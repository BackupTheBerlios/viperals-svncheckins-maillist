<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r179 - in cms/trunk: admin includes	includes/db includes/forums includes/templates/admin/modules	install modules/control_panel/modules modules/forums	modules/forums/images modules/forums/images/en	modules/forums/images/karma themes/viperal/template/modules
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2006-August/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r179%20-%20in%20cms/trunk%3A%20admin%20includes%0A%09includes/db%20includes/forums%20includes/templates/admin/modules%0A%09install%20modules/control_panel/modules%20modules/forums%0A%09modules/forums/images%20modules/forums/images/en%0A%09modules/forums/images/karma%20themes/viperal/template/modules&In-Reply-To=%3C200608041347.k74DlnLY003923%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000099.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r179 - in cms/trunk: admin includes	includes/db includes/forums includes/templates/admin/modules	install modules/control_panel/modules modules/forums	modules/forums/images modules/forums/images/en	modules/forums/images/karma themes/viperal/template/modules</H1>
    <B>viperal at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r179%20-%20in%20cms/trunk%3A%20admin%20includes%0A%09includes/db%20includes/forums%20includes/templates/admin/modules%0A%09install%20modules/control_panel/modules%20modules/forums%0A%09modules/forums/images%20modules/forums/images/en%0A%09modules/forums/images/karma%20themes/viperal/template/modules&In-Reply-To=%3C200608041347.k74DlnLY003923%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r179 - in cms/trunk: admin includes	includes/db includes/forums includes/templates/admin/modules	install modules/control_panel/modules modules/forums	modules/forums/images modules/forums/images/en	modules/forums/images/karma themes/viperal/template/modules">viperal at mail.berlios.de
       </A><BR>
    <I>Fri Aug  4 15:47:49 CEST 2006</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000099.html">[Viperals-svncheckins] r180 - in cms/trunk: includes	includes/forums includes/forums/mcp modules/forums
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#98">[ date ]</a>
              <a href="thread.html#98">[ thread ]</a>
              <a href="subject.html#98">[ subject ]</a>
              <a href="author.html#98">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2006-08-04 15:47:39 +0200 (Fri, 04 Aug 2006)
New Revision: 179

Added:
   cms/trunk/modules/forums/images/
   cms/trunk/modules/forums/images/background.gif
   cms/trunk/modules/forums/images/cellpic.gif
   cms/trunk/modules/forums/images/cellpic1.gif
   cms/trunk/modules/forums/images/cellpic2.jpg
   cms/trunk/modules/forums/images/cellpic3.gif
   cms/trunk/modules/forums/images/created_by.jpg
   cms/trunk/modules/forums/images/en/
   cms/trunk/modules/forums/images/en/btn_aim.gif
   cms/trunk/modules/forums/images/en/btn_approve.gif
   cms/trunk/modules/forums/images/en/btn_delete.gif
   cms/trunk/modules/forums/images/en/btn_edit.gif
   cms/trunk/modules/forums/images/en/btn_email.gif
   cms/trunk/modules/forums/images/en/btn_icq.gif
   cms/trunk/modules/forums/images/en/btn_info.gif
   cms/trunk/modules/forums/images/en/btn_ip.gif
   cms/trunk/modules/forums/images/en/btn_jabber.gif
   cms/trunk/modules/forums/images/en/btn_locked.gif
   cms/trunk/modules/forums/images/en/btn_msnm.gif
   cms/trunk/modules/forums/images/en/btn_offline.gif
   cms/trunk/modules/forums/images/en/btn_online.gif
   cms/trunk/modules/forums/images/en/btn_pm.gif
   cms/trunk/modules/forums/images/en/btn_post.gif
   cms/trunk/modules/forums/images/en/btn_post_pm.gif
   cms/trunk/modules/forums/images/en/btn_profile.gif
   cms/trunk/modules/forums/images/en/btn_quote.gif
   cms/trunk/modules/forums/images/en/btn_reply.gif
   cms/trunk/modules/forums/images/en/btn_reply_pm.gif
   cms/trunk/modules/forums/images/en/btn_report.gif
   cms/trunk/modules/forums/images/en/btn_search.gif
   cms/trunk/modules/forums/images/en/btn_www.gif
   cms/trunk/modules/forums/images/en/btn_yim.gif
   cms/trunk/modules/forums/images/folder.gif
   cms/trunk/modules/forums/images/folder_announce.gif
   cms/trunk/modules/forums/images/folder_announce_new.gif
   cms/trunk/modules/forums/images/folder_announce_new_posted.gif
   cms/trunk/modules/forums/images/folder_announce_posted.gif
   cms/trunk/modules/forums/images/folder_big.gif
   cms/trunk/modules/forums/images/folder_hot.gif
   cms/trunk/modules/forums/images/folder_hot_posted.gif
   cms/trunk/modules/forums/images/folder_link_big.gif
   cms/trunk/modules/forums/images/folder_lock.gif
   cms/trunk/modules/forums/images/folder_lock_new.gif
   cms/trunk/modules/forums/images/folder_lock_new_posted.gif
   cms/trunk/modules/forums/images/folder_lock_posted.gif
   cms/trunk/modules/forums/images/folder_locked_big.gif
   cms/trunk/modules/forums/images/folder_moved.gif
   cms/trunk/modules/forums/images/folder_new.gif
   cms/trunk/modules/forums/images/folder_new_big.gif
   cms/trunk/modules/forums/images/folder_new_hot.gif
   cms/trunk/modules/forums/images/folder_new_hot_posted.gif
   cms/trunk/modules/forums/images/folder_new_posted.gif
   cms/trunk/modules/forums/images/folder_posted.gif
   cms/trunk/modules/forums/images/folder_sticky.gif
   cms/trunk/modules/forums/images/folder_sticky_new.gif
   cms/trunk/modules/forums/images/folder_sticky_new_posted.gif
   cms/trunk/modules/forums/images/folder_sticky_posted.gif
   cms/trunk/modules/forums/images/icon_attach.gif
   cms/trunk/modules/forums/images/icon_latest_reply.gif
   cms/trunk/modules/forums/images/icon_mini_faq.gif
   cms/trunk/modules/forums/images/icon_mini_groups.gif
   cms/trunk/modules/forums/images/icon_mini_login.gif
   cms/trunk/modules/forums/images/icon_mini_members.gif
   cms/trunk/modules/forums/images/icon_mini_message.gif
   cms/trunk/modules/forums/images/icon_mini_profile.gif
   cms/trunk/modules/forums/images/icon_mini_register.gif
   cms/trunk/modules/forums/images/icon_mini_search.gif
   cms/trunk/modules/forums/images/icon_minipost.gif
   cms/trunk/modules/forums/images/icon_minipost_new.gif
   cms/trunk/modules/forums/images/icon_newest_reply.gif
   cms/trunk/modules/forums/images/icon_reported.gif
   cms/trunk/modules/forums/images/icon_unapproved.gif
   cms/trunk/modules/forums/images/index_en.php
   cms/trunk/modules/forums/images/karma/
   cms/trunk/modules/forums/images/karma/karma-1.gif
   cms/trunk/modules/forums/images/karma/karma-2.gif
   cms/trunk/modules/forums/images/karma/karma-3.gif
   cms/trunk/modules/forums/images/karma/karma-4.gif
   cms/trunk/modules/forums/images/karma/karma-5.gif
   cms/trunk/modules/forums/images/karma/karma0.gif
   cms/trunk/modules/forums/images/karma/karma1.gif
   cms/trunk/modules/forums/images/karma/karma2.gif
   cms/trunk/modules/forums/images/karma/karma3.gif
   cms/trunk/modules/forums/images/karma/karma4.gif
   cms/trunk/modules/forums/images/karma/karma5.gif
   cms/trunk/modules/forums/images/no_avatar.gif
   cms/trunk/modules/forums/images/progress_bar.gif
   cms/trunk/modules/forums/images/spacer.gif
   cms/trunk/modules/forums/images/subfolder_big.gif
   cms/trunk/modules/forums/images/subfolder_new_big.gif
   cms/trunk/modules/forums/images/topic_delete.gif
   cms/trunk/modules/forums/images/topic_lock.gif
   cms/trunk/modules/forums/images/topic_move.gif
   cms/trunk/modules/forums/images/topic_split.gif
   cms/trunk/modules/forums/images/topic_unlock.gif
   cms/trunk/modules/forums/images/vote_lcap.gif
   cms/trunk/modules/forums/images/vote_rcap.gif
   cms/trunk/modules/forums/images/voting_bar.gif
   cms/trunk/modules/forums/images/whosonline.gif
Removed:
   cms/trunk/includes/nusoap/
   cms/trunk/themes/viperal/template/modules/Forums/
Modified:
   cms/trunk/admin/menu.php
   cms/trunk/admin/modules.php
   cms/trunk/includes/db/mysql.php
   cms/trunk/includes/db/mysqli.php
   cms/trunk/includes/db/postgres.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/session.php
   cms/trunk/includes/templates/admin/modules/index.html
   cms/trunk/includes/user.php
   cms/trunk/install/build_data.php
   cms/trunk/modules/control_panel/modules/ucp_zebra.php
   cms/trunk/modules/forums/posting.php
   cms/trunk/modules/forums/viewforum.php
   cms/trunk/modules/forums/viewtopic.php
Log:


Modified: cms/trunk/admin/menu.php
===================================================================
--- cms/trunk/admin/menu.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/admin/menu.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -44,13 +44,13 @@
 $menu['modules'][] = '';
 $menu['modules'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('ARTICLES'), 'link' =&gt; generate_link('articles', array('admin' =&gt; true)));
 
-$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('FORUMS'), 'link' =&gt; generate_link('Forums', array('admin' =&gt; true)));
-$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('ADMIN_INDEX'), 'link' =&gt; generate_link('Forums', array('admin' =&gt; true)));
+$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('FORUMS'), 'link' =&gt; generate_link('forums', array('admin' =&gt; true)));
+$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('ADMIN_INDEX'), 'link' =&gt; generate_link('forums', array('admin' =&gt; true)));
 $menu['forums'][] = '';
-$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('MANAGE_FORUMS'), 'link' =&gt; generate_link('Forums&amp;file=admin_forums', array('admin' =&gt; true)));
-$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('PERMISSIONS'), 'link' =&gt; generate_link('Forums&amp;file=admin_permissions&amp;mode=forum', array('admin' =&gt; true)));
-$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('ADMINISTRATORS'), 'link' =&gt; generate_link('Forums&amp;file=admin_permissions&amp;mode=admin', array('admin' =&gt; true)));
-$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('MODERATORS'), 'link' =&gt; generate_link('Forums&amp;file=admin_permissions&amp;mode=mod', array('admin' =&gt; true)));
+$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('MANAGE_FORUMS'), 'link' =&gt; generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)));
+$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('PERMISSIONS'), 'link' =&gt; generate_link('forums&amp;file=admin_permissions&amp;mode=forum', array('admin' =&gt; true)));
+$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('ADMINISTRATORS'), 'link' =&gt; generate_link('forums&amp;file=admin_permissions&amp;mode=admin', array('admin' =&gt; true)));
+$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('MODERATORS'), 'link' =&gt; generate_link('forums&amp;file=admin_permissions&amp;mode=mod', array('admin' =&gt; true)));
 
 $menu['system'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('SYSTEM'), 'link' =&gt; generate_link('system', array('admin' =&gt; true)));
 $menu['system'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('SITE_SETTINGS'), 'link' =&gt; generate_link('system&amp;mode=site', array('admin' =&gt; true)));

Modified: cms/trunk/admin/modules.php
===================================================================
--- cms/trunk/admin/modules.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/admin/modules.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -273,6 +273,9 @@
 	));
 }
 
+$_CLASS['core_template']-&gt;assign_array(array(
+	'B_SEARCH'	=&gt; generate_link('modules&amp;mode=search', array('admin' =&gt; true)),
+));
 
 $_CLASS['core_display']-&gt;display(false, 'admin/modules/index.html');
 

Modified: cms/trunk/includes/db/mysql.php
===================================================================
--- cms/trunk/includes/db/mysql.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/db/mysql.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -225,10 +225,37 @@
 		return mysql_query($query, $this-&gt;link_identifier);
 	}
 
+	function sql_query_build($query_type, $array, $table)
+	{
+		if (!is_array($array) || !$table )
+		{
+			return false;
+		}
+
+		$values = $this-&gt;sql_build_array($query_type, $array);
+
+		if (!$value)
+		{
+			return false;
+		}
+
+		SWitch  ($query_type)
+		{
+			case 'MULTI_INSERT':
+			case 'INSERT':
+				return $this-&gt;query('INSERT INTO ' . $table . ' '. $values');
+			break;
+
+			case 'UPDATE':
+				return $this-&gt;query('UPDATE ' . $table . ' SET ' . $values);
+			break;
+		}
+	}
+
 	/*
-		Boy do I like this but it phpBB's, may have to do something similar
+		Boy do I like this but it phpBB's
 	*/
-	function sql_build_array($query, $array = false)
+	function sql_build_array($query_type, $array)
 	{
 		if (!is_array($array))
 		{
@@ -237,58 +264,92 @@
 
 		$_fields = $values = array();
 
-		if ($query == 'INSERT')
+		SWitch  ($query_type)
 		{
-			foreach ($array as $key =&gt; $value)
-			{
-				$_fields[] = $key;
-
-				if (is_numeric($value))
+			case 'INSERT':
+				foreach ($array as $key =&gt; $value)
 				{
-					$values[] = $value;
+					$_fields[] = $key;
+	
+					if (is_numeric($value))
+					{
+						$values[] = $value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = &quot;'&quot; . $this-&gt;escape($value) . &quot;'&quot;;
+					}
+					elseif (is_null($value))
+					{
+						$values[] = 'NULL';
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = ($value) ? 1 : 0;
+					}
 				}
-				elseif (is_string($value))
-				{
-					$values[] = &quot;'&quot; . $this-&gt;escape($value) . &quot;'&quot;;
-				}
-				elseif (is_null($value))
-				{
-					$values[] = 'NULL';
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = ($value) ? 1 : 0;
-				}
-			}
+	
+				return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
 
-			return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
-		}
-		elseif ($query == 'UPDATE' || $query == 'SELECT')
-		{
-			$values = array();
-			foreach ($array as $key =&gt; $value)
-			{
-				if (is_numeric($value))
+			case 'MULTI_INSERT':
+				$ary = array();
+				foreach ($array as $array2)
+				{
+					$values = array();
+					foreach ($array2 as $key =&gt; $value)
+					{
+						if (is_numeric($value))
+						{
+							$values[] = $value;
+						}
+						elseif (is_string($value))
+						{
+							$values[] = &quot;'&quot; . $this-&gt;escape($value) . &quot;'&quot;;
+						}
+						elseif (is_null($value))
+						{
+							$values[] = 'NULL';
+						}
+						elseif (is_bool($value))
+						{
+							$values[] = ($value) ? 1 : 0;
+						}
+					}
+					$ary[] = '(' . implode(', ', $values) . ')';
+				}
+	
+				return ' (' . implode(', ', array_keys($array[0])) . ') VALUES ' . implode(', ', $ary);
+			break;
+
+			case 'UPDATE':
+			case 'SELECT':
+				$values = array();
+				foreach ($array as $key =&gt; $value)
 				{
-					$values[] = $key.' = '.$value;
+					if (is_numeric($value))
+					{
+						$values[] = $key.' = '.$value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = &quot;$key = '&quot; . $this-&gt;escape($value) . &quot;'&quot;;
+					}
+					elseif (is_null($value))
+					{
+						$values[] = &quot;$key = NULL&quot;;
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = $key.' = '.(($value) ? 1 : 0);
+					}
+	
 				}
-				elseif (is_string($value))
-				{
-					$values[] = &quot;$key = '&quot; . $this-&gt;escape($value) . &quot;'&quot;;
-				}
-				elseif (is_null($value))
-				{
-					$values[] = &quot;$key = NULL&quot;;
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = $key.' = '.(($value) ? 1 : 0);
-				}
-
-			}
-
-			return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+	
+				return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+			break;
 		}
+		return false;
 	}
 
 	function num_rows($result = false)

Modified: cms/trunk/includes/db/mysqli.php
===================================================================
--- cms/trunk/includes/db/mysqli.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/db/mysqli.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -227,10 +227,41 @@
 		return mysqli_query($this-&gt;link_identifier, $query);
 	}
 
+	function sql_query_build($query_type, $array, $table)
+	{
+		if (!is_array($array) || !$table )
+		{
+			return false;
+		}
+
+		$values = $this-&gt;sql_build_array($query_type, $array);
+
+		if (!$value)
+		{
+			return false;
+		}
+
+		SWitch  ($query_type)
+		{
+			case 'MULTI_INSERT':
+			case 'INSERT':
+				return $this-&gt;query('INSERT INTO ' . $table . ' '. $values');
+				/*foreach ($array as $array2)
+				{
+					return $this-&gt;query('INSERT INTO ' . $table . ' '. $values');
+				}*/
+			break;
+
+			case 'UPDATE':
+				return $this-&gt;query('UPDATE ' . $table . ' SET ' . $values);
+			break;
+		}
+	}
+
 	/*
-		Boy do I like this but it phpBB's, may have to do something similar
+		Boy do I like this but it phpBB's
 	*/
-	function sql_build_array($query, $array = false)
+	function sql_build_array($query_type, $array)
 	{
 		if (!is_array($array))
 		{
@@ -239,58 +270,92 @@
 
 		$_fields = $values = array();
 
-		if ($query == 'INSERT')
+		SWitch (strtoupper($query_type))
 		{
-			foreach ($array as $key =&gt; $value)
-			{
-				$_fields[] = $key;
-
-				if (is_numeric($value))
+			case 'INSERT':
+				foreach ($array as $key =&gt; $value)
 				{
-					$values[] = $value;
+					$_fields[] = $key;
+	
+					if (is_numeric($value))
+					{
+						$values[] = $value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = &quot;'&quot; . $this-&gt;escape($value) . &quot;'&quot;;
+					}
+					elseif (is_null($value))
+					{
+						$values[] = 'NULL';
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = ($value) ? 1 : 0;
+					}
 				}
-				elseif (is_string($value))
-				{
-					$values[] = &quot;'&quot; . $this-&gt;escape($value) . &quot;'&quot;;
-				}
-				elseif (is_null($value))
-				{
-					$values[] = 'NULL';
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = ($value) ? 1 : 0;
-				}
-			}
+	
+				return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
 
-			return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
-		}
-		elseif ($query == 'UPDATE' || $query == 'SELECT')
-		{
-			$values = array();
-			foreach ($array as $key =&gt; $value)
-			{
-				if (is_numeric($value))
+			case 'MULTI_INSERT':
+				$ary = array();
+				foreach ($array as $array2)
+				{
+					$values = array();
+					foreach ($array2 as $key =&gt; $value)
+					{
+						if (is_numeric($value))
+						{
+							$values[] = $value;
+						}
+						elseif (is_string($value))
+						{
+							$values[] = &quot;'&quot; . $this-&gt;escape($value) . &quot;'&quot;;
+						}
+						elseif (is_null($value))
+						{
+							$values[] = 'NULL';
+						}
+						elseif (is_bool($value))
+						{
+							$values[] = ($value) ? 1 : 0;
+						}
+					}
+					$ary[] = '(' . implode(', ', $values) . ')';
+				}
+	
+				return ' (' . implode(', ', array_keys($array[0])) . ') VALUES ' . implode(', ', $ary);
+			break;
+
+			case 'UPDATE':
+			case 'SELECT':
+				$values = array();
+				foreach ($array as $key =&gt; $value)
 				{
-					$values[] = $key.' = '.$value;
+					if (is_numeric($value))
+					{
+						$values[] = $key.' = '.$value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = &quot;$key = '&quot; . $this-&gt;escape($value) . &quot;'&quot;;
+					}
+					elseif (is_null($value))
+					{
+						$values[] = &quot;$key = NULL&quot;;
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = $key.' = '.(($value) ? 1 : 0);
+					}
+	
 				}
-				elseif (is_string($value))
-				{
-					$values[] = &quot;$key = '&quot; . $this-&gt;escape($value) . &quot;'&quot;;
-				}
-				elseif (is_null($value))
-				{
-					$values[] = &quot;$key = NULL&quot;;
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = $key.' = '.(($value) ? 1 : 0);
-				}
-
-			}
-
-			return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+	
+				return implode(($query_type == 'UPDATE') ? ', ' : ' AND ', $values);
+			break;
 		}
+		return false;
 	}
 
 	function num_rows($result = false)

Modified: cms/trunk/includes/db/postgres.php
===================================================================
--- cms/trunk/includes/db/postgres.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/db/postgres.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -237,70 +237,132 @@
 		return $this-&gt;query($query, $backtrace);
 	}
 
+	function sql_query_build($query_type, $array, $table)
+	{
+		if (!is_array($array) || !$table)
+		{
+			return false;
+		}
+
+		SWitch (strtoupper($query_type))
+		{
+			case 'MULTI_INSERT':
+				foreach ($array as $array2)
+				{
+					pg_insert($this-&gt;link_identifier, $table, $array2);
+				}
+			break;
+
+			case 'INSERT':
+				return pg_insert($this-&gt;link_identifier, $table, $array);
+				//return $this-&gt;query('INSERT INTO ' . $table . ' '. $values');
+			break;
+
+			case 'UPDATE':
+				return pg_update($this-&gt;link_identifier, $table, $array);
+				//return $this-&gt;query('UPDATE ' . $table . ' SET ' . $values);
+			break;
+		}
+	}
+
 	/*
-		Boy do I like this but it phpBB's, may have to do something similar
+		Boy do I like this but it phpBB's
 	*/
-	function sql_build_array($query, $array = false)
+	function sql_build_array($query_type, $array)
 	{
 		if (!is_array($array))
 		{
 			return false;
 		}
 
-		$fields = $values = array();
+		$_fields = $values = array();
 
-		if ($query == 'INSERT')
+		SWitch  ($query_type)
 		{
-			foreach ($array as $key =&gt; $value)
-			{
-				$fields[] = $key;
-
-				if (is_numeric($value))
+			case 'INSERT':
+				foreach ($array as $key =&gt; $value)
 				{
-					$values[] = $value;
+					$_fields[] = $key;
+	
+					if (is_numeric($value))
+					{
+						$values[] = $value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = &quot;'&quot; . $this-&gt;escape($value) . &quot;'&quot;;
+					}
+					elseif (is_null($value))
+					{
+						$values[] = 'NULL';
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = ($value) ? 1 : 0;
+					}
 				}
-				elseif (is_string($value))
-				{
-					$values[] = &quot;'&quot; . $this-&gt;escape($value) . &quot;'&quot;;
-				}
-				elseif (is_null($value))
-				{
-					$values[] = 'NULL';
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = ($value) ? 1 : 0;
-				}
-			}
+	
+				return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
 
-			return ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
-		}
-		elseif ($query == 'UPDATE' || $query == 'SELECT')
-		{
-			$values = array();
-			foreach ($array as $key =&gt; $value)
-			{
-				if (is_numeric($value))
+			case 'MULTI_INSERT':
+				$ary = array();
+				foreach ($array as $array2)
+				{
+					$values = array();
+					foreach ($array2 as $key =&gt; $value)
+					{
+						if (is_numeric($value))
+						{
+							$values[] = $value;
+						}
+						elseif (is_string($value))
+						{
+							$values[] = &quot;'&quot; . $this-&gt;escape($value) . &quot;'&quot;;
+						}
+						elseif (is_null($value))
+						{
+							$values[] = 'NULL';
+						}
+						elseif (is_bool($value))
+						{
+							$values[] = ($value) ? 1 : 0;
+						}
+					}
+					$ary[] = '(' . implode(', ', $values) . ')';
+				}
+	
+				return ' (' . implode(', ', array_keys($array[0])) . ') VALUES ' . implode(', ', $ary);
+			break;
+
+			case 'UPDATE':
+			case 'SELECT':
+				$values = array();
+				foreach ($array as $key =&gt; $value)
 				{
-					$values[] = $key.' = '.$value;
+					if (is_numeric($value))
+					{
+						$values[] = $key.' = '.$value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = &quot;$key = '&quot; . $this-&gt;escape($value) . &quot;'&quot;;
+					}
+					elseif (is_null($value))
+					{
+						$values[] = &quot;$key = NULL&quot;;
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = $key.' = '.(($value) ? 1 : 0);
+					}
+	
 				}
-				elseif (is_string($value))
-				{
-					$values[] = &quot;$key = '&quot; . $this-&gt;escape($value) . &quot;'&quot;;
-				}
-				elseif (is_null($value))
-				{
-					$values[] = &quot;$key = NULL&quot;;
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = $key.' = '.(($value) ? 1 : 0);
-				}
-
-			}
-
-			return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+	
+				return implode(($query_type == 'UPDATE') ? ', ' : ' AND ', $values);
+			break;
 		}
+		return false;
 	}
 
 	function num_rows($result = false)

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/forums/functions.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -1322,9 +1322,6 @@
 		'T_RANKS_PATH'			=&gt; &quot;{$config['ranks_path']}/&quot;,
 		'T_UPLOAD_PATH'			=&gt; &quot;{$config['upload_path']}/&quot;,
 
-// Temp
-		'T_IMAGE_PATH'			=&gt; &quot;themes/viperal/template/modules/Forums/images/&quot;,
-
 		'U_ACP'				=&gt; ($_CLASS['core_user']-&gt;is_admin &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('a_')) ? generate_link('Forums', array('admin' =&gt; true)) : '',
 		'L_ACP'				=&gt; $_CLASS['core_user']-&gt;lang['ACP']
 	));

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/forums/functions_display.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -36,10 +36,9 @@
 {
 	global $config, $_CLASS, $_CORE_CONFIG;
 
-	// Get posted/get info
 	$mark_read = request_var('mark', '');
 
-	$forum_id_ary = $active_forum_ary = $forum_rows = $subforums = $forum_moderators = $mark_forums = array();
+	$forum_id_ary = $active_forum_ary = $forum_rows = $subforums = $forum_moderators = $forum_ids_moderator = $mark_forums = array();
 	$visible_forums = 0;
 
 	if (!$root_data)
@@ -69,13 +68,12 @@
 
 	$sql = &quot;SELECT f.* $lastread_select 
 		FROM &quot;. FORUMS_FORUMS_TABLE . &quot; f $sql_from
-		WHERE forum_status &lt;&gt; &quot;.ITEM_DELETING.&quot;
+		WHERE forum_status &lt;&gt; &quot; . ITEM_DELETING . &quot;
 		$sql_where
 		ORDER BY f.left_id&quot;;
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
 	$branch_root_id = $root_data['forum_id'];
-	$forum_ids		= array($root_data['forum_id']);
 
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
@@ -89,6 +87,14 @@
 			continue;
 		}
 
+
+
+		if ($row['forum_type'] == FORUM_CAT &amp;&amp; ($row['left_id'] + 1 == $row['right_id']))
+		{
+			// Non-postable forum with no subforums: don't display
+			continue;
+		}
+
 		if (isset($right_id))
 		{
 			if ($row['left_id'] &lt; $right_id)
@@ -98,12 +104,6 @@
 			unset($right_id);
 		}
 
-		if ($row['forum_type'] == FORUM_CAT &amp;&amp; ($row['left_id'] + 1 == $row['right_id']))
-		{
-			// Non-postable forum with no subforums: don't display
-			continue;
-		}
-
 		if (!$_CLASS['auth']-&gt;acl_get('f_list', $row['forum_id']))
 		{
 			// if the user does not have permissions to list this forum, skip everything until next branch
@@ -114,6 +114,16 @@
 		// Display active topics from this forum?
 		if ($show_active &amp;&amp; $row['forum_type'] == FORUM_POST &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_read', $row['forum_id']) &amp;&amp; ($row['forum_flags'] &amp; 16))
 		{
+			if (!isset($active_forum_ary['forum_topics']))
+			{
+				$active_forum_ary['forum_topics'] = 0;
+			}
+
+			if (!isset($active_forum_ary['forum_posts']))
+			{
+				$active_forum_ary['forum_posts'] = 0;
+			}
+
 			$active_forum_ary['forum_id'][]		= $row['forum_id'];
 			$active_forum_ary['enable_icons'][] = $row['enable_icons'];
 			$active_forum_ary['forum_topics']	+= ($_CLASS['auth']-&gt;acl_get('m_approve', $row['forum_id'])) ? $row['forum_topics_real'] : $row['forum_topics'];
@@ -131,7 +141,7 @@
 			$parent_id = $row['forum_id'];
 			$forum_rows[$row['forum_id']] = $row;
 
-			if (!$row['parent_id'] &amp;&amp; $row['forum_type'] == FORUM_CAT &amp;&amp; $row['parent_id'] == $root_data['forum_id'])
+			if ($row['forum_type'] == FORUM_CAT &amp;&amp; $row['parent_id'] == $root_data['forum_id'])
 			{
 				$branch_root_id = $row['forum_id'];
 			}
@@ -150,7 +160,7 @@
 				$forum_rows[$parent_id]['forum_posts'] += $row['forum_posts'];
 			}
 
-			if (isset($forum_rows[$parent_id]) &amp;&amp; $row['forum_last_post_time'] &gt; $forum_rows[$parent_id]['forum_last_post_time'])
+			if ($row['forum_last_post_time'] &gt; $forum_rows[$parent_id]['forum_last_post_time'])
 			{
 				$forum_rows[$parent_id]['forum_last_post_id'] = $row['forum_last_post_id'];
 				$forum_rows[$parent_id]['forum_last_post_time'] = $row['forum_last_post_time'];
@@ -211,6 +221,8 @@
 				'FORUM_ID'			=&gt;	$row['forum_id'],
 				'FORUM_NAME'		=&gt;	$row['forum_name'],
 				'FORUM_DESC'		=&gt;	$row['forum_desc'],
+				//'FORUM_FOLDER_IMG'		=&gt; ($row['forum_image']) ? '&lt;img src=&quot;' . $phpbb_root_path . $row['forum_image'] . '&quot; alt=&quot;' . $user-&gt;lang['FORUM_CAT'] . '&quot; /&gt;' : '',
+				//'FORUM_FOLDER_IMG_SRC'	=&gt; ($row['forum_image']) ? $phpbb_root_path . $row['forum_image'] : '',
 				'U_VIEWFORUM'		=&gt;	generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']))
 			);
 			
@@ -226,28 +238,22 @@
 		// Generate list of subforums if we need to
 		if (isset($subforums[$forum_id]))
 		{
+			$links = array();
+
 			foreach ($subforums[$forum_id] as $subforum_id =&gt; $subforum_row)
 			{
-				$links = array();
-
 				if ($subforum_row['display'] &amp;&amp; $subforum_row['name'])
 				{
 					$links[] = '&lt;a href=&quot;' .generate_link('forums&amp;file=viewforum&amp;f='.$subforum_id).'&quot;&gt;' .  $subforum_row['name'] . '&lt;/a&gt;';
 				}
-				else
-				{
-					unset($subforums[$forum_id][$subforum_id]);
-				}
-
-				if (!empty($links))
-				{
-					$subforums_list = implode(', ', $links);
-					$l_subforums = (count($subforums[$forum_id]) === 1) ? $_CLASS['core_user']-&gt;lang['SUBFORUM'] . ': ' : $_CLASS['core_user']-&gt;lang['SUBFORUMS'] . ': ';
-				}
-
-				unset($links);
+				unset($subforums[$forum_id][$subforum_id]);
 			}
+		
+			$subforums_list = implode(', ', $links);
+			$l_subforums = (count($links) === 1) ? $_CLASS['core_user']-&gt;lang['SUBFORUM'] . ': ' : $_CLASS['core_user']-&gt;lang['SUBFORUMS'] . ': ';
 
+			unset($links);
+	
 			$folder_image = (!empty($forum_unread[$forum_id])) ? 'sub_forum_new' : 'sub_forum';
 		}
 		else
@@ -307,6 +313,8 @@
 		$_CLASS['core_template']-&gt;assign_vars_array('forumrow', array(
 			'S_IS_CAT'			=&gt; false, 
 			'S_IS_LINK'			=&gt; ($row['forum_type'] == FORUM_LINK), 
+			'S_UNREAD_FORUM'	=&gt; !empty($forum_unread[$forum_id]),
+			'S_LOCKED_FORUM'	=&gt; ($row['forum_status'] == ITEM_LOCKED) ? true : false,
 
 			'LAST_POST_IMG'		=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'), 
 
@@ -342,7 +350,12 @@
 		'L_SUBFORUM'		=&gt; ($visible_forums == 1) ? $_CLASS['core_user']-&gt;lang['SUBFORUM'] : $_CLASS['core_user']-&gt;lang['SUBFORUMS']
 	));
 
-	return $active_forum_ary;
+	if ($return_moderators)
+	{
+		return array($active_forum_ary, $forum_moderators);
+	}
+
+	return array($active_forum_ary, array());
 }
 
 function topic_status(&amp;$topic_row, $replies, $mark_time, &amp;$unread, &amp;$folder_img, &amp;$folder_alt, &amp;$topic_type)

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/forums/functions_posting.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -166,14 +166,7 @@
 		$upload-&gt;set_allowed_extensions(array_keys($extensions['_allowed_']));
 	}
 
-	if ($local)
-	{
-		$file = $upload-&gt;local_upload($local_storage);
-	}
-	else
-	{
-		$file = $upload-&gt;form_upload($form_name);
-	}
+	$file = ($local) ? $upload-&gt;local_upload($local_storage) : $upload-&gt;form_upload($form_name);
 
 	if ($file-&gt;init_error)
 	{
@@ -215,7 +208,7 @@
 	$filedata['extension'] = $file-&gt;get('extension');
 	$filedata['physical_filename'] = $file-&gt;get('realname');
 	$filedata['real_filename'] = $file-&gt;get('uploadname');
-	$filedata['filetime'] = time();
+	$filedata['filetime'] = $_CLASS['core_user']-&gt;time;
 
 	// Check our complete quota
 	if ($config['attachment_quota'])
@@ -343,7 +336,6 @@
 	global $config;
 
 	$min_filesize = (int) $config['img_min_thumb_filesize'];
-
 	$img_filesize = (file_exists($source)) ? @filesize($source) : false;
 
 	if (!$img_filesize || $img_filesize &lt;= $min_filesize)
@@ -367,7 +359,7 @@
 
 	$used_imagick = false;
 
-	if (file_exists($destination))
+	if (file_exists($destination) &amp;&amp; function_exists('passthru'))
 	{
 		passthru($config['img_imagick'] . 'convert' . ((defined('PHP_OS') &amp;&amp; preg_match('#win#i', PHP_OS)) ? '.exe' : '') . ' -quality 85 -antialias -sample ' . $new_width . 'x' . $new_height . ' &quot;' . str_replace('\\', '/', $source) . '&quot; +profile &quot;*&quot; &quot;' . str_replace('\\', '/', $destination) . '&quot;');
 		if (file_exists($new_file))
@@ -408,7 +400,13 @@
 				$new_image = imagecreatetruecolor($new_width, $new_height);
 				imagecopyresampled($new_image, $image, 0, 0, 0, 0, $new_width, $new_height, $width, $height);
 			}
-			
+
+			// If we are in safe mode create the destination file prior to using the gd functions to circumvent a PHP bug
+			if (@ini_get('safe_mode') || @strtolower(ini_get('safe_mode')) === 'on')
+			{
+				@touch($destination);		
+			}
+
 			switch ($type['format'])
 			{
 				case IMG_GIF:
@@ -743,6 +741,7 @@
 
 	if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
+		$_CLASS['core_db']-&gt;free_result($result);
 		return false;
 	}
 
@@ -758,7 +757,7 @@
 	// Instantiate BBCode class
 	if (!isset($bbcode) &amp;&amp; $bbcode_bitfield)
 	{
-		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 		$bbcode = new bbcode($bbcode_bitfield);
 	}
 
@@ -768,14 +767,24 @@
 		$poster = $row['username'];
 
 		// Handle anon users posting with usernames
-		if ($poster_id == ANONYMOUS &amp;&amp; $row['post_username'])
+		if ($poster_id == ANONYMOUS)
 		{
-			$poster = $row['post_username'];
+			$poster = ($row['post_username']) ? $row['post_username'] :$_CLASS['core_user']-&gt;lang['GUEST'];
 			$poster_rank = $_CLASS['core_user']-&gt;lang['GUEST'];
 		}
 
 		$post_subject = $row['post_subject'];
 		$message = $row['post_text'];
+		$decoded_message = false;
+
+		if ($show_quote_button &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_reply', $forum_id))
+		{
+			$decoded_message = $message;
+			decode_message($decoded_message, $row['bbcode_uid']);
+
+			$decoded_message = censor_text($decoded_message);
+			$decoded_message = str_replace(&quot;\n&quot;, &quot;&lt;br /&gt;&quot;, $decoded_message);
+		}
 
 		if ($row['bbcode_bitfield'])
 		{
@@ -793,6 +802,7 @@
 			'MINI_POST_IMG' =&gt; $_CLASS['core_user']-&gt;img('icon_post', $_CLASS['core_user']-&gt;lang['POST']),
 			'POST_DATE' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['post_time']),
 			'MESSAGE' 		=&gt; str_replace(&quot;\n&quot;, '&lt;br /&gt;', $message), 
+			'DECODED_MESSAGE'	=&gt; $decoded_message,
 
 			'U_POST_ID'		=&gt; $row['post_id'],
 			'U_MINI_POST'	=&gt; generate_link('Forums&amp;file=viewtopic&amp;p=' . $row['post_id'] . '#' . $row['post_id']),
@@ -984,4 +994,924 @@
 	$_CLASS['core_db']-&gt;transaction('commit');
 }
 
+//
+// Post handling functions
+//
+
+/**
+* Delete Post
+*/
+function delete_post($forum_id, $topic_id, $post_id, &amp;$data)
+{
+	global $_CLASS, $config;
+
+	// Specify our post mode
+	$post_mode = ($data['topic_first_post_id'] == $data['topic_last_post_id']) ? 'delete_topic' : (($data['topic_first_post_id'] == $post_id) ? 'delete_first_post' : (($data['topic_last_post_id'] == $post_id) ? 'delete_last_post' : 'delete'));
+	$sql_data = array();
+	$next_post_id = 0;
+
+	require_once SITE_FILE_ROOT.'includes/forums/functions_admin.php';
+
+	$_CLASS['core_db']-&gt;transaction();
+
+	if (!delete_posts('post_id', array($post_id), false, false))
+	{
+		// Try to delete topic, we may had an previous error causing inconsistency
+		if ($post_mode == 'delete_topic')
+		{
+			delete_topics('topic_id', array($topic_id), false);
+		}
+		trigger_error('ALREADY_DELETED');
+	}
+
+	$_CLASS['core_db']-&gt;transaction('commit');
+
+	// Collect the necessary information for updating the tables
+	$sql_data[FORUMS_FORUMS_TABLE] = '';
+	switch ($post_mode)
+	{
+		case 'delete_topic':
+			delete_topics('topic_id', array($topic_id), false);
+
+			if ($data['topic_type'] != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] .= 'forum_posts = forum_posts - 1, forum_topics_real = forum_topics_real - 1';
+				$sql_data[FORUMS_FORUMS_TABLE] .= ($data['topic_approved']) ? ', forum_topics = forum_topics - 1' : '';
+			}
+
+			$update_sql = update_post_information('forum', $forum_id, true);
+			if (sizeof($update_sql))
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] .= ($sql_data[FORUMS_FORUMS_TABLE]) ? ', ' : '';
+				$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', $update_sql[$forum_id]);
+			}
+		break;
+
+		case 'delete_first_post':
+			$sql = 'SELECT p.post_id, p.poster_id, p.post_username, u.username
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . &quot; u
+				WHERE p.topic_id = $topic_id
+					AND p.poster_id = u.user_id
+				ORDER BY p.post_time ASC&quot;;
+			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if ($data['topic_type'] != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
+			}
+
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_first_post_id = ' . intval($row['post_id']) . &quot;, topic_first_poster_name = '&quot; . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']-&gt;escape($row['post_username']) : $_CLASS['core_db']-&gt;escape($row['username'])) . &quot;'&quot;;
+			$sql_data[FORUMS_TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+
+			$next_post_id = (int) $row['post_id'];
+		break;
+
+		case 'delete_last_post':
+			if ($data['topic_type'] != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
+			}
+
+			$update_sql = update_post_information('forum', $forum_id, true);
+			if (sizeof($update_sql))
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] .= ($sql_data[FORUMS_FORUMS_TABLE]) ? ', ' : '';
+				$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', $update_sql[$forum_id]);
+			}
+
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_bumped = 0, topic_bumper = 0, topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+
+			$update_sql = update_post_information('topic', $topic_id, true);
+			if (sizeof($update_sql))
+			{
+				$sql_data[FORUMS_TOPICS_TABLE] .= ', ' . implode(', ', $update_sql[$topic_id]);
+				$next_post_id = (int) str_replace('topic_last_post_id = ', '', $update_sql[$topic_id][0]);
+			}
+			else
+			{
+				$sql = 'SELECT MAX(post_id) as last_post_id
+					FROM ' . FORUMS_POSTS_TABLE . &quot;
+					WHERE topic_id = $topic_id &quot; .
+						((!$_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? 'AND post_approved = 1' : '');
+				$result = $_CLASS['core_db']-&gt;query($sql);
+				$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+
+				$next_post_id = (int) $row['last_post_id'];
+			}
+		break;
+
+		case 'delete':
+			$sql = 'SELECT post_id
+				FROM ' . FORUMS_POSTS_TABLE . &quot;
+				WHERE topic_id = $topic_id &quot; .
+					((!$_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? 'AND post_approved = 1' : '') . '
+					AND post_time &gt; ' . $data['post_time'] . '
+				ORDER BY post_time ASC';
+			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if ($data['topic_type'] != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
+			}
+
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+			$next_post_id = (int) $row['post_id'];
+		break;
+	}
+
+	//$sql_data[CORE_USERS_TABLE] = ($_CLASS['forums_auth']-&gt;acl_get('f_postcount', $forum_id)) ? 'user_posts = user_posts - 1' : '';
+
+	$_CLASS['core_db']-&gt;transaction();
+
+	$where_sql = array(
+		FORUMS_FORUMS_TABLE	=&gt; &quot;forum_id = $forum_id&quot;,
+		FORUMS_TOPICS_TABLE	=&gt; &quot;topic_id = $topic_id&quot;,
+		CORE_USERS_TABLE	=&gt; 'user_id = ' . $data['poster_id']
+	);
+
+	foreach ($sql_data as $table =&gt; $update_sql)
+	{
+		if ($update_sql)
+		{
+			$_CLASS['core_db']-&gt;query(&quot;UPDATE $table SET $update_sql WHERE &quot; . $where_sql[$table]);
+		}
+	}
+
+	$_CLASS['core_db']-&gt;transaction('commit');
+
+	// Adjust posted info for this user by looking for a post by him/her within this topic...
+	/*
+	if ($post_mode != 'delete_topic' &amp;&amp; $config['load_db_track'] &amp;&amp; $_CLASS['core_user']-&gt;is_user)
+	{
+		$sql = 'SELECT poster_id
+			FROM ' . POSTS_TABLE . '
+			WHERE topic_id = ' . $topic_id . '
+				AND poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+		$poster_id = (int) $db-&gt;sql_fetchfield('poster_id');
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		// The user is not having any more posts within this topic
+		if (!$poster_id)
+		{
+			$sql = 'DELETE FROM ' . TOPICS_POSTED_TABLE . '
+				WHERE topic_id = ' . $topic_id . '
+					AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+	}
+	*/
+
+	if ($data['post_reported'] &amp;&amp; ($post_mode != 'delete_topic'))
+	{
+		sync('topic_reported', 'topic_id', array($topic_id));
+	}
+
+	return $next_post_id;
+}
+
+/**
+* Submit Post
+*/
+function submit_post($mode, $subject, $username, $topic_type, &amp;$poll, &amp;$data, $update_message = true)
+{
+	global $config, $_CORE_CONFIG, $_CLASS;
+
+	// We do not handle erasing posts here
+	if ($mode == 'delete')
+	{
+		return false;
+	}
+
+	$current_time = $_CLASS['core_user']-&gt;time;
+
+	if ($mode == 'post')
+	{
+		$post_mode = 'post';
+		$update_message = true;
+	}
+	else if ($mode != 'edit')
+	{
+		$post_mode = 'reply';
+		$update_message = true;
+	}
+	else if ($mode == 'edit')
+	{
+		$post_mode = ($data['topic_first_post_id'] == $data['topic_last_post_id']) ? 'edit_topic' : (($data['topic_first_post_id'] == $data['post_id']) ? 'edit_first_post' : (($data['topic_last_post_id'] == $data['post_id']) ? 'edit_last_post' : 'edit'));
+	}
+
+	// Collect some basic informations about which tables and which rows to update/insert
+	$sql_data = array();
+	$poster_id = ($mode == 'edit') ? $data['poster_id'] : (int) $_CLASS['core_user']-&gt;data['user_id'];
+
+	// Collect Informations
+	switch ($post_mode)
+	{
+		case 'post':
+		case 'reply':
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
+				'forum_id'			=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
+				'poster_id'			=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+				'icon_id'			=&gt; $data['icon_id'],
+				'poster_ip'			=&gt; $_CLASS['core_user']-&gt;ip,
+				'post_time'			=&gt; $current_time,
+				'post_approved'		=&gt; (!$_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? 0 : 1,
+				'enable_html' 		=&gt; $data['enable_html'],
+				'enable_bbcode'		=&gt; $data['enable_bbcode'],
+				'enable_smilies'	=&gt; $data['enable_smilies'],
+				'enable_magic_url'	=&gt; $data['enable_urls'],
+				'enable_sig'		=&gt; $data['enable_sig'],
+				'post_username'		=&gt; (!$_CLASS['core_user']-&gt;is_user) ? $username : '',
+				'post_subject'		=&gt; $subject,
+				'post_text'			=&gt; $data['message'],
+				'post_checksum'		=&gt; $data['message_md5'],
+				'post_attachment'	=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
+				'bbcode_uid'		=&gt; $data['bbcode_uid'],
+				'post_postcount'	=&gt; ($_CLASS['forums_auth']-&gt;acl_get('f_postcount', $data['forum_id'])) ? 1 : 0,
+				'post_edit_locked'	=&gt; $data['post_edit_locked']
+			);
+		break;
+
+		case 'edit_first_post':
+		case 'edit':
+
+			if (!$_CLASS['forums_auth']-&gt;acl_get('m_edit', $data['forum_id']) || $data['post_edit_reason'])
+			{
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
+					'post_edit_time'	=&gt; $current_time
+				);
+
+				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
+			}
+
+		// no break
+
+		case 'edit_last_post':
+		case 'edit_topic':
+
+			if (($post_mode == 'edit_last_post' || $post_mode == 'edit_topic') &amp;&amp; $data['post_edit_reason'])
+			{
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
+					'post_edit_time'	=&gt; $current_time
+				);
+
+				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
+			}
+
+			if (!isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
+			{
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array();
+			}
+
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
+				'forum_id'			=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
+				'poster_id'			=&gt; $data['poster_id'],
+				'icon_id'			=&gt; $data['icon_id'],
+				'post_approved'		=&gt; (!$_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? 0 : 1,
+				'enable_html' 		=&gt; $data['enable_html'],
+				'enable_bbcode'		=&gt; $data['enable_bbcode'],
+				'enable_smilies'	=&gt; $data['enable_smilies'],
+				'enable_magic_url'	=&gt; $data['enable_urls'],
+				'enable_sig'		=&gt; $data['enable_sig'],
+				'post_username'		=&gt; ($username &amp;&amp; $data['poster_id'] == ANONYMOUS) ? $username : '',
+				'post_subject'		=&gt; $subject,
+				'post_edit_reason'	=&gt; $data['post_edit_reason'],
+				'post_edit_user'	=&gt; (int) $data['post_edit_user'],
+				'post_checksum'		=&gt; $data['message_md5'],
+				'post_attachment'	=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
+				'bbcode_uid'		=&gt; $data['bbcode_uid'],
+				'post_edit_locked'	=&gt; $data['post_edit_locked'])
+			);
+
+			if ($update_message)
+			{
+				$sql_data[FORUMS_POSTS_TABLE]['sql']['post_text'] = $data['message'];
+			}
+
+		break;
+	}
+
+	// And the topic ladies and gentlemen
+	switch ($post_mode)
+	{
+		case 'post':
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
+				'topic_poster'				=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+				'topic_time'				=&gt; $current_time,
+				'forum_id'					=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
+				'icon_id'					=&gt; $data['icon_id'],
+				'topic_approved'			=&gt; (!$_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? 0 : 1,
+				'topic_title'				=&gt; $subject,
+				'topic_first_poster_name'	=&gt; (!$_CLASS['core_user']-&gt;is_user &amp;&amp; $username) ? $username : (($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS) ? $_CLASS['core_user']-&gt;data['username'] : ''),
+				'topic_type'				=&gt; $topic_type,
+				'topic_time_limit'			=&gt; ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
+				'topic_attachment'			=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'topic_status'				=&gt; 0,
+				'topic_replies_real'		=&gt; 0,
+				'topic_replies'				=&gt; 0,
+				'topic_views'				=&gt; 0,
+				'topic_moved_id'			=&gt; 0
+			);
+
+			if (isset($poll['poll_options']) &amp;&amp; !empty($poll['poll_options']))
+			{
+				$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array_merge($sql_data[FORUMS_TOPICS_TABLE]['sql'], array(
+					'poll_title'		=&gt; $poll['poll_title'],
+					'poll_start'		=&gt; ($poll['poll_start']) ? $poll['poll_start'] : $current_time,
+					'poll_max_options'	=&gt; $poll['poll_max_options'],
+					'poll_length'		=&gt; ($poll['poll_length'] * 86400),
+					'poll_vote_change'	=&gt; $poll['poll_vote_change'])
+				);
+			}
+
+			$sql_data[CORE_USERS_TABLE]['stat'][] = &quot;user_last_post_time = $current_time&quot; . (($_CLASS['forums_auth']-&gt;acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
+	
+			if ($topic_type != POST_GLOBAL)
+			{
+				if ($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id']))
+				{
+					$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
+				}
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? ', forum_topics = forum_topics + 1' : '');
+			}
+		break;
+
+		case 'reply':
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = 'topic_replies_real = topic_replies_real + 1, topic_bumped = 0, topic_bumper = 0' . (($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? ', topic_replies = topic_replies + 1' : '');
+			$sql_data[CORE_USERS_TABLE]['stat'][] = &quot;user_last_post_time = $current_time&quot; . (($_CLASS['forums_auth']-&gt;acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
+
+			if (($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) &amp;&amp; $topic_type != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
+			}
+		break;
+
+		case 'edit_topic':
+		case 'edit_first_post':
+
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
+				'forum_id'					=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
+				'icon_id'					=&gt; $data['icon_id'],
+				'topic_approved'			=&gt; (!$_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? 0 : 1,
+				'topic_title'				=&gt; $subject,
+				'topic_first_poster_name'	=&gt; $username,
+				'topic_type'				=&gt; $topic_type,
+				'topic_time_limit'			=&gt; ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
+				'poll_title'				=&gt; (isset($poll['poll_options'])) ? $poll['poll_title'] : '',
+				'poll_start'				=&gt; (isset($poll['poll_options'])) ? (($poll['poll_start']) ? $poll['poll_start'] : $current_time) : 0,
+				'poll_max_options'			=&gt; (isset($poll['poll_options'])) ? $poll['poll_max_options'] : 1,
+				'poll_length'				=&gt; (isset($poll['poll_options'])) ? ($poll['poll_length'] * 86400) : 0,
+				'poll_vote_change'			=&gt; (isset($poll['poll_vote_change'])) ? $poll['poll_vote_change'] : 0,
+
+				'topic_attachment'			=&gt; ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0) : (isset($data['topic_attachment']) ? $data['topic_attachment'] : 0)
+			);
+		break;
+	}
+
+	$_CLASS['core_db']-&gt;transaction();
+
+	// Submit new topic
+	if ($post_mode == 'post')
+	{
+		$sql = 'INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' .
+			$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[FORUMS_TOPICS_TABLE]['sql']);
+		$_CLASS['core_db']-&gt;query($sql);
+
+		$data['topic_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_TOPICS_TABLE, 'topic_id');
+
+		$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
+			'topic_id' =&gt; $data['topic_id'])
+		);
+		unset($sql_data[FORUMS_TOPICS_TABLE]['sql']);
+	}
+
+	// Submit new post
+	if ($post_mode == 'post' || $post_mode == 'reply')
+	{
+		if ($post_mode == 'reply')
+		{
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
+				'topic_id' =&gt; $data['topic_id'])
+			);
+		}
+
+		$query = '';
+
+		switch ($_CLASS['core_db']-&gt;db_layer)
+		{
+			case 'mssql':
+			case 'mssql_odbc':
+				$fields = array();
+				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key =&gt; $var)
+				{
+					$fields[] = $key;
+
+					if (is_null($var))
+					{
+						$values[] = 'NULL';
+					}
+					else if (is_string($var))
+					{
+						if ($key !== 'bbcode_bitfield')
+						{
+							$values[] = &quot;'&quot; . $_CLASS['core_db']-&gt;escape($var) . &quot;'&quot;;
+						}
+						else
+						{
+							$values[] = &quot;CAST('&quot; . $var . &quot;' AS varbinary)&quot;;
+						}
+					}
+					else
+					{
+						$values[] = (is_bool($var)) ? intval($var) : $var;
+					}
+				}
+				$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
+
+			case 'sqlite':
+				$fields = array();
+				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key =&gt; $var)
+				{
+					$fields[] = $key;
+
+					if (is_null($var))
+					{
+						$values[] = 'NULL';
+					}
+					else if (is_string($var))
+					{
+						if ($key !== 'bbcode_bitfield')
+						{
+							$values[] = &quot;'&quot; . $_CLASS['core_db']-&gt;escape($var) . &quot;'&quot;;
+						}
+						else
+						{
+							$values[] = &quot;'&quot; . sqlite_udf_encode_binary($var) . &quot;'&quot;;
+						}
+					}
+					else
+					{
+						$values[] = (is_bool($var)) ? intval($var) : $var;
+					}
+				}
+				$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
+
+			default:
+				$query = $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']);
+			break;
+		}
+
+
+		$sql = 'INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .	$query;
+		$_CLASS['core_db']-&gt;query($sql);
+		$data['post_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_POSTS_TABLE, 'post_id');
+
+		if ($post_mode == 'post')
+		{
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
+				'topic_first_post_id'	=&gt; $data['post_id'],
+				'topic_last_post_id'	=&gt; $data['post_id'],
+				'topic_last_post_time'	=&gt; $current_time,
+				'topic_last_poster_id'	=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+				'topic_last_poster_name'=&gt; (!$_CLASS['core_user']-&gt;is_user &amp;&amp; $username) ? $username : (($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS) ? $_CLASS['core_user']-&gt;data['username'] : '')
+			);
+		}
+
+		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
+	}
+
+	$make_global = false;
+
+	// Are we globalising or unglobalising?
+	if ($post_mode == 'edit_first_post' || $post_mode == 'edit_topic')
+	{
+		$sql = 'SELECT topic_type, topic_replies_real, topic_approved
+			FROM ' . FORUMS_TOPICS_TABLE . '
+			WHERE topic_id = ' . $data['topic_id'];
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		// globalise
+		if ($row['topic_type'] != POST_GLOBAL &amp;&amp; $topic_type == POST_GLOBAL)
+		{
+			// Decrement topic/post count
+			$make_global = true;
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
+
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts - ' . ($row['topic_replies_real'] + 1);
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real - 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics - 1' : '');
+
+			// Update forum_ids for all posts
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+				SET forum_id = 0
+				WHERE topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+		// unglobalise
+		else if ($row['topic_type'] == POST_GLOBAL &amp;&amp; $topic_type != POST_GLOBAL)
+		{
+			// Increment topic/post count
+			$make_global = true;
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
+
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + ' . ($row['topic_replies_real'] + 1);
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics + 1' : '');
+
+			// Update forum_ids for all posts
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+				SET forum_id = ' . $data['forum_id'] . '
+				WHERE topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+	}
+
+	// Update the topics table
+	if (isset($sql_data[FORUMS_TOPICS_TABLE]['sql']))
+	{
+		$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data[FORUMS_TOPICS_TABLE]['sql']) . '
+			WHERE topic_id = ' . $data['topic_id'];
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Update the posts table
+	if (isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
+	{
+		switch ($_CLASS['core_db']-&gt;db_layer)
+		{
+			case 'mssql':
+			case 'mssql_odbc':
+				$values = array();
+				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key =&gt; $var)
+				{
+					if (is_null($var))
+					{
+						$values[] = &quot;$key = NULL&quot;;
+					}
+					else if (is_string($var))
+					{
+						if ($key !== 'bbcode_bitfield')
+						{
+							$values[] = &quot;$key = '&quot; . $_CLASS['core_db']-&gt;escape($var) . &quot;'&quot;;
+						}
+						else
+						{
+							$values[] = &quot;$key = CAST('&quot; . $var . &quot;' AS varbinary)&quot;;
+						}
+					}
+					else
+					{
+						$values[] = (is_bool($var)) ? &quot;$key = &quot; . intval($var) : &quot;$key = $var&quot;;
+					}
+				}
+				$query = implode(', ', $values);
+			break;
+
+			case 'sqlite':
+				$values = array();
+				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key =&gt; $var)
+				{
+					if (is_null($var))
+					{
+						$values[] = &quot;$key = NULL&quot;;
+					}
+					else if (is_string($var))
+					{
+						if ($key !== 'bbcode_bitfield')
+						{
+							$values[] = &quot;$key = '&quot; . $_CLASS['core_db']-&gt;escape($var) . &quot;'&quot;;
+						}
+						else
+						{
+							$values[] = &quot;$key ='&quot; . sqlite_udf_encode_binary($var) . &quot;'&quot;;
+						}
+					}
+					else
+					{
+						$values[] = (is_bool($var)) ? &quot;$key = &quot; . intval($var) : &quot;$key = $var&quot;;
+					}
+				}
+				$query = implode(', ', $values);
+			break;
+
+			default:
+				$query = $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data[FORUMS_POSTS_TABLE]['sql']);
+			break;
+		}
+
+		$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+			SET ' . $query . '
+			WHERE post_id = ' . $data['post_id'];
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Update Poll Tables
+	if (isset($poll['poll_options']) &amp;&amp; !empty($poll['poll_options']))
+	{
+		$cur_poll_options = array();
+
+		if ($poll['poll_start'] &amp;&amp; $mode == 'edit')
+		{
+			$sql = 'SELECT * FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
+				WHERE topic_id = ' . $data['topic_id'] . '
+				ORDER BY poll_option_id';
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$cur_poll_options = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$cur_poll_options[] = $row;
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+
+		$sql_insert_ary = array();
+		for ($i = 0, $size = sizeof($poll['poll_options']); $i &lt; $size; $i++)
+		{
+			if (trim($poll['poll_options'][$i]))
+			{
+				if (empty($cur_poll_options[$i]))
+				{
+					$sql_insert_ary[] = array(
+						'poll_option_id'	=&gt; (int) $i,
+						'topic_id'			=&gt; (int) $data['topic_id'],
+						'poll_option_text'	=&gt; (string) $poll['poll_options'][$i]
+					);
+				}
+				else if ($poll['poll_options'][$i] != $cur_poll_options[$i])
+				{
+					$sql = &quot;UPDATE &quot; . FORUMS_POLL_OPTIONS_TABLE . &quot;
+						SET poll_option_text = '&quot; . $_CLASS['core_db']-&gt;escape($poll['poll_options'][$i]) . &quot;'
+						WHERE poll_option_id = &quot; . $cur_poll_options[$i]['poll_option_id'] . &quot;
+							AND topic_id = &quot; . $data['topic_id'];
+					$_CLASS['core_db']-&gt;query($sql);
+				}
+			}
+		}
+
+		if (sizeof($sql_insert_ary))
+		{
+			switch ($_CLASS['core_db']-&gt;db_layer)
+			{
+				case 'mysql':
+				case 'mysql4':
+				case 'mysqli':
+					$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('MULTI_INSERT', $sql_insert_ary));
+				break;
+
+				default:
+					foreach ($sql_insert_ary as $ary)
+					{
+						$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $ary));
+					}
+				break;
+			}
+		}
+
+		if (count($poll['poll_options']) &lt; count($cur_poll_options))
+		{
+			$sql = 'DELETE FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
+				WHERE poll_option_id &gt;= ' . count($poll['poll_options']) . '
+					AND topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+	}
+
+	// Submit Attachments
+	if (sizeof($data['attachment_data']) &amp;&amp; $data['post_id'] &amp;&amp; in_array($mode, array('post', 'reply', 'quote', 'edit')))
+	{
+		$space_taken = $files_added = 0;
+
+		foreach ($data['attachment_data'] as $pos =&gt; $attach_row)
+		{
+			if ($attach_row['attach_id'])
+			{
+				// update entry in db if attachment already stored in db and filespace
+				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . &quot;
+					SET attach_comment = '&quot; . $_CLASS['core_db']-&gt;escape($attach_row['attach_comment']) . &quot;'
+					WHERE attach_id = &quot; . (int) $attach_row['attach_id'];
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+			else
+			{
+				// insert attachment into db
+				if (!@file_exists($config['upload_path'] . '/' . basename($attach_row['physical_filename'])))
+				{
+					continue;
+				}
+
+				$attach_sql = array(
+					'post_msg_id'		=&gt; $data['post_id'],
+					'topic_id'			=&gt; $data['topic_id'],
+					'in_message'		=&gt; 0,
+					'poster_id'			=&gt; $poster_id,
+					'physical_filename'	=&gt; basename($attach_row['physical_filename']),
+					'real_filename'		=&gt; basename($attach_row['real_filename']),
+					'download_count'	=&gt; 0,
+					'attach_comment'	=&gt; $attach_row['attach_comment'],
+					'extension'			=&gt; $attach_row['extension'],
+					'mimetype'			=&gt; $attach_row['mimetype'],
+					'filesize'			=&gt; $attach_row['filesize'],
+					'filetime'			=&gt; $attach_row['filetime'],
+					'thumbnail'			=&gt; $attach_row['thumbnail']
+				);
+
+				$sql = 'INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' .
+					$_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql);
+				$_CLASS['core_db']-&gt;query($sql);
+
+				$space_taken += $attach_row['filesize'];
+				$files_added++;
+			}
+		}
+
+		if (sizeof($data['attachment_data']))
+		{
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+				SET post_attachment = 1
+				WHERE post_id = ' . $data['post_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+				SET topic_attachment = 1
+				WHERE topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+
+		set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
+		set_config('num_files', $config['num_files'] + $files_added, true);
+	}
+
+	$_CLASS['core_db']-&gt;transaction('commit');
+
+	if ($post_mode == 'post' || $post_mode == 'reply' || $post_mode == 'edit_last_post')
+	{
+		if ($topic_type != POST_GLOBAL)
+		{
+			$update_sql = update_post_information('forum', $data['forum_id'], true);
+			if (sizeof($update_sql))
+			{
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', $update_sql[$data['forum_id']]);
+			}
+		}
+
+		$update_sql = update_post_information('topic', $data['topic_id'], true);
+		if (sizeof($update_sql))
+		{
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update_sql[$data['topic_id']]);
+		}
+	}
+
+	if ($make_global)
+	{
+		$update_sql = update_post_information('forum', $data['forum_id'], true);
+		if (sizeof($update_sql))
+		{
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', $update_sql[$data['forum_id']]);
+		}
+	}
+
+	if ($post_mode == 'edit_topic')
+	{
+		$update_sql = update_post_information('topic', $data['topic_id'], true);
+		if (sizeof($update_sql))
+		{
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update_sql[$data['topic_id']]);
+		}
+	}
+
+	// Update total post count, do not consider moderated posts/topics
+	if ($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id']))
+	{
+		if ($post_mode == 'post')
+		{
+			set_config('num_topics', $config['num_topics'] + 1, true);
+			set_config('num_posts', $config['num_posts'] + 1, true);
+		}
+
+		if ($post_mode == 'reply')
+		{
+			set_config('num_posts', $config['num_posts'] + 1, true);
+		}
+	}
+
+	// Update forum stats
+	$_CLASS['core_db']-&gt;transaction();
+
+	$where_sql = array(FORUMS_POSTS_TABLE =&gt; 'post_id = ' . $data['post_id'], FORUMS_TOPICS_TABLE =&gt; 'topic_id = ' . $data['topic_id'], FORUMS_FORUMS_TABLE =&gt; 'forum_id = ' . $data['forum_id'], CORE_USERS_TABLE =&gt; 'user_id = ' . $_CLASS['core_user']-&gt;data['user_id']);
+
+	foreach ($sql_data as $table =&gt; $update_ary)
+	{
+		if (isset($update_ary['stat']) &amp;&amp; implode('', $update_ary['stat']))
+		{
+			$_CLASS['core_db']-&gt;query(&quot;UPDATE $table SET &quot; . implode(', ', $update_ary['stat']) . ' WHERE ' . $where_sql[$table]);
+		}
+	}
+
+	// Delete topic shadows (if any exist). We do not need a shadow topic for an global announcement
+	if ($make_global)
+	{
+		$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . '
+			WHERE topic_moved_id = ' . $data['topic_id'];
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Index message contents
+	if (false &amp;&amp; $update_message &amp;&amp; $data['enable_indexing'])
+	{
+		// Select the search method and do some additional checks to ensure it can actually be utilised
+		$search_type = basename($config['search_type']);
+
+		if (!file_exists($phpbb_root_path . 'includes/search/' . $search_type . '.' . $phpEx))
+		{
+			trigger_error('NO_SUCH_SEARCH_MODULE');
+		}
+
+		require(&quot;{$phpbb_root_path}includes/search/$search_type.$phpEx&quot;);
+
+		$error = false;
+		$search = new $search_type($error);
+
+		if ($error)
+		{
+			trigger_error($error);
+		}
+
+		$search-&gt;index($mode, $data['post_id'], $data['message'], $subject, $_CLASS['core_user']-&gt;lang['ENCODING'], $poster_id, ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id']);
+	}
+
+	$_CLASS['core_db']-&gt;transaction('commit');
+
+	// Delete draft if post was loaded...
+	$draft_id = request_var('draft_loaded', 0);
+	if ($draft_id)
+	{
+		$sql = 'DELETE FROM ' . FORUMS_DRAFTS_TABLE . &quot;
+			WHERE draft_id = $draft_id
+				AND user_id = {$_CLASS['core_user']-&gt;data['user_id']}&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Topic Notification, do not change if moderator is changing other users posts...
+	if ($_CLASS['core_user']-&gt;data['user_id'] == $poster_id)
+	{
+		if (!$data['notify_set'] &amp;&amp; $data['notify'])
+		{
+			$notify_sql = array(
+				'user_id'		=&gt; $_CLASS['core_user']-&gt;data['user_id'],
+				'forum_id'		=&gt; $data['forum_id'],
+				'topic_id'		=&gt; $data['topic_id'],
+				'notify_type'	=&gt; $poster_id,
+				'notify_status'	=&gt; 0,
+			);
+				
+			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $notify_sql));
+			unset($notify_sql);
+		}
+		else if ($data['notify_set'] &amp;&amp; !$data['notify'])
+		{
+			$sql = 'DELETE FROM ' . FORUMS_TOPICS_WATCH_TABLE . '
+				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+					AND topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+	}
+
+	if ($mode == 'post' || $mode == 'reply' || $mode == 'quote')
+	{
+		// Mark this topic as posted to
+		markread('post', $data['forum_id'], $data['topic_id'], $data['post_time']);
+	}
+
+	// Mark this topic as read
+	// We do not use post_time here, this is intended (post_time can have a date in the past if editing a message)
+	markread('topic', $data['forum_id'], $data['topic_id'], $_CLASS['core_user']-&gt;time);
+
+	// Send Notifications
+	if ($mode != 'edit' &amp;&amp; $mode != 'delete' &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])))
+	{
+		user_notification($mode, $subject, $data['topic_title'], $data['forum_name'], $data['forum_id'], $data['topic_id'], $data['post_id']);
+	}
+
+	if ($mode == 'post')
+	{
+		$url = ($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? generate_link('forums&amp;file=viewtopic&amp;f=' . $data['forum_id'] . '&amp;t=' . $data['topic_id']) : generate_link('forums&amp;file=viewforum&amp;f=' . $data['forum_id']);
+	}
+	else
+	{
+		$url = ($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ?  generate_link(&quot;forums&amp;file=viewtopic&amp;f={$data['forum_id']}&amp;t={$data['topic_id']}&amp;p={$data['post_id']}&quot;) . &quot;#p{$data['post_id']}&quot; : generate_link(&quot;forums&amp;file=viewtopic&amp;f={$data['forum_id']}&amp;t={$data['topic_id']}&quot;);
+	}
+
+	return $url;
+}
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/functions_user.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -176,20 +176,19 @@
 // add a required array here, then find feilds that are not in the data array
 	$_CLASS['core_db']-&gt;transaction();
 
-	$sql = 'INSERT INTO ' . CORE_USERS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $data);
-	$_CLASS['core_db']-&gt;query($sql);
+	$_CLASS['core_db']-&gt;sql_query_build('INSERT', $data, CORE_USERS_TABLE);
 
 	$data['user_id'] = $_CLASS['core_db']-&gt;insert_id(CORE_USERS_TABLE, 'user_id');
 
 	if ($group_add)
 	{
-		$sql = 'INSERT INTO ' . CORE_USER_GROUP_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
+		$data2 = array(
 			'group_id'		=&gt; (int) $data['user_group'],
 			'user_id'		=&gt; (int) $data['user_id'],
 			'member_status'	=&gt; $data['user_status']
-		));
-		
-		$_CLASS['core_db']-&gt;query($sql);
+		);
+
+		$_CLASS['core_db']-&gt;sql_query_build('INSERT', $data2, CORE_USER_GROUP_TABLE);
 	}
 
 	$_CLASS['core_db']-&gt;transaction('commit');
@@ -506,20 +505,26 @@
 
 	$_CLASS['core_db']-&gt;transaction();
 
+	$data = array();
 	foreach ($user_id as $u_id)
 	{
 		foreach ($group_id as $g_id)
 		{
-			$data = array(
+			$data[] = array(
 				'group_id'		=&gt; (int) $g_id,
 				'user_id'		=&gt; (int) $u_id,
 				'member_status'	=&gt; (int) $status,
 			);
 		
-			$_CLASS['core_db']-&gt;query('INSERT INTO '.USER_GROUP_TABLE.' '.$_CLASS['core_db']-&gt;sql_build_array('INSERT', $data));
+			//$_CLASS['core_db']-&gt;query('INSERT INTO '.USER_GROUP_TABLE.' '.$_CLASS['core_db']-&gt;sql_build_array('INSERT', $data));
 		}
 	}
 
+	if (!empty($data)) 
+	{
+		$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $data, USER_GROUP_TABLE);
+	}
+
 	$_CLASS['core_db']-&gt;transaction('commit');
 }
 

Modified: cms/trunk/includes/session.php
===================================================================
--- cms/trunk/includes/session.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/session.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -213,7 +213,7 @@
 			'session_autologin'	=&gt; (string) $this-&gt;autologin_code,
 		);
 
-		$_CLASS['core_db']-&gt;query('INSERT INTO ' . CORE_SESSIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $session_data));
+		$_CLASS['core_db']-&gt;sql_query_build('INSERT', $session_data, CORE_SESSIONS_TABLE);
 
 		$this-&gt;new_session =  true;
 
@@ -258,7 +258,7 @@
 			'auto_login_time'		=&gt; (int) $this-&gt;time,
 		);
 
-		$_CLASS['core_db']-&gt;query('INSERT INTO ' . CORE_SESSIONS_AUTOLOGIN_TABLE . ' '.	$_CLASS['core_db']-&gt;sql_build_array('INSERT', $data_array));
+		$_CLASS['core_db']-&gt;sql_query_build('INSERT', $data_array, CORE_SESSIONS_AUTOLOGIN_TABLE);
 
 		$this-&gt;set_cookie('ali', $this-&gt;data['user_id'], $this-&gt;time + 2592000);
 		$this-&gt;set_cookie('alc', $this-&gt;autologin_code, $this-&gt;time + 2592000);

Modified: cms/trunk/includes/templates/admin/modules/index.html
===================================================================
--- cms/trunk/includes/templates/admin/modules/index.html	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/templates/admin/modules/index.html	2006-08-04 13:47:39 UTC (rev 179)
@@ -1,7 +1,16 @@
 &lt;!-- DISPLAY_HEADER --&gt;
 
 { $THEME_TABLE_OPEN }
-
+&lt;table border=&quot;0&quot; class=&quot;tablebg&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot; width=&quot;100%&quot;&gt;
+	&lt;tbody&gt;
+		&lt;tr&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot; onmouseover=&quot;this.className='row2'&quot; onmouseout=&quot;this.className='row1'&quot; onclick=&quot;location.href='{ $B_SEARCH }'; return false;&quot;&gt;&lt;a href=&quot;{ $B_SEARCH }&quot;&gt;{ $L_SEARCH_FOR_MODULE }&lt;/a&gt;&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;&nbsp;&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;&nbsp;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/tbody&gt;
+&lt;/table&gt;
+&lt;div style=&quot;padding: 3px&quot;&gt;&lt;/div&gt;
 &lt;table class=&quot;tablebg&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot; width=&quot;100%&quot;&gt;
     &lt;tbody&gt;
 		&lt;tr&gt;

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/user.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -285,7 +285,7 @@
 
 	function add_img($img_file = false, $module = false, $lang = false)
 	{
-		$img_file = ($img_file) ? &quot;$img_file.php&quot; : 'index.php';
+		//$img_file = ($img_file) ? &quot;$img_file.php&quot; : 'index.php';
 
 		if (!$img_file || !ereg('/', $img_file))
 		{
@@ -294,19 +294,39 @@
 			$module = ($module) ? $module : $_CLASS['core_display']-&gt;page['page_name'];
 			$lang = ($lang) ? $lang : $this-&gt;lang_name;
 
+			$img_file = ($img_file) ? $img_file.'_'.$lang.'.php' : 'index_'.$lang.'.php';
+			$img_file2 = ($img_file) ? &quot;$img_file.php&quot; : 'index.php';
+
 			if (file_exists($_CLASS['core_display']-&gt;theme_path.&quot;/images/modules/$module/$img_file&quot;))
 			{
-				include $_CLASS['core_display']-&gt;theme_path.&quot;/images/modules/$module/$img_file&quot;;
+				require_once $_CLASS['core_display']-&gt;theme_path.&quot;/images/modules/$module/$img_file&quot;;
 			}
+			elseif (file_exists(SITE_FILE_ROOT.'modules/'.$module.&quot;/images/$img_file&quot;))
+			{
+				require_once SITE_FILE_ROOT.'modules/'.$module.&quot;/images/$img_file&quot;;
+			}
+			elseif (file_exists($_CLASS['core_display']-&gt;theme_path.&quot;/images/modules/$module/$img_file2&quot;))
+			{
+				require_once $_CLASS['core_display']-&gt;theme_path.&quot;/images/modules/$module/$img_file2&quot;;
+			}
+			elseif (file_exists(SITE_FILE_ROOT.'modules/'.$module.&quot;/images/$img_file2&quot;))
+			{
+				require_once SITE_FILE_ROOT.'modules/'.$module.&quot;/images/$img_file2&quot;;
+			}
 			else
 			{
-				include SITE_FILE_ROOT.'modules/'.$module.&quot;/images/$img_file&quot;;
+				return false;
 			}
 		}
+		elseif (file_exists($img_file.'.php'))
+		{
+			require_once $img_file.'.php';
+		}
 		else
 		{
-			include $img_file.'.php';
+			return false;
 		}
+		return true;
 	}
 	
 	function get_lang($lang)
@@ -331,8 +351,7 @@
 		if (!is_array($this-&gt;img[$img]))
 		{
 			list($src, $height, $width) = explode('*', $this-&gt;img[$img]);
-			$src = '&quot;' . str_replace('{LANG}', $this-&gt;lang_name, $src) . '&quot;'; // remove once everything is updated
-
+			//$src = '&quot;' . str_replace('{LANG}', $this-&gt;lang_name, $src) . '&quot;'; // remove once everything is updated
 			$this-&gt;img[$img] = array('src' =&gt; $src, 'width' =&gt; $width, 'height' =&gt; $height);
 		}
 
@@ -359,7 +378,7 @@
 		{
 			if (mb_strpos($lang_file, '/') !== false)
 			{
-				include SITE_FILE_ROOT.&quot;language/$this-&gt;lang_name/$lang_file&quot;;
+				include SITE_FILE_ROOT.&quot;language/{$this-&gt;lang_name}/$lang_file&quot;;
 
 				return;
 			}
@@ -450,17 +469,6 @@
 
 		return '&lt;img src=' . $img['src'] .$width . $height .' alt=&quot;' . $alt . '&quot; title=&quot;' . $alt . '&quot; /&gt;';
 	}
-/*
-	function optionget($key, $data = false)
-	{
-		return $this-&gt;user_data_get($key);
-	}
-
-	function optionset($key, $value, $data = false)
-	{
-		return $this-&gt;user_data_set($key, $value);
-	}
-*/
 }
 
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/install/build_data.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -30,7 +30,7 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_smilies', 'images/smilies', 'string', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'site_name', '', 'string', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_theme', 'viperal', 'string', 1)&quot;);
-$content = $_CLASS['core_db']-&gt;escape('&lt;a href=&quot;feed.php?feed=rss1&quot; title=&quot;RSS 1.0 / RDF Feed&quot;&gt;&lt;img alt=&quot;RSS 1.0 / RDF&quot; src=&quot;images/rss10_logo.gif&quot; /&gt;&lt;/a&gt; &lt;a href=&quot;feed.php?feed=rss2&quot; title=&quot;RSS 2.0 Feed&quot;&gt;&lt;img alt=&quot;RSS 2.0&quot; src=&quot;images/rss20_logo.gif&quot; /&gt;&lt;/a&gt; &lt;a href=&quot;feed.php?feed=rss&quot; title=&quot;RSS 0.91 Feed&quot;&gt;&lt;img alt=&quot;RSS 0.9&quot; src=&quot;images/rss090_logo.gif&quot; /&gt;&lt;/a&gt;');
+$content = $_CLASS['core_db']-&gt;escape('&lt;a href=&quot;feed.php?mod=articles&amp;feed=rss1&quot; title=&quot;RSS 1.0 / RDF Feed&quot;&gt;&lt;img alt=&quot;RSS 1.0 / RDF&quot; src=&quot;images/rss10_logo.gif&quot; /&gt;&lt;/a&gt; &lt;a href=&quot;feed.php?mod=articles&amp;feed=rss2&quot; title=&quot;RSS 2.0 Feed&quot;&gt;&lt;img alt=&quot;RSS 2.0&quot; src=&quot;images/rss20_logo.gif&quot; /&gt;&lt;/a&gt; &lt;a href=&quot;feed.php?mod=articles&amp;feed=rss&quot; title=&quot;RSS 0.91 Feed&quot;&gt;&lt;img alt=&quot;RSS 0.9&quot; src=&quot;images/rss090_logo.gif&quot; /&gt;&lt;/a&gt;');
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot1', '$content', 'string', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot2', '', 'string', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_lang', 'en', 'string', 1)&quot;);

Modified: cms/trunk/modules/control_panel/modules/ucp_zebra.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_zebra.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/control_panel/modules/ucp_zebra.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -26,13 +26,13 @@
 {
 	if ($add_users = get_variable('add', 'REQUEST', false))
 	{
+		$add_users = array_map('trim', array_map('strtolower', explode(&quot;\n&quot;, $add_users)));
+
 		require_once SITE_FILE_ROOT.'includes/forums/functions.php';
 		load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 		
 		$_CLASS['forums_auth']-&gt;acl($_CLASS['core_user']-&gt;data);
 
-		$add_users = explode(&quot;\n&quot;, $add_users);
-
 		$sql = 'SELECT z.*, u.username 
 			FROM ' . ZEBRA_TABLE . ' z, ' . CORE_USERS_TABLE . ' u 
 			WHERE z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
@@ -44,23 +44,50 @@
 		{
 			if ($row['friend'])
 			{
-				$friends[] = $row['username'];
+				$friends[] = strtolower($row['username']);
 			}
 			else
 			{
-				$foes[] = $row['username'];
+				$foes[] = strtolower($row['username']);
 			}
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
-		$add_users = array_diff($add_users, $friends, $foes, array($_CLASS['core_user']-&gt;data['username']));
-		unset($friends, $foes);
+		// remove friends from the username array
+		$n = count($add_users);
+		$add_users = array_diff($add_users, $friends);
+
+		if (count($add_users) &lt; $n &amp;&amp; $mode === 'foes')
+		{
+			$error[] = $_CLASS['core_user']-&gt;get_lang('NOT_ADDED_FOES_FRIENDS');
+		}
+
+		// remove foes from the username array
+		$n = count($add_users);
+		$add_users = array_diff($add_users, $foes);
+
+		if (count($add_users) &lt; $n &amp;&amp; $mode === 'friends')
+		{
+			$error[] = $_CLASS['core_user']-&gt;get_lang('NOT_ADDED_FRIENDS_FOES');
+		}
+
+		// remove the user himself from the username array
+		$n = sizeof($add_users);
+		$add_users = array_diff($add_users, array(strtolower($_CLASS['core_user']-&gt;data['username'])));
+
+		if (sizeof($add_users) &lt; $n)
+		{
+			$error[] = $_CLASS['core_user']-&gt;get_lang('NOT_ADDED_' . $l_mode . '_SELF');
+		}
+	
+		//$add_users = array_diff($add_users, $friends, $foes, array($_CLASS['core_user']-&gt;data['username']));
+		unset($friends, $foes, $n);
 
 		if (!empty($add_users))
 		{
 			$sql = 'SELECT user_id, user_type, user_status
 				FROM ' . CORE_USERS_TABLE . &quot; 
-				WHERE username IN ('&quot; .implode(&quot;', '&quot;, $_CLASS['core_db']-&gt;escape_array($add_users)).&quot;')&quot;;
+				WHERE LOWER(username) IN ('&quot; .implode(&quot;', '&quot;, $_CLASS['core_db']-&gt;escape_array($add_users)).&quot;')&quot;;
 			$result = $_CLASS['core_db']-&gt;query($sql);
 
 			$add_users = array();
@@ -88,7 +115,13 @@
 						}
 					}
 
-					// This may not be right ... it may yield true when perms equate to deny
+					$perms = array_unique($perms);
+
+					if (!empty($perms))
+					{
+						$error[] = $_CLASS['core_user']-&gt;get_lang('NOT_ADDED_FOES_MOD_ADMIN');
+					}
+
 					$add_users = array_diff($add_users, $perms);
 					unset($perms);
 				}
@@ -96,10 +129,18 @@
 				if (!empty($add_users))
 				{
 					$sql_mode = ($this-&gt;mode === 'friends') ? 'friend' : 'foe';
+					
+					$sql_array = array();
+					foreach ($add_users as $zebra_id)
+					{
+						$sql_array[] = array(
+							'user_id'		=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+							'zebra_id'		=&gt; (int) $zebra_id,
+							$sql_mode		=&gt; 1
+						);
+					}
 
-					$sql = 'INSERT INTO ' . ZEBRA_TABLE . &quot; (user_id, zebra_id, $sql_mode) 
-						VALUES &quot; . implode(', ', preg_replace('#^([0-9]+)$#', '(' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;, \\1, 1)&quot;,  $user_id_ary));
-					$_CLASS['core_db']-&gt;query($sql);
+					$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $sql_array, ZEBRA_TABLE);
 				}
 				else
 				{
@@ -109,7 +150,7 @@
 			}
 			else
 			{
-				$error[] = 'USER_NOT_FOUND';
+				$error[] = 'USER_NOT_FOUND_OR_INACTIVE';
 			}
 			
 			$_CLASS['core_db']-&gt;free_result($result);
@@ -131,13 +172,13 @@
 	}
 	else
 	{
-		$_CLASS['core_template']-&gt;assign('ERROR', implode('&lt;br /&gt;', preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error)));
+		$_CLASS['core_template']-&gt;assign('ERROR', implode('&lt;br /&gt;', $error));
 	}
 }
 
 $sql_and = ($this-&gt;mode === 'friends') ? 'z.friend = 1' : 'z.foe = 1';
 
-$sql = 'SELECT z.*, u.username 
+$sql = 'SELECT u.user_id, u.username 
 	FROM ' . ZEBRA_TABLE . ' z, ' . CORE_USERS_TABLE . ' u 
 	WHERE z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
 		AND $sql_and 
@@ -147,7 +188,7 @@
 $username_options = '';
 while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 {
-	$username_options .= '&lt;option value=&quot;' . $row['zebra_id'] . '&quot;&gt;' . $row['username'] . '&lt;/option&gt;';
+	$username_options .= '&lt;option value=&quot;' . $row['user_id'] . '&quot;&gt;' . $row['username'] . '&lt;/option&gt;';
 }
 $_CLASS['core_db']-&gt;free_result($result);
 

Added: cms/trunk/modules/forums/images/background.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/background.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/cellpic.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/cellpic.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/cellpic1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/cellpic1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/cellpic2.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/cellpic2.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/cellpic3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/cellpic3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/created_by.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/created_by.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_aim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_aim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_approve.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_approve.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_edit.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_edit.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_email.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_email.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_icq.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_icq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_info.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_info.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_ip.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_ip.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_jabber.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_jabber.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_msnm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_msnm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_offline.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_offline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_online.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_online.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_post.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_post.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_post_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_post_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_profile.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_quote.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_quote.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_reply_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_reply_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_report.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_report.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_search.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_www.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_www.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_yim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_yim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_announce.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_announce.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_announce_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_announce_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_announce_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_announce_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_announce_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_announce_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_hot_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_hot_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_link_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_link_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_lock_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_lock_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_lock_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_lock_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_lock_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_lock_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_locked_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_locked_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_moved.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_moved.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new_hot_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new_hot_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_sticky.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_sticky.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_sticky_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_sticky_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_sticky_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_sticky_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_sticky_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_sticky_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_attach.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_attach.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_latest_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_latest_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_faq.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_faq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_groups.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_groups.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_login.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_login.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_members.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_members.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_message.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_message.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_profile.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_register.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_register.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_search.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_minipost.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_minipost.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_minipost_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_minipost_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_newest_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_newest_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_reported.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_reported.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_unapproved.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_unapproved.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/index_en.php
===================================================================
--- cms/trunk/modules/forums/images/index_en.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/forums/images/index_en.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -0,0 +1,92 @@
+&lt;?php
+
+global $_CLASS;
+
+$_CLASS['core_template']-&gt;assign('T_IMAGE_PATH',  'modules/forums/images/');
+
+$this-&gt;img = array(
+	'bbcode_bitfield' =&gt; '6913',
+    'btn_post' =&gt; 'modules/forums/images/en/btn_post.gif*27*97',
+    'btn_post_pm' =&gt; 'modules/forums/images/en/btn_post_pm.gif*27*97',
+    'btn_reply' =&gt; 'modules/forums/images/en/btn_reply.gif*27*97',
+    'btn_reply_pm' =&gt; 'modules/forums/images/en/btn_reply_pm.gif*20*90',
+    'btn_locked' =&gt; 'modules/forums/images/en/btn_locked.gif*27*97',
+    'btn_profile' =&gt; 'modules/forums/images/en/btn_profile.gif*20*72',
+    'btn_pm' =&gt; 'modules/forums/images/en/btn_pm.gif*20*72',
+    'btn_delete' =&gt; 'modules/forums/images/en/btn_delete.gif*20*20',
+    'btn_info' =&gt; 'modules/forums/images/en/btn_info.gif*20*20',
+    'btn_quote' =&gt; 'modules/forums/images/en/btn_quote.gif*20*90',
+    'btn_search' =&gt; 'modules/forums/images/en/btn_search.gif*20*72',
+    'btn_edit' =&gt; 'modules/forums/images/en/btn_edit.gif*20*90',
+    'btn_report' =&gt; 'modules/forums/images/en/btn_report.gif*20*20',
+    'btn_email' =&gt; 'modules/forums/images/en/btn_email.gif*20*72',
+    'btn_www' =&gt; 'modules/forums/images/en/btn_www.gif*20*72',
+    'btn_icq' =&gt; 'modules/forums/images/en/btn_icq.gif*20*72',
+    'btn_aim' =&gt; 'modules/forums/images/en/btn_aim.gif*20*72',
+    'btn_yim' =&gt; 'modules/forums/images/en/btn_yim.gif*20*72',
+    'btn_msnm' =&gt; 'modules/forums/images/en/btn_msnm.gif*20*72',
+    'btn_jabber' =&gt; 'modules/forums/images/en/btn_jabber.gif*20*72',
+    'btn_online' =&gt; 'modules/forums/images/en/btn_online.gif*20*72',
+    'btn_offline' =&gt; 'modules/forums/images/en/btn_offline.gif*20*72',
+    'btn_friend' =&gt; '',
+    'btn_foe' =&gt; '',
+    'icon_unapproved' =&gt; 'modules/forums/images/icon_unapproved.gif*18*19',
+    'icon_reported' =&gt; 'modules/forums/images/icon_reported.gif*18*19',
+    'icon_attach' =&gt; 'modules/forums/images/icon_attach.gif*18*14',
+    'icon_post' =&gt; 'modules/forums/images/icon_minipost.gif*9*12',
+    'icon_post_new' =&gt; 'modules/forums/images/icon_minipost_new.gif*9*12',
+    'icon_post_latest' =&gt; 'modules/forums/images/icon_latest_reply.gif*9*18',
+    'icon_post_newest' =&gt; 'modules/forums/images/icon_newest_reply.gif*9*18',
+    'forum' =&gt; 'modules/forums/images/folder_big.gif*25*46',
+    'forum_new' =&gt; 'modules/forums/images/folder_new_big.gif*25*46',
+    'forum_locked' =&gt; 'modules/forums/images/folder_locked_big.gif*25*46',
+    'forum_link' =&gt; 'modules/forums/images/folder_link_big.gif*25*46',
+    'sub_forum' =&gt; 'modules/forums/images/subfolder_big.gif*25*46',
+    'sub_forum_new' =&gt; 'modules/forums/images/subfolder_new_big.gif*25*46',
+    'folder' =&gt; 'modules/forums/images/folder.gif*18*19',
+    'folder_moved' =&gt; 'modules/forums/images/folder_moved.gif*18*19',
+    'folder_posted' =&gt; 'modules/forums/images/folder_posted.gif*18*19',
+    'folder_new' =&gt; 'modules/forums/images/folder_new.gif*18*19',
+    'folder_new_posted' =&gt; 'modules/forums/images/folder_new_posted.gif*18*19',
+    'folder_hot' =&gt; 'modules/forums/images/folder_hot.gif*18*19',
+    'folder_hot_posted' =&gt; 'modules/forums/images/folder_hot_posted.gif*18*19',
+    'folder_hot_new' =&gt; 'modules/forums/images/folder_new_hot.gif*18*19',
+    'folder_hot_new_posted' =&gt; 'modules/forums/images/folder_new_hot_posted.gif*18*19',
+    'folder_locked' =&gt; 'modules/forums/images/folder_lock.gif*18*19',
+    'folder_locked_posted' =&gt; 'modules/forums/images/folder_lock_posted.gif*18*19',
+    'folder_locked_new' =&gt; 'modules/forums/images/folder_lock_new.gif*18*19',
+    'folder_locked_new_posted' =&gt; 'modules/forums/images/folder_lock_new_posted.gif*18*19',
+    'folder_sticky' =&gt; 'modules/forums/images/folder_sticky.gif*18*19',
+    'folder_sticky_posted' =&gt; 'modules/forums/images/folder_sticky_posted.gif*18*19',
+    'folder_sticky_new' =&gt; 'modules/forums/images/folder_sticky_new.gif*18*19',
+    'folder_sticky_new_posted' =&gt; 'modules/forums/images/folder_sticky_new_posted.gif*18*19',
+    'folder_announce' =&gt; 'modules/forums/images/folder_announce.gif*18*19',
+    'folder_announce_posted' =&gt; 'modules/forums/images/folder_announce_posted.gif*18*19',
+    'folder_announce_new' =&gt; 'modules/forums/images/folder_announce_new.gif*18*19',
+    'folder_announce_new_posted' =&gt; 'modules/forums/images/folder_announce_new_posted.gif*18*19',
+    'folder_global' =&gt; '',
+    'folder_global_posted' =&gt; '',
+    'folder_global_new' =&gt; '',
+    'folder_global_new_posted' =&gt; '',
+    'poll_left'		=&gt; 'modules/forums/images/vote_lcap.gif*12*4',
+    'poll_center'	=&gt; 'modules/forums/images/voting_bar.gif*12*4',
+    'poll_right'	=&gt; 'modules/forums/images/vote_rcap.gif*12*4',
+    'attach_progress_bar' =&gt; 'modules/forums/images/progress_bar.gif*16*280',
+    'karma_left' =&gt; '',
+    'karma_center' =&gt; 'modules/forums/images/karma/karma{SUFFIX}.gif*6*69',
+    'karma_right' =&gt; '',
+    'pagination_sep' =&gt; ', ',
+    'image_register' =&gt; 'modules/forums/images/icon_mini_register.gif',
+    'user_icon1' =&gt; '',
+    'user_icon2' =&gt; '',
+    'user_icon3' =&gt; '',
+    'user_icon4' =&gt; '',
+    'user_icon5' =&gt; '',
+    'user_icon6' =&gt; '', 
+    'user_icon7' =&gt; '',
+    'user_icon8' =&gt; '',
+    'user_icon9' =&gt; '',
+    'user_icon10' =&gt; '',
+);
+
+?&gt;
\ No newline at end of file

Added: cms/trunk/modules/forums/images/karma/karma-1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma-2.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma-3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma-4.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-4.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma-5.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-5.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma0.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma0.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma2.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma4.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma4.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma5.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma5.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/no_avatar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/no_avatar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/progress_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/progress_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/spacer.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/spacer.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/subfolder_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/subfolder_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/subfolder_new_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/subfolder_new_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_move.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_move.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_split.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_split.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_unlock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_unlock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/vote_lcap.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/vote_lcap.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/vote_rcap.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/vote_rcap.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/voting_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/voting_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/whosonline.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/whosonline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/trunk/modules/forums/posting.php
===================================================================
--- cms/trunk/modules/forums/posting.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/forums/posting.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -61,7 +61,7 @@
 // Was cancel pressed? If so then redirect to the appropriate page
 if ($_CLASS['core_user']-&gt;is_bot || isset($_POST['cancel']))
 {
-	$redirect = ($post_id) ? &quot;forums&amp;file=viewtopic&amp;p=$post_id#$post_id&quot; : (($topic_id) ? 'Forums&amp;file=viewtopic&amp;t='.$topic_id : (($forum_id) ? 'Forums&amp;file=viewforum&amp;f='.$forum_id : 'Forums'));
+	$redirect = ($post_id) ? &quot;forums&amp;file=viewtopic&amp;p=$post_id#$post_id&quot; : (($topic_id) ? 'forums&amp;file=viewtopic&amp;t='.$topic_id : (($forum_id) ? 'forums&amp;file=viewforum&amp;f='.$forum_id : 'forums'));
 	redirect(generate_link($redirect,  array('full' =&gt; true)));
 }
 
@@ -121,65 +121,200 @@
 
 $result = $_CLASS['core_db']-&gt;query($sql);
 
-$posting_data = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+$post_data = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 $_CLASS['core_db']-&gt;free_result($result);
 
-if (!$posting_data)
+if (!$post_data)
 {
 	trigger_error('NO_POST');
 }
 
-require_once(SITE_FILE_ROOT.'includes/forums/message_parser.php');
-require_once(SITE_FILE_ROOT.'includes/forums/functions_admin.php');
-require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
+require_once SITE_FILE_ROOT.'includes/forums/message_parser.php';
+require_once SITE_FILE_ROOT.'includes/forums/functions_admin.php';
+require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
 
-// remove
-extract($posting_data);
+// Use post_row values in favor of submitted ones...
+$forum_id	= (!empty($post_data['forum_id'])) ? (int) $post_data['forum_id'] : (int) $forum_id;
+$topic_id	= (!empty($post_data['topic_id'])) ? (int) $post_data['topic_id'] : (int) $topic_id;
+$post_id	= (!empty($post_data['post_id'])) ? (int) $post_data['post_id'] : (int) $post_id;
 
-if ($posting_data['forum_type'] == FORUM_POST &amp;&amp; !$_CLASS['auth']-&gt;acl_get('f_' . $mode, $forum_id) &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_'. $mode, $forum_id))
+$post_data['post_edit_locked'] = isset($post_data['post_edit_locked']) ? (int) $post_data['post_edit_locked'] : false;
+
+$_CLASS['core_user']-&gt;add_lang(array('posting', 'mcp', 'viewtopic'));
+$_CLASS['core_user']-&gt;add_img();
+
+// Is the user able to read within this forum?
+if (!$_CLASS['forums_auth']-&gt;acl_get('f_read', $forum_id))
+{
+	if ($_CLASS['core_user']-&gt;is_user)
+	{
+		trigger_error('USER_CANNOT_READ');
+	}
+
+	login_box('', $_CLASS['core_user']-&gt;get_lang('LOGIN_EXPLAIN_POST'));
+}
+
+if ($post_data['forum_password'])
 {
-	if ($_CLASS['core_user']-&gt;is_user)
+	login_forum_box(array(
+		'forum_id'		=&gt; $forum_id, 
+		'forum_password'=&gt; $post_data['forum_password']
+	));
+}
+
+
+// Permission to do the action asked?
+$is_authed = false;
+
+switch ($mode)
+{
+	case 'post':
+		if ($_CLASS['forums_auth']-&gt;acl_get('f_post', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+
+	case 'bump':
+		if ($_CLASS['forums_auth']-&gt;acl_get('f_bump', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+
+	case 'quote':
+	case 'reply':
+		if ($_CLASS['forums_auth']-&gt;acl_get('f_reply', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+
+	case 'edit':
+		if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['forums_auth']-&gt;acl_gets('f_edit', 'm_edit', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+
+	case 'delete':
+		if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['forums_auth']-&gt;acl_gets('f_delete', 'm_delete', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+}
+
+if (!$is_authed)
+{
+	if ($_CLASS['core_user']-&gt;is_user)
+	{
+		trigger_error('USER_CANNOT_' . strtoupper(($mode == 'quote') ? 'reply' : $mode));
+	}
+
+	login_box('', $_CLASS['core_user']-&gt;get_lang('LOGIN_EXPLAIN_' . strtoupper($mode)));
+}
+unset($is_authed);
+
+// Is the user able to post within this forum?
+if ($post_data['forum_type'] != FORUM_POST &amp;&amp; in_array($mode, array('post', 'bump', 'quote', 'reply')))
+{
+	trigger_error('USER_CANNOT_FORUM_POST');
+}
+
+// Forum/Topic locked?
+if (($post_data['forum_status'] == ITEM_LOCKED || (isset($post_data['topic_status']) &amp;&amp; $post_data['topic_status'] == ITEM_LOCKED)) &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id))
+{
+	trigger_error(($post_data['forum_status'] == ITEM_LOCKED) ? 'FORUM_LOCKED' : 'TOPIC_LOCKED');
+}
+
+// Can we edit this post ... if we're a moderator with rights then always yes
+// else it depends on editing times, lock status and if we're the correct user
+if ($mode == 'edit' &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id))
+{
+	if ($post_data['post_edit_locked'])
 	{
-		trigger_error('USER_CANNOT_' . strtoupper($mode));
+		trigger_error('CANNOT_EDIT_POST_LOCKED');
 	}
-	
-	login_box(array('explain' =&gt; $_CLASS['core_user']-&gt;lang['LOGIN_EXPLAIN_' . strtoupper($mode)]));
-}
 
-$forum_id	= (int) $posting_data['forum_id'];
-$topic_id	= (int) $topic_id;
-$post_id	= (int) $post_id;
+	if ($_CLASS['core_user']-&gt;data['user_id'] != $post_data['poster_id'])
+	{
+		trigger_error('USER_CANNOT_EDIT');
+	}
 
-$posting_data['post_edit_locked'] = isset($posting_data['post_edit_locked']) ? (int) $posting_data['post_edit_locked'] : false;
+	if ($config['edit_time'] &amp;&amp; $post_data['post_time'] &gt; ($current_time - $config['edit_time']))
+	{
+		trigger_error('CANNOT_EDIT_TIME');
+	}
+}
 
-$_CLASS['core_user']-&gt;add_lang(array('posting', 'mcp', 'viewtopic'));
-$_CLASS['core_user']-&gt;add_img();
+// Handle delete mode...
+if ($mode == 'delete')
+{
+	handle_post_delete($forum_id, $topic_id, $post_id, $post_data);
+	exit;
+}
 
-if ($forum_password)
+// Bump Topic
+if ($mode == 'bump')
 {
-	$forum_info = array(
-		'forum_id'		=&gt; $forum_id, 
-		'forum_password'=&gt; $forum_password
-	);
+	if ($bump_time = bump_topic_allowed($forum_id, $post_data['topic_bumped'], $post_data['topic_last_post_time'], $post_data['topic_poster'], $post_data['topic_last_poster_id']))
+	{
+		$_CLASS['core_db']-&gt;transaction();
 	
-	login_forum_box($forum_info);
-	unset($forum_info);
-}
+		$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . &quot;
+			SET post_time = $current_time
+			WHERE post_id = {$post_data['topic_last_post_id']}
+				AND topic_id = $topic_id&quot;);
+	
+		$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . &quot;
+			SET topic_last_post_time = $current_time,
+				topic_bumped = 1,
+				topic_bumper = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
+			WHERE topic_id = $topic_id&quot;);
+	
+		$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_FORUMS_TABLE . '
+			SET ' . implode(', ', update_last_post_information('forum', $forum_id)) . &quot;
+			WHERE forum_id = $forum_id&quot;);
+	
+		$_CLASS['core_db']-&gt;query('UPDATE ' . CORE_USERS_TABLE . &quot;
+			SET user_last_post_time = $current_time
+			WHERE user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id']);
+	
+		$_CLASS['core_db']-&gt;transaction('commit');
+	
+		//markread('topic', $forum_id, $topic_id, $current_time);
+	
+		add_log('mod', $forum_id, $topic_id, 'LOG_BUMP_TOPIC', $post_data['topic_title']);
+	
+		$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$topic_last_post_id#$topic_last_post_id&quot;));
+	
+		$message = $_CLASS['core_user']-&gt;lang['TOPIC_BUMPED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['VIEW_MESSAGE'], '&lt;a href=&quot;'.generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$topic_last_post_id#$topic_last_post_id&quot;).'&quot;&gt;', '&lt;/a&gt;') . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;'.generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id). '&quot;&gt;', '&lt;/a&gt;');
+		$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;' . generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id) . '&quot;&gt;', '&lt;/a&gt;');
 
-$post_subject = in_array($mode, array('quote', 'edit', 'delete')) ? $posting_data['post_subject'] : (isset($posting_data['topic_title']) ? $posting_data['topic_title'] : '');
-$topic_time_limit = (isset($posting_data['topic_time_limit']) &amp;&amp; $posting_data['topic_time_limit']) ? (int) $posting_data['topic_time_limit'] / 86400 : 0;
+		trigger_error($message);
+	}
 
-$poll_length = (isset($poll_length)) ? (($poll_length) ? (int) $poll_length / 86400 : (int) $poll_length) : 0;
-$poll_start = (isset($poll_start)) ? (int) $poll_start : 0;
-$poll_options = array();
+	trigger_error('BUMP_ERROR');
+}
 
+// Determine some vars
+$post_data['quote_username']	= (!empty($post_data['username'])) ? $post_data['username'] : ((!empty($post_data['post_username'])) ? $post_data['post_username'] : '');
+$post_data['post_edit_locked']	= (isset($post_data['post_edit_locked'])) ? (int) $post_data['post_edit_locked'] : 0;
+$post_data['post_subject']		= (in_array($mode, array('quote', 'edit'))) ? $post_data['post_subject'] : ((isset($post_data['topic_title'])) ? $post_data['topic_title'] : '');
+$post_data['topic_time_limit']	= (isset($post_data['topic_time_limit'])) ? (($post_data['topic_time_limit']) ? (int) $post_data['topic_time_limit'] / 86400 : (int) $post_data['topic_time_limit']) : 0;
+$post_data['poll_length']		= (!empty($post_data['poll_length'])) ? (int) $post_data['poll_length'] / 86400 : 0;
+$post_data['poll_start']		= (!empty($post_data['poll_start'])) ? (int) $post_data['poll_start'] : 0;
+$post_data['icon_id']			= (!isset($post_data['icon_id']) || in_array($mode, array('quote', 'reply'))) ? 0 : (int) $post_data['icon_id'];
+$post_data['poll_options']		= array();
+
 if (!isset($icon_id) || in_array($mode, array('quote', 'reply')))
 {
 	$icon_id = 0;
 }
 
 // Get Poll Data
-if ($poll_start)
+if ($post_data['poll_start'])
 {
 	$sql = 'SELECT poll_option_text 
 		FROM ' . FORUMS_POLL_OPTIONS_TABLE . &quot;
@@ -189,38 +324,39 @@
 
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$poll_options[] = trim($row['poll_option_text']);
+		$post_data['poll_options'][] = trim($row['poll_option_text']);
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 }
 
-$orig_poll_options_size = count($poll_options);
+$orig_poll_options_size = count($post_data['poll_options']);
+
 $message_parser = new parse_message();
 
-if (isset($post_text))
+if (isset($post_data['post_text']))
 {
-	$message_parser-&gt;message = $post_text;
-	unset($post_text);
+	$message_parser-&gt;message = $post_data['post_text'];
+	unset($post_data['post_text']);
 }
 
-$message_parser-&gt;get_submitted_attachment_data();
 
 // Set uninitialized variables
-$uninit = array('post_attachment' =&gt; 0, 'poster_id' =&gt; 0, 'enable_magic_url' =&gt; 0, 'topic_status' =&gt; ITEM_UNLOCKED, 'topic_type' =&gt; POST_NORMAL, 'subject' =&gt; '', 'topic_title' =&gt; '', 'post_time' =&gt; 0, 'post_edit_reason' =&gt; '');
+$uninit = array('post_attachment' =&gt; 0, 'poster_id' =&gt; $_CLASS['core_user']-&gt;data['user_id'], 'enable_magic_url' =&gt; 0, 'topic_status' =&gt; 0, 'topic_type' =&gt; POST_NORMAL, 'post_subject' =&gt; '', 'topic_title' =&gt; '', 'post_time' =&gt; 0, 'post_edit_reason' =&gt; '', 'notify_set' =&gt; 0);
 
 foreach ($uninit as $var_name =&gt; $default_value)
 {
-	if (!isset($posting_data[$var_name]))
-	{
-		$posting_data[$var_name] = $default_value;
+	if (!isset($post_data[$var_name]))
+	{
+		$post_data[$var_name] = $default_value;
 	}
 }
+unset($uninit);
 
-unset($uninit, $var_name, $default_value);
+$message_parser-&gt;get_submitted_attachment_data($post_data['poster_id']);
 
-if ($posting_data['post_attachment'] &amp;&amp; !$submit &amp;&amp; !$refresh &amp;&amp; !$preview &amp;&amp; $mode == 'edit')
+if ($post_data['post_attachment'] &amp;&amp; !$submit &amp;&amp; !$refresh &amp;&amp; !$preview &amp;&amp; $mode == 'edit')
 {
-	$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
+	$sql = 'SELECT attach_id, physical_filename, attach_comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
 		FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot;
 		WHERE post_msg_id = $post_id
 			AND in_message = 0
@@ -235,34 +371,34 @@
 	$_CLASS['core_db']-&gt;free_result($result);
 }
 
-if (!$posting_data['poster_id'] || $posting_data['poster_id'] == ANONYMOUS)
+if (!$post_data['poster_id'] || $post_data['poster_id'] == ANONYMOUS)
 {
-	$posting_data['username'] = in_array($mode, array('quote', 'edit', 'delete')) ? trim($posting_data['post_username']) : get_variable('username', 'POST', '');
+	$post_data['username'] = in_array($mode, array('quote', 'edit')) ? trim($post_data['post_username']) : get_variable('username', 'POST', '');
 }
 else
 {
-	$posting_data['username'] = in_array($mode, array('quote', 'edit', 'delete')) ? trim($posting_data['username']) : '';
+	$post_data['username'] = in_array($mode, array('quote', 'edit')) ? trim($post_data['username']) : '';
 }
 
-$enable_urls = $posting_data['enable_magic_url'];
-$enable_html = isset($enable_html) ? $enable_html : $config['allow_html'];
+$post_data['enable_urls'] = $post_data['enable_magic_url'];
+$post_data['enable_html'] = isset($enable_html) ? $enable_html : $config['allow_html'];
 
-if (!in_array($mode, array('quote', 'edit', 'delete')))
+if (!in_array($mode, array('quote', 'edit')))
 {
-	$enable_sig		= ($config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('attachsig'));
-	$enable_smilies = ($config['allow_smilies'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('smilies'));
-	$enable_bbcode	= ($config['allow_bbcode'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('bbcode'));
-	$enable_urls	= true;
+	$post_data['enable_sig']		= ($config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('attachsig'));
+	$post_data['enable_smilies']	= ($config['allow_smilies'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('smilies'));
+	$post_data['enable_bbcode']		= ($config['allow_bbcode'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('bbcode'));
+	$post_data['enable_urls']		= true;
 }
 
-$posting_data['enable_magic_url'] = $drafts = false;
+$post_data['enable_magic_url'] = $post_data['drafts'] = false;
 
 // User own some drafts?
-if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $mode != 'delete')
+if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_savedrafts'))
 {
 	$sql = 'SELECT draft_id
 		FROM ' . FORUMS_DRAFTS_TABLE . '
-		WHERE (forum_id = ' . $forum_id . (($topic_id) ? &quot; OR topic_id = $topic_id&quot; : '') . ')
+		WHERE (forum_id IN (' . $forum_id . ', 0)'. (($topic_id) ? &quot; OR topic_id = $topic_id&quot; : '') . ')
 			AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . 
 			(($draft_id) ? &quot; AND draft_id &lt;&gt; $draft_id&quot; : '');
 	$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
@@ -274,12 +410,10 @@
 	$_CLASS['core_db']-&gt;free_result($result);
 }
 
-$check_value = (($enable_html+1) &lt;&lt; 16) + (($enable_bbcode+1) &lt;&lt; 8) + (($enable_smilies+1) &lt;&lt; 4) + (($enable_urls+1) &lt;&lt; 2) + (($enable_sig+1) &lt;&lt; 1);
+$check_value = (($post_data['enable_bbcode']+1) &lt;&lt; 8) + (($post_data['enable_smilies']+1) &lt;&lt; 4) + (($post_data['enable_urls']+1) &lt;&lt; 2) + (($post_data['enable_sig']+1) &lt;&lt; 1);
 
 // Notify user checkbox
-$notify_set = false;
-
-if ($mode != 'post' &amp;&amp; $_CLASS['core_user']-&gt;is_user)
+if ($mode != 'post' &amp;&amp; $config['allow_topic_notify'] &amp;&amp; $_CLASS['core_user']-&gt;is_user)
 {
 	$sql = 'SELECT forum_id, topic_id
 		FROM ' . FORUMS_WATCH_TABLE . &quot;
@@ -290,52 +424,22 @@
 
 	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$notify_set = ($row['topic_id']) ? 1 : 2;
+		$post_data['notify_set'] = ($row['topic_id']) ? 1 : 2;
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 }
 
-// Forum/Topic locked?
-// what about if we want to delete/etc ?
-if (($posting_data['forum_status'] == ITEM_LOCKED || $posting_data['topic_status'] == ITEM_LOCKED) &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_edit', $forum_id))
-{
-	$message = ($posting_data['forum_status'] == ITEM_LOCKED) ? 'FORUM_LOCKED' : 'TOPIC_LOCKED';
-	trigger_error($message);
-}
-
-// Can we edit this post ... if we're a moderator with rights then always yes
-// else it depends on editing times, lock status and if we're the correct user
-// !$preview &amp;&amp; !$refresh &amp;&amp; !$submit &amp;&amp;
-if ($mode == 'edit' &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; !$submit &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_edit', $forum_id))
-{
-	if ($posting_data['post_edit_locked'])
-	{
-		trigger_error('CANNOT_EDIT_POST_LOCKED');
-	}
-
-	if ($_CLASS['core_user']-&gt;data['user_id'] != $posting_data['poster_id'])
-	{
-		trigger_error('USER_CANNOT_EDIT');
-	}
-
-	if ($config['edit_time'] &amp;&amp; $posting_data['post_time'] &gt; ($current_time - $config['edit_time']))
-	{
-		trigger_error('CANNOT_EDIT_TIME');
-	}
-}
-
 // Do we want to edit our post ?
-
-if ($mode == 'edit')
+if ($mode == 'edit' &amp;&amp; $post_data['bbcode_uid'])
 {
-	$message_parser-&gt;bbcode_uid = $bbcode_uid;
+	$message_parser-&gt;bbcode_uid = $post_data['bbcode_uid'];
 }
-
+/*
 // should we alow ip no user deletion ?
 // Delete triggered ?
 if ($mode == 'delete')
 {
-	if ($_CLASS['auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $post_id == $topic_last_post_id &amp;&amp; ((!$_CLASS['core_user']-&gt;is_user &amp;&amp; $posting_data['poster_id'] == ANONYMOUS &amp;&amp; $poster_ip &amp;&amp; $poster_ip == $_CLASS['core_user']-&gt;ip) || ($_CLASS['core_user']-&gt;is_user &amp;&amp; $posting_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'])))
+	if ($_CLASS['forums_auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $post_id == $topic_last_post_id &amp;&amp; ((!$_CLASS['core_user']-&gt;is_user &amp;&amp; $post_data['poster_id'] == ANONYMOUS &amp;&amp; $poster_ip &amp;&amp; $poster_ip == $_CLASS['core_user']-&gt;ip) || ($_CLASS['core_user']-&gt;is_user &amp;&amp; $post_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'])))
 	{
 		$user_deletable = true;
 	}
@@ -345,7 +449,7 @@
 	}
 }
 
-if ($mode == 'delete' &amp;&amp; ($user_deletable || $_CLASS['auth']-&gt;acl_get('m_delete', $forum_id)))
+if ($mode == 'delete' &amp;&amp; ($user_deletable || $_CLASS['forums_auth']-&gt;acl_get('m_delete', $forum_id)))
 {
 	$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;p&quot; value=&quot;' . $post_id . '&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;f&quot; value=&quot;' . $forum_id . '&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;mode&quot; value=&quot;delete&quot; /&gt;';
 
@@ -355,10 +459,10 @@
 			'topic_first_post_id'=&gt; $topic_first_post_id,
 			'topic_last_post_id'=&gt; $topic_last_post_id,
 			'topic_approved'	=&gt; $topic_approved,
-			'topic_type'		=&gt; $posting_data['topic_type'],
+			'topic_type'		=&gt; $post_data['topic_type'],
 			'post_approved' 	=&gt; $post_approved,
-			'post_time'			=&gt; $posting_data['post_time'],
-			'poster_id'			=&gt; $posting_data['poster_id']
+			'post_time'			=&gt; $post_data['post_time'],
+			'poster_id'			=&gt; $post_data['poster_id']
 		);
 		
 		$next_post_id = delete_post($mode, $post_id, $topic_id, $forum_id, $data);
@@ -367,10 +471,10 @@
 		{
 			if (!$user_deletable)
 			{
-				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_TOPIC', $posting_data['topic_title']);
+				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_TOPIC', $post_data['topic_title']);
 			}
 
-			$meta_info = generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id);
+			$meta_info = generate_link('forums&amp;file=viewforum&amp;f='.$forum_id);
 			$message = $_CLASS['core_user']-&gt;lang['POST_DELETED'];
 		}
 		else
@@ -380,23 +484,23 @@
 				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_POST', $post_subject);
 			}
 
-			$meta_info = generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$next_post_id#$next_post_id&quot;);
-			$message = $_CLASS['core_user']-&gt;lang['POST_DELETED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$next_post_id#$next_post_id&quot;).'&quot;&gt;', '&lt;/a&gt;');
+			$meta_info = generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$next_post_id#$next_post_id&quot;);
+			$message = $_CLASS['core_user']-&gt;lang['POST_DELETED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;'.generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$next_post_id#$next_post_id&quot;).'&quot;&gt;', '&lt;/a&gt;');
 		}
 
 		$_CLASS['core_display']-&gt;meta_refresh(3, $meta_info);
-		$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;'.generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id).'&quot;&gt;', '&lt;/a&gt;');
+		$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;'.generate_link('forums&amp;file=viewforum&amp;f='.$forum_id).'&quot;&gt;', '&lt;/a&gt;');
 
 		trigger_error($message);
 	}
 }
 
-if ($mode == 'delete' &amp;&amp; $posting_data['poster_id'] != $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; !$_CLASS['auth']-&gt;acl_get('f_delete', $forum_id))
+if ($mode == 'delete' &amp;&amp; $post_data['poster_id'] != $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('f_delete', $forum_id))
 {
 	trigger_error('DELETE_OWN_POSTS');
 }
 
-if ($mode == 'delete' &amp;&amp; $posting_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $post_id != $topic_last_post_id)
+if ($mode == 'delete' &amp;&amp; $post_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $post_id != $topic_last_post_id)
 {
 	trigger_error('CANNOT_DELETE_REPLIED');
 }
@@ -405,53 +509,21 @@
 {
 	trigger_error('USER_CANNOT_DELETE');
 }
+*/
 
-// Bump Topic
-if ($mode == 'bump' &amp;&amp; ($bump_time = bump_topic_allowed($forum_id, $topic_bumped, $topic_last_post_time, $topic_poster, $topic_last_poster_id)))
-{
-	$_CLASS['core_db']-&gt;transaction();
+// HTML, BBCode, Smilies, Images and Flash status
+$html_status	= ($config['allow_html'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_html', $forum_id));
+$bbcode_status	= ($config['allow_bbcode'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_bbcode', $forum_id));
+$smilies_status	= ($config['allow_smilies'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_smilies', $forum_id));
+$img_status		= ($_CLASS['forums_auth']-&gt;acl_get('f_img', $forum_id));
+$flash_status	= ($_CLASS['forums_auth']-&gt;acl_get('f_flash', $forum_id));
+$quote_status	= ($_CLASS['forums_auth']-&gt;acl_get('f_reply', $forum_id));
 
-	$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . &quot;
-		SET post_time = $current_time
-		WHERE post_id = $topic_last_post_id
-			AND topic_id = $topic_id&quot;);
-
-	$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . &quot;
-		SET topic_last_post_time = $current_time,
-			topic_bumped = 1,
-			topic_bumper = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
-		WHERE topic_id = $topic_id&quot;);
-
-	$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_FORUMS_TABLE . '
-		SET ' . implode(', ', update_last_post_information('forum', $forum_id)) . &quot;
-		WHERE forum_id = $forum_id&quot;);
-
-	$_CLASS['core_db']-&gt;query('UPDATE ' . CORE_USERS_TABLE . &quot;
-		SET user_last_post_time = $current_time
-		WHERE user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id']);
-
-	$_CLASS['core_db']-&gt;transaction('commit');
-
-	//markread('topic', $forum_id, $topic_id, $current_time);
-
-	add_log('mod', $forum_id, $topic_id, sprintf($_CLASS['core_user']-&gt;lang['LOGM_BUMP'], $posting_data['topic_title']));
-
-	$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$topic_last_post_id#$topic_last_post_id&quot;));
-
-	$message = $_CLASS['core_user']-&gt;lang['TOPIC_BUMPED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['VIEW_MESSAGE'], '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$topic_last_post_id#$topic_last_post_id&quot;).'&quot;&gt;', '&lt;/a&gt;') . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id). '&quot;&gt;', '&lt;/a&gt;');
-
-	trigger_error($message);
-}
-elseif ($mode == 'bump')
-{
-	trigger_error('BUMP_ERROR');
-}
-
 // Save Draft
-if ($save &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['auth']-&gt;acl_get('u_savedrafts'))
+if ($save &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_savedrafts'))
 {
 	$subject = request_var('subject', '', true);
-	$subject = (!$subject &amp;&amp; $mode != 'post') ? $posting_data['topic_title'] : $subject;
+	$subject = (!$subject &amp;&amp; $mode != 'post') ? $post_data['topic_title'] : $subject;
 	$message = request_var('message', '', true);
 
 	if ($subject &amp;&amp; $message)
@@ -462,52 +534,66 @@
 			'forum_id'	=&gt; $forum_id,
 			'save_time'	=&gt; $current_time,
 			'draft_subject' =&gt; $subject,
-			'draft_message' =&gt; $message));
+			'draft_message' =&gt; $message
+		));
 		$_CLASS['core_db']-&gt;query($sql);
 	
-		$meta_info = ($mode == 'post') ? generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id) : generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;);
+		$meta_info = ($mode == 'post') ? generate_link('forums&amp;file=viewforum&amp;f='.$forum_id) : generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;);
 
 		$_CLASS['core_display']-&gt;meta_refresh(3, $meta_info);
 
 		$message = $_CLASS['core_user']-&gt;lang['DRAFT_SAVED'] . '&lt;br /&gt;&lt;br /&gt;';
 		$message .= ($mode != 'post') ? sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;' . $meta_info . '&quot;&gt;', '&lt;/a&gt;') . '&lt;br /&gt;&lt;br /&gt;' : '';
-		$message .= sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '&quot;&gt;', '&lt;/a&gt;');
+		$message .= sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;'.generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id) . '&quot;&gt;', '&lt;/a&gt;');
 
 		trigger_error($message);
 	}
+	/*		$s_hidden_fields = build_hidden_fields(array(
+				'mode'		=&gt; $mode,
+				'save'		=&gt; true,
+				'f'			=&gt; $forum_id,
+				't'			=&gt; $topic_id,
+				'subject'	=&gt; $subject,
+				'message'	=&gt; $message,
+				)
+			);
+
+			confirm_box(false, 'SAVE_DRAFT', $s_hidden_fields);
+		*/
+	unset($subject, $message);
 
-	unset($subject);
-	unset($message);
 }
 
 // Move to where they should be
 $_CLASS['core_template']-&gt;assign_array(array(
-		'S_DRAFT_LOADED'	=&gt; false,
-		'S_SHOW_DRAFTS'		=&gt; false,
-		'S_POST_REVIEW'		=&gt; false,
-		'S_DISPLAY_PREVIEW'	=&gt; false,
-		'S_UNGLOBALISE'		=&gt; false,
-		'S_INLINE_ATTACHMENT_OPTIONS' =&gt; false,
-		'S_TOPIC_TYPE_ANNOUNCE' =&gt; false,
-		'S_TOPIC_TYPE_STICKY' =&gt; false,
-		'S_DISPLAY_REVIEW'	=&gt; false,
+		'S_DRAFT_LOADED'				=&gt; false,
+		'S_SHOW_DRAFTS'					=&gt; false,
+		'S_POST_REVIEW'					=&gt; false,
+		'S_DISPLAY_PREVIEW'				=&gt; false,
+		'S_UNGLOBALISE'					=&gt; false,
+		'S_INLINE_ATTACHMENT_OPTIONS' 	=&gt; false,
+		'S_TOPIC_TYPE_ANNOUNCE' 		=&gt; false,
+		'S_TOPIC_TYPE_STICKY'			 =&gt; false,
+		'S_DISPLAY_REVIEW'				=&gt; false,
 ));
 
 // Load Draft
-if ($draft_id &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['auth']-&gt;acl_get('u_savedrafts'))
+if ($draft_id &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_savedrafts'))
 {
 	$sql = 'SELECT draft_subject, draft_message 
 		FROM ' . FORUMS_DRAFTS_TABLE . &quot; 
 		WHERE draft_id = $draft_id
 			AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
 	$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-	
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	if ($row)
 	{
-		$_REQUEST['subject'] = $row['draft_subject'];
-		$_REQUEST['message'] = $row['draft_message'];
+		$post_data['post_subject'] = $row['draft_subject'];
+		$message_parser-&gt;message = $row['draft_message'];
 
-		$refresh = true;
+		//$refresh = true;
 		$_CLASS['core_template']-&gt;assign('S_DRAFT_LOADED', true);
 	}
 	else
@@ -516,50 +602,56 @@
 	}
 }
 
-// HTML, BBCode, Smilies, Images and Flash status
-$html_status	= ($config['allow_html'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_html', $forum_id));
-$bbcode_status	= ($config['allow_bbcode'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_bbcode', $forum_id));
-$smilies_status	= ($config['allow_smilies'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_smilies', $forum_id));
-$img_status		= ($_CLASS['auth']-&gt;acl_get('f_img', $forum_id));
-$flash_status	= ($_CLASS['auth']-&gt;acl_get('f_flash', $forum_id));
-$quote_status	= ($_CLASS['auth']-&gt;acl_get('f_quote', $forum_id));
-
 // Load Drafts
-if ($load &amp;&amp; $drafts)
+if ($load &amp;&amp; $post_data['drafts'])
 {
 	load_drafts($topic_id, $forum_id);
 }
 
 if ($submit || $preview || $refresh)
 {
-	$posting_data['post_edit_reason'] = ($mode == 'edit' &amp;&amp; isset($_POST['edit_reason']) &amp;&amp; !empty($_POST['edit_reason']) &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] != $posting_data['poster_id']) ? get_variable('edit_reason', 'POST', '') : '';
-	$posting_data['topic_type'] = isset($_POST['topic_type']) ? (int) $_POST['topic_type'] : (($mode != 'post') ? $posting_data['topic_type'] : POST_NORMAL);
+	$post_data['topic_cur_post_id'] = request_var('topic_cur_post_id', 0);
+	$post_data['post_subject'] = request_var('subject', '', true);
 
-	$topic_cur_post_id	= get_variable('topic_cur_post_id', 'POST', 0, 'int');
+	// If subject is all-uppercase then we make all lowercase (we do not want to be yelled at too :P)
+	// Admins/Mods might want to create all-uppercase topics, therefore we do not apply this check to them (they should know better ;))
+	if ($post_data['post_subject'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_gets('a_', 'm_', $forum_id))// &amp;&amp; strcmp($post_data['post_subject'], strtoupper($post_data['post_subject'])) == 0)
+	{
+		//$subject = mb_strtolower(htmlentities(get_variable('subject', 'POST', ''), ENT_QUOTES, 'UTF-8'));
+		$post_data['post_subject'] = mb_strtolower(htmlentities($post_data['post_subject'], ENT_QUOTES, 'UTF-8'));
+	}	
 
-	$subject = mb_strtolower(htmlentities(get_variable('subject', 'POST', ''), ENT_QUOTES, 'UTF-8'));
 	$message_parser-&gt;message = request_var('message', '', true);
+
+	$post_data['username']			= request_var('username', $post_data['username']);
+	$post_data['post_edit_reason']	= (!empty($_POST['edit_reason']) &amp;&amp; $mode == 'edit' &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id)) ? request_var('edit_reason', '', true) : '';
+
+	$post_data['topic_type']		= get_variable('topic_type', 'POST', (($mode != 'post') ? (int) $post_data['topic_type'] : POST_NORMAL), 'int');
+	$post_data['topic_time_limit']	= get_variable('topic_time_limit', 'POST', (($mode != 'post') ? (int) $post_data['topic_time_limit'] : 0), 'int');
+	$post_data['icon_id']			= get_variable('icon', 'POST', 0, 'int');
+
+	$post_data['enable_bbcode']		= (!$bbcode_status || isset($_POST['disable_bbcode'])) ? false : true;
+	$post_data['enable_smilies']	= (!$smilies_status || isset($_POST['disable_smilies'])) ? false : true;
+	$post_data['enable_urls']		= !isset($_POST['disable_magic_url']);
+	$post_data['enable_sig']		= (!$config['allow_sig']) ? false : ((isset($_POST['attach_sig']) &amp;&amp; $_CLASS['core_user']-&gt;is_user) ? true : false);
 
+	if ($config['allow_topic_notify'] &amp;&amp; $_CLASS['core_user']-&gt;is_user)
+	{
+		$notify = isset($_POST['notify']);
+	}
+	else
+	{
+		$notify = false;
+	}
 
-	$topic_time_limit	= (isset($_POST['topic_time_limit'])) ? (int) $_POST['topic_time_limit'] : (($mode != 'post') ? $topic_time_limit : 0);
-	$icon_id			= get_variable('icon', 'POST', 0, 'int');
-
-	$enable_html 		= (!$html_status || isset($_POST['disable_html'])) ? false : true;
-	$enable_bbcode 		= (!$bbcode_status || isset($_POST['disable_bbcode'])) ? false : true;
-	$enable_smilies		= (!$smilies_status || isset($_POST['disable_smilies'])) ? false : true;
-	$enable_urls 		= isset($_POST['disable_magic_url']) ? 0 : 1;
-	$enable_sig			= (!$config['allow_sig']) ? false : (($_CLASS['core_user']-&gt;is_user &amp;&amp; isset($_POST['attach_sig'])) ? true : false);
-
-	$notify				= isset($_POST['notify']);
 	$topic_lock			= isset($_POST['lock_topic']);
 	$post_lock			= isset($_POST['lock_post']);
-
 	$poll_delete		= isset($_POST['poll_delete']);
 	
 	// Faster than crc32
 	if ($submit)
 	{
-		$status_switch  = (($enable_html+1) &lt;&lt; 16) + (($enable_bbcode+1) &lt;&lt; 8) + (($enable_smilies+1) &lt;&lt; 4) + (($enable_urls+1) &lt;&lt; 2) + (($enable_sig+1) &lt;&lt; 1);
+		$status_switch = (($post_data['enable_bbcode']+1) &lt;&lt; 8) + (($post_data['enable_smilies']+1) &lt;&lt; 4) + (($post_data['enable_urls']+1) &lt;&lt; 2) + (($post_data['enable_sig']+1) &lt;&lt; 1);
 		$status_switch = ($status_switch != $check_value);
 	}
 	else
@@ -568,17 +660,17 @@
 	}
 
 	// Delete Poll
-	if ($poll_delete &amp;&amp; $mode == 'edit' &amp;&amp; $poll_options &amp;&amp; 
-		((!$poll_last_vote &amp;&amp; $posting_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_delete', $forum_id)) || $_CLASS['auth']-&gt;acl_get('m_delete', $forum_id)))
+	if ($poll_delete &amp;&amp; $mode == 'edit' &amp;&amp; count($post_data['poll_options']) &amp;&amp; 
+		((!$post_data['poll_last_vote'] &amp;&amp; $post_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_delete', $forum_id)) || $_CLASS['forums_auth']-&gt;acl_get('m_delete', $forum_id)))
 	{
-		switch (SQL_LAYER)
+		switch ($_CLASS['core_db']-&gt;db_layer)
 		{
 			case 'mysql4':
 			case 'mysqli':
 				$sql = 'DELETE FROM ' . POLL_OPTIONS_TABLE . ', ' . POLL_VOTES_TABLE . &quot;
 					WHERE topic_id = $topic_id&quot;;
 				$_CLASS['core_db']-&gt;query($sql);
-				break;
+			break;
 
 			default:
 				$sql = 'DELETE FROM ' . POLL_OPTIONS_TABLE . &quot;
@@ -588,8 +680,9 @@
 				$sql = 'DELETE FROM ' . POLL_VOTES_TABLE . &quot;
 					WHERE topic_id = $topic_id&quot;;
 				$_CLASS['core_db']-&gt;query($sql);
+			break;
 		}
-		
+
 		$topic_sql = array(
 			'poll_title'		=&gt; '',
 			'poll_start' 		=&gt; 0,
@@ -604,22 +697,22 @@
 			WHERE topic_id = $topic_id&quot;;
 		$_CLASS['core_db']-&gt;query($sql);
 
-		$poll_title = $poll_option_text = '';
-		$poll_vote_change = $poll_max_options = $poll_length = 0;
+		$post_data['poll_title'] = $post_data['poll_option_text'] = '';
+		$post_data['poll_vote_change'] = $post_data['poll_max_options'] = $post_data['poll_length'] = 0;
 	}
 	else
 	{
-		$poll_title			= request_var('poll_title', '');
-		$poll_length		= request_var('poll_length', 0);
-		$poll_option_text	= request_var('poll_option_text', '');
-		$poll_max_options	= request_var('poll_max_options', 1);
-		$poll_vote_change	= ($_CLASS['auth']-&gt;acl_get('f_votechg', $forum_id) &amp;&amp; isset($_POST['poll_vote_change'])) ? 1 : 0;
+		$post_data['poll_title']		= request_var('poll_title', '', true);
+		$post_data['poll_length']		= request_var('poll_length', 0);
+		$post_data['poll_option_text']	= request_var('poll_option_text', '', true);
+		$post_data['poll_max_options']	= request_var('poll_max_options', 1);
+		$post_data['poll_vote_change']	= ($_CLASS['forums_auth']-&gt;acl_get('f_votechg', $forum_id) &amp;&amp; isset($_POST['poll_vote_change'])) ? 1 : 0;
 	}
 
 	// If replying/quoting and last post id has changed
 	// give user option to continue submit or return to post
 	// notify and show user the post made between his request and the final submit
-	if (($mode == 'reply' || $mode == 'quote') &amp;&amp; $topic_cur_post_id &amp;&amp; $topic_cur_post_id != $topic_last_post_id)
+	if (($mode == 'reply' || $mode == 'quote') &amp;&amp; $post_data['topic_cur_post_id'] &amp;&amp; $post_data['topic_cur_post_id'] != $post_data['topic_last_post_id'])
 	{
 		if (topic_review($topic_id, $forum_id, 'post_review', $topic_cur_post_id))
 		{
@@ -636,19 +729,19 @@
 	$message_md5 = md5($message_parser-&gt;message);
 
 	// Check checksum ... don't re-parse message if the same
-	$update_message = ($mode != 'edit' || $message_md5 != $post_checksum || $status_switch) ? true : false;
+	$update_message = ($mode != 'edit' || $message_md5 != $post_data['post_checksum'] || $status_switch) ? true : false;
 	
 	// Parse message
 	if ($update_message)
 	{
-		$message_parser-&gt;parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, $quote_status);
+		$message_parser-&gt;parse($post_data['enable_bbcode'], $post_data['enable_urls'], $post_data['enable_smilies'], $img_status, $flash_status, $quote_status);
 	}
 	else
 	{
-		$message_parser-&gt;bbcode_bitfield = $bbcode_bitfield;
+		$message_parser-&gt;bbcode_bitfield = $post_data['bbcode_bitfield'];
 	}
 
-	if ($mode != 'edit' &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; $config['flood_interval'] &amp;&amp; !$_CLASS['auth']-&gt;acl_get('f_ignoreflood', $forum_id))
+	if ($mode != 'edit' &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; $config['flood_interval'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('f_ignoreflood', $forum_id))
 	{
 		// Flood check
 		$last_post_time = 0;
@@ -664,7 +757,6 @@
 				WHERE poster_ip = '&quot; . $_CLASS['core_user']-&gt;ip . &quot;'
 					AND post_time &gt; &quot; . ($current_time - $config['flood_interval']);
 			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-
 			if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$last_post_time = $row['last_post_time'];
@@ -672,60 +764,80 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 		}
 
-		if ($last_post_time)
+		if ($last_post_time &amp;&amp; ($current_time - $last_post_time) &lt; intval($config['flood_interval']))
 		{
-			if ($last_post_time &amp;&amp; ($current_time - $last_post_time) &lt; intval($config['flood_interval']))
-			{
-				$error[] = $_CLASS['core_user']-&gt;get_lang('FLOOD_ERROR');
-			}
+			$error[] = $_CLASS['core_user']-&gt;get_lang('FLOOD_ERROR');
 		}
 	}
 
 	// Validate username
-	if ($posting_data['username'] &amp;&amp; (!$_CLASS['core_user']-&gt;is_user || ($mode == 'edit' &amp;&amp; (!$posting_data['poster_id'] || $posting_data['poster_id'] == ANONYMOUS))))
+	if (($post_data['username'] &amp;&amp; !$_CLASS['core_user']-&gt;is_user) || ($mode == 'edit' &amp;&amp; $post_data['post_username']))
 	{
-		require_once(SITE_FILE_ROOT.'includes/functions_user.php');
-		$result = validate_username($posting_data['username']);
+		require_once SITE_FILE_ROOT.'includes/functions_user.php';
+		$result = validate_username($post_data['username']);
 
 		if ($result !== true)
 		{
 			$error[] = $_CLASS['core_user']-&gt;get_lang($result);
 		}
 	}
+	
+/*
+ ADD
+	if ($config['enable_post_confirm'] &amp;&amp; !$_CLASS['core_user']-&gt;is_user &amp;&amp; in_array($mode, array('quote', 'post', 'reply')))
+	{
+		$confirm_id = request_var('confirm_id', '');
+		$confirm_code = request_var('confirm_code', '');
+
+		$sql = 'SELECT code
+			FROM ' . CONFIRM_TABLE . &quot;
+			WHERE confirm_id = '&quot; . $db-&gt;sql_escape($confirm_id) . &quot;'
+				AND session_id = '&quot; . $db-&gt;sql_escape($_CLASS['core_user']-&gt;session_id) . &quot;'
+				AND confirm_type = &quot; . CONFIRM_POST;
+		$result = $db-&gt;sql_query($sql);
+		$confirm_row = $db-&gt;sql_fetchrow($result);
+		$db-&gt;sql_freeresult($result);
+
+		if (empty($confirm_row['code']) || strcasecmp($confirm_row['code'], $confirm_code) !== 0)
+		{
+			$error[] = $_CLASS['core_user']-&gt;get_lang('CONFIRM_CODE_WRONG');
+		}
+	}
+*/
 
 	// Parse subject
-	if (!$subject &amp;&amp; ($mode == 'post' || ($mode == 'edit' &amp;&amp; $posting_data['topic_first_post_id'] == $posting_data['post_id'])))
+	if (!$post_data['post_subject'] &amp;&amp; ($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_data['topic_first_post_id'] == $post_id)))
 	{
 		$error[] = $_CLASS['core_user']-&gt;get_lang('EMPTY_SUBJECT');
 	}
 
-	$poll_last_vote = (isset($poll_last_vote)) ? $poll_last_vote : 0;
+	$post_data['poll_last_vote'] = (isset($post_data['poll_last_vote'])) ? $post_data['poll_last_vote'] : 0;
 
-	if ($poll_option_text &amp;&amp; 
-			($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_id == $topic_first_post_id &amp;&amp; (!$poll_last_vote || $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id))))
-			&amp;&amp; $_CLASS['auth']-&gt;acl_get('f_poll', $forum_id))
+	if ($post_data['poll_option_text'] &amp;&amp; 
+		($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_id == $post_data['topic_first_post_id'] &amp;&amp; (!$post_data['poll_last_vote'] || $_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id))))
+			&amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_poll', $forum_id))
 	{
-		$poll = array(
-			'poll_title'		=&gt; $poll_title,
-			'poll_length'		=&gt; $poll_length,
-			'poll_max_options'	=&gt; $poll_max_options,
-			'poll_option_text'	=&gt; $poll_option_text,
-			'poll_start'		=&gt; $poll_start,
-			'poll_last_vote'	=&gt; $poll_last_vote,
-			'poll_vote_change'	=&gt; $poll_vote_change,
-			'enable_html'		=&gt; $enable_html,
-			'enable_bbcode'		=&gt; $enable_bbcode,
-			'enable_urls'		=&gt; $enable_urls,
-			'enable_smilies'	=&gt; $enable_smilies,
-			'img_status'		=&gt; $img_status
+		$poll = array(
+			'poll_title'		=&gt; $post_data['poll_title'],
+			'poll_length'		=&gt; $post_data['poll_length'],
+			'poll_max_options'	=&gt; $post_data['poll_max_options'],
+			'poll_option_text'	=&gt; $post_data['poll_option_text'],
+			'poll_start'		=&gt; $post_data['poll_start'],
+			'poll_last_vote'	=&gt; $post_data['poll_last_vote'],
+			'poll_vote_change'	=&gt; $post_data['poll_vote_change'],
+			//'enable_html'		=&gt; $post_data['enable_html'],
+			'enable_bbcode'		=&gt; $post_data['enable_bbcode'],
+			'enable_urls'		=&gt; $post_data['enable_urls'],
+			'enable_smilies'	=&gt; $post_data['enable_smilies'],
+			'img_status'		=&gt; $img_status
 		);
 
 		$message_parser-&gt;parse_poll($poll);
-	
-		$poll_options = isset($poll['poll_options']) ? $poll['poll_options'] : '';
-		$poll_title = isset($poll['poll_title']) ? $poll['poll_title'] : '';
 
-		if ($poll_last_vote &amp;&amp; ($poll['poll_options_size'] &lt; $orig_poll_options_size))
+		$post_data['poll_options'] = (isset($poll['poll_options'])) ? $poll['poll_options'] : '';
+		$post_data['poll_title'] = (isset($poll['poll_title'])) ? $poll['poll_title'] : '';
+
+		if ($post_data['poll_last_vote'] &amp;&amp; ($poll['poll_options_size'] &lt; $orig_poll_options_size))
 		{
 			$message_parser-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['NO_DELETE_POLL_OPTIONS'];
 		}
@@ -736,9 +848,9 @@
 	}
 
 	// Check topic type
-	if ($posting_data['topic_type'] != POST_NORMAL &amp;&amp; ($mode == 'post' || ($mode == 'edit' &amp;&amp; $posting_data['topic_first_post_id'] == $posting_data['post_id'])))
+	if ($post_data['topic_type'] != POST_NORMAL &amp;&amp; ($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_data['topic_first_post_id'] == $post_id)))
 	{
-		switch ($posting_data['topic_type'])
+		switch ($post_data['topic_type'])
 		{
 			case POST_GLOBAL:
 			case POST_ANNOUNCE:
@@ -754,7 +866,7 @@
 			break;	
 		}
 
-		if (!$_CLASS['auth']-&gt;acl_get($auth_option, $forum_id))
+		if (!$_CLASS['forums_auth']-&gt;acl_get($auth_option, $forum_id))
 		{
 			$error[] = $_CLASS['core_user']-&gt;lang['CANNOT_POST_' . str_replace('F_', '', strtoupper($auth_option))];
 		}
@@ -769,21 +881,24 @@
 	if (empty($error) &amp;&amp; $submit)
 	{
 		// Check if we want to de-globalize the topic... and ask for new forum
-		if ($posting_data['topic_type'] != POST_GLOBAL)
+		if ($post_data['topic_type'] != POST_GLOBAL)
 		{
 			$sql = 'SELECT topic_type, forum_id
 				FROM ' . FORUMS_TOPICS_TABLE . &quot;
 				WHERE topic_id = $topic_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
 
+			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
 			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			
+			$_CLASS['core_db']-&gt;free_result($result);
+
 			if ($row &amp;&amp; !$row['forum_id'] &amp;&amp; $row['topic_type'] == POST_GLOBAL)
 			{
 				$to_forum_id = request_var('to_forum_id', 0);
 	
 				if (!$to_forum_id)
 				{
+					require_once  SITE_FILE_ROOT.'includes/forums/functions_admin.php';
+	
 					$_CLASS['core_template']-&gt;assign_array(array(
 						'S_FORUM_SELECT'	=&gt; make_forum_select(false, false, false, true, true),
 						'S_UNGLOBALISE'		=&gt; true) 
@@ -802,21 +917,21 @@
 		if ($submit)
 		{
 			// Lock/Unlock Topic
-			$change_topic_status = $posting_data['topic_status'];
-			$perm_lock_unlock = ($_CLASS['auth']-&gt;acl_get('m_lock', $forum_id) || ($_CLASS['auth']-&gt;acl_get('f_user_lock', $forum_id) &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] == $topic_poster));
+			$change_topic_status = $post_data['topic_status'];
+			$perm_lock_unlock = ($_CLASS['forums_auth']-&gt;acl_get('m_lock', $forum_id) || ($_CLASS['forums_auth']-&gt;acl_get('f_user_lock', $forum_id) &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] == $topic_poster));
 
-			if ($posting_data['topic_status'] == ITEM_LOCKED &amp;&amp; !$topic_lock &amp;&amp; $perm_lock_unlock)
+			if ($post_data['topic_status'] == ITEM_LOCKED &amp;&amp; !$topic_lock &amp;&amp; $perm_lock_unlock)
 			{
 				$change_topic_status = ITEM_UNLOCKED;
 			}
-			else if ($posting_data['topic_status'] == ITEM_UNLOCKED &amp;&amp; $topic_lock &amp;&amp; $perm_lock_unlock)
+			else if ($post_data['topic_status'] == ITEM_UNLOCKED &amp;&amp; $topic_lock &amp;&amp; $perm_lock_unlock)
 			{
 				$change_topic_status = ITEM_LOCKED;
 			}
 		
-			if ($change_topic_status != $posting_data['topic_status'])
+			if ($change_topic_status != $post_data['topic_status'])
 			{
-				$posting_data['topic_status'] = $change_topic_status;
+				$post_data['topic_status'] = $change_topic_status;
 
 				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . &quot;
 					SET topic_status = $change_topic_status
@@ -824,49 +939,49 @@
 						AND topic_moved_id = 0&quot;;
 				$_CLASS['core_db']-&gt;query($sql);
 			
-				$user_lock = ($_CLASS['auth']-&gt;acl_get('f_user_lock', $forum_id) &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] == $topic_poster) ? 'USER_' : '';
+				$user_lock = ($_CLASS['forums_auth']-&gt;acl_get('f_user_lock', $forum_id) &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] == $topic_poster) ? 'USER_' : '';
 
-				//add_log('mod', $forum_id, $topic_id, 'LOG_' . $user_lock . (($change_topic_status == ITEM_LOCKED) ? 'LOCK' : 'UNLOCK'), $posting_data['topic_title']);
+				//add_log('mod', $forum_id, $topic_id, 'LOG_' . $user_lock . (($change_topic_status == ITEM_LOCKED) ? 'LOCK' : 'UNLOCK'), $post_data['topic_title']);
 			}
 
 			// Lock/Unlock Post Edit
-			if ($mode == 'edit' &amp;&amp; $posting_data['post_edit_locked'] == ITEM_LOCKED &amp;&amp; !$post_lock &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id))
+			if ($mode == 'edit' &amp;&amp; $post_data['post_edit_locked'] == ITEM_LOCKED &amp;&amp; !$post_lock &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id))
 			{
-				$posting_data['post_edit_locked'] = ITEM_UNLOCKED;
+				$post_data['post_edit_locked'] = ITEM_UNLOCKED;
 			}
-			else if ($mode == 'edit' &amp;&amp; $posting_data['post_edit_locked'] == ITEM_UNLOCKED &amp;&amp; $post_lock &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id))
+			else if ($mode == 'edit' &amp;&amp; $post_data['post_edit_locked'] == ITEM_UNLOCKED &amp;&amp; $post_lock &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id))
 			{
-				$posting_data['post_edit_locked'] = ITEM_LOCKED;
+				$post_data['post_edit_locked'] = ITEM_LOCKED;
 			}
 
-			$post_data = array(
-				'topic_title'			=&gt; (!$posting_data['topic_title']) ? $subject : $posting_data['topic_title'],
-				'topic_first_post_id'	=&gt; (isset($topic_first_post_id)) ? (int) $topic_first_post_id : 0,
-				'topic_last_post_id'	=&gt; (isset($topic_last_post_id)) ? (int) $topic_last_post_id : 0,
-				'topic_time_limit'		=&gt; (int) $topic_time_limit,
-				'topic_status'			=&gt; (int) $posting_data['topic_status'],
-				'post_id'				=&gt; (int) $post_id,
-				'topic_id'				=&gt; (int) $topic_id,
-				'forum_id'				=&gt; (int) $forum_id,
-				'icon_id'				=&gt; (int) $icon_id,
-				'poster_id'				=&gt; (int) $posting_data['poster_id'],
-				'enable_sig'			=&gt; (bool) $enable_sig,
-				'enable_bbcode'			=&gt; (bool) $enable_bbcode,
-				'enable_html' 			=&gt; (bool) $enable_html,
-				'enable_smilies'		=&gt; (bool) $enable_smilies,
-				'enable_urls'			=&gt; (bool) $enable_urls,
-				'enable_indexing'		=&gt; (bool) $enable_indexing,
+			$data = array(
+				'topic_title'			=&gt; (empty($post_data['topic_title'])) ? $post_data['post_subject'] : $post_data['topic_title'],
+				'topic_first_post_id'	=&gt; (isset($post_data['topic_first_post_id'])) ? (int) $post_data['topic_first_post_id'] : 0,
+				'topic_last_post_id'	=&gt; (isset($post_data['topic_last_post_id'])) ? (int) $post_data['topic_last_post_id'] : 0,
+				'topic_time_limit'		=&gt; (int) $post_data['topic_time_limit'],
+				'topic_status'			=&gt; (int) $post_data['topic_status'],
+				'post_id'				=&gt; (int) $post_id,
+				'topic_id'				=&gt; (int) $topic_id,
+				'forum_id'				=&gt; (int) $forum_id,
+				'icon_id'				=&gt; (int) $post_data['icon_id'],
+				'poster_id'				=&gt; (int) $post_data['poster_id'],
+				'enable_sig'			=&gt; (bool) $post_data['enable_sig'],
+				'enable_bbcode'			=&gt; (bool) $post_data['enable_bbcode'],
+				'enable_html' 			=&gt; (bool) $post_data['enable_html'],
+				'enable_smilies'		=&gt; (bool) $post_data['enable_smilies'],
+				'enable_urls'			=&gt; (bool) $post_data['enable_urls'],
+				'enable_indexing'		=&gt; (bool) $post_data['enable_indexing'],
 				'message_md5'			=&gt; (string) $message_md5,
-				'post_time'				=&gt; ($posting_data['post_time']) ? (int) $posting_data['post_time'] : $current_time,
-				'post_checksum'			=&gt; (isset($post_checksum)) ? (string) $post_checksum : '',
-				'post_edit_reason'		=&gt; $posting_data['post_edit_reason'],
-				'post_edit_user'		=&gt; ($mode == 'edit') ? $_CLASS['core_user']-&gt;data['user_id'] : ((isset($post_edit_user)) ? (int) $post_edit_user : 0),
-				'forum_parents'			=&gt; $forum_parents,
-				'forum_name'			=&gt; $forum_name,
-				'notify'				=&gt; $notify,
-				'notify_set'			=&gt; $notify_set,
-				'poster_ip'				=&gt; (isset($poster_ip)) ? (int) $poster_ip : $_CLASS['core_user']-&gt;ip,
-				'post_edit_locked'		=&gt; (int) $posting_data['post_edit_locked'],
+				'post_time'				=&gt; (isset($post_data['post_time'])) ? (int) $post_data['post_time'] : $current_time,
+				'post_checksum'			=&gt; (isset($post_data['post_checksum'])) ? (string) $post_data['post_checksum'] : '',
+				'post_edit_reason'		=&gt; $post_data['post_edit_reason'],
+				'post_edit_user'		=&gt; ($mode == 'edit') ? $_CLASS['core_user']-&gt;data['user_id'] : ((isset($post_data['post_edit_user'])) ? (int) $post_data['post_edit_user'] : 0),
+				'forum_parents'			=&gt; $post_data['forum_parents'],
+				'forum_name'			=&gt; $post_data['forum_name'],
+				'notify'				=&gt; $notify,
+				'notify_set'			=&gt; $post_data['notify_set'],
+				'poster_ip'				=&gt; (isset($post_data['poster_ip'])) ? $post_data['poster_ip'] : $_CLASS['core_user']-&gt;ip,
+				'post_edit_locked'		=&gt; (int) $post_data['post_edit_locked'],
 				'bbcode_bitfield'		=&gt; (int) $message_parser-&gt;bbcode_bitfield,
 				'bbcode_uid'			=&gt; $message_parser-&gt;bbcode_uid,
 				'message'				=&gt; $message_parser-&gt;message,
@@ -875,26 +990,32 @@
 			);
 			unset($message_parser);
 			
-			submit_post($mode, $subject, $posting_data['username'], $posting_data['topic_type'], $poll, $post_data, $update_message);
+			$redirect_url = submit_post($mode, $post_data['post_subject'], $post_data['username'], $post_data['topic_type'], $poll, $data, $update_message);
+
+			$_CLASS['core_display']-&gt;meta_refresh(3, $redirect_url);
+
+			$message = (!$_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? (($mode == 'edit') ? 'POST_EDITED_MOD' : 'POST_STORED_MOD') : (($mode == 'edit') ? 'POST_EDITED' : 'POST_STORED');
+			$message = $_CLASS['core_user']-&gt;get_lang($message) . (($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;get_lang('VIEW_MESSAGE'), '&lt;a href=&quot;' . $redirect_url . '&quot;&gt;', '&lt;/a&gt;') : '');
+			$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;get_lang('RETURN_FORUM'), '&lt;a href=&quot;' . generate_link('forums&amp;file=viewforumf=' . $data['forum_id']) . '&quot;&gt;', '&lt;/a&gt;');
+			trigger_error($message);
+		
 		}
 	}	
-
-	$post_subject = $subject;
 }
 
 // Preview
 if (empty($error) &amp;&amp; $preview)
 {
-	$posting_data['post_time'] = ($mode == 'edit') ? $posting_data['post_time'] : $current_time;
+	$post_data['post_time'] = ($mode == 'edit') ? $post_data['post_time'] : $current_time;
 
-	$preview_message = $message_parser-&gt;format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
+	$preview_message = $message_parser-&gt;format_display($post_data['enable_html'], $post_data['enable_bbcode'], $post_data['enable_urls'], $post_data['enable_smilies'], false);
 
-	$preview_signature = ($mode == 'edit') ? $user_sig : $_CLASS['core_user']-&gt;data['user_sig'];
-	$preview_signature_uid = ($mode == 'edit') ? $user_sig_bbcode_uid : $_CLASS['core_user']-&gt;data['user_sig_bbcode_uid'];
-	$preview_signature_bitfield = ($mode == 'edit') ? $user_sig_bbcode_bitfield : $_CLASS['core_user']-&gt;data['user_sig_bbcode_bitfield'];
+	$preview_signature = ($mode == 'edit') ? $post_data['user_sig'] : $_CLASS['core_user']-&gt;data['user_sig'];
+	$preview_signature_uid = ($mode == 'edit') ? $post_data['user_sig_bbcode_uid'] : $_CLASS['core_user']-&gt;data['user_sig_bbcode_uid'];
+	$preview_signature_bitfield = ($mode == 'edit') ? $post_data['user_sig_bbcode_bitfield'] : $_CLASS['core_user']-&gt;data['user_sig_bbcode_bitfield'];
 
 	// Signature
-	if ($enable_sig &amp;&amp; $config['allow_sig'] &amp;&amp; $preview_signature &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_sigs', $forum_id))
+	if ($post_data['enable_sig'] &amp;&amp; $config['allow_sig'] &amp;&amp; $preview_signature &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_sigs', $forum_id))
 	{
 		$parse_sig = new parse_message($preview_signature);
 		$parse_sig-&gt;bbcode_uid = $preview_signature_uid;
@@ -910,31 +1031,31 @@
 		$preview_signature = '';
 	}
 	
-	$preview_subject = censor_text($subject);
+	$preview_subject = censor_text($post_data['post_subject']);
 	
 	// Poll Preview
-	if (($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_id == $topic_first_post_id &amp;&amp; (!$poll_last_vote || $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id))))
-	&amp;&amp; $_CLASS['auth']-&gt;acl_get('f_poll', $forum_id))
+	if (($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_id == $post_data['topic_first_post_id'] &amp;&amp; (!$post_data['poll_last_vote'] || $_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id))))
+	&amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_poll', $forum_id))
 	{
-		$parse_poll = new parse_message($poll_title);
+		$parse_poll = new parse_message($post_data['poll_title']);
 		$parse_poll-&gt;bbcode_uid = $message_parser-&gt;bbcode_uid;
 		$parse_poll-&gt;bbcode_bitfield = $message_parser-&gt;bbcode_bitfield;
 
-		$parse_poll-&gt;format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies);
+		$parse_poll-&gt;format_display($post_data['enable_html'], $post_data['enable_bbcode'], $post_data['enable_urls'], $post_data['enable_smilies']);
 		
 		$_CLASS['core_template']-&gt;assign_array(array(
 			'S_HAS_POLL_OPTIONS'=&gt; !empty($poll_options),
-			'S_IS_MULTI_CHOICE'	=&gt; ($poll_max_options &gt; 1) ? true : false,
+			'S_IS_MULTI_CHOICE'	=&gt; ($post_data['poll_max_options'] &gt; 1) ? true : false,
 
 			'POLL_QUESTION'		=&gt; $parse_poll-&gt;message,
 			
-			'L_POLL_LENGTH'		=&gt; ($poll_length) ? sprintf($_CLASS['core_user']-&gt;lang['POLL_RUN_TILL'], $_CLASS['core_user']-&gt;format_date($poll_length + $poll_start)) : '',
-			'L_MAX_VOTES'		=&gt; ($poll_max_options == 1) ? $_CLASS['core_user']-&gt;lang['MAX_OPTION_SELECT'] : sprintf($_CLASS['core_user']-&gt;lang['MAX_OPTIONS_SELECT'], $poll_max_options))
+			'L_POLL_LENGTH'		=&gt; ($post_data['poll_length']) ? sprintf($_CLASS['core_user']-&gt;get_lang('POLL_RUN_TILL'), $_CLASS['core_user']-&gt;format_date($post_data['poll_length'] + $post_data['poll_start'])) : '',
+			'L_MAX_VOTES'		=&gt; ($post_data['poll_max_options'] == 1) ? $_CLASS['core_user']-&gt;get_lang('MAX_OPTION_SELECT') : sprintf($_CLASS['core_user']-&gt;get_lang('MAX_OPTIONS_SELECT'), $post_data['poll_max_options']))
 		);
 		
-		$parse_poll-&gt;message = implode(&quot;\n&quot;, $poll_options);
-		$parse_poll-&gt;format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies);
-		$preview_poll_options = explode('&lt;br /&gt;', $parse_poll-&gt;message);
+		$parse_poll-&gt;message = implode(&quot;\n&quot;, $post_data['poll_options']);
+		$parse_poll-&gt;format_display($post_data['enable_html'], $post_data['enable_bbcode'], $post_data['enable_urls'], $post_data['enable_smilies']);
+		$preview_poll_options = explode('&lt;br /&gt;', $parse_poll-&gt;message);
 		unset($parse_poll);
 		
 		foreach ($preview_poll_options as $option)
@@ -984,36 +1105,35 @@
 }
 
 // Decode text for message display
-$bbcode_uid = ($mode == 'quote' &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; empty($error)) ? $bbcode_uid : $message_parser-&gt;bbcode_uid;
-$message_parser-&gt;decode_message($bbcode_uid);
+$post_data['bbcode_uid'] = ($mode == 'quote' &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; !sizeof($error)) ? $post_data['bbcode_uid'] : $message_parser-&gt;bbcode_uid;
+$message_parser-&gt;decode_message($post_data['bbcode_uid']);
 
-if ($mode == 'quote' &amp;&amp; !$preview &amp;&amp; !$refresh)
+if ($mode == 'quote' &amp;&amp; !$submit &amp;&amp; !$preview &amp;&amp; !$refresh)
 {
-	$quote_username = isset($posting_data['username']) ? $posting_data['username'] : (isset($posting_data['post_username']) ? $posting_data['post_username'] : '');
-	$message_parser-&gt;message = '[quote=&quot;' . $quote_username . '&quot;]' . censor_text(trim($message_parser-&gt;message)) . &quot;[/quote]\n&quot;;
+	$message_parser-&gt;message = '[quote=&quot;' . $post_data['quote_username'] . '&quot;]' . censor_text(trim($message_parser-&gt;message)) . &quot;[/quote]\n&quot;;
 }
 
-if (($mode == 'reply' || $mode == 'quote') &amp;&amp; !$preview &amp;&amp; !$refresh)
-{
-	$post_subject = ((!preg_match('/^Re:/', $post_subject)) ? 'Re: ' : '') . censor_text($post_subject);
+if (($mode == 'reply' || $mode == 'quote') &amp;&amp; !$submit &amp;&amp; !$preview &amp;&amp; !$refresh)
+{
+	$post_data['post_subject'] = ((!preg_match('/^Re:/', $post_data['post_subject'])) ? 'Re: ' : '') . censor_text($post_data['post_subject']);
 }
 
 $attachment_data = $message_parser-&gt;attachment_data;
 $filename_data = $message_parser-&gt;filename_data;
-$post_text = $message_parser-&gt;message;
+$post_data['post_text'] = $message_parser-&gt;message;
 
-if (!empty($poll_options) &amp;&amp; $poll_title)
-{
-	$message_parser-&gt;message = $poll_title;
-	$message_parser-&gt;bbcode_uid = $bbcode_uid;
-
-	$message_parser-&gt;decode_message();
-	$poll_title = $message_parser-&gt;message;
-
-	$message_parser-&gt;message = implode(&quot;\n&quot;, $poll_options);
-	$message_parser-&gt;decode_message();
-	$poll_options = explode(&quot;\n&quot;, $message_parser-&gt;message);
-}
+if (sizeof($post_data['poll_options']) &amp;&amp; $post_data['poll_title'])
+{
+	$message_parser-&gt;message = $post_data['poll_title'];
+	$message_parser-&gt;bbcode_uid = $post_data['bbcode_uid'];
+
+	$message_parser-&gt;decode_message();
+	$post_data['poll_title'] = $message_parser-&gt;message;
+
+	$message_parser-&gt;message = implode(&quot;\n&quot;, $post_data['poll_options']);
+	$message_parser-&gt;decode_message();
+	$post_data['poll_options'] = explode(&quot;\n&quot;, $message_parser-&gt;message);
+}
 unset($message_parser);
 
 // MAIN POSTING PAGE BEGINS HERE
@@ -1030,29 +1150,32 @@
 // Do show topic type selection only in first post.
 $topic_type_toggle = false;
 
-if ($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_id == $topic_first_post_id))
+if ($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_id == $post_data['topic_first_post_id']))
 {
-	$topic_type_toggle = posting_gen_topic_types($forum_id, $posting_data['topic_type']);
+	$topic_type_toggle = posting_gen_topic_types($forum_id, $post_data['topic_type']);
 }
 
 $s_topic_icons = false;
 
-if ($enable_icons)
+if ($post_data['enable_icons'])
 {
-	$s_topic_icons = posting_gen_topic_icons($mode, $icon_id);
+	$s_topic_icons = posting_gen_topic_icons($mode, $post_data['icon_id']);
 }
 
 
 
-$html_checked		= (isset($enable_html)) ? !$enable_html : (($config['allow_html']) ? !$_CLASS['core_user']-&gt;user_data_get('html') : 1);
-$bbcode_checked		= (isset($enable_bbcode)) ? !$enable_bbcode : (($config['allow_bbcode']) ? !$_CLASS['core_user']-&gt;user_data_get('bbcode') : 1);
-$smilies_checked	= (isset($enable_smilies)) ? !$enable_smilies : (($config['allow_smilies']) ? !$_CLASS['core_user']-&gt;user_data_get('smilies') : 1);
-$urls_checked		= (isset($enable_urls)) ? !$enable_urls : 0;
-$sig_checked		= $enable_sig;
-$notify_checked		= (isset($notify)) ? $notify : ((!$notify_set) ? (($_CLASS['core_user']-&gt;is_user) ? $_CLASS['core_user']-&gt;data['user_notify'] : 0) : 1);
-$lock_topic_checked	= (isset($topic_lock)) ? $topic_lock : (($posting_data['topic_status'] == ITEM_LOCKED) ? 1 : 0);
-$lock_post_checked	= isset($post_lock) ? $post_lock : $posting_data['post_edit_locked'];
+$html_checked		= (isset($post_data['enable_html'])) ? !$post_data['enable_html'] : (($config['allow_html']) ? !$_CLASS['core_user']-&gt;user_data_get('html') : 1);
+$bbcode_checked		= (isset($post_data['enable_bbcode'])) ? !$post_data['enable_bbcode'] : (($config['allow_bbcode']) ? !$_CLASS['core_user']-&gt;user_data_get('bbcode') : 1);
+$smilies_checked	= (isset($post_data['enable_smilies'])) ? !$post_data['enable_smilies'] : (($config['allow_smilies']) ? !$_CLASS['core_user']-&gt;user_data_get('smilies') : 1);
+$urls_checked		= (isset($post_data['enable_urls'])) ? !$post_data['enable_urls'] : 0;
+$sig_checked		= $post_data['enable_sig'];
 
+$lock_topic_checked	= (isset($topic_lock)) ? $topic_lock : (($post_data['topic_status'] == ITEM_LOCKED) ? 1 : 0);
+$lock_post_checked	= (isset($post_lock)) ? $post_lock : $post_data['post_edit_locked'];
+
+// If in edit mode, and the user is not the poster, we do not take the notification into account
+$notify_checked		= (isset($notify)) ? $notify : (($mode == 'post') ? $_CLASS['core_user']-&gt;data['user_notify'] : $post_data['notify_set']);
+
 // Page title &amp; action URL, include session_id for security purpose
 $s_action = &quot;forums&amp;file=posting&amp;mode=$mode&amp;f=$forum_id&quot;;
 $s_action .= ($topic_id) ? &quot;&amp;t=$topic_id&quot; : '';
@@ -1063,116 +1186,138 @@
 {
 	case 'post':
 		$page_title = $_CLASS['core_user']-&gt;lang['POST_TOPIC'];
-		break;
+	break;
 
 	case 'quote':
 	case 'reply':
 		$page_title = $_CLASS['core_user']-&gt;lang['POST_REPLY'];
-		break;
+	break;
 
 	case 'delete':
 	case 'edit':
 		$page_title = $_CLASS['core_user']-&gt;lang['EDIT_POST'];
+	break;
 }
 
-$forum_data = array(
-	'parent_id'		=&gt; $parent_id,
-	'left_id'		=&gt; $left_id,
-	'right_id'		=&gt; $right_id,
-	'forum_parents'	=&gt; $forum_parents,
-	'forum_name'	=&gt; $forum_name,
-	'forum_id'		=&gt; $forum_id,
-	'forum_type'	=&gt; $posting_data['forum_type'],
-	'forum_desc'	=&gt; $forum_desc,
-	'forum_rules'	=&gt; $forum_rules,
-	'forum_rules_flags' =&gt; $forum_rules_flags,
-	'forum_rules_bbcode_uid' =&gt; $forum_rules_bbcode_uid,
-	'forum_rules_bbcode_bitfield' =&gt; $forum_rules_bbcode_bitfield,
-	'forum_rules_link' =&gt; $forum_rules_link
-);
-
 // Build Navigation Links
-generate_forum_nav($forum_data);
+generate_forum_nav($post_data);
 
 // Build Forum Rules
-generate_forum_rules($forum_data);
+generate_forum_rules($post_data);
+/*
+if ($config['enable_post_confirm'] &amp;&amp; !$_CLASS['core_user']-&gt;is_user &amp;&amp; ($mode == 'post' || $mode == 'reply' || $mode == 'quote'))
+{
+	// Show confirm image
+	$sql = 'DELETE FROM ' . CONFIRM_TABLE . &quot;
+		WHERE session_id = '&quot; . $db-&gt;sql_escape($_CLASS['core_user']-&gt;session_id) . &quot;'
+			AND confirm_type = &quot; . CONFIRM_POST;
+	$db-&gt;sql_query($sql);
+
+	// Generate code
+	$code = gen_rand_string(mt_rand(5, 8));
+	$confirm_id = md5(unique_id($_CLASS['core_user']-&gt;ip));
+
+	$sql = 'INSERT INTO ' . CONFIRM_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', array(
+		'confirm_id'	=&gt; (string) $confirm_id,
+		'session_id'	=&gt; (string) $_CLASS['core_user']-&gt;session_id,
+		'confirm_type'	=&gt; (int) CONFIRM_POST,
+		'code'			=&gt; (string) $code)
+	);
+	$db-&gt;sql_query($sql);
+
+	$template-&gt;assign_vars(array(
+		'S_CONFIRM_CODE'			=&gt; true,
+		'CONFIRM_ID'				=&gt; $confirm_id,
+		'CONFIRM_IMAGE'				=&gt; '&lt;img src=&quot;' . append_sid(&quot;{$phpbb_root_path}ucp.$phpEx&quot;, 'mode=confirm&amp;id=' . $confirm_id . '&amp;type=' . CONFIRM_POST) . '&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;',
+		'L_POST_CONFIRM_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;get_lang('POST_CONFIRM_EXPLAIN'), '&lt;a href=&quot;mailto:' . htmlentities($config['board_contact']) . '&quot;&gt;', '&lt;/a&gt;'),
+	));
+}*/
 
-$s_hidden_fields = ($mode == 'reply' || $mode == 'quote') ? '&lt;input type=&quot;hidden&quot; name=&quot;topic_cur_post_id&quot; value=&quot;' . $topic_last_post_id . '&quot; /&gt;' : '';
-$s_hidden_fields .= ($draft_id || isset($_REQUEST['draft_loaded'])) ? '&lt;input type=&quot;hidden&quot; name=&quot;draft_loaded&quot; value=&quot;' . ((isset($_REQUEST['draft_loaded'])) ? intval($_REQUEST['draft_loaded']) : $draft_id) . '&quot; /&gt;' : '';
+$s_hidden_fields = ($mode == 'reply' || $mode == 'quote') ? '&lt;input type=&quot;hidden&quot; name=&quot;topic_cur_post_id&quot; value=&quot;' . $post_data['topic_last_post_id'] . '&quot; /&gt;' : '';
+$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;lastclick&quot; value=&quot;' . $current_time . '&quot; /&gt;';
+$s_hidden_fields .= ($draft_id || isset($_REQUEST['draft_loaded'])) ? '&lt;input type=&quot;hidden&quot; name=&quot;draft_loaded&quot; value=&quot;' . request_var('draft_loaded', $draft_id) . '&quot; /&gt;' : '';
 
-$form_enctype = (@ini_get('file_uploads') == '0' || strtolower(@ini_get('file_uploads')) == 'off' || @ini_get('file_uploads') == '0' || !$config['allow_attachments'] || !$_CLASS['auth']-&gt;acl_gets(array('f_attach', 'u_attach'), $forum_id)) ? '' : ' enctype=&quot;multipart/form-data&quot;';
+$form_enctype = (@ini_get('file_uploads') == '0' || strtolower(@ini_get('file_uploads')) == 'off' || @ini_get('file_uploads') == '0' || !$config['allow_attachments'] || !$_CLASS['forums_auth']-&gt;acl_gets(array('f_attach', 'u_attach'), $forum_id)) ? '' : ' enctype=&quot;multipart/form-data&quot;';
 
 // Start assigning vars for main posting page ...
 $_CLASS['core_template']-&gt;assign_array(array(
 	'L_POST_A'				=&gt; $page_title,
-	'L_ICON'				=&gt; ($mode == 'reply' || $mode == 'quote') ? $_CLASS['core_user']-&gt;lang['POST_ICON'] : $_CLASS['core_user']-&gt;lang['TOPIC_ICON'], 
-	'L_MESSAGE_BODY_EXPLAIN'=&gt; (intval($config['max_post_chars'])) ? sprintf($_CLASS['core_user']-&gt;lang['MESSAGE_BODY_EXPLAIN'], intval($config['max_post_chars'])) : '',
+	'L_ICON'					=&gt; ($mode == 'reply' || $mode == 'quote' || ($mode == 'edit' &amp;&amp; $post_id != $post_data['topic_first_post_id'])) ? $_CLASS['core_user']-&gt;lang['POST_ICON'] : $_CLASS['core_user']-&gt;lang['TOPIC_ICON'],
+	'L_MESSAGE_BODY_EXPLAIN'	=&gt; (intval($config['max_post_chars'])) ? sprintf($_CLASS['core_user']-&gt;get_lang('MESSAGE_BODY_EXPLAIN'), intval($config['max_post_chars'])) : '',
 	
-	'FORUM_NAME' 			=&gt; $forum_name,
-	'FORUM_DESC'			=&gt; ($forum_desc) ? strip_tags($forum_desc) : '',
-	'TOPIC_TITLE' 			=&gt; $posting_data['topic_title'],
+	'FORUM_NAME'			=&gt; $post_data['forum_name'],
+	'FORUM_DESC'			=&gt; ($post_data['forum_desc']) ? strip_tags($post_data['forum_desc']) : '',
+	'TOPIC_TITLE'			=&gt; censor_text($post_data['topic_title']),
 	'MODERATORS' 			=&gt; empty($moderators) ? '' : implode(', ', $moderators[$forum_id]),
-	'USERNAME'				=&gt; ((!$preview &amp;&amp; $mode != 'quote') || $preview) ? $posting_data['username'] : '',
-	'SUBJECT'				=&gt; $post_subject,
-	'MESSAGE'				=&gt; $post_text,
+	'USERNAME'				=&gt; ((!$preview &amp;&amp; $mode != 'quote') || $preview) ? $post_data['username'] : '',
+	'SUBJECT'				=&gt; $post_data['post_subject'],
+	'MESSAGE'				=&gt; $post_data['post_text'],
 	'HTML_STATUS'			=&gt; ($html_status) ? $_CLASS['core_user']-&gt;lang['HTML_IS_ON'] : $_CLASS['core_user']-&gt;lang['HTML_IS_OFF'],
-	'BBCODE_STATUS'			=&gt; ($bbcode_status) ? sprintf($_CLASS['core_user']-&gt;lang['BBCODE_IS_ON'], '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;phpbbcode&quot; onclick=&quot;window.open(\''.generate_link('Forums&amp;file=faq&amp;mode=bbcode').&quot;', '_phpbbcode', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false\&quot;&gt;&quot;, '&lt;/a&gt;') : sprintf($_CLASS['core_user']-&gt;lang['BBCODE_IS_OFF'], '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;'),
+	'BBCODE_STATUS'			=&gt; ($bbcode_status) ? sprintf($_CLASS['core_user']-&gt;lang['BBCODE_IS_ON'], '&lt;a href=&quot;' . generate_link('forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;phpbbcode&quot; onclick=&quot;window.open(\''.generate_link('forums&amp;file=faq&amp;mode=bbcode').&quot;', '_phpbbcode', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false\&quot;&gt;&quot;, '&lt;/a&gt;') : sprintf($_CLASS['core_user']-&gt;lang['BBCODE_IS_OFF'], '&lt;a href=&quot;' . generate_link('forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;'),
 	'IMG_STATUS'			=&gt; ($img_status) ? $_CLASS['core_user']-&gt;lang['IMAGES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['IMAGES_ARE_OFF'],
 	'FLASH_STATUS'			=&gt; ($flash_status) ? $_CLASS['core_user']-&gt;lang['FLASH_IS_ON'] : $_CLASS['core_user']-&gt;lang['FLASH_IS_OFF'],
 	'SMILIES_STATUS'		=&gt; ($smilies_status) ? $_CLASS['core_user']-&gt;lang['SMILIES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['SMILIES_ARE_OFF'],
 	'MINI_POST_IMG'			=&gt; $_CLASS['core_user']-&gt;img('icon_post', $_CLASS['core_user']-&gt;lang['POST']),
-	'POST_DATE'				=&gt; ($posting_data['post_time']) ? $_CLASS['core_user']-&gt;format_date($posting_data['post_time']) : '',
+	'POST_DATE'				=&gt; ($post_data['post_time']) ? $_CLASS['core_user']-&gt;format_date($post_data['post_time']) : '',
 	'ERROR'					=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error), 
-	'TOPIC_TIME_LIMIT'		=&gt; (int) $topic_time_limit,
-	'EDIT_REASON'			=&gt; $posting_data['post_edit_reason'],
+	'TOPIC_TIME_LIMIT'		=&gt; (int) $post_data['topic_time_limit'],
+	'EDIT_REASON'			=&gt; $post_data['post_edit_reason'],
 
-	'U_VIEW_FORUM' 			=&gt; generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id),
-	'U_VIEWTOPIC' 			=&gt; ($mode != 'post') ? generate_link(&quot;Forums&amp;file=viewtopic&amp;$forum_id&amp;t=$topic_id&quot;) : '',
+	'U_VIEW_FORUM' 			=&gt; generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id),
+	'U_VIEWTOPIC' 			=&gt; ($mode != 'post') ? generate_link(&quot;forums&amp;file=viewtopic&amp;$forum_id&amp;t=$topic_id&quot;) : '',
 
 	'S_EDIT_POST'			=&gt; ($mode == 'edit'),
-	'S_EDIT_REASON'			=&gt; ($mode == 'edit' &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] != $posting_data['poster_id']),
-	'S_DISPLAY_USERNAME'	=&gt; (!$_CLASS['core_user']-&gt;is_user || ($mode == 'edit' &amp;&amp; $post_username)),
+	'S_EDIT_REASON'			=&gt; ($mode == 'edit' &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] != $post_data['poster_id']),
+	'S_DISPLAY_USERNAME'	=&gt; (!$_CLASS['core_user']-&gt;is_user || ($mode == 'edit' &amp;&amp; $post_data['post_username'])),
 	'S_SHOW_TOPIC_ICONS'	=&gt; $s_topic_icons,
-	'S_DELETE_ALLOWED' 		=&gt; ($mode == 'edit' &amp;&amp; (($post_id == $topic_last_post_id &amp;&amp; $posting_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_delete', $forum_id)) || $_CLASS['auth']-&gt;acl_get('m_delete', $forum_id))),
+	'S_DELETE_ALLOWED'		=&gt; ($mode == 'edit' &amp;&amp; (($post_id == $post_data['topic_last_post_id'] &amp;&amp; $post_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_delete', $forum_id)) || $_CLASS['forums_auth']-&gt;acl_get('m_delete', $forum_id))) ? true : false,
 	'S_HTML_ALLOWED'		=&gt; $html_status,
 	'S_HTML_CHECKED' 		=&gt; ($html_checked) ? ' checked=&quot;checked&quot;' : '',
 	'S_BBCODE_ALLOWED'		=&gt; $bbcode_status,
 	'S_BBCODE_CHECKED' 		=&gt; ($bbcode_checked) ? ' checked=&quot;checked&quot;' : '',
 	'S_SMILIES_ALLOWED'		=&gt; $smilies_status,
 	'S_SMILIES_CHECKED' 	=&gt; ($smilies_checked) ? ' checked=&quot;checked&quot;' : '',
-	'S_SIG_ALLOWED'			=&gt; ($_CLASS['auth']-&gt;acl_get('f_sigs', $forum_id) &amp;&amp; $config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;is_user),
+	'S_SIG_ALLOWED'			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('f_sigs', $forum_id) &amp;&amp; $config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;is_user),
 	'S_SIGNATURE_CHECKED' 	=&gt; ($sig_checked) ? ' checked=&quot;checked&quot;' : '',
 	'S_NOTIFY_ALLOWED'		=&gt; ($_CLASS['core_user']-&gt;is_user),
 	'S_NOTIFY_CHECKED' 		=&gt; ($notify_checked) ? ' checked=&quot;checked&quot;' : '',
-	'S_LOCK_TOPIC_ALLOWED'	=&gt; (($mode == 'edit' || $mode == 'reply' || $mode == 'quote') &amp;&amp; ($_CLASS['auth']-&gt;acl_get('m_lock', $forum_id) || ($_CLASS['auth']-&gt;acl_get('f_user_lock', $forum_id) &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] == $topic_poster))),
+	'S_LOCK_TOPIC_ALLOWED'	=&gt; (($mode == 'edit' || $mode == 'reply' || $mode == 'quote') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('m_lock', $forum_id) || ($_CLASS['forums_auth']-&gt;acl_get('f_user_lock', $forum_id) &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] == $topic_poster))),
 	'S_LOCK_TOPIC_CHECKED'	=&gt; ($lock_topic_checked) ? ' checked=&quot;checked&quot;' : '',
-	'S_LOCK_POST_ALLOWED'	=&gt; ($mode == 'edit' &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id)),
+	'S_LOCK_POST_ALLOWED'	=&gt; ($mode == 'edit' &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id)),
 	'S_LOCK_POST_CHECKED'	=&gt; ($lock_post_checked) ? ' checked=&quot;checked&quot;' : '',
 	'S_MAGIC_URL_CHECKED' 	=&gt; ($urls_checked) ? ' checked=&quot;checked&quot;' : '',
 	'S_TYPE_TOGGLE'			=&gt; $topic_type_toggle,
-	'S_SAVE_ALLOWED'		=&gt; ($_CLASS['auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $_CLASS['core_user']-&gt;is_user),
-	'S_HAS_DRAFTS'			=&gt; ($_CLASS['auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $drafts),
+	'S_SAVE_ALLOWED'		=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $_CLASS['core_user']-&gt;is_user),
+	'S_HAS_DRAFTS'			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $post_data['drafts']),
 	'S_FORM_ENCTYPE'		=&gt; $form_enctype,
 
+	'S_BBCODE_IMG'			=&gt; $img_status,
+	'S_BBCODE_FLASH'		=&gt; $flash_status,
+	'S_BBCODE_QUOTE'		=&gt; $quote_status,
+
 	'S_POST_ACTION' 		=&gt; $s_action,
 	'S_HIDDEN_FIELDS'		=&gt; $s_hidden_fields)
 );
 
+// Build custom bbcodes array
+//display_custom_bbcodes();
+
 // Poll entry
-if (($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_id == $topic_first_post_id &amp;&amp; (!$poll_last_vote || $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id))))
-	&amp;&amp; $_CLASS['auth']-&gt;acl_get('f_poll', $forum_id))
+if (($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_id == $post_data['topic_first_post_id'] &amp;&amp; (!$post_data['poll_last_vote'] || $_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id))))
+	&amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_poll', $forum_id))
 {
 	$_CLASS['core_template']-&gt;assign_array(array(
 		'S_SHOW_POLL_BOX'		=&gt; true,
-		'S_POLL_VOTE_CHANGE'    =&gt; ($_CLASS['auth']-&gt;acl_get('f_votechg', $forum_id)),
-		'S_POLL_DELETE'			=&gt; ($mode == 'edit' &amp;&amp; $poll_options &amp;&amp; ((!$poll_last_vote &amp;&amp; $posting_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_delete', $forum_id)) || $_CLASS['auth']-&gt;acl_get('m_delete', $forum_id))),
+		'S_POLL_VOTE_CHANGE'    =&gt; ($_CLASS['forums_auth']-&gt;acl_get('f_votechg', $forum_id)),
+		'S_POLL_DELETE'			=&gt; ($mode == 'edit' &amp;&amp; !empty($post_data['poll_options']) &amp;&amp; ((!$post_data['poll_last_vote'] &amp;&amp; $post_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_delete', $forum_id)) || $_CLASS['forums_auth']-&gt;acl_get('m_delete', $forum_id))),
 
 		'L_POLL_OPTIONS_EXPLAIN'=&gt; sprintf($_CLASS['core_user']-&gt;lang['POLL_OPTIONS_EXPLAIN'], $config['max_poll_options']),
-		'VOTE_CHANGE_CHECKED'   =&gt; (isset($poll_vote_change) &amp;&amp; $poll_vote_change) ? ' checked=&quot;checked&quot;' : '',
-		'POLL_TITLE' 			=&gt; (isset($poll_title)) ? $poll_title : '',
-		'POLL_OPTIONS'			=&gt; (isset($poll_options) &amp;&amp; $poll_options) ? implode(&quot;\n&quot;, $poll_options) : '',
-		'POLL_MAX_OPTIONS'		=&gt; (isset($poll_max_options)) ? (int) $poll_max_options : 1, 
-		'POLL_LENGTH' 			=&gt; $poll_length)
+
+		'VOTE_CHANGE_CHECKED'	=&gt; (!empty($post_data['poll_vote_change'])) ? ' checked=&quot;checked&quot;' : '',
+		'POLL_TITLE'			=&gt; (isset($post_data['poll_title'])) ? $post_data['poll_title'] : '',
+		'POLL_OPTIONS'			=&gt; (!empty($post_data['poll_options'])) ? implode(&quot;\n&quot;, $post_data['poll_options']) : '',
+		'POLL_MAX_OPTIONS'		=&gt; (isset($post_data['poll_max_options'])) ? (int) $post_data['poll_max_options'] : 1,
+		'POLL_LENGTH'			=&gt; $post_data['poll_length'])
 	);
 }
 else
@@ -1185,7 +1330,7 @@
 }
 
 // Attachment entry
-if ($form_enctype)
+if ($_CLASS['forums_auth']-&gt;acl_get('f_attach', $forum_id) &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_attach') &amp;&amp; $config['allow_attachments'] &amp;&amp; $form_enctype)
 {
 	posting_gen_attachment_entry($attachment_data, $filename_data);
 }
@@ -1211,694 +1356,76 @@
 
 $_CLASS['core_template']-&gt;display('modules/forums/posting_body.html');
 
-// ---------
-// FUNCTIONS
-//
 
-// Delete Post
-function delete_post($mode, $post_id, $topic_id, $forum_id, &amp;$data)
-{
-	global $config, $_CLASS;
-
-	// Specify our post mode
-	$post_mode = ($data['topic_first_post_id'] == $data['topic_last_post_id']) ? 'delete_topic' : (($data['topic_first_post_id'] == $post_id) ? 'delete_first_post' : (($data['topic_last_post_id'] == $post_id) ? 'delete_last_post' : 'delete'));
-	$sql_data = array();
-	$next_post_id = 0;
-
-	$_CLASS['core_db']-&gt;transaction();
-
-	if (!delete_posts('post_id', array($post_id), false))
-	{
-		// Try to delete topic, we may had an previous error causing inconsistency
-		/*
-		if ($post_mode === 'delete_topic')
-		{
-			delete_topics('topic_id', array($topic_id), false);
-		}
-		*/
-
-		trigger_error('ALREADY_DELETED');
-	}
-
-	$_CLASS['core_db']-&gt;transaction('commit');
-
-	// Collect the necessary informations for updating the tables
-	$sql_data[FORUMS_FORUMS_TABLE] = '';
-
-	switch ($post_mode)
-	{
-		case 'delete_topic':
-			delete_topics('topic_id', array($topic_id), false);
-			set_config('num_topics', $config['num_topics'] - 1, true);
-
-			if ($data['topic_type'] != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE] .= 'forum_posts = forum_posts - 1, forum_topics_real = forum_topics_real - 1';
-				$sql_data[FORUMS_FORUMS_TABLE] .= ($data['topic_approved']) ? ', forum_topics = forum_topics - 1' : '';
-				$sql_data[FORUMS_FORUMS_TABLE] .= ', ';
-			}
-
-			$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
-			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-		break;
-
-		case 'delete_first_post':
-			$sql = 'SELECT p.post_id, p.poster_id, p.post_username, u.username 
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . &quot; u
-				WHERE p.topic_id = $topic_id 
-					AND p.poster_id = u.user_id 
-				ORDER BY p.post_time ASC&quot;;
-			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-
-			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			if ($data['topic_type'] != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
-			}
-
-			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_first_post_id = ' . intval($row['post_id']) . &quot;, topic_first_poster_name = '&quot; . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']-&gt;escape($row['post_username']) : $_CLASS['core_db']-&gt;escape($row['username'])) . &quot;'&quot;;
-			$sql_data[FORUMS_TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-
-			$next_post_id = (int) $row['post_id'];
-		break;
-			
-		case 'delete_last_post':
-			if ($data['topic_type'] != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
-			}
-
-			$sql_data[FORUMS_FORUMS_TABLE] .= ($sql_data[FORUMS_FORUMS_TABLE]) ? ', ' : '';
-			$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
-			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_bumped = 0, topic_bumper = 0, topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-
-			$update = update_last_post_information('topic', $topic_id);
-			if (!empty($update))
-			{
-				$sql_data[FORUMS_TOPICS_TABLE] .= ', ' . implode(', ', $update);
-				$next_post_id = (int) str_replace('topic_last_post_id = ', '', $update[0]);
-			}
-			else
-			{
-				$sql = 'SELECT MAX(post_id) as last_post_id
-					FROM ' . FORUMS_POSTS_TABLE . &quot;
-					WHERE topic_id = $topic_id &quot; .
-						((!$_CLASS['auth']-&gt;acl_get('m_approve')) ? 'AND post_approved = 1' : '');
-				$result = $_CLASS['core_db']-&gt;query($sql);
-				$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-				$_CLASS['core_db']-&gt;free_result($result);
-	
-				$next_post_id = (int) $row['last_post_id'];
-			}
-		break;
-			
-		case 'delete':
-			$sql = 'SELECT post_id
-				FROM ' . FORUMS_POSTS_TABLE . &quot;
-				WHERE topic_id = $topic_id &quot; . 
-					((!$_CLASS['auth']-&gt;acl_get('m_approve')) ? 'AND post_approved = 1' : '') . '
-					AND post_time &gt; ' . $data['post_time'] . '
-				ORDER BY post_time ASC';
-			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-
-			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			if ($data['topic_type'] != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
-			}
-
-			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-			$next_post_id = (int) $row['post_id'];
-		break;
-	}
-				
-	$sql_data[CORE_USERS_TABLE] = ($_CLASS['auth']-&gt;acl_get('f_postcount', $forum_id)) ? 'user_posts = user_posts - 1' : '';
-	set_config('num_posts', $config['num_posts'] - 1, true);
-
-	$_CLASS['core_db']-&gt;transaction();
-
-	$where_sql = array(FORUMS_FORUMS_TABLE =&gt; &quot;forum_id = $forum_id&quot;, FORUMS_TOPICS_TABLE =&gt; &quot;topic_id = $topic_id&quot;, CORE_USERS_TABLE =&gt; 'user_id = ' . $data['poster_id']);
-
-	foreach ($sql_data as $table =&gt; $update_sql)
-	{
-		if ($update_sql)
-		{
-			$_CLASS['core_db']-&gt;query(&quot;UPDATE $table SET $update_sql WHERE &quot; . $where_sql[$table]);
-		}
-	}
-
-	$_CLASS['core_db']-&gt;transaction('commit');
-
-	return $next_post_id;
+/**
+* Do the various checks required for removing posts as well as removing it
+*/
+function handle_post_delete($forum_id, $topic_id, $post_id, &amp;$post_data)
+{
+	global $_CLASS;
+
+	// If moderator removing post or user itself removing post, present a confirmation screen
+	if ($_CLASS['forums_auth']-&gt;acl_get('m_delete', $forum_id) || ($post_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['core_user']-&gt;data['is_registered'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $post_id == $post_data['topic_last_post_id']))
+	{
+		$s_hidden_fields = build_hidden_fields(array(
+			'p'		=&gt; $post_id,
+			'f'		=&gt; $forum_id,
+			'mode'	=&gt; 'delete')
+		);
+
+		if (confirm_box(true))
+		{
+			$data = array(
+				'topic_first_post_id'	=&gt; $post_data['topic_first_post_id'],
+				'topic_last_post_id'	=&gt; $post_data['topic_last_post_id'],
+				'topic_approved'		=&gt; $post_data['topic_approved'],
+				'topic_type'			=&gt; $post_data['topic_type'],
+				'post_approved'			=&gt; $post_data['post_approved'],
+				'post_reported'			=&gt; $post_data['post_reported'],
+				'post_time'				=&gt; $post_data['post_time'],
+				'poster_id'				=&gt; $post_data['poster_id'],
+				'post_postcount'		=&gt; $post_data['post_postcount']
+			);
+
+			$next_post_id = delete_post($forum_id, $topic_id, $post_id, $data);
+
+			if ($post_data['topic_first_post_id'] == $post_data['topic_last_post_id'])
+			{
+				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_TOPIC', $post_data['topic_title']);
+
+				$meta_info = generate_link('forums&amp;file=viewforumf='.$forum_id);
+				$message = $_CLASS['core_user']-&gt;lang['POST_DELETED'];
+			}
+			else
+			{
+				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_POST', $post_data['post_subject']);
+
+				$meta_info = generate_link(&quot;forums&amp;file=viewtopicf=$forum_id&amp;t=$topic_id&amp;p=$next_post_id&quot;) . &quot;#p$next_post_id&quot;;
+				$message = $_CLASS['core_user']-&gt;lang['POST_DELETED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;' . $meta_info . '&quot;&gt;', '&lt;/a&gt;');
+			}
+
+			$_CLASS['core_display']-&gt;meta_refresh(3, $meta_info);
+			$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;' . generate_link('forums&amp;file=viewforumf=' . $forum_id) . '&quot;&gt;', '&lt;/a&gt;');
+			trigger_error($message);
+		}
+		else
+		{
+			confirm_box(false, 'DELETE_MESSAGE', $s_hidden_fields);
+		}
+	}
+
+	// If we are here the user is not able to delete - present the correct error message
+	if ($post_data['poster_id'] != $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('f_delete', $forum_id))
+	{
+		trigger_error('DELETE_OWN_POSTS');
+	}
+
+	if ($post_data['poster_id'] == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $post_id != $post_data['topic_last_post_id'])
+	{
+		trigger_error('CANNOT_DELETE_REPLIED');
+	}
+
+	trigger_error('USER_CANNOT_DELETE');
 }
 
-// Submit Post
-function submit_post($mode, $subject, $username, $topic_type, &amp;$poll, &amp;$data, $update_message = true)
-{
-	global $_CLASS, $config;
-
-	// We do not handle erasing posts here
-	if ($mode == 'delete')
-	{
-		return;
-	}
-
-	$current_time = $_CLASS['core_user']-&gt;time;
-
-	if ($mode == 'post')
-	{
-		$post_mode = 'post';
-		$update_message = true;
-	}
-	else if ($mode != 'edit')
-	{
-		$post_mode = 'reply';
-		$update_message = true;
-	}
-	else if ($mode == 'edit')
-	{
-		$post_mode = ($data['topic_first_post_id'] == $data['topic_last_post_id']) ? 'edit_topic' : (($data['topic_first_post_id'] == $data['post_id']) ? 'edit_first_post' : (($data['topic_last_post_id'] == $data['post_id']) ? 'edit_last_post' : 'edit'));
-	}
-
-
-	// Collect some basic informations about which tables and which rows to update/insert
-	$sql_data = array();
-	$poster_id = ($mode == 'edit') ? $data['poster_id'] : (int) $_CLASS['core_user']-&gt;data['user_id'];
-
-	// Collect Informations
-	switch ($post_mode)
-	{
-		case 'post':
-		case 'reply':
-			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
-				'forum_id' 			=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
-				'poster_id' 		=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
-				'icon_id'			=&gt; $data['icon_id'],
-				'poster_ip' 		=&gt; $_CLASS['core_user']-&gt;ip,
-				'post_time'			=&gt; $current_time,
-				'post_approved' 	=&gt; ($_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_approve')) ? 0 : 1,
-				'enable_bbcode' 	=&gt; $data['enable_bbcode'],
-				'enable_html' 		=&gt; $data['enable_html'],
-				'enable_smilies' 	=&gt; $data['enable_smilies'],
-				'enable_magic_url' 	=&gt; $data['enable_urls'],
-				'enable_sig' 		=&gt; $data['enable_sig'],
-				'post_username'		=&gt; (!$_CLASS['core_user']-&gt;is_user) ? $username : '',
-				'post_subject'		=&gt; $subject,
-				'post_text' 		=&gt; $data['message'],
-				'post_checksum'		=&gt; $data['message_md5'],
-				'post_attachment'	=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0,
-				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
-				'bbcode_uid'		=&gt; $data['bbcode_uid'],
-				'post_edit_locked'	=&gt; $data['post_edit_locked']
-			);
-			break;
-
-		case 'edit_first_post':
-		case 'edit':
-			if (!$_CLASS['auth']-&gt;acl_gets('m_', 'a_') || $data['post_edit_reason'])
-			{
-				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
-					'post_edit_time'	=&gt; $current_time
-				);
-
-				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
-			}
-
-		case 'edit_last_post':
-		case 'edit_topic':
-
-			if (($post_mode == 'edit_last_post' || $post_mode == 'edit_topic') &amp;&amp; $data['post_edit_reason'])
-			{
-				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
-					'post_edit_time'	=&gt; $current_time
-				);
-
-				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
-			}
-
-			if (!isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
-			{
-				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array();
-			}
-
-			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
-				'forum_id' 			=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
-				'poster_id' 		=&gt; $data['poster_id'],
-				'icon_id'			=&gt; $data['icon_id'],
-				'post_approved' 	=&gt; ($_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_approve')) ? 0 : 1,
-				'enable_bbcode' 	=&gt; $data['enable_bbcode'],
-				'enable_html' 		=&gt; $data['enable_html'],
-				'enable_smilies' 	=&gt; $data['enable_smilies'],
-				'enable_magic_url' 	=&gt; $data['enable_urls'],
-				'enable_sig' 		=&gt; $data['enable_sig'],
-				'post_username'		=&gt; ($username &amp;&amp; $data['poster_id'] == ANONYMOUS) ? $username : '',
-				'post_subject'		=&gt; $subject,
-				'post_edit_reason'	=&gt; $data['post_edit_reason'],
-				'post_edit_user'	=&gt; (int) $data['post_edit_user'],
-				'post_checksum'		=&gt; $data['message_md5'],
-				'post_attachment'	=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0,
-				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
-				'bbcode_uid'		=&gt; $data['bbcode_uid'],
-				'post_edit_locked'	=&gt; $data['post_edit_locked'])
-			);
-
-			if ($update_message)
-			{
-				$sql_data[FORUMS_POSTS_TABLE]['sql']['post_text'] = $data['message'];
-			}
-
-			break;
-	}
-
-	// And the topic ladies and gentlemen
-	switch ($post_mode)
-	{
-		case 'post':
-			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
-				'topic_poster'			=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
-				'topic_time'			=&gt; $current_time,
-				'forum_id' 				=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
-				'icon_id'				=&gt; $data['icon_id'],
-				'topic_approved'		=&gt; ($_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_approve')) ? 0 : 1,
-				'topic_title' 			=&gt; $subject,
-				'topic_first_poster_name' =&gt; (!$_CLASS['core_user']-&gt;is_user &amp;&amp; $username) ? $username : $_CLASS['core_user']-&gt;data['username'],
-				'topic_type'			=&gt; $topic_type,
-				'topic_time_limit'		=&gt; ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
-				'topic_status'			=&gt; $data['topic_status'],
-				'topic_attachment'		=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0,
-				'topic_replies_real'	=&gt; 0,
-				'topic_replies'			=&gt; 0,
-				'topic_views'			=&gt; 0,
-				'topic_moved_id'		=&gt; 0
-			);
-
-			if (isset($poll['poll_options']) &amp;&amp; !empty($poll['poll_options']))
-			{
-				$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array_merge($sql_data[TOPICS_TABLE]['sql'], array(
-					'poll_title'		=&gt; $poll['poll_title'],
-					'poll_start'		=&gt; ($poll['poll_start']) ? $poll['poll_start'] : $current_time,
-					'poll_max_options'	=&gt; $poll['poll_max_options'],
-					'poll_length'		=&gt; ($poll['poll_length'] * 86400),
-					'poll_vote_change'	=&gt; $poll['poll_vote_change'])
-				);
-			}
-
-			$sql_data[CORE_USERS_TABLE]['stat'][] = &quot;user_last_post_time = $current_time&quot; . (($_CLASS['auth']-&gt;acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
-
-			if ($topic_type != POST_GLOBAL)
-			{
-				if (!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve'))
-				{
-					$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
-				}
-				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . ((!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) ? ', forum_topics = forum_topics + 1' : '');
-			}
-		break;
-
-		case 'reply':
-			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = 'topic_replies_real = topic_replies_real + 1, topic_bumped = 0, topic_bumper = 0' . ((!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) ? ', topic_replies = topic_replies + 1' : '');
-			$sql_data[CORE_USERS_TABLE]['stat'][] = &quot;user_last_post_time = $current_time&quot; . (($_CLASS['auth']-&gt;acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
-			
-			if ((!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) &amp;&amp; $topic_type != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
-			}
-		break;
-
-		case 'edit_topic':
-		case 'edit_first_post':
-
-			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
-				'forum_id' 					=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
-				'icon_id'					=&gt; $data['icon_id'],
-				'topic_approved'			=&gt; ($_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_approve')) ? 0 : 1,
-				'topic_title' 				=&gt; $subject,
-				'topic_first_poster_name'	=&gt; $username,
-				'topic_type'				=&gt; $topic_type,
-				'topic_time_limit'			=&gt; ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
-				'poll_title'				=&gt; isset($poll['poll_options']) ? $poll['poll_title'] : '',
-				'poll_start'				=&gt; isset($poll['poll_options']) ? (($poll['poll_start']) ? $poll['poll_start'] : $current_time) : 0,
-				'poll_max_options'			=&gt; isset($poll['poll_options']) ? $poll['poll_max_options'] : 1,
-				'poll_length'				=&gt; isset($poll['poll_options']) ? ($poll['poll_length'] * 86400) : 0,
-				'poll_vote_change'			=&gt; isset($poll['poll_vote_change']) ? $poll['poll_vote_change'] : 0,
-				'topic_attachment'			=&gt; ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0) : (int) $data['topic_attachment']
-			);
-		break;
-	}
-
-	$_CLASS['core_db']-&gt;transaction();
-
-	// Submit new topic
-	if ($post_mode == 'post')
-	{
-		$sql = 'INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' .
-			$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[FORUMS_TOPICS_TABLE]['sql']);
-		$_CLASS['core_db']-&gt;query($sql);
-
-		$data['topic_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_TOPICS_TABLE, 'topic_id');
-
-		$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
-			'topic_id' =&gt; $data['topic_id'])
-		);
-		unset($sql_data[FORUMS_TOPICS_TABLE]['sql']);
-	}
-
-	// Submit new post
-	if ($post_mode == 'post' || $post_mode == 'reply')
-	{
-		if ($post_mode == 'reply')
-		{
-			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
-				'topic_id' =&gt; $data['topic_id'])
-			);
-		}
-
-		$sql = 'INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .
-			$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']);
-		$_CLASS['core_db']-&gt;query($sql);
-		$data['post_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_POSTS_TABLE, 'post_id');
-
-		if ($post_mode == 'post')
-		{
-			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
-				'topic_first_post_id'	=&gt; $data['post_id'],
-				'topic_last_post_id'	=&gt; $data['post_id'],
-				'topic_last_post_time'	=&gt; $current_time,
-				'topic_last_poster_id'	=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
-				'topic_last_poster_name'=&gt; (!$_CLASS['core_user']-&gt;is_user &amp;&amp; $username) ? $username : $_CLASS['core_user']-&gt;data['username']
-			);
-		}
-
-		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
-	}
-
-	$make_global = false;
-
-	// Are we globalising or unglobalising?
-	if ($post_mode == 'edit_first_post' || $post_mode == 'edit_topic')
-	{
-		$sql = 'SELECT topic_type, topic_replies_real, topic_approved
-			FROM ' . FORUMS_TOPICS_TABLE . '
-			WHERE topic_id = ' . $data['topic_id'];
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-		
-		// globalise
-		if ($row['topic_type'] != POST_GLOBAL &amp;&amp; $topic_type == POST_GLOBAL)
-		{
-			// Decrement topic/post count
-			$make_global = true;
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
-
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts - ' . ($row['topic_replies_real'] + 1);
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real - 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics - 1' : '');
-
-			// Update forum_ids for all posts
-			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-				SET forum_id = 0
-				WHERE topic_id = ' . $data['topic_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-		// unglobalise
-		else if ($row['topic_type'] == POST_GLOBAL &amp;&amp; $topic_type != POST_GLOBAL)
-		{
-			// Increment topic/post count
-			$make_global = true;
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
-
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + ' . ($row['topic_replies_real'] + 1);
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics + 1' : '');
-
-			// Update forum_ids for all posts
-			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-				SET forum_id = ' . $data['forum_id'] . '
-				WHERE topic_id = ' . $data['topic_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-	}
-
-	// Update the topics table
-	if (isset($sql_data[FORUMS_TOPICS_TABLE]['sql']))
-	{
-		$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . '
-			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data[FORUMS_TOPICS_TABLE]['sql']) . '
-			WHERE topic_id = ' . $data['topic_id']);
-	}
-
-	// Update the posts table
-	if (isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
-	{
-		$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . '
-			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data[FORUMS_POSTS_TABLE]['sql']) . '
-			WHERE post_id = ' . $data['post_id']);
-	}
-
-	// Update Poll Tables
-	if (isset($poll['poll_options']) &amp;&amp; !empty($poll['poll_options']))
-	{
-		$cur_poll_options = array();
-
-		if ($poll['poll_start'] &amp;&amp; $mode == 'edit')
-		{
-			$sql = 'SELECT * FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
-				WHERE topic_id = ' . $data['topic_id'] . '
-				ORDER BY poll_option_id';
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			while ($cur_poll_options[] = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-			$_CLASS['core_db']-&gt;free_result($result);
-		}
-		
-		$size = count($poll['poll_options']);
-
-		for ($i = 0, $size; $i &lt; $size; $i++)
-		{
-			if (trim($poll['poll_options'][$i]))
-			{
-				if (!$cur_poll_options[$i])
-				{
-					$sql = 'INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . &quot;  (poll_option_id, topic_id, poll_option_text)
-						VALUES ($i, &quot; . $data['topic_id'] . &quot;, '&quot; . $_CLASS['core_db']-&gt;escape($poll['poll_options'][$i]) . &quot;')&quot;;
-					$_CLASS['core_db']-&gt;query($sql);
-				}
-				else if ($poll['poll_options'][$i] != $cur_poll_options[$i])
-				{
-					$sql = &quot;UPDATE &quot; . FORUMS_POLL_OPTIONS_TABLE . &quot;
-						SET poll_option_text = '&quot; . $_CLASS['core_db']-&gt;escape($poll['poll_options'][$i]) . &quot;'
-						WHERE poll_option_id = &quot; . $cur_poll_options[$i]['poll_option_id'] . &quot;
-							AND topic_id = &quot; . $data['topic_id'];
-					$_CLASS['core_db']-&gt;query($sql);
-				}
-			}
-		}
-
-		if (count($poll['poll_options']) &lt; count($cur_poll_options))
-		{
-			$sql = 'DELETE FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
-				WHERE poll_option_id &gt;= ' . count($poll['poll_options']) . '
-					AND topic_id = ' . $data['topic_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-	}
-
-	// Submit Attachments
-	if (!empty($data['attachment_data']) &amp;&amp; $data['post_id'] &amp;&amp; in_array($mode, array('post', 'reply', 'quote', 'edit')))
-	{
-		$space_taken = $files_added = 0;
-
-		foreach ($data['attachment_data'] as $pos =&gt; $attach_row)
-		{
-			if ($attach_row['attach_id'])
-			{
-				// update entry in db if attachment already stored in db and filespace
-				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . &quot;
-					SET comment = '&quot; . $_CLASS['core_db']-&gt;escape($attach_row['comment']) . &quot;'
-					WHERE attach_id = &quot; . (int) $attach_row['attach_id'];
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-			else
-			{
-				// insert attachment into db
-				if (!@file_exists($config['upload_path'] . '/' . basename($attach_row['physical_filename'])))
-				{
-					continue;
-				}
-				
-				$attach_sql = array(
-					'post_msg_id'		=&gt; $data['post_id'],
-					'topic_id'			=&gt; $data['topic_id'],
-					'in_message'		=&gt; 0,
-					'poster_id'			=&gt; $poster_id,
-					'physical_filename'	=&gt; basename($attach_row['physical_filename']),
-					'real_filename'		=&gt; basename($attach_row['real_filename']),
-					'download_count'	=&gt; 0,
-					'comment'			=&gt; $attach_row['comment'],
-					'extension'			=&gt; $attach_row['extension'],
-					'mimetype'			=&gt; $attach_row['mimetype'],
-					'filesize'			=&gt; $attach_row['filesize'],
-					'filetime'			=&gt; $attach_row['filetime'],
-					'thumbnail'			=&gt; $attach_row['thumbnail']
-				);
-
-				$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql));
-
-				$space_taken += $attach_row['filesize'];
-				$files_added++;
-			}
-		}
-
-		if (!empty($data['attachment_data']))
-		{
-			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-				SET post_attachment = 1
-				WHERE post_id = ' . $data['post_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
-				SET topic_attachment = 1
-				WHERE topic_id = ' . $data['topic_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-
-		set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
-		set_config('num_files', $config['num_files'] + $files_added, true);
-	}
-
-	$_CLASS['core_db']-&gt;transaction('commit');
-
-	if ($post_mode == 'post' || $post_mode == 'reply' || $post_mode == 'edit_last_post')
-	{
-		if ($topic_type != POST_GLOBAL)
-		{
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
-		}
-
-		$update = update_last_post_information('topic', $data['topic_id']);
-
-		if (!empty($update))
-		{
-			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
-		}
-	}
-
-	if ($make_global)
-	{
-		$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
-	}
-
-	if ($post_mode == 'edit_topic')
-	{
-		$update = update_last_post_information('topic', $data['topic_id']);
-
-		if (!empty($update))
-		{
-			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
-		}
-	}
-
-	// Update total post count, do not consider moderated posts/topics
-	if (!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve'))
-	{
-		if ($post_mode == 'post')
-		{
-			set_config('num_topics', $config['num_topics'] + 1, true);
-			set_config('num_posts', $config['num_posts'] + 1, true);
-		}
-
-		if ($post_mode == 'reply')
-		{
-			set_config('num_posts', $config['num_posts'] + 1, true);
-		}
-	}
-
-	// Update forum stats
-	$_CLASS['core_db']-&gt;transaction();
-
-	$where_sql = array(FORUMS_POSTS_TABLE =&gt; 'post_id = ' . $data['post_id'], FORUMS_TOPICS_TABLE =&gt; 'topic_id = ' . $data['topic_id'], FORUMS_FORUMS_TABLE =&gt; 'forum_id = ' . $data['forum_id'], CORE_USERS_TABLE =&gt; 'user_id = ' . $_CLASS['core_user']-&gt;data['user_id']);
-
-	foreach ($sql_data as $table =&gt; $update_ary)
-	{
-		if (isset($update_ary['stat']) &amp;&amp; implode('', $update_ary['stat']))
-		{
-			$_CLASS['core_db']-&gt;query(&quot;UPDATE $table SET &quot; . implode(', ', $update_ary['stat']) . ' WHERE ' . $where_sql[$table]);
-		}
-	}
-
-	// Delete topic shadows (if any exist). We do not need a shadow topic for an global announcement
-	if ($make_global)
-	{
-		$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_TOPICS_TABLE . '
-			WHERE topic_moved_id = ' . $data['topic_id']);
-	}
-
-	// Fulltext parse
-	if ($update_message &amp;&amp; $data['enable_indexing'])
-	{
-		$search = new fulltext_search();
-		$result = $search-&gt;add($mode, $data['post_id'], $data['message'], $subject);
-	}
-
-	$_CLASS['core_db']-&gt;transaction('commit');
-
-	// Delete draft if post was loaded...
-	$draft_id = request_var('draft_loaded', 0);
-	if ($draft_id)
-	{
-		$_CLASS['core_db']-&gt;query('DELETE FROM ' . DRAFTS_TABLE . &quot; WHERE draft_id = $draft_id AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id']);
-	}
-
-	// Topic Notification
-	if (!$data['notify_set'] &amp;&amp; $data['notify'])
-	{
-		$notify_sql = array(
-			'user_id'		=&gt; $_CLASS['core_user']-&gt;data['user_id'],
-			'forum_id'		=&gt; $data['forum_id'],
-			'topic_id'		=&gt; $data['topic_id'],
-			'notify_type'	=&gt; $poster_id,
-			'notify_status'	=&gt; 0,
-		);
-				
-		$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $notify_sql));
-
-		unset($notify_sql);
-	}
-	else if ($data['notify_set'] &amp;&amp; !$data['notify'])
-	{
-		$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
-			WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
-				AND topic_id = ' . $data['topic_id'];
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Mark this topic as read and posted to.
-	//markread('topic', $data['forum_id'], $data['topic_id'], $data['post_time']);
-
-	// Send Notifications
-	if ($mode != 'edit' &amp;&amp; $mode != 'delete' &amp;&amp; (!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')))
-	{
-		user_notification($mode, $subject, $data['topic_title'], $data['forum_name'], $data['forum_id'], $data['topic_id'], $data['post_id']);
-	}
-
-	if ($mode == 'post')
-	{
-		$url = (!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) ? generate_link('Forums&amp;file=viewtopic&amp;f=' . $data['forum_id'] . '&amp;t=' . $data['topic_id']) : generate_link('Forums&amp;file=viewforum&amp;f=' . $data['forum_id']);
-	}
-	else
-	{
-		$url = (!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) ?  generate_link(&quot;Forums&amp;file=viewtopic&amp;f={$data['forum_id']}&amp;t={$data['topic_id']}&amp;p={$data['post_id']}#{$data['post_id']}&quot;) : generate_link(&quot;Forums&amp;file=viewtopic&amp;f={$data['forum_id']}&amp;t={$data['topic_id']}&quot;);
-	}
-
-	$_CLASS['core_display']-&gt;meta_refresh(3, $url);
-
-	$message = ($_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_approve')) ? (($mode == 'edit') ? 'POST_EDITED_MOD' : 'POST_STORED_MOD') : (($mode == 'edit') ? 'POST_EDITED' : 'POST_STORED');
-	$message = $_CLASS['core_user']-&gt;lang[$message] . ((!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) ? '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['VIEW_MESSAGE'], '&lt;a href=&quot;' . $url . '&quot;&gt;', '&lt;/a&gt;') : '') . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;'.generate_link('Forums&amp;file=viewforum&amp;f=' . $data['forum_id']) . '&quot;&gt;', '&lt;/a&gt;');
-	trigger_error($message);
-}
-
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/forums/viewforum.php
===================================================================
--- cms/trunk/modules/forums/viewforum.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/forums/viewforum.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -111,7 +111,7 @@
 }
 
 // Check if links are checked for permission
-if (!$_CLASS['auth']-&gt;acl_get('f_read', $forum_id))
+if (!$_CLASS['forums_auth']-&gt;acl_get('f_read', $forum_id))
 {
 	if ($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS)
 	{
@@ -146,8 +146,6 @@
 // Add Images
 $_CLASS['core_user']-&gt;add_img();
 
-
-
 // Build navigation links
 generate_forum_nav($forum_data);
 
@@ -155,15 +153,16 @@
 generate_forum_rules($forum_data);
 
 // Do we have subforums?
-$active_forum_ary = array();
+$active_forum_ary = $moderators = array();
 
 if ($forum_data['left_id'] != $forum_data['right_id'] - 1)
 {
-	$active_forum_ary = display_forums($forum_data);
+	list($active_forum_ary, $moderators) = display_forums($forum_data, $config['load_moderators'], $config['load_moderators']);
 }
 else
 {
 	$_CLASS['core_template']-&gt;assign('S_HAS_SUBFORUM', false);
+	$moderators = get_moderators($forum_id);
 }
 
 // Not postable forum or showing active topics?
@@ -183,8 +182,6 @@
 	$_CLASS['core_template']-&gt;display('modules/forums/viewforum_body.html');
 }
 
-$moderators = get_moderators($forum_id);
-
 // Handle marking posts
 if ($mark_read == 'topics')
 {
@@ -222,7 +219,7 @@
 
 */
 
-if ($_CLASS['auth']-&gt;acl_get('f_subscribe', $forum_id))
+if ($_CLASS['forums_auth']-&gt;acl_get('f_subscribe', $forum_id))
 {
 	$notify_status = isset($forum_data['notify_status']) ? $forum_data['notify_status'] : null;
 	$s_watching_forum = watch_topic_forum('forum', $_CLASS['core_user']-&gt;data['user_id'], $forum_id, 0, $notify_status);
@@ -255,7 +252,7 @@
 		WHERE forum_id = $forum_id
 			AND topic_type NOT IN (&quot; . POST_ANNOUNCE . ', ' . POST_GLOBAL . &quot;)
 			AND topic_last_post_time &gt;= $min_post_time
-		&quot; . (($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? '' : 'AND topic_approved = 1');
+		&quot; . (($_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? '' : 'AND topic_approved = 1');
 	$result = $_CLASS['core_db']-&gt;query($sql);
 	$topics_count = ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? (int) $row['num_topics'] : 0;
 	$_CLASS['core_db']-&gt;free_result($result);
@@ -269,7 +266,7 @@
 }
 else
 {
-	if ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id))
+	if ($_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id))
 	{
 		$topics_count = ($forum_data['forum_topics_real']) ? $forum_data['forum_topics_real'] : 1;
 	}
@@ -296,8 +293,8 @@
 
 	'POST_IMG' 			=&gt; ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']-&gt;img('btn_locked', $post_alt) : $_CLASS['core_user']-&gt;img('btn_post', $post_alt),
 
-	'MOD_TOPIC_LOCK'	=&gt;	$_CLASS['auth']-&gt;acl_get('m_lock', $forum_id),
-	'MOD_TOPIC_TITLE'	=&gt;	$_CLASS['auth']-&gt;acl_get('m_', $forum_id),
+	'MOD_TOPIC_LOCK'	=&gt;	$_CLASS['forums_auth']-&gt;acl_get('m_lock', $forum_id),
+	'MOD_TOPIC_TITLE'	=&gt;	$_CLASS['forums_auth']-&gt;acl_get('m_', $forum_id),
 
 	'FORUM_IMG'			=&gt;	$_CLASS['core_user']-&gt;img('forum', 'NO_NEW_POSTS'),
 	'FORUM_NEW_IMG'		=&gt;	$_CLASS['core_user']-&gt;img('forum_new', 'NEW_POSTS'),
@@ -330,10 +327,10 @@
 	'S_WATCH_FORUM_LINK'	=&gt; $s_watching_forum['link'],
 	'S_WATCH_FORUM_TITLE'	=&gt; $s_watching_forum['title'],
 	'S_FORUM_ACTION' 		=&gt; generate_link(&quot;forums&amp;file=viewforum&amp;f=$forum_id&amp;start=$start&quot;),
-	'S_DISPLAY_SEARCHBOX'	=&gt; ($_CLASS['auth']-&gt;acl_get('f_search', $forum_id)) ? true : false, 
+	'S_DISPLAY_SEARCHBOX'	=&gt; ($_CLASS['forums_auth']-&gt;acl_get('f_search', $forum_id)) ? true : false, 
 	'S_SEARCHBOX_ACTION'	=&gt; generate_link('forums&amp;file=search&amp;search_forum[]='.$forum_id), 
 
-	'U_MCP' 			=&gt; ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? generate_link(&quot;forums&amp;file=mcp&amp;f=$forum_id&amp;mode=forum_view&quot;) : '', 
+	'U_MCP' 			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('m_', $forum_id)) ? generate_link(&quot;forums&amp;file=mcp&amp;f=$forum_id&amp;mode=forum_view&quot;) : '', 
 	'U_POST_NEW_TOPIC'	=&gt; generate_link('forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id), 
 	'U_VIEW_FORUM'		=&gt; generate_link(&quot;forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param&amp;start=$start&quot;), 
 	'U_MARK_TOPICS' 	=&gt; generate_link(&quot;forums&amp;file=viewforum&amp;f=$forum_id&amp;mark=topics&quot;))
@@ -343,7 +340,7 @@
 $icons = obtain_icons();
 
 // Grab all topic data
-$rowset = $announcement_list = $topic_list = array();
+$rowset = $announcement_list = $topic_list = $global_announce_list = array();
 
 $sql_from = FORUMS_TOPICS_TABLE.' t ';
 $sql_select = '';
@@ -354,7 +351,7 @@
 	$sql_select .= ', tt.mark_time';
 }
 
-$sql_approved = $_CLASS['auth']-&gt;acl_get('m_approve', $forum_id) ? '' : 'AND t.topic_approved = 1';
+$sql_approved = $_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id) ? '' : 'AND t.topic_approved = 1';
 
 if ($forum_data['forum_type'] == FORUM_POST)
 {
@@ -370,6 +367,11 @@
 	{
 		$rowset[$row['topic_id']] = $row;
 		$announcement_list[] = $row['topic_id'];
+
+		if ($row['topic_type'] == POST_GLOBAL)
+		{
+			$global_announce_list[$row['topic_id']] = true;
+		}
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 }
@@ -410,13 +412,43 @@
 	ORDER BY t.topic_type &quot; . ((!$store_reverse) ? 'DESC' : 'ASC') . ', ' . $sql_sort_order;
 $result = $_CLASS['core_db']-&gt;query_limit($sql, $sql_limit, $sql_start);
 
+$shadow_topic_list = array();
 while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 {
 	$rowset[$row['topic_id']] = $row;
 	$topic_list[] = $row['topic_id'];
+	
+	if ($row['topic_status'] == ITEM_MOVED)
+	{
+		$shadow_topic_list[$row['topic_moved_id']] = $row['topic_id'];
+	}
 }
 $_CLASS['core_db']-&gt;free_result($result);
 
+// If we have some shadow topics, update the rowset to reflect their topic informations
+if (!empty($shadow_topic_list))
+{
+	$sql = 'SELECT *
+		FROM ' . FORUMS_TOPICS_TABLE . '
+		WHERE topic_id IN (' . implode(', ', array_keys($shadow_topic_list)) . ')';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$orig_topic_id = $shadow_topic_list[$row['topic_id']];
+
+		// We want to retain some values
+		$row = array_merge($row, array(
+			'topic_moved_id'	=&gt; $rowset[$orig_topic_id]['topic_moved_id'],
+			'topic_status'		=&gt; $rowset[$orig_topic_id]['topic_status'])
+		);
+
+		$rowset[$orig_topic_id] = $row;
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+}
+unset($shadow_topic_list);
+
 $topic_list = ($store_reverse) ? array_merge($announcement_list, array_reverse($topic_list)) : array_merge($announcement_list, $topic_list);
 unset($announcement_list);
 
@@ -478,24 +510,25 @@
 		$s_type_switch_test = ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL) ? 1 : 0;
 
 		// Replies
-		$replies = ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? (int) $row['topic_replies_real'] : (int) $row['topic_replies'];
+		$replies = ($_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? (int) $row['topic_replies_real'] : (int) $row['topic_replies'];
 
 		if ($row['topic_status'] == ITEM_MOVED)
 		{
 // currently no marking supported
 			$topic_id = $row['topic_moved_id'];
+			$mark_time = $_CLASS['core_user']-&gt;time;
 		}
 
 		// Get folder img, topic status/type related informations
 		$folder_img = $folder_alt = $topic_type = '';
-	//	$status = topic_status($row, $replies, $mark_time, $unread_topic, $folder_img, $folder_alt, $topic_type);
 		topic_status($row, $replies, $mark_time, $unread_topic, $folder_img, $folder_alt, $topic_type);
 
+		$topic_unapproved = (!$row['topic_approved'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? true : false;
+		$posts_unapproved = ($row['topic_approved'] &amp;&amp; $row['topic_replies'] &lt; $row['topic_replies_real'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? true : false;
+
 		$newest_post_img = ($unread_topic) ? '&lt;a href=&quot;' . generate_link(&quot;forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread#unread&quot;) . '&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_newest', 'VIEW_NEWEST_POST') . '&lt;/a&gt; ' : '';
 
-		// Generate all the URIs ...
 		$view_topic_url = 'forums&amp;file=viewtopic&amp;t='.$topic_id;
-
 		$pagination = generate_pagination('forums&amp;file=viewtopic&amp;&amp;t='.$topic_id, $replies, $config['posts_per_page']);
 
 		// Send vars to template
@@ -509,7 +542,7 @@
 			'FIRST_POST_TIME' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
 			'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
 			'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),
-			'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
+			'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
 
 			'PAGINATION'		=&gt; $pagination['formated'],
 			'PAGINATION_ARRAY'	=&gt; $pagination['array'],
@@ -523,28 +556,37 @@
 
 			'LAST_POST_IMG' 	=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'),
 			'NEWEST_POST_IMG' 	=&gt; $newest_post_img,
+
 			'TOPIC_FOLDER_IMG' 	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
 			//'TOPIC_FOLDER_IMG_SRC'	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt, false, '', 'src'),
-
 			'TOPIC_ICON_IMG'        =&gt; empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['img'],
 			'TOPIC_ICON_IMG_WIDTH'  =&gt; empty($icons[$row['icon_id']]) ? '' :  $icons[$row['icon_id']]['width'],
 			'TOPIC_ICON_IMG_HEIGHT' =&gt; empty($icons[$row['icon_id']]) ? '' :  $icons[$row['icon_id']]['height'],
-	
-			'ATTACH_ICON_IMG'       =&gt; ($row['topic_attachment'] &amp;&amp; $_CLASS['auth']-&gt;acl_gets(array('f_download', 'u_download'), $forum_id)) ? $_CLASS['core_user']-&gt;img('icon_attach', $_CLASS['core_user']-&gt;lang['TOTAL_ATTACHMENTS']) : '',
+			'ATTACH_ICON_IMG'       =&gt; ($row['topic_attachment'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_gets(array('f_download', 'u_download'), $forum_id)) ? $_CLASS['core_user']-&gt;img('icon_attach', $_CLASS['core_user']-&gt;lang['TOTAL_ATTACHMENTS']) : '',
+			'UNAPPROVED_IMG'		=&gt; ($topic_unapproved || $posts_unapproved) ? $_CLASS['core_user']-&gt;img('icon_unapproved', ($topic_unapproved) ? 'TOPIC_UNAPPROVED' : 'POSTS_UNAPPROVED') : '',
 
+			'S_TOPIC_UNAPPROVED'	=&gt; $topic_unapproved,
+			'S_POSTS_UNAPPROVED'	=&gt; $posts_unapproved,
+			'S_HAS_POLL'			=&gt; ($row['poll_start']),
+			'S_POST_ANNOUNCE'		=&gt; ($row['topic_type'] == POST_ANNOUNCE),
+			'S_POST_GLOBAL'			=&gt; ($row['topic_type'] == POST_GLOBAL),
+			'S_POST_STICKY'			=&gt; ($row['topic_type'] == POST_STICKY),
+			'S_TOPIC_LOCKED'		=&gt; ($row['topic_status'] == ITEM_LOCKED),
+			'S_TOPIC_MOVED'			=&gt; ($row['topic_status'] == ITEM_MOVED),
+			
 			'S_TOPIC_TYPE'			=&gt; $row['topic_type'], 
 			'S_UNREAD_TOPIC'		=&gt; $unread_topic,
+			'S_TOPIC_REPORTED'		=&gt; ($row['topic_reported'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_report', $forum_id)),
+			'S_TOPIC_UNAPPROVED'	=&gt; (!$row['topic_approved'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)),
 
-			'S_TOPIC_REPORTED'		=&gt; ($row['topic_reported'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_report', $forum_id)),
-			'S_TOPIC_UNAPPROVED'	=&gt; (!$row['topic_approved'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)),
+			'U_NEWEST_POST'			=&gt; generate_link($view_topic_url . '&amp;view=unread#unread'),
+			'U_LAST_POST'			=&gt; generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),	
+			'U_LAST_POST_AUTHOR'	=&gt; ($row['topic_last_poster_id']&amp;&amp; $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+			'U_VIEW_TOPIC'			=&gt; generate_link($view_topic_url),
 
-			'U_LAST_POST'       =&gt; generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),	
-			'U_LAST_POST_AUTHOR'=&gt; ($row['topic_last_poster_id']) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
-			'U_VIEW_TOPIC'		=&gt; generate_link($view_topic_url),
+			'U_MCP_REPORT'			=&gt; generate_link('forums&amp;file=mcp&amp;mode=reports&amp;t='.$topic_id),
+			'U_MCP_QUEUE'       	=&gt; generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;t='.$topic_id),
 
-			'U_MCP_REPORT'		=&gt; generate_link('forums&amp;file=mcp&amp;mode=reports&amp;t='.$topic_id),
-			'U_MCP_QUEUE'       =&gt; generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;t='.$topic_id),
-
 			'S_TOPIC_TYPE_SWITCH'=&gt; ($s_type_switch == $s_type_switch_test) ? -1 : $s_type_switch_test)
 		);
 

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/forums/viewtopic.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -162,13 +162,7 @@
 	}
 }
 
-$sql = 'SELECT t.topic_id, t.forum_id, t.topic_title, t.topic_attachment, t.topic_status, t.topic_approved,
-	t.topic_replies_real, t.topic_replies, t.topic_first_post_id, t.topic_last_post_id, t.topic_last_poster_id,
-	t.topic_last_post_time, t.topic_poster, t.topic_time, t.topic_time_limit, t.topic_type, t.topic_bumped, 
-	t.topic_bumper, t.poll_max_options, t.poll_start, t.poll_length, t.poll_title, t.poll_vote_change,
-	f.forum_name, f.forum_desc, f.forum_parents, f.parent_id, f.left_id, f.right_id, f.forum_status, f.forum_type,
-	f.forum_id, f.forum_password, f.forum_rules, f.forum_rules_link, f.forum_rules_flags, f.forum_rules_bbcode_uid,
-	f.forum_rules_bbcode_bitfield' . $extra_fields . '
+$sql = 'SELECT t.*, f.*' . $extra_fields . '
 		FROM ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . &quot; t  $join_sql_table 
 		WHERE t.topic_id = $topic_id
 		AND f.forum_id = $forum_id&quot;;
@@ -193,6 +187,13 @@
 	login_box(array('explain' =&gt; $_CLASS['core_user']-&gt;lang['LOGIN_VIEWFORUM']));
 }
 
+// Forum is passworded ... check whether access has been granted to this
+// user this session, if not show login box
+if ($topic_data['forum_password'])
+{
+	login_forum_box($topic_data);
+}
+
 // Are we watching this topic?
 if (!isset($topic_data['notify_status']))
 {
@@ -245,10 +246,7 @@
 // We make this check here because the correct forum_id is determined
 $topic_replies = ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? (int) $topic_data['topic_replies_real'] : (int) $topic_data['topic_replies'];
 
-if (!isset($topic_last_read))
-{
-	$topic_last_read = topic_last_read($topic_id, $forum_id);
-}
+$topic_last_read = topic_last_read($topic_id, $forum_id);
 
 // Check sticky/announcement time limit
 if (($topic_data['topic_type'] == POST_STICKY || $topic_data['topic_type'] == POST_ANNOUNCE) &amp;&amp; $topic_data['topic_time_limit'] &amp;&amp; $topic_data['topic_time'] + $topic_data['topic_time_limit'] &lt; $_CLASS['core_user']-&gt;time)
@@ -256,8 +254,8 @@
 	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' 
 		SET topic_type = ' . POST_NORMAL . ', topic_time_limit = 0
 		WHERE topic_id = ' . $topic_id;
+	$_CLASS['core_db']-&gt;query($sql);
 
-	$_CLASS['core_db']-&gt;query($sql);
 	$topic_data['topic_type'] = POST_NORMAL;
 	$topic_data['topic_time_limit'] = 0;
 }
@@ -266,19 +264,13 @@
 $_CLASS['core_user']-&gt;add_lang('viewtopic');
 $_CLASS['core_user']-&gt;add_img();
 
-// Forum is passworded ... check whether access has been granted to this
-// user this session, if not show login box
-if ($topic_data['forum_password'])
-{
-	login_forum_box($topic_data);
+
+// What is start equal to?
+if ($post_id)
+{
+	$start = floor(($topic_data['prev_posts'] - 1) / $config['posts_per_page']) * $config['posts_per_page'];
 }
 
-// What is start equal to?
-/*if (!empty($post_id))
-{
-	$start = floor(($prev_posts - 1) / $config['posts_per_page']) * $config['posts_per_page'];
-}*/
-
 // Post ordering options
 $limit_days = array(0 =&gt; $_CLASS['core_user']-&gt;lang['ALL_POSTS'], 1 =&gt; $_CLASS['core_user']-&gt;lang['1_DAY'], 7 =&gt; $_CLASS['core_user']-&gt;lang['7_DAYS'], 14 =&gt; $_CLASS['core_user']-&gt;lang['2_WEEKS'], 30 =&gt; $_CLASS['core_user']-&gt;lang['1_MONTH'], 90 =&gt; $_CLASS['core_user']-&gt;lang['3_MONTHS'], 180 =&gt; $_CLASS['core_user']-&gt;lang['6_MONTHS'], 364 =&gt; $_CLASS['core_user']-&gt;lang['1_YEAR']);
 
@@ -301,14 +293,15 @@
 		&quot; . (($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? '' : 'AND post_approved = 1');
 
 	$result = $_CLASS['core_db']-&gt;query($sql);
+	$total_posts = ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $row['num_posts'] : 0;
+	$_CLASS['core_db']-&gt;free_result($result);
 
+	$limit_posts_time = &quot;AND p.post_time &gt;= $min_post_time &quot;;
+
 	if (isset($_POST['sort']))
 	{
 		$start = 0;
 	}
-
-	$total_posts = ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $row['num_posts'] : 0;
-	$limit_posts_time = &quot;AND p.post_time &gt;= $min_post_time &quot;;
 }
 else
 {
@@ -332,6 +325,12 @@
 	$highlight = urlencode($hilit_words);
 }
 
+// Make sure $start is set to the last page if it exceeds the amount
+if ($start &lt; 0 || $start &gt; $total_posts)
+{
+	$start = ($start &lt; 0) ? 0 : floor(($total_posts - 1) / $config['posts_per_page']) * $config['posts_per_page'];
+}
+
 // General Viewtopic URL for return links
 $viewtopic_url = &quot;forums&amp;file=viewtopic&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param&quot; . (($highlight_match) ? &quot;&amp;hilit=$highlight&quot; : '');
 
@@ -350,15 +349,15 @@
 // Generate Forum Rules
 generate_forum_rules($topic_data);
 
-gen_forum_auth_level('topic', $forum_id);
+gen_forum_auth_level('topic', $forum_id, $topic_data['forum_status']);
 
 // Does this topic contain a poll?
-if (!empty($poll_start))
+if (!empty($topic_data['poll_start']))
 {
 	$sql = 'SELECT o.*, p.bbcode_bitfield, p.bbcode_uid
 		FROM ' . FORUMS_POLL_OPTIONS_TABLE . ' o, ' . FORUMS_POSTS_TABLE . &quot; p
 		WHERE o.topic_id = $topic_id 
-			AND p.post_id = $topic_first_post_id
+			AND p.post_id = {$topic_data['topic_first_post_id']}
 			AND p.topic_id = o.topic_id
 		ORDER BY o.poll_option_id&quot;;
 	$result = $_CLASS['core_db']-&gt;query($sql);
@@ -397,12 +396,12 @@
 	}
 
 	$s_can_vote = (((empty($cur_voted_id) &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_vote', $forum_id)) || 
-		($_CLASS['auth']-&gt;acl_get('f_votechg', $forum_id) &amp;&amp; $poll_vote_change)) &amp;&amp;
-		(($poll_length != 0 &amp;&amp; $poll_start + $poll_length &gt; time()) || $poll_length == 0) &amp;&amp;
+		($_CLASS['auth']-&gt;acl_get('f_votechg', $forum_id) &amp;&amp; $topic_data['poll_vote_change'])) &amp;&amp;
+		(($topic_data['poll_length'] != 0 &amp;&amp; $topic_data['poll_start'] + $topic_data['poll_length'] &gt; time()) || $topic_data['poll_length'] == 0) &amp;&amp;
 		$topic_data['topic_status'] != ITEM_LOCKED &amp;&amp; 
 		$topic_data['forum_status'] != ITEM_LOCKED) ? true : false;
 		
-		$s_display_results = (!$s_can_vote || ($s_can_vote &amp;&amp; !empty($cur_voted_id)) || $view == 'viewpoll') ? true : false;
+	$s_display_results = (!$s_can_vote || ($s_can_vote &amp;&amp; !empty($cur_voted_id)) || $view == 'viewpoll') ? true : false;
 		
 	if ($update &amp;&amp; $s_can_vote)
 	{
@@ -417,55 +416,61 @@
 
 		foreach ($voted_id as $option)
 		{
-			if (in_array($option, $cur_voted_id))
-			{
-				continue;
+			if (in_array($option, $cur_voted_id))
+			{
+				continue;
+			}
+
+			$sql = 'UPDATE ' . POLL_OPTIONS_TABLE . '
+				SET poll_option_total = poll_option_total + 1
+				WHERE poll_option_id = ' . (int) $option . '
+					AND topic_id = ' . (int) $topic_id;
+			$_CLASS['core_db']-&gt;query($sql);
+
+			if ($_CLASS['core_user']-&gt;is_user)
+			{
+				$sql_ary = array(
+					'topic_id'			=&gt; (int) $topic_id,
+					'poll_option_id'	=&gt; (int) $option,
+					'vote_user_id'		=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+					'vote_user_ip'		=&gt; (string) $_CLASS['core_user']-&gt;ip,
+				);
+
+				$sql = 'INSERT INTO  ' . POLL_VOTES_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', $sql_ary);
+				$_CLASS['core_db']-&gt;query($sql);
 			}
-
-			$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . &quot; 
-				SET poll_option_total = poll_option_total + 1 
-				WHERE poll_option_id = $option 
-					AND topic_id = $topic_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-
-			if ($_CLASS['core_user']-&gt;is_user)
-			{
-				$sql = 'INSERT INTO  ' . FORUMS_POLL_VOTES_TABLE . &quot; (topic_id, poll_option_id, vote_user_id, vote_user_ip) 
-					VALUES ($topic_id, $option, &quot; . $_CLASS['core_user']-&gt;data['user_id'] . &quot;, '&quot;.$_CLASS['core_user']-&gt;ip.&quot;')&quot;;
-				$_CLASS['core_db']-&gt;query($sql);
-			}
 		}
 
 		foreach ($cur_voted_id as $option)
 		{
 			if (!in_array($option, $voted_id))
 			{
-				$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . &quot; 
-					SET poll_option_total = poll_option_total - 1 
-					WHERE poll_option_id = $option 
-						AND topic_id = $topic_id&quot;;
+				$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . ' 
+					SET poll_option_total = poll_option_total - 1
+					WHERE poll_option_id = ' . (int) $option . '
+						AND topic_id = ' . (int) $topic_id;
 				$_CLASS['core_db']-&gt;query($sql);
 
 				if ($_CLASS['core_user']-&gt;is_user)
 				{
-					$sql = 'DELETE FROM ' . FORUMS_POLL_VOTES_TABLE . &quot; 
-						WHERE topic_id = $topic_id
-							AND poll_option_id = $option 
-							AND vote_user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
+					$sql = 'DELETE FROM ' . FORUMS_POLL_VOTES_TABLE . ' 
+						WHERE topic_id = ' . (int) $topic_id . '
+							AND poll_option_id = ' . (int) $option . '
+							AND vote_user_id = ' . (int) $_CLASS['core_user']-&gt;data['user_id'];
 					$_CLASS['core_db']-&gt;query($sql);
 				}
 			}
 		}
 
-		if ($_CLASS['core_user']-&gt;data['user_id'] == ANONYMOUS)
+		if ($_CLASS['core_user']-&gt;data['user_id'] == ANONYMOUS &amp;&amp; !$_CLASS['core_user']-&gt;is_bot)
 		{
-			$_CLASS['core_user']-&gt;set_cookie('poll_' . $topic_id, implode(',', $voted_id), time() + 31536000);
+			$_CLASS['core_user']-&gt;set_cookie('poll_' . $topic_id, implode(',', $voted_id), $_CLASS['core_user']-&gt;time + 31536000);
 		}
 
 		$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' 
-			SET poll_last_vote = ' . time() . &quot; 
-			WHERE topic_id = $topic_id&quot;;
-			//, topic_last_post_time = ' . time() . &quot; -- for bumping topics with new votes, ignore for now
+			SET poll_last_vote = ' . $_CLASS['core_user']-&gt;time . ' 
+			WHERE topic_id =' . (int)  $topic_id;
+			//, topic_last_post_time = ' . $_CLASS['core_user']-&gt;time . &quot; -- for bumping topics with new votes, ignore for now
 		$_CLASS['core_db']-&gt;query($sql);
 
 		$_CLASS['core_display']-&gt;meta_refresh(5, generate_link(&quot;forums&amp;file=viewtopic&amp;t=$topic_id&quot;));
@@ -484,22 +489,32 @@
 	{
 		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 		$poll_bbcode = new bbcode();
-		
-		$count = count($poll_info);
+	}
+	else
+	{
+		$poll_bbcode = false;
+	}
 
-		for ($i = 0; $i &lt; $count; $i++)
-		{
-			$poll_bbcode-&gt;bbcode_second_pass($poll_info[$i]['poll_option_text'], $poll_info[$i]['bbcode_uid'], $poll_option['bbcode_bitfield']);
-			$poll_info[$i]['poll_option_text'] = smiley_text($poll_info[$i]['poll_option_text']);
-			$poll_info[$i]['poll_option_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($poll_info[$i]['poll_option_text']));
+	$count = count($poll_info);
+
+	for ($i = 0; $i &lt; $count; $i++)
+	{
+		if ($poll_bbcode !== false)
+		{
+			$poll_bbcode-&gt;bbcode_second_pass($poll_info[$i]['poll_option_text'], $poll_info[$i]['bbcode_uid'], $poll_option['bbcode_bitfield']);
 		}
+		$poll_info[$i]['poll_option_text'] = smiley_text($poll_info[$i]['poll_option_text']);
+		$poll_info[$i]['poll_option_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($poll_info[$i]['poll_option_text']));
+	}
 
-		$poll_bbcode-&gt;bbcode_second_pass($poll_title, $poll_info[0]['bbcode_uid'], $poll_info[0]['bbcode_bitfield']);
-		$poll_title = smiley_text($poll_title);
-		$poll_title = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($poll_title));
+	if ($poll_bbcode !== false)
+	{
+		$poll_bbcode-&gt;bbcode_second_pass($topic_data['poll_title'], $poll_info[0]['bbcode_uid'], $poll_info[0]['bbcode_bitfield']);
+	}
+	$topic_data['poll_title'] = smiley_text($topic_data['poll_title']);
+	$topic_data['poll_title'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($topic_data['poll_title']));
 
-		unset($poll_bbcode);
-	}
+	unset($poll_bbcode);
 	
 	foreach ($poll_info as $poll_option)
 	{
@@ -518,18 +533,18 @@
 	}
 
 	$_CLASS['core_template']-&gt;assign_array(array(
-		'POLL_QUESTION'		=&gt; $poll_title,
+		'POLL_QUESTION'		=&gt; $topic_data['poll_title'],
 		'TOTAL_VOTES' 		=&gt; $poll_total,
 		'POLL_LEFT_CAP_IMG'	=&gt; $_CLASS['core_user']-&gt;img('poll_left'),
 		'POLL_RIGHT_CAP_IMG'=&gt; $_CLASS['core_user']-&gt;img('poll_right'),
 
-		'L_MAX_VOTES'		=&gt; ($poll_max_options == 1) ? $_CLASS['core_user']-&gt;lang['MAX_OPTION_SELECT'] : sprintf($_CLASS['core_user']-&gt;lang['MAX_OPTIONS_SELECT'], $poll_max_options), 
-		'L_POLL_LENGTH'		=&gt; ($poll_length) ? sprintf($_CLASS['core_user']-&gt;lang['POLL_RUN_TILL'], $_CLASS['core_user']-&gt;format_date($poll_length + $poll_start)) : '', 
+		'L_MAX_VOTES'		=&gt; ($topic_data['poll_max_options'] == 1) ? $_CLASS['core_user']-&gt;lang['MAX_OPTION_SELECT'] : sprintf($_CLASS['core_user']-&gt;lang['MAX_OPTIONS_SELECT'], $topic_data['poll_max_options']), 
+		'L_POLL_LENGTH'		=&gt; ($topic_data['poll_length']) ? sprintf($_CLASS['core_user']-&gt;lang['POLL_RUN_TILL'], $_CLASS['core_user']-&gt;format_date($topic_data['poll_length'] + $topic_data['poll_start'])) : '', 
 
 		'S_HAS_POLL'		=&gt; true, 
 		'S_CAN_VOTE'		=&gt; $s_can_vote, 
 		'S_DISPLAY_RESULTS'	=&gt; $s_display_results,
-		'S_IS_MULTI_CHOICE'	=&gt; ($poll_max_options &gt; 1) ? true : false, 
+		'S_IS_MULTI_CHOICE'	=&gt; ($topic_data['poll_max_options'] &gt; 1) ? true : false,
 		'S_POLL_ACTION'		=&gt; generate_link($viewtopic_url, false),
 
 		'U_VIEW_RESULTS'	=&gt; generate_link($viewtopic_url . '&amp;view=viewpoll', false))
@@ -543,7 +558,7 @@
 }
 
 // If the user is trying to reach the second half of the topic, fetch it starting from the end
-$store_reverse = FALSE;
+$store_reverse = false;
 $sql_limit = $config['posts_per_page'];
 
 if ($start &gt; $total_posts / 2)
@@ -567,7 +582,7 @@
 }
 
 // Container for user details, only process once
-$post_list = $user_cache = $id_cache = $attachments = $attach_list = $rowset = $update_count = $post_edit_list = array();
+$post_list = $user_cache = $id_cache = $attachments = $attach_list = $rowset = $update_count = $post_edit_list = array();
 $has_attachments = $display_notice = false;
 $bbcode_bitfield = $i = $i_total = 0;
 
@@ -596,7 +611,7 @@
 	trigger_error($_CLASS['core_user']-&gt;lang['NO_TOPIC']);
 }
 
-$sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_posts, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_jabber, u.user_reg_date, u.user_msnm, u.user_allow_viewemail, u.user_allow_viewonline, u.user_rank, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height, z.friend, z.foe, p.*
+$sql = 'SELECT u.*, z.friend, z.foe, p.*
 	FROM ' . FORUMS_POSTS_TABLE . ' p
 	LEFT JOIN ' . ZEBRA_TABLE . ' z ON (z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' AND z.zebra_id = p.poster_id), ' . CORE_USERS_TABLE . ' u
 	WHERE p.post_id IN (' . implode(', ', $post_list) . ')
@@ -604,6 +619,9 @@
 
 $result = $_CLASS['core_db']-&gt;query($sql);
 
+$today = explode('-', date('j-n-Y', $_CLASS['core_user']-&gt;time));
+$today = array('day' =&gt; (int) $today[0], 'month' =&gt; (int) $today[1], 'year' =&gt; (int) $today[2]);
+
 // Posts are stored in the $rowset array while $attach_list, $user_cache
 // and the global bbcode_bitfield are built
 while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
@@ -611,12 +629,13 @@
 	$poster_id = $row['poster_id'];
 	$poster	= ($poster_id == ANONYMOUS) ? ((!empty($row['post_username'])) ? $row['post_username'] : $_CLASS['core_user']-&gt;lang['GUEST']) : $row['username'];
 
-	if ($view != 'show_all' || ($view != 'show' || $post_id != $row['post_id']))
+	if ($view != 'show' || $post_id != $row['post_id'])
 	{
 		if ($row['foe'])
 		{
 			$rowset[$row['post_id']] = array(
-				'foe'		=&gt; true,
+				'foe'		=&gt; true,
+				'user_id'	=&gt; $row['user_id'],
 				'post_id'	=&gt; $row['post_id'],
 				'poster'	=&gt; $poster,
 			);
@@ -648,7 +667,9 @@
 		'post_edit_time'	=&gt; $row['post_edit_time'],
 		'post_edit_reason'	=&gt; $row['post_edit_reason'],
 		'post_edit_user'	=&gt; $row['post_edit_user'],
-		'icon_id'			=&gt; $row['icon_id'],
+		
+		// Make sure the icon actually exists
+		'icon_id'			=&gt; (isset($icons[$row['icon_id']]['img'], $icons[$row['icon_id']]['height'], $icons[$row['icon_id']]['width'])) ? $row['icon_id'] : 0,
 		'post_attachment'	=&gt; $row['post_attachment'],
 		'post_approved'		=&gt; $row['post_approved'],
 		'post_reported'		=&gt; $row['post_reported'],
@@ -662,12 +683,12 @@
 	);
 
 	// Define the global bbcode bitfield, will be used to load bbcodes
-	$bbcode_bitfield |= $row['bbcode_bitfield'];
+	$bbcode_bitfield = $bbcode_bitfield | $row['bbcode_bitfield'];
 
 	// Is a signature attached? Are we going to display it?
 	if ($row['enable_sig'] &amp;&amp; $config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('viewsigs'))
 	{
-		$bbcode_bitfield |= $row['user_sig_bbcode_bitfield'];
+		$bbcode_bitfield = $bbcode_bitfield | $row['user_sig_bbcode_bitfield'];
 	}
 
 	// Cache various user specific data ... so we don't have to recompute
@@ -688,6 +709,7 @@
 				'avatar'		=&gt; '',
 				'rank_title'	=&gt; '',
 				'rank_image'	=&gt; '',
+				'rank_image_src'	=&gt; '',
 				'sig'			=&gt; '',
 				'posts'			=&gt; '',
 				'profile'		=&gt; '',
@@ -701,7 +723,10 @@
 				'yim'			=&gt; '',
 				'jabber'		=&gt; '',
 				'search'		=&gt; '',
-				'username'		=&gt; ($row['user_colour']) ? '&lt;span style=&quot;color:#' . $row['user_colour'] . '&quot;&gt;' . $poster . '&lt;/span&gt;' : $poster
+				'username'		=&gt; ($row['user_colour']) ? '&lt;span style=&quot;color:#' . $row['user_colour'] . '&quot;&gt;' . $poster . '&lt;/span&gt;' : $poster,
+				'age'			=&gt; '',
+
+				'warnings'		=&gt; 0,
 			);
 		}
 		else
@@ -718,14 +743,23 @@
 			$user_cache[$poster_id] = array(
 				'joined'				=&gt; $_CLASS['core_user']-&gt;format_date($row['user_reg_date'], $_CLASS['core_user']-&gt;lang['DATE_FORMAT']),
 				'posts'					=&gt; $row['user_posts'],
+				'warnings'		=&gt; (isset($row['user_warnings'])) ? $row['user_warnings'] : 0,
 				'from'					=&gt; $row['user_from'],
+
 				'sig'					=&gt; $user_sig,
 				'sig_bbcode_uid'		=&gt; ($user_sig) ? $row['user_sig_bbcode_uid'] : '',
 				'sig_bbcode_bitfield'	=&gt; ($user_sig) ? $row['user_sig_bbcode_bitfield'] : '',
-				'viewonline'			=&gt; $row['user_allow_viewonline'], 
+
+				'viewonline'			=&gt; $row['user_allow_viewonline'],
+
 				'avatar'				=&gt; '',
-				'online'				=&gt; false,
+				'age'					=&gt; '',
 
+				'rank_title'		=&gt; '',
+				'rank_image'		=&gt; '',
+				'rank_image_src'	=&gt; '',
+
+				'online'		=&gt; false,
 				'profile'		=&gt; generate_link(&quot;members_list&amp;mode=viewprofile&amp;u=$poster_id&quot;),
 				'www'			=&gt; $row['user_website'],
 				'aim'			=&gt; ($row['user_aim']) ? generate_link('members_list&amp;mode=contact&amp;action=aim&amp;u='.$poster_id) : '',
@@ -757,11 +791,13 @@
 			{
 				$user_cache[$poster_id]['rank_title'] = (isset($ranks['special'][$row['user_rank']])) ? $ranks['special'][$row['user_rank']]['rank_title'] : '';
 				$user_cache[$poster_id]['rank_image'] = (!empty($ranks['special'][$row['user_rank']]['rank_image'])) ? '&lt;img src=&quot;' . $config['ranks_path'] . '/' . $ranks['special'][$row['user_rank']]['rank_image'] . '&quot; border=&quot;0&quot; alt=&quot;' . $ranks['special'][$row['user_rank']]['rank_title'] . '&quot; title=&quot;' . $ranks['special'][$row['user_rank']]['rank_title'] . '&quot; /&gt;&lt;br /&gt;' : '';
+				$user_cache[$poster_id]['rank_image_src'] = (!empty($ranks['special'][$row['user_rank']]['rank_image'])) ? $config['ranks_path'] . '/' . $ranks['special'][$row['user_rank']]['rank_image'] : '';
+
 			}
 			else
 			{
-				$user_cache[$poster_id]['rank_title'] = '';
-				$user_cache[$poster_id]['rank_image'] = '';
+				$user_cache[$poster_id]['rank_title'] = $user_cache[$poster_id]['rank_image'] = '';
+				$user_cache[$poster_id]['rank_image_src'] = '';
 				
 				/*
 				Well we kind of do need this
@@ -773,7 +809,7 @@
 						{
 							$user_cache[$poster_id]['rank_title'] = $rank['rank_title'];
 							$user_cache[$poster_id]['rank_image'] = (!empty($rank['rank_image'])) ? '&lt;img src=&quot;' . $config['ranks_path'] . '/' . $rank['rank_image'] . '&quot; border=&quot;0&quot; alt=&quot;' . $rank['rank_title'] . '&quot; title=&quot;' . $rank['rank_title'] . '&quot; /&gt;&lt;br /&gt;' : '';
-
+							$user_cache[$poster_id]['rank_image_src'] = (!empty($rank['rank_image'])) ? $config['ranks_path'] . '/' . $rank['rank_image'] : '';
 							break;
 						}
 					}
@@ -792,7 +828,8 @@
 
 			if (!empty($row['user_icq']))
 			{
-				$user_cache[$poster_id]['icq'] =  generate_link('members_list&amp;mode=contact&amp;action=icq&amp;u='.$poster_id);
+				//$user_cache[$poster_id]['icq'] =  generate_link('members_list&amp;mode=contact&amp;action=icq&amp;u='.$poster_id);
+				$user_cache[$poster_id]['icq'] = '<A HREF="http://www.icq.com/people/webmsg.php?to=">http://www.icq.com/people/webmsg.php?to=</A>' . $row['user_icq'];
 				$user_cache[$poster_id]['icq_status_img'] = '&lt;img src=&quot;<A HREF="http://web.icq.com/whitepages/online?icq=">http://web.icq.com/whitepages/online?icq=</A>' . $row['user_icq'] . '&amp;img=5&quot; width=&quot;18&quot; height=&quot;18&quot; border=&quot;0&quot; /&gt;';
 			}
 			else
@@ -800,10 +837,21 @@
 				$user_cache[$poster_id]['icq_status_img'] = '';
 				$user_cache[$poster_id]['icq'] = '';
 			}
+			
+			if (!empty($row['user_birthday']))
+			{
+				list($bday_day, $bday_month, $bday_year) = array_map('intval', explode('-', $row['user_birthday']));
+
+				if ($bday_year)
+				{
+					$user_cache[$poster_id]['age'] = (int) ($today['year'] - $bday_year - (($today['month'] - $bday_month &lt; 0) ? 1 : (($today['day'] - $bday_day &lt; 0) ? 1 : 0)));
+				}
+			}
 		}
 	}
 }
 $_CLASS['core_db']-&gt;free_result($result);
+unset($today);
 
 // Generate online information for user
 if ($config['load_onlinetrack'] &amp;&amp; !empty($id_cache))
@@ -821,6 +869,7 @@
 	{
 		$user_cache[$row['session_user_id']]['online'] = (!$row['session_hidden'] &amp;&amp; $row['online_time'] &gt; $online_time);
 	}
+	$_CLASS['core_db']-&gt;free_result($result);
 }
 unset($id_cache);
 
@@ -829,8 +878,6 @@
 {
 	if ($_CLASS['auth']-&gt;acl_gets(array('f_download', 'u_download'), $forum_id))
 	{
-		include(SITE_FILE_ROOT.'includes/forums/functions_display.php');
-
 		$sql = 'SELECT * 
 			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 			WHERE post_msg_id IN (' . implode(', ', $attach_list) . ')
@@ -870,6 +917,7 @@
 						WHERE topic_id = $topic_id&quot;;
 					$_CLASS['core_db']-&gt;query($sql);
 				}
+				$_CLASS['core_db']-&gt;free_result($result);
 			}
 			else
 			{
@@ -899,7 +947,7 @@
 // Instantiate BBCode if need be
 if ($bbcode_bitfield)
 {
-	require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+	require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 	$bbcode = new bbcode($bbcode_bitfield);
 }
 
@@ -914,7 +962,6 @@
 for ($i = 0; $i &lt; $count; ++$i)
 {
 	$row =&amp; $rowset[$post_list[$i]];
-	$force_encoding = '';
 
 	//is poster is on the users ignore list ?
 	if (!empty($row['foe']))
@@ -939,12 +986,9 @@
 
 		$user_cache[$poster_id]['sig'] = smiley_text($user_cache[$poster_id]['sig']);
 		$user_cache[$poster_id]['sig'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($user_cache[$poster_id]['sig']));
-		$user_cache[$poster_id]['sig_parsed'] = TRUE;
+		$user_cache[$poster_id]['sig_parsed'] = true;
 	}
 
-	// Parse the message and subject
-	$row['post_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', $row['post_text']);
-
 	// If the board has HTML off but the post has HTML on then we process it, else leave it alone
 	if ($row['enable_html'] &amp;&amp; (!$config['allow_html'] || !$_CLASS['auth']-&gt;acl_get('f_html', $forum_id)))
 	{
@@ -974,9 +1018,7 @@
 	// Highlight active words (primarily for search)
 	if ($highlight_match)
 	{
-		// This was shamelessly 'borrowed' from volker at multiartstudio dot de
-		// via php.net's annotated manual
-		$row['post_text'] = str_replace('\&quot;', '&quot;', substr(preg_replace('#(\&gt;(((?&gt;([^&gt;&lt;]+|(?R)))*)\&lt;))#se', &quot;preg_replace('#\b(&quot; . str_replace('\\', '\\\\', addslashes($highlight_match)) . &quot;)\b#i', '&lt;span class=\&quot;posthilit\&quot;&gt;\\\\1&lt;/span&gt;', '\\0')&quot;, '&gt;' . $row['post_text'] . '&lt;'), 1, -1));
+		$message = preg_replace('#(?!&lt;.*)(?&lt;!\w)(' . $highlight_match . ')(?!\w|[^&lt;&gt;]*&gt;)#i', '&lt;span class=&quot;posthilit&quot;&gt;\1&lt;/span&gt;', $message);
 	}
 
 	if ($row['enable_html'] &amp;&amp; ($config['allow_html'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_html', $forum_id)))
@@ -984,12 +1026,16 @@
 		// Remove Comments from post content
 		$row['post_text'] = preg_replace('#&lt;!\-\-(.*?)\-\-&gt;#is', '', $row['post_text']);
 	}
-	
+
+	// Replace naughty words such as farty pants
+	$row['post_subject'] = censor_text($row['post_subject']);
+	$row['post_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($row['post_text']));
+
 	// Editing information
 	if (($row['post_edit_count'] &amp;&amp; $config['display_last_edited']) || $row['post_edit_reason'])
 	{
 		// Get usernames for all following posts if not already stored
-		if (empty($post_edit_list) &amp;&amp; $row['post_edit_reason'])
+		if (empty($post_edit_list) &amp;&amp; ($row['post_edit_reason'] || ($row['post_edit_user'] &amp;&amp; !isset($user_cache[$row['post_edit_user']]))))
 		{
 			// Remove all post_ids already parsed (we do not have to check them)
 			$post_storage_list = (!$store_reverse) ? array_slice($post_list, $i) : array_slice(array_reverse($post_list), $i);
@@ -999,22 +1045,35 @@
 				WHERE p.post_id IN (' . implode(', ', $post_storage_list) . &quot;)
 					AND p.post_edit_count &lt;&gt; 0
 					AND p.post_edit_user &lt;&gt; 0
-					AND p.post_edit_reason &lt;&gt; ''
 					AND p.post_edit_user = u.user_id&quot;;
 			$result2 = $_CLASS['core_db']-&gt;query($sql);
 			while ($user_edit_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result2))
 			{
+				$user_edit_row['username'] = ($user_edit_row['user_colour']) ? '&lt;span style=&quot;color:#' . $user_edit_row['user_colour'] . '&quot;&gt;' . $user_edit_row['username'] . '&lt;/span&gt;' : $user_edit_row['username'];
 				$post_edit_list[$user_edit_row['user_id']] = $user_edit_row;
 			}
 			$_CLASS['core_db']-&gt;free_result($result2);
 			
 			unset($post_storage_list);
 		}
+
 		$l_edit_time_total = ($row['post_edit_count'] == 1) ? $_CLASS['core_user']-&gt;lang['EDITED_TIME_TOTAL'] : $_CLASS['core_user']-&gt;lang['EDITED_TIMES_TOTAL'];
 
-		$user_edit_row = ($row['post_edit_reason']) ? $post_edit_list[$row['post_edit_user']] : array();
-
-		$l_edited_by = sprintf($l_edit_time_total, (!$row['post_edit_user']) ? $row['poster'] : (($user_edit_row['user_colour']) ? '&lt;span style=&quot;color:#' . $user_edit_row['user_colour'] . '&quot;&gt;' . $user_edit_row['username'] . '&lt;/span&gt;' : $user_edit_row['username']), $_CLASS['core_user']-&gt;format_date($row['post_edit_time']), $row['post_edit_count']);
+		if ($row['post_edit_reason'])
+		{
+			$user_edit_row = $post_edit_list[$row['post_edit_user']];
+
+			$l_edited_by = sprintf($l_edit_time_total, (!$row['post_edit_user']) ? $row['poster'] : $user_edit_row['username'], $_CLASS['core_user']-&gt;format_date($row['post_edit_time']), $row['post_edit_count']);
+		}
+		else
+		{
+			if ($row['post_edit_user'] &amp;&amp; !isset($user_cache[$row['post_edit_user']]))
+			{
+				$user_cache[$row['post_edit_user']] = $post_edit_list[$row['post_edit_user']];
+			}
+
+			$l_edited_by = sprintf($l_edit_time_total, (!$row['post_edit_user']) ? $row['poster'] : $user_cache[$row['post_edit_user']]['username'], $_CLASS['core_user']-&gt;format_date($row['post_edit_time']), $row['post_edit_count']);
+		}
 	}
 	else
 	{
@@ -1022,10 +1081,11 @@
 	}
 
 	// Bump information
-	if ($topic_data['topic_bumped'] &amp;&amp; $row['post_id'] == $topic_data['topic_last_post_id'])
+	if ($topic_data['topic_bumped'] &amp;&amp; $row['post_id'] == $topic_data['topic_last_post_id'] &amp;&amp; isset($user_cache[$topic_data['topic_bumper']]) )
 	{
-		// It is safe to grab the username from the user cache array, we are at the last 
-		// post and only the topic poster and last poster are allowed to bump
+		// It is safe to grab the username from the user cache array, we are at the last
+		// post and only the topic poster and last poster are allowed to bump. However, a
+		// check is still needed incase an admin bumped the topic (but didn't post in the topic)
 		$l_bumped_by = '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['BUMPED_BY'], $user_cache[$topic_data['topic_bumper']]['username'], $_CLASS['core_user']-&gt;format_date($topic_data['topic_last_post_time']));
 	}
 	else
@@ -1048,36 +1108,39 @@
 		'POSTER_NAME' 	=&gt; $row['poster'],
 		'POSTER_RANK' 	=&gt; $user_cache[$poster_id]['rank_title'],
 		'RANK_IMAGE' 	=&gt; $user_cache[$poster_id]['rank_image'],
-		'POSTER_JOINED' =&gt; $user_cache[$poster_id]['joined'],
-		'POSTER_POSTS' 	=&gt; $user_cache[$poster_id]['posts'],
-		'POSTER_FROM' 	=&gt; $user_cache[$poster_id]['from'],
-		'POSTER_AVATAR' =&gt; $user_cache[$poster_id]['avatar'],
+		'RANK_IMAGE_SRC'	=&gt; $user_cache[$poster_id]['rank_image_src'],
+		'POSTER_JOINED'		=&gt; $user_cache[$poster_id]['joined'],
+		'POSTER_POSTS'		=&gt; $user_cache[$poster_id]['posts'],
+		'POSTER_FROM'		=&gt; $user_cache[$poster_id]['from'],
+		'POSTER_AVATAR'		=&gt; $user_cache[$poster_id]['avatar'],
+		'POSTER_WARNINGS'	=&gt; $user_cache[$poster_id]['warnings'],
+		'POSTER_AGE'		=&gt; $user_cache[$poster_id]['age'],
 		
 		'POST_DATE' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['post_time']),
-		'POST_SUBJECT' 	=&gt; censor_text($row['post_subject']),
-		'MESSAGE' 		=&gt; censor_text($row['post_text']),
+		'POST_SUBJECT' 	=&gt; $row['post_subject'],
+		'MESSAGE' 		=&gt; $row['post_text'],
 		'SIGNATURE' 	=&gt; ($row['enable_sig']) ? $user_cache[$poster_id]['sig'] : '',
 		'EDITED_MESSAGE'=&gt; $l_edited_by,
 		'EDIT_REASON'	=&gt; $row['post_edit_reason'],
 		'BUMPED_MESSAGE'=&gt; $l_bumped_by,
 
 		'MINI_POST_IMG'			=&gt; ($unread) ? $_CLASS['core_user']-&gt;img('icon_post_new', 'NEW_POST') : $_CLASS['core_user']-&gt;img('icon_post', 'POST'),
-		'POST_ICON_IMG'			=&gt; $icons[$row['icon_id']]['img'],
-		'POST_ICON_IMG_WIDTH'   =&gt; $icons[$row['icon_id']]['width'],
-		'POST_ICON_IMG_HEIGHT'  =&gt; $icons[$row['icon_id']]['height'],
+		'POST_ICON_IMG'			=&gt; (!empty($row['icon_id'])) ? $icons[$row['icon_id']]['img'] : '',
+		'POST_ICON_IMG_WIDTH'	=&gt; (!empty($row['icon_id'])) ? $icons[$row['icon_id']]['width'] : '',
+		'POST_ICON_IMG_HEIGHT'	=&gt; (!empty($row['icon_id'])) ? $icons[$row['icon_id']]['height'] : '',
 		
 		'ICQ_STATUS_IMG'	=&gt; $user_cache[$poster_id]['icq_status_img'],
-
 		'ONLINE_IMG'		=&gt; ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? '' : (($user_cache[$poster_id]['online']) ? $_CLASS['core_user']-&gt;img('btn_online', 'ONLINE') : $_CLASS['core_user']-&gt;img('btn_offline', 'OFFLINE')), 
+		'S_ONLINE'			=&gt; ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? false : (($user_cache[$poster_id]['online']) ? true : false),
 
-		'U_EDIT' 			=&gt; (($_CLASS['core_user']-&gt;data['user_id'] == $poster_id &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_edit', $forum_id) &amp;&amp; ($row['post_time'] &gt; time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id)) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=edit&amp;p=&quot; . $row['post_id']) : '',
-		'U_QUOTE' 			=&gt; ($_CLASS['auth']-&gt;acl_get('f_quote', $forum_id)) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=quote&amp;p=&quot; . $row['post_id']) : '', 
-		'U_INFO'            =&gt; ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id'], false, false) : '',
-		'U_DELETE' 			=&gt; (($_CLASS['core_user']-&gt;data['user_id'] == $poster_id &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $topic_data['topic_last_post_id'] == $row['post_id'] &amp;&amp; ($row['post_time'] &gt; time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']-&gt;acl_get('m_delete', $forum_id)) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=delete&amp;p=&quot; . $row['post_id']) : '',
+		'U_EDIT' 			=&gt; (($_CLASS['core_user']-&gt;data['user_id'] == $poster_id &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_edit', $forum_id) &amp;&amp; ($row['post_time'] &gt; time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id)) ? generate_link(&quot;forums&amp;file=posting&amp;mode=edit&amp;p=&quot; . $row['post_id']) : '',
+		'U_QUOTE' 			=&gt; ($_CLASS['auth']-&gt;acl_get('f_quote', $forum_id)) ? generate_link(&quot;forums&amp;file=posting&amp;mode=quote&amp;p=&quot; . $row['post_id']) : '', 
+		'U_INFO'            =&gt; ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id'], false, false) : '',
+		'U_DELETE' 			=&gt; (($_CLASS['core_user']-&gt;data['user_id'] == $poster_id &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $topic_data['topic_last_post_id'] == $row['post_id'] &amp;&amp; ($row['post_time'] &gt; time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']-&gt;acl_get('m_delete', $forum_id)) ? generate_link(&quot;forums&amp;file=posting&amp;mode=delete&amp;p=&quot; . $row['post_id']) : '',
 
 		'U_PROFILE' 		=&gt; $user_cache[$poster_id]['profile'],
 		'U_SEARCH' 			=&gt; $user_cache[$poster_id]['search'],
-		'U_PM' 				=&gt; ($poster_id != ANONYMOUS) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;action=quote&amp;q=1&amp;p=' . $row['post_id']) : '',
+		'U_PM' 				=&gt; ($poster_id != ANONYMOUS) ? generate_link('control_panel&amp;i=pm&amp;mode=compose&amp;action=quote&amp;q=1&amp;p=' . $row['post_id']) : '',
 		'U_EMAIL' 			=&gt; $user_cache[$poster_id]['email'],
 		'U_WWW' 			=&gt; $user_cache[$poster_id]['www'],
 		'U_ICQ' 			=&gt; $user_cache[$poster_id]['icq'],
@@ -1086,22 +1149,26 @@
 		'U_YIM' 			=&gt; $user_cache[$poster_id]['yim'],
 		'U_JABBER'			=&gt; $user_cache[$poster_id]['jabber'], 
 
-		'U_REPORT'			=&gt; generate_link('Forums&amp;file=report&amp;p=' . $row['post_id']),
-		'U_MCP_REPORT'		=&gt; ($_CLASS['auth']-&gt;acl_gets(array('m_', 'a_', 'f_report'), $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
-		'U_MCP_APPROVE'		=&gt; ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
-		'U_MCP_DETAILS'		=&gt; ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
-		'U_MINI_POST'		=&gt; generate_link('Forums&amp;file=viewtopic&amp;p=' . $row['post_id']) . '#' . $row['post_id'],
+		'U_REPORT'			=&gt; generate_link('forums&amp;file=report&amp;p=' . $row['post_id']),
+		'U_MCP_REPORT'		=&gt; ($_CLASS['auth']-&gt;acl_gets(array('m_', 'a_', 'f_report'), $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
+		'U_MCP_APPROVE'		=&gt; ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
+		'U_MCP_DETAILS'		=&gt; ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
+		'U_MINI_POST'		=&gt; generate_link('forums&amp;file=viewtopic&amp;p=' . $row['post_id']) . '#' . $row['post_id'],
 		'U_NEXT_POST_ID'	=&gt; ($i &lt; $i_total &amp;&amp; isset($rowset[$i + 1])) ? $rowset[$i + 1]['post_id'] : '', 
 		'U_PREV_POST_ID'	=&gt; $prev_post_id, 
+
 		'POST_ID'           =&gt; $row['post_id'],
-		'S_IGNORE_POST' 	=&gt; false, 
-		
+
+		//'U_NOTES'			=&gt; ($_CLASS['auth']-&gt;acl_getf_global('m_')) ? generate_link('forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $poster_id) : '',
+		//'U_WARN'			=&gt; ($_CLASS['auth']-&gt;acl_getf_global('m_warn') &amp;&amp; $poster_id != $_CLASS['core_user']-&gt;data['user_id']) ? generate_link('forums&amp;file=mcp&amp;i=warn&amp;mode=warn_post&amp;f=' . $forum_id . '&amp;p=' . $row['post_id']) : '',
+
 		'S_POST_UNAPPROVED'	=&gt; !$row['post_approved'],
-		'S_POST_REPORTED'	=&gt; ($row['post_reported'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? TRUE : FALSE,
-		'S_DISPLAY_NOTICE'	=&gt; ($display_notice &amp;&amp; $row['post_attachment']) ? true : false, 
+		'S_POST_REPORTED'	=&gt; ($row['post_reported'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_', $forum_id)),
+		'S_DISPLAY_NOTICE'	=&gt; ($display_notice &amp;&amp; $row['post_attachment']), 
 		'S_FRIEND'			=&gt; $row['friend'],
 		'S_UNREAD_POST'		=&gt; $unread,
 		'S_FIRST_UNREAD'	=&gt; false,
+		'S_IGNORE_POST'		=&gt; false
 	);
 
 	if ($unread &amp;&amp; !$first_unread_makred)
@@ -1115,11 +1182,35 @@
 	
 	$prev_post_id = $row['post_id'];
 
-	unset($rowset[$i], $attachments[$row['post_id']]);
+	unset($postrow, $rowset[$i], $attachments[$row['post_id']]);
 }
 
 unset($rowset, $user_cache);
 
+
+// Update topic view and if necessary attachment view counters ... but only
+// if this is the first 'page view'
+
+//mb_strpos() should never be 0 here
+if (!mb_strpos($_CLASS['core_user']-&gt;data['session_url'], '&amp;t='.$topic_id))
+{
+	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+		SET topic_views = topic_views + 1, topic_last_view_time = ' . $_CLASS['core_user']-&gt;time . &quot;
+		WHERE topic_id = $topic_id&quot;;
+	$_CLASS['core_db']-&gt;query($sql);
+
+	// Update the attachment download counts
+	if (!empty($update_count))
+	{
+		$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
+			SET download_count = download_count + 1 
+			WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+}
+
+$allow_change_type = ($_CLASS['auth']-&gt;acl_get('m_', $forum_id) || ($_CLASS['core_user']-is_user &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] == $topic_data['topic_poster'])) ? true : false;
+
 // Quick mod tools
 $topic_mod = '';
 $topic_mod .= ($_CLASS['auth']-&gt;acl_get('m_lock', $forum_id) || ($_CLASS['auth']-&gt;acl_get('f_user_lock', $forum_id) &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] == $topic_data['topic_poster'])) ? (($topic_data['topic_status'] == ITEM_UNLOCKED) ? '&lt;option value=&quot;lock&quot;&gt;' . $_CLASS['core_user']-&gt;lang['LOCK_TOPIC'] . '&lt;/option&gt;' : '&lt;option value=&quot;unlock&quot;&gt;' . $_CLASS['core_user']-&gt;lang['UNLOCK_TOPIC'] . '&lt;/option&gt;') : '';
@@ -1128,13 +1219,14 @@
 $topic_mod .= ($_CLASS['auth']-&gt;acl_get('m_split', $forum_id)) ? '&lt;option value=&quot;split&quot;&gt;' . $_CLASS['core_user']-&gt;lang['SPLIT_TOPIC'] . '&lt;/option&gt;' : '';
 $topic_mod .= ($_CLASS['auth']-&gt;acl_get('m_merge', $forum_id)) ? '&lt;option value=&quot;merge&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MERGE_TOPIC'] . '&lt;/option&gt;' : '';
 $topic_mod .= ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? '&lt;option value=&quot;fork&quot;&gt;' . $_CLASS['core_user']-&gt;lang['FORK_TOPIC'] . '&lt;/option&gt;' : '';
-$topic_mod .= ($_CLASS['auth']-&gt;acl_get('m_', $forum_id) &amp;&amp; $topic_data['topic_type'] != POST_NORMAL) ? '&lt;option value=&quot;make_normal&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAKE_NORMAL'] . '&lt;/option&gt;' : '';
-$topic_mod .= ($_CLASS['auth']-&gt;acl_get('f_sticky', $forum_id) &amp;&amp; $topic_data['topic_type'] != POST_STICKY) ? '&lt;option value=&quot;make_sticky&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAKE_STICKY'] . '&lt;/option&gt;' : '';
-$topic_mod .= ($_CLASS['auth']-&gt;acl_get('f_announce', $forum_id) &amp;&amp; $topic_data['topic_type'] != POST_ANNOUNCE) ? '&lt;option value=&quot;make_announce&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAKE_ANNOUNCE'] . '&lt;/option&gt;' : '';
-$topic_mod .= ($_CLASS['auth']-&gt;acl_get('f_announce', $forum_id) &amp;&amp; $topic_data['topic_type'] != POST_GLOBAL) ? '&lt;option value=&quot;make_global&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAKE_GLOBAL'] . '&lt;/option&gt;' : '';
+$topic_mod .= ($allow_change_type &amp;&amp; $_CLASS['auth']-&gt;acl_gets(array('f_sticky', 'f_announce'), $forum_id) &amp;&amp; $topic_data['topic_type'] != POST_NORMAL) ? '&lt;option value=&quot;make_normal&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAKE_NORMAL'] . '&lt;/option&gt;' : '';
+$topic_mod .= ($allow_change_type &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_sticky', $forum_id) &amp;&amp; $topic_data['topic_type'] != POST_STICKY) ? '&lt;option value=&quot;make_sticky&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAKE_STICKY'] . '&lt;/option&gt;' : '';
+$topic_mod .= ($allow_change_type &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_announce', $forum_id) &amp;&amp; $topic_data['topic_type'] != POST_ANNOUNCE) ? '&lt;option value=&quot;make_announce&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAKE_ANNOUNCE'] . '&lt;/option&gt;' : '';
+$topic_mod .= ($allow_change_type &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_announce', $forum_id) &amp;&amp; $topic_data['topic_type'] != POST_GLOBAL) ? '&lt;option value=&quot;make_global&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAKE_GLOBAL'] . '&lt;/option&gt;' : '';
 $topic_mod .= ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? '&lt;option value=&quot;viewlogs&quot;&gt;' . $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_LOGS'] . '&lt;/option&gt;' : '';
 
 $pagination = generate_pagination(&quot;forums&amp;file=viewtopic&amp;t=$topic_id&amp;$u_sort_param&quot; . (($highlight_match) ? &quot;&amp;hilit=$highlight&quot; : ''), $total_posts, $config['posts_per_page'], $start);
+
 $topic_data['topic_title'] = censor_text($topic_data['topic_title']);
 
 // Send vars to template
@@ -1171,10 +1263,14 @@
 	'REPORT_IMG'	=&gt; $_CLASS['core_user']-&gt;img('btn_report', 'REPORT_POST'),
 	'REPORTED_IMG'	=&gt; $_CLASS['core_user']-&gt;img('icon_reported', 'POST_REPORTED'),
 	'UNAPPROVED_IMG'=&gt; $_CLASS['core_user']-&gt;img('icon_unapproved', 'POST_UNAPPROVED'),
+	'WARN_IMG'		=&gt; $_CLASS['core_user']-&gt;img('btn_warn', 'WARN_USER'),
+
 	
 	'S_SELECT_SORT_DIR' 	=&gt; $s_sort_dir,
 	'S_SELECT_SORT_KEY' 	=&gt; $s_sort_key,
 	'S_SELECT_SORT_DAYS' 	=&gt; $s_limit_days,
+	'S_SINGLE_MODERATOR'	=&gt; (!empty($forum_moderators[$forum_id]) &amp;&amp; count($forum_moderators[$forum_id]) &gt; 1) ? false : true,
+
 	'S_TOPIC_ACTION' 		=&gt; generate_link(&quot;forums&amp;file=viewtopic&amp;t=$topic_id&amp;start=$start&quot;),
 	'S_TOPIC_MOD' 			=&gt; ($topic_mod) ? '&lt;select name=&quot;mode&quot;&gt;' . $topic_mod . '&lt;/select&gt;' : '',
 	'S_MOD_ACTION' 			=&gt; generate_link(&quot;forums&amp;file=mcp&amp;t=$topic_id&amp;quickmod=1&quot;, false, false), 
@@ -1182,14 +1278,14 @@
 	'S_DISPLAY_SEARCHBOX'	=&gt; ($_CLASS['auth']-&gt;acl_get('f_search', $forum_id)) ? true : false, 
 	'S_SEARCHBOX_ACTION'	=&gt; generate_link('forums&amp;file=search&amp;search_forum[]='.$forum_id), 
 
-	'U_TOPIC'				=&gt; ($view == 'print') ? generate_link('forums&amp;file=viewtopic&amp;t='.$topic_id, array('full' =&gt; true)) : generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id),
+	'U_TOPIC'				=&gt; ($view == 'print') ? generate_link('forums&amp;file=viewtopic&amp;t='.$topic_id, array('full' =&gt; true)) : generate_link('forums&amp;file=viewtopic&amp;t='.$topic_id),
 	'U_VIEW_UNREAD_POST'	=&gt; ($first_unread_makred) ? generate_link(&quot;forums&amp;file=viewtopic&amp;t=$topic_id#unread&quot;) : false,
 	'U_VIEW_TOPIC' 			=&gt; generate_link($viewtopic_url),
 	'U_VIEW_FORUM' 			=&gt; generate_link('forums&amp;file=viewforum&amp;f='.$forum_id),
 	'U_VIEW_OLDER_TOPIC'	=&gt; generate_link(&quot;forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=previous&quot;),
 	'U_VIEW_NEWER_TOPIC'	=&gt; generate_link(&quot;forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=next&quot;),
 	'U_PRINT_TOPIC'			=&gt; ($_CLASS['auth']-&gt;acl_get('f_print', $forum_id)) ? generate_link($viewtopic_url . '&amp;view=print') : '',
-	'U_EMAIL_TOPIC'			=&gt; ($_CLASS['auth']-&gt;acl_get('f_email', $forum_id) &amp;&amp; $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;t='.$topic_id) : '', 
+	'U_EMAIL_TOPIC'			=&gt; ($_CLASS['auth']-&gt;acl_get('f_email', $forum_id) &amp;&amp; $_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;t='.$topic_id) : '', 
 
 	'S_WATCH_FORUMS'		=&gt; $topic_data['watch_topic'] ? false : true,
 	'U_WATCH_TOPIC' 		=&gt; $s_watching_topic['link'], 
@@ -1200,30 +1296,9 @@
 	
 	'U_POST_NEW_TOPIC' 		=&gt; generate_link('forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id),
 	'U_POST_REPLY_TOPIC' 	=&gt; generate_link(&quot;forums&amp;file=posting&amp;mode=reply&amp;t=$topic_id&quot;),
-	'U_BUMP_TOPIC'			=&gt; bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id']) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id&quot;) : '')
+	'U_BUMP_TOPIC'			=&gt; bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id']) ? generate_link(&quot;forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id&quot;) : '')
 );
 
-// Update topic view and if necessary attachment view counters ... but only
-// if this is the first 'page view'
-
-//mb_strpos() should never be 0 here
-if (!mb_strpos($_CLASS['core_user']-&gt;data['session_url'], '&amp;t='.$topic_id))
-{
-	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
-		SET topic_views = topic_views + 1, topic_last_view_time = ' . $_CLASS['core_user']-&gt;time . &quot;
-		WHERE topic_id = $topic_id&quot;;
-	$_CLASS['core_db']-&gt;query($sql);
-
-	// Update the attachment download counts
-	if (!empty($update_count))
-	{
-		$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
-			SET download_count = download_count + 1 
-			WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-}
-
 // Mark topics read
 if ($update_mark)
 {


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000099.html">[Viperals-svncheckins] r180 - in cms/trunk: includes	includes/forums includes/forums/mcp modules/forums
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#98">[ date ]</a>
              <a href="thread.html#98">[ thread ]</a>
              <a href="subject.html#98">[ subject ]</a>
              <a href="author.html#98">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
