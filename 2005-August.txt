From viperal at berlios.de  Mon Aug  8 18:45:30 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Mon, 8 Aug 2005 18:45:30 +0200
Subject: [Viperals-svncheckins] r77 - trunk/includes
Message-ID: <200508081645.j78GjUjr028279@sheep.berlios.de>

Author: viperal
Date: 2005-08-08 18:44:56 +0200 (Mon, 08 Aug 2005)
New Revision: 77

Modified:
   trunk/includes/mailer.php
Log:


Modified: trunk/includes/mailer.php
===================================================================
--- trunk/includes/mailer.php	2005-08-08 05:03:17 UTC (rev 76)
+++ trunk/includes/mailer.php	2005-08-08 16:44:56 UTC (rev 77)
@@ -4,7 +4,7 @@
 //**************************************************************//
 //																//
 //  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
+//  By Ryan Marshall ( Viperal?	)								//
 //																//
 //  http://www.viperal.com										//
 //																//
@@ -15,15 +15,14 @@
 
 class core_mailer
 {
-	var $from;
-	var $reply_to;
 	var $message;
 	var $subject;
-	var $bcc;
-	var $to;
+	var $address_arrays;
 	var $extra_headers;
 
-	function setup()
+	var $encoding = 'UTF-8';
+
+	function core_mailer()
 	{	
 		$this->html = false;
 		$this->message = $this->subject = '';
@@ -33,7 +32,7 @@
 	function to($address, $name = '')
 	{
 		$this->address_arrays['to'][] = array(
-				'address'	=> $address
+				'address'	=> $address,
 				'name'		=> $name
 			);
 	}
@@ -41,7 +40,7 @@
 	function cc($address, $name = '')
 	{
 		$this->address_arrays['cc'][] = array(
-				'address'	=> $address
+				'address'	=> $address,
 				'name'		=> $name
 			);
 	}
@@ -49,7 +48,7 @@
 	function bcc($address, $name = '')
 	{
 		$this->address_arrays['bcc'][] = array(
-				'address'	=> $address
+				'address'	=> $address,
 				'name'		=> $name
 			);
 	}
@@ -57,7 +56,7 @@
 	function reply_to($address, $name = '')
 	{
 		$this->address_arrays['reply_to'] = array(
-			'address'	=> $address
+			'address'	=> $address,
 			'name'		=> $name
 		);
 	}
@@ -65,7 +64,7 @@
 	function from($address, $name = '')
 	{
 		$this->address_arrays['from'] = array(
-			'address'	=> $address
+			'address'	=> $address,
 			'name'		=> $name
 		);
 	}
@@ -96,14 +95,14 @@
 	{
 		global $_CLASS, $_CORE_CONFIG;
 
-		$to = $cc = $bcc = $reply_to = $from = '';
+		$to = $cc = $bcc = $reply_to = $from = false;
 
 		foreach ($this->address_arrays as $type => $address)
 		{
-			$$type = format_address($address);
+			$$type = $this->format_address($address);
 		}
 
-		$_CORE_CONFIG['email']['site_mail'] = trim($_CORE_CONFIG['email']['site_mail'])
+		$_CORE_CONFIG['email']['site_mail'] = trim($_CORE_CONFIG['email']['site_mail']);
 
 		if (!$from)
 		{
@@ -111,24 +110,42 @@
 			$from = '<' . $_CORE_CONFIG['email']['site_mail'] . '>';
 		}
 
-		$headers = "From: $from \n";
-		$headers .= 'Date: ' . gmdate('D, d M Y H:i:s T')) . "\n";
-		$headers .= isset($cc) ? "Cc: $cc\n" : '';
-		$headers .= isset($bcc) ? "Bcc: $bcc\n" : ''; 
-		$headers .= isset($reply_to) ? "Reply-to: $reply_to \n" : '';
-		$headers .= 'Return-Path: <' . $_CORE_CONFIG['email']['site_mail'] . ">\n";
-		$headers .= 'Sender: <' .  . ">\n";
-		$headers .= "MIME-Version: 1.0\n";
-		$headers .= 'Message-ID: <' . ((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))) . "@" . $_CORE_CONFIG['global']['site_name'] . ">\n";
+		$headers[] = "From: $from";
+		$headers[] = 'Date: ' . gmdate('D, d M Y H:i:s T');
 
+		if (!$_CORE_CONFIG['email']['smtp'])
+		{
+			if ($cc)
+			{
+				$headers[] = "Cc: $cc";
+			}
+
+			if ($bcc)
+			{
+				$headers[] = "Bcc: $bcc";
+			}
+		}
+
+		if ($reply_to)
+		{
+			$headers[] = "Reply-to: $reply_to";
+		}
+
+		$headers[] = 'Return-Path: <' . $_CORE_CONFIG['email']['site_mail'] . ">";
+		$headers[] = 'Sender: <' . $_CORE_CONFIG['email']['site_mail'] . ">";
+		$headers[] = "MIME-Version: 1.0";
+		$headers[] = 'Message-ID: <' . ((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))) . "@" . $_CORE_CONFIG['global']['site_name'] . ">";
+
 		if ($this->html)
 		{
 			// multipart
-			$text_boundary = trim('----part_'.((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true)));
+			$text_boundary = trim('----part_'.((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))));
 
-			$headers .= "Content-Type: multipart/alternative;\nboundary=$text_boundary\n"; 
-			$headers .= 'Content-Type: text/html; charset='.$this->encoding."\n";
+			$headers[] = 'Content-Type: multipart/alternative;'; 
+			$headers[] = 'boundary="'.$text_boundary.'"';
 			
+			//$message = 'This is a multi-part message in MIME format'.
+
 			// Plain text
 			$message = "\n$text_boundary\n";
 			$message .= 'Content-type: text/plain; charset='.$this->encoding."\n"; //format=
@@ -145,15 +162,44 @@
 		}
 		else
 		{
-			$headers .= 'Content-type: text/plain; charset='.$this->encoding."\n";
-			$headers .= "Content-transfer-encoding: 8bit\n";
-			$message .= "\n".strip_tags(preg_replace('/<br[/]?>/', "/n", $this->message)."\n";
+			$headers[] = 'Content-type: text/plain; charset='.$this->encoding;
+			$headers[] = 'Content-transfer-encoding: 8bit';
+			$message = "\n".strip_tags(preg_replace('#<br */?>#i', "/n", $this->message))."\n";
 		}
 
-		if (function_exists($_CORE_CONFIG['email']['email_function_name'])
+		if ($_CORE_CONFIG['email']['smtp'])
 		{
-			$result = $_CORE_CONFIG['email']['email_function_name']($to, $this->subject, $message, $headers);
+			$smtp = new smtp_mailer;
 
+			if ($connect = $smtp->connect($_CORE_CONFIG['email']['smtp_host'], $_CORE_CONFIG['email']['smtp_port']))
+			{
+				$login = $smtp->login($_CORE_CONFIG['email']['smtp_username'], $_CORE_CONFIG['email']['smtp_password']);
+			}
+
+			if (!$connect || !$login)
+			{
+				$this->error = $smtp->error;
+				return false;
+			}
+		
+			$smtp->subject = $this->subject;
+			$smtp->headers = $headers;
+			$smtp->message = $message;
+			$this->recipients = array_merge($this->address_arrays['to'], $this->address_arrays['cc'] , $this->address_arrays['bcc']);
+
+			if (!$smtp->send_mail())
+			{
+				$this->error = $smtp->error;
+				return false;
+			}
+
+			return true;			
+		}
+
+		if (function_exists($_CORE_CONFIG['email']['email_function_name']))
+		{
+			$result = $_CORE_CONFIG['email']['email_function_name']($to, $this->subject, $message, implode("\n", $headers));
+
 			if (!$result)
 			{
 				return false;
@@ -177,6 +223,7 @@
 	var $connection;
 	var $host;
 	var $port;
+	var $error;
 
 	/*
 		PHP5 destructor
@@ -190,7 +237,7 @@
 	{
 		$port = ((int) $port) ? (int) $port : 25;
 
-		$this->connection = fsockopen($host, $port, $errno, $errstr, 15)
+		$this->connection = fsockopen($host, $port, $errno, $errstr, 15);
 
 		if (!$this->connection)
 		{
@@ -236,6 +283,7 @@
 			if (!$this->check_response(250))
 			{
 				$this->disconnect();
+				$this->error = "Server doesn't like you";
 				return false;
 			}
 		}
@@ -251,6 +299,7 @@
 			}
 
 			$this->disconnect();
+			$this->error = "Auth not supported";
 			return false;
 		}
 
@@ -259,6 +308,7 @@
 		if (!$this->check_response(334))
 		{
 			$this->disconnect();
+			$this->error = "User name denied";
 			return false;
 		}
 
@@ -267,6 +317,7 @@
 		if (!$this->check_response(235))
 		{
 			$this->disconnect();
+			$this->error = "Password denied";
 			return false;
 		}
 
@@ -323,23 +374,22 @@
 			return false;
 		}
 
-		//fwrite($this->connection, "To: ".implode(', ', $to_header)."\r\n");
-		$sending_header = ($this->subject) ? 'Subject: '.$this->subject."\r\n" : ''; // should add something here
-		$sending_header .= "To: ".implode(', ', $to_header)."\r\n";
-		$sending_header .= $this->headers."\r\n\r\n";
+		fwrite($this->connection, 'Subject: '.$this->subject."\r\n");
+		fwrite($this->connection, 'To: '.implode(', ', $to_header)."\r\n");
+		fwrite($this->connection, implode("\r\n", $this->headers)."\r\n\r\n");
 
 // Do my html and plain text mail thing, change it to a function maybe ?
-		fwrite($this->connection, $sending_header.$this->message."\r\n");
+		fwrite($this->connection, $this->message."\r\n");
 
 		fwrite($this->connection, '.'."\r\n");
 
-		$status = $this->check_response(250)
+		$status = $this->check_response(250);
 		$this->disconnect();
 
 		return $status;
 	}
 
-	function check_response($code, $full = false)
+	function check_response($code, $full = true)
 	{
 		$this->response = '';
 
@@ -355,6 +405,7 @@
 		}
 
 		$this->response = trim($this->response);
+		echo $this->response.'<br/>';
 
 		if ($code && substr($this->response, 0, 3) != $code)
 		{
@@ -364,4 +415,5 @@
 		return true;
 	}
 }
+
 ?>
\ No newline at end of file



From viperal at berlios.de  Tue Aug  9 00:18:20 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Tue, 9 Aug 2005 00:18:20 +0200
Subject: [Viperals-svncheckins] r78 - trunk/includes
Message-ID: <200508082218.j78MIKgO005886@sheep.berlios.de>

Author: viperal
Date: 2005-08-09 00:18:18 +0200 (Tue, 09 Aug 2005)
New Revision: 78

Modified:
   trunk/includes/mailer.php
Log:


Modified: trunk/includes/mailer.php
===================================================================
--- trunk/includes/mailer.php	2005-08-08 16:44:56 UTC (rev 77)
+++ trunk/includes/mailer.php	2005-08-08 22:18:18 UTC (rev 78)
@@ -17,16 +17,19 @@
 {
 	var $message;
 	var $subject;
-	var $address_arrays;
+	var $address_arrays = array('to' => array(), 'cc' => array(), 'bcc' => array());
 	var $extra_headers;
 
 	var $encoding = 'UTF-8';
+	
+	// Needed for some windows sendmail emulator/ SMTP
+	// Set to false is you have problems sending
+	var $named_addresses = true;
+	var $error = '';
 
-	function core_mailer()
+	function core_mailer($html = false)
 	{	
 		$this->html = false;
-		$this->message = $this->subject = '';
-		$this->bcc = $this->to = $this->from = $this->reply_to = $this->extra_headers = array();
 	}
 
 	function to($address, $name = '')
@@ -84,10 +87,9 @@
 		foreach ($address as $array)
 		{
 			$array['name'] = trim($array['name']);
-
-			$formatted[] = (($array['name']) ? $array['name'] : '') . ' <' . trim($array['address']) . '> ';
+//"=?UTF-8?B?VmlwZXJhbA==?="
+			$formatted[] = ($array['name'] && $this->named_addresses) ?  '"' . mail_encode($array['name'], $this->encoding) . '" <' . $array['address'] . '>' : $array['address'];
 		}
-
 		return implode(', ', $formatted);
 	}
 
@@ -99,6 +101,11 @@
 
 		foreach ($this->address_arrays as $type => $address)
 		{
+			if (empty($address))
+			{
+				continue;
+			}
+
 			$$type = $this->format_address($address);
 		}
 
@@ -138,39 +145,38 @@
 
 		if ($this->html)
 		{
+			// Seems a bit bugged, or it could be Mercury mailer :-(
 			// multipart
-			$text_boundary = trim('----part_'.((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))));
+			$text_boundary = trim('--'.((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))));
 
-			$headers[] = 'Content-Type: multipart/alternative;'; 
-			$headers[] = 'boundary="'.$text_boundary.'"';
-			
-			//$message = 'This is a multi-part message in MIME format'.
+			$headers[] = "Content-Type: multipart/alternative;\n\t boundary=\"$text_boundary\";";
 
+			$message = 'This is a multi-part message in MIME format, Please use a MIME-compatible client';
+
 			// Plain text
-			$message = "\n$text_boundary\n";
-			$message .= 'Content-type: text/plain; charset='.$this->encoding."\n"; //format=
-			$message .= "Content-transfer-encoding: 8bit\n";
-			$message .= "\n".html_entity_decode(strip_tags(preg_replace('#<br */?>#i', "/n", $this->message)), ENT_QUOTES)."\n";
+			$message .= "\n\n$text_boundary\n";
+			$message .= 'Content-Type: text/plain; charset='.$this->encoding."\n"; //format=
+			$message .= "Content-Transfer-Encoding: 8bit\n";
+			$message .= "\n".html_entity_decode(strip_tags(preg_replace('#<br */?>#i', "\n", modify_lines($this->message))), ENT_QUOTES)."\n";
 
 			// HTML
-			$message = "\n$text_boundary\n";
-			$message .= 'Content-type: text/html; charset='.$this->encoding."\n";
-			$message .= "Content-transfer-encoding: 8bit\n";
+			$message .= "$text_boundary\n";
+			$message .= 'Content-Type: text/html; charset='.$this->encoding."\n";
+			$message .= "Content-Transfer-Encoding: 8bit\n";
 			$message .= "\n".$this->message."\n";
 
-			$message = "\n$text_boundary\n";
+			$message .= "\n$text_boundary--\n";
 		}
 		else
 		{
-			$headers[] = 'Content-type: text/plain; charset='.$this->encoding;
-			$headers[] = 'Content-transfer-encoding: 8bit';
-			$message = "\n".strip_tags(preg_replace('#<br */?>#i', "/n", $this->message))."\n";
+			$headers[] = 'Content-Type: text/plain; charset='.$this->encoding;
+			$headers[] = 'Content-Transfer-Encoding: 8bit';
+			$message = "\n".strip_tags(preg_replace('#<br */?>#i', "\n", modify_lines($this->message)))."\n";
 		}
 
 		if ($_CORE_CONFIG['email']['smtp'])
 		{
 			$smtp = new smtp_mailer;
-
 			if ($connect = $smtp->connect($_CORE_CONFIG['email']['smtp_host'], $_CORE_CONFIG['email']['smtp_port']))
 			{
 				$login = $smtp->login($_CORE_CONFIG['email']['smtp_username'], $_CORE_CONFIG['email']['smtp_password']);
@@ -181,11 +187,11 @@
 				$this->error = $smtp->error;
 				return false;
 			}
-		
+
 			$smtp->subject = $this->subject;
 			$smtp->headers = $headers;
 			$smtp->message = $message;
-			$this->recipients = array_merge($this->address_arrays['to'], $this->address_arrays['cc'] , $this->address_arrays['bcc']);
+			$smtp->recipients = array_merge($this->address_arrays['to'], $this->address_arrays['cc'] , $this->address_arrays['bcc']);
 
 			if (!$smtp->send_mail())
 			{
@@ -197,7 +203,7 @@
 		}
 
 		if (function_exists($_CORE_CONFIG['email']['email_function_name']))
-		{
+		{			
 			$result = $_CORE_CONFIG['email']['email_function_name']($to, $this->subject, $message, implode("\n", $headers));
 
 			if (!$result)
@@ -237,15 +243,21 @@
 	{
 		$port = ((int) $port) ? (int) $port : 25;
 
-		$this->connection = fsockopen($host, $port, $errno, $errstr, 15);
+		//$host = 'tls://smtp.gmail.com';
+		//$port = 587;
 
-		if (!$this->connection)
+		$this->connection = fsockopen($host, $port, $errno, $errstr, 5);
+
+		if (!$this->connection || !$this->check_response(220))
 		{
+			$this->disconnect();
+
 			$this->error = 'Could not connect';
 			return false;
 		}
 		
 		$this->host = $host;
+		
 		return $this->connection;
 	}
 
@@ -259,12 +271,13 @@
 		fwrite($this->connection, "QUIT\r\n");
 		fclose($this->connection);
 
-		$this->connection = false;
+		$this->connection = false;
 	}
 	
 	// If login fails we disconnect, may do it differently later on
 	function login($user, $password)
 	{
+		$user = ''; $password='';
 		if (!$this->connection)
 		{
 			$this->error = 'No connection';
@@ -287,7 +300,13 @@
 				return false;
 			}
 		}
+		
+		if (!$user || !$password)
+		{
+			return true;
+		}
 
+		//base64_encode($username . " " . bin2hex(mhash(MHASH_MD5,$challenge,$password));
 		fwrite($this->connection, "AUTH LOGIN\r\n");
 
 		if (!$this->check_response(334))
@@ -341,7 +360,6 @@
 		// Let tell the server who to send this to.
 		foreach ($this->recipients as $email)
 		{
-			$email = trim($email);
 			$name = false;
 			
 			if (is_array($email))
@@ -350,9 +368,11 @@
 				$email = $email['address'];
 			}
 
+			$email = trim($email);
+
 			fwrite($this->connection, 'RCPT TO: <'.$email.">\r\n");
 
-			if (!$this->check_response(250))
+			if ($this->check_response(250))
 			{
 				$to_header[] = ($name) ? "$name <$email>" : "<$email>";
 			}
@@ -361,6 +381,7 @@
 		// Was any recipients accepted ?
 		if (empty($to_header))
 		{
+			$this->error = 'Nothing to send';
 			$this->disconnect();
 			return false;
 		}
@@ -389,16 +410,15 @@
 		return $status;
 	}
 
-	function check_response($code, $full = true)
+	function check_response($code)
 	{
 		$this->response = '';
 
-		while ($buffer = fgets($this->connection, 256))
+		while ($buffer = fgets($this->connection, 515))
 		{
 			$this->response .= $buffer;
 
-			//$buffer{strlen($this->response) - 1} == ' ' .... .maybe just check the ending ?
-			if ((!$full && strlen($this->response) >= 3) || substr($buffer, 3, 1) != ' ')
+			if (substr($buffer, 3, 1) == ' ')
 			{
 				break;
 			}
@@ -416,4 +436,31 @@
 	}
 }
 
+// Encodes the given string for proper display for this encoding ... nabbed 
+// from php.net and modified by phpBB.
+function mail_encode($str, $encoding)
+{
+	if ($encoding == '')
+	{
+		return $str;
+	}
+
+	// define start delimimter, end delimiter and spacer
+	$end = "?=";
+	$start = "=?$encoding?B?";
+	$spacer = "$end\r\n $start";
+
+	// determine length of encoded text within chunks and ensure length is even
+	$length = 75 - strlen($start) - strlen($end);
+	$length = floor($length / 2) * 2;
+
+	// encode the string and split it into chunks with spacers after each chunk
+	$str = chunk_split(base64_encode($str), $length, $spacer);
+
+	// remove trailing spacer and add start and end delimiters
+	$str = preg_replace('#' . preg_quote($spacer) . '$#', '', $str);
+
+	return $start . $str . $end;
+}
+
 ?>
\ No newline at end of file



From viperal at berlios.de  Tue Aug  9 06:10:05 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Tue, 9 Aug 2005 06:10:05 +0200
Subject: [Viperals-svncheckins] r79 - in trunk: . images/mimetypes images/smilies javascript
Message-ID: <200508090410.j794A5AZ004558@sheep.berlios.de>

Author: viperal
Date: 2005-08-09 06:09:50 +0200 (Tue, 09 Aug 2005)
New Revision: 79

Added:
   trunk/javascript/
   trunk/javascript/collapse.js
Removed:
   trunk/images/mimetypes/Thumbs.db
   trunk/images/smilies/Thumbs.db
   trunk/java/
Log:
renamed java to a more fitting name "javascript"

Deleted: trunk/images/mimetypes/Thumbs.db
===================================================================
(Binary files differ)

Deleted: trunk/images/smilies/Thumbs.db
===================================================================
(Binary files differ)

Copied: trunk/javascript (from rev 63, trunk/java)

Copied: trunk/javascript/collapse.js (from rev 78, trunk/java/collapse.js)



From viperal at berlios.de  Tue Aug  9 06:12:20 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Tue, 9 Aug 2005 06:12:20 +0200
Subject: [Viperals-svncheckins] r80 - trunk/javascript
Message-ID: <200508090412.j794CKAX004758@sheep.berlios.de>

Author: viperal
Date: 2005-08-09 06:12:16 +0200 (Tue, 09 Aug 2005)
New Revision: 80

Modified:
   trunk/javascript/collapse.js
Log:
Now add an updated collapse.js script

Modified: trunk/javascript/collapse.js
===================================================================
--- trunk/javascript/collapse.js	2005-08-09 04:09:50 UTC (rev 79)
+++ trunk/javascript/collapse.js	2005-08-09 04:12:16 UTC (rev 80)
@@ -1,26 +1,8 @@
 // Collapse Code by Ryan Marshall ( viperal1 at gmail.com )
+
+// If we use this on news, we need some kind of true gc.
+// May not be possible tho without some php stuff
 
-var collapsed_cookie = get_cookie('blocks_collapsed');
-
-if (collapsed_cookie != null)
-{
-	var collapsed_cookie = collapsed_cookie.split(':');
-	//blocks_collapsed.sort();
-	//for (var i in blocks_collapsed)
-	
-	var length = collapsed_cookie.length
-
-	for (var i = 0; i < length; i++)
-	{
-		blocks_collapsed[i] = blocks_collapsed.shift();
-	}
-}
-else
-{
-	var blocks_collapsed = new Array();
-}
-
-
 function get_cookie(Name)
 {
 	var cookie_name = Name + "=";
@@ -34,7 +16,7 @@
 		{
 			offset += cookie_name.length;
 			var end = document.cookie.indexOf(';', offset);
-			
+
 			if (end == -1)
 			{
 				end = cookie_length;
@@ -69,60 +51,82 @@
 	return null;
 }
 
-function switch_collapse(id, min, max)
+function switch_collapse_area(id, name)
 {
-	var img = document.getElementById(id);
+	var area = document.getElementById(id);
 
-	if (img.style.display == 'none')
+	if (area.style.display == 'none')
 	{
-		img.style.display = '';
+		area.style.display = '';
 		var value = null;
 	}
 	else
 	{
-		img.style.display = '';
+		area.style.display = 'none';
 		var value = id;
 	}
+
+	// typeof name == 'undefined'
+	if (!name)
+	{
+		name = 'collapsed_items';
+	}
+
+	// Best why to do it, if we don't want var name
+	// it's a small script, shouldn't have any noticable speed impact
+	var collapsed_cookie = get_cookie(name);
+	var collapsed_items = new Array();
 
-	var key = array_search(id, blocks_collapsed, false);
+	if (collapsed_cookie != null)
+	{
+		collapsed_cookie = collapsed_cookie.split(':');
+	
+		for (var i in collapsed_cookie)
+		{
+			collapsed_items[i] = collapsed_cookie[i];
+		}
+	}
 
+	var key = array_search(id, collapsed_items, false);
+
 	if (key != null)
 	{
 		if (value != null)
 		{
-			blocks_collapsed[key] == key;
+			collapsed_items[key] == key;
 		}
 		else
 		{
-			var tmp = new array();
+			var tmp = new Array();
 	
-			for (var i in blocks_collapsed)
+			for (var i in collapsed_items)
 			{
-				// We do it like this to get any duplicate values
-				if (blocks_collapsed[i] != id)
+				// We do it like this to get any duplicate values ( simple gc -- well not really )
+				if (collapsed_items[i] != id)
 				{
-					tmp.push(id);
+					tmp.push(collapsed_items[i]);
 				}
 			}
-
-			// not sure if this works
-			blocks_collapsed = tmp;
+
+			collapsed_items = tmp;
 		}
 	}
 	else
 	{
-		blocks_collapsed.push(id);
-	}
+		collapsed_items.push(id);
+	}
 
-	if (blocks_collapsed.length)
+	//alert(collapsed_items.join(':'));
+
+	if (collapsed_items.length)
 	{
 		var expires = new Date()
 
 		expires.setTime(expires.getTime() + 31536000000);
-		set_cookie('blocks_collapsed', blocks_collapsed.join(':'), expires)
+		set_cookie(name, collapsed_items.join(':'), expires)
 	}
 	else
 	{
-		delete_cookie('blocks_collapsed')
+		delete_cookie(name)
 	}
 }
\ No newline at end of file



From viperal at berlios.de  Wed Aug 10 04:42:10 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 10 Aug 2005 04:42:10 +0200
Subject: [Viperals-svncheckins] r81 - in trunk: . images/mimetypes images/smilies includes includes/auth includes/cache includes/db includes/display includes/forums javascript modules/Control_Panel/ucp modules/Forums modules/Quick_Message
Message-ID: <200508100242.j7A2gAPa027146@sheep.berlios.de>

Author: viperal
Date: 2005-08-10 04:42:08 +0200 (Wed, 10 Aug 2005)
New Revision: 81

Modified:
   trunk/core.php
   trunk/images/mimetypes/
   trunk/images/smilies/
   trunk/includes/auth/auth.php
   trunk/includes/cache/cache_file.php
   trunk/includes/core_rss.php
   trunk/includes/db/mssql.php
   trunk/includes/db/mysql.php
   trunk/includes/db/mysqli.php
   trunk/includes/db/postgres.php
   trunk/includes/display/blocks.php
   trunk/includes/display/display.php
   trunk/includes/forums/functions.php
   trunk/includes/forums/functions_messenger.php
   trunk/includes/forums/functions_posting.php
   trunk/includes/forums/functions_privmsgs.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/mailer.php
   trunk/includes/session.php
   trunk/includes/user.php
   trunk/javascript/collapse.js
   trunk/modules/Control_Panel/ucp/ucp_groups.php
   trunk/modules/Control_Panel/ucp/ucp_main.php
   trunk/modules/Control_Panel/ucp/ucp_pm.php
   trunk/modules/Control_Panel/ucp/ucp_pm_compose.php
   trunk/modules/Control_Panel/ucp/ucp_pm_options.php
   trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
   trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php
   trunk/modules/Control_Panel/ucp/ucp_profile.php
   trunk/modules/Forums/faq.php
   trunk/modules/Forums/posting.php
   trunk/modules/Forums/viewtopic.php
   trunk/modules/Quick_Message/index.php
Log:
Beginning of true UTF-8 (Unicode) support. Will adjust for older software versions ( mainly database ).

Extended collapse.js, should also perform better ( not like it was a problem :-) )

beginning of core auth changes, have alot of extending to do

Other changes ..

Modified: trunk/core.php
===================================================================
--- trunk/core.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/core.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -20,7 +20,8 @@
 
 set_magic_quotes_runtime(0);
 error_reporting(E_ALL);
-//error_reporting(0);
+mb_internal_encoding('UTF-8');
+//mb_http_output('UTF-8');
 
 // Remove registered globals
 if ((bool) ini_get('register_globals'))
@@ -29,21 +30,21 @@
 	{
 		unset($$var_name);
 	}
-	unset($variable, $value);
 }
 
-define('STRIP', get_magic_quotes_gpc());
+define('STRIP_SLASHES', get_magic_quotes_gpc());
 
 $starttime = explode(' ', microtime());
 $starttime = $starttime[1] + $starttime[0];
 
 // Move to index files
 $base_memory_usage = function_exists('memory_get_usage') ? memory_get_usage() : 0;
-           
+
 require($site_file_root.'includes/functions.php');
 require($site_file_root.'config.php');
 require($site_file_root.'includes/tables.php');
 require($site_file_root.'includes/handler.php');
+require($site_file_root.'includes/mailer.php');
 require($site_file_root.'includes/db/'.$site_db['type'].'.php');
 require($site_file_root.'includes/display/template.php');
 require($site_file_root.'includes/cache/cache.php');
@@ -57,7 +58,7 @@
 
 // Set error handler
 $_CLASS['core_error_handler']->start();
-$_CLASS['core_error_handler']->stop();
+//$_CLASS['core_error_handler']->stop();
 //error_reporting(E_ERROR | E_WARNING | E_PARSE);
 
 if (function_exists('register_shutdown_function'))
@@ -145,18 +146,4 @@
 	// error here
 }
 
-/*
-if ((time() - $config['cache_gc']) > $config['cache_last_gc'])
-{
-	//$_CLASS['core_cache']->gc();
-	set_config('cache_last_gc', time(), true);
-}
-
-// maybe add to register_shutdown_function()
-If ($_CORE_CONFIG['server']['optimize_rate'] && ($_CORE_CONFIG['server']['optimize_last'] + $_CORE_CONFIG['server']['optimize_rate']) < time())
-{
-	set_core_config('server', 'optimize_last', time());
-	$_CLASS['core_db']->sql_optimize_tables();
-	//optimize_cache();
-}*/
 ?>
\ No newline at end of file


Property changes on: trunk/images/mimetypes
___________________________________________________________________
Name: svn:ignore
   + Thumbs.db



Property changes on: trunk/images/smilies
___________________________________________________________________
Name: svn:ignore
   + Thumbs.db


Modified: trunk/includes/auth/auth.php
===================================================================
--- trunk/includes/auth/auth.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/auth/auth.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -283,10 +283,8 @@
 	{
 		global $_CLASS, $site_file_root;
 
-		$options['groups_allowed'] = empty($options['groups_allowed']) ? array() : $options['groups_allowed'];
-		$options['users_allowed'] = empty($options['users_allowed']) ? array() : $options['users_allowed'];
-		$options['groups_disallowed'] = empty($options['groups_disallowed']) ? array() : $options['groups_disallowed'];
-		$options['users_disallowed'] = empty($options['users_disallowed']) ? array() : $options['users_disallowed'];
+		$options['groups'] = empty($options['groups']) ? array() : $options['groups'];
+		$options['users'] = empty($options['users']) ? array() : $options['users'];
 
 		$mode = $return = false;
 		$checks = array('add', 'remove', 'set');
@@ -308,57 +306,72 @@
 			switch ($mode)
 			{
 				case 'add':
-					// Allowed
 					$setup['groups'] = get_variable('groups_add', 'POST', array(), 'array');
 					$setup['users'] = explode("\n", get_variable('users_add', 'POST'));
-		
+
 					if (count($setup['users']))
 					{
-						$ids['users'] = user_get_id($setup['users']);
+						$setup['users'] = user_get_id($setup['users']);
 					}
-		
+
 					if (count($setup['groups']))
 					{
 						$sql = 'SELECT group_id
 							FROM ' . GROUPS_TABLE . '
 							WHERE group_id IN ('.implode(', ', array_map('intval', $setup['groups'])).')';
 						$result = $_CLASS['core_db']->query($sql);
-		
+
+						$setup['groups'] = array();
+
 						while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 						{
-							$ids['groups'][] = $row['group_id'];
+							$setup['groups'][] = $row['group_id'];
 						}
 						$_CLASS['core_db']->free_result($result);
 					}
 
-					$function = (true) ? 'array_merge' : 'array_diff';
+					foreach ($setup['groups'] as $id)
+					{
+						$options['groups'][$id] = array('status' => 1);
+					}
 
-					$options['groups_allowed'] = $function($options['groups_allowed'], $ids['groups']);
-					$options['users_allowed'] = $function($options['users_allowed'], $ids['users']);
+					foreach ($setup['users'] as $id)
+					{
+						$options['users'][$id] = array('status' => 1);
+					}
+
+					unset($setup);
+					//print_r($options);
 				break;
-			
-				case 'ss':
-					$options['groups_disallowed'] = array_diff(array_merge($options['groups_disallowed'], $dg_add), $dg_remove, $options['groups_allowed']);
-					$options['users_disallowed'] = array_diff(array_merge($options['users_disallowed'], $user_ids['disallowed']), $du_remove, $options['users_allowed']);
-		
-					print_r($ids);
-					die;
-					$current['groups_allowed'] = get_variable('g_current', 'POST', array(), 'array');
-					$current['users_allowed'] = get_variable('u_current', 'POST', array(), 'array');
-					$current['groups_disallowed'] = get_variable('dg_current', 'POST', array(), 'array');
-					$current['users_disallowed'] = get_variable('du_current', 'POST', array(), 'array');
-		
-			
-		
-					$options['groups_allowed'] = array_diff(array_merge($options['groups_allowed'], $g_add), $g_remove);
-					$options['users_allowed'] = array_diff(array_merge($options['users_allowed'], $user_ids['allowed']), $u_remove);
-			
-					$options['groups_disallowed'] = array_diff(array_merge($options['groups_disallowed'], $dg_add), $dg_remove, $options['groups_allowed']);
-					$options['users_disallowed'] = array_diff(array_merge($options['users_disallowed'], $user_ids['disallowed']), $du_remove, $options['users_allowed']);
-		
-					$return = null;
+
+				case 'remove':
+					$ids['groups'] = array_map('intval', get_variable('groups_current', 'POST', array(), 'array'));
+					$ids['users'] = array_map('intval', get_variable('users_current', 'POST', array(), 'array'));
 					
+					$function = ($mode == 'add') ? 'array_merge' : 'array_diff';
+
+					foreach ($options['groups'] as $key => $ignore)
+					{
+						if (in_array($key, $ids['groups']))
+						{
+							unset($options['groups'][$key]);
+						}
+					}
+
+					foreach ($options['users'] as $key => $ignore)
+					{
+						if (in_array($key, $ids['users']))
+						{
+							unset($options['users'][$key]);
+						}
+					}
+
+					//print_r($options);
 				break;
+			
+				case 'set':
+
+				break;
 			}
 
 			foreach ($options as $option)
@@ -370,39 +383,38 @@
 				}
 			}
 		}
+
 		$group_list = $allowed_group_list = $disallowed_group_list = $allowed_user_list = $disallowed_user_list = '';
+		$groups_ids = array_keys($options['users']);
 
-		$set_users = array_merge($options['users_allowed'], $options['users_disallowed']);
-		$set_groups = array_merge($options['groups_allowed'], $options['groups_disallowed']);
-
-		if (count($set_users))
+		if (!empty($options['users']))
 		{
 			$sql = 'SELECT user_id, username, user_colour
 				FROM ' . USERS_TABLE . '
-				WHERE user_id IN ('.implode(', ', $set_users).')
+				WHERE user_id IN ('.implode(', ', array_keys($options['users'])).')
 					ORDER BY username';
 			$result = $_CLASS['core_db']->query($sql);
 
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$user_list = (in_array($row['user_id'], $options['users_allowed'])) ? 'allowed_user_list' : 'disallowed_user_list';
+				$user_list = ($options['users'][$row['user_id']]['status'] === 1) ? 'allowed_user_list' : 'disallowed_user_list';
 
 				$$user_list .= '<option ' . (($row['user_colour']) ? ' style="color: #'.$row['user_colour'].';"' : '') . ' value="' . $row['user_id'] . '">' . $row['username'] . '</option>';
 			}
 			$_CLASS['core_db']->free_result($result);
 		}
 
-		if (count($set_groups))
+		if (!empty($groups_ids))
 		{
 			$sql = 'SELECT group_id, group_name, group_type 
 				FROM ' . GROUPS_TABLE . '
-				WHERE group_id IN ('.implode(', ', $set_groups).')
+				WHERE group_id IN ('.implode(', ', array_keys($options['groups'])).')
 					ORDER BY group_type DESC, group_name';
 			$result = $_CLASS['core_db']->query($sql);
 
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$group_list = (in_array($row['group_id'], $options['groups_allowed'])) ? 'allowed_group_list' : 'disallowed_group_list';
+				$group_list = ($options['groups'][$row['group_id']]['status'] === 1) ? 'allowed_group_list' : 'disallowed_group_list';
 				
 				$$group_list .= '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
 				
@@ -412,7 +424,7 @@
 
 		$sql = 'SELECT group_id, group_name, group_type 
 			FROM ' . GROUPS_TABLE . 
-				((!empty($set_groups)) ? ' WHERE group_id NOT IN ('.implode(', ', $set_groups).')' : '').'
+				(empty($groups_ids) ? '' : ' WHERE group_id NOT IN ('.implode(', ', $groups_ids).')').'
 					ORDER BY group_type DESC, group_name';
 		$result = $_CLASS['core_db']->query($sql);
 

Modified: trunk/includes/cache/cache_file.php
===================================================================
--- trunk/includes/cache/cache_file.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/cache/cache_file.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -58,13 +58,7 @@
 
 		$file_data = "<?php $protection_code \$this->vars['$name'] = ".var_export($data, true)."; \n\$this->expires['$name'] = $expires;  ?>";
 
-		if ($fp = @fopen($this->cache_dir . "cache_$name.php", 'wb'))
-		{
-			@flock($fp, LOCK_EX);
-			fwrite($fp, $file_data);
-			@flock($fp, LOCK_UN);
-			fclose($fp);
-		}
+		file_put_contents($this->cache_dir."cache_$name.php", $file_data);
 
 		$this->vars[$name] = $data;
 		$this->expires[$name] = $expires;

Modified: trunk/includes/core_rss.php
===================================================================
--- trunk/includes/core_rss.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/core_rss.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -125,17 +125,17 @@
 
 		$data = strtolower(trim(fgets($this->fp, 300)));
 
-		if (strpos($data, '200') === false)
+		if (mb_strpos($data, '200') === false)
 		{
 			echo $data;
 
-			if (strpos($data, '301') === true || strpos($data, '301') === true)
+			if (mb_strpos($data, '301') === true || mb_strpos($data, '301') === true)
 			{
 				while (!empty($data))
 				{
 					$data = strtolower(trim(fgets($this->fp, 300)));
 
-					if (strpos('location:', $data) == true)
+					if (mb_strpos('location:', $data) == true)
 					{
 						$new_url = trim(eregi_replace('location:', '', $data));
 						
@@ -161,19 +161,19 @@
 		{
 			$data = strtolower(trim(fgets($this->fp, 300)));
 			
-			if (strpos($data, 'content-type') !== false && strpos($data, 'xml') === false)
+			if (mb_strpos($data, 'content-type') !== false && mb_strpos($data, 'xml') === false)
 			{
 				$this->Close_connection();
 				$this->error = 'Document type is invalid';
 				return false;
 			}
 			
-			if (strpos($data, 'last-modified') !== false)
+			if (mb_strpos($data, 'last-modified') !== false)
 			{
 				//
 			}
 
-			if (strpos($data, 'content-encoding') !== false && strpos($data, 'gzip') !== false)
+			if (mb_strpos($data, 'content-encoding') !== false && mb_strpos($data, 'gzip') !== false)
 			{
 				$compressed = true;
 			}
@@ -232,7 +232,7 @@
 
 		$element = strtolower($element);
 
-		if (strpos($element, ':'))
+		if (mb_strpos($element, ':'))
 		{
 			list($element) = explode(':', $element, 2);
 		}
@@ -319,7 +319,7 @@
 	{
 		$element = strtolower($element);
 
-		if (strpos($element, ':' ))
+		if (mb_strpos($element, ':' ))
 		{
 			list($element) = explode(':', $element, 2);
 		}

Modified: trunk/includes/db/mssql.php
===================================================================
--- trunk/includes/db/mssql.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/db/mssql.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -545,8 +545,11 @@
 				{
 					$fields .= ", \n";
 				}
+				
+				//#MyTempTable -- local temp tables
+				//##MyTempTable -- Global temp tables
 
-				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB;";
+				$table = 'CREATE TABLE ['.$this->_table_name."] ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB;";
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
 				if ($option == 'return')

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/db/mysql.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -16,7 +16,7 @@
 class db_mysql
 {
 	var $link_identifier = false;
-	var $db_layer = 'mysql4';
+	var $db_layer = 'mysql';
 
 	var $last_result;
 	var $return_on_error;
@@ -46,11 +46,22 @@
 		}
 
 		$this->link_identifier = ($db['persistent']) ? @mysql_pconnect($db['server'], $db['username'], $db['password']) : @mysql_connect($db['server'], $db['username'], $db['password']);
-
 		if ($this->link_identifier)
 		{
 			if (@mysql_select_db($db['database']))
 			{
+				mysql_query('SET NAMES utf8',$this->link_identifier);
+
+				//mysql_query('SET character_set_results = NULL', $this->link_identifier);
+
+				/*
+				$result = mysql_query("show variables like 'col%'",$this->link_identifier);
+				while ($value = mysql_fetch_assoc($result))
+				{
+					print_r($value);
+					echo '<br>';
+				}
+				*/
 				return $this->link_identifier;
 			}
 
@@ -177,7 +188,7 @@
 
 	function sql_query($query = false)
 	{
-		return @mysql_query($query, $this->link_identifier);
+		return mysql_query($query, $this->link_identifier);
 	}
 
 	function query_limit($query = false, $total = false, $offset = 0, $backtrace = false) 
@@ -319,7 +330,7 @@
 		return @mysql_fetch_array($result);
 	}
 	
-	function insert_id()
+	function insert_id($table, $column)
 	{
 		return ($this->link_identifier) ? @mysql_insert_id($this->link_identifier) : false;
 	}
@@ -502,7 +513,7 @@
 					$fields .= ", \n";
 				}
 
-				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB;";
+				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
 				if ($option == 'return')

Modified: trunk/includes/db/mysqli.php
===================================================================
--- trunk/includes/db/mysqli.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/db/mysqli.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -51,6 +51,11 @@
 		{
 			if (@mysqli_select_db($this->link_identifier, $db['database']))
 			{
+				mysqli_query($this->link_identifier, 'SET NAMES utf8');
+
+				//mysqli_query($this->link_identifier, 'SET character_set_results = NULL');
+				//mysqli_set_charset($this->link_identifier, "utf8");
+
 				return $this->link_identifier;
 			}
 
@@ -260,7 +265,7 @@
 				{
 					$values[] = "$key = '" . $this->escape($value) . "'";
 				}
-				elseif (is_null($var))
+				elseif (is_null($value))
 				{
 					$values[] = "$key = NULL";
 				}
@@ -329,7 +334,7 @@
 		return @mysqli_fetch_array($result);
 	}
 
-	function insert_id()
+	function insert_id($table, $column)
 	{
 		return ($this->link_identifier) ? @mysqli_insert_id($this->link_identifier) : false;
 	}
@@ -509,7 +514,7 @@
 					$fields .= ", \n";
 				}
 
-				$table = 'CREATE TABLE '.$this->table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB;";
+				$table = 'CREATE TABLE '.$this->table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
 				if ($option == 'return')

Modified: trunk/includes/db/postgres.php
===================================================================
--- trunk/includes/db/postgres.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/db/postgres.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -72,6 +72,8 @@
 
 		if ($this->link_identifier)
 		{
+			pg_set_client_encoding($this->link_identifier, 'UNICODE');
+			//pg_query($this->link_identifier, "SET CLIENT_ENCODING TO 'value'"); SET NAMES 'value'
 			return $this->link_identifier;
 		}
 
@@ -522,10 +524,10 @@
 				$fields = implode(", \n", $this->_fields);
 				$indexs = ($this->_indexs) ? "\n\n".implode("\n", $this->_indexs) :  '';
 
-				$oid = ($this->_table_oid) ? ' WITH OIDS' : ' WITHOUT OIDS';
+				$oid = ($this->_table_oid) ? 'WITH OIDS' : 'WITHOUT OIDS';
 
-				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields." \n )\n$oid;$indexs";
-
+				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields." \n )\n $oid;$indexs";
+//WITH ENCODING='UNICODE'  ( for create table )
 				if ($option == 'return')
 				{
 					return $table;

Modified: trunk/includes/display/blocks.php
===================================================================
--- trunk/includes/display/blocks.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/display/blocks.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -283,16 +283,14 @@
 		$postion = ($this->block['position'] == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
 		
 		$_CLASS['core_template']->assign_vars_array('message_block_'.$postion, array(
-				'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['title']),
-				'TITLE'		=> $this->block['title'],
-				'CONTENT'	=> $this->block['content'],
-				'EXPIRES'	=> $expires,
-				'EDIT_LINK'	=> $edit_link,
-				'L_EDIT'	=> $_CLASS['core_user']->lang['EDIT'],
-				'HIDE'		=> hideblock($this->block['id']) ? 'style="display: none"' : '',
-				'ID'		=> $this->block['id'],
-			)
-		);
+				//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['title']),
+				'title'		=> $this->block['title'],
+				'collapsed'	=> collapsed_items('block_'.$this->block['id']),
+				'content'	=> $this->block['content'],
+				'expires'	=> $expires,
+				'edit_link'	=> $edit_link,
+				'id'		=> $this->block['id'],
+		));
 	}
 	
 	function block_side()
@@ -302,14 +300,12 @@
 		$position = ($this->block['position'] == BLOCK_RIGHT) ? 'right' : 'left';
 		
 		$_CLASS['core_template']->assign_vars_array('block_'.$position, array(
-			'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['title']),
-			'TITLE'		=> $this->block['title'],
-			'CONTENT'	=> $this->content,
-			'ID'		=> $this->block['id'],
-			'COLLAPSE'	=> hideblock($this->block['id']) ? 'style="display: none"' : '',
-			'TEMPLATE'	=> $this->template,
-			)
-		);
+			//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['title']),
+			'title'		=> $this->block['title'],
+			'content'	=> $this->content,
+			'collapsed'	=> collapsed_items('block_'.$this->block['id']),
+			'id'		=> $this->block['id'],
+		));
 	}
 	
 	function block_html()
@@ -389,8 +385,7 @@
 			$this->block['rss_expires'] = ($this->block['rss_rate']) ? time() + $this->block['rss_rate'] : 0;
 			
 			$sql = 'UPDATE '.BLOCKS_TABLE."
-				SET content='".$_CLASS['core_db']->escape($this->content)."'
-				, rss_expires='".$this->block['rss_expires']."' 
+				SET content='".$_CLASS['core_db']->escape($this->content)."', rss_expires='".$this->block['rss_expires']."' 
 					WHERE id=".$this->block['id'];
 				
 			$_CLASS['core_db']->query($sql);

Modified: trunk/includes/display/display.php
===================================================================
--- trunk/includes/display/display.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/display/display.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -88,7 +88,7 @@
 	{
 		global $_CLASS;
 
-		header('Content-Type: text/html; charset='.$_CLASS['core_user']->lang['ENCODING']);
+		header('Content-Type: text/html; charset=UTF-8');
 		header('Content-language: ' . $_CLASS['core_user']->lang['LANG']);
 
 		header('P3P: CP="CAO DSP COR CURa ADMa DEVa OUR IND PHY ONL UNI COM NAV INT DEM PRE"');
@@ -162,7 +162,7 @@
 			'SITE_LANG'			=>	$_CLASS['core_user']->lang['LANG'],
 			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.$_CORE_MODULE['title'],
 			'SITE_BASE'			=>	generate_base_url(),
-			'SITE_CHARSET'		=>	$_CLASS['core_user']->lang['ENCODING'],
+			'SITE_CHARSET'		=>	'UTF-8',
 			'SITE_NAME'			=>	$_CORE_CONFIG['global']['site_name'],
 			'SITE_URL'			=>	$_CORE_CONFIG['global']['site_url'],
 			'HEADER_MESSAGE'	=>	$this->message,
@@ -196,7 +196,6 @@
 		if (!$this->displayed['header'])
 		{
 			script_close($save);
-			die;
 		}
 
 		if ($_CORE_MODULE = $this->get_module())
@@ -228,7 +227,7 @@
 	*/
 	function footer_debug()
 	{
-		global $_CORE_CONFIG, $SID, $mainindex, $SID, $_CLASS, $starttime;
+		global $_CORE_CONFIG, $_CLASS, $starttime;
 
 		$mtime = explode(' ', microtime());
 		$totaltime = ($mtime[0] + $mtime[1] - $starttime) - $_CLASS['core_db']->queries_time;
@@ -290,6 +289,19 @@
 	}
 }
 
+function collapsed_items($marker, $cookie = 'collapsed_items') 
+{
+    static $collapsed_items_array = array();
+
+    if (!isset($collapsed_items_array[$cookie]))
+    {
+		$cookie_data = get_variable($cookie, 'COOKIE');
+		$collapsed_items_array[$cookie] = ($cookie_data) ? explode(':', $cookie_data) : array();
+    }
+
+    return in_array($marker, $collapsed_items_array[$cookie]);
+}
+
 function hideblock($id) 
 {
     // From cpgnuke - http://dragonflycms.org/

Modified: trunk/includes/forums/functions.php
===================================================================
--- trunk/includes/forums/functions.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/forums/functions.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -497,8 +497,6 @@
 	return;
 }
 
-// Pick a language, any language ...
-// this need replacing big time
 function language_select($default = '')
 {
 }
@@ -1013,12 +1011,10 @@
 }
 
 // Generate forum login box
-function login_forum_box(&$forum_data)
+function login_forum_box($forum_data)
 {
 	global $config, $_CLASS;
 
-	$password = request_var('password', '');
-
 	$sql = 'SELECT forum_id
 		FROM ' . FORUMS_ACCESS_TABLE ."
 		WHERE forum_id = '".$forum_data['forum_id']."'
@@ -1033,6 +1029,8 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
+	$password = request_var('password', '');
+
 	if ($password)
 	{
 		// Remove expired authorised sessions
@@ -1067,14 +1065,11 @@
 		$_CLASS['core_template']->assign('LOGIN_ERROR', $_CLASS['core_user']->lang['WRONG_PASSWORD']);
 	}
 	
-	$_CLASS['core_display']->display_head();
-
 	page_header();
 	
 	$_CLASS['core_template']->display('modules/Forums/login_forum.html');
 
-	$_CLASS['core_display']->display_footer();
-
+	script_close();
 }
 
 // Bump Topic Check - used by posting and viewtopic
@@ -1431,7 +1426,7 @@
 		'S_USER_LANG'			=> $_CLASS['core_user']->data['user_lang'], 
 		'S_USER_BROWSER' 		=> ($_CLASS['core_user']->data['session_browser']) ? $_CLASS['core_user']->data['session_browser'] : $_CLASS['core_user']->lang['UNKNOWN_BROWSER'],
 		'S_CONTENT_DIRECTION' 	=> $_CLASS['core_user']->lang['DIRECTION'],
-		'S_CONTENT_ENCODING' 	=> $_CLASS['core_user']->lang['ENCODING'],
+		'S_CONTENT_ENCODING' 	=> 'UTF-8',
 		'S_CONTENT_DIR_LEFT' 	=> $_CLASS['core_user']->lang['LEFT'],
 		'S_CONTENT_DIR_RIGHT' 	=> $_CLASS['core_user']->lang['RIGHT'],
 		'S_TIMEZONE'			=> ($_CLASS['core_user']->data['user_dst'] || (!$_CLASS['core_user']->is_user && $_CORE_CONFIG['global']['default_dst'])) ? sprintf($_CLASS['core_user']->lang['ALL_TIMES'], $_CLASS['core_user']->lang['tz'][$tz/3600], $_CLASS['core_user']->lang['tz']['dst']) : sprintf($_CLASS['core_user']->lang['ALL_TIMES'], $_CLASS['core_user']->lang['tz'][$tz/3600], ''),
@@ -1454,37 +1449,7 @@
 		'TRANSLATION_INFO'	=> 'Ported by <a href="http://www.viperal.com/" target="viperal">Viperal</a>',
 		'U_ACP'				=> ($_CLASS['core_user']->is_admin && $_CLASS['auth']->acl_get('a_')) ? generate_link('Forums', array('admin' => true)) : '',
 		'L_ACP'				=> $_CLASS['core_user']->lang['ACP']
-		)
-	);
-	
-/*	// Call cron-type script
-	if (!defined('IN_CRON'))
-	{
-		$cron_type = '';
-
-		if (time() - $config['queue_interval'] > $config['last_queue_run'] && !defined('IN_ADMIN') && file_exists($phpbb_root_path . 'cache/queue.' . $phpEx))
-		{
-			// Process email queue
-			$cron_type = 'queue';
-		}
-		else if (method_exists($cache, 'tidy') && time() - $config['cache_gc'] > $config['cache_last_gc'])
-		{
-			// Tidy the cache
-			$cron_type = 'tidy_cache';
-		}
-		else if (time() - (7 * 24 * 3600) > $config['database_last_gc'])
-		{
-			// Tidy some table rows every week
-			$cron_type = 'tidy_database';
-		}
-
-		if ($cron_type)
-		{
-			echo 'test';
-			$_CLASS['core_template']->assign('RUN_CRON_TASK', '<img src="'.generate_link('Forums&file=cron&cron_type=' . $cron_type).'" width="1" height="1" />');
-		}
-	}
-	return;*/
+	));
 }
 
 ?>
\ No newline at end of file

Modified: trunk/includes/forums/functions_messenger.php
===================================================================
--- trunk/includes/forums/functions_messenger.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/forums/functions_messenger.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -1198,6 +1198,7 @@
 // from php.net and modified. There is an alternative encoding method which 
 // may produce less output but it's questionable as to its worth in this 
 // scenario IMO
+/*
 function mail_encode($str, $encoding)
 {
 	if ($encoding == '')
@@ -1221,6 +1222,6 @@
 	$str = preg_replace('#' . preg_quote($spacer) . '$#', '', $str);
 
 	return $start . $str . $end;
-}
+}*/
 
 ?>
\ No newline at end of file

Modified: trunk/includes/forums/functions_posting.php
===================================================================
--- trunk/includes/forums/functions_posting.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/forums/functions_posting.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -86,6 +86,8 @@
 
 		$_CLASS['core_template']->assign('T_SMILIES_PATH', "{$config['smilies_path']}/");
 		$_CLASS['core_template']->display('modules/Forums/posting_smilies.html');
+
+		script_close();
 	}
 }
 

Modified: trunk/includes/forums/functions_privmsgs.php
===================================================================
--- trunk/includes/forums/functions_privmsgs.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/forums/functions_privmsgs.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -128,15 +128,15 @@
 		WHERE user_id = $user_id
 			AND folder_id <> " . PRIVMSGS_NO_BOX . '
 		GROUP BY folder_id';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	$num_messages = $num_unread = array();
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$num_messages[(int) $row['folder_id']] = $row['num_messages'];
 		$num_unread[(int) $row['folder_id']] = $row['num_unread'];
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	// Make sure the default boxes are defined
 	foreach (array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX) as $default_folder)
@@ -161,13 +161,13 @@
 	$sql = 'SELECT folder_id, folder_name, pm_count
 		FROM ' . PRIVMSGS_FOLDER_TABLE . "
 			WHERE user_id = $user_id";
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 			
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$folder[$row['folder_id']] = array('folder_name' => $row['folder_name'], 'num_messages' => $row['pm_count'], 'unread_messages' => ((isset($num_unread[$row['folder_id']])) ? $num_unread[$row['folder_id']] : 0));
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	$folder[PRIVMSGS_OUTBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_OUTBOX'], 'num_messages' => $num_messages[PRIVMSGS_OUTBOX], 'unread_messages' => $num_unread[PRIVMSGS_OUTBOX]);
 	$folder[PRIVMSGS_SENTBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_SENTBOX'], 'num_messages' => $num_messages[PRIVMSGS_SENTBOX], 'unread_messages' => $num_unread[PRIVMSGS_SENTBOX]);
@@ -207,14 +207,14 @@
 				AND t.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 				AND t.folder_id = ' . PRIVMSGS_SENTBOX . '
 			ORDER BY p.message_time ASC';
-		$result = $_CLASS['core_db']->sql_query_limit($sql, ($num_sentbox_messages - $message_limit));
+		$result = $_CLASS['core_db']->query_limit($sql, ($num_sentbox_messages - $message_limit));
 
 		$delete_ids = array();
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$delete_ids[] = $row['msg_id'];
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 		delete_pm($_CLASS['core_user']->data['user_id'], $delete_ids, PRIVMSGS_SENTBOX);
 	}
 }
@@ -284,23 +284,23 @@
 		$sql = 'SELECT * 
 			FROM ' . PRIVMSGS_RULES_TABLE . "
 			WHERE user_id = $user_id";
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		$user_rules = $_CLASS['core_db']->sql_fetchrowset($result);
-		$_CLASS['core_db']->sql_freeresult($result);
+		$user_rules = $_CLASS['core_db']->fetch_row_assocset($result);
+		$_CLASS['core_db']->free_result($result);
 
 		if (sizeof($user_rules))
 		{
 			$sql = 'SELECT zebra_id, friend, foe
 				FROM ' . ZEBRA_TABLE . "
 				WHERE user_id = $user_id";
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$zebra[$row['zebra_id']] = $row;
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 		}
 	}
 
@@ -310,7 +310,7 @@
 			SET folder_id = ' . PRIVMSGS_NO_BOX . '
 			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . "
 				AND user_id = $user_id";
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 
 	// Get those messages not yet placed into any box
@@ -321,10 +321,10 @@
 			AND p.author_id = u.user_id
 			AND t.folder_id = " . PRIVMSGS_NO_BOX . '
 			AND t.msg_id = p.msg_id';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	$action_ary = $move_into_folder = array();
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$row['to']		= explode(':', $row['to_address']);
 		$row['bcc']		= explode(':', $row['bcc_address']);
@@ -349,7 +349,7 @@
 			$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
 		}
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	// We place actions into arrays, to save queries.
 	$num_new = $num_unread = 0;
@@ -424,7 +424,7 @@
 			WHERE msg_id IN (' . implode(', ', $unread_ids) . ")
 				AND user_id = $user_id
 				AND folder_id = " . PRIVMSGS_NO_BOX;
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 
 	// mark messages as important
@@ -435,7 +435,7 @@
 			WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
 				AND user_id = $user_id
 				AND msg_id IN (" . implode(', ', $important_ids) . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 
 	// Move into folder
@@ -450,13 +450,13 @@
 			FROM ' . PRIVMSGS_FOLDER_TABLE . '
 			WHERE folder_id IN (' . implode(', ', array_keys($move_into_folder)) . (($full_folder_action >= 0) ? ', ' . $full_folder_action : '') . ")
 				AND user_id = $user_id";
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$folder[(int) $row['folder_id']] = (int) $row['pm_count'];
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
 		if (in_array(PRIVMSGS_INBOX, array_keys($move_into_folder)))
 		{
@@ -465,10 +465,10 @@
 				WHERE user_id = $user_id
 					AND folder_id = " . PRIVMSGS_INBOX . "
 				GROUP BY folder_id";
-			$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
+			$result = $_CLASS['core_db']->query_limit($sql, 1);
 			
 			$folder[PRIVMSGS_INBOX] = (int) $_CLASS['core_db']->sql_fetchfield('num_messages', 0, $result);
-			$_CLASS['core_db']->sql_freeresult($result);			
+			$_CLASS['core_db']->free_result($result);			
 		}
 	}
 
@@ -506,14 +506,14 @@
 						AND t.user_id = $user_id
 						AND t.folder_id = $dest_folder
 					ORDER BY p.message_time ASC";
-				$result = $_CLASS['core_db']->sql_query_limit($sql, (($folder[$dest_folder] + sizeof($msg_ary)) - $message_limit));
+				$result = $_CLASS['core_db']->query_limit($sql, (($folder[$dest_folder] + sizeof($msg_ary)) - $message_limit));
 
 				$delete_ids = array();
-				while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
 					$delete_ids[] = $row['msg_id'];
 				}
-				$_CLASS['core_db']->sql_freeresult($result);
+				$_CLASS['core_db']->free_result($result);
 				delete_pm($user_id, $delete_ids, $dest_folder);
 			}
 		}
@@ -526,7 +526,7 @@
 				WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
 					AND user_id = $user_id
 					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 		}
 		else
 		{
@@ -536,7 +536,7 @@
 					AND user_id = $user_id
 					AND new = 1
 					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			if ($dest_folder != PRIVMSGS_INBOX)
 			{
@@ -544,7 +544,7 @@
 					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']->sql_affectedrows() . "
 					WHERE folder_id = $dest_folder
 						AND user_id = $user_id";
-				$_CLASS['core_db']->sql_query($sql);
+				$_CLASS['core_db']->query($sql);
 			}
 			else
 			{
@@ -561,7 +561,7 @@
 			SET folder_id = ' . PRIVMSGS_SENTBOX . '
 			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
 				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 
 	// Update unread and new status field
@@ -574,7 +574,7 @@
 			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
 		}
 		
-		$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
+		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
 		$_CLASS['core_user']->data['user_new_privmsg'] -= $num_new;
 		$_CLASS['core_user']->data['user_unread_privmsg'] -= $num_unread;
 	}
@@ -604,13 +604,13 @@
 				FROM ' . PRIVMSGS_FOLDER_TABLE . "
 				WHERE folder_id = $dest_folder
 					AND user_id = $user_id";
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 
-			if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
+			if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
 			{
 				trigger_error('NOT_AUTHORIZED');
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 
 			if ($row['pm_count'] + sizeof($move_msg_ids) > $message_limit)
 			{
@@ -625,7 +625,7 @@
 				FROM ' . PRIVMSGS_TO_TABLE . '
 				WHERE folder_id = ' . PRIVMSGS_INBOX . "
 					AND user_id = $user_id";
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 			if ($_CLASS['core_db']->sql_fetchfield('num_messages', 0, $result) + sizeof($move_msg_ids) > $message_limit)
 			{
 				$message = sprintf($_CLASS['core_user']->lang['NOT_ENOUGH_SPACE_FOLDER'], $_CLASS['core_user']->lang['PM_INBOX']) . '<br /><br />';
@@ -639,7 +639,7 @@
 			WHERE folder_id = $cur_folder_id
 				AND user_id = $user_id
 				AND msg_id IN (" . implode(', ', $move_msg_ids) . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 		$num_moved = $_CLASS['core_db']->sql_affectedrows();
 
 		// Update pm counts
@@ -651,7 +651,7 @@
 					SET pm_count = pm_count - $num_moved
 					WHERE folder_id = $cur_folder_id
 						AND user_id = $user_id";
-				$_CLASS['core_db']->sql_query($sql);
+				$_CLASS['core_db']->query($sql);
 			}
 
 			if ($dest_folder != PRIVMSGS_INBOX)
@@ -660,7 +660,7 @@
 					SET pm_count = pm_count + $num_moved
 					WHERE folder_id = $dest_folder
 						AND user_id = $user_id";
-				$_CLASS['core_db']->sql_query($sql);
+				$_CLASS['core_db']->query($sql);
 			}
 		}
 	}
@@ -683,12 +683,12 @@
 		WHERE msg_id = $msg_id
 			AND user_id = $user_id
 			AND folder_id = $folder_id";
-	$_CLASS['core_db']->sql_query($sql);
+	$_CLASS['core_db']->query($sql);
 
 	$sql = 'UPDATE ' . USERS_TABLE . " 
 		SET user_unread_privmsg = user_unread_privmsg - 1
 		WHERE user_id = $user_id";
-	$_CLASS['core_db']->sql_query($sql);
+	$_CLASS['core_db']->query($sql);
 }
 
 // Handle all actions possible with marked messages
@@ -714,7 +714,7 @@
 				WHERE folder_id = $cur_folder_id
 					AND user_id = $user_id
 					AND msg_id IN (" . implode(', ', $msg_ids) . ')';
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			break;
 
@@ -802,18 +802,18 @@
 		WHERE msg_id IN (' . implode(', ', array_map('intval', $msg_ids)) . ")
 			AND folder_id = $folder_id
 			AND user_id = $user_id";
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	$delete_rows = array();
 	$num_unread = $num_new = $num_deleted = 0;
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$num_unread += (int) $row['unread'];
 		$num_new += (int) $row['new'];
 
 		$delete_rows[$row['msg_id']] = 1;
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 	unset($msg_ids);
 
 	if (!sizeof($delete_rows))
@@ -829,19 +829,19 @@
 		$sql = 'DELETE FROM ' . PRIVMSGS_TO_TABLE . "
 			WHERE user_id = $user_id AND folder_id = " . PRIVMSGS_OUTBOX . '
 				AND msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		// Update PM Information for safety
 		$sql = 'UPDATE ' . PRIVMSGS_TABLE . " SET message_text = ''
 			WHERE msg_id IN (" . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		// Set delete flag for those intended to receive the PM
 		// We do not remove the message actually, to retain some basic informations (sent time for example)
 		$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . '
 			SET deleted = 1
 			WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		$num_deleted = $_CLASS['core_db']->sql_affectedrows();
 	}
@@ -852,7 +852,7 @@
 			WHERE user_id = $user_id
 				AND folder_id = $folder_id
 				AND msg_id IN (" . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 		$num_deleted = $_CLASS['core_db']->sql_affectedrows();
 	}
 
@@ -862,7 +862,7 @@
 		$sql = 'UPDATE ' . PRIVMSGS_FOLDER_TABLE . " 
 			SET pm_count = pm_count - $num_deleted 
 			WHERE folder_id = $folder_id";
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 
 	// Update unread and new status field
@@ -875,20 +875,20 @@
 			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
 		}
 		
-		$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
+		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
 	}
 	
 	// Now we have to check which messages we can delete completely	
 	$sql = 'SELECT msg_id 
 		FROM ' . PRIVMSGS_TO_TABLE . '
 		WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		unset($delete_rows[$row['msg_id']]);
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	$delete_ids = implode(', ', array_keys($delete_rows));
 
@@ -896,7 +896,7 @@
 	{
 		$sql = 'DELETE FROM ' . PRIVMSGS_TABLE . '
 			WHERE msg_id IN (' . $delete_ids . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 }
 
@@ -955,10 +955,10 @@
 			$sql = 'SELECT user_id, username, user_colour 
 				FROM ' . USERS_TABLE . '
 				WHERE user_id IN (' . implode(', ', $u) . ')
-					AND user_type IN (' . USER_NORMAL . ', ' . USER_FOUNDER . ')';
-			$result = $_CLASS['core_db']->sql_query($sql);
+					AND user_type = ' . USER_NORMAL;
+			$result = $_CLASS['core_db']->query($sql);
 
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				if ($check_type == 'to' || $author_id == $_CLASS['core_user']->data['user_id'] || $row['user_id'] == $_CLASS['core_user']->data['user_id'])
 				{
@@ -972,7 +972,7 @@
 					}
 				}
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 		}
 
 		if (sizeof($g))
@@ -982,16 +982,16 @@
 				$sql = 'SELECT group_name
 					FROM ' . GROUPS_TABLE . ' 
 						WHERE group_id IN (' . implode(', ', $g) . ')';
-				$result = $_CLASS['core_db']->sql_query($sql);
+				$result = $_CLASS['core_db']->query($sql);
 		
-				while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
 					if ($check_type == 'to' || $author_id == $_CLASS['core_user']->data['user_id'] || $row['user_id'] == $_CLASS['core_user']->data['user_id'])
 					{
 						$address[] = $row['group_name'];
 					}
 				}
-				$_CLASS['core_db']->sql_freeresult($result);
+				$_CLASS['core_db']->free_result($result);
 			}
 			else
 			{
@@ -1000,9 +1000,9 @@
 						WHERE g.group_id IN (' . implode(', ', $g) . ')
 						AND g.group_id = ug.group_id
 						AND ug.user_pending = 0';
-				$result = $_CLASS['core_db']->sql_query($sql);
+				$result = $_CLASS['core_db']->query($sql);
 		
-				while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
 					if (!isset($address['group'][$row['group_id']]))
 					{
@@ -1017,7 +1017,7 @@
 						$address['user'][$row['user_id']]['in_group'] = $row['group_id'];
 					}
 				}
-				$_CLASS['core_db']->sql_freeresult($result);
+				$_CLASS['core_db']->free_result($result);
 			}
 		}
 
@@ -1126,14 +1126,14 @@
 				FROM ' . USER_GROUP_TABLE . '
 				WHERE group_id IN (' . implode(', ', array_keys($data['address_list']['g'])) . ')
 					AND user_pending = 0';
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 	
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$field = ($data['address_list']['g'][$row['group_id']] == 'to') ? 'to' : 'bcc';
 				$recipients[$row['user_id']] = $field;
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 		}
 
 		if (!sizeof($recipients))
@@ -1172,7 +1172,6 @@
 				'message_subject'	=> $subject,
 				'message_text' 		=> $data['message'],
 				'message_checksum'	=> $data['message_md5'],
-				'message_encoding'	=> $_CLASS['core_user']->lang['ENCODING'],
 				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid'],
@@ -1193,7 +1192,6 @@
 				'message_subject'	=> $subject,
 				'message_text' 		=> $data['message'],
 				'message_checksum'	=> $data['message_md5'],
-				'message_encoding'	=> $_CLASS['core_user']->lang['ENCODING'],
 				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid']
@@ -1201,35 +1199,35 @@
 			break;
 	}
 
+	$_CLASS['core_db']->transaction();
+
 	if (sizeof($sql_data))
 	{
 		if ($mode == 'post' || $mode == 'reply' || $mode == 'quote' || $mode == 'forward')
 		{
-			$_CLASS['core_db']->sql_query('INSERT INTO ' . PRIVMSGS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_data));
-			$data['msg_id'] = $_CLASS['core_db']->sql_nextid();
+			$_CLASS['core_db']->query('INSERT INTO ' . PRIVMSGS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_data));
+			$data['msg_id'] = $_CLASS['core_db']->insert_id(PRIVMSGS_TABLE, 'msg_id');
 		}
 		else if ($mode == 'edit')
 		{
 			$sql = 'UPDATE ' . PRIVMSGS_TABLE . ' 
 				SET message_edit_count = message_edit_count + 1, ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data) . ' 
 				WHERE msg_id = ' . $data['msg_id'];
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 		}
 	}
 	
 	if ($mode != 'edit')
 	{
-		$_CLASS['core_db']->sql_transaction();
-	
 		if ($sql)
 		{
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 		}
 		unset($sql);
 
 		foreach ($recipients as $user_id => $type)
 		{
-			$_CLASS['core_db']->sql_query('INSERT INTO ' . PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+			$_CLASS['core_db']->query('INSERT INTO ' . PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 				'msg_id'	=> $data['msg_id'],
 				'user_id'	=> $user_id,
 				'author_id'	=> $_CLASS['core_user']->data['user_id'],
@@ -1243,12 +1241,12 @@
 		$sql = 'UPDATE ' . USERS_TABLE . ' 
 			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1, user_last_privmsg = ' . time() . '
 			WHERE user_id IN (' . implode(', ', array_keys($recipients)) . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		// Put PM into outbox
 		if ($put_in_outbox)
 		{
-			$_CLASS['core_db']->sql_query('INSERT INTO ' . PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+			$_CLASS['core_db']->query('INSERT INTO ' . PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 				'msg_id'	=> (int) $data['msg_id'],
 				'user_id'	=> (int) $_CLASS['core_user']->data['user_id'],
 				'author_id'	=> (int) $_CLASS['core_user']->data['user_id'],
@@ -1258,8 +1256,6 @@
 				'forwarded'	=> ($mode == 'forward') ? 1 : 0))
 			);
 		}
-
-		$_CLASS['core_db']->sql_transaction('commit');
 	}
 
 	// Set user last post time
@@ -1268,11 +1264,9 @@
 		$sql = 'UPDATE ' . USERS_TABLE . "
 			SET user_lastpost_time = $current_time
 			WHERE user_id = " . $_CLASS['core_user']->data['user_id'];
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 
-	$_CLASS['core_db']->sql_transaction();
-
 	// Submit Attachments
 	if (sizeof($data['attachment_data']) && $data['msg_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit', 'forward')))
 	{
@@ -1286,7 +1280,7 @@
 				$sql = 'UPDATE ' . ATTACHMENTS_TABLE . " 
 					SET comment = '" . $_CLASS['core_db']->sql_escape($attach_row['comment']) . "' 
 					WHERE attach_id = " . (int) $attach_row['attach_id'];
-				$_CLASS['core_db']->sql_query($sql);
+				$_CLASS['core_db']->query($sql);
 			}
 			else
 			{
@@ -1308,7 +1302,7 @@
 
 				$sql = 'INSERT INTO ' . ATTACHMENTS_TABLE . ' ' . 
 					$_CLASS['core_db']->sql_build_array('INSERT', $attach_sql);
-				$_CLASS['core_db']->sql_query($sql);
+				$_CLASS['core_db']->query($sql);
 
 				$space_taken += $attach_row['filesize'];
 				$files_added++;
@@ -1320,7 +1314,7 @@
 			$sql = 'UPDATE ' . PRIVMSGS_TABLE . '
 				SET message_attachment = 1
 				WHERE msg_id = ' . $data['msg_id'];
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 		}
 
 		if ($space_taken && $files_added)
@@ -1330,7 +1324,7 @@
 		}
 	}
 
-	$_CLASS['core_db']->sql_transaction('commit');
+	$_CLASS['core_db']->transaction('commit');
 
 	// Delete draft if post was loaded...
 	$draft_id = request_var('draft_loaded', 0);
@@ -1339,7 +1333,7 @@
 		$sql = 'DELETE FROM ' . DRAFTS_TABLE . " 
 			WHERE draft_id = $draft_id 
 				AND user_id = " . $_CLASS['core_user']->data['user_id'];
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 
 	// Send Notifications
@@ -1361,18 +1355,18 @@
 	// Get banned User ID's
 	$sql = 'SELECT ban_userid 
 		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']->data['user_id']]);
 	
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		if (isset($row['ban_userid']))
 		{
 			unset($recipients[$row['ban_userid']]);
 		}
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	if (!sizeof($recipients))
 	{
@@ -1384,10 +1378,10 @@
 	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type, user_jabber
 		FROM ' . USERS_TABLE . "
 		WHERE user_id IN ($recipient_list)";
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	$msg_list_ary = array();
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		if ($row['user_notify_pm'] == 1 && trim($row['user_email']))
 		{
@@ -1400,7 +1394,7 @@
 			);
 		}
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 	
 	if (!sizeof($msg_list_ary))
 	{

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/functions.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -59,6 +59,19 @@
 	return $is_bot;
 }
 
+function check_collapsed_status($marker, $cookie = 'collapsed_items') 
+{
+    static $collapsed_items_array = array();
+
+    if (!isset($collapsed_items_array[$cookie]))
+    {
+		$cookie_data = get_variable($cookie, 'COOKIE');
+		$collapsed_items_array[$cookie] = ($cookie_data) ? explode(':', $cookie_data) : array();
+    }
+
+    return in_array($marker, $collapsed_items_array[$cookie]);
+}
+
 /*
 */
 function check_load_status($return = false)
@@ -247,6 +260,8 @@
 function get_variable($var_name, $type, $default = false, $var_type = 'string')
 {
 	$variable = null;
+	
+	$type = strtoupper($type);
 
 	switch ($type)
 	{
@@ -376,7 +391,7 @@
     return ($options['full']) ? generate_base_url().$link : $link;
 }
 
-function generate_pagination_formated($base_url, $total, $per_page = 10, $start = 0, $admin_link = false)
+function generate_pagination($base_url, $total, $per_page = 10, $start = 0, $admin_link = false)
 {
 	global $_CLASS;
 
@@ -392,8 +407,10 @@
 
 	$total_pages = ceil($total / $per_page);
 	$current_page = ($start) ? floor($start / $per_page) + 1 : 1;
-	$display = '';
 
+	$display['formated'] = '';
+	$display['array'] = array();
+
 	if ($total_pages > 8)
 	{
 		if ($current_page < 4)
@@ -406,7 +423,8 @@
 			$end = min($total_pages, $current_page + 2);
 			$start = ($end > $total_pages - 2) ? $total_pages - 4 : $current_page - 2;
 
-			$display = sprintf($wrapper['first'], generate_link($base_url, $admin_link), 1);
+			$display['array'][] = array('page' => 1, 'link' => generate_link($base_url, $admin_link), 'seperator' => 'after');
+			$display['formated'] = sprintf($wrapper['first'], generate_link($base_url, $admin_link), 1);
 		}
 	}
 	else
@@ -417,64 +435,39 @@
 
 	for($i = $start; $i <= $end; $i++)
 	{
+		$display['array'][] = array('page' => $i, 'link' => generate_link($base_url.'&amp;start='.(($i - 1) * $per_page)), 'seperator' => false);
+		
 		$this_wrapper = ($current_page == $i) ? $wrapper['current'] : $wrapper['normal'];
-		$display .= sprintf($this_wrapper, generate_link($base_url.'&amp;start='.(($i - 1) * $per_page)), $i);
+		$display['formated'] .= sprintf($this_wrapper, generate_link($base_url.'&amp;start='.(($i - 1) * $per_page)), $i);
 	}
 
 	if ($end != $total_pages)
 	{
-		$display .= sprintf($wrapper['last'], generate_link($base_url.'&amp;start='.(($total_pages - 1)  * $per_page), $admin_link), $total_pages);
+		$display['array'][] = array('page' => $total_pages, 'link' => generate_link($base_url.'&amp;start='.(($total_pages - 1) * $per_page), $admin_link), 'seperator' => 'before');
+		$display['formated'] .= sprintf($wrapper['last'], generate_link($base_url.'&amp;start='.(($total_pages - 1)  * $per_page), $admin_link), $total_pages);
 	}
 
-	return $display;
+//TMP
+	return $display['formated'];
 }
 
-function generate_pagination_array($base_url, $total, $per_page = 10, $start = 0, $admin_link = false)
-{
-	global $_CLASS;
-
-	if ($total <= $per_page)
-	{
-		return false;
-	}
-
-	$total_pages = ceil($total / $per_page);
-	$current_page = ($start) ? floor($start / $per_page) + 1 : 1;
-	$display = array();
-
-	if ($total_pages > 8)
-	{
-		if ($current_page < 4)
-		{
-			$start = 1;
-			$end = 5;
-		}
-		else
-		{
-			$start = $current_page - 2;
-			$end = min($total_pages, $current_page + 2);
-
-			$display[] = array('page' => 1, 'link' => generate_link($base_url, $admin_link), 'seperator' => 'after');
-		}
-	}
-	else
-	{
-		$start = 1;
-		$end = $total_pages;
-	}
-
-	for($i = $start; $i <= $end; $i++)
-	{
-		$link = ($i == $current_page) ? false : generate_link($base_url.'&amp;start='.(($i - 1) * $per_page), $admin_link);
-		$display[] = array('page' => $i, 'link' => $link, 'seperator' => false);
-	}
-	
-	if ($end != $total_pages)
-	{
-		$display[] = array('page' => $total_pages, 'link' => generate_link($base_url.'&amp;start='.(($total_pages - 1) * $per_page), $admin_link), 'seperator' => 'before');
-	}
-	
-	return $display;
+/*
+	Generates random strings
+*/
+function generate_string($length)
+{
+	// Add type
+	$chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
+
+	$string = '';
+	$num_chars = strlen($chars) - 1;
+
+	for ($i = 0; $i < $length; ++$i)
+	{
+		$string .= substr($chars, mt_rand(0, $num_chars), 1);
+	}
+
+	return $string;
 }
 
 function gmtime()
@@ -685,7 +678,7 @@
 	return $theme;
 }
 
-function modify_lines($text, $replacement = ' ')
+function modify_lines($text, $replacement = '')
 {
 	return str_replace(array("\r\n", "\r", "\n"), $replacement, $text);
 }
@@ -840,15 +833,4 @@
 	}
 }
 
-//REMOVE
-function generate_pagination($base_url, $num_items, $per_page, $start_item, $add_prevnext_text = false, $tpl_prefix = '')
-{
-	global $_CLASS;
-		$_CLASS['core_template']->assign(array(
-		$tpl_prefix . 'PREVIOUS_PAGE'	=>  '',
-		$tpl_prefix . 'NEXT_PAGE'	=> '')
-	);
-
-	return generate_pagination_formated($base_url, $num_items, $per_page, $start_item, false);
-}
 ?>
\ No newline at end of file

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/functions_user.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -13,50 +13,108 @@
 //																//
 //**************************************************************//
 
-function user_get_id($names, &$difference = array())
+function user_get_id($username, &$difference = array())
 {
 	global $_CLASS;
 
-	$data = array('ids' => array(), 'names' => array());
+	$data = array('user_id' => array(), 'username' => array());
 
 	$sql = 'SELECT user_id, username
 				FROM ' . USERS_TABLE . " 
-				WHERE username IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array($names)) . "')";
+				WHERE username IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array($username)) . "')";
 	$result = $_CLASS['core_db']->query($sql);
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$data['ids'][] = $row['user_id'];
-		$data['names'][] = $row['username'];
+		$data['user_id'][] = $row['user_id'];
+		$data['username'][] = $row['username'];
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	$difference = array_diff($names, $data['names']);
-	
-	return $data['ids'];
+	$difference = array_diff($username, $data['username']);
+
+	return $data['user_id'];
 }
 
-function user_get_name($ids, &$difference = array())
+function user_get_name($user_ids, &$difference = array())
 {
 	global $_CLASS;
 
-	$data = array('ids' => array(), 'names' => array());
+	$user_ids = array_map('intval', $user_ids);
 
+	if (empty($user_ids))
+	{
+		return;
+	}
+
+	$data = array('user_id' => array(), 'username' => array());
+
 	$sql = 'SELECT user_id, username
 				FROM ' . USERS_TABLE . ' 
-				WHERE user_id IN (' . implode(', ', array_map('intval', $ids)) . ')';
+				WHERE user_id IN (' . implode(', ', $user_ids) . ')';
 	$result = $_CLASS['core_db']->query($sql);
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$data['ids'][] = $row['user_id'];
-		$data['names'][] = $row['username'];
+		$data['user_ids'][] = $row['user_id'];
+		$data['username'][] = $row['username'];
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	$difference = array_diff($ids, $data['ids']);
+	$difference = array_diff($user_ids, $data['user_ids']);
 
-	return $data['names'];
+	return $data['username'];
 }
 
+function groups_user_remove($group_ids, $user_ids)
+{
+	global $_CLASS;
+
+	$group_ids = is_array($group_ids) ? $group_ids : array($group_ids);
+	$user_ids = is_array($user_ids) ? $user_ids : array($user_ids);
+
+	$group_ids = array_map('intval', $group_ids);
+	$user_ids = array_map('intval', $user_ids);
+
+	if (empty($group_ids) || empty($user_ids))
+	{
+		return;
+	}
+
+	$sql = 'SELECT user_id FROM ' . USERS_TABLE . ' 
+				WHERE group_id IN (' . implode(', ', $group_ids) . ')
+				AND user_id IN (' . implode(', ', $group_ids) . ')';
+	$result = $_CLASS['core_db']->query($sql);
+
+	$defaults = array();
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$defaults[] = $row['user_id'];
+	}
+	$_CLASS['core_db']->free_result($result);
+	
+	// We move all users that are removed from the default groups to
+	// REGISTERED / REGISTERED_COPPA
+	if (!empty($defaults))
+	{
+// need to update/completion
+		$result = $_CLASS['core_db']->query('SELECT * FROM ' . GROUPS_TABLE . ' 	WHERE group_id = 4');
+
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		$sql = 'UPDATE FROM '. USERS_TABLE .' 
+					SET group_id = 4, user_rank = -1
+					WHERE user_id IN (' . implode(', ', $group_ids) . ')';
+		$result = $_CLASS['core_db']->query($sql);
+	}
+
+	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . '
+		WHERE group_id IN ('. implode(', ', $group_ids) . ')
+		AND user_id IN ('. implode(', ', $user_ids) .')';
+
+	$result = $_CLASS['core_db']->query($sql);
+}
+
 ?>
\ No newline at end of file

Modified: trunk/includes/mailer.php
===================================================================
--- trunk/includes/mailer.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/mailer.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -145,27 +145,27 @@
 
 		if ($this->html)
 		{
-			// Seems a bit bugged, or it could be Mercury mailer :-(
 			// multipart
 			$text_boundary = trim('--'.((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))));
 
-			$headers[] = "Content-Type: multipart/alternative;\n\t boundary=\"$text_boundary\";";
+			$headers[] = 'Content-Type: multipart/alternative;';
+			$headers[] = "\tboundary=\"$text_boundary\"";
 
-			$message = 'This is a multi-part message in MIME format, Please use a MIME-compatible client';
+			$message .= 'This is a multi-part message in MIME format, Please use a MIME-compatible client';
 
 			// Plain text
 			$message .= "\n\n$text_boundary\n";
 			$message .= 'Content-Type: text/plain; charset='.$this->encoding."\n"; //format=
-			$message .= "Content-Transfer-Encoding: 8bit\n";
-			$message .= "\n".html_entity_decode(strip_tags(preg_replace('#<br */?>#i', "\n", modify_lines($this->message))), ENT_QUOTES)."\n";
+			$message .= "Content-Transfer-Encoding: 8bit\n\n";
+			$message .= html_entity_decode(strip_tags(preg_replace('#<br */?>#i', "\n", modify_lines($this->message))), ENT_QUOTES);
 
 			// HTML
-			$message .= "$text_boundary\n";
+			$message .= "\n\n$text_boundary\n";
 			$message .= 'Content-Type: text/html; charset='.$this->encoding."\n";
-			$message .= "Content-Transfer-Encoding: 8bit\n";
-			$message .= "\n".$this->message."\n";
+			$message .= "Content-Transfer-Encoding: 8bit\n\n";
+			$message .= $this->message;
 
-			$message .= "\n$text_boundary--\n";
+			$message .= "\n\n$text_boundary--\n";
 		}
 		else
 		{
@@ -203,7 +203,7 @@
 		}
 
 		if (function_exists($_CORE_CONFIG['email']['email_function_name']))
-		{			
+		{//mb_send_mail
 			$result = $_CORE_CONFIG['email']['email_function_name']($to, $this->subject, $message, implode("\n", $headers));
 
 			if (!$result)
@@ -399,7 +399,6 @@
 		fwrite($this->connection, 'To: '.implode(', ', $to_header)."\r\n");
 		fwrite($this->connection, implode("\r\n", $this->headers)."\r\n\r\n");
 
-// Do my html and plain text mail thing, change it to a function maybe ?
 		fwrite($this->connection, $this->message."\r\n");
 
 		fwrite($this->connection, '.'."\r\n");

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/session.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -28,9 +28,6 @@
 
 		$this->server_local = ($_SERVER['HTTP_HOST'] == 'localhost' || $_SERVER['HTTP_HOST'] == '127.0.0.1') ? true : false;
 
-		$session_data = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_data', 'COOKIE'));
-// should spearate this, since I have to check to make sure the 2 values are in the array, would be easy to not do this
-		$session_data = (is_array($session_data)) ? $session_data : array();
 		$session_data['session_id'] = get_variable('sid', 'GET');
 
 		if ($cookie_sid = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_sid', 'COOKIE'))
@@ -58,7 +55,7 @@
 
 			$this->data = $_CLASS['core_db']->fetch_row_assoc($result);
 			$_CLASS['core_db']->free_result($result);
-//print_R($this->data);die;
+
 			if (isset($this->data['user_id']) && ($this->data['user_id'] == ANONYMOUS || $this->data['user_status'] == USER_ACTIVE))
 			{
 				$valid  = true;
@@ -72,7 +69,7 @@
 				{
 					$check_ip = implode('.', explode('.', $this->data['session_ip'], $_CORE_CONFIG['server']['ip_check']));
 					
-					if ($check_ip != substr($this->ip, 0, strlen($check_ip)))
+					if ($check_ip != mb_substr($this->ip, 0, mb_strlen($check_ip)))
 					{
 						$valid  = false;
 					}

Modified: trunk/includes/user.php
===================================================================
--- trunk/includes/user.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/includes/user.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -22,23 +22,23 @@
 
 	function core_user()
 	{
-		$this->browser = substr((empty($_SERVER['HTTP_USER_AGENT']) ? getenv('HTTP_USER_AGENT') : $_SERVER['HTTP_USER_AGENT']), 0, 255);
+		$this->browser = mb_substr((empty($_SERVER['HTTP_USER_AGENT']) ? getenv('HTTP_USER_AGENT') : $_SERVER['HTTP_USER_AGENT']), 0, 255);
 		$this->url	= empty($_SERVER['REQUEST_URI']) ? getenv('REQUEST_URI') : $_SERVER['REQUEST_URI'];
 		$this->ip	= empty($_SERVER['REMOTE_ADDR']) ? getenv('REMOTE_ADDR') : $_SERVER['REMOTE_ADDR'];
 		$this->time	= gmtime();
 
-		if (($pos = strpos($this->url, INDEX_PAGE.'?mod=')) !== false)
+		if (($pos = mb_strpos($this->url, INDEX_PAGE.'?mod=')) !== false)
 		{
-			$pos = $pos + strlen(INDEX_PAGE.'?mod=');
-			$this->url = substr($this->url, $pos);
+			$pos = $pos + mb_strlen(INDEX_PAGE.'?mod=');
+			$this->url = mb_substr($this->url, $pos);
 			
-			if (($pos = strpos($this->url, 'sid')) !== false)
+			if (($pos = mb_strpos($this->url, 'sid')) !== false)
 			{
-				$this->url = substr($this->url, 0, $pos - 1);
+				$this->url = mb_substr($this->url, 0, $pos - 1);
 			}
 
 			$this->url = htmlspecialchars(html_entity_decode($this->url, ENT_QUOTES));
-			$this->url = substr($this->url, 0, 255);
+			$this->url = mb_substr($this->url, 0, 255);
 		}
 		else
 		{
@@ -269,8 +269,9 @@
 		{
 			return $this->lang[$lang];
 		}
-		
-		return ucfirst(strtolower(preg_replace('/_/', ' ', $lang)));
+
+		//return ucfirst(mb_strtolower(preg_replace('/_/', ' ', $lang)));
+		return mb_convert_case(preg_replace('/_/', ' ', $lang), MB_CASE_TITLE);
 	}
 	
 	function get_img($img)
@@ -311,7 +312,7 @@
 		
 		if ($lang_file)
 		{
-			if (strpos($lang_file, '/') !== false)
+			if (mb_strpos($lang_file, '/') !== false)
 			{
 				include($site_file_root."language/$this->lang_name/$lang_file");
 

Modified: trunk/javascript/collapse.js
===================================================================
--- trunk/javascript/collapse.js	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/javascript/collapse.js	2005-08-10 02:42:08 UTC (rev 81)
@@ -51,73 +51,88 @@
 	return null;
 }
 
-function switch_collapse_area(id, name)
+function switch_collapse(id, name)
 {
 	var area = document.getElementById(id);
 
 	if (area.style.display == 'none')
 	{
-		area.style.display = '';
-		var value = null;
+		area.style.display = '';
+		switch_collapse_save(id, false, name);
 	}
 	else
 	{
 		area.style.display = 'none';
-		var value = id;
+		switch_collapse_save(id, id, name);
 	}
+}
 
+function switch_collapse_img(id, img_show, img_hide, name)
+{
+	var area = document.getElementById(id);
+	var img = document.getElementById(id+'_img');
+
+	if (area.style.display == 'none')
+	{
+		area.style.display = '';
+		img.src = img_show;
+
+		switch_collapse_save(id, false, name);
+	}
+	else
+	{
+		area.style.display = 'none';
+		img.src = img_hide;
+
+		switch_collapse_save(id, id, name);
+	}
+}
+
+function switch_collapse_save(id, save, name)
+{
 	// typeof name == 'undefined'
 	if (!name)
 	{
 		name = 'collapsed_items';
 	}
 
-	// Best why to do it, if we don't want var name
-	// it's a small script, shouldn't have any noticable speed impact
+	//alert(name);
+
 	var collapsed_cookie = get_cookie(name);
 	var collapsed_items = new Array();
-
+	var set = false;
+
 	if (collapsed_cookie != null)
 	{
 		collapsed_cookie = collapsed_cookie.split(':');
-	
+
 		for (var i in collapsed_cookie)
 		{
-			collapsed_items[i] = collapsed_cookie[i];
-		}
-	}
-
-	var key = array_search(id, collapsed_items, false);
-
-	if (key != null)
-	{
-		if (value != null)
-		{
-			collapsed_items[key] == key;
-		}
-		else
-		{
-			var tmp = new Array();
-	
-			for (var i in collapsed_items)
-			{
-				// We do it like this to get any duplicate values ( simple gc -- well not really )
-				if (collapsed_items[i] != id)
-				{
-					tmp.push(collapsed_items[i]);
-				}
+			if (collapsed_cookie[i] == id)
+			{
+				if (set == false)
+				{
+					set = true;
+
+					if (save != false)
+					{
+						collapsed_items.push(id);
+					}
+				}
+			}
+			else
+			{
+				collapsed_items.push(collapsed_cookie[i]);
 			}
-
-			collapsed_items = tmp;
 		}
-	}
-	else
-	{
-		collapsed_items.push(id);
 	}
-
-	//alert(collapsed_items.join(':'));
-
+
+	if (set == false && save != false)
+	{
+		collapsed_items.push(id);
+	}
+
+	//alert(collapsed_items.join(':'));
 	if (collapsed_items.length)
 	{
 		var expires = new Date()

Modified: trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -15,13 +15,45 @@
 {
 	function ucp_groups($id, $mode)
 	{
-		global $config, $_CLASS, $SID;
+		global $_CLASS, $site_file_root;
 
 		$_CLASS['core_user']->add_lang('groups');
 
-		$submit	= (!empty($_POST['submit'])) ? true : false;
-		$delete	= (!empty($_POST['delete'])) ? true : false;
-		
+		$submit	= !empty($_POST['submit']);
+		$group_ids = array_map('intval', request_var('mark', array(0)));
+
+		if ($submit)
+		{
+			require_once($site_file_root.'includes/functions_user.php');
+
+			switch ($_POST['mode'])
+			{
+				case 'resign':
+					
+					$sql = 'SELECT group_id	FROM  ' . GROUPS_TABLE . '
+								WHERE group_type = ' . GROUP_SPECIAL .'
+								AND group_id IN ('. implode(', ', $group_ids) .')';
+					$result = $_CLASS['core_db']->query($sql);
+
+					$special = array();
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						$special[] = $row['user_id'];
+					}
+					$_CLASS['core_db']->free_result($result);
+
+					$group_ids = array_diff($group_ids, $special);
+					unset($special);
+
+					groups_user_remove($group_ids, $_CLASS['core_user']->data['user_id']);
+				break;
+
+				case 'apply':
+					
+				break;		
+			}
+		}
+
 		$error = $data = array();
 
 		$sql = 'SELECT g.group_id, g.group_name, g.group_description, g.group_type, ug.user_status
@@ -29,10 +61,10 @@
 			WHERE ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 				AND g.group_id = ug.group_id
 			ORDER BY g.group_type DESC, g.group_name';
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
 		$group_id_ary = array();
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$block = ($row['user_status'] == STATUS_LEADER) ? 'leader' : (($row['user_status'] == STATUS_PENDING) ? 'pending' : 'member');
 
@@ -48,9 +80,8 @@
 
 			$group_id_ary[] = $row['group_id'];
 		}
+		$_CLASS['core_db']->free_result($result);
 
-		$_CLASS['core_db']->sql_freeresult($result);
-
 		// Hide hidden groups unless user is an admin with group privileges
 		$sql_and = ($_CLASS['auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? '<> ' . GROUP_SPECIAL : 'NOT IN (' . GROUP_SPECIAL . ', ' . GROUP_HIDDEN . ')';
 
@@ -59,25 +90,25 @@
 			WHERE group_id NOT IN (' . implode(', ', $group_id_ary) . ")
 				AND group_type $sql_and
 			ORDER BY group_type DESC, group_name";
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$_CLASS['core_template']->assign_vars_array('nonmember', array(
 				'GROUP_ID'		=> $row['group_id'],
 				'GROUP_NAME'	=> ($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
 				'GROUP_DESC'	=> $row['group_description'],
-				'GROUP_SPECIAL'	=> ($row['group_type'] <> GROUP_SPECIAL) ? false : true,
+				'GROUP_SPECIAL'	=> ($row['group_type'] == GROUP_SPECIAL),
 				'GROUP_CLOSED'	=> ($row['group_type'] <> GROUP_CLOSED || $_CLASS['auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? false : true,
 
 				'U_VIEW_GROUP'	=> generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id'])
 			));
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
 		$_CLASS['core_template']->assign(array(
-			'S_CHANGE_DEFAULT' 	=> ($_CLASS['auth']->acl_get('u_chggrp')),
-			'S_DISPLAY_FORM'	=> true,
+		'S_DISPLAY_FORM', true,
+		'S_UCP_ACTION' => ''
 		));
 
 		$this->display($_CLASS['core_user']->get_lang('UCP_GROUPS'), 'ucp_groups_membership.html');

Modified: trunk/modules/Control_Panel/ucp/ucp_main.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_main.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Control_Panel/ucp/ucp_main.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -303,8 +303,6 @@
 
 					$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
 				}
-		
-				$_CLASS['core_db']->free_result($result);
 
 				$sql = "SELECT f.*$lastread_select 
 					FROM $sql_from, " . FORUMS_WATCH_TABLE . ' fw
@@ -377,8 +375,6 @@
 				}
 				$_CLASS['core_db']->free_result($result);
 
-				$sql_f_select = '';
-				
 				// Subscribed Topics
 				$start = request_var('start', 0);
 

Modified: trunk/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -115,9 +115,8 @@
 					'U_JS_RETURN_INBOX'	=> $indox_link,
 					'S_NOT_LOGGED_IN'	=> ($_CLASS['core_user']->data['user_id'] == ANONYMOUS) ? true : false,
 					'CLICK_TO_VIEW'		=> sprintf($_CLASS['core_user']->lang['CLICK_VIEW_PRIVMSG'], '<a href="' . $indox_link . '" onclick="jump_to_inbox();return false;" target="_new">', '</a>'),
-					'U_INBOX'			=> $indox_link)
-					
-				);
+					'U_INBOX'			=> $indox_link
+				));
 
 				break;
 			
@@ -143,10 +142,12 @@
 					FROM ' . GROUPS_TABLE . '
 					WHERE group_id = ' . $_CLASS['core_user']->data['group_id'];
 				$result = $_CLASS['core_db']->query($sql);
-				$message_limit = (int) $_CLASS['core_db']->sql_fetchfield('group_message_limit', 0, $result);
-				$_CLASS['core_db']->sql_freeresult($result);
+
+				list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
+
+				$_CLASS['core_db']->free_result($result);
 				
-				$_CLASS['core_user']->data['message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
+				(int) $_CLASS['core_user']->data['message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 				
 				get_folder($_CLASS['core_user']->data['user_id'], $folder);
 
@@ -161,7 +162,7 @@
 				$module = new ucp_main($id, $mode);
 				unset($module);
 				exit;
-				break;
+			break;
 
 			case 'unread':
 			case 'view_messages':
@@ -170,8 +171,8 @@
 					FROM ' . GROUPS_TABLE . '
 					WHERE group_id = ' . $_CLASS['core_user']->data['group_id'];
 				$result = $_CLASS['core_db']->query($sql);
-				$message_limit = (int) $_CLASS['core_db']->sql_fetchfield('group_message_limit', 0, $result);
-				$_CLASS['core_db']->sql_freeresult($result);
+				list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
+				$_CLASS['core_db']->free_result($result);
 				
 				$_CLASS['core_user']->data['message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 				
@@ -199,7 +200,7 @@
 					trigger_error('NO_AUTH_READ_MESSAGE');
 				}
 
-				// First Handle Mark actions and moving messages
+// First Handle Mark actions and moving messages
 
 				// Move PM
 				if (isset($_REQUEST['move_pm']))
@@ -246,7 +247,7 @@
 							AND user_id = " . $_CLASS['core_user']->data['user_id'];
 					$result = $_CLASS['core_db']->query_limit($sql, 1);
 					
-					if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
+					if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
 					{
 						trigger_error('NO_MESSAGE');
 					}					
@@ -273,7 +274,7 @@
 							ORDER BY p.message_time $sql_ordering";
 						$result = $_CLASS['core_db']->query_limit($sql, 1);
 
-						if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
+						if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
 						{
 							$message = ($view == 'next') ? 'NO_NEWER_PM' : 'NO_OLDER_PM';
 							trigger_error($message);
@@ -293,7 +294,7 @@
 							AND p.msg_id = $msg_id";
 					$result = $_CLASS['core_db']->query_limit($sql, 1);
 
-					if (!($message_row = $_CLASS['core_db']->sql_fetchrow($result)))
+					if (!($message_row = $_CLASS['core_db']->fetch_row_assoc($result)))
 					{
 						trigger_error('NO_MESSAGE');
 					}

Modified: trunk/modules/Control_Panel/ucp/ucp_pm_compose.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -180,15 +180,15 @@
 
 	if ($sql)
 	{
-		$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
 
-		if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
+		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
 		{
 			trigger_error('NO_MESSAGE');
 		}
 
 		extract($row);
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 		
 		$msg_id = (int) $msg_id;
 		$enable_urls = $enable_magic_url;
@@ -299,11 +299,11 @@
 			WHERE post_msg_id = $msg_id
 				AND in_message = 1
 				ORDER BY filetime " . ((!$config['display_order']) ? 'DESC' : 'ASC');
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		$message_parser->attachment_data = array_merge($message_parser->attachment_data, $_CLASS['core_db']->sql_fetchrowset($result));
+		$message_parser->attachment_data = array_merge($message_parser->attachment_data, $_CLASS['core_db']->fetch_row_assocset($result));
 		
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 	}
 	
 	if (!in_array($action, array('quote', 'edit', 'delete', 'forward')))
@@ -324,13 +324,13 @@
 			WHERE (forum_id = 0 AND topic_id = 0)
 				AND user_id = ' . $_CLASS['core_user']->data['user_id'] . 
 				(($draft_id) ? " AND draft_id <> $draft_id" : '');
-		$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
 
-		if ($_CLASS['core_db']->sql_fetchrow($result))
+		if ($_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$drafts = true;
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 	}
 
 	if ($action == 'edit' || $action == 'forward')
@@ -360,7 +360,7 @@
 				'save_time'	=> $current_time,
 				'draft_subject' => $subject,
 				'draft_message' => $message));
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 	
 			$_CLASS['core_display']->meta_refresh(3, generate_link('Control_Panel&i=pm&mode='.$mode));
 
@@ -382,9 +382,9 @@
 				AND topic_id = 0
 				AND forum_id = 0
 				AND user_id = " . $_CLASS['core_user']->data['user_id'];
-		$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
 	
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$_REQUEST['subject'] = $row['draft_subject'];
 			$_POST['message'] = $row['draft_message'];
@@ -629,14 +629,14 @@
 		$result = array();
 		if (isset($address_list['u']) && sizeof($address_list['u']))
 		{
-			$result['u'] = $_CLASS['core_db']->sql_query('SELECT user_id as id, username as name, user_colour as colour 
+			$result['u'] = $_CLASS['core_db']->query('SELECT user_id as id, username as name, user_colour as colour 
 				FROM ' . USERS_TABLE . ' 
 				WHERE user_id IN (' . implode(', ', array_map('intval', array_keys($address_list['u']))) . ')');
 		}
 		
 		if (isset($address_list['g']) && sizeof($address_list['g']))
 		{
-			$result['g'] = $_CLASS['core_db']->sql_query('SELECT group_id as id, group_name as name, group_colour as colour 
+			$result['g'] = $_CLASS['core_db']->query('SELECT group_id as id, group_name as name, group_colour as colour 
 				FROM ' . GROUPS_TABLE . ' 
 				WHERE group_receive_pm = 1 AND group_id IN (' . implode(', ', array_map('intval', array_keys($address_list['g']))) . ')');
 		}
@@ -646,11 +646,11 @@
 		{
 			if (isset($result[$type]) && $result[$type])
 			{
-				while ($row = $_CLASS['core_db']->sql_fetchrow($result[$type]))
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result[$type]))
 				{
 					${$type}[$row['id']] = array('name' => $row['name'], 'colour' => $row['colour']);
 				}
-				$_CLASS['core_db']->sql_freeresult($result[$type]);
+				$_CLASS['core_db']->free_result($result[$type]);
 			}
 		}
 

Modified: trunk/modules/Control_Panel/ucp/ucp_pm_options.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm_options.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Control_Panel/ucp/ucp_pm_options.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -53,7 +53,7 @@
 			$sql = 'UPDATE ' . USERS_TABLE . '
 				SET user_full_folder = ' . $set_folder_id . '
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			$_CLASS['core_user']->data['user_full_folder'] = $set_folder_id;
 			
@@ -74,28 +74,28 @@
 				FROM ' . PRIVMSGS_FOLDER_TABLE . "
 				WHERE folder_name = '" . $_CLASS['core_db']->sql_escape($folder_name) . "'
 					AND user_id = " . $_CLASS['core_user']->data['user_id'];
-			$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
+			$result = $_CLASS['core_db']->query_limit($sql, 1);
 
-			if ($_CLASS['core_db']->sql_fetchrow($result))
+			if ($_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				trigger_error(sprintf($_CLASS['core_user']->lang['FOLDER_NAME_EXIST'], $folder_name));
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 
 			$sql = 'SELECT COUNT(folder_id) as num_folder
 				FROM ' . PRIVMSGS_FOLDER_TABLE . '
 					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 			
 			if ($_CLASS['core_db']->sql_fetchfield('num_folder', 0, $result) >= $config['pm_max_boxes'])
 			{
 				trigger_error('MAX_FOLDER_REACHED');
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 
 			$sql = 'INSERT INTO ' . PRIVMSGS_FOLDER_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 				'user_id' => (int) $_CLASS['core_user']->data['user_id'], 'folder_name' => $folder_name));
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			$message = $_CLASS['core_user']->lang['FOLDER_ADDED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $redirect_url . '">', '</a>');
 			$_CLASS['core_display']->meta_refresh(3, $redirect_url);
@@ -120,9 +120,9 @@
 			FROM ' . PRIVMSGS_FOLDER_TABLE . '
 			WHERE user_id = '.$_CLASS['core_user']->data['user_id']."
 				AND folder_id = $rename_folder_id";
-		$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
-		$folder_row = $_CLASS['core_db']->sql_fetchrow($result);
-		$_CLASS['core_db']->sql_freeresult($result);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
+		$folder_row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 
 		if (!$folder_row)
 		{
@@ -133,7 +133,7 @@
 			SET folder_name = '" . $_CLASS['core_db']->sql_escape($new_folder_name) . "'
 			WHERE folder_id = $rename_folder_id
 				AND user_id = ".$_CLASS['core_user']->data['user_id'];
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		$message = $_CLASS['core_user']->lang['FOLDER_RENAMED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $redirect_url . '">', '</a>');
 		$_CLASS['core_display']->meta_refresh(3, $redirect_url);
@@ -160,9 +160,9 @@
 			FROM ' . PRIVMSGS_FOLDER_TABLE . '
 			WHERE user_id = '.$_CLASS['core_user']->data['user_id']."
 				AND folder_id = $remove_folder_id";
-		$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
-		$folder_row = $_CLASS['core_db']->sql_fetchrow($result);
-		$_CLASS['core_db']->sql_freeresult($result);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
+		$folder_row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 
 		if (!$folder_row)
 		{
@@ -182,14 +182,14 @@
 				FROM ' . PRIVMSGS_TO_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 					AND folder_id = $remove_folder_id";
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 
 			$msg_ids = array();
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$msg_ids[] = (int) $row['msg_id'];
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 
 			// First of all, copy all messages to another folder... or delete all messages
 			switch ($remove_action)
@@ -216,7 +216,7 @@
 			$sql = 'DELETE FROM ' . PRIVMSGS_FOLDER_TABLE . '
 				WHERE user_id = '.$_CLASS['core_user']->data['user_id']."
 					AND folder_id = $remove_folder_id";
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			// Check full folder option. If the removed folder has been specified as destination switch back to inbox
 			if ($_CLASS['core_user']->data['user_full_folder'] == $remove_folder_id)
@@ -224,7 +224,7 @@
 				$sql = 'UPDATE ' . USERS_TABLE . '
 					SET user_full_folder = ' . PRIVMSGS_INBOX . '
 					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-				$_CLASS['core_db']->sql_query($sql);
+				$_CLASS['core_db']->query($sql);
 
 				$_CLASS['core_user']->data['user_full_folder'] = PRIVMSGS_INBOX;
 			}
@@ -280,16 +280,16 @@
 		$sql = 'SELECT rule_id 
 			FROM ' . PRIVMSGS_RULES_TABLE . '
 			WHERE ' . $_CLASS['core_db']->sql_build_array('SELECT', $rule_ary);
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		if ($_CLASS['core_db']->sql_fetchrow($result))
+		if ($_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			trigger_error('RULE_ALREADY_DEFINED');
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 		
 		$sql = 'INSERT INTO ' . PRIVMSGS_RULES_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $rule_ary);
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		$message = $_CLASS['core_user']->lang['RULE_ADDED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $redirect_url . '">', '</a>');
 		$_CLASS['core_display']->meta_refresh(3, $redirect_url);
@@ -315,7 +315,7 @@
 			$sql = 'DELETE FROM ' . PRIVMSGS_RULES_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 					AND rule_id = $delete_id";
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			$meta_info = generate_link("Control_Panel$SID&amp;i=pm&amp;mode=$mode");
 			$message = $_CLASS['core_user']->lang['RULE_DELETED'];
@@ -337,9 +337,9 @@
 		FROM ' . PRIVMSGS_TO_TABLE . '
 		WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 			AND folder_id = ' . PRIVMSGS_INBOX;
-	$result = $_CLASS['core_db']->sql_query($sql);
-	$num_messages = $_CLASS['core_db']->sql_fetchfield('num_messages', 0, $result);
-	$_CLASS['core_db']->sql_freeresult($result);
+	$result = $_CLASS['core_db']->query($sql);
+	list($num_messages) = $_CLASS['core_db']->fetch_row_num($result);
+	$_CLASS['core_db']->free_result($result);
 	
 	$folder[PRIVMSGS_INBOX] = array(
 		'folder_name'	=> $_CLASS['core_user']->lang['PM_INBOX'], 
@@ -349,10 +349,10 @@
 	$sql = 'SELECT folder_id, folder_name, pm_count 
 		FROM ' . PRIVMSGS_FOLDER_TABLE . '
 			WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	$num_user_folder = 0;
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$num_user_folder++;
 		$folder[$row['folder_id']] = array(
@@ -360,7 +360,7 @@
 			'message_status'=> sprintf($_CLASS['core_user']->lang['FOLDER_MESSAGE_STATUS'], $row['pm_count'], $message_limit)
 		);
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	$s_full_folder_options = $s_to_folder_options = $s_folder_options = '';
 	
@@ -623,26 +623,26 @@
 				$sql = 'SELECT user_id
 					FROM ' . USERS_TABLE . "
 					WHERE username = '" . $_CLASS['core_db']->sql_escape($rule_string) . "'";
-				$result = $_CLASS['core_db']->sql_query($sql);
+				$result = $_CLASS['core_db']->query($sql);
 				
 				if (!($rule_user_id = $_CLASS['core_db']->sql_fetchfield('user_id', 0, $result)))
 				{
 					$rule_string = '';
 				}
-				$_CLASS['core_db']->sql_freeresult($result);
+				$_CLASS['core_db']->free_result($result);
 			}
 			else if (!$rule_string && $rule_user_id)
 			{
 				$sql = 'SELECT username
 					FROM ' . USERS_TABLE . "
 					WHERE user_id = $rule_user_id";
-				$result = $_CLASS['core_db']->sql_query($sql);
+				$result = $_CLASS['core_db']->query($sql);
 				
 				if (!($rule_string = $_CLASS['core_db']->sql_fetchfield('username', 0, $result)))
 				{
 					$rule_user_id = 0;
 				}
-				$_CLASS['core_db']->sql_freeresult($result);
+				$_CLASS['core_db']->free_result($result);
 			}
 
 			$_CLASS['core_template']->assign(array(
@@ -687,9 +687,9 @@
 	$sql = 'SELECT *
 		FROM ' . PRIVMSGS_RULES_TABLE . '
 		WHERE user_id = ' . $user_id;
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 	
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$_CLASS['core_template']->assign_vars_array('rule', array(
 			'RULE_ID'	=> $row['rule_id'],
@@ -700,7 +700,7 @@
 			'FOLDER'	=> ($row['rule_action'] == ACTION_PLACE_INTO_FOLDER) ? $folder[$row['rule_folder_id']]['folder_name'] : '')
 		);
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 }
 
 ?>
\ No newline at end of file

Modified: trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -51,14 +51,14 @@
 	$sql = 'SELECT * 
 		FROM ' . ZEBRA_TABLE . ' 
 		WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$friend[$row['zebra_id']] = $row['friend'];
 		$foe[$row['zebra_id']] = $row['foe'];
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	$_CLASS['core_template']->assign(array(
 		'S_UNREAD'		=> ($type == 'unread'),
@@ -97,13 +97,13 @@
 					$sql = ($ug_type == 'u') ? 'SELECT user_id as id, username as name, user_colour as colour FROM ' . USERS_TABLE . ' WHERE user_id' : 'SELECT group_id as id, group_name as name, group_colour as colour FROM ' . GROUPS_TABLE . ' WHERE group_id';
 					$sql .= ' IN (' . implode(', ', array_keys($recipient_list[$ug_type])) . ')';
 	
-					$result = $_CLASS['core_db']->sql_query($sql);
+					$result = $_CLASS['core_db']->query($sql);
 
-					while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 					{
 						$recipient_list[$ug_type][$row['id']] = array('name' => $row['name'], 'colour' => $row['colour']);
 					}
-					$_CLASS['core_db']->sql_freeresult($result);
+					$_CLASS['core_db']->free_result($result);
 				}
 			}		
 
@@ -229,15 +229,15 @@
 				AND t.user_id = $user_id
 				AND t.msg_id = p.msg_id
 				AND p.message_time >= $min_post_time";
-		$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
 
 		if (isset($_POST['sort']))
 		{
 			$start = 0;
 		}
 
-		$pm_count = ($row = $_CLASS['core_db']->sql_fetchrow($result)) ? $row['pm_count'] : 0;
-		$_CLASS['core_db']->sql_freeresult($result);
+		$pm_count = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['pm_count'] : 0;
+		$_CLASS['core_db']->free_result($result);
 
 		$sql_limit_time = "AND p.message_time >= $min_post_time";
 	}
@@ -264,9 +264,9 @@
 					WHERE folder_id = $folder_id
 						AND user_id = $user_id";
 			}
-			$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
-			$pm_count = ($row = $_CLASS['core_db']->sql_fetchrow($result)) ? $row['pm_count'] : 0;
-			$_CLASS['core_db']->sql_freeresult($result);
+			$result = $_CLASS['core_db']->query_limit($sql, 1);
+			$pm_count = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['pm_count'] : 0;
+			$_CLASS['core_db']->free_result($result);
 		}
 
 		$sql_limit_time = '';
@@ -327,14 +327,14 @@
 			$sql_limit_time
 		ORDER BY $sql_sort_order";
 
-	$result = $_CLASS['core_db']->sql_query_limit($sql, $sql_limit, $sql_start);
+	$result = $_CLASS['core_db']->query_limit($sql, $sql_limit, $sql_start);
 
-	while($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$rowset[$row['msg_id']] = $row;
 		$pm_list[] = $row['msg_id'];
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	$pm_list = ($store_reverse) ? array_reverse($pm_list) : $pm_list;
 

Modified: trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -93,13 +93,13 @@
 				WHERE post_msg_id = $msg_id
 					AND in_message = 1
 				ORDER BY filetime " . ((!$config['display_order']) ? 'DESC' : 'ASC') . ', post_msg_id ASC';
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$attachments[] = $row;
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 	
 			// No attachments exist, but message table thinks they do so go ahead and reset attach flags
 			if (!sizeof($attachments))
@@ -107,7 +107,7 @@
 				$sql = 'UPDATE ' . PRIVMSGS_TABLE . " 
 					SET message_attachment = 0 
 					WHERE msg_id = $msg_id";
-				$_CLASS['core_db']->sql_query($sql);
+				$_CLASS['core_db']->query($sql);
 			}
 		}
 		else
@@ -247,9 +247,9 @@
 	$sort_dir = (!empty($_CLASS['core_user']->data['user_sortby_dir'])) ? $_CLASS['core_user']->data['user_sortby_dir'] : 'd';
 	$sql .= ($sort_dir == 'd') ? 'ASC' : 'DESC';
 
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
-	if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
+	if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
 	{
 		return false;
 	}
@@ -275,8 +275,8 @@
 			$bbcode_bitfield |= $row['bbcode_bitfield'];
 		}
 	}
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result));
-	$_CLASS['core_db']->sql_freeresult($result);
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+	$_CLASS['core_db']->free_result($result);
 
 	$title = ($sort_dir == 'a') ? $row['message_subject'] : $title;
 
@@ -382,10 +382,10 @@
 			FROM ' . SESSIONS_TABLE . " 
 			WHERE session_user_id = $user_id
 			GROUP BY session_user_id";
-		$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
 
 		$update_time = $config['load_online_time'] * 60;
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$user_row['online'] = (time() - $update_time < $row['online_time'] && ($row['viewonline'] && $user_row['user_allow_viewonline'])) ? true : false;
 		} else {

Modified: trunk/modules/Control_Panel/ucp/ucp_profile.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -61,7 +61,7 @@
 							array('username', $data['username'])),
 						'password_confirm'	=> array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
 						'new_password'		=> array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
-						'cur_password'		=> array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
+						//'cur_password'		=> array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
 						'email'				=> array(
 							array('string', false, 6, 60), 
 							array('email', $data['email'])),
@@ -77,7 +77,7 @@
 						$error[] = 'NEW_PASSWORD_ERROR';
 					}
 
-					if (($new_password || ($_CLASS['auth']->acl_get('u_chgemail') && $email != $_CLASS['core_user']->data['user_email']) || ($username != $_CLASS['core_user']->data['username'] && $_CLASS['auth']->acl_get('u_chgname') && $_CORE_CONFIG['user']['allow_namechange'])) && md5($cur_password) != $_CLASS['core_user']->data['user_password'])
+					if (($new_password || ($_CLASS['auth']->acl_get('u_chgemail') && $email != $_CLASS['core_user']->data['user_email']) || ($username != $_CLASS['core_user']->data['username'] && $_CLASS['auth']->acl_get('u_chgname') && $_CORE_CONFIG['user']['allow_namechange'])) && encode_password($cur_password, $_CLASS['core_user']->data['user_password_encoding']) != $_CLASS['core_user']->data['user_password'])
 					{
 						$error[] = 'CUR_PASSWORD_ERROR';
 					}
@@ -90,33 +90,21 @@
 					if (!sizeof($error))
 					{
 						$sql_ary = array(
-							'username'			=> ($_CLASS['auth']->acl_get('u_chgname') && $_CORE_CONFIG['user']['allow_namechange']) ? $username : $_CLASS['core_user']->data['username'], 
+							//'username'			=> ($_CLASS['auth']->acl_get('u_chgname') && $_CORE_CONFIG['user']['allow_namechange']) ? $username : $_CLASS['core_user']->data['username'], 
 							'user_email'		=> ($_CLASS['auth']->acl_get('u_chgemail')) ? $email : $_CLASS['core_user']->data['user_email'], 
-							'user_email_hash'	=> ($_CLASS['auth']->acl_get('u_chgemail')) ? crc32(strtolower($email)) . strlen($email) : $_CLASS['core_user']->data['user_email_hash'], 
-							'user_password'		=> ($_CLASS['auth']->acl_get('u_chgpasswd') && $new_password) ? md5($new_password) : $_CLASS['core_user']->data['user_password'], 
-							'user_passchg'		=> time(), 
+							//'user_password'		=> ($_CLASS['auth']->acl_get('u_chgpasswd') && $new_password) ? md5($new_password) : $_CLASS['core_user']->data['user_password'], 
+							//'user_passchg'		=> time(), 
 						);
 
 						if ($_CORE_CONFIG['email']['email_enable'] && $email != $_CLASS['core_user']->data['user_email'] && ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN))
 						{
-							require_once($site_file_root.'includes/forums/functions_messenger.php');
+							$template_file = ($config['require_activation'] == USER_ACTIVATION_ADMIN) ? 'user_activate_inactive.html' : 'user_activate.html';
+							$mailer = new core_mailer;
 
-							$server_url = generate_board_url();
-
-							$user_actkey = gen_rand_string(10);
-							$key_len = 54 - strlen($server_url);
-							$key_len = ($key_len > 6) ? $key_len : 6;
-							$user_actkey = substr($user_actkey, 0, $key_len);
-
-							$messenger = new messenger();
-
-							$template_file = ($config['require_activation'] == USER_ACTIVATION_ADMIN) ? 'user_activate_inactive' : 'user_activate';
 							$messenger->template($template_file, $_CLASS['core_user']->data['user_lang']);
-							$messenger->subject($subject);
+							$mailer->subject($subject);
 
-							$messenger->replyto($config['board_contact']);
 							$messenger->to($email, $username);
-
 							$messenger->headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
 							$messenger->headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']->data['user_id']);
 							$messenger->headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']->data['username']);
@@ -129,6 +117,8 @@
 								'U_ACTIVATE'    => generate_link("Control_Panel&amp;mode=activate&u={$_CLASS['core_user']->data['user_id']}&k=$user_actkey", array('full' => true)))
 							);
 
+							$body = trim($_CLASS['core_template']->display('modules/Contact/email/index.html', true));
+
 							$messenger->send(NOTIFY_EMAIL);
 
 							if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)

Modified: trunk/modules/Forums/faq.php
===================================================================
--- trunk/modules/Forums/faq.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Forums/faq.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -86,7 +86,7 @@
 		$_size = sizeof($help_block[$i]);
 		$faq_row_link = $faq_row = array();
 		
-		for ($j = 0, $_size; $j < $_size; $j++)
+		for ($j = 0; $j < $_size; $j++)
 		{
 			$faq_row[] = array(
 				'FAQ_SECTION' 		=> $i,

Modified: trunk/modules/Forums/posting.php
===================================================================
--- trunk/modules/Forums/posting.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Forums/posting.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -43,21 +43,14 @@
 	url_redirect($redirect);
 }
 
-if (in_array($mode, array('post', 'reply', 'quote', 'edit', 'delete', 'popup')) && !$forum_id)
-{
-	trigger_error('NO_FORUM');
-}
-
-require_once($site_file_root.'includes/forums/message_parser.php');
-require($site_file_root.'includes/forums/functions_admin.php');
-require($site_file_root.'includes/forums/functions_posting.php');
-
-// What is all this following SQL for? Well, we need to know
-// some basic information in all cases before we do anything.
-
 switch ($mode)
 {
 	case 'post':
+		if (!$forum_id)
+		{
+			trigger_error('NO_FORUM');
+		}
+
 		$sql = 'SELECT *
 			FROM ' . FORUMS_TABLE . "
 			WHERE forum_id = $forum_id";
@@ -75,7 +68,7 @@
 			WHERE t.topic_id = $topic_id
 				AND f.forum_id = t.forum_id";
 	break;
-	
+
 	case 'quote':
 	case 'edit':
 	case 'delete':
@@ -95,11 +88,11 @@
 
 	case 'smilies':
 		generate_smilies('window', $forum_id);
-		die;
 	break;
 
 	default:
 		trigger_error('NO_POST_MODE');
+	break;
 }
 
 $result = $_CLASS['core_db']->query($sql);
@@ -112,6 +105,10 @@
 	trigger_error('NO_POST');
 }
 
+require_once($site_file_root.'includes/forums/message_parser.php');
+require_once($site_file_root.'includes/forums/functions_admin.php');
+require_once($site_file_root.'includes/forums/functions_posting.php');
+
 extract($posting_data);
 
 if (!$_CLASS['auth']->acl_get('f_' . $mode, $forum_id) && !$_CLASS['auth']->acl_get('m_'. $mode, $forum_id) && $forum_type == FORUM_POST)
@@ -1391,7 +1388,6 @@
 				'post_subject'		=> $subject,
 				'post_text' 		=> $data['message'],
 				'post_checksum'		=> $data['message_md5'],
-				'post_encoding'		=> $_CLASS['core_user']->lang['ENCODING'],
 				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid'],
@@ -1442,7 +1438,6 @@
 				'post_edit_reason'	=> $data['post_edit_reason'],
 				'post_edit_user'	=> (int) $data['post_edit_user'],
 				'post_checksum'		=> $data['message_md5'],
-				'post_encoding'		=> $_CLASS['core_user']->lang['ENCODING'],
 				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid'],

Modified: trunk/modules/Forums/viewtopic.php
===================================================================
--- trunk/modules/Forums/viewtopic.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Forums/viewtopic.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -38,7 +38,7 @@
 	trigger_error('NO_TOPIC');
 }
 
-$voted_id	= request_var('vote_id', array(0));;
+$voted_id	= request_var('vote_id', array(0));
 $start		= request_var('start', 0);
 $view		= request_var('view', '');
 $update		= request_var('update', false);
@@ -747,7 +747,6 @@
 		'post_approved'		=> $row['post_approved'],
 		'post_reported'		=> $row['post_reported'],
 		'post_text'			=> $row['post_text'],
-		'post_encoding'		=> $row['post_encoding'],
 		'bbcode_uid'		=> $row['bbcode_uid'],
 		'bbcode_bitfield'	=> $row['bbcode_bitfield'],
 		'enable_html'		=> $row['enable_html'],

Modified: trunk/modules/Quick_Message/index.php
===================================================================
--- trunk/modules/Quick_Message/index.php	2005-08-09 04:12:16 UTC (rev 80)
+++ trunk/modules/Quick_Message/index.php	2005-08-10 02:42:08 UTC (rev 81)
@@ -63,7 +63,7 @@
 		trigger_error($_CLASS['core_user']->lang['NO_MESSAGE']); 
     }
     
-    $length = strlen($message);
+    $length = mb_strlen($message);
     
     if($length < 2)
     {
@@ -74,11 +74,11 @@
     { 
 		trigger_error($_CLASS['core_user']->lang['LONG_MESSAGE']);
     }
-   
+
 	$message 	= htmlentities($message, ENT_QUOTES, 'UTF-8');
 	$user_name 	= htmlentities($user_name, ENT_QUOTES, 'UTF-8');
 
-    $result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.$prefix."quick_message WHERE message='".$_CLASS['core_db']->escape($message)."' AND time >= '".(time() - $_CORE_CONFIG['quick_message']['lastpost_check'])."' LIMIT 1");
+    $result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.$prefix."quick_message WHERE message='".$_CLASS['core_db']->escape($message)."' AND time >= '".(time() - $_CORE_CONFIG['quick_message']['lastpost_check'])."'");
 	$count = $_CLASS['core_db']->fetch_row_assoc($result);
     $_CLASS['core_db']->free_result($result);
 
@@ -95,14 +95,14 @@
 		'user_id'	=> (int) $user_id ,
 		'message'	=> (string) $message,
 		'time'		=> (int)  $_CLASS['core_user']->time,
-		'ip'		=> (string) $_CLASS['core_user']->ip));
+		'ip'		=> (string) $_CLASS['core_user']->ip
+	));
 		
 	$_CLASS['core_db']->query($sql);
 	
 	url_redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
 }
 
-    
 function show_messages($all = false)
 {
     global $prefix, $_CLASS, $config, $_CORE_CONFIG;
@@ -110,13 +110,12 @@
 	$_CLASS['core_user']->add_lang();
 	$_CLASS['core_user']->add_img(false, 'Forums');
 
-	$start = ($all) ? '' : get_variable('start', 'GET', '', 'integer');
+	$start = ($all) ? '' : get_variable('start', 'GET', 0, 'integer');
 	$limit = ($all) ? '' : $_CORE_CONFIG['quick_message']['number'];
 	
-	$sql = 'SELECT * FROM '.$prefix.'quick_message ORDER BY time DESC';
 	//$sql = 'SELECT s.*, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height FROM '.$prefix.'quick_message s LEFT JOIN ' . USERS_TABLE . ' u  ON (u.user_id = s.user_id) ORDER BY time DESC';
 	
-	$result = $_CLASS['core_db']->query_limit($sql, $limit, $start);
+	$result = $_CLASS['core_db']->query_limit('SELECT * FROM '.$prefix.'quick_message ORDER BY time DESC', $limit, $start);
 	$error = (!$row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $_CLASS['core_user']->lang['NO_POSTS'] : false;
 
 	$_CLASS['core_template']->assign(array(
@@ -215,6 +214,7 @@
 	
 	$id = (int) get_variable('id', 'GET');
 	
+// we should only delete last message
 	$result = $_CLASS['core_db']->query('SELECT user_id, time, ip FROM '.$prefix.'quick_message WHERE id='.$id);
 	$row = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
@@ -264,7 +264,7 @@
 		}
 	}
 	
-	$length = strlen($user_name);
+	$length = mb_strlen($user_name);
 	
 	if ($length < 2)
 	{



From viperal at berlios.de  Mon Aug 15 23:01:42 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Mon, 15 Aug 2005 23:01:42 +0200
Subject: [Viperals-svncheckins] r82 - in trunk: . admin admin/functions blocks images includes includes/auth includes/cache includes/db includes/display modules/Contact modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Quick_Message themes/viperal themes/viperal/images themes/viperal/style themes/viperal/style/images themes/viperal/template themes/viperal/template/modules/News
Message-ID: <200508152101.j7FL1gZK011031@sheep.berlios.de>

Author: viperal
Date: 2005-08-15 23:01:36 +0200 (Mon, 15 Aug 2005)
New Revision: 82

Added:
   trunk/modules/Quick_Message/install.php
   trunk/themes/viperal/images/mail.png
   trunk/themes/viperal/images/print.png
Removed:
   trunk/modules/Control_Panel/ucp/ucp_activate.php
   trunk/modules/Control_Panel/ucp/ucp_confirm.php
   trunk/modules/Control_Panel/ucp/ucp_confirm_old.php
   trunk/modules/Control_Panel/ucp/ucp_remind.php
   trunk/modules/Control_Panel/ucp/ucp_resend.php
   trunk/themes/viperal/blockscript.js
   trunk/themes/viperal/images/down-logo.gif
   trunk/themes/viperal/images/leftbar.gif
   trunk/themes/viperal/images/mainbar.gif
   trunk/themes/viperal/images/print.gif
   trunk/themes/viperal/images/rightbar.gif
   trunk/themes/viperal/style/images/cellpic3.gif
   trunk/themes/viperal/style/images/created_by.jpg
   trunk/themes/viperal/style/images/icon_mini_faq.gif
   trunk/themes/viperal/style/images/icon_mini_groups.gif
   trunk/themes/viperal/style/images/icon_mini_login.gif
   trunk/themes/viperal/style/images/icon_mini_members.gif
   trunk/themes/viperal/style/images/icon_mini_message.gif
   trunk/themes/viperal/style/images/icon_mini_profile.gif
   trunk/themes/viperal/style/images/icon_mini_register.gif
   trunk/themes/viperal/style/images/icon_mini_search.gif
   trunk/themes/viperal/style/images/icons/
   trunk/themes/viperal/style/images/index.htm
   trunk/themes/viperal/style/images/logo-christmas.jpg
   trunk/themes/viperal/style/images/sitelogo.jpg
   trunk/themes/viperal/style/images/whosonline.gif
Modified:
   trunk/admin.php
   trunk/admin/blocks.php
   trunk/admin/bots.php
   trunk/admin/functions/block_functions.php
   trunk/admin/index.php
   trunk/admin/system.php
   trunk/blocks/block-Quick_Message.php
   trunk/images/Thumbs.db
   trunk/includes/auth/auth.php
   trunk/includes/auth/auth_db.php
   trunk/includes/auth/auth_http.php
   trunk/includes/cache/cache.php
   trunk/includes/cache/cache_eaccelerator.php
   trunk/includes/cache/cache_file.php
   trunk/includes/cache/cache_none.php
   trunk/includes/core_rss.php
   trunk/includes/db/mysql.php
   trunk/includes/db/mysqli.php
   trunk/includes/display/blocks.php
   trunk/includes/display/display.php
   trunk/includes/display/template.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/handler.php
   trunk/includes/session.php
   trunk/includes/system.php
   trunk/includes/user.php
   trunk/modules/Contact/index.php
   trunk/modules/Control_Panel/index.php
   trunk/modules/Control_Panel/ucp/ucp_attachments.php
   trunk/modules/Control_Panel/ucp/ucp_groups.php
   trunk/modules/Control_Panel/ucp/ucp_main.php
   trunk/modules/Control_Panel/ucp/ucp_pm.php
   trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
   trunk/modules/Control_Panel/ucp/ucp_register.php
   trunk/modules/Forums/download.php
   trunk/modules/Forums/faq.php
   trunk/modules/Forums/main.php
   trunk/modules/Forums/posting.php
   trunk/modules/Forums/viewforum.php
   trunk/modules/Forums/viewtopic.php
   trunk/modules/Quick_Message/index.php
   trunk/themes/viperal/images/Thumbs.db
   trunk/themes/viperal/index.php
   trunk/themes/viperal/style/images/Thumbs.db
   trunk/themes/viperal/style/style.css
   trunk/themes/viperal/template/blockleft.html
   trunk/themes/viperal/template/blockright.html
   trunk/themes/viperal/template/header.html
   trunk/themes/viperal/template/modules/News/index.html
Log:
You would expect me to add something of use here, wouldn't you ?

Modified: trunk/admin/blocks.php
===================================================================
--- trunk/admin/blocks.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/blocks.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -21,8 +21,6 @@
 require($site_file_root.'admin/functions/block_functions.php');
 $_CLASS['core_user']->add_lang('admin/blocks.php');
 
-$mode = get_variable('mode', 'GET', false);
-
 function check_position($position, $redirect = true)
 {
 	$appoved_blocks = array(BLOCK_RIGHT, BLOCK_TOP, BLOCK_BOTTOM, BLOCK_LEFT);
@@ -41,68 +39,119 @@
 	return true;
 }
 
-function get_id($rediret = true)
+if (isset($_REQUEST['mode']))
 {
-	$id = get_variable('id', 'GET', false, 'integer');
-
-	if (!$id && $rediret)
+	if ($id = get_variable('id', 'REQUEST', false, 'integer'))
 	{
-		url_redirect(generate_link('blocks', array('admin' => true)));
-		die;
+		switch ($_REQUEST['mode'])
+		{
+			case 'change':
+				block_change($id);
+			break;
+	
+			case 'order':
+				block_order($id, get_variable('option', 'GET', false));
+			break;
+	
+			case 'delete':
+				block_delete($id);
+			break;
+	
+			case 'position':
+				if ($position = get_variable('option', 'GET', false, 'integer'))
+				{
+					blocks_change_position($position, $id);
+				}
+			break;
+	
+			case 'auth':
+				block_auth($id);
+			break;
+		}
 	}
+	
+	switch ($_REQUEST['mode'])
+	{
+		case 'add':
+		case 'edit':
+			block_add($id);
+			script_close(false);
+		break;
+		   
+		case 'save':
+			block_save($id);
+		break;
+	}
+}
 
-	return (int) $id;
+blocks_block('main');
+
+$result = $_CLASS['core_db']->query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_file, block_auth
+	FROM '.BLOCKS_TABLE.'
+	WHERE block_position IN ('.BLOCK_RIGHT.', '.BLOCK_TOP.', '.BLOCK_BOTTOM.', '.BLOCK_LEFT.')  ORDER BY block_position, block_order ASC');
+
+$block_position = array(BLOCK_RIGHT => 'right', BLOCK_TOP => 'centertop', BLOCK_BOTTOM => 'centerbottom', BLOCK_LEFT => 'left');
+$in_position = false;
+$blocks = array();
+
+while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	if ($in_position != $row['block_position'])
+	{
+		$weigth[$row['block_position']] = $row['block_order'];
+		$in_position == $row['block_position'];
+	}
+	$blocks[] = $row;
 }
+$_CLASS['core_db']->free_result($result);
 
-switch ($mode)
+foreach ($blocks as $block)
 {
-	case 'change':
-		block_change(get_id());
-		url_redirect(generate_link('blocks', array('admin' => true, 'full' => true)));
-    break;
-    
-    case 'weight':
-		block_weight(get_id(), get_variable('option', 'GET', false));
-		url_redirect(generate_link('blocks', array('admin' => true, 'full' => true)));
-    break;
-    	
-    case 'delete':
-		block_delete(get_id());
-		url_redirect(generate_link('blocks', array('admin' => true, 'full' => true)));
-    break;
-    
-    case 'position':
-		$position = get_variable('option', 'GET', false, 'integer');
+	$error = false;
+	switch ($block['block_type'])
+	{
+		case BLOCKTYPE_FILE:
+			if (!$block['block_file'] || !file_exists($site_file_root.'blocks/'.$block['block_file']))
+			{
+				$error = 'File_MISSING';
+			}
+		break;
+	}
 
-		// Would cause problems is $data['position'] = (int) 0
-		if (!$position)
-		{
-			url_redirect(generate_link('blocks', array('admin' => true, 'full' => true)));
-		}
+	$_CLASS['core_template']->assign_vars_array($block_position[$block['block_position']].'_admin_blocks', array(
+			'ACTIVE'		=> ($block['block_status']),
+			'ACTIVE_LINK'	=> generate_link('blocks&amp;mode=change&amp;id='.$block['block_id'], array('admin' => true)),
+			'CHANGE'		=> ($block['block_status']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+			'ERROR'			=> ($error) ? $_CLASS['core_user']->get_lang($error) : false,
 
-		blocks_change_position($position, get_id());
+			'EDIT_LINK'		=> generate_link('blocks&amp;mode=edit&amp;id='.$block['block_id'], array('admin' => true)),
+			'AUTH_LINK'		=> generate_link('blocks&amp;mode=auth&amp;id='.$block['block_id'], array('admin' => true)),
 
-		url_redirect(generate_link('blocks', array('admin' => true, 'full' => true)));
-    break;
+			'DELETE_LINK' 	=> ($block['block_type'] != BLOCKTYPE_SYSTEM) ? generate_link('blocks&amp;mode=delete&amp;id='.$block['block_id'], array('admin' => true)) : '',
+			'TITLE'			=> $block['block_title'],
+			'TYPE'			=> $_CLASS['core_user']->get_lang('TYPE_'.$block['block_type']),
 
-    case 'add':
-    case 'edit':
-		block_add();
-    break;
-       
-    case 'save':
-		block_save();
-    break;
+			'ORDER_DOWN' 	=> ($block['block_order'] < $weigth[$block['block_position']]),
+			'ORDER_UP'		=> ($block['block_order'] > 1),
 
-    case 'auth':
-		block_auth(get_id());
-    break;
-
-    default:
-		blocks_admin();
-    break;
+			'LINK_ORDER_UP' 	=> generate_link('blocks&amp;mode=order&amp;option=up&amp;id='.$block['block_id'], array('admin' => true)),
+			'LINK_ORDER_TOP' 	=> generate_link('blocks&amp;mode=order&amp;option=top&amp;id='.$block['block_id'], array('admin' => true)),
+			'LINK_ORDER_DOWN'	=> generate_link('blocks&amp;mode=order&amp;option=down&amp;id='.$block['block_id'], array('admin' => true)),
+			'LINK_ORDER_BOTTOM'	=> generate_link('blocks&amp;mode=order&amp;option=bottom&amp;id='.$block['block_id'], array('admin' => true)),
+	));
 }
 
+$_CLASS['core_template']->assign_array(array(
+	'L_BLOCK_REGULAR'	=> 'Add New Regular Block',
+	'L_BLOCK_HTML'		=> 'Add New HTML Block',
+	'L_BLOCK_FEED'		=> 'Add New Feed Block',
+	'N_BLOCK_FILE'		=> generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FILE, array('admin' => true)),
+	'N_BLOCK_FEED'		=> generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FEED, array('admin' => true)),
+	'N_BLOCK_HTML'		=> generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_HTML, array('admin' => true))
+));
+
+$_CLASS['core_template']->display('admin/blocks/index.html');
+	
 script_close(false);
 
 function blocks_change_position($position, $id)
@@ -111,123 +160,50 @@
 
 	check_position($position);
 
-	$result = $_CLASS['core_db']->query('SELECT position, weight FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+	$result = $_CLASS['core_db']->query('SELECT block_position, block_order FROM '.BLOCKS_TABLE.' WHERE block_id = '.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
-	check_position($block['position']);
-
-	if ($block['position'] == $position)
+	if (!$block || $block['block_position'] == $position)
 	{
 		return;
 	}
 
-	$result = $_CLASS['core_db']->query('SELECT weight FROM '.BLOCKS_TABLE." WHERE position = $position ORDER BY weight DESC LIMIT 1");
-	$max_weight = $_CLASS['core_db']->fetch_row_assoc($result);
-	$_CLASS['core_db']->free_result($result);
+	check_position($block['block_position']);
 
-	$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight= weight - 1 WHERE position = '.$block['position'].' AND weight > '.$block['weight']);
-	$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE." set position = $position , weight = ".((int) $max_weight['weight'] + 1).' where id ='.$id);
-
-	$_CLASS['core_cache']->destroy('blocks');
-}
-
-function blocks_admin()
-{
-    global $_CLASS, $site_file_root;
-
-	blocks_block('main');
-
-    $result = $_CLASS['core_db']->query('SELECT id, title, type,  position, weight, active, file, auth
-		FROM '.BLOCKS_TABLE.'
-		WHERE position IN ('.BLOCK_RIGHT.', '.BLOCK_TOP.', '.BLOCK_BOTTOM.', '.BLOCK_LEFT.')  ORDER BY position, weight ASC');
-
-    $block_position = array(BLOCK_RIGHT => 'right', BLOCK_TOP => 'centertop', BLOCK_BOTTOM => 'centerbottom', BLOCK_LEFT => 'left');
-	$in_position = false;
-	$blocks = array();
-
-	while($row = $_CLASS['core_db']->fetch_row_assoc($result))
-    {
-		if ($in_position != $row['position'])
-		{
-			$weigth[$row['position']] = $row['weight'];
-			$in_position == $row['position'];
-		}
-		$blocks[] = $row;
-	}
+	$result = $_CLASS['core_db']->query('SELECT max(block_order) as max_order FROM '.BLOCKS_TABLE.' WHERE block_position = '.$position);
+	list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 	$_CLASS['core_db']->free_result($result);
 
-	foreach ($blocks as $block)
-	{
-		$error = false;
-		switch ($block['type'])
-		{
-			case BLOCKTYPE_FILE:
-				if (!$block['file'] || !file_exists($site_file_root.'blocks/'.$block['file']))
-				{
-					$error = 'File_MISSING';
-				}
-			break;
-		}
+	$new_order = (int) $max_order + 1;
 
-		$_CLASS['core_template']->assign_vars_array($block_position[$block['position']].'_admin_blocks', array(
-				'ACTIVE'		=> ($block['active']),
-				'ACTIVE_LINK'	=> generate_link('blocks&amp;mode=change&amp;id='.$block['id'], array('admin' => true)),
-				'CHANGE'		=> ($block['active']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
-				'ERROR'			=> ($error) ? $_CLASS['core_user']->get_lang($error) : false,
+	$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE." SET block_position = $position , block_order = $new_order where block_id = $id");
+	$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET block_order = block_order - 1 WHERE block_position = '.$block['block_position'].' AND block_order > '.$block['block_order']);
 
-				'EDIT_LINK'		=> generate_link('blocks&amp;mode=edit&amp;id='.$block['id'], array('admin' => true)),
-				'AUTH_LINK'		=> generate_link('blocks&amp;mode=auth&amp;id='.$block['id'], array('admin' => true)),
-
-				'DELETE_LINK' 	=> ($block['type'] != BLOCKTYPE_SYSTEM) ? generate_link('blocks&amp;mode=delete&amp;id='.$block['id'], array('admin' => true)) : '',
-				'TITLE'			=> $block['title'],
-				'TYPE'			=> $_CLASS['core_user']->get_lang('TYPE_'.$block['type']),
-
-				'WEIGHT_DOWN' 	=> ($block['weight'] < $weigth[$block['position']]),
-				'WEIGHT_UP'		=> ($block['weight'] > 1),
-
-				'WEIGHT_MOVE_UP' 	=> generate_link('blocks&amp;mode=weight&amp;option=up&amp;id='.$block['id'], array('admin' => true)),
-				'WEIGHT_MOVE_TOP' 	=> generate_link('blocks&amp;mode=weight&amp;option=top&amp;id='.$block['id'], array('admin' => true)),
-				'WEIGHT_MOVE_DOWN'	=> generate_link('blocks&amp;mode=weight&amp;option=down&amp;id='.$block['id'], array('admin' => true)),
-				'WEIGHT_MOVE_BOTTOM'=> generate_link('blocks&amp;mode=weight&amp;option=bottom&amp;id='.$block['id'], array('admin' => true)),
-		));
-	}
-
-    $_CLASS['core_template']->assign(array(
-		'L_BLOCK_REGULAR'	=> 'Add New regular Block',
-		'L_BLOCK_HTML'		=> 'Add New HTML Block',
-		'L_BLOCK_FEED'		=> 'Add New Feed Block',
-		'N_BLOCK_FILE'		=> generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FILE, array('admin' => true)),
-		'N_BLOCK_FEED'		=> generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FEED, array('admin' => true)),
-		'N_BLOCK_HTML'		=> generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_HTML, array('admin' => true))
-	));
-
-	$_CLASS['core_template']->display('admin/blocks/index.html');
+	$_CLASS['core_cache']->destroy('blocks');
 }
 
-function block_add($block = false, $error = false)
+function block_add($id = false, $block = false, $error = false)
 {
     global $_CLASS;
 
-    $id = false;
-
-	if (isset($_REQUEST['id']) && $id = get_id())
+	if ($id)
 	{
-		$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+		$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_id = '.$id);
 		$block = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
 		if (!$block)
 		{
-			url_redirect(generate_link('blocks', array('admin' => true)));
+			return;
 		}
 
-		check_position($block['position']);
+		check_position($block['block_position']);
 
 		if (isset($_POST['submit']))
 		{
 			// need to re-validate data with the db type
-			block_get_data($block_post, $error, $block['type']);
+			block_get_data($block_post, $error, $block['block_type']);
 			$block = array_merge($block, $block_post);
 		}
 
@@ -247,38 +223,38 @@
 	$b_show_content = $b_file = $b_rss_show = $b_rss_rate = $b_rss_url = false;
 	$b_header = $_CLASS['core_user']->lang['ADD_NEW'];
 
-	switch ($block['type'])
+	switch ($block['block_type'])
 	{
 		case BLOCKTYPE_HTML:
 			$b_show_content = true;
 		break;
 
 		case BLOCKTYPE_FILE:
-			$b_file = block_select($block['file']);
+			$b_file = block_select($block['block_file']);
 		break;
 
 		case BLOCKTYPE_FEED:
 			$b_rss_show = true;
-			$b_rss_rate = ($block['rss_rate']) ? $block['rss_rate'] : 3600; // 1hr defualt
-			$b_rss_url = ($block['rss_url']) ? $block['rss_url'] : '';
+			$b_rss_rate = ($block['block_rss_rate']) ? $block['block_rss_rate'] : 3600; // 1hr defualt
+			$b_rss_url = ($block['block_rss_url']) ? $block['block_rss_url'] : '';
 		break;
 	}
 
-	$_CLASS['core_template']->assign(array(
-		'B_ACTION'		=> generate_link('blocks&amp;mode=save&amp;type='.$block['type'].(($id) ? '&amp;id='.$id : ''), array('admin' => true)),
+	$_CLASS['core_template']->assign_array(array(
+		'B_ACTION'		=> generate_link('blocks&amp;mode=save&amp;type='.$block['block_type'].(($id) ? '&amp;id='.$id : ''), array('admin' => true)),
 		'B_HEADER'		=> $b_header,
-		'B_TITLE'		=> $block['title'],
+		'B_TITLE'		=> $block['block_title'],
 		'B_FILE' 		=> $b_file,
-		'B_POSITION'	=> block_position_select($block['position']),
-		'B_ACTIVE'		=> $block['active'],
+		'B_POSITION'	=> block_position_select($block['block_position']),
+		'B_ACTIVE'		=> $block['block_status'],
 		'B_SHOW_CONTENT'=> $b_show_content,
-		'B_CONTENT'		=> $block['content'],
+		'B_CONTENT'		=> $block['block_content'],
 		'B_RSS_SHOW'	=> $b_rss_show,
 		'B_RSS_REFRESH'	=> $b_rss_rate,
 		'B_RSS_URL'		=> $b_rss_url,
 		'B_ERROR'		=> $error,
-		'B_EXPIRES'		=> is_numeric($block['expires']) ? $_CLASS['core_user']->format_date($block['expires'], 'M d, Y h:i a') : $block['expires'],
-		'B_STARTS'		=> is_numeric($block['start']) ? $_CLASS['core_user']->format_date($block['start'], 'M d, Y h:i a') : $block['start'],
+		'B_EXPIRES'		=> is_numeric($block['block_expires']) ? $_CLASS['core_user']->format_date($block['block_expires'], 'M d, Y h:i a') : $block['block_expires'],
+		'B_STARTS'		=> is_numeric($block['block_starts']) ? $_CLASS['core_user']->format_date($block['block_starts'], 'M d, Y h:i a') : $block['block_starts'],
 		'B_CURRENT_TIME'=> $_CLASS['core_user']->format_date($_CLASS['core_user']->time),
 	));
 
@@ -335,33 +311,33 @@
 	$error = '';
 	$data = array();
 
-	$data['title'] = get_variable('b_title', 'POST', '');
+	$data['block_title'] = get_variable('b_title', 'POST', '');
 
 	// leave here for mods, maybe !
 	foreach ($data as $field => $value)
 	{
 		if (!$value)
 		{
-			$error .= $_CLASS['core_user']->lang['ERROR_'.$field].'<br />';
+			$error .= $_CLASS['core_user']->get_lang('ERROR_'.$field).'<br />';
 		}
 	}
 
-	$data['position'] = get_variable('b_position', 'POST', false, 'integer');
+	$data['block_position'] = get_variable('b_position', 'POST', false, 'integer');
 
-	if (!$data['position'] || !check_position($data['position'], false))
+	if (!$data['block_position'] || !check_position($data['block_position'], false))
 	{
-		$data['position'] = BLOCK_RIGHT;
+		$data['block_position'] = BLOCK_RIGHT;
 	}
 
-	$data['active'] = (int) get_variable('b_active', 'POST', 0);
-	$data['expires'] = get_variable('b_expires', 'POST', '');
-	$data['start'] = get_variable('b_time', 'POST', '');
+	$data['block_status'] = (int) get_variable('b_active', 'POST', 0);
+	$data['block_expires'] = get_variable('b_expires', 'POST', '');
+	$data['block_starts'] = get_variable('b_time', 'POST', '');
 
 	$start = $expires = '';
 
-	if ($data['start'])
+	if ($data['block_starts'])
 	{
-		$start = strtotime($data['start']);
+		$start = strtotime($data['block_starts']);
 
 		if (!$start || $start == -1)
 		{
@@ -369,9 +345,9 @@
 		}
 	}
 
-	if ($data['expires'])
+	if ($data['block_expires'])
 	{
-		$expires = strtotime($data['expires']);
+		$expires = strtotime($data['block_expires']);
 
 		if (!$expires || $expires == -1)
 		{
@@ -380,22 +356,22 @@
 	}
 
 	$appoved_types = array(BLOCKTYPE_FILE, BLOCKTYPE_FEED, BLOCKTYPE_HTML, BLOCKTYPE_SYSTEM);
-	$data['type'] = ($type) ? (int) $type : (int) get_variable('b_type', 'REQUEST', BLOCKTYPE_FILE);
+	$data['block_type'] = ($type) ? (int) $type : (int) get_variable('b_type', 'REQUEST', BLOCKTYPE_FILE);
 
-	if (!in_array($data['type'], $appoved_types, true))
+	if (!in_array($data['block_type'], $appoved_types, true))
 	{
-		$data['type'] = BLOCKTYPE_FILE;
+		$data['block_type'] = BLOCKTYPE_FILE;
 	}
 
-	$data['content'] = '';
+	$data['block_content'] = '';
 
-	switch ($data['type'])
+	switch ($data['block_type'])
 	{
 		case BLOCKTYPE_HTML:
 			//$data['content'] = modify_lines(trim(get_variable('b_content', 'POST', '')), '<br/>');
-			$data['content'] = modify_lines(trim(get_variable('b_content', 'POST', '')), '');
+			$data['block_content'] = modify_lines(trim(get_variable('b_content', 'POST', '')), '');
 
-			if (strlen($data['content']) < 6)
+			if (mb_strlen($data['block_content']) < 6)
 			{
 				$error .= $_CLASS['core_user']->lang['ERROR_content'].'<br />';
 			}
@@ -403,20 +379,20 @@
 		
 		case BLOCKTYPE_FILE:
 			// Add a file check here
-			$data['file'] = trim(get_variable('b_file', 'POST', ''));
+			$data['block_file'] = trim(get_variable('b_file', 'POST', ''));
 		break;
 		
 		case BLOCKTYPE_FEED:
 			// Add an url rss check here
-			$data['rss_url'] = get_variable('b_url', 'POST', '');
-			$data['rss_rate'] = get_variable('b_refresh', 'POST', '');
+			$data['block_rss_url'] = get_variable('b_url', 'POST', '');
+			$data['block_rss_rate'] = get_variable('b_refresh', 'POST', '');
 		break;
 	}
 
 	if (!$error)
 	{
-		$data['start'] = ($start) ? $_CLASS['core_user']->time_convert($start, 'gmt') : 0;
-		$data['expires'] = ($expires) ? $_CLASS['core_user']->time_convert($expires, 'gmt') : 0;
+		$data['block_starts'] = ($start) ? $_CLASS['core_user']->time_convert($start, 'gmt') : 0;
+		$data['block_expires'] = ($expires) ? $_CLASS['core_user']->time_convert($expires, 'gmt') : 0;
 	}
 }
 
@@ -451,38 +427,38 @@
 	return $block_position;
 }
 
-function block_save()
+function block_save($id = false)
 {
 	global $_CLASS;
 	
-	if (isset($_REQUEST['id']) && $id = get_id())
+	if ($id)
 	{
-		$result = $_CLASS['core_db']->query('SELECT weight, position, type FROM '.BLOCKS_TABLE.' WHERE id = '.$id);
+		$result = $_CLASS['core_db']->query('SELECT block_order, block_position, block_type FROM '.BLOCKS_TABLE.' WHERE block_id = '.$id);
 		$block = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 		
 		if (!$block)
 		{	
-			url_redirect(generate_link('blocks', array('admin' => true)));
+			return;
 		}
 
-		check_position($block['position']);
+		check_position($block['block_position']);
 		// need to validate data with the db type
-		block_get_data($data, $error, $block['type']);
-		
+		block_get_data($data, $error, $block['block_type']);
+
 		if ($error)
 		{
-			return block_add($data, $error);
+			return block_add($id, $data, $error);
 		}
 
-		//update old position weight if new position is not the same
-		if ($block['position'] != $data['position'])
+		//update old position order if new position is not the same
+		if ($block['block_position'] != $data['block_position'])
 		{
 			// Make an error msg, just incase this fails for some reason
-			blocks_change_position($data['position'], $id);
+			blocks_change_position($data['block_position'], $id);
 		}
 		
-		$sql = 'UPDATE '.BLOCKS_TABLE.' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE id = '.$id;
+		$sql = 'UPDATE '.BLOCKS_TABLE.' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE block_id = '.$id;
 	}
 	else
 	{
@@ -490,14 +466,14 @@
 
 		if ($error)
 		{
-			return block_add($data, $error);
+			return block_add(false, $data, $error);
 		}
-		
-		$result = $_CLASS['core_db']->query('SELECT MAX(weight) as weight FROM '.BLOCKS_TABLE.' WHERE position = '.$data['position']);
-		$maxweight = $_CLASS['core_db']->fetch_row_assoc($result);
+
+		$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM '.BLOCKS_TABLE.' WHERE block_position = '.$data['block_position']);
+		list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 		$_CLASS['core_db']->free_result($result);
 				
-		$data['weight'] = (int) $maxweight['weight'] + 1;
+		$data['block_order'] = (int) $max_order + 1;
 		
 		$sql = 'INSERT INTO '.BLOCKS_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data);
 	}

Modified: trunk/admin/bots.php
===================================================================
--- trunk/admin/bots.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/bots.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,88 +1,73 @@
 <?php
 
-$option = get_variable('option', 'GET', false);
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
+
 $id = (int) get_variable('id', 'GET', false);
 
-switch ($option)
+if ($id && isset($_REQUEST['option']))
 {
-	case 'activate':
+	require_once($site_file_root.'includes/functions_user.php');
 
-		if ($id)
-		{
-			$sql = 'UPDATE ' . USERS_TABLE . '
-				SET user_type = '.USER_BOT_ACTIVE.'
-				WHERE user_type = '.USER_BOT_INACTIVE.' AND user_id ='.$id;
-			$_CLASS['core_db']->sql_query($sql);
-		}
+	switch ($_REQUEST['option'])
+	{
+		case 'activate':
+			user_activate($id);
 		break;
 
-	case 'deactivate':
-
-		if ($id)
-		{
-			$sql = 'UPDATE ' . USERS_TABLE . '
-				SET user_type = '.USER_BOT_INACTIVE.'
-				WHERE user_type = '.USER_BOT_ACTIVE.' AND user_id ='.$id;
-			$_CLASS['core_db']->sql_query($sql);
-		}
+		case 'deactivate':
+			user_disable($id);
 		break;
-
-	case 'delete':
-
-		if ($id)
-		{
-			$sql = 'SELECT user_id, user_type
-				FROM ' . USERS_TABLE . ' 
-				WHERE user_id = '.$id;
-
-			$result = $_CLASS['core_db']>sql_query($sql);
-			$row = $_CLASS['core_db']>sql_fetchrow($result);
-			$_CLASS['core_db']->sql_freeresult($result);
-
-			if (!in_array($row['user_type'], array(USER_BOT_ACTIVE, USER_BOT_INACTIVE)))
+	
+		case 'delete':
+			if (display_confirmation())
 			{
-				continue;
+				$sql = 'SELECT user_id, user_type
+					FROM ' . USERS_TABLE . ' 
+					WHERE user_id = '.$id;
+	
+				$result = $_CLASS['core_db']->query($sql);
+				$row = $_CLASS['core_db']>fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+	
+				if ($row['user_type'] != USER_BOT)
+				{
+					break;
+				}
+	
+				user_delete($id);
+	
+				trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
 			}
-
-// remove permissions also
-			foreach (array(USERS_TABLE, USER_GROUP_TABLE) as $table)
-			{
-				$sql = "DELETE FROM $table
-					WHERE user_id = $id";
-				$_CLASS['core_db']->sql_query($sql);
-			}
-
-			trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
-		}
 		break;
+	}
 }
 
-$sql = 'SELECT user_id, username, user_type, user_lastvisit 
+$sql = 'SELECT user_id, username, user_status, user_last_visit 
 	FROM ' . USERS_TABLE . ' u
-	WHERE user_type IN (' . USER_BOT_ACTIVE . ', ' . USER_BOT_INACTIVE . ')
-		ORDER BY user_lastvisit DESC';
+	WHERE user_type = ' . USER_BOT . ' ORDER BY user_last_visit DESC';
 
-$result = $_CLASS['core_db']->sql_query($sql);
+$result = $_CLASS['core_db']->query($sql);
 
-while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
 	$_CLASS['core_template']->assign_vars_array('admin_bots', array(
-		'ACTIVE'		=> ($row['user_type'] == USER_BOT_ACTIVE) ? true : false,
+		'ACTIVE'		=> ($row['user_status'] == USER_ACTIVE),
 		'NAME'			=> $row['username'],
-		'DELETE_LINK'	=> generate_link('system&amp;mode=bots&amp;option=delete&amp;id='.$row['user_id'], array('admin' => true)),
-		'STATUS_LINK'	=> generate_link('system&amp;mode=bots&amp;option='.(($row['user_type'] == USER_BOT_ACTIVE) ? 'deactivate' :  'activate').'&amp;id='.$row['user_id'], array('admin' => true)),
-		'EDIT_LINK'		=> generate_link('system&amp;mode=bots&amp;options=edite&amp;id='.$row['user_id'], array('admin' => true)),
-		'LAST_VISIT'	=> ($row['user_lastvisit']) ?  $_CLASS['core_user']->format_date($row['user_lastvisit']) : $_CLASS['core_user']->lang['BOT_NEVER'],
-		'L_STATUS'		=> ($block['active']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+		'DELETE_LINK'	=> generate_link('bots&amp;option=delete&amp;id='.$row['user_id'], array('admin' => true)),
+		'STATUS_LINK'	=> generate_link('bots&amp;option='.(($row['user_status'] == USER_ACTIVE) ? 'deactivate' :  'activate').'&amp;id='.$row['user_id'], array('admin' => true)),
+		'EDIT_LINK'		=> generate_link('bots&amp;options=edite&amp;id='.$row['user_id'], array('admin' => true)),
+		'LAST_VISIT'	=> ($row['user_last_visit']) ?  $_CLASS['core_user']->format_date($row['user_last_visit']) : $_CLASS['core_user']->lang['BOT_NEVER'],
+		'L_STATUS'		=> ($row['user_status'] == USER_ACTIVE) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
 	));
 }
 
-$_CLASS['core_db']->sql_freeresult($result);
+$_CLASS['core_db']->free_result($result);
 
 $_CLASS['core_template']->assign('ACTION', generate_link('system&amp;mode=bots', array('admin' => true))); 
 
-$_CLASS['core_display']->display_head();
-$_CLASS['core_template']->display('admin/system/bots.html');
-$_CLASS['core_display']->display_footer();
+$_CLASS['core_display']->display(false, 'admin/bots.html');
 
 ?>
\ No newline at end of file

Modified: trunk/admin/functions/block_functions.php
===================================================================
--- trunk/admin/functions/block_functions.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/functions/block_functions.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -17,7 +17,7 @@
 {
 	global $_CLASS;
 
-	$result = $_CLASS['core_db']->query('SELECT position, auth FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+	$result = $_CLASS['core_db']->query('SELECT position, auth FROM ' . BLOCKS_TABLE . ' WHERE id='.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 	
@@ -30,17 +30,26 @@
 	
 	check_position($block['position']);
 	
-	if ($auth = $_CLASS['core_auth']->generate_auth_options($block['auth']))
+	$_CLASS['core_display']->display_header();
+
+	$auth = $_CLASS['core_auth']->generate_auth_options($block['auth']);
+
+	if ($auth !== false)
 	{
-		$block['auth'] = ($auth === true) ? '' : $auth;
-		$auth = ($auth === true) ? '' : $_CLASS['core_db']->escape(serialize($auth));
-	
-		$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE." SET auth = '$auth' WHERE id = $id");
+		if (is_null($auth))
+		{
+			$block['auth'] = $auth = '';
+		}
+		else
+		{
+			$block['auth'] = $auth;
+			$auth = $_CLASS['core_db']->escape(serialize($auth));
+		}
+
+		$_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . " SET auth = '$auth' WHERE id = $id");
 		$_CLASS['core_cache']->destroy('blocks');
 	}
 	
-	$_CLASS['core_display']->display_header();
-	$_CLASS['core_auth']->generate_auth_options($block['auth'], true);
 	$_CLASS['core_display']->display_footer();
 }
 		
@@ -48,7 +57,7 @@
 {
 	global $_CLASS;
 	
-	$result = $_CLASS['core_db']->query('SELECT active, position FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+	$result = $_CLASS['core_db']->query('SELECT block_status, block_position FROM ' . BLOCKS_TABLE . ' WHERE block_id='.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
@@ -56,15 +65,16 @@
 	{
 		trigger_error('BLOCK_NOT_FOUND');
 	}
-	check_position($block['position']);
-	$active = ($block['active']) ? 0 : 1;
 
-	$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET active='.$active.' WHERE id='.$id);
+	check_position($block['block_position']);
+	$status = ($block['block_status']) ? 0 : 1;
 
+	$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_status = '.$status.' WHERE block_id = '.$id);
+
 	$_CLASS['core_cache']->destroy('blocks');
 }
 
-function block_weight($id, $option)
+function block_order($id, $option)
 {
 	global $_CLASS;
 
@@ -73,7 +83,7 @@
 		return;
 	}
 
-	$result = $_CLASS['core_db']->query('SELECT position, weight FROM '.BLOCKS_TABLE.' WHERE id='. (int) $id);
+	$result = $_CLASS['core_db']->query('SELECT block_position, block_order FROM ' . BLOCKS_TABLE . ' WHERE block_id= ' . $id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
@@ -82,47 +92,47 @@
 		trigger_error('BLOCK_NOT_FOUND');
 	}
 
-	check_position($block['position']);
-	$block['weight'] = (int) $block['weight'];
+	check_position($block['block_position']);
+	settype($block['block_order'], 'integer');
 
 	switch ($option)
 	{
 		case 'down':
 
-			$result = $_CLASS['core_db']->query('SELECT MAX(weight) as weight FROM '.BLOCKS_TABLE.' WHERE position='.$block['position']);
-			$maxweight = $_CLASS['core_db']->fetch_row_assoc($result);
+			$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
+			list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 			$_CLASS['core_db']->free_result($result);
 
-			if ($block['weight'] < $maxweight['weight'])
+			if ($block['block_order'] < $max_order)
 			{
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight=weight-1 WHERE position='.$block['position'].' AND weight='.($block['weight'] + 1));
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight='.($block['weight'] + 1).' WHERE id ='. $id);
+				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position = '.$block['block_position'].' AND block_order='.($block['block_order'] + 1));
+				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = '.($block['block_order'] + 1).' WHERE block_id ='. $id);
 			}
 
 			$_CLASS['core_cache']->destroy('blocks');
 		break;
 
-		case 'up':
+		case 'bottom':
 
-			if ($block['weight'] && $block['weight'] != 1)
+			$result = $_CLASS['core_db']->query('SELECT MAX(weight) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
+			list($max_order) = $_CLASS['core_db']->fetch_row_($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if ($block['block_order'] < $max_order)
 			{
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight=weight+1 WHERE position='.$block['position'].' AND weight='.($block['weight'] - 1));
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight='.($block['weight'] -1 ).' WHERE id ='. $id);
+				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order > '.$block['block_order']);
+				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = '.$max_order.' WHERE block_id = '.$id);
 			}
 
 			$_CLASS['core_cache']->destroy('blocks');
 		break;
 
-		case 'bottom':
+		case 'up':
 
-			$result = $_CLASS['core_db']->query('SELECT MAX(weight) as weight FROM '.BLOCKS_TABLE.' WHERE position='.$block['position']);
-			$maxweight = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			if ($block['weight'] < $maxweight['weight'])
+			if ($block['block_order'] && $block['weight'] != 1)
 			{
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight=weight-1 WHERE position='.$block['position'].' AND weight > '.$block['weight']);
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight='.$maxweight['weight'].' WHERE id='.$id);
+				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order = '.($block['block_order'] - 1));
+				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order='.($block['block_order'] -1 ).' WHERE block_id ='. $id);
 			}
 
 			$_CLASS['core_cache']->destroy('blocks');
@@ -130,10 +140,10 @@
 
 		case 'top':
 
-			if ($block['weight'] != 1)
+			if ($block['block_order'] != 1)
 			{
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight=weight+1 WHERE position='.$block['position'].' AND weight < '.$block['weight']);
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight=1 WHERE id='.$id);
+				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order < '.$block['block_order']);
+				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = 1 WHERE block_id = '.$id);
 			}
 
 			$_CLASS['core_cache']->destroy('blocks');
@@ -141,46 +151,38 @@
 	}
 }
 
-function block_delete($id, $return_link = '')
+function block_delete($id, $return_link = false)
 {
     global $_CLASS;
 
-	$result = $_CLASS['core_db']->query('SELECT weight, type, position FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+	$result = $_CLASS['core_db']->query('SELECT block_order, block_type, block_position FROM ' . BLOCKS_TABLE . ' WHERE block_id='.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
-	if (!$block || ($block['type'] == BLOCKTYPE_SYSTEM))
+	if (!$block || ($block['block_type'] == BLOCKTYPE_SYSTEM))
 	{
 		trigger_error(($block) ? 'BLOCK_NOT_DELETABLE' : 'BLOCK_NOT_FOUND');
 	}
 
-	check_position($block['position']);
+	check_position($block['block_position']);
 
-// TEMP
-    if (get_variable('confirm', 'POST', false) == 'Delete')
+    if (display_confirmation())
     {
-        $result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight=weight-1 WHERE position='.$block['position'].' AND weight > '.$block['weight']);
-        $_CLASS['core_db']->query('DELETE from '.BLOCKS_TABLE.' where id='.$id);
+		$_CLASS['core_db']->query('DELETE from ' . BLOCKS_TABLE . ' where block_id='.$id);
+        $result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order > '.$block['block_order']);
 
         $_CLASS['core_cache']->destroy('blocks');
         
-        trigger_error('Block deleted<br/><a href="'.generate_link($return_link, array('admin' => true)).'">Click here to return</a>');	        
-    }
-	else
+        if ($return_link)
+        {
+			trigger_error('Block deleted<br/><a href="'.$return_link.'">Click here to return</a>');	        
+		}
+	}
+	
+	if ($return_link)
 	{
-		$_CLASS['core_display']->display_header();
-		echo $_CLASS['core_display']->table_open;
-		
-		echo '<form name="confirm" action="" method="post">
-		<center><b>If your certain that you want to remove this item click delete to continue<br/>';
-		echo '<a href="'.generate_link($_CLASS['core_user']->url, array('admin' => true)).'">Click here to return</a><br/><br/>
-		<input type="submit" name="confirm" value="Delete" class="btnmain" />&nbsp;&nbsp;<input type="submit" name="cancel" value="Cancel" class="button" />
-		</center>';
-
-		echo $_CLASS['core_display']->table_close;
-		
-        $_CLASS['core_display']->display_footer();
-    }
+		url_redirect($return_link);
+	}
 }
 
 ?>
\ No newline at end of file

Modified: trunk/admin/index.php
===================================================================
--- trunk/admin/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,7 +1,31 @@
 <?php
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
 
-if (($cms_news = $_CLASS['core_cache']->get('cms_news')) === false)
+if (isset($_REQUEST['user_mode']) && $_CLASS['core_auth']->admin_power('users') && display_confirmation())
 {
+	require_once($site_file_root.'includes/functions_user.php');
+	$user_id = get_variable('id', 'REQUEST', false, 'integer');
+
+	if ($user_id)
+	{
+		switch ($_REQUEST['user_mode'])
+		{
+			case 'remove':
+				user_delete($user_id);
+			break;
+
+			case 'activate':
+				user_activate($user_id);
+			break;
+		}
+	}
+}
+
+if (is_null($cms_news = $_CLASS['core_cache']->get('cms_news')))
+{
 	$cms_news = array();
 	
 	load_class($site_file_root.'includes/core_rss.php', 'core_rss');
@@ -13,31 +37,52 @@
 			$cms_news[] = $data;
 		}
 	}
+
 	$_CLASS['core_cache']->put('cms_news', $cms_news, 43200);
 }
 
+$server_name = empty($_SERVER['SERVER_NAME']) ? getenv('SERVER_NAME') : $_SERVER['SERVER_NAME'];
+$server_addr = empty($_SERVER['SERVER_ADDR']) ? getenv('SERVER_ADDR') : $_SERVER['SERVER_ADDR'];
+$server_software = empty($_SERVER['SERVER_SOFTWARE']) ? getenv('SERVER_SOFTWARE') : $_SERVER['SERVER_SOFTWARE'];
+
+$_CLASS['core_template']->assign_array(array(
+	'core_version'		=> 'CMS Apha 1',
+	'server_host'		=> ($server_name) ? $server_name." ( $server_addr )": 'N.A. ',
+	'server_software'	=> ($server_software) ? $server_software : 'N.A. ',
+	'database_version'	=> $_CLASS['core_db']->version(true),
+	'php_version'		=> PHP_VERSION,
+));
+	
 $_CLASS['core_template']->assign('cms_news', $cms_news);
 
-$sql = 'SELECT user_id, username, user_regdate
-	FROM ' . USERS_TABLE . ' 
-	WHERE user_type = ' . USER_INACTIVE . ' 
-		ORDER BY user_regdate ASC';
-	
-$result = $_CLASS['core_db']->sql_query($sql);
-
-while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+if ($_CLASS['core_auth']->admin_power('users'))
 {
-	$_CLASS['core_template']->assign_vars_array('admin_user', array(
-			'user_name'		=> $row['username'],
-			'registered'	=> $row['user_regdate'],
-			'active_link'	=> '',
-	));
+	// seperate this
+	$sql = 'SELECT user_id, username, user_regdate
+		FROM ' . USERS_TABLE . '
+			WHERE user_type = '.USER_NORMAL.'
+			AND user_status IN (' . USER_DISABLE . ',  '.USER_UNACTIVATED.')';
+		
+	$result = $_CLASS['core_db']->query_limit($sql, 20);
+	
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$type = ($row['user_id'] == USER_DISABLE) ? 'users_disabled' : 'users_unactivated';
+	
+		$_CLASS['core_template']->assign_vars_array($type, array(
+				'user_id'		=> $row['user_id'],
+				'user_name'		=> $row['username'],
+				'registered'	=> $_CLASS['core_user']->format_time($row['user_regdate']),
+				'link_profile'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+				'link_activate'	=> generate_link('&amp;user_mode=activate&amp;id=' . $row['user_id'], array('admin' => true)),
+				'link_remove'	=> generate_link('&amp;user_mode=remove&amp;id=' . $row['user_id'], array('admin' => true)),
+				'link_remind'	=> generate_link('&amp;user_mode=remind&amp;id=' . $row['user_id'], array('admin' => true)),
+				'link_details'	=> '',
+		));
+	}
+	$_CLASS['core_db']->free_result($result);
 }
 
-$_CLASS['core_db']->sql_freeresult($result);
-
-$_CLASS['core_display']->display_head();
 $_CLASS['core_template']->display('admin/index.html');
-$_CLASS['core_display']->display_footer();
 
 ?>
\ No newline at end of file

Modified: trunk/admin/system.php
===================================================================
--- trunk/admin/system.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/system.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -9,57 +9,34 @@
 
 $_CLASS['core_user']->add_lang('admin/system.php');
 
-$_CLASS['core_template']->assign(array(
-	'A_L_SITE'		=> generate_link('system&amp;mode=site', array('admin' => true)),
-	'A_L_WYSIWYG'	=> generate_link('system&amp;mode=wysiwyg', array('admin' => true)),
-	'A_L_SYSTEM'	=> generate_link('system&amp;mode=system', array('admin' => true)),
-	'A_L_USERS'		=> generate_link('system&amp;mode=users', array('admin' => true)),
-));
-
-$option = array(
-	'Site' => array(
-			'lang' => $_CLASS['core_user']->get_lang('SITE')),
-	'system' => array(
-			'lang' => $_CLASS['core_user']->get_lang('SYSTEM')),
-	'users' => array(
-			'lang' => $_CLASS['core_user']->get_lang('USERS_OPTIONS')),
-);
-
 $mode =	get_variable('mode', 'GET', false);
 
-if (!$mode || !in_array($mode, array_keys($option)))
+if (!$mode || !in_array($mode, array('Site', 'system')))
 {
-	$mode = 'Site';
+	$mode = 'site';
 }
 
-foreach ($option as $option_mode => $settings)
-{
-	$_CLASS['core_template']->assign_vars_array('a_options', array(
-		'ACTIVE'	=> ($option_mode == $mode) ? true : false,
-		'LANG'		=> $settings['lang'],
-		'LINK'		=> generate_link('system&amp;mode='.$option_mode, array('admin' => true)),
-	));
-}
+$_CLASS['core_template']->assign_array(array(
+	'LINK_SITE'		=> generate_link('system&amp;mode=site', array('admin' => true)),
+	'LINK_SYSTEM'	=> generate_link('system&amp;mode=system', array('admin' => true)),
+	'SYSTEM_MODE'	=> $mode,
+));
 
 $save = (isset($_POST['submit'])) ? true : false;
 
 switch ($mode)
 {
-	case 'Site':
+	case 'site':
 		admin_site($save);
-		break;
+	break;
 
-	case 'wysiwyg':
-		admin_wysiwyg($save);
-		break;
-
 	case 'users':
-		admin_users($save);
-		break;
+		//admin_users($save);
+	break;
 
 	case 'system':
 		admin_system($save);
-		break;
+	break;
 }
 
 function admin_save($data)
@@ -71,14 +48,14 @@
 		foreach ($option AS $db_name => $data_op)
 		{
 			$value = get_variable($data_op['post_name'], 'POST', false);
-	
+
 			if ($value != $_CORE_CONFIG[$section][$db_name])
 			{
-				//echo $data_op['post_name'].' : '. $db_name.' : '.$value.'<br/>';
 				set_core_config($section, $db_name, $value, false);
 			}
 		}
     }
+
 	$_CLASS['core_cache']->destroy('core_config');
 }
 
@@ -101,17 +78,15 @@
 
 	global $_CLASS, $_CORE_CONFIG;
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'A_OPTION'		=> 'site',
 		'ACTION'		=> generate_link('system', array('admin' => true)),
 		
 		'DEFAULT_THEME' 	=> $_CORE_CONFIG['global']['default_theme'],
 		'LINK_OPTIMIZATION' => $_CORE_CONFIG['global']['link_optimization'],
-		'SITE_LOGO'			=> $_CORE_CONFIG['global']['site_logo'],
 		'SITE_NAME'			=> $_CORE_CONFIG['global']['site_name'],
 		'SITE_URL'			=> $_CORE_CONFIG['global']['site_url'],
-		'SLOGAN'			=> $_CORE_CONFIG['global']['slogan'],
-		'START_DATE'		=> $_CORE_CONFIG['global']['startdate'],
+		'START_DATE'		=> $_CORE_CONFIG['global']['start_date'],
 
 		'FOOTER_FIRST' 		=> $_CORE_CONFIG['global']['foot1'],
 		'FOOTER_SECOND' 	=> $_CORE_CONFIG['global']['foot2'],
@@ -136,9 +111,7 @@
 	
 	closedir($handle);
 
-	$_CLASS['core_display']->display_head();
 	$_CLASS['core_template']->display('admin/system/index.html');
-	$_CLASS['core_display']->display_footer();
 }
 
 function admin_system($save)
@@ -174,7 +147,7 @@
 	
 	global $_CLASS, $_CORE_CONFIG;
    
-    $_CLASS['core_template']->assign(array(
+    $_CLASS['core_template']->assign_array(array(
 		'A_OPTION' 			=> 'system',
 		'ACTION'			=> generate_link('system&amp;mode=system', array('admin' => true)),
 		
@@ -197,9 +170,7 @@
 		
 		));
 
-	$_CLASS['core_display']->display_head();
 	$_CLASS['core_template']->display('admin/system/index.html');
-	$_CLASS['core_display']->display_footer();
 }
 
 function admin_users($save)
@@ -229,7 +200,7 @@
 
 	global $_CLASS, $_CORE_CONFIG;
 
-    $_CLASS['core_template']->assign(array(
+    $_CLASS['core_template']->assign_array(array(
 		'A_OPTION' => 'users',
 		'ACTION' => generate_link('system&amp;mode=users', array('admin' => true)),
 		'L_EDITOR_OPTION' => $_CLASS['core_user']->lang['EDITOR_OPTION'],
@@ -270,9 +241,7 @@
 			))
 		));
 
-		$_CLASS['core_display']->display_head();
 		$_CLASS['core_template']->display('admin/system/index.html');
-		$_CLASS['core_display']->display_footer();
 }
 
 ?>
\ No newline at end of file

Modified: trunk/admin.php
===================================================================
--- trunk/admin.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -91,13 +91,13 @@
 $_CORE_MODULE['sides'] = BLOCK_ALL;
 	
 $_CLASS['core_blocks']->add_block(array(
-		'title'		=> 'Administration',
-		'position'	=> BLOCK_LEFT,
-		'file'		=> 'block-Admin.php',
+		'block_title'		=> 'Administration',
+		'block_position'	=> BLOCK_LEFT,
+		'block_file'		=> 'block-Admin.php',
 	));
 
-load_class($site_file_root.'includes/core_editor.php', 'core_editor');
-$_CLASS['core_editor']->setup();
+//load_class($site_file_root.'includes/core_editor.php', 'core_editor');
+//$_CLASS['core_editor']->setup();
 require($file_path);
     
 ?>
\ No newline at end of file

Modified: trunk/blocks/block-Quick_Message.php
===================================================================
--- trunk/blocks/block-Quick_Message.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/blocks/block-Quick_Message.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,92 +1,107 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 if (!defined('VIPERAL'))
 {
     die;
 }
 
+if (!defined('QUICK_MESSAGE_TABLE'))
+{
+	define('QUICK_MESSAGE_TABLE', 'test_quick_message');
+}
+
 global $prefix, $_CLASS, $_CORE_CONFIG;
 
 $this->content = '<div style="width: 100%; height: '.$_CORE_CONFIG['quick_message']['height'].'px; overflow: auto;">';
 
-$result = $_CLASS['core_db']->query_limit('SELECT * from '.$prefix.'quick_message ORDER BY time DESC', 10);
+$result = $_CLASS['core_db']->query_limit('SELECT * from '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 10);
 
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	$words_array = explode(' ',html_entity_decode($row['message'], ENT_QUOTES, 'UTF-8'));
-	$row['message'] = '';
+	//$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES, 'UTF-8'));
+	$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES));
 
+	$row['message_text'] = '';
+
     foreach($words_array as $words)
     {
 		if (substr($words, 0, 4) != '[url')
 		{
-			$row['message'] .= ' '.wordwrap($words, 18, "\n", 1);
+			$row['message_text'] .= ' '.wordwrap($words, 18, "\n", 1);
 		}
 		else
 		{
-			$row['message'] .= $words;
+			$row['message_text'] .= $words;
 		}
     }
 
-	htmlentities($row['message'], ENT_QUOTES, 'UTF-8');
+	htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8');
 
 	unset($words_array, $words);
 	
 	$this->content .= '<div style="padding: 4px;">';
 	
-	if ($row['user_name'])
+	if ($row['poster_name'])
 	{
-		if ($row['user_id']) 
+		if ($row['poster_id']) 
 		{
-			$this->content .= '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'"><b>' . $row['user_name'] . ': </b></a>';
+			$this->content .= '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']).'"><b>' . $row['poster_name'] . ': </b></a>';
 		}
 		else
 		{
-			$this->content .= '<b>' . $row['user_name'] . ': </b>'; 
+			$this->content .= '<b>' . $row['poster_name'] . ': </b>'; 
 		}
 	}
 	else
 	{
 		$this->content .= '<b>' . $_CLASS['core_user']->lang['ANONYMOUS'] . ': </b>';
 	}
-	
-	if ($row['user_id'])
+
+	if ($row['poster_id'])
 	{
-		$row['message'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '<a href="$1" target="_blank">$2</a>', $row['message']);
+		$row['message_text'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '<a href="$1" target="_blank">$2</a>', $row['message_text']);
 	}
-	
-	$this->content .= $row['message'].'<br />'.(($_CORE_CONFIG['quick_message']['time']) ? $_CLASS['core_user']->format_date($row['time']) : '').'</div><hr/>';
+
+	$this->content .= $row['message_text'].'<br />'. $_CLASS['core_user']->format_date($row['message_time']) .'</div><hr/>';
 }
 
 $_CLASS['core_db']->free_result($result);
 
-$this->content .= '</div>';
+$this->content .= '</div><div align="center"><a href="'.generate_link('Quick_Message').'">Message History</a><br />';
 
-$this->content .= '<form name="post" method="post" action="'.generate_link('Quick_Message&amp;mode=add').'" enctype="multipart/form-data">'
-				.'		<div align="center"><a href="'.generate_link('Quick_Message').'">Message History</a><br />';
-if (!$_CLASS['core_user']->is_user) 
+if (!$_CLASS['core_user']->is_user && !$_CORE_CONFIG['quick_message']['anonymous_posting'])
 {
-	if ( !$_CORE_CONFIG['quick_message']['allow_anonymous'] )
-	{
-		$this->content .= 'Only registered users can post<br /><a href="'.generate_link('Control_Panel&amp;mode=register').'">[ Register&nbsp;|&nbsp;</a><a href="'.generate_link('Control_Panel').'">Login ]</a><br /></div>
-		';
-		return;
-	} elseif ( $_CORE_CONFIG['quick_message']['allow_anonymous'] == '2') {
-		$this->content .= 'Name: <br /><input class="post" type="text" style="width:90%;" name="user_name" size="10" maxlength="10" /><br />';
-	}
+	$this->content .= '<br/>Only registered users can post<br />[ <a href="'.generate_link('Control_Panel&amp;mode=register').'">Register</a>&nbsp;|&nbsp;<a href="'.generate_link('Control_Panel').'">Login</a> ]<br /></div>';
+
+	return;
 }
 
+$this->content .= '<form name="post" method="post" action="'.generate_link('Quick_Message&amp;mode=add').'">';
+
+if (!$_CLASS['core_user']->is_user && $_CORE_CONFIG['quick_message']['anonymous_posting'] == '2')
+{
+	$this->content .= 'Name: <br /><input class="post" type="text" style="width:90%;" name="poster_name" size="10" maxlength="10" /><br />';
+}
+
 $this->content .= 'Message <br/> <textarea name="message" style="width:90%;" rows="3"></textarea><br /><br />
 			<input class="button" type="submit" name="submit" value="Post" />
 		</div></form>';

Modified: trunk/images/Thumbs.db
===================================================================
(Binary files differ)

Modified: trunk/includes/auth/auth.php
===================================================================
--- trunk/includes/auth/auth.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/auth/auth.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,20 +1,29 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class core_auth
 {
 	var $_user_id;
-	var $_group_id;
+	var $_group_ids = array();
+	var $_group_default_id;
 
 	var $_got_data = false;
 	var $_admin_permission = array();
@@ -24,7 +33,7 @@
 		global $_CLASS;
 
 		$this->_user_id = ($user_id) ? $user_id : $_CLASS['core_user']->data['user_id'];
-		$this->_group_id = ($group_id) ? $group_id : $_CLASS['core_user']->data['group_id'];
+		$this->_group_default_id = ($group_id) ? $group_id : $_CLASS['core_user']->data['group_id'];
 	}
 
 	function user_auth($user_name, $user_password)
@@ -69,30 +78,31 @@
 	{
 		global $_CLASS;
 
-		$sql = 'SELECT * FROM ' . AUTH_ADMIN_TABLE ." 
-					WHERE user_id = {$this->_user_id}
-					OR group_id = {$this->_group_id} ORDER BY user_id";
+// should this be extended for defualt groups only, and all in group ?
+		$sql = 'SELECT * FROM ' . ADMIN_AUTH_TABLE ." 
+					WHERE member_user_id = {$this->_user_id}
+					OR member_group_id = {$this->_group_default_id} ORDER BY member_user_id";
 
 		$result = $_CLASS['core_db']->query($sql);
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			if ($row['status'] == STATUS_PENDING)
+			if ($row['admin_status'] == STATUS_PENDING)
 			{
 				continue;
 			}
 
-			if (!isset($this->_admin_permission[$row['section']]))
+			if (!isset($this->_admin_permission[$row['admin_section']]))
 			{
-				$this->_admin_permission[$row['section']]['core']['status'] = $row['status'];
+				$this->_admin_permission[$row['admin_section']]['core']['status'] = $row['admin_status'];
 
-				if ($row['options'] && is_array($row['options'] = @unserialize($row['options'])))
+				if (trim($row['admin_options']) && is_array($row['admin_options'] = @unserialize($row['admin_options'])))
 				{
 					$this->_admin_permission[$row['section']] = $row['options'];
 				}
 			}
 		}
-	
+
 		$this->_got_data = true;
 		$_CLASS['core_db']->free_result($result);
 	}
@@ -166,13 +176,7 @@
 
 				if (is_numeric($result))
 				{
-					$data = array(
-						'admin_login'		=> $login_array['admin_login'],
-						'auto_log'			=> (!empty($_POST['autologin'])) ? true : false,
-						'show_online'		=> (!empty($_POST['viewonline'])) ? 0 : 1,
-					);
-			
-					$_CLASS['core_user']->login($result, $data['admin_login'], $data['show_online']);
+					$_CLASS['core_user']->login($result, $login_array['admin_login'], !empty($_POST['hidden']), !empty($_POST['auto_login']));
 
 					$login_array['redirect'] = generate_link(get_variable('redirect', 'POST', $login_array['redirect']), array('admin' => $data['admin_login']));	
 
@@ -203,7 +207,7 @@
 			$confirm_image = false;
 		}
 
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'LOGIN_ERROR'			=> $_CLASS['core_user']->get_lang($error),
 			'LOGIN_EXPLAIN'			=> $_CLASS['core_user']->get_lang($login_array['explain']), 
 
@@ -221,9 +225,9 @@
 			'S_HIDDEN_FIELDS' 		=> $s_hidden_fields,
 		));
 
-		if ($login_array['full_screen'])
+		if (!$template && $login_array['full_screen'])
 		{
-			$_CLASS['core_template']->display('login_body_full.html');
+			$template = 'login_body_full.html';
 		}
 
 		$_CLASS['core_template']->display(($template) ? $template : 'login_body.html');
@@ -235,57 +239,64 @@
 
 	}
 
-	function auth($data)
+	function auth($options_array, $option = 'core_status')
 	{
 		global $_CLASS;
 
-		if (!$data)
+		if (!$options_array || (empty($options_array['groups']) && empty($options_array['users'])))
 		{
 			return true;
 		}
 
-		if (empty($data['users_allowed']) && empty($data['groups_allowed']))
+		if (isset($options_array['users'][$this->_user_id]))
 		{
+			return (isset($options_array['users'][$this->_user_id][$option]) ? $options_array['users'][$this->_user_id][$option] : false);
+		}
+
+		if (!empty($options_array['groups'][1]))
+		{
 			$return = true;
 
-			if (!empty($data['users_disallowed']) && in_array($this->_user_id, $data['users_disallowed']))
+			// need to sort/seperate this so that Only Default goups are first
+			foreach ($options_array['groups'][1] as $id => $group_options)
 			{
-				$return = false;
+				if ($id == $this->_group_default_id)
+				{
+					return (isset($group_options[$option]) ? $group_options[$option] : false);
+				}
 			}
+		}
 
-			if ($return && !empty($data['groups_disallowed']) && in_array($this->_group_id, $data['groups_disallowed']))
-			{
-				$return = false;
-			}
-
-			return $return;
-		}
-		else
+		if (!empty($options_array['groups'][0]))
 		{
-			if (!empty($data['users_allowed']) && in_array($this->_user_id, $data['users_allowed']))
+			//get the ids for all the groups
+			$ids = array_keys($options_array['groups'][0]);
+			//remove the groups that the user isn't a member of
+			$ids = array_intersect($ids, $this->__group_ids);
+			// need to sort/seperate this so that Only Default goups are first
+			foreach ($ids as $id)
 			{
-				return true;
-			}
-	
-			if (!empty($data['groups_allowed']) && in_array($this->_group_id, $data['groups_allowed']))
-			{
-				if (empty($data['users_disallowed']) || !in_array($this->_user_id, $data['users_disallowed']))
+// will need some sort of ordering if the option is not regular  true/false (0/1)
+				// if the option is not false, return it. The user has permission
+				if (!empty($options_array['groups'][0][$id][$option]))
 				{
-					return true;
+					return $group_options[$option];
 				}
 			}
+		}
 
-			return false;
-		}
+		return false;
 	}
 
-	function generate_auth_options($options = array(), $options_extend = false, $return_link = false)
+	function generate_auth_options($auth_options = array(), $options_extend = false, $return_link = false)
 	{
 		global $_CLASS, $site_file_root;
 
-		$options['groups'] = empty($options['groups']) ? array() : $options['groups'];
-		$options['users'] = empty($options['users']) ? array() : $options['users'];
+		$auth_options['groups'][0] = empty($auth_options['groups'][0]) ? array() : $auth_options['groups'][0];
+		$auth_options['groups'][1] = empty($auth_options['groups'][1]) ? array() : $auth_options['groups'][1];
 
+		$auth_options['users'] = empty($auth_options['users']) ? array() : $auth_options['users'];
+
 		$mode = $return = false;
 		$checks = array('add', 'remove', 'set');
 		
@@ -309,6 +320,8 @@
 					$setup['groups'] = get_variable('groups_add', 'POST', array(), 'array');
 					$setup['users'] = explode("\n", get_variable('users_add', 'POST'));
 
+					$submited_options = get_variable('auth_options', 'POST', array(), 'array');
+
 					if (count($setup['users']))
 					{
 						$setup['users'] = user_get_id($setup['users']);
@@ -332,16 +345,16 @@
 
 					foreach ($setup['groups'] as $id)
 					{
-						$options['groups'][$id] = array('status' => 1);
+						$auth_options['groups'][$submited_options['core_auth_type']][$id] = array('core_status' => $submited_options['core_status']);
 					}
 
 					foreach ($setup['users'] as $id)
 					{
-						$options['users'][$id] = array('status' => 1);
+						$auth_options['users'][$id] = array('core_status' => $submited_options['core_status']);
 					}
 
 					unset($setup);
-					//print_r($options);
+					//print_r($auth_options); die;
 				break;
 
 				case 'remove':
@@ -350,23 +363,30 @@
 					
 					$function = ($mode == 'add') ? 'array_merge' : 'array_diff';
 
-					foreach ($options['groups'] as $key => $ignore)
+// We need to tell with is only group and with is in group.
+
+					foreach ($ids['groups'] as $groups_id)
 					{
-						if (in_array($key, $ids['groups']))
+						if (isset($auth_options['groups'][1][$groups_id]))
 						{
-							unset($options['groups'][$key]);
+							unset($auth_options['groups'][1][$groups_id]);
 						}
+
+						if (isset($auth_options['groups'][0][$groups_id]))
+						{
+							unset($auth_options['groups'][0][$groups_id]);
+						}
 					}
 
-					foreach ($options['users'] as $key => $ignore)
+					foreach ($auth_options['users'] as $key => $ignore)
 					{
 						if (in_array($key, $ids['users']))
 						{
-							unset($options['users'][$key]);
+							unset($auth_options['users'][$key]);
 						}
 					}
 
-					//print_r($options);
+					//print_r($auth_options);
 				break;
 			
 				case 'set':
@@ -374,49 +394,53 @@
 				break;
 			}
 
-			foreach ($options as $option)
+			$return = null;
+
+			foreach ($auth_options as $test)
 			{
-				if (!empty($option))
+				if (!empty($test))
 				{
-					$return =& $options;
+					$return =& $auth_options;
 					break;
 				}
 			}
 		}
 
 		$group_list = $allowed_group_list = $disallowed_group_list = $allowed_user_list = $disallowed_user_list = '';
-		$groups_ids = array_keys($options['users']);
 
-		if (!empty($options['users']))
+		if (!empty($auth_options['users']))
 		{
 			$sql = 'SELECT user_id, username, user_colour
 				FROM ' . USERS_TABLE . '
-				WHERE user_id IN ('.implode(', ', array_keys($options['users'])).')
+				WHERE user_id IN ('.implode(', ', array_keys($auth_options['users'])).')
 					ORDER BY username';
 			$result = $_CLASS['core_db']->query($sql);
 
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$user_list = ($options['users'][$row['user_id']]['status'] === 1) ? 'allowed_user_list' : 'disallowed_user_list';
+				$user_list = ($auth_options['users'][$row['user_id']]['core_status'] == 1) ? 'allowed_user_list' : 'disallowed_user_list';
 
 				$$user_list .= '<option ' . (($row['user_colour']) ? ' style="color: #'.$row['user_colour'].';"' : '') . ' value="' . $row['user_id'] . '">' . $row['username'] . '</option>';
 			}
 			$_CLASS['core_db']->free_result($result);
 		}
+// this can be removed, when everthing else is updated
+		$groups_ids = array_merge(array_keys($auth_options['groups'][0]), array_keys($auth_options['groups'][1]));
 
 		if (!empty($groups_ids))
 		{
 			$sql = 'SELECT group_id, group_name, group_type 
 				FROM ' . GROUPS_TABLE . '
-				WHERE group_id IN ('.implode(', ', array_keys($options['groups'])).')
+				WHERE group_id IN ('.implode(', ', $groups_ids).')
 					ORDER BY group_type DESC, group_name';
 			$result = $_CLASS['core_db']->query($sql);
 
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$group_list = ($options['groups'][$row['group_id']]['status'] === 1) ? 'allowed_group_list' : 'disallowed_group_list';
+				$group_auth_type = isset($auth_options['groups'][1][$row['group_id']]['core_status']) ? 1 : 0;
+				$group_list = ($auth_options['groups'][$group_auth_type][$row['group_id']]['core_status']) ? 'allowed_group_list' : 'disallowed_group_list';
 				
-				$$group_list .= '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+				$$group_list .= '<option' . (($group_auth_type == 1) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
 				
 			}
 			$_CLASS['core_db']->free_result($result);
@@ -430,7 +454,7 @@
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$group_list .= '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+			$group_list .= '<option value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
 		}
 		$_CLASS['core_db']->free_result($result);
 	
@@ -444,7 +468,7 @@
 
 		$_CLASS['core_template']->display('permission.html');
 
-		return ($return !== false) ? $return : false;
+		return $return;
 	}
 }
 

Modified: trunk/includes/auth/auth_db.php
===================================================================
--- trunk/includes/auth/auth_db.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/auth/auth_db.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ?? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class auth_db extends core_auth
 {

Modified: trunk/includes/auth/auth_http.php
===================================================================
--- trunk/includes/auth/auth_http.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/auth/auth_http.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ?? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class auth_db extends core_auth
 {

Modified: trunk/includes/cache/cache.php
===================================================================
--- trunk/includes/cache/cache.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/cache/cache.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//	??															//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class cache
 {

Modified: trunk/includes/cache/cache_eaccelerator.php
===================================================================
--- trunk/includes/cache/cache_eaccelerator.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/cache/cache_eaccelerator.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//	??															//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class cache_eaccelerator extends cache
 {

Modified: trunk/includes/cache/cache_file.php
===================================================================
--- trunk/includes/cache/cache_file.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/cache/cache_file.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//	??															//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class cache_file extends cache
 {

Modified: trunk/includes/cache/cache_none.php
===================================================================
--- trunk/includes/cache/cache_none.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/cache/cache_none.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class cache_none extends cache
 {

Modified: trunk/includes/core_rss.php
===================================================================
--- trunk/includes/core_rss.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/core_rss.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 // Add channel support, rss_data[channel][item][item_branch]
 // nested items
 // maybe make this more xml specfic with another rss function?
@@ -127,7 +133,7 @@
 
 		if (mb_strpos($data, '200') === false)
 		{
-			echo $data;
+			//echo $data;
 
 			if (mb_strpos($data, '301') === true || mb_strpos($data, '301') === true)
 			{
@@ -165,13 +171,16 @@
 			{
 				$this->Close_connection();
 				$this->error = 'Document type is invalid';
+
 				return false;
 			}
 			
+			/*
 			if (mb_strpos($data, 'last-modified') !== false)
 			{
 				//
 			}
+			*/
 
 			if (mb_strpos($data, 'content-encoding') !== false && mb_strpos($data, 'gzip') !== false)
 			{
@@ -180,7 +189,7 @@
 		}
 
 		$this->rss_parser = xml_parser_create();
-		xml_set_object( $this->rss_parser, $this );
+		xml_set_object($this->rss_parser, $this);
 		xml_set_element_handler($this->rss_parser, 'tag_open', 'tag_close');
 		xml_set_character_data_handler($this->rss_parser, 'cdata');
 
@@ -196,7 +205,7 @@
 
 		if ($compressed)
 		{
-			$data = gzinflate(substr($data,10));
+			$data = gzinflate(substr($data, 10));
 		}
 
 		$status = xml_parse($this->rss_parser, $data, true);

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/db/mysql.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class db_mysql
 {
@@ -94,6 +100,11 @@
 		$this->return_on_error = $fail;
 	}
 
+	function return_on_error($fail = false)
+	{
+		$this->return_on_error = $fail;
+	}
+
 	function transaction($option = 'start')
 	{
 		if (!$this->link_identifier)
@@ -530,58 +541,62 @@
 		}
 	}
 
-	function add_table_field_int($name, $number_min, $number_max = false, $default = 0, $auto_increment = false)
+	function add_table_field_int($name, $setting_sent)
 	{
-		$length = max(strlen($number_min), strlen($number_max));
+		$setting = array('default' => null, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
+		$setting = array_merge($setting, $setting_sent);
 
-		if ($number_min >= -0 && $number_max <= 255)
+		$length = max(strlen($setting['min']), strlen($setting['max']));
+
+		if ($setting['min'] >= 0 && $setting['max'] <= 255)
 		{
 			// TINYINT UNSIGNED ( 0 to 255 )
 			$this->_fields[$name] =  "`$name` TINYINT($length) UNSIGNED";
 		}
-		elseif ($number_min >= -128 && $number_max <= 128)
+		elseif ($setting['min'] >= -128 && $setting['max'] <= 128)
 		{
 			// TINYINT ( -128 to 127 )
 			$this->_fields[$name] =  "`$name` TINYINT($length) DEFAULT";
 		}
-		elseif ($number_min >= 0 && $number_max <= 65535)
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 65535)
 		{
 			// SMALLINT UNSIGNED ( 0 to 65,535 )
 			$this->_fields[$name] =  "`$name` SMALLINT($length) UNSIGNED";
 		}
-		elseif ($number_min >= -32768 && $number_max <= 32767)
+		elseif ($setting['min'] >= -32768 && $setting['max'] <= 32767)
 		{
 			// SMALLINT ( -32,768 to 32,767 )
 			$this->_fields[$name] =  "`$name` SMALLINT($length)";
 		}
-		elseif ($number_min >= 0 && $number_max <= 16777215)
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 16777215)
 		{
 			// MEDIUMINT UNSIGNED ( 0 to 16,777,215 )
 			$this->_fields[$name] =  "`$name` MEDIUMINT($length) UNSIGNED";
 		}
-		elseif ($number_min >= -8388608 && $number_max <= 8388607)
+		elseif ($setting['min'] >= -8388608 && $setting['max'] <= 8388607)
 		{
 			// MEDIUMINT ( -8,388,608 to 8,388,607 )
 			$this->_fields[$name] =  "`$name` MEDIUMINT($length)";
 		}
-		elseif ($number_min >= -2147483647 && $number_max <= 2147483647)
+		elseif ($setting['min'] >= -2147483647 && $setting['max'] <= 2147483647)
 		{
 			// INT ( -2,147,483,647 to 2,147,483,647 )
 			$this->_fields[$name] =  "`$name` INT($length)";
 		}
-		elseif ($number_min >= 0 && $number_max <= 4294967295) // we'll do this last
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 4294967295) // we'll do this last
 		{
 			// INT UNSIGNED ( 0 to 4,294,967,295 )
 			$this->_fields[$name] =  "`$name` INT($length) UNSIGNED";
 		}
 
-		if ($auto_increment)
+		if ($setting['auto_increment'])
 		{
 			$this->_fields[$name] .= ' auto_increment';
 		}
 		else
 		{
-			$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '".(int) $default."'";
+			$this->_fields[$name] .= ($setting['null']) ? " NULL" : " NOT NULL";
+			$this->_fields[$name] .= is_null($setting['default']) ? '' : " DEFAULT '".(int) $setting['default']."'";
 		}
 	}
 
@@ -611,21 +626,22 @@
 		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
 	}
 
-	function add_table_field_char($name, $characters, $default = '', $padded = false)
+	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
-
 		$this->_fields[$name] = ($padded) ? "`$name` CHAR($characters)" :  "`$name` VARCHAR($characters)";
-		$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '$default'";
+		$this->_fields[$name] .= $null ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= is_null($default) ? '' : "DEFAULT '$default'";
 	}
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = ($index_name) ? $index_name : $field;
-
-		if (empty($this->_fields[$field]))
+		
+		/*if (empty($this->_fields[$field]))
 		{
 			return;
-		}
+		}*/
+		$field = is_array($field) ? implode(',', $field) : $field;
 
 		switch ($type)
 		{

Modified: trunk/includes/db/mysqli.php
===================================================================
--- trunk/includes/db/mysqli.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/db/mysqli.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class db_mysqli
 {
@@ -497,24 +503,24 @@
 		switch ($option)
 		{
 			case 'start':
-				$this->table_name = $name;
-				$this->fields = $this->indexs = array();
+				$this->_table_name = $name;
+				$this->_fields = $this->_indexs = array();
 			break;
 
 			case 'commit':
 			case 'return':
-				if (!$this->table_name)
+				if (!$this->_table_name)
 				{
 					return;
 				}
 
-				$fields = implode(", \n", $this->fields);
-				if ($indexs = implode(", \n", $this->indexs))
+				$fields = implode(", \n", $this->_fields);
+				if ($indexs = implode(", \n", $this->_indexs))
 				{
 					$fields .= ", \n";
 				}
 
-				$table = 'CREATE TABLE '.$this->table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
 				if ($option == 'return')
@@ -525,64 +531,68 @@
 				$this->sql_query($table);
 
 			case 'cancel':
-				$this->table_name = false;
-				$this->fields = $this->indexs = array();
+				$this->_table_name = false;
+				$this->_fields = $this->_indexs = array();
 			break;
 		}
 	}
 
-	function add_table_field_int($name, $number_min, $number_max = false, $default = 0, $auto_increment = false)
+	function add_table_field_int($name, $setting_sent)
 	{
-		$length = max(strlen($number_min), strlen($number_max));
+		$setting = array('default' => null, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
+		$setting = array_merge($setting, $setting_sent);
 
-		if ($number_min >= -0 && $number_max <= 255)
+		$length = max(strlen($setting['min']), strlen($setting['max']));
+
+		if ($setting['min'] >= 0 && $setting['max'] <= 255)
 		{
 			// TINYINT UNSIGNED ( 0 to 255 )
-			$this->fields[$name] =  "`$name` TINYINT($length) UNSIGNED";
+			$this->_fields[$name] =  "`$name` TINYINT($length) UNSIGNED";
 		}
-		elseif ($number_min >= -128 && $number_max <= 128)
+		elseif ($setting['min'] >= -128 && $setting['max'] <= 128)
 		{
 			// TINYINT ( -128 to 127 )
-			$this->fields[$name] =  "`$name` TINYINT($length) DEFAULT";
+			$this->_fields[$name] =  "`$name` TINYINT($length) DEFAULT";
 		}
-		elseif ($number_min >= 0 && $number_max <= 65535)
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 65535)
 		{
 			// SMALLINT UNSIGNED ( 0 to 65,535 )
-			$this->fields[$name] =  "`$name` SMALLINT($length) UNSIGNED";
+			$this->_fields[$name] =  "`$name` SMALLINT($length) UNSIGNED";
 		}
-		elseif ($number_min >= -32768 && $number_max <= 32767)
+		elseif ($setting['min'] >= -32768 && $setting['max'] <= 32767)
 		{
 			// SMALLINT ( -32,768 to 32,767 )
-			$this->fields[$name] =  "`$name` SMALLINT($length)";
+			$this->_fields[$name] =  "`$name` SMALLINT($length)";
 		}
-		elseif ($number_min >= 0 && $number_max <= 16777215)
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 16777215)
 		{
 			// MEDIUMINT UNSIGNED ( 0 to 16,777,215 )
-			$this->fields[$name] =  "`$name` MEDIUMINT($length) UNSIGNED";
+			$this->_fields[$name] =  "`$name` MEDIUMINT($length) UNSIGNED";
 		}
-		elseif ($number_min >= -8388608 && $number_max <= 8388607)
+		elseif ($setting['min'] >= -8388608 && $setting['max'] <= 8388607)
 		{
 			// MEDIUMINT ( -8,388,608 to 8,388,607 )
-			$this->fields[$name] =  "`$name` MEDIUMINT($length)";
+			$this->_fields[$name] =  "`$name` MEDIUMINT($length)";
 		}
-		elseif ($number_min >= -2147483647 && $number_max <= 2147483647)
+		elseif ($setting['min'] >= -2147483647 && $setting['max'] <= 2147483647)
 		{
 			// INT ( -2,147,483,647 to 2,147,483,647 )
-			$this->fields[$name] =  "`$name` INT($length)";
+			$this->_fields[$name] =  "`$name` INT($length)";
 		}
-		elseif ($number_min >= 0 && $number_max <= 4294967295) // we'll do this last
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 4294967295) // we'll do this last
 		{
 			// INT UNSIGNED ( 0 to 4,294,967,295 )
-			$this->fields[$name] =  "`$name` INT($length) UNSIGNED";
+			$this->_fields[$name] =  "`$name` INT($length) UNSIGNED";
 		}
 
-		if ($auto_increment)
+		if ($setting['auto_increment'])
 		{
-			$this->fields[$name] .= ' auto_increment';
+			$this->_fields[$name] .= ' auto_increment';
 		}
 		else
 		{
-			$this->fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '".(int) $default."'";
+			$this->_fields[$name] .= ($setting['null']) ? " NULL" : " NOT NULL";
+			$this->_fields[$name] .= is_null($setting['default']) ? '' : " DEFAULT '".(int) $setting['default']."'";
 		}
 	}
 
@@ -591,56 +601,57 @@
 		if ($characters <= 255)
 		{
 			// TINYTEXT 1 to 255 Characters
-			$this->fields[$name] =  "`$name` TINYTEXT";
+			$this->_fields[$name] =  "`$name` TINYTEXT";
 		}
 		elseif ($characters <= 65535)
 		{
 			// TEXT 1 to 65535 Characters
-			$this->fields[$name] =  "`$name` TEXT";
+			$this->_fields[$name] =  "`$name` TEXT";
 		}
 		elseif ($characters <= 16777215)
 		{
 			// MEDIUMTEXT 1 to 16,777,215 Characters
-			$this->fields[$name] =  "`$name` MEDIUMTEXT";
+			$this->_fields[$name] =  "`$name` MEDIUMTEXT";
 		}
 		elseif ($characters <= 4294967295)
 		{
 			// LONGTEXT 1 to 4,294,967,295 Characters
-			$this->fields[$name] =  "`$name` LONGTEXT";
+			$this->_fields[$name] =  "`$name` LONGTEXT";
 		}
 
-		$this->fields[$name] .= ($null) ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
 	}
 
-	function add_table_field_char($name, $characters, $default = '', $padded = false)
+	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
-		$this->fields[$name] =  ($padded) ? "`$name` CHAR($characters)" : "`$name` VARCHAR($characters)";
-		$this->fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '$default'";
+		$this->_fields[$name] = ($padded) ? "`$name` CHAR($characters)" :  "`$name` VARCHAR($characters)";
+		$this->_fields[$name] .= $null ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= is_null($default) ? '' : "DEFAULT '$default'";
 	}
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = ($index_name) ? $index_name : $field;
-
-		//$field = (is_array($field)) ? $field : array($field);
-
-		if (empty($this->fields[$field]))
+		
+		/*if (empty($this->_fields[$field]))
 		{
 			return;
-		}
+		}*/
+		$field = is_array($field) ? implode(',', $field) : $field;
 
 		switch ($type)
 		{
 			case 'index':
 			case 'unique':
-				$this->indexs[$index_name] = (($type == 'UNIQUE') ? 'UNIQUE ' : '') . "KEY `$index_name` (`$field`)";
+				$this->_indexs[$index_name] = (($type == 'UNIQUE') ? 'UNIQUE ' : '') . "KEY `$index_name` (`$field`)";
 			break;
 
 			case 'primary':
-				$this->indexs['primary'] = "PRIMARY KEY (`$field`)";
+				$this->_indexs['primary'] = "PRIMARY KEY (`$field`)";
 			break;
 		}
 	}
+
 }
 
 ?>
\ No newline at end of file

Modified: trunk/includes/display/blocks.php
===================================================================
--- trunk/includes/display/blocks.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/display/blocks.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 /* to do
 move Auth, lang, and expire/begin checks to load_blocks
@@ -24,7 +30,7 @@
 	var $info;
 	var $content;
 	var $template;
-	
+
 	/*
 		Check to see there's any blocks for the specified side
 		should be used to stop themes from displaying blank sides
@@ -34,24 +40,24 @@
 // expand this for center blocks
 		static $side_check = array();
 		
-		if (!empty($side_check[$side]))
+		if (isset($side_check[$side]))
 		{
 			return $side_check[$side];
 		}
-		
+
 		global $_CORE_MODULE, $_CLASS;
 
 		$trueside = $side;
-		
+
 		if ($_CLASS['core_user']->lang['DIRECTION'] == 'rtl')
 		{
-			$side = (($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT);
+			$side = ($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
 		}
 			
 		if ($_CORE_MODULE['sides'] == BLOCK_ALL || ($side == BLOCK_LEFT && $_CORE_MODULE['sides'] == BLOCK_LEFT) || ($side == BLOCK_RIGHT && $_CORE_MODULE['sides'] == BLOCK_RIGHT))
 		{
 			$this->load_blocks();
-			
+
 			if (!empty($this->blocks_array[$side]))
 			{
 				return $side_check[$trueside] = $side;
@@ -60,7 +66,7 @@
 		
 		return $side_check[$trueside] = false;
 	}
-	
+
 	/*
 		Load Blocks from cache or databases, also run needed checks
 	*/
@@ -71,49 +77,50 @@
 		{
 			return;
 		}
-		
+
 		global $_CLASS;
 
 		if (is_null($this->blocks_array = $_CLASS['core_cache']->get('blocks')))
 		{
-			$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE active > 0 ORDER BY weight ASC');
-			
+			$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_status = 1 ORDER BY block_order ASC');
+
 			$this->blocks_array = array();
-			
+
 			while($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$row['auth'] = ($row['auth']) ? unserialize($row['auth']) : '';
-				$this->blocks_array[$row['position']][] = $row;
+				$row['block_auth'] = ($row['block_auth']) ? unserialize($row['block_auth']) : '';
+				$this->blocks_array[$row['block_position']][] = $row;
 			}
-			
+
 			$_CLASS['core_db']->free_result($result);
 			$_CLASS['core_cache']->put('blocks', $this->blocks_array);
+
 			$_CLASS['core_cache']->save();
 		}
-		
+
 		$_CLASS['core_cache']->remove('blocks');
 		$this->blocks_loaded = true;
 	}
-	
+
 	/*
 	*/
 	function add_block($data, $position = false)
 	{
-		$option_array = array('title','position', 'content', 'file' , 'modules', 'start' ,'expires', 'id',	'auth',	'type');
-		
+		$option_array = array('block_title','block_position', 'block_content', 'block_file' , 'block_starts' ,'block_expires', 'block_id',	'block_auth',	'block_type');
+
 		foreach($option_array as $option)
 		{
 			$data_perpared[$option] = (empty($data[$option])) ? '' : $data[$option];
 		}
-		
-		$this->blocks_array[$data['position']][] = $data_perpared;
+
+		$this->blocks_array[$data_perpared['block_position']][] = $data_perpared;
 	}
-	
+
 	/*
 	*/
-	function display($position, $template_name = false)
+	function display($position)
 	{
-		//$this->template_name = $template_name;
+		$this->display_position = $position;
 
 		if ($position == BLOCK_LEFT || $position == BLOCK_RIGHT)
 		{
@@ -124,27 +131,27 @@
 				return false;
 			}
 		}
-		
+
 		$this->load_blocks();
-			
+
 		if (empty($this->blocks_array[$position]))
 		{
 			return false;
 		}
-		
+
 		static $expire_updated = false;
 		global $_CLASS;
-		
+
 		$this->content = '';
-		
+
 		foreach($this->blocks_array[$position] as $this->block)
 		{
-			if ($this->block['auth'] && !$_CLASS['core_auth']->auth($this->block['auth']) && !$_CLASS['core_auth']->admin_power('blocks') )
+			if ($this->block['block_auth'] && !$_CLASS['core_auth']->auth($this->block['block_auth']) && !$_CLASS['core_auth']->admin_power('blocks'))
 			{
 				continue;
 			}
 //language check here.
-			if ($this->block['expires'] && !$expire_updated && ($_CLASS['core_user']->time > $this->block['expires']))
+			if ($this->block['block_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $this->block['block_expires']))
 			{
 				$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET active=0 WHERE expires > 0 AND expires <='.$_CLASS['core_user']->time);
 										
@@ -153,26 +160,28 @@
 
 				continue;
 			}
-			
-			if ($this->block['start'] && ($this->block['start'] > $_CLASS['core_user']->time))
+
+			if ($this->block['block_starts'] && ($this->block['block_starts'] > $_CLASS['core_user']->time))
 			{
 				continue;
 			}
-			
-			if ($this->block['modules'])
+
+			/*
+			if ($this->block['block_modules'])
 			{
-				$this->block['modules'] = unserialize($this->block['modules']);
+				$this->block['block_modules'] = unserialize($this->block['block_modules']);
 // Homepage needs it's own value
-				if (!in_array($_CORE_MODULE['title'], $this->block['modules']['show'] || in_array($_CORE_MODULE['title'], $this->block['modules']['hide'])))
+				if (!in_array($_CORE_MODULE['title'], $this->block['block_modules']['show'] || in_array($_CORE_MODULE['title'], $this->block['block_modules']['hide'])))
 				{
 					continue;
 				}
 			}
-			
+			*/
+
 			$this->display_blocks();
 			$this->content = '';
 		}
-		
+
 		unset($this->blocks_array[$position]);
 	}
 
@@ -180,29 +189,26 @@
 	*/
 	function display_blocks()
 	{
-		Switch ($this->block['type'])
+		Switch ($this->block['block_type'])
 		{
 			case BLOCKTYPE_FILE:
 			case BLOCKTYPE_SYSTEM:
-				
 				$this->block_file();
-				break;
+			break;
 				
 			case BLOCKTYPE_MESSAGE:
 			case BLOCKTYPE_MESSAGE_GLOBAL:
-			
 				$this->block_message();
-				break;
+			break;
 					
 			case BLOCKTYPE_HTML:
 				$this->block_html();
-				break;
+			break;
 				
 			case BLOCKTYPE_FEED;
 				$this->block_feed();
-				break;
+			break;
 		}
-		
 		return;
 	}
 
@@ -211,17 +217,17 @@
 	function block_file()
 	{
 		global $_CLASS, $site_file_root;
-		
-		if ($this->block['file'] && file_exists($site_file_root.'blocks/'.$this->block['file']))
+
+		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/'.$this->block['block_file']))
 		{
 			$this->info = false;
 
-			//$_CLASS['core_error_handler']->debug_start($this->block['title']);
-		
-			include($site_file_root.'blocks/'.$this->block['file']);
-			
-			//$_CLASS['core_error_handler']->debug_stop($this->block['title']);
+			//$_CLASS['core_error_handler']->debug_start($this->block['block_title']);
 
+			include($site_file_root.'blocks/'.$this->block['block_file']);
+
+			//$_CLASS['core_error_handler']->debug_stop($this->block['block_title']);
+
 			if (!$this->content && !$this->template)
 			{
 				if ($_CLASS['core_auth']->admin_power('blocks'))
@@ -246,10 +252,10 @@
 			}		
 		}
 
-		//$this->content .= '<div style="text-align: center;"><br />'.$_CLASS['core_error_handler']->debug_get($this->block['title'], 'formated').'</div>';
-		//$_CLASS['core_error_handler']->debug_remove($this->block['title']);
+		//$this->content .= '<div style="text-align: center;"><br />'.$_CLASS['core_error_handler']->debug_get($this->block['block_title'], 'formated').'</div>';
+		//$_CLASS['core_error_handler']->debug_remove($this->block['block_title']);
 
-		if ($this->block['position'] == BLOCK_LEFT || $this->block['position'] == BLOCK_RIGHT)
+		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
 		{
 			$this->block_side();
 		}
@@ -258,61 +264,60 @@
 			$this->block_center();
 		}
 	}
-			
+
 	function block_message()
 	{
 		global $_CLASS;
-		
-		if (($this->block['type'] == BLOCKTYPE_MESSAGE) && (!$_CLASS['core_display']->homepage))
+
+		if (($this->block['block_type'] == BLOCKTYPE_MESSAGE) && (!$_CLASS['core_display']->homepage))
 		{
 			return;
 		}
-		
+
 		if ($_CLASS['core_auth']->admin_power('messages'))
 		{
-			$expires = ($this->block['expires']) ? $_CLASS['core_user']->lang['EXPIRES'].' '.$_CLASS['core_user']->format_date($this->block['expires']) : false;
-			$edit_link = generate_link('messages&amp;mode=edit&amp;id='.$this->block['id'], array('admin' => true));
-		
+			$expires = ($this->block['block_expires']) ? $_CLASS['core_user']->lang['EXPIRES'].' '.$_CLASS['core_user']->format_date($this->block['block_expires']) : false;
+			$edit_link = generate_link('messages&amp;mode=edit&amp;id='.$this->block['block_id'], array('admin' => true));
 		}
 		else
 		{
 		
 			$edit_link = $expires = false;
 		}
-		
-		$postion = ($this->block['position'] == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
-		
+
+		$postion = ($this->display_position == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
+
 		$_CLASS['core_template']->assign_vars_array('message_block_'.$postion, array(
-				//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['title']),
-				'title'		=> $this->block['title'],
-				'collapsed'	=> collapsed_items('block_'.$this->block['id']),
-				'content'	=> $this->block['content'],
+				//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
+				'title'		=> $this->block['block_title'],
+				'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
+				'content'	=> $this->block['block_content'],
 				'expires'	=> $expires,
 				'edit_link'	=> $edit_link,
-				'id'		=> $this->block['id'],
+				'id'		=> $this->block['block_id'],
 		));
 	}
-	
+
 	function block_side()
 	{
 		global $_CLASS;
 		
-		$position = ($this->block['position'] == BLOCK_RIGHT) ? 'right' : 'left';
+		$position = ($this->display_position == BLOCK_RIGHT) ? 'right' : 'left';
 		
 		$_CLASS['core_template']->assign_vars_array('block_'.$position, array(
-			//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['title']),
-			'title'		=> $this->block['title'],
+			//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
+			'title'		=> $this->block['block_title'],
 			'content'	=> $this->content,
-			'collapsed'	=> collapsed_items('block_'.$this->block['id']),
-			'id'		=> $this->block['id'],
+			'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
+			'id'		=> $this->block['block_id'],
 		));
 	}
-	
+
 	function block_html()
 	{
-		$this->content = $this->block['content'];
-		
-		if ($this->block['position'] == BLOCK_LEFT || $this->block['position'] == BLOCK_RIGHT)
+		$this->content = $this->block['block_content'];
+
+		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
 		{
 			$this->block_side();
 		}
@@ -321,17 +326,17 @@
 			$this->block_center();
 		}
 	}
-	
+
 	function block_feed()
 	{
 		global $site_file_root, $_CLASS;
 // think about disabling the block automatically if there's url problems
 // update core_rss file
-		if ($this->block['content'] && (!$this->block['rss_expires'] || $this->block['rss_expires'] > time()))
+		if ($this->block['block_content'] && (!$this->block['block_rss_expires'] || $this->block['block_rss_expires'] > time()))
 		{
-			$this->content = $this->block['content'];
-			
-			if ($this->block['position'] == BLOCK_LEFT || $this->block['position'] == BLOCK_RIGHT)
+			$this->content = $this->block['block_content'];
+
+			if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
 			{
 				$this->block_side();
 			}
@@ -339,13 +344,13 @@
 			{
 				$this->block_center();
 			}
-			
+
 			return;
 		}
-		
-		if ($this->block['file'] && file_exists($site_file_root.'blocks/rss/'.$this->block['file']))
+
+		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/rss/'.$this->block['block_file']))
 		{
-			include($site_file_root.'blocks/rss/'.$this->block['file']);
+			include($site_file_root.'blocks/rss/'.$this->block['block_file']);
 			
 			if (!$this->content)
 			{
@@ -357,14 +362,14 @@
 			load_class($site_file_root.'includes/core_rss.php', 'core_rss');
 			$_CLASS['core_rss']->setup(false, array('title', 'link'));
 				
-			if (!$_CLASS['core_rss']->get_rss($this->block['rss_url']))
+			if (!$_CLASS['core_rss']->get_rss($this->block['block_rss_url']))
 			{
 	//admin only message here
 				return;
 			}
-			
+
 			$this->content = '<center><br />';
-			
+
 			while ($data = $_CLASS['core_rss']->get_rss_data())
 			{
 				$this->content .= '<a href="'.$data['link'].'" target="new">'.$data['title'].'</a><hr width="30%"/>';
@@ -378,22 +383,22 @@
 			$this->content .= '</center>';
 		}
 
-		settype($this->block['rss_rate'], 'integer');
+		settype($this->block['block_rss_rate'], 'integer');
 
-		if ($this->block['rss_rate'] !== -1)
+		if ($this->block['block_rss_rate'] !== -1)
 		{
-			$this->block['rss_expires'] = ($this->block['rss_rate']) ? time() + $this->block['rss_rate'] : 0;
+			$this->block['block_rss_expires'] = ($this->block['block_rss_rate']) ? gmtime() + (int) $this->block['block_rss_rate'] : 0;
 			
 			$sql = 'UPDATE '.BLOCKS_TABLE."
-				SET content='".$_CLASS['core_db']->escape($this->content)."', rss_expires='".$this->block['rss_expires']."' 
-					WHERE id=".$this->block['id'];
+				SET block_content = '".$_CLASS['core_db']->escape($this->content)."', block_rss_expires = ".$this->block['block_rss_expires']." 
+					WHERE block_id = ".$this->block['block_id'];
 				
 			$_CLASS['core_db']->query($sql);
 
 			$_CLASS['core_cache']->destroy('blocks');
 		}
-		
-		if ($this->block['position'] == BLOCK_LEFT || $this->block['position'] == BLOCK_RIGHT)
+
+		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
 		{
 			$this->block_side();
 		}
@@ -402,15 +407,15 @@
 			$this->block_center();
 		}
 	}
-	
+
 	function block_center()
 	{
 		global $_CLASS;
 		
-		$position = ($this->block['position'] == BLOCK_TOP) ? 'center' : 'bottom';
+		$position = ($this->display_position == BLOCK_TOP) ? 'center' : 'bottom';
 		
 		$_CLASS['core_template']->assign_vars_array('block_'.$position , array(
-			'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['title']),
+			'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
 			'CONTENT'	=> $this->content,
 			'TEMPLATE'	=> $this->template
 		));

Modified: trunk/includes/display/display.php
===================================================================
--- trunk/includes/display/display.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/display/display.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class core_display
 {
@@ -158,7 +164,7 @@
 			$this->message = '<b>System is in maintenance mode</b><br />';
 		}
 
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'SITE_LANG'			=>	$_CLASS['core_user']->lang['LANG'],
 			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.$_CORE_MODULE['title'],
 			'SITE_BASE'			=>	generate_base_url(),
@@ -234,17 +240,14 @@
 
 		$debug_output = 'Code Time : '.round($totaltime, 4).'s | Queries Time '.round($_CLASS['core_db']->queries_time, 4).'s | ' . $_CLASS['core_db']->num_queries . ' Queries  ] <br /> [ GZIP : ' .  ((in_array('ob_gzhandler' , ob_list_handlers())) ? 'On' : 'Off' ) . ' | Load : '  . (($_CLASS['core_user']->load) ? $_CLASS['core_user']->load : 'N/A');
 
-		if (function_exists('memory_get_usage'))
+		if ($memory_usage = get_memory_usage())
 		{
-			if ($memory_usage = memory_get_usage())
-			{
-				global $base_memory_usage;
-				
-				$memory_usage -= $base_memory_usage;
-				$memory_usage = ($memory_usage >= 1048576) ? round((round($memory_usage / 1048576 * 100) / 100), 2) . ' ' . $_CLASS['core_user']->lang['MB'] : (($memory_usage >= 1024) ? round((round($memory_usage / 1024 * 100) / 100), 2) . ' ' . $_CLASS['core_user']->lang['KB'] : $memory_usage . ' ' . $_CLASS['core_user']->lang['BYTES']);
+			global $base_memory_usage;
+			
+			$memory_usage -= $base_memory_usage;
+			$memory_usage = ($memory_usage >= 1048576) ? round((round($memory_usage / 1048576 * 100) / 100), 2) . ' ' . $_CLASS['core_user']->lang['MB'] : (($memory_usage >= 1024) ? round((round($memory_usage / 1024 * 100) / 100), 2) . ' ' . $_CLASS['core_user']->lang['KB'] : $memory_usage . ' ' . $_CLASS['core_user']->lang['BYTES']);
 
-				$debug_output .= ' | Memory Usage: ' . $memory_usage;	
-			}
+			$debug_output .= ' | Memory Usage: ' . $memory_usage;	
 		}
 
 		return $debug_output;
@@ -289,39 +292,4 @@
 	}
 }
 
-function collapsed_items($marker, $cookie = 'collapsed_items') 
-{
-    static $collapsed_items_array = array();
-
-    if (!isset($collapsed_items_array[$cookie]))
-    {
-		$cookie_data = get_variable($cookie, 'COOKIE');
-		$collapsed_items_array[$cookie] = ($cookie_data) ? explode(':', $cookie_data) : array();
-    }
-
-    return in_array($marker, $collapsed_items_array[$cookie]);
-}
-
-function hideblock($id) 
-{
-    // From cpgnuke - http://dragonflycms.org/
-    static $hiddenblocks = false;
-
-    if (!$hiddenblocks) 
-    {
-		$hiddenblocks = array();
-
-        if (isset($_COOKIE['hiddenblocks']))
-        {
-            $tmphidden = explode(':', $_COOKIE['hiddenblocks']);
-			foreach ($tmphidden as $value)
-			{
-                $hiddenblocks[$value] = true;
-            }
-        }
-    }
-
-    return (empty($hiddenblocks[$id])) ? false : true;
-}
-
 ?>
\ No newline at end of file

Modified: trunk/includes/display/template.php
===================================================================
--- trunk/includes/display/template.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/display/template.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,18 +1,25 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
 /*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
+
+/*
 	To-do cache daa.
 	Area code for content
 */
@@ -39,21 +46,30 @@
     /*
 		Assign variable to be used in template
     */
-    function assign($var, $value = false)
+// rewmove array from here
+	function assign($var, $value = false)
     {
-        if (is_array($var))
-        {
-			foreach ($var as $name => $value)
-            {
-				$this->_vars[$name] = $value;
-			}
-        }
-        else
-        {
+		if (is_array($var))
+		{
+			foreach ($var as $name => $value)
+			{
+				$this->_vars[$name] = $value;
+			}
+		}
+		else
+		{
 			$this->_vars[$var] = $value;
 		}
-    }
+	}
 
+    function assign_array($var, $value = false)
+	{
+		foreach ($var as $name => $value)
+		{
+			$this->_vars[$name] = $value;
+		}
+	}
+
 	/*
 		Assign variable that are part of a Loop
     */
@@ -178,7 +194,7 @@
 
 		$file_name = str_replace(array('.', '/'), '#', $name);
 
-		return (($this->theme_themplate) ? $_CLASS['core_display']->theme.'#' : '') . "$file_name.php";
+		return ($this->theme_themplate ? $_CLASS['core_display']->theme_name.'#' : '') . "$file_name.php";
 	}
 
     function is_compiled($name)

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/functions.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,24 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
+
 // Redo
 function check_email($email)
 {
@@ -172,26 +179,23 @@
 	return false;
 }
 
-function display_confirmation($check = false, $hidden = '')
+function display_confirmation($message = '', $hidden = '')
 {
 	global $_CLASS, $SID;
 // Add user entered confirmation code as a choose, maybe ...
-	if ($check)
+	if (isset($_POST['cancel']))
+	{
+		return false;
+	}
+
+	if (isset($_POST['confirm']))
 	{
-		if (isset($_POST['cancel']))
-		{
-			return false;
-		}
-	
-		if (isset($_POST['confirm']))
+		$code = $_CLASS['core_user']->session_data_get('confirmation_code');
+		$confirm_code = get_variable('confirm_code', 'POST');
+
+		if ($code && $confirm_code && $code == $confirm_code)
 		{
-			$code = $_CLASS['core_user']->session_data_get('confirmation_code');
-			$confirm_code = get_variable('confirm_code', 'POST');
-
-			if ($code && $confirm_code && $code !== $confirm_code)
-			{
-				return true;
-			}
+			return true;
 		}
 
 		return false;
@@ -200,12 +204,15 @@
 	$confirmation_code = generate_string(6);
 	$_CLASS['core_user']->session_data_set('confirmation_code', $confirmation_code);
 
-	$_CLASS['core_template']->assign(array(
-		'S_CONFIRM_ACTION'  => generate_link($_CLASS['core_user']->url),
-		'S_HIDDEN_FIELDS'	=> $hidden.'<input type="hidden" name="confirm_code" value="' . $confirmation_code . '" />'
+	$_CLASS['core_template']->assign_array(array(
+		'MESSAGE'		=> ($message) ? $message : 'Are you sure you want to perform this action ?',
+		'CONFIRM_ACTION'=> generate_link($_CLASS['core_user']->url),
+		'HIDDEN_FIELDS'	=> $hidden.'<input type="hidden" name="confirm_code" value="' . $confirmation_code . '" />'
 	));
-
-	$_CLASS['core_template']->display('confirm_display.html');
+
+	$_CLASS['core_template']->display('confirmation.html');
+
+	script_close();
 }
 
 function encode_password($pure, $encoding = 'md5')
@@ -290,6 +297,7 @@
 	{
 		switch ($var_type)
 		{
+		 	case 'int':
 		 	case 'integer':
 				$variable = is_numeric($variable) ? (int) $variable : $default;
 			break;
@@ -372,7 +380,7 @@
 	{
 		if ($link{0} == '&')
 		{
-			$link = $_CORE_MODULE['title'].$link;
+			$link = $_CORE_MODULE['name'].$link;
 		}
 
 		$link = $file.'?mod='.$link;
@@ -447,8 +455,7 @@
 		$display['formated'] .= sprintf($wrapper['last'], generate_link($base_url.'&amp;start='.(($total_pages - 1)  * $per_page), $admin_link), $total_pages);
 	}
 
-//TMP
-	return $display['formated'];
+	return $display;
 }
 
 /*
@@ -498,34 +505,32 @@
 	$_CLASS['core_auth']->do_login($login_options, $template);
 }
 
-function set_core_config($section, $name, $value, $clear_cache = true, $auto_add = false)
+function set_core_config($section, $name, $value, $clear_cache = true, $auto_add = false, $cache = true)
 {
 	global $_CLASS, $_CORE_CONFIG;
 	
-	$_CLASS['core_db']->sql_return_on_error(true);
+	$sql = 'UPDATE ' . CORE_CONFIG_TABLE . " SET config_value ='".$_CLASS['core_db']->escape($value) . "'
+		WHERE config_section = '" . $_CLASS['core_db']->escape($section) . "'
+			AND config_name = '". $_CLASS['core_db']->escape($name) ."'";
 
-	$sql = 'UPDATE ' . CORE_CONFIG_TABLE . " SET value ='".$_CLASS['core_db']->escape($value) . "'
-		WHERE (section = '" . $_CLASS['core_db']->escape($section) . "')
-			AND (name = '". $_CLASS['core_db']->escape($name) ."')";
-
-	if (!$_CLASS['core_db']->query($sql) && $auto_add)
+	if ($auto_add && (!$_CLASS['core_db']->query($sql) || !$_CLASS['core_db']->affected_rows()))
 	{
 		$sql_array = array(
-			'section'	=> $section,
-			'name'		=> $name,
-			'value'		=> $value
+			'config_section'	=> (string) $section,
+			'config_name'		=> (string) $name,
+			'config_value'		=> (string) $value,
+			'config_cache'		=> (int) $cache,
 		);
+
+		$_CLASS['core_db']->return_on_error(true);
+
+		$_CLASS['core_db']->query('INSERT INTO ' . CORE_CONFIG_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_array));
 		
-		$_CLASS['core_db']->sql_return_on_error(false);
-
-		$sql = 'INSERT INTO ' . CORE_CONFIG_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_array);
-		$_CLASS['core_db']->query($sql);
+		$_CLASS['core_db']->return_on_error(false);
 	}
 
-	$_CLASS['core_db']->sql_return_on_error(false);
-	
 	$_CORE_CONFIG[$section][$name] = $value;
-	
+
 	if ($clear_cache)
 	{
 		$_CLASS['core_cache']->destroy('core_config');
@@ -683,7 +688,7 @@
 	return str_replace(array("\r\n", "\r", "\n"), $replacement, $text);
 }
 
-function url_redirect($url = false, $save = false)
+function redirect($url = false, $save = false)
 {
 	$url = ($url) ? $url : generate_link(false, array('full' => true));
 	$url = trim(str_replace('&amp;', '&', $url));
@@ -710,6 +715,11 @@
 	script_close($save);
 }
 
+function url_redirect($url = false, $save = false)
+{
+	redirect($url = false, $save = false);
+}
+
 if (!function_exists('file_get_contents'))
 {
 	//string file_get_contents ( string filename [, bool use_include_path [, resource context [, int offset [, int maxlen]]]] )

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/functions_user.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,22 +1,32 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
-function user_get_id($username, &$difference = array())
+function user_get_id($username, &$difference)
 {
 	global $_CLASS;
 
+	$difference = array();
+
+	$username = is_array($username) ? $username : array($username);
+
 	$data = array('user_id' => array(), 'username' => array());
 
 	$sql = 'SELECT user_id, username
@@ -36,13 +46,15 @@
 	return $data['user_id'];
 }
 
-function user_get_name($user_ids, &$difference = array())
+function user_get_name($user_id, &$difference)
 {
 	global $_CLASS;
 
-	$user_ids = array_map('intval', $user_ids);
+	$difference = array();
 
-	if (empty($user_ids))
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+
+	if (empty($user_id))
 	{
 		return;
 	}
@@ -51,39 +63,196 @@
 
 	$sql = 'SELECT user_id, username
 				FROM ' . USERS_TABLE . ' 
-				WHERE user_id IN (' . implode(', ', $user_ids) . ')';
+				WHERE user_id IN (' . implode(', ', $user_id) . ')';
 	$result = $_CLASS['core_db']->query($sql);
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$data['user_ids'][] = $row['user_id'];
+		$data['user_id'][] = $row['user_id'];
 		$data['username'][] = $row['username'];
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	$difference = array_diff($user_ids, $data['user_ids']);
+	$difference = array_diff($user_id, $data['user_id']);
 
 	return $data['username'];
 }
 
-function groups_user_remove($group_ids, $user_ids)
+function user_activate($user_id)
 {
+	global $_CLASS, $_CORE_CONFIG;
+
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+
+	if (empty($user_id))
+	{
+		return;
+	}
+// hook here -- maybe ?
+	$sql = 'UPDATE ' . USERS_TABLE . '
+		SET user_status = ' . USER_ACTIVE . '
+			WHERE user_id  IN (' . implode(', ', $user_id) . ')
+			AND user_type <>' . USER_GUEST;
+
+	$_CLASS['core_db']->query($sql);
+	
+	set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + count($user_id));
+}
+
+function user_disable($user_id)
+{
+	global $_CLASS, $_CORE_CONFIG;
+
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+
+	if (empty($user_id))
+	{
+		return;
+	}
+// hook here -- maybe ?
+	$sql = 'UPDATE ' . USERS_TABLE . '
+		SET user_status = ' . USER_DISABLE . '
+			WHERE user_id  IN (' . implode(', ', $user_id) . ')
+			AND user_type <>' . USER_GUEST;
+	$_CLASS['core_db']->query($sql);
+
+	if (in_array($_CORE_CONFIG['user']['newest_user_id'], $user_id))
+	{
+		$sql = 'SELECT user_id, username FROM ' . USERS_TABLE . '
+			WHERE user_type = '.USER_NORMAL.' AND user_status = '.USER_ACTIVE.'
+			ORDER BY user_regdate';
+
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		set_core_config('user', 'newest_user_id', $row['user_id'], false);
+		set_core_config('user', 'newest_username', $row['username'], false);
+	}
+
+	set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] - count($user_id), false);
+	
+	$_CLASS['core_cache']->destroy('core_config');
+}
+
+function user_activate_reminder($user_id)
+{
 	global $_CLASS;
 
-	$group_ids = is_array($group_ids) ? $group_ids : array($group_ids);
-	$user_ids = is_array($user_ids) ? $user_ids : array($user_ids);
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
 
-	$group_ids = array_map('intval', $group_ids);
-	$user_ids = array_map('intval', $user_ids);
+	if (empty($user_id))
+	{
+		return;
+	}
+// hook here -- maybe ?
+	$sql = 'UPDATE ' . USERS_TABLE . '
+		SET user_status = ' . USER_ACTIVE . '
+			WHERE user_id  IN (' . implode(', ', $user_id) . ')
+			AND user_type =' . USER_NORMAL;
+
+	$_CLASS['core_db']->query($sql);
+}
 
-	if (empty($group_ids) || empty($user_ids))
+function user_delete($user_id, $quick = false)
+{
+	global $_CLASS;
+
+	if ($quick)
 	{
+		$sql = "DELETE FROM USERS_TABLE
+			WHERE user_id IN (" . implode(', ', $user_id) . ')';
+		$_CLASS['core_db']->query($sql);
+		
 		return;
 	}
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
 
+// Maybe we should make this a cron
+// and just set the user type to deleted or something
+	set_time_limit(0);
+	ignore_user_abort(true);
+
+	if (empty($user_id))
+	{
+		return;
+	}
+
+	// We disable users first to make sure things go right
+	user_disable($user_id);
+
+	$_CLASS['core_db']->transaction();
+
+	$optimize_array = array();
+	$tables = array(USERS_TABLE => 'user_id', USER_GROUP_TABLE => 'user_id');
+// hook here
+
+// Move this to hooks on seperation
+	$tables += array(FORUMS_ACL_TABLE => 'user_id', FORUMS_WATCH_TABLE => 'user_id', FORUMS_TRACK_TABLE => 'user_id');
+
+	$sql = 'UPDATE ' . FORUMS_TABLE . '
+		SET forum_last_poster_id = ' . ANONYMOUS . " 
+		WHERE forum_last_poster_id IN (" . implode(', ', $user_id) . ')';
+	$_CLASS['core_db']->query($sql);
+
+	$sql = 'UPDATE ' . POSTS_TABLE . '
+		SET poster_id = ' . ANONYMOUS . " 
+		WHERE poster_id IN (" . implode(', ', $user_id) . ')';
+	$_CLASS['core_db']->query($sql);
+
+	$sql = 'UPDATE ' . TOPICS_TABLE . '
+		SET topic_poster = ' . ANONYMOUS . "
+		WHERE topic_poster IN (" . implode(', ', $user_id) . ')';
+	$_CLASS['core_db']->query($sql);
+
+	$sql = 'UPDATE ' . TOPICS_TABLE . '
+		SET topic_last_poster_id = ' . ANONYMOUS . "
+		WHERE topic_last_poster_id IN (" . implode(', ', $user_id) . ')';
+	$_CLASS['core_db']->query($sql);
+
+	switch ($_CLASS['core_db']->db_layer)
+	{
+		//case 'mysql4':
+		//case 'mysqli':
+		//DELETE FROM t1, t2 USING t1, t2, t3 WHERE t1.id=t2.id AND t2.id=t3.id;
+		//break;
+
+		default:
+			foreach ($tables as $table => $feild)
+			{
+				$sql = "DELETE FROM $table 
+					WHERE $feild IN (" . implode(', ', $user_id) . ')';
+				$_CLASS['core_db']->query($sql);
+			}
+			$optimize_array[] = $table;
+		break;
+	}
+
+// error on commit fail ( think about seperation commits for hooks )
+	$_CLASS['core_db']->transaction('commit');
+	
+// This should be in hooks
+	$_CLASS['core_db']->optimize_tables($optimize_array);
+}
+
+function groups_user_remove($group_id, $user_id)
+{
+	global $_CLASS;
+
+	$group_ids = is_array($group_id) ? $group_id : array($group_id);
+	$user_ids = is_array($user_id) ? $user_id : array($user_id);
+
+	$group_id = array_map('intval', $group_id);
+	$user_id = array_map('intval', $user_id);
+
+	if (empty($group_id) || empty($user_id))
+	{
+		return;
+	}
+
 	$sql = 'SELECT user_id FROM ' . USERS_TABLE . ' 
-				WHERE group_id IN (' . implode(', ', $group_ids) . ')
-				AND user_id IN (' . implode(', ', $group_ids) . ')';
+				WHERE group_id IN (' . implode(', ', $group_id) . ')
+				AND user_id IN (' . implode(', ', $user_id) . ')';
 	$result = $_CLASS['core_db']->query($sql);
 
 	$defaults = array();
@@ -106,15 +275,68 @@
 
 		$sql = 'UPDATE FROM '. USERS_TABLE .' 
 					SET group_id = 4, user_rank = -1
-					WHERE user_id IN (' . implode(', ', $group_ids) . ')';
+					WHERE user_id IN (' . implode(', ', $group_id) . ')';
 		$result = $_CLASS['core_db']->query($sql);
 	}
 
 	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . '
-		WHERE group_id IN ('. implode(', ', $group_ids) . ')
-		AND user_id IN ('. implode(', ', $user_ids) .')';
+		WHERE group_id IN ('. implode(', ', $group_id) . ')
+		AND user_id IN ('. implode(', ', $user_id) .')';
 
 	$result = $_CLASS['core_db']->query($sql);
 }
 
+function groups_user_add($group_id, $user_id, $status)
+{
+	global $_CLASS;
+
+	$group_ids = is_array($group_id) ? $group_id : array($group_id);
+	$user_ids = is_array($user_id) ? $user_id : array($user_id);
+
+	$group_id = array_map('intval', $group_id);
+	$user_id = array_map('intval', $user_id);
+
+	if (empty($group_id) || empty($user_id))
+	{
+		return;
+	}
+
+	$sql = 'SELECT member_user_id, member_status FROM ' . USER_GROUP_TABLE . ' 
+				WHERE group_id IN (' . implode(', ', $group_id) . ')
+				AND member_user_id IN (' . implode(', ', $user_id) . ')
+				AND  = '.$status;
+	$result = $_CLASS['core_db']->query($sql);
+
+	$update_array = array();
+	$ignore_array = array();
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$update_id[] = $row['user_id'];
+	}
+	$_CLASS['core_db']->free_result($result);
+	
+	// We move all users that are removed from the default groups to
+	// REGISTERED / REGISTERED_COPPA
+	if (!empty($defaults))
+	{
+// need to update/completion
+		$result = $_CLASS['core_db']->query('SELECT * FROM ' . GROUPS_TABLE . ' 	WHERE group_id = 4');
+
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		$sql = 'UPDATE FROM '. USERS_TABLE .' 
+					SET group_id = 4, user_rank = -1
+					WHERE user_id IN (' . implode(', ', $group_id) . ')';
+		$result = $_CLASS['core_db']->query($sql);
+	}
+
+	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . '
+		WHERE group_id IN ('. implode(', ', $group_id) . ')
+		AND user_id IN ('. implode(', ', $user_id) .')';
+
+	$result = $_CLASS['core_db']->query($sql);
+}
+
 ?>
\ No newline at end of file

Modified: trunk/includes/handler.php
===================================================================
--- trunk/includes/handler.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/handler.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 // Add saving reports to a log file and its define ..
 // this will be core_handlers
 
@@ -168,7 +176,7 @@
 
 				$code = false;
 
-				if (strpos($error, ':')) // there shouldn't be a 0 position
+				if (mb_strpos($error, ':')) // there shouldn't be a 0 position
 				{
 					list($code, $error) = explode(':', $error, 2);
 					
@@ -195,33 +203,25 @@
 				$error = (!empty($_CLASS['core_user']->lang[$error])) ? $_CLASS['core_user']->lang[$error] : $error;
 
 				$_CLASS['core_template']->assign('MESSAGE_TEXT',  $error);
-						
-				$_CLASS['core_template']->display('error.html');
-					
-				script_close(false);
-				die;
-				
-				break;
-	
+
+				$_CLASS['core_display']->display(false, 'error.html');
+			break;
+
 			case E_USER_NOTICE:
 				$_CLASS['core_user']->user_setup();
 
-				$this->error_setting['title'] = (!empty($_CLASS['core_user']->lang[$this->error_setting['title']])) ? $_CLASS['core_user']->lang[$this->error_setting['title']] : $this->error_setting['title'];
-				
-				$error = (!empty($_CLASS['core_user']->lang[$error])) ? $_CLASS['core_user']->lang[$error] : $error;
-				
-				$_CLASS['core_display']->display_head($this->error_setting['title']);
+				$this->error_setting['title'] = empty($_CLASS['core_user']->lang[$this->error_setting['title']]) ? $this->error_setting['title'] : $_CLASS['core_user']->lang[$this->error_setting['title']];
 
-				$_CLASS['core_template']->assign(array(
+				$error = empty($_CLASS['core_user']->lang[$error]) ? $error : $_CLASS['core_user']->lang[$error];
+
+				$_CLASS['core_template']->assign_array(array(
 					'MESSAGE_TITLE'	=> $this->error_setting['title'],
 					'MESSAGE_TEXT'	=> $error
 				));
-				
+
 				$this->error_setting = array('title', 'redirect');
 				
-				$_CLASS['core_template']->display('message.html');
-
-				$_CLASS['core_display']->display_footer(false);
+				$_CLASS['core_display']->display($this->error_setting['title'], 'message.html');
 			break;
 		}
 	}

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/session.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class sessions
 {
@@ -28,27 +34,28 @@
 
 		$this->server_local = ($_SERVER['HTTP_HOST'] == 'localhost' || $_SERVER['HTTP_HOST'] == '127.0.0.1') ? true : false;
 
-		$session_data['session_id'] = get_variable('sid', 'GET');
+		$session_id = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_sid', 'COOKIE');
+		$session_id_url = get_variable('sid', 'GET');
 
-		if ($cookie_sid = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_sid', 'COOKIE'))
+		if ($session_id_url)
 		{
 			// session id in url > cookie
-			if (!$session_data['session_id'] || $cookie_sid === $session_data['session_id'])
+			if (!$session_id || $session_id_url !== $session_id)
 			{
-				$session_data['session_id'] = $cookie_sid;
-				$this->sid_link = defined('NEED_SID') ? 'sid='.$session_data['session_id'] : false;
+				$session_id = $session_id_url;
+				$this->sid_link = 'sid='.$session_id;
 			}
 		}
 		else
 		{
-			$this->sid_link = 'sid='.$session_data['session_id'];
+			$this->sid_link = defined('NEED_SID') ? 'sid='.$session_id : false;
 		}
 
-		if ($session_data['session_id'])
+		if ($session_id)
 		{
 			$sql = 'SELECT u.*, s.*
 				FROM ' . SESSIONS_TABLE . ' s, ' . USERS_TABLE . " u
-				WHERE s.session_id = '" . $_CLASS['core_db']->escape($session_data['session_id']) . "'
+				WHERE s.session_id = '" . $_CLASS['core_db']->escape($session_id) . "'
 					AND u.user_id = s.session_user_id";
 					
 			$result = $_CLASS['core_db']->query($sql);
@@ -69,7 +76,7 @@
 				{
 					$check_ip = implode('.', explode('.', $this->data['session_ip'], $_CORE_CONFIG['server']['ip_check']));
 					
-					if ($check_ip != mb_substr($this->ip, 0, mb_strlen($check_ip)))
+					if ($check_ip != substr($this->ip, 0, strlen($check_ip)))
 					{
 						$valid  = false;
 					}
@@ -102,10 +109,23 @@
 			$this->data = array();
 		}
 
+		$user_id = ANONYMOUS;
+
+		$ali = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_ali', 'COOKIE', false, 'int');
+		$alc = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_alc', 'COOKIE');
+
+		if ($ali && $ali)
+		{
+			if ($id = $this->autologin_retrieve($ali, $alc))
+			{
+				$user_id = $id;
+			}
+		}
+
 		check_maintance_status();
 		$this->load = check_load_status();
 
-		return $this->login();
+		return $this->login($user_id);
 	}
 
 	function can_create()
@@ -134,28 +154,32 @@
 	}
 
 	// Create a new session
-	function session_create()
+	function session_create($auto_log = false)
 	{
 		global $_CLASS, $_CORE_CONFIG, $config;
-		$auto_log = false;
 
+		if (isset($this->data['session_id']) && $this->data['session_id'])
+		{
+			$this->session_destroy(false, false);
+		}
+
 		$this->data['session_last_visit'] = ($this->data['user_last_visit']) ? $this->data['user_last_visit'] : $this->time;
 
-		$session_id = (function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
+		$session_id = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
 
 		$session_data = array(
-			'session_id'			=> (string) $session_id,
-			'session_user_id'		=> (int) $this->data['user_id'],
-			'session_start'			=> (int) $this->time,
-			'session_time'			=> (int) $this->time,
-			'session_browser'		=> (string) $this->browser,
-			'session_page'			=> (string) $this->page,
-			'session_url'			=> (string) $this->url,
-			'session_ip'			=> (string) $this->ip,
-			'session_user_type'		=> (string) $this->data['user_type'],
-			'session_admin'			=> (int) $this->data['session_admin'],
-			'session_auth'			=> (int) serialize($_CLASS['core_auth']->auth_dump()),
-			'session_viewonline'	=> (int) $this->data['session_viewonline'],
+			'session_id'		=> (string) $session_id,
+			'session_user_id'	=> (int) $this->data['user_id'],
+			'session_start'		=> (int) $this->time,
+			'session_time'		=> (int) $this->time,
+			'session_browser'	=> (string) $this->browser,
+			'session_page'		=> (string) $this->page,
+			'session_url'		=> (string) $this->url,
+			'session_ip'		=> (string) $this->ip,
+			'session_user_type'	=> (int) $this->data['user_type'],
+			'session_admin'		=> (int) $this->data['session_admin'],
+			'session_auth'		=> (int) serialize($_CLASS['core_auth']->auth_dump()),
+			'session_hidden'	=> (int) $this->data['session_hidden'],
 		);
 
 		$_CLASS['core_db']->query('INSERT INTO ' . SESSIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $session_data));
@@ -174,17 +198,10 @@
 		{
 			if ($auto_log && $this->is_user)
 			{
-				$cookie_data['login_code'] = $session_data['user_password'];
-				$cookie_data['user_id'] = $this->data['user_id'];
-				
-				$this->set_cookie('data', serialize($cookie_data), $this->time + 31536000);
+				$this->autologin_generate();
 			}
-			elseif ($this->new_session)
-			{
-				$this->set_cookie('data', '', 0);
-			}
 
-			$this->set_cookie('sid', $this->data['session_id'], 0);
+			$this->set_cookie('sid', $session_id, 0);
 		}
 
 		$this->sid_link = ($this->is_bot) ? false : 'sid='.$this->data['session_id'];
@@ -194,17 +211,55 @@
 		return true;
 	}
 
-	function session_destroy($session_id = false)
+	function autologin_generate()
 	{
 		global $_CLASS;
+// make this useable outside sessions
+		$code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
 
+		$data_array = array(
+			'user_id'				=> (int) $this->data['user_id'],
+			'auto_login_browser'	=> (string) $this->browser,
+			'auto_login_code'		=> $code,
+			'auto_login_time'		=> (int) $this->time,
+		);
+		
+		$_CLASS['core_db']->query('INSERT INTO ' . SESSIONS_AUTOLOGIN_TABLE . ' '.	$_CLASS['core_db']->sql_build_array('INSERT', $data_array));
+	
+		$this->set_cookie('ali', $this->data['user_id'], $this->time + 31536000);
+		$this->set_cookie('alc', $code, $this->time + 31536000);
+	}
+
+	function autologin_retrieve($user_id, $code)
+	{
+		global $_CLASS;
+		
+		$sql = 'SELECT *
+			FROM ' . SESSIONS_AUTOLOGIN_TABLE . " 
+			WHERE user_id = $user_id
+			AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
+				
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		// This is about all you can validate other than the code, and user_id
+		return ($row && $row['auto_login_browser'] == $this->browser) ? $user_id : false;
+	}
+
+	function session_destroy($session_id = false, $remove_cookie = true)
+	{
+		global $_CLASS;
+
 		if (!$session_id)
 		{
 			$session_id = $this->data['session_id'];
 			
-			$this->set_cookie('data', '', $this->time - 31536000);
-			$this->set_cookie('sid', '', $this->time - 31536000);
-			
+			if ($remove_cookie)
+			{
+				$this->set_cookie('sid', '', $this->time - 31536000);
+			}
+
 			if ($this->data['session_time'])
 			{
 				$sql = 'UPDATE ' . USERS_TABLE . '
@@ -219,9 +274,11 @@
 
 		$_CLASS['core_db']->query($sql);
 	}
-	
+
 	function gc($time)
 	{
+// Add auto login cleaning
+// Move to cron
 		global $_CORE_CONFIG, $_CLASS;
 
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '

Modified: trunk/includes/system.php
===================================================================
--- trunk/includes/system.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/system.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 function confirmation_image($code = false, $size = false)
 {
@@ -140,18 +146,78 @@
 		$x += $font_width * (($width_addition) ? mt_rand(2, 5) : 1);
 	}
 
-	//imagepng($im);
+	imagepng($im);
 	imagedestroy($im);
 }
 
-function login()
+function activate()
 {
 	global $_CLASS;
 
-	$login_options = array(
-		'full_screen'	=> isset($_REQUEST['full']),
+	$user_id = get_variable('user_id', 'GET', 0, 'integer');
+	$key = get_variable('key', 'GET', false);
+
+	if (!$user_id || !$key)
+	{
+		trigger_error('CANT_ACTIVATED');
+	}
+	
+	$sql = 'SELECT username, user_status, user_email, user_new_password, user_new_password_encoding, user_act_key
+		FROM ' . USERS_TABLE . " WHERE user_id = $user_id AND user_type = ".USER_NORMAL;
+
+	$result = $_CLASS['core_db']->sql_query($sql);
+	$row = $_CLASS['core_db']->sql_fetchrow($result);
+	$_CLASS['core_db']->sql_freeresult($result);
+
+	if (!$row)
+	{
+		trigger_error('NO_USER');
+	}
+	
+	if ($row['user_status'] != USER_UNACTIVATED && !$row['user_new_password'])
+	{
+		trigger_error(($row['user_status'] == USER_ACTIVE) ? 'ALREADY_ACTIVATED' : 'CANT_ACTIVATED');
+	}
+	
+	if ($row['user_act_key'] != $key)
+	{
+		trigger_error('WRONG_ACTIVATION_KEY');
+	}
+
+	$sql_ary = array(
+		'user_act_key'				=> null,
+		'user_new_password'			=> null,
+		'user_new_password_encoding'=> null
 	);
+
+	if ($row['user_new_password'])
+	{
+		$sql_ary += array(
+			'user_password'				=> $row['user_new_password'],
+			'user_password_encoding'	=> $row['user_new_password_encoding'],
+		);
+	}
+	else
+	{
+		include_once($site_file_root.'includes/functions_user.php');
+		user_activate($user_id);
 		
-	$_CLASS['core_auth']->do_login($login_options, $template);
+		set_core_config('user', 'newest_user_id', $row['user_id'], false);
+		set_core_config('user', 'newest_username', $row['username'], false);
+	}
+
+	$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
+		WHERE user_id = ' . $row['user_id'];
+	$result = $_CLASS['core_db']->sql_query($sql);
 }
+
+function login()
+{
+	global $_CLASS;
+
+	$login_options = array('full_screen' => isset($_REQUEST['full']));
+		
+	$_CLASS['core_auth']->do_login($login_options, false);
+}
+
 ?>
\ No newline at end of file

Modified: trunk/includes/user.php
===================================================================
--- trunk/includes/user.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/user.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,5 +1,25 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
+// sessions should extend this
 class core_user extends sessions
 {
 	var $browser;
@@ -76,15 +96,10 @@
 		return $time + $this->timezone + $this->dst;
 	}
 
-	function login($id = ANONYMOUS, $admin_login = false, $view_online = true)
+	function login($id = ANONYMOUS, $admin_login = false, $hidden = false, $auto_log = false)
 	{
 		global $_CLASS;
 
-		if (isset($this->data['session_id']) && $this->data['session_id'])
-		{
-			$this->session_destroy();
-		}
-
 		if ($bot = check_bot_status($this->browser, $this->ip))
 		{
 			$id = $bot;
@@ -139,9 +154,9 @@
 		}
 
 		$this->is_admin = ($this->data['session_admin'] == ADMIN_IS_ADMIN);
-		$this->data['session_viewonline'] = $view_online;
+		$this->data['session_hidden'] = $hidden;
 
-		$this->session_create();
+		$this->session_create($auto_log);
 	}
 
 	function logout()
@@ -149,7 +164,7 @@
 		global $_CLASS;
 
 		$this->session_destroy();
-		
+// do last visit update here
 		$sql = 'SELECT *
 			FROM ' . USERS_TABLE . '
 			WHERE user_id = ' . ANONYMOUS;

Modified: trunk/modules/Contact/index.php
===================================================================
--- trunk/modules/Contact/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Contact/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -18,58 +18,30 @@
     die;
 }
 
+$_CLASS['core_user']->user_setup();
 $_CLASS['core_user']->add_lang();
 
-function send_feedback($sender_name, $sender_email, $message, $preview = false)
-{
-	global $_CLASS, $_CORE_CONFIG;
-
-	$_CLASS['core_template']->assign(array(
-		'SENT_FROM'		=> $sender_name,
-		'SENDER_NAME'	=> $sender_name,
-		'SENDER_EMAIL'	=> $sender_email,
-		'SENDER_IP'		=> $_CLASS['core_user']->ip,
-
-		'MESSAGE' 		=> $message,
-	));
-	
-	$body = $_CLASS['core_template']->display('modules/Contact/email/index.html', true);
-
-	if ($preview)
-	{
-		$_CLASS['core_template']->assign('PREVIEW', $body);
-		return;
-	}
-
-	//include_once(
-	//print $body;
-}
-
-
 $error = '';
 
-If (!empty($_POST['preview']) || !empty($_POST['contact']))
+if (!empty($_POST['preview']) || !empty($_POST['contact']))
 {
 	$data['MESSAGE']= get_variable('message', 'POST', '');
 	$data['NAME']	= get_variable('sender_name', 'POST', '');
 	$data['EMAIL']	= get_variable('sender_email', 'POST', '');
-    
 
 	foreach ($data as $field => $value)
 	{
 		if (!$value)
 		{
-				$error .= $_CLASS['core_user']->lang['ERROR_'.$field].'<br />';
-				unset($field, $value, $lang);
-				
+			$error .= $_CLASS['core_user']->lang['ERROR_'.$field].'<br />';
+			unset($field, $value, $lang);
         }
         elseif ($field == 'EMAIL' && !check_email($value))
         {
-        
 			$error .= $_CLASS['core_user']->lang['BAD_EMAIL'].'<br />';
 		}
 	} 
-	
+
 	if (!empty($_POST['preview']) && $data['MESSAGE'])
 	{
 		send_feedback($data['NAME'],  $data['EMAIL'], $data['MESSAGE'], $preview = true);
@@ -90,15 +62,42 @@
 	$message = '';
 }
 
-	
-$_CLASS['core_template']->assign(array( 
+$_CLASS['core_template']->assign_array(array( 
 	'ERROR' 				=> $error,
 	'MESSAGE' 				=> $message,
 	'ACTION' 				=> generate_link($_CORE_MODULE['name']),
 	'SENDER_EMAIL' 			=> $sender_email,
 	'SENDER_NAME' 			=> $sender_name,
 ));
-		
+
 $_CLASS['core_template']->display('modules/Contact/index.html');
 
+function send_feedback($sender_name, $sender_email, $message, $preview = false)
+{
+	global $_CLASS, $_CORE_CONFIG;
+
+	$_CLASS['core_template']->assign_array(array(
+		'SENT_FROM'		=> $sender_name,
+		'SENDER_NAME'	=> $sender_name,
+		'SENDER_EMAIL'	=> $sender_email,
+		'SENDER_IP'		=> $_CLASS['core_user']->ip,
+		'MESSAGE' 		=> $message,
+	));
+
+	$body = trim($_CLASS['core_template']->display('modules/Contact/email/index.html', true));
+
+	if ($preview)
+	{
+		$_CLASS['core_template']->assign('PREVIEW', $body);
+		return;
+	}
+
+	$mailer = new core_mailer;
+	$mailer->to('newuser at localhost', 'Viperal');
+	$mailer->subject('New Feedback');
+
+	$mailer->message = $body;
+
+	trigger_error($mailer->send() ? 'SEND_SUCCESSFULL' : $mailer->error);
+}
 ?>
\ No newline at end of file

Modified: trunk/modules/Control_Panel/index.php
===================================================================
--- trunk/modules/Control_Panel/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -32,14 +32,14 @@
 require($site_file_root.'includes/forums/functions_user.php');
 
 //define the undefineds
-$_CLASS['core_template']->assign(array(
+$_CLASS['core_template']->assign_array(array(
 	'S_DISPLAY_FORM'		=> true,
 	'S_SHOW_PM_BOX'			=> false,
 	'S_SHOW_COLOUR_LEGEND'	=> false,
 	'USERNAME'				=> '',
 	'friends_online'		=> false,
 	'friends_offline' 		=> false,
-	));
+));
 
 // ---------
 // FUNCTIONS
@@ -57,7 +57,7 @@
 		global $_CLASS, $config;
 
 		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
-			FROM ' . MODULES_TABLE . "
+			FROM ' . FORUMS_MODULES_TABLE . "
 			WHERE module_type = '{$module_type}'
 				AND module_enabled = 1
 			ORDER BY module_order ASC";
@@ -206,7 +206,7 @@
 
         $_CLASS['core_template']->display('modules/Control_Panel/'.$tpl_name);
 
-		die;
+		script_close();
 	}
 
 	// Public methods to be overwritten by modules
@@ -261,7 +261,7 @@
 	case 'register':
 		if ($_CLASS['core_user']->data['user_id'] != ANONYMOUS || isset($_REQUEST['not_agreed']))
 		{
-			url_redirect();
+			redirect();
 		}
 
 		$ucp->load('ucp', 'register');
@@ -276,7 +276,7 @@
 	case 'login':
 		if ($_CLASS['core_user']->is_user || $_CLASS['core_user']->is_bot)
 		{
-			url_redirect();
+			redirect();
 		}
 
 		login_box();
@@ -326,7 +326,7 @@
 			confirm_box(false, 'DELETE_COOKIES', '');
 		}
 		
-		url_redirect();
+		redirect();
 		break;
 }
 
@@ -345,7 +345,7 @@
 // Output listing of friends online
 $update_time = $config['load_online_time'] * 60;
 
-$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_viewonline
+$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_hidden
 	FROM ' . USERS_TABLE . ' u, ' . ZEBRA_TABLE . ' z 
 	LEFT JOIN ' . SESSIONS_TABLE . ' s ON (s.session_user_id = z.zebra_id)
 	WHERE z.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 

Deleted: trunk/modules/Control_Panel/ucp/ucp_activate.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_activate.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_activate.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,115 +0,0 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_activate.php,v 1.8 2004/05/26 20:16:20 acydburn Exp $
-//
-// FILENAME  : ucp_activate.php
-// STARTED   : Mon May 19, 2003
-// COPYRIGHT : ? 2001, 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
- 
-class ucp_activate extends module 
-{
-	function ucp_activate($id, $mode)
-	{
-		global $config, $_CORE_CONFIG, $_CLASS, $site_file_root;
-
-		//$user_id = request_var('u', 0);
-		$user_id = get_variable('u', 'REQUEST', 0, 'integer')
-		$key = request_var('k', '');
-
-		$sql = 'SELECT user_id, username, user_type, user_email, user_newpasswd, user_lang, user_notify_type, user_actkey
-			FROM ' . USERS_TABLE . "
-			WHERE user_id = $user_id";
-		$result = $_CLASS['core_db']->sql_query($sql);
-
-		if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
-		{
-			trigger_error($_CLASS['core_user']->lang['NO_USER']);
-		}
-		$_CLASS['core_db']->sql_freeresult($result);
-
-		if ($row['user_type'] <> USER_INACTIVE && !$row['user_newpasswd'])
-		{
-			$_CLASS['core_display']->meta_refresh(3);
-			trigger_error($_CLASS['core_user']->lang['ALREADY_ACTIVATED']);
-		}
-		
-		if ($row['user_actkey'] != $key)
-		{
-			trigger_error($_CLASS['core_user']->lang['WRONG_ACTIVATION']);
-		}
-
-		$update_password = ($row['user_newpasswd']) ? true : false;
-
-		if ($update_password)
-		{
-			$sql_ary = array(
-				'user_type'			=> USER_NORMAL,
-				'user_actkey'		=> '',
-				'user_password'		=> $row['user_newpasswd'],
-				'user_newpasswd'	=> ''
-			);
-
-			$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
-				WHERE user_id = ' . $row['user_id'];
-			$result = $_CLASS['core_db']->sql_query($sql);
-		}
-		
-		// TODO: check for group membership after password update... active_flip there too
-		if (!$update_password)
-		{
-			// Now we need to demote the user from the inactive group and add him to the registered group
-
-			include_once($site_file_root.'includes/forums/functions_user.php');
-			user_active_flip($row['user_id'], $row['user_type'], '', $row['username']);
-		}
-		
-		if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN && !$update_password)
-		{
-			include_once($site_file_root.'includes/forums/functions_messenger.php');
-
-			$messenger = new messenger();
-
-			$messenger->template('admin_welcome_activated', $row['user_lang']);
-			
-			$messenger->replyto($config['board_contact']);
-			$messenger->to($row['user_email'], $row['username']);
-
-			$messenger->headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-			$messenger->headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']->data['user_id']);
-			$messenger->headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']->data['username']);
-			$messenger->headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']->ip);
-
-			$messenger->assign_vars(array(
-				'SITENAME'	=> $_CORE_CONFIG['global']['sitename'],
-				'USERNAME'	=> $row['username'],
-				'EMAIL_SIG' => str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']))
-			);
-
-			$messenger->send($row['user_notify_type']);
-			$messenger->save_queue();
-
-			$message = 'ACCOUNT_ACTIVE_ADMIN';
-		}
-		else
-		{
-			$message = (!$update_password) ? 'ACCOUNT_ACTIVE' : 'PASSWORD_ACTIVATED';
-		}
-
-		if (!$update_password)
-		{
-			set_config('newest_user_id', $row['user_id']);
-			set_config('newest_username', $row['username']);
-			set_config('num_users', $config['num_users'] + 1, TRUE);
-		}
-
-		$_CLASS['core_display']->meta_refresh(3, generate_link());
-		trigger_error($_CLASS['core_user']->lang[$message]);
-	}
-}
-
-?>
\ No newline at end of file

Modified: trunk/modules/Control_Panel/ucp/ucp_attachments.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -34,7 +34,7 @@
 				$s_hidden_fields .= '<input type="hidden" name="attachment[' . $attachment_id . ']" value="1" />';
 			}
 
-			if (confirm_box(true))
+			if (display_confirmation($_CLASS['core_user']->get_lang((count($delete_ids) == 1) ? 'DELETE_ATTACHMENT' : 'DELETE_ATTACHMENTS'), $s_hidden_fields))
 			{
 				require($site_file_root.'includes/forums/functions_admin.php');
 				delete_attachments('attach', $delete_ids);
@@ -44,10 +44,6 @@
 				$message = ((sizeof($delete_ids) == 1) ? $_CLASS['core_user']->lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']->lang['ATTACHMENTS_DELETED']) . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $refresh_url . '">', '</a>');
 				trigger_error($message);
 			}
-			else
-			{
-				confirm_box(false, (sizeof($delete_ids) == 1) ? 'DELETE_ATTACHMENT' : 'DELETE_ATTACHMENTS', $s_hidden_fields);
-			}
 		}
 		
 		$sort_key = request_var('sk', 'a');
@@ -76,24 +72,24 @@
 		$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir == 'a') ? 'ASC' : 'DESC');
 		
 		$sql = 'SELECT COUNT(*) as num_attachments
-			FROM ' . ATTACHMENTS_TABLE . '
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 			WHERE poster_id = ' . $_CLASS['core_user']->data['user_id'];
-		$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
-		$num_attachments = $_CLASS['core_db']->sql_fetchfield('num_attachments', 0, $result);
-		$_CLASS['core_db']->sql_freeresult($result);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
+		list($num_attachments) = $_CLASS['core_db']->fetch_row_num($result);
+		$_CLASS['core_db']->free_result($result);
 		
 		$sql = 'SELECT a.*, t.topic_title, p.message_subject as message_title
-			FROM ' . ATTACHMENTS_TABLE . ' a 
-				LEFT JOIN ' . TOPICS_TABLE . ' t ON (a.topic_id = t.topic_id
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . ' a 
+				LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON (a.topic_id = t.topic_id
 					AND a.in_message = 0)
-				LEFT JOIN ' . PRIVMSGS_TABLE . ' p ON (a.post_msg_id = p.msg_id
+				LEFT JOIN ' . FORUMS_PRIVMSGS_TABLE . ' p ON (a.post_msg_id = p.msg_id
 					AND a.in_message = 1)
 			WHERE a.poster_id = ' . $_CLASS['core_user']->data['user_id'] . "
 			ORDER BY $order_by";
-		$result = $_CLASS['core_db']->sql_query_limit($sql, $config['posts_per_page'], $start);
+		$result = $_CLASS['core_db']->query_limit($sql, $config['posts_per_page'], $start);
 
 		$row_count = 0;
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$_CLASS['core_template']->assign('S_ATTACHMENT_ROWS', true);
 
@@ -130,9 +126,9 @@
 
 				$row_count++;
 			} 
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result));
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
 		$_CLASS['core_template']->assign(array( 
 			'PAGE_NUMBER'			=> on_page($num_attachments, $config['posts_per_page'], $start),

Deleted: trunk/modules/Control_Panel/ucp/ucp_confirm.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_confirm.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_confirm.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,28 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )						 		//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-/*
-	For phpBB3 mods
-*/
-
-class ucp_confirm extends module 
-{
-	function ucp_confirm($id, $mode)
-	{
-		include_once($site_file_root.'includes/system.php');
-		confirmation_image();
-	}
-}
-
-?>
\ No newline at end of file

Deleted: trunk/modules/Control_Panel/ucp/ucp_confirm_old.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_confirm_old.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_confirm_old.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,426 +0,0 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_confirm.php,v 1.5 2004/05/26 20:16:20 acydburn Exp $
-//
-// FILENAME  : ucp_confirm.php
-// STARTED   : Mon May 19, 2003
-// COPYRIGHT : ? 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-// Note to potential users of this code ...
-//
-// Remember this is released under the _GPL_ and is subject
-// to that licence. Do not incorporate this within software 
-// released or distributed in any way under a licence other
-// than the GPL. We will be watching ... ;)
-
-class ucp_confirm extends module 
-{
-	function ucp_confirm($id, $mode)
-	{
-		global $config, $_CLASS;
-		
-		// Do we have an id? No, then just exit
-		$confirm_id = request_var('id', '');
-
-		if (!$confirm_id)
-		{
-			exit;
-		}
-
-		// Define available charset
-		$chars = array('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J',  'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T',  'U', 'V', 'W', 'X', 'Y', 'Z', '1', '2', '3', '4', '5', '6', '7', '8', '9');
-
-		// Try and grab code for this id and session
-		$sql = 'SELECT code  
-			FROM ' . CONFIRM_TABLE . " 
-			WHERE session_id = '" . $_CLASS['core_db']->sql_escape($_CLASS['core_user']->data['session_id']) . "' 
-				AND confirm_id = '" . $_CLASS['core_db']->sql_escape($confirm_id) . "'";
-		$result = $_CLASS['core_db']->sql_query($sql);
-
-		// If we have a row then grab data else create a new id
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
-		{
-			$_CLASS['core_db']->sql_freeresult($result);
-			$code = $row['code'];
-		}
-		else
-		{
-			exit;
-		}
-
-		// If we can we will generate a single filtered png else we will have to simply
-		// output six seperate original pngs ... first way is preferable!
-		if (@extension_loaded('zlib'))
-		{
-			$_png = $this->define_filtered_pngs();
-
-			$total_width = 320;
-			$total_height = 50;
-			$img_height = 40;
-			$img_width = 0;
-			$l = 0;
-
-			list($usec, $sec) = explode(' ', microtime()); 
-			mt_srand($sec * $usec); 
-
-			$char_widths = array();
-			for ($i = 0; $i < strlen($code); $i++)
-			{
-				$char = $code{$i};
-
-				$width = mt_rand(0, 4);
-				$char_widths[] = $width;
-				$img_width += $_png[$char]['width'] - $width;
-			}
-
-			$offset_x = mt_rand(0, $total_width - $img_width);
-			$offset_y = mt_rand(0, $total_height - $img_height);
-
-			$image = '';
-			$hold_chars = array();
-			for ($i = 0; $i < $total_height; $i++)
-			{
-				$image .= chr(0);
-
-				if ($i > $offset_y && $i < $offset_y + $img_height)
-				{
-					$j = 0;
-
-					for ($k = 0; $k < $offset_x; $k++)
-					{
-						$image .= chr(mt_rand(140, 255));
-					}
-
-					for ($k = 0; $k < strlen($code); $k++)
-					{
-						$char = $code{$k};
-
-						if (empty($hold_chars[$char]))
-						{
-							$hold_chars[$char] = explode("\n", chunk_split(base64_decode($_png[$char]['data']), $_png[$char]['width'] + 1, "\n"));
-						}
-						$image .= $this->randomise(substr($hold_chars[$char][$l], 1), $char_widths[$j]);
-						$j++;
-					}
-
-					for ($k = $offset_x + $img_width; $k < $total_width; $k++)
-					{
-						$image .= chr(mt_rand(140, 255));
-					}
-
-					$l++;
-				}
-				else
-				{
-					for ($k = 0; $k < $total_width; $k++)
-					{
-						$image .= chr(mt_rand(140, 255));
-					}
-				}
-
-			}
-			unset($hold);
-
-			$image = $this->create_png(gzcompress($image), $total_width, $total_height);
-
-			// Output image
-			header('Content-Type: image/png');
-			header('Cache-control: no-cache, no-store');
-			echo $image;
-
-			unset($image);
-			unset($_png);
-			exit;
-
-		}
-		else
-		{
-			$char = request_var('c', 0);
-
-			if ($char)
-			{
-				$_png = $this->define_raw_pngs();
-
-				$char = substr($code, $char - 1, 1);
-				header('Content-Type: image/png');
-				header('Cache-control: no-cache, no-store');
-				echo base64_decode($_png[$char]);
-
-				unset($_png);
-				exit;
-			}
-		}
-
-		exit;
-	}
-
-	// This is designed to randomise the pixels of the image data within
-	// certain limits so as to keep it readable. It also varies the image
-	// width a little
-	function randomise($scanline, $width)
-	{
-		$new_line = '';
-		$start = floor($width/2);
-		$end = strlen($scanline) - ceil($width/2);
-
-		for ($i = $start; $i < $end; $i++)
-		{
-			$pixel = ord($scanline{$i});
-
-			if ($pixel < 190)
-			{
-				$new_line .= chr(mt_rand(0, 205));
-			}
-			else if ($pixel > 190)
-			{
-				$new_line .= chr(mt_rand(145, 255));
-			}
-			else
-			{
-				$new_line .= $scanline{$i};
-			}
-		}
-
-		return $new_line;
-	}
-
-	// This creates a chunk of the given type, with the given data
-	// of the given length adding the relevant crc
-	function png_chunk($length, $type, $data)
-	{
-		$raw = $type;
-		$raw .= $data;
-		$crc = crc32($raw);
-		$raw .= pack('C4', $crc >> 24, $crc >> 16, $crc >> 8, $crc);
-
-		return pack('C4', $length >> 24, $length >> 16, $length >> 8, $length) . $raw;
-	}
-
-	// Creates greyscale 8bit png - The PNG spec can be found at
-	// http://www.libpng.org/pub/png/spec/PNG-Contents.html we use
-	// png because it's a fully recognised open standard and supported
-	// by practically all modern browsers and OSs
-	function create_png($gzimage, $width, $height)
-	{
-		// SIG
-		$image = pack('C8', 137, 80, 78, 71, 13, 10, 26, 10);
-		// IHDR
-		$raw = pack('C4', $width >> 24, $width >> 16, $width >> 8, $width);
-		$raw .= pack('C4', $height >> 24, $height >> 16, $height >> 8, $height);
-		$raw .= pack('C5', 8, 0, 0, 0, 0);
-		$image .= $this->png_chunk(13, 'IHDR', $raw);
-		// IDAT
-		$image .= $this->png_chunk(strlen($gzimage), 'IDAT', $gzimage);
-		// IEND
-		$image .= $this->png_chunk(0, 'IEND', '');
-
-		return $image;
-	}
-
-	// Each 'data' element is base64_encoded uncompressed IDAT
-	// png image data
-	function define_filtered_pngs()
-	{
-		$_png = array(
-			'0' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A///////////////////olFAkBAAAGDyA4P///M31/////////////wD////////////////0dAgAAAAAAAAAAAAEcPipFGHn////////////AP//////////////6DAAAAAAAAAAAAAAAAAALSEAN+T///////////8A//////////////xAAAAAAAAAAAAAAAAAAAAAACPA/////////////wD/////////////oAAAAAAAAAAAAAAAAAAAAAAAev//////////////AP////////////8oAAAAAAAAPNj/zDAAAAAAAABD//////////////8A////////////1AAAAAAAABjw////5BAAAAAAAADo/////////////wD///////////+QAAAAAAAAbP//////QgAAAAAAAKj/////////////AP///////////1wAAAAAAACs/////8AXAAAAAAAAcP////////////8A////////////OAAAAAAAAND////dNwAAAAAAAABI/////////////wD///////////8gAAAAAAAA4P//7koACwAAAAAAACT//!
 ///////////AP///////////wgAAAAAAAD///VqAwaPAAAAAAAAEP////////////8A////////////AAAAAAAAAP/8kQYDavUAAAAAAAAA/////////////wD///////////8AAAAAAAAA/6kNAEru/wAAAAAAAAD/////////////AP///////////wAAAAAAAADAIwA33f//AAAAAAAAAP////////////8A////////////FAAAAAAAADYAI8D///8AAAAAAAAQ/////////////wD///////////8kAAAAAAAAAA2p////5AAAAAAAACD/////////////AP///////////0gAAAAAAAAFkfz////UAAAAAAAAQP////////////8A////////////cAAAAAAAAET1/////7AAAAAAAABo/////////////wD///////////+oAAAAAAAAXfX/////sAAAAAAAAGj/////////////AAAAALgAAAAAAAAwAAAAAAAAAAAAAAD////////////oAAAAAAAACOT////oEAAAAAAAAOD/////////////AP////////////8+AAAAAAAAKMz/zDQAAAAAAAA0//////////////8A////////////7jgAAAAAAAAAAAAAAAAAAAAAAKT//////////////wD///////////VqAwIAAAAAAAAAAAAAAAAAAAA8////////////////AP//////////rQcDaVEAAAAAAAAAAAAAAAAAKOj///////////////8A///////////nblnu/IAIAAAAAAAAAAAAAFzw/////////////////wD////////////79////+iITCAAAAAgSITg////////////////////AP////////////////////////////////////////////////////8A/////////////////!
 ////////////////////////////////////wD////////////////////////!
 ////////
/////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////w==', 
-				'width' => 40
-			), 
-			'1' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////8BAAAAAAAP//////////////////AP////////////////////////9sAAAAAAAA//////////////////8A////////////////////////pAAAAAAAAAD//////////////////wD//////////////////////6wEAAAAAAAAAP//////////////////AP////////////////////h4AAAAAAAAAAAA//////////////////8A//////////////////ygJAAAAAAAAAAAAAD//////////////////wD//////////////9x8HAAAAAAAAAAAAAAAAP//////////////////AP//////////////AAAAAAAAAAAAAAAAAAAA//////////////////8A//////////////8AAAAAAAAAAAAAAAAAAAD//////////////////wD//////////////wAAAAAAAAR4AAAAAAAAAP//////////////////AP//////////////AAAAAAA4zP8AAAAAAAAA//////////////////8A//////////////8AAAA4sP///wAAAAAAAAD//////////////////wD//////////////yR80P//////AAAAAAAAAP//////////////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////AAAAAAAAAP///////!
 ///////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////AAAAAAAAAP//////////////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////AAAAAAAAAP//////////////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////AAAAAAAAAP//////////////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'2' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP/////////////////okFAkCAAABCBIfNT///////////////////8A///////////////8hAgAAAAAAAAAAAAAAFTo/////////////////wD//////////////1QAAAAAAAAAAAAAAAAAACjo////////////////AP////////////+MAAAAAAAAAAAAAAAAAAAAADj///////////////8A////////////9BAAAAAAAAAAAAAAAAAAAAAAALD//////////////wD///////////+gAAAAAAAAAHjs+KwMAAAAAAAAVP///!
 ///////////AP///////////1gAAAAAAABM/////6QAAAAAAAAU//////////////8A////////////KAAAAAAAALj/////+AAAAAAAAAD//////////////wD///////////+MfGBMOCAI8P/////wAAAAAAAACP//////////////AP///////////////////////////5wAAAAAAAAw//////////////8A///////////////////////////oFAAAAAAAAHz//////////////wD/////////////////////////6CgAAAAAAAAE3P//////////////AP///////////////////////9ggAAAAAAAAAHT///////////////8A//////////////////////+0DAAAAAAAAAA8+P///////////////wD/////////////////////gAAAAAAAAAAAKOj/////////////////AP//////////////////9FAAAAAAAAAAADzw//////////////////8A/////////////////+g4AAAAAAAAAABk/P///////////////////wD////////////////oKAAAAAAAAAAMqP//////////////////////AP//////////////6CgAAAAAAAAAMNz///////////////////////8A//////////////g4AAAAAAAAAFT0/////////////////////////wD/////////////bAAAAAAAAABU/P//////////////////////////AP///////////8wAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8A////////////SAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////9wAAAAAAAAAAAAAAAAAAAAAAAAAAP///////!
 ///////AP//////////hAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8!
 A///////
///9AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////xAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'3' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD////////////////8sGg0FAAAACA4cLz8////////////////////AP//////////////rBgAAAAAAAAAAAAAACTA//////////////////8A/////////////3QAAAAAAAAAAAAAAAAAAASs/////////////////wD///////////+YAAAAAAAAAAAAAAAAAAAAAAjc////////////////AP//////////6AwAAAAAAAAAAAAAAAAAAAAAAGT///////////////8A//////////94AAAAAAAABJDw/8g4AAAAAAAAHP///////////////wD//////////yAAAAAAAACE/////9gAAAAAAAAA////////////////AP///////////NSwiGQ4FOT//////AAAAAAAABD///////////////8A//////////////////////////+YAAAAAAAAVP///////////////wD//////////////////////P/ggAQAAAAAAATM/////!
 ///////////AP////////////////////9gAAAAAAAAAAAElP////////////////8A/////////////////////0AAAAAAAAAAHLj//////////////////wD/////////////////////OAAAAAAAAAAwkPj/////////////////AP////////////////////8gAAAAAAAAAAAAINj///////////////8A/////////////////////xAAAAAAAAAAAAAAIPD//////////////wD/////////////////////uOz/4HgEAAAAAAAAhP//////////////AP///////////////////////////3wAAAAAAAAw//////////////8A////////////////////////////6AAAAAAAAAj//////////////wD/////////////////////////////AAAAAAAAAP//////////////AP//////////tJh8YEQoDNz//////+AAAAAAAAAY//////////////8A//////////88AAAAAAAAaP//////dAAAAAAAAEz//////////////wD//////////6QAAAAAAAAAdOD/5HQAAAAAAAAApP//////////////AP///////////CgAAAAAAAAAAAAAAAAAAAAAACD4//////////////8A////////////yAQAAAAAAAAAAAAAAAAAAAAEuP///////////////wD/////////////rAQAAAAAAAAAAAAAAAAABJD/////////////////AP//////////////zDQAAAAAAAAAAAAAACTA//////////////////8A/////////////////8BwOCAAAAAUNGi0/P///////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'4' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP//////////////////////////nAAAAAAAAAD///////////////8A/////////////////////////8AEAAAAAAAAAP///////////////wD////////////////////////gGAAAAAAAAAAA////////////////AP//////////////////////9DAAAAAAAAAAAAD///////////////8A//////////////////////9UAAAAAAAAAAAAAP///////////////wD/////////////////////hAAAAAAAAAAAAAAA////////////////AP///////////////////7QAAAAAAAAAAAAAAAD///////////////8A///////////////////UDAAAAAAUAAAAAAAAAP///////////////wD/////////////////7CQAAAAABMAAAAAAAAAA////////////////AP////////////////xEAAAAAACU/wAAAAAAAAD///////////////8A////////////////cAAAAAAAZP//AAAAAAAAAP///////////////wD//////////////6AAAAAAADz8//8AAAAAAAAA////////////////AP/////////////IBAAAAAAc6P///wAAAAAAAAD///////////////8A////////////5BgAAAAADMz/////AAAAAAAAAP///////////////wD///////////g0AAAAAACk//////8AAAAAAAAA/////!
 ///////////AP//////////XAAAAAAAfP///////wAAAAAAAAD///////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A////////////////////////////AAAAAAAAAP///////////////wD///////////////////////////8AAAAAAAAA////////////////AP///////////////////////////wAAAAAAAAD///////////////8A////////////////////////////AAAAAAAAAP///////////////wD///////////////////////////8AAAAAAAAA////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'5' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP//////////////8AAAAAAAAAAAAAAAAAAAAAAA//////////////8A///////////////MAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////////6wAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////////iAAAAAAAAAAAAAAAAAAAAAAA//////////////8A//////////////9kAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////////0QAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////////IAAAAAAAYP////////////////////////////8A//////////////wAAAAAAAB8/////////////////////////////wD/////////////3AAAAAAAAIj//////////////////!
 ///////////AP////////////+4AAAAAAAAoLRYHAAEKGTE//////////////////8A/////////////5QAAAAAAAAQAAAAAAAAAABY9P///////////////wD/////////////dAAAAAAAAAAAAAAAAAAAAAA89P//////////////AP////////////9QAAAAAAAAAAAAAAAAAAAAAABg//////////////8A/////////////zAAAAAAAAAAAAAAAAAAAAAAAADQ/////////////wD/////////////IAAAAAAAAGjY/+h4BAAAAAAAAGz/////////////AP//////////////9NS0lHSc//////90AAAAAAAALP////////////8A/////////////////////////////9QAAAAAAAAE/////////////wD//////////////////////////////wAAAAAAAAD/////////////AP/////////////////////////////8AAAAAAAAEP////////////8A////////////pIRwWEAgDOD//////8wAAAAAAAA8/////////////wD///////////9EAAAAAAAAaP//////ZAAAAAAAAHz/////////////AP///////////6QAAAAAAAAAaOD/4GQAAAAAAAAE4P////////////8A/////////////CQAAAAAAAAAAAAAAAAAAAAAAGD//////////////wD/////////////yAQAAAAAAAAAAAAAAAAAAAAc7P//////////////AP//////////////rAwAAAAAAAAAAAAAAAAAGNj///////////////8A////////////////0EAAAAAAAAAAAAAAAFTo/////////////////wD//////////////////8h4QCAAAAAcQHzU/////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'6' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////////////////+0ZCwMAAAUNGjI////////////////////AP/////////////////EMAAAAAAAAAAAAABM6P////////////////8A////////////////lAQAAAAAAAAAAAAAAAAo6P///////////////wD//////////////6wAAAAAAAAAAAAAAAAAAABI////////////////AP/////////////oEAAAAAAAAAAAAAAAAAAAAACw//////////////8A/////////////3AAAAAAAAAoxP/YPAAAAAAAAEj//////////////wD////////////4EAAAAAAACOD////YDCBAVGiAoP//////////////AP///////////7gAAAAAAABY//////////////////////////////8A////////////eAAAAAAAAJT//////////////////////////////wD///////////9MAAAAAAAAvP/IXBgABCx03P//////////////////AP///////////ygAAAAAAADcdAAAAAAAAAAEiP////////////////8A////////////FAAAAAAAAFAAAAAAAAAAAAAAcP///////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAlP//////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAQ8P////////////8A////////////AAAAAAAAAABAyP/kZAAAAAAAAACQ/////////////wD///////////8MAAAAAAAALPj/////WAAAAAAAAET//!
 ///////////AP///////////yQAAAAAAACY///////MAAAAAAAAFP////////////8A////////////SAAAAAAAAMD///////wAAAAAAAAA/////////////wD///////////9wAAAAAAAAvP///////wAAAAAAAAD/////////////AP///////////7QAAAAAAACI///////UAAAAAAAAJP////////////8A////////////+AwAAAAAACDw/////2wAAAAAAABY/////////////wD/////////////cAAAAAAAADC8/Ox4AAAAAAAAAKj/////////////AP/////////////oEAAAAAAAAAAAAAAAAAAAAAAk/P////////////8A//////////////+oAAAAAAAAAAAAAAAAAAAABLj//////////////wD///////////////+QAAAAAAAAAAAAAAAAAACQ////////////////AP////////////////+0JAAAAAAAAAAAAAAkuP////////////////8A///////////////////8sGg0FAAADCxgqPz//////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'7' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAABP////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAy4/////////////wD//////////////////////////+QUAAAAAAAEuP///!
 ///////////AP/////////////////////////8QAAAAAAAAKT///////////////8A/////////////////////////4wAAAAAAAB0/////////////////wD////////////////////////cCAAAAAAANPz/////////////////AP///////////////////////0QAAAAAAATY//////////////////8A//////////////////////+0AAAAAAAAeP///////////////////wD//////////////////////CQAAAAAABTw////////////////////AP////////////////////+gAAAAAAAAkP////////////////////8A/////////////////////ywAAAAAABDw/////////////////////wD///////////////////+4AAAAAAAAbP//////////////////////AP///////////////////1wAAAAAAADQ//////////////////////8A///////////////////4DAAAAAAAMP///////////////////////wD//////////////////7QAAAAAAAB8////////////////////////AP//////////////////aAAAAAAAAMj///////////////////////8A//////////////////8oAAAAAAAM/P///////////////////////wD/////////////////8AAAAAAAAET/////////////////////////AP////////////////+0AAAAAAAAcP////////////////////////8A/////////////////4wAAAAAAACY/////////////////////////wD/////////////////WAAAAAAAAMD//////////////////!
 ///////AP////////////////80AAAAAAAA4P////////////////////////8!
 A///////
//////////xAAAAAAAAD4/////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'8' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD////////////////////IdDQUAAAEIEiA1P//////////////////AP/////////////////gRAAAAAAAAAAAAAAAROD///////////////8A////////////////0BgAAAAAAAAAAAAAAAAAEMj//////////////wD///////////////AcAAAAAAAAAAAAAAAAAAAAHPD/////////////AP//////////////hAAAAAAAAAAAAAAAAAAAAAAAhP////////////8A//////////////8sAAAAAAAAKMz/zCgAAAAAAAAs/////////////wD//////////////wAAAAAAAADM////zAAAAAAAAAD/////////////AP//////////////BAAAAAAAAP//////AAAAAAAABP////////////8A//////////////8sAAAAAAAAzP///9QAAAAAAAAw/////////////wD//////////////3wAAAAAAAAoyP/YNAAAAAAAAIT/////////////AP//////////////7BgAAAAAAAAAAAAAAAAAAAAc8P////////////8A////////////////xBgAAAAAAAAAAAAAAAAAGNj//////////////wD/////////////////tAQAAAAAAAAAAAAAAACo/////!
 ///////////AP///////////////HAAAAAAAAAAAAAAAAAAAAB8//////////////8A//////////////9gAAAAAAAAAAAAAAAAAAAAAAB8/////////////wD/////////////wAAAAAAAAABk4P/UWAAAAAAAAATQ////////////AP////////////9UAAAAAAAAaP//////XAAAAAAAAGT///////////8A/////////////xgAAAAAAADg///////cAAAAAAAAJP///////////wD/////////////AAAAAAAAAP////////8AAAAAAAAA////////////AP////////////8AAAAAAAAA4P//////3AAAAAAAAAT///////////8A/////////////ygAAAAAAABg//////9cAAAAAAAALP///////////wD/////////////ZAAAAAAAAABY1P/cXAAAAAAAAABw////////////AP/////////////QAAAAAAAAAAAAAAAAAAAAAAAABNz///////////8A//////////////9gAAAAAAAAAAAAAAAAAAAAAAB0/////////////wD///////////////Q8AAAAAAAAAAAAAAAAAAAAUPz/////////////AP////////////////x4CAAAAAAAAAAAAAAAEIT8//////////////8A///////////////////smFQwGAAAABg0ZKT0/////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'9' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////////////////ysYCwMAAAUNGiw/P//////////////////AP////////////////+4JAAAAAAAAAAAAAAkuP////////////////8A////////////////lAQAAAAAAAAAAAAAAAAAkP///////////////wD//////////////8AEAAAAAAAAAAAAAAAAAAAAqP//////////////AP/////////////8JAAAAAAAAAAAAAAAAAAAAAAQ7P////////////8A/////////////6wAAAAAAAAAfOz8vCwAAAAAAABw/////////////wD/////////////WAAAAAAAAHD/////7BgAAAAAAAz4////////////AP////////////8kAAAAAAAA1P//////hAAAAAAAALT///////////8A/////////////wAAAAAAAAD///////+4AAAAAAAAcP///////////wD/////////////AAAAAAAAAPz//////8AAAAAAAABI////////////AP////////////8UAAAAAAAAzP//////lAAAAAAAACT///////////8A/////////////0QAAAAAAABY//////gsAAAAAAAADP///////////wD/////////////kAAAAAAAAABw5P/IPAAAAAAAAAAA////////////AP/////////////wEAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A//////////////+UAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD///////////////9wAAAAAAAAAAAAAFAAAAAAAAAU/!
 ///////////AP////////////////+IBAAAAAAAAABw3AAAAAAAACj///////////8A///////////////////cdCwEABhcxP+8AAAAAAAATP///////////wD//////////////////////////////5AAAAAAAAB4////////////AP//////////////////////////////UAAAAAAAALj///////////8A//////////////+kgGxUQCAM2P///+AIAAAAAAAQ+P///////////wD//////////////0gAAAAAAAA42P/EKAAAAAAAAHD/////////////AP//////////////sAAAAAAAAAAAAAAAAAAAAAAQ6P////////////8A////////////////TAAAAAAAAAAAAAAAAAAAAKz//////////////wD////////////////oKAAAAAAAAAAAAAAAAASU////////////////AP/////////////////sUAAAAAAAAAAAAAAwxP////////////////8A////////////////////yHA0FAAADCxktP///////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'A' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////+QAAAAAAAAAAAAAAOT/////////////////AP//////////////////kAAAAAAAAAAAAAAAkP////////////////8A//////////////////88AAAAAAAAAAAAAAA8/////////////////wD/////////////////5AAAAAAAAAAAAAAAAADk////////////////AP////////////////+QAAAAAAAAAAAAAAAAAJD///////////////8A/////////////////zwAAAAAAAAAAAAAAAAAPP///////////////wD////////////////kAAAAAAAAAAgAAAAAAAAA5P//////////////AP///////////////5AAAAAAAAAAgAAAAAAAAACQ//////////////8A////////////////PAAAAAAAAAz8HAAAAAAAADz//////////////wD//////////////+QAAAAAAAAAWP9kAAAAAAAAANz//!
 ///////////AP//////////////kAAAAAAAAACk/7wAAAAAAAAAhP////////////8A//////////////88AAAAAAAABOz//BQAAAAAAAAw/////////////wD/////////////4AAAAAAAAAA8////ZAAAAAAAAADc////////////AP////////////+EAAAAAAAAAIj///+8AAAAAAAAAIT///////////8A/////////////zAAAAAAAAAA2P////wQAAAAAAAAMP///////////wD////////////cAAAAAAAAACT//////1wAAAAAAAAA3P//////////AP///////////4QAAAAAAAAAAAAAAAAAAAAAAAAAAACE//////////8A////////////MAAAAAAAAAAAAAAAAAAAAAAAAAAAADD//////////wD//////////9wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANz/////////AP//////////hAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAhP////////8A//////////8wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAw/////////wD/////////3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADc////////AP////////+EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIT///////8A/////////zAAAAAAAAAAhP///////////2QAAAAAAAAAMP///////wD////////cAAAAAAAAAADM////////////vAAAAAAAAAAA3P//////AP///////4QAAAAAAAAAHP/////////////4DAAAAAAAAACE//////8A////////MAAAAAAAAABk//////////////9cAAAAAAAAADD//////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'B' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAEDh83P///////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAEhP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAeP////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAxP///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAABY////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAABT///////////8A//////////8AAAAAAAAAAP/////4zEwAAAAAAAAAAP///////////wD//////////wAAAAAAAAAA////////7AAAAAAAAAAQ////////////AP//////////AAAAAAAAAAD////////sAAAAAAAAAEj///////////8A//////////8AAAAAAAAAAP/////4zEQAAAAAAAAAtP///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAFz/////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAiA/P////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAIjPj//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAGKz//!
 ///////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAJT///////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAABNz//////////wD//////////wAAAAAAAAAA///////sqCAAAAAAAAAAbP//////////AP//////////AAAAAAAAAAD/////////yAAAAAAAAAAs//////////8A//////////8AAAAAAAAAAP//////////AAAAAAAAAAT//////////wD//////////wAAAAAAAAAA/////////7wAAAAAAAAAAP//////////AP//////////AAAAAAAAAAD//////+ikGAAAAAAAAAAY//////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFT//////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsP//////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAADj///////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAc6P///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAATOj/////////////AP//////////AAAAAAAAAAAAAAAAAAAEIEBkkNj///////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'C' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP//////////////////5JRULBAAAAgkTIDQ//////////////////8A////////////////1FAAAAAAAAAAAAAAAABAyP///////////////wD//////////////4gEAAAAAAAAAAAAAAAAAAAElP//////////////AP////////////9wAAAAAAAAAAAAAAAAAAAAAAAAlP////////////8A////////////kAAAAAAAAAAAAAAAAAAAAAAAAAAEyP///////////wD//////////9wIAAAAAAAAAAAAAAAAAAAAAAAAAAAw/!
 ///////////AP//////////WAAAAAAAAAAAWMz/8JwQAAAAAAAAAACw//////////8A/////////+wEAAAAAAAAAID//////9QMAAAAAAAAAET//////////wD/////////nAAAAAAAAAAo/P///////3wAAAAABDBspP//////////AP////////9gAAAAAAAAAIz/////////3BxQjMT0//////////////8A/////////zQAAAAAAAAAzP///////////////////////////////wD/////////GAAAAAAAAADo////////////////////////////////AP////////8AAAAAAAAAAP////////////////////////////////8A/////////wAAAAAAAAAA/////////////////////////////////wD/////////AAAAAAAAAAD/////////////////////////////////AP////////8cAAAAAAAAAOj///////////////////////////////8A/////////zgAAAAAAAAA0P/////////kIGio7P///////////////wD/////////bAAAAAAAAACg/////////5wAAAAAMHS49P//////////AP////////+oAAAAAAAAAEz/////////PAAAAAAAAAAc//////////8A//////////QIAAAAAAAAALz//////6QAAAAAAAAAAGT//////////wD//////////3AAAAAAAAAADIzo/+SEBAAAAAAAAAAAyP//////////AP//////////7BAAAAAAAAAAAAAAAAAAAAAAAAAAAED///////////8A////////////rAAAAAAAAAAAAAAAAAAAAAAAAAAE0P///////////wD/////////////fAAAAAAAAAAAAAAAAAAAAAAAAJz//////!
 ///////AP//////////////iAQAAAAAAAAAAAAAAAAAAASY//////////////8!
 A///////
/////////yEAAAAAAAAAAAAAAAAA8yP///////////////wD//////////////////9yIUCwQAAAAIEB4yP//////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'D' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////////8AAAAAAAAAAAAAAAAADChQkOT/////////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAABGjw//////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAACDY/////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAABjk////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAED///////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAKj//////////wD///////////8AAAAAAAAAAP///+isSAAAAAAAAAAANP//////////AP///////////wAAAAAAAAAA////////hAAAAAAAAAAA2P////////8A////////////AAAAAAAAAAD/////////MAAAAAAAAACQ/////////wD///////////8AAAAAAAAAAP////////+MAAAAAAAAAFj/////////AP///////////wAAAAAAAAAA/////////8gAAAAAAAAAMP////////8A////////////AAAAAAAAAAD/////////5AAAAAAAAAAY/////////wD///////////8AAAAAAAAAAP//////////AAAAAAAAA!
 AD/////////AP///////////wAAAAAAAAAA//////////8AAAAAAAAAAP////////8A////////////AAAAAAAAAAD//////////wAAAAAAAAAA/////////wD///////////8AAAAAAAAAAP/////////wAAAAAAAAABD/////////AP///////////wAAAAAAAAAA/////////9QAAAAAAAAAJP////////8A////////////AAAAAAAAAAD/////////qAAAAAAAAABI/////////wD///////////8AAAAAAAAAAP////////9QAAAAAAAAAHj/////////AP///////////wAAAAAAAAAA////////uAAAAAAAAAAAvP////////8A////////////AAAAAAAAAAD////w0HwEAAAAAAAAACT8/////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAoP//////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAAADz8//////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAY6P///////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAKNz/////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAACHT0//////////////8A////////////AAAAAAAAAAAAAAAAABg4bKj0/////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'E' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//!
 ///////////AP//////////AAAAAAAAAAD///////////////////////////////8A//////////8AAAAAAAAAAP///////////////////////////////wD//////////wAAAAAAAAAA////////////////////////////////AP//////////AAAAAAAAAAD///////////////////////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8A//////////8AAAAAAAAAAP///////////////////////////////wD//////////wAAAAAAAAAA////////////////////////////////AP//////////AAAAAAAAAAD///////////////////////////////8A//////////8AAAAAAAAAAP///////////////////////////////wD//////////wAAAAAAAAAA////////////////////////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////!
 ///////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8!
 A///////
///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'F' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA/////!
 ///////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'G' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////MB8TCgQAAAACCA4YJzs////////////////AP///////////////JQcAAAAAAAAAAAAAAAAAAhw8P////////////8A/////////////9gwAAAAAAAAAAAAAAAAAAAAAAAk2P///////////wD////////////EDAAAAAAAAAAAAAAAAAAAAAAAAAAc7P//////////AP//////////2AwAAAAAAAAAAAAAAAAAAAAAAAAAAABY//////////8A//////////wwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADQ/////////wD/////////kAAAAAAAAAAAEHzQ/P/gmCAAAAAAAAAAAFz/////////AP////////wcAAAAAAAAACjg////////8CwAAAAAAAAgWP////////8A////////vAAAAAAAAAAI2P//////////yBRAcJjI8P///////////wD///////94AAAAAAAAAGD//////////////////////!
 ///////////AP///////0AAAAAAAAAAsP////////////////////////////////8A////////IAAAAAAAAADc/////////////////////////////////wD///////8AAAAAAAAAAP///////wAAAAAAAAAAAAAAAAD/////////AP///////wAAAAAAAAAA////////AAAAAAAAAAAAAAAAAP////////8A////////AAAAAAAAAAD///////8AAAAAAAAAAAAAAAAA/////////wD///////8gAAAAAAAAAOD//////wAAAAAAAAAAAAAAAAD/////////AP///////0AAAAAAAAAAtP//////AAAAAAAAAAAAAAAAAP////////8A////////cAAAAAAAAABw//////8AAAAAAAAAAAAAAAAA/////////wD///////+8AAAAAAAAABDs////////////AAAAAAAAAAD/////////AP////////wYAAAAAAAAADz0//////////AAAAAAAAAAAP////////8A/////////5AAAAAAAAAAACCY4P//3KhcCAAAAAAAAAAA/////////wD/////////+CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////AP//////////xAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIP////////8A////////////rAQAAAAAAAAAAAAAAAAAAAAAAAAAAGTw/////////wD/////////////vBQAAAAAAAAAAAAAAAAAAAAAADjI////////////AP//////////////8HAQAAAAAAAAAAAAAAAAAEiw//////////////8A//////////////////iwcEAgBAAABCA4aKDk/////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'H' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAA!
 P//////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP///!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'I' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP///////////!
 ///////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'J' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP//////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP//////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP//////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP//////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP///!
 ///////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAj//////////////wD//////////+zMrIxwUDAQ//////wAAAAAAAAAIP//////////////AP//////////DAAAAAAAAADo////2AAAAAAAAAA0//////////////8A//////////8wAAAAAAAAAKj///+YAAAAAAAAAFj//////////////wD//////////2gAAAAAAAAAIND/yBgAAAAAAAAAkP//////////////AP//////////vAAAAAAAAAAAAAAAAAAAAAAAAADc//////////////8A////////////MAAAAAAAAAAAAAAAAAAAAAAAUP///////////////wD////////////EBAAAAAAAAAAAAAAAAAAAABjk////////////////AP////////////+sBAAAAAAAAAAAAAAAAAAY2P////////////////8A///////////////EMAAAAAAAAAAAAAAAVOj//////////////////wD/////////////////vHBAIAAAABg8fNT/////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'K' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////8AAAAAAAAAAP//////////wAQAAAAAAAAAAABw////////AP///////wAAAAAAAAAA/////////9AMAAAAAAAAAAAAcP////////8A////////AAAAAAAAAAD////////cGAAAAAAAAAAAAHD//////////wD///////8AAAAAAAAAAP//////6CgAAAAAAAAAAABs////////////AP///////wAAAAAAAAAA//////Q0AAAAAAAAAAAAVPz///////////8A////////AAAAAAAAAAD////8RAAAAAAAAAAAAFT8/////////////wD///////8AAAAAAAAAAP///1gAAAAAAAAAAABU/P///!
 ///////////AP///////wAAAAAAAAAA//9wAAAAAAAAAAAASPz///////////////8A////////AAAAAAAAAAD/jAAAAAAAAAAAADz0/////////////////wD///////8AAAAAAAAAAKQAAAAAAAAAAAA89P//////////////////AP///////wAAAAAAAAAABAAAAAAAAAAAFPT///////////////////8A////////AAAAAAAAAAAAAAAAAAAAAAAApP///////////////////wD///////8AAAAAAAAAAAAAAAAAAAAAAAAU8P//////////////////AP///////wAAAAAAAAAAAAAAAAAAAAAAAABk//////////////////8A////////AAAAAAAAAAAAAAAAAAAAAAAAAADE/////////////////wD///////8AAAAAAAAAAAAAAAAoEAAAAAAAACz8////////////////AP///////wAAAAAAAAAAAAAAGNiAAAAAAAAAAIj///////////////8A////////AAAAAAAAAAAAABjY//gYAAAAAAAACOD//////////////wD///////8AAAAAAAAAAAAY2P///5wAAAAAAAAASP//////////////AP///////wAAAAAAAAAAGNj//////CgAAAAAAAAAqP////////////8A////////AAAAAAAAAADI////////sAAAAAAAAAAc8P///////////wD///////8AAAAAAAAAAP//////////QAAAAAAAAABs////////////AP///////wAAAAAAAAAA///////////IAAAAAAAAAATI//////////8A////////AAAAAAAAAAD///////////9YAAAAAAAAADD8/////////wD///////8AAAAAAAAAAP///////////9wEAAAAAAAAAJD//!
 ///////AP///////wAAAAAAAAAA/////////////3AAAAAAAAAADOT///////8!
 A///////
/AAAAAAAAAAD/////////////7BAAAAAAAAAAUP///////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'L' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD//////////////////!
 ///////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'M' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A//////8AAAAAAAAAAAAAAHz//////3wAAAAAAAAAAAAAAP///////wD//////wAAAAAAAAAAAAAATP//////UAAAAAAAAAAAAAAA////////AP//////AAAAAAAAAAAAAAAc//////8cAAAAAAAAAAAAAAD///////8A//////8AAAAAAAAAAAAAAADw////8AAAAAAAAAAAAAAAAP///////wD//////wAAAAAAAAAAAAAAALz////AAAAAAAAAAAAAAAAA////////AP//////AAAAAAAAAAAAAAAAkP///5AAAAAAAAAAAAAAAAD///////8A//////8AAAAAAAAAAAAAAABc////ZAAAAAAAAAAAAAAAAP///////wD//////wAAAAAAAAAoAAAAADD///8wAAAAACQAAAAAAAAA////////AP//////AAAAAAAAAFwAAAAABPz//AgAAAAAXAAAAAAAAAD///////8A//////8AAAAAAAAAkAAAAAAA0P/UAAAAAACQAAAAAAAAAP///////wD//////wAAAAAAAADMAAAAAACg/6gAAAAAAMQAAAAAAAAA////////AP//////AAAAAAAAAPgEAAAAAHD/dAAAAAAE+AAAAAAAAAD///////8A//////8AAAAAAAAA/zQAAAAAQP9IAAAAADD/AAAAAAAAAP///////wD//////wAAAAAAAAD/bAAAAAAQ/xQAAAAAaP8AAAAAA!
 AAA////////AP//////AAAAAAAAAP+gAAAAAADQAAAAAACc/wAAAAAAAAD///////8A//////8AAAAAAAAA/9QAAAAAAGgAAAAAAND/AAAAAAAAAP///////wD//////wAAAAAAAAD//wwAAAAAFAAAAAAM/P8AAAAAAAAA////////AP//////AAAAAAAAAP//RAAAAAAAAAAAADz//wAAAAAAAAD///////8A//////8AAAAAAAAA//94AAAAAAAAAAAAcP//AAAAAAAAAP///////wD//////wAAAAAAAAD//7AAAAAAAAAAAACo//8AAAAAAAAA////////AP//////AAAAAAAAAP//5AAAAAAAAAAAANz//wAAAAAAAAD///////8A//////8AAAAAAAAA////HAAAAAAAAAAQ////AAAAAAAAAP///////wD//////wAAAAAAAAD///9QAAAAAAAAAEz///8AAAAAAAAA////////AP//////AAAAAAAAAP///4gAAAAAAAAAfP///wAAAAAAAAD///////8A//////8AAAAAAAAA////vAAAAAAAAACw////AAAAAAAAAP///////wD//////wAAAAAAAAD////wAAAAAAAAAOz///8AAAAAAAAA////////AP//////AAAAAAAAAP////8sAAAAAAAc/////wAAAAAAAAD///////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'N' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////AAAAAAAAALD/////////////AAAAAAAAAP//////////AP////////8AAAAAAAAAFOj///////////8AAAAAAAAA//////////8A/////////wAAAAAAAAAASP///////////wAAAAAAAAD//////////wD/////////AAAAAAAAAAAAkP//////////AAAAAAAAAP//////////AP////////8AAAAAAAAAAAAI1P////////8AAAAAAAAA//////////8A/////////wAAAAAAAAAAAAAw+P///////wAAAAAAAAD//////////wD/////////AAAAAAAAAAAAAABw////////AAAAAAAAAP//////////AP////////8AAAAAAAAAAAAAAAC8//////8AAAAAAAAA//////////8A/////////wAAAAAAAAAAAAAAABzs/////wAAAAAAAAD//////////wD/////////AAAAAAAAAAAAAAAAAFD/////AAAAAAAAA!
 P//////////AP////////8AAAAAAAAAAAAAAAAAAJz///8AAAAAAAAA//////////8A/////////wAAAAAAAAAUAAAAAAAADNz//wAAAAAAAAD//////////wD/////////AAAAAAAAALQAAAAAAAAANPz/AAAAAAAAAP//////////AP////////8AAAAAAAAA/2wAAAAAAAAAfP8AAAAAAAAA//////////8A/////////wAAAAAAAAD/+CwAAAAAAAAExAAAAAAAAAD//////////wD/////////AAAAAAAAAP//0AQAAAAAAAAgAAAAAAAAAP//////////AP////////8AAAAAAAAA////jAAAAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAD/////RAAAAAAAAAAAAAAAAAD//////////wD/////////AAAAAAAAAP/////kFAAAAAAAAAAAAAAAAP//////////AP////////8AAAAAAAAA//////+sAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAD///////9kAAAAAAAAAAAAAAD//////////wD/////////AAAAAAAAAP////////QkAAAAAAAAAAAAAP//////////AP////////8AAAAAAAAA/////////8wEAAAAAAAAAAAA//////////8A/////////wAAAAAAAAD//////////4QAAAAAAAAAAAD//////////wD/////////AAAAAAAAAP///////////DwAAAAAAAAAAP//////////AP////////8AAAAAAAAA////////////4BAAAAAAAAAA//////////8A/////////wAAAAAAAAD/////////////qAAAAAAAAAD//////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'O' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A///////////////////0qGw4HAAAABw4aKT0/////////////////wD////////////////wcAwAAAAAAAAAAAAAAAho6P//////////////AP//////////////uBQAAAAAAAAAAAAAAAAAAAAMoP////////////8A/////////////6AEAAAAAAAAAAAAAAAAAAAAAAAAkP///////////wD///////////+4BAAAAAAAAAAAAAAAAAAAAAAAAAAAoP//////////AP//////////8BQAAAAAAAAAAAAAAAAAAAAAAAAAAAAM5P////////8A//////////9wAAAAAAAAAAAsrPD/7KQsAAAAAAAAAABg/////////wD/////////+BAAAAAAAAAAUPj///////hQAAAAAAAAAAjs////////AP////////+sAAAAAAAAABDw//////////AYAAAAAAAAAKD///////8A/////////2wAAAAAAAAAdP///////////3wAAAAAAAAAYP///////wD/////////OAAAAAAAAAC4////////////xAAAAAAAA!
 AAw////////AP////////8cAAAAAAAAAOD////////////oAAAAAAAAABT///////8A/////////wAAAAAAAAAA//////////////8AAAAAAAAAAP///////wD/////////AAAAAAAAAAD//////////////wAAAAAAAAAA////////AP////////8AAAAAAAAAAP/////////////8AAAAAAAAAAD///////8A/////////xwAAAAAAAAA5P///////////+AAAAAAAAAAHP///////wD/////////NAAAAAAAAAC8////////////uAAAAAAAAAA4////////AP////////9oAAAAAAAAAHj///////////98AAAAAAAAAGT///////8A/////////6gAAAAAAAAAGPD/////////+BgAAAAAAAAApP///////wD/////////9AwAAAAAAAAAUPz///////xcAAAAAAAAAAjs////////AP//////////cAAAAAAAAAAALKjs//CwOAAAAAAAAAAAYP////////8A///////////wFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAzk/////////wD///////////+4BAAAAAAAAAAAAAAAAAAAAAAAAAAAoP//////////AP////////////+QAAAAAAAAAAAAAAAAAAAAAAAAAJD///////////8A//////////////+sEAAAAAAAAAAAAAAAAAAAAAyg/////////////wD////////////////oZAgAAAAAAAAAAAAAAARg4P//////////////AP//////////////////9KhsOCAAAAAUMFyc7P////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'P' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP///////////wAAAAAAAAAAAAAAAAAACCxguP////////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAOOD//////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAGOD/////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAARP////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAxP///////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAABo////////////AP///////////wAAAAAAAAAA////6JwMAAAAAAAAADD///////////8A////////////AAAAAAAAAAD//////6AAAAAAAAAADP///////////wD///////////8AAAAAAAAAAP//////9AAAAAAAAAAA////////////AP///////////wAAAAAAAAAA///////0AAAAAAAAAAD///////////8A////////////AAAAAAAAAAD//////5gAAAAAAAAAHP///////////wD///////////8AAAAAAAAAAP///9iICAAAAAAAAABI////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAJD///////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAI6P///////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAIT//!
 ///////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAABU/P////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAIhPz//////////////wD///////////8AAAAAAAAAAAAAAAAABCRMkOz/////////////////AP///////////wAAAAAAAAAA//////////////////////////////8A////////////AAAAAAAAAAD//////////////////////////////wD///////////8AAAAAAAAAAP//////////////////////////////AP///////////wAAAAAAAAAA//////////////////////////////8A////////////AAAAAAAAAAD//////////////////////////////wD///////////8AAAAAAAAAAP//////////////////////////////AP///////////wAAAAAAAAAA//////////////////////////////8A////////////AAAAAAAAAAD//////////////////////////////wD///////////8AAAAAAAAAAP//////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'Q' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////SoaDQcAAAAHDhoqPT///////////////////8A//////////////BwDAAAAAAAAAAAAAAACHDo/////////////////wD///////////+4FAAAAAAAAAAAAAAAAAAAABCo////////////////AP//////////nAQAAAAAAAAAAAAAAAAAAAAAAACQ//////////////8A/////////7gEAAAAAAAAAAAAAAAAAAAAAAAAAACg/////////////wD////////wFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAzo////////////AP///////3AAAAAAAAAAACyo8P/sqCwAAAAAAAAAAGT///////////8A///////4EAAAAAAAAABM+P///////FQAAAAAAAAACPT//////////wD//////7AAAAAAAAAAFPD/////////9BgAAAAAAAAApP//////////AP//////bAAAAAAAAAB4////////////fAAAAAAAAABk//////////8A//////84AAAAAAAAALz///////////+8AAAAAAAAADT//////////wD//////xwAAAAAAAAA6P///////////+QAAAAAAAAAH!
 P//////////AP//////AAAAAAAAAAD//////////////wAAAAAAAAAA//////////8A//////8AAAAAAAAAAP//////////////AAAAAAAAAAD//////////wD//////wAAAAAAAAAA/P////////////8AAAAAAAAAAP//////////AP//////GAAAAAAAAADg////////////4AAAAAAAAAAc//////////8A//////84AAAAAAAAALT////MJHTo//+8AAAAAAAAADT//////////wD//////2wAAAAAAAAAdP///2AAABCg/3wAAAAAAAAAZP//////////AP//////rAAAAAAAAAAY9P/sCAAAAABMGAAAAAAAAACk//////////8A///////4EAAAAAAAAABU/P+0OAAAAAAAAAAAAAAACPT//////////wD///////94AAAAAAAAAAA4sPD/gAAAAAAAAAAAAABk////////////AP////////AcAAAAAAAAAAAAAAAAAAAAAAAAAAAADOT///////////8A/////////7wEAAAAAAAAAAAAAAAAAAAAAAAAAACQ/////////////wD//////////6wEAAAAAAAAAAAAAAAAAAAAAAAAABSs////////////AP///////////7gUAAAAAAAAAAAAAAAAAAAAAAAAAABAwP////////8A//////////////BwDAAAAAAAAAAAAAAABAgAAAAAAAA8/////////wD////////////////0qGg0GAAAABgwXJjkxBgAAAAAALD/////////AP//////////////////////////////////5DQAAAAk/P////////8A////////////////////////////////////+GwAAJD//////////wD//////////////////////////////////////8A49P///!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'R' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////wAAAAAAAAAAAAAAAAAAAAQgOGSk+P///////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAcuP//////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAEsP////////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQ6P///////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAADD///////////8A/////////wAAAAAAAAAA///////svDgAAAAAAAAACP///////////wD/////////AAAAAAAAAAD/////////7AAAAAAAAAAA////////////AP////////8AAAAAAAAAAP/////////cAAAAAAAAABD///////////8A/////////wAAAAAAAAAA//////DQoCQAAAAAAAAAQP///////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAACU////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAIPj///////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAzU/////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAA02P///!
 ///////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAxctPz///////////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAEDY/////////////////wD/////////AAAAAAAAAAD/9LAsAAAAAAAAAAzc////////////////AP////////8AAAAAAAAAAP///+wkAAAAAAAAADD8//////////////8A/////////wAAAAAAAAAA/////8QAAAAAAAAAAJD//////////////wD/////////AAAAAAAAAAD//////1QAAAAAAAAAFPD/////////////AP////////8AAAAAAAAAAP//////3AQAAAAAAAAAgP////////////8A/////////wAAAAAAAAAA////////aAAAAAAAAAAM6P///////////wD/////////AAAAAAAAAAD////////oCAAAAAAAAABs////////////AP////////8AAAAAAAAAAP////////+AAAAAAAAAAATc//////////8A/////////wAAAAAAAAAA//////////AUAAAAAAAAAFj//////////wD/////////AAAAAAAAAAD//////////5AAAAAAAAAAAND/////////AP////////8AAAAAAAAAAP//////////+CQAAAAAAAAAQP////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'S' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP/////////////////8vHBEIAgAAAQgQHC8/P////////////////8A////////////////pCQAAAAAAAAAAAAAAAAcoP///////////////wD//////////////FwAAAAAAAAAAAAAAAAAAAAAXP//////////////AP////////////9oAAAAAAAAAAAAAAAAAAAAAAAAhP////////////8A////////////zAAAAAAAAAAAAAAAAAAAAAAAAAAI6P///////////wD///////////9cAAAAAAAAAAAAAAAAAAAAAAAAAACA////////////AP///////////xgAAAAAAAAAUOD/8KwkAAAAAAAAADj///////////8A////////////AAAAAAAAAAD0/////8wABCAgICxASP///////////wD///////////8MAAAAAAAAAMz//////////////////!
 ///////////AP///////////0AAAAAAAAAACFiQxPT///////////////////////8A////////////oAAAAAAAAAAAAAAAADBwtPT//////////////////wD////////////8QAAAAAAAAAAAAAAAAAAACFTA////////////////AP/////////////oOAAAAAAAAAAAAAAAAAAAAABM6P////////////8A///////////////4fAgAAAAAAAAAAAAAAAAAAAAY2P///////////wD/////////////////7IwwAAAAAAAAAAAAAAAAAAAo+P//////////AP/////////////////////koGw0BAAAAAAAAAAAAACU//////////8A///////////////////////////4uFgAAAAAAAAAADz//////////wD//////////2BgSEA0IBwA6P///////5QAAAAAAAAADP//////////AP//////////JAAAAAAAAACc/////////AAAAAAAAAAA//////////8A//////////9YAAAAAAAAACDo///////AAAAAAAAAABT//////////wD//////////6QAAAAAAAAAACCk7P/snBQAAAAAAAAAUP//////////AP//////////+BAAAAAAAAAAAAAAAAAAAAAAAAAAAACs//////////8A////////////kAAAAAAAAAAAAAAAAAAAAAAAAAAAOP///////////wD////////////8RAAAAAAAAAAAAAAAAAAAAAAAABjc////////////AP/////////////0PAAAAAAAAAAAAAAAAAAAAAAg2P////////////8A///////////////8hBQAAAAAAAAAAAAAAAAMdPT//////////////wD/////////////////+LRwSCAMAAAAHDhoqPT//////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'T' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP///////////!
 ///////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'U' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAA!
 P//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////JAAAAAAAAADk/////////+gAAAAAAAAAHP//////////AP////////9MAAAAAAAAAJz/////////nAAAAAAAAABE//////////8A/////////4gAAAAAAAAAHOj//////+ggAAAAAAAAAHz//////////wD/////////0AAAAAAAAAAAIJzs/+ykIAAAAAAAAAAA0P//////////AP//////////QAAAAAAAAAAAAAAAAAAAAAAAAAAAAED///////////8A///////////IBAAAAAAAAAAAAAAAAAAAAAAAAAAE0P///////////wD///////////+YAAAAAAAAAAAAAAAAAAAAAAAAAJj/////////////AP////////////+UBAAAAAAAAAAAAAAAAAAAAASU//////////////8A///////////////IPAAAAAAAAAAAAAAAAAAwyP///////////////wD/////////////////0IxYOCAIAAAEIEiAyP//////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'V' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////zAAAAAAAAAAYP//////////////ZAAAAAAAAAAw////////AP//////kAAAAAAAAAAU/P////////////8UAAAAAAAAAJD///////8A///////oBAAAAAAAAADE////////////xAAAAAAAAAAE7P///////wD///////9MAAAAAAAAAHD///////////94AAAAAAAAAEz/////////AP///////6gAAAAAAAAAJP///////////yQAAAAAAAAArP////////8A////////+BAAAAAAAAAA1P/////////YAAAAAAAAABT4/////////wD/////////aAAAAAAAAACE/////////4QAAAAAAAAAb!
 P//////////AP/////////EAAAAAAAAADT/////////OAAAAAAAAADM//////////8A//////////8kAAAAAAAAAOT//////+QAAAAAAAAAKP///////////wD//////////4QAAAAAAAAAmP//////nAAAAAAAAACI////////////AP//////////5AAAAAAAAABE//////9EAAAAAAAABOT///////////8A////////////QAAAAAAAAAT0////9AgAAAAAAABI/////////////wD///////////+gAAAAAAAAAKT///+kAAAAAAAAAKj/////////////AP////////////QIAAAAAAAAXP///1wAAAAAAAAM+P////////////8A/////////////1wAAAAAAAAM+P/8DAAAAAAAAGT//////////////wD/////////////vAAAAAAAAAC8/7wAAAAAAAAAxP//////////////AP//////////////HAAAAAAAAGj/aAAAAAAAACT///////////////8A//////////////94AAAAAAAAHP8cAAAAAAAAhP///////////////wD//////////////9gAAAAAAAAAkAAAAAAAAADk////////////////AP///////////////zgAAAAAAAAQAAAAAAAAQP////////////////8A////////////////lAAAAAAAAAAAAAAAAACg/////////////////wD////////////////sCAAAAAAAAAAAAAAADPT/////////////////AP////////////////9QAAAAAAAAAAAAAABg//////////////////8A/////////////////7AAAAAAAAAAAAAAAMD//////////////////wD//////////////////BQAAAAAAAAAAAAc/////////////!
 ///////AP//////////////////cAAAAAAAAAAAAHz///////////////////8!
 A///////
////////////MAAAAAAAAAAAA3P///////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'W' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A//8cAAAAAAAAALz/////4AAAAAAAAAAA6P////+8AAAAAAAAABz//wD//1QAAAAAAAAAjP////+gAAAAAAAAAACo/////4wAAAAAAAAAUP//AP//jAAAAAAAAABU/////2AAAAAAAAAAAGj/////VAAAAAAAAACM//8A///EAAAAAAAAACT/////IAAAAAAAAAAAKP////8kAAAAAAAAAMT//wD///gEAAAAAAAAAPD//+AAAAAAAAAAAAAA6P//8AAAAAAAAAAE9P//AP///zAAAAAAAAAAvP//oAAAAAAAAAAAAACo//+8AAAAAAAAADD///8A////bAAAAAAAAACM//9gAAAAAAAAAAAAAGT//4wAAAAAAAAAaP///wD///+kAAAAAAAAAFT//yAAAAAAAAAAAAAAIP//VAAAA!
 AAAAACc////AP///9gAAAAAAAAAJP/gAAAAAAAAAAAAAAAA4P8kAAAAAAAAANT///8A/////xAAAAAAAAAA8KAAAAAAAAAAAAAAAACg8AAAAAAAAAAQ/////wD/////TAAAAAAAAAC8YAAAAAAAAAAAAAAAAGC8AAAAAAAAAET/////AP////+AAAAAAAAAAIwgAAAAAAAAAAAAAAAAIIwAAAAAAAAAfP////8A/////7gAAAAAAAAANAAAAAAAACwwAAAAAAAANAAAAAAAAACw/////wD/////8AAAAAAAAAAAAAAAAAAAdHgAAAAAAAAAAAAAAAAAAOz/////AP//////KAAAAAAAAAAAAAAAAAC4vAAAAAAAAAAAAAAAAAAg//////8A//////9gAAAAAAAAAAAAAAAACPj4CAAAAAAAAAAAAAAAAFj//////wD//////5QAAAAAAAAAAAAAAABE//9IAAAAAAAAAAAAAAAAkP//////AP//////0AAAAAAAAAAAAAAAAIj//4wAAAAAAAAAAAAAAADI//////8A///////8DAAAAAAAAAAAAAAAzP//1AAAAAAAAAAAAAAABPj//////wD///////88AAAAAAAAAAAAABT/////GAAAAAAAAAAAAAA0////////AP///////3QAAAAAAAAAAAAAWP////9gAAAAAAAAAAAAAHD///////8A////////sAAAAAAAAAAAAACg/////6QAAAAAAAAAAAAApP///////wD////////kAAAAAAAAAAAAAOT/////6AAAAAAAAAAAAADc////////AP////////8cAAAAAAAAAAAo////////MAAAAAAAAAAAEP////////8A/////////1QAAAAAAAAAAHD///////94AAAAAAAAAABM/////////wD/////////jAAAAAAAAAAAtP///////7wAAAAAAAAAAID//!
 ///////AP/////////EAAAAAAAAAAT0////////+AgAAAAAAAAAuP////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'X' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////9UAAAAAAAAAKz///////////+sAAAAAAAAAFD/////////AP///////+QQAAAAAAAAFOT/////////8BwAAAAAAAAM5P////////8A/////////5gAAAAAAAAATP////////9kAAAAAAAAAJD//////////wD//////////0AAAAAAAAAAoP//////wAAAAAAAAAA0/P//////////AP//////////2AgAAAAAAAAQ4P////gkAAAAAAAABMz///////////8A////////////iAAAAAAAAABA////dAAAAAAAAABw/////////////wD////////////8MAAAAAAAAACU/9AEAAAAAAAAHPD/////////////AP/////////////IBAAAAAAAAAzYMAAAAAAAAACs//////////////8A//////////////90AAAAAAAAABAAAAAAAAAATP///////////////wD///////////////QgAAAAAAAAAAAAAAAAAAzg/////!
 ///////////AP///////////////7wAAAAAAAAAAAAAAAAAjP////////////////8A/////////////////2AAAAAAAAAAAAAAADD8/////////////////wD/////////////////7BQAAAAAAAAAAAAEyP//////////////////AP/////////////////gDAAAAAAAAAAAAAjY//////////////////8A/////////////////0AAAAAAAAAAAAAAADj8/////////////////wD///////////////+UAAAAAAAAAAAAAAAAAJD/////////////////AP//////////////4AwAAAAAAAAAAAAAAAAADOD///////////////8A//////////////9AAAAAAAAAAAAAAAAAAAAAQP///////////////wD/////////////nAAAAAAAAAAAWAAAAAAAAAAAlP//////////////AP///////////+QQAAAAAAAAAGD/YAAAAAAAAAAM4P////////////8A////////////TAAAAAAAAAAs9P/0LAAAAAAAAABM/////////////wD//////////6AAAAAAAAAADNT////UDAAAAAAAAACg////////////AP/////////kEAAAAAAAAACg//////+gAAAAAAAAABDk//////////8A/////////0wAAAAAAAAAYP////////9gAAAAAAAAAEz//////////wD///////+oAAAAAAAAACz0//////////QsAAAAAAAAAKT/////////AP//////7BQAAAAAAAAM1P///////////9QMAAAAAAAAFOz///////8A//////9UAAAAAAAAAKD//////////////6AAAAAAAAAAVP///////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'Y' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP///////1QAAAAAAAAAAGj//////////2gAAAAAAAAAAFT///////8A////////5BAAAAAAAAAAAMT////////EAAAAAAAAAAAQ5P///////wD/////////mAAAAAAAAAAAKPj/////+CgAAAAAAAAAAJj/////////AP//////////PAAAAAAAAAAAgP////+AAAAAAAAAAAA8//////////8A///////////YCAAAAAAAAAAE2P//2AQAAAAAAAAACNj//////////wD///////////+AAAAAAAAAAAA4//84AAAAAAAAAACA////////////AP////////////woAAAAAAAAAACUlAAAAAAAAAAAKPz///////////8A/////////////8gAAAAAAAAAABAQAAAAAAAAAADI/////////////wD//////////////2wAAAAAAAAAAAAAAAAAAAAAbP//////////////AP//////////////8BwAAAAAAAAAAAAAAAAAABzw//////////////8A////////////////tAAAAAAAAAAAAAAAAAAAtP///////////////wD/////////////////VAAAAAAAAAAAAAAAAFT//////!
 ///////////AP/////////////////oEAAAAAAAAAAAAAAQ6P////////////////8A//////////////////+cAAAAAAAAAAAAAJz//////////////////wD///////////////////9AAAAAAAAAAABA////////////////////AP///////////////////9gAAAAAAAAAANj///////////////////8A/////////////////////wAAAAAAAAAA/////////////////////wD/////////////////////AAAAAAAAAAD/////////////////////AP////////////////////8AAAAAAAAAAP////////////////////8A/////////////////////wAAAAAAAAAA/////////////////////wD/////////////////////AAAAAAAAAAD/////////////////////AP////////////////////8AAAAAAAAAAP////////////////////8A/////////////////////wAAAAAAAAAA/////////////////////wD/////////////////////AAAAAAAAAAD/////////////////////AP////////////////////8AAAAAAAAAAP////////////////////8A/////////////////////wAAAAAAAAAA/////////////////////wD/////////////////////AAAAAAAAAAD/////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-			'Z' => array(
-				'data' => 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAQ//////////////8A/////////////////////////1AAAAAAAAAABLz//////////////wD///////////////////////98AAAAAAAAAACY////////////////AP//////////////////////pAAAAAAAAAAAaP////////////////8A/////////////////////8QIAAAAAAAAAET8/////////////////wD////////////////////gGAAAAAAAAAAo9P///////!
 ///////////AP//////////////////9CwAAAAAAAAAFNz///////////////////8A//////////////////xMAAAAAAAAAATA/////////////////////wD/////////////////eAAAAAAAAAAAnP//////////////////////AP///////////////5wAAAAAAAAAAHT///////////////////////8A///////////////ABAAAAAAAAABM/P///////////////////////wD/////////////3BQAAAAAAAAALPT/////////////////////////AP////////////QoAAAAAAAAABjg//////////////////////////8A///////////8SAAAAAAAAAAExP///////////////////////////wD//////////2wAAAAAAAAAAKD/////////////////////////////AP////////+YAAAAAAAAAAB8//////////////////////////////8A/////////wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' => 40
-			), 
-		);
-
-		return $_png;
-	}
-
-	// These define base64_encoded raw png image data used
-	// when we cannot generate our own single png image
-	function define_raw_pngs()
-	{
-		$_png = array(
-			'0' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QKCNGXKO6AAAAB3RJTUUH0wUOEDQ6EUG1VwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAXNJREFUeNpj/M9AHGAiUt2wVvhyaqAqKyOjpG3jQwaGv+e+IUn9RwJfSjjg4iwFP1aKJD6HyyErfGGAYrquIoP5E2wK/zigu0v5wH9sChdgeKDqP1aFGhBZmxv/z0Dd4IxV4RWIpMQHIPuJAITzAqEQETx7IFQIP5CQNoJwDmALxzMQCuyjg1chnBPYwtECwr8AZN41h0p6YHOjAkTuwf//77wYuCEcFWwKOWA2fM1iZuuHcASwKYQ55c9ENuasrxgRjKlwJS+D17v/hBUeUGYwv/sfn0IRiJQZJIbxuFEFagjvSlDUQNgK2GIGqpC1JRhIfoAqxBYz0DRhn8IMJO+giKEqhMaMJBeI3AHhIKdkRPqG8DlAifqFADyasKRHO6h1Z/6fMYEwTbCmx3cWGCl8CTaFwBhGz+M2/7EpXMvOnBmIok7jBVaFz/Mi3/1pQORrhpgPyOr+M8IL0j9/gKpeLjhy5QEwoDVsYuRR3cE4IktcAJNx8cJaZBeQAAAAAElFTkSuQmCC', 
-			'1' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMi//xxVKAAAAB3RJTUUH0wUOEDYLcqnX7wAAAAlwSFlzAAALEgAACxIB0t1+/AAAAHpJREFUeNpj/M9AHGAiUh1WhR8FGUGAsMKaD9iM/I8BlmCVwVS4hoUohT8qcNiFyv2zQIWBCIV3amRwu54RKcDRAgQ1KigIcJYK7CqR3QsCFmf+Y8qgeQakbANMAz6FKjUXECbj8zWa76nm61GFw1UhI10KqVGFNFQIADdK9Zj7PsV9AAAAAElFTkSuQmCC', 
-			'2' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMwPUBEjoAAAAB3RJTUUH0wUOEDUqFe2UcgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAQxJREFUeNpj/M9AHGAiUt2owkGrkAWF93LFgStPfjCwyGiYRGijqfyPAH9aOJAkQl78RwbICkNQjdB4gUNhD7qzLLAr/CKA4YENSAoRvl7zAUJXvPmxhgfCXILVMxEQvg+IDVUhgtVqDYjkDhD7B2aQIMIx5cOTN29evLAAsaEKObBajQzmQOQMcIQjHLwQgSisIaDwBdS5LHfwK7yhAHVVyX+8CrdAA5HB5gdehQ3Yoxpd4ZcAmDqbD//xKISEIjhU//zHoxDmXQaeFRhOZ8CmzuDOf3wKf8DsDfnyH6/CHJi6P//xKjyDJethVehBpMI7DPgVwrPCCgb8AK5wDwGFcNMF8EkCASOx1QcAGUxu1untnFIAAAAASUVORK5CYII=', 
-			'3' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMxBQugk2AAAAB3RJTUUH0wUOEDU3duv4qwAAAAlwSFlzAAALEgAACxIB0t1+/AAAATdJREFUeNpj/M9AHGAiUt0IVciCzPm7ZceZB28YGBQkLHwcmNFU/keANRJI4ioH/qMAJIUlaHatwaFwBrqrOO5gVfiCB8P9KVgVVkAtnPDh/wkLCFsGq0IFiGQLiH0D06P/GWHJ7O+NOzfuXLlzQRrEhgSawHscwYPurxAcwQMBf/4/aIAYyHIGr8IEeDhO+Y9XoQNUncwOVHGMRPEDSovc+IkzrpGDCQgUbuC1WgBhhsIHfAp3vPn/oIIFKfRxKQSDGohCA4IKX0DTD7YoRAWMUJ9iyQpbn4DBBWUQ5yFEDDnFw622gXAzwBxoYvfB5sYlUI0lD/4/gWWKJdgU/tHAcKjCD6y+PsGCpo4FJbaRgmcNqkqWCThTzxkTJHXo+Ro1HA9uOPHiATDlKJj4eKCVFIzDqWgGAK7GW/haPS+zAAAAAElFTkSuQmCC', 
-			'4' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMyqWttCEAAAAB3RJTUUH0wUOEDUxn4hdngAAAAlwSFlzAAALEgAACxIB0t1+/AAAAKBJREFUeNpj/M9AHGAiUh2FCucyQgCK4H9McIAFixwWhQ8kGIhS+MWAgTiFIQzEKWxhIE7hFgbiFF7hASkQIajwjQpInuUAIYV/XMDyU/4TUlgAlk75T0jhArCszR9CCk+AY07mxX8CCp+AY47nzH8CCn+YgOWW/CekMAYsVfMfl0JGmCBq4kNEDp2zAn0UMmItABjRvDykPTO43DgyFQIANP6pTFLWAdoAAAAASUVORK5CYII=', 
-			'5' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMzPy3XhEAAAAB3RJTUUH0wUOEDUk8lW5dQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAQpJREFUeNpj/M9AHGAiUt2oQuIVfmREBzgU3iHWxAfEKiTaRFpZnfAfAbAr/AsxUYagiVCbeQgqhPpFYmukLCOrZupRNJUIB02BCAjAZCK+/Ed2LoJZgm6bzRfsCgMw3JWAXaEBpg8uIGSRPPMBQmXc+P+iggXCnoOQZUQK1K8PgEAjGcQs7QGL6FzG5mtkcAUiyYIQYcRRUkDTLEIWR1b4ixamQMPhrKUP3rx48eDNFXmwdyFiOthixgXqaTAnBcKpwRaOS6A6Mx78fwBVx/IAm8I/KsTGzAkWNHUyb7Ar/L8GNSlK3MCRev7/v+CApC7kBUoUoAX4yQ0nHjwAWqpiE6GNFgNDoAwHAKC2Q2lMNcCmAAAAAElFTkSuQmCC', 
-			'6' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QNAObRd4vAAAAB3RJTUUH0wUOEDUc2lcB6wAAAAlwSFlzAAALEgAACxIB0t1+/AAAATtJREFUeNpj/M9AHGAiUh2Gwq2puryMjKKmmSfRVf5HBkcMEBI+L1CkUBROYUE2QuMFLoVr0CzzwKHwhQC6szZgV1gAtfHI/xs2mEYywsPxp8QHEMVxQ56B4aaJiIKIiIRCPDZf74DwI/5jB4hwPAChbAgG+BWoExlOxkoysuqW3sUV4BoQ/p0SqARLB44AF4HIByDMKMCuEIu7phCrUOADNl/DgMOJ/09SIMwPC7B5hgfC1/kB4kRAOC7YrFaByM0Ac85AOCLYrFaBhSMIQNPlG2wBDg3HP2CSGU/MuEAoiKVXUWxB9cwPiG8UwEGSg5FCMNOjwZ4/byqgpqwgMoWr/MGeZ1agqWPZgSNz/Z+AqnDCf1wK/29B8qbKDhQpRtTE8HfLjjMP3jDwKJh4hKCGJSPNC6lRhTRWCABWpdoxd/bZ4QAAAABJRU5ErkJggg==', 
-			'7' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QNA18/fMoAAAAB3RJTUUH0wUOEDUVo4u5TwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAM9JREFUeNpj/M9AHGAiUt2oQnorZIGzGLFJIyJ40HqGhUiFPFuQ/YUFPBGBmLcDSQybwj8OEDOW/CegsAeiruQ/AYV3OMDqTP4QUugCceCN/wQUQn1a8Z+Awj8qYHUiHwgpXAAxcMJ/Qgp1wOoEPhBSuANiYM5/QgpjIAovEFL4gweszgAz0NASxZ4vYMqHYDKDBiIWhWhWa0CS1x9CVn+8AaYsmAlZfQRC6RDMChADGTQIKjxDrMI7EEoBi0JGlMJe8AOY+sFOSCEeQHQBAABCZ7xyT9fJhwAAAABJRU5ErkJggg==', 
-			'8' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QNBeBnwpSAAAAB3RJTUUH0wUOEDUOKe5wowAAAAlwSFlzAAALEgAACxIB0t1+/AAAATVJREFUeNpj/M9AHGAiUt1AKmRB459cc+DBGwYWGQ2LEG1Umf/I4IELkozLA2QpFIUXJFDMEDiBQ+EHGTR3yHzArrAFwwct2BXqQGQ1zvw/owFh6mBXCDXmDJB5BsOrjEhxzfoHIgkiGCGB9xtrgEPtOwvEV6FWY4+ZAAgVc5LhZgKEGYI9wN+gBiPu4Pl/BFWlxA1cMfN/C0rUr8AVhX8K0KyuwaEwASNmarAqPACVTXnw/0oENBFewKYQGhYZYE4MVBM2hVAvQ1LhHQhHBVsUMjIgYhCdhy3PPASTd6GOxBYz0KhOQHajDjY3pkC1Rlz5fweqjqEAm8ILGK5gYLlDZICXYI+ZLzZo6gL+4EgUfyo4kJQJtCCpQ8kKQPB2zZ47L14AU5iMgUMAN7IM43AqHwdQIQAhMPz6Gz5V/wAAAABJRU5ErkJggg==', 
-			'9' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QNCQ+T2tEAAAAB3RJTUUH0wUOEDUHUDLIBwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAUZJREFUeNpj/M9AHGAiUh26wr9rE3V5GRlFTTM3/kVT+R8Z7FBBSKjsQJFCUTiFBcWMCbgUHmBBs20FdoV/VNDUMQi8wapwDVS65s2fPToQZgFWhRFIkm8kwGyeH9gUQm2+Aua0QDhb4LJI4XgHQmmDSRMIZw+emIEENAeEcwObQhEIdQHiABRbUGPGBSIQAWL/gHqbB5tnJkC1Fjz5f8IGwxwkhR8EsCQarFE4hViF/wsQCgKgHsSu8H8HLFkUQL2rgUPh/zslOiwMEjFH/kND2geXQvQgqMAWhSjgAIRygAswIuXCpXfevHjz4M0ZdQaGhxo/wAnyBTuWmPnvARGxuPH/iAa+9Ph/A7r9Ai+wK/zvg6ZwzX8cCl9oICtjmfIfl8L/bwIQ6gyO/Met8P//EwUmwHTJo5OyBU2CkdaF1KhCWisEAM/sJxmZkdWnAAAAAElFTkSuQmCC', 
-			'A' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QFwy1U7TfAAAAB3RJTUUH0wUOEC0ZKCZtPQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAO1JREFUeNrt1LERwiAUBuAHZ2GRwsIypQMwQEZwgBQpM4QDZBSLFI7gCA5gQWGRdA5gkTuMSh48eMTUnq96wH98B+QiDCwruTD3D76qF676ueAp0Y9lSBXeSkFWaLAje3T+kkzK4SgpBzZw8pqxJWcdOJuRsyGPbWDk0tS20zw9SXsobdfytJVXdzNsP61i6Zt3K7Ht0UeUgbPdjsrOXMd+2IS2C2qb271HVWi7YANcNXFQsUEVBTXwNdl46jYRxPl52dnwRUZbhkLSDmS8DnxFRWiULxg8UxvobefuRR8ZQYDKtffVVcQWv/RrfgJC4bd0upw4MQAAAABJRU5ErkJggg==', 
-			'B' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGAusrz2zAAAAB3RJTUUH0wUOEC01Gv4B3gAAAAlwSFlzAAALEgAACxIB0t1+/AAAANJJREFUeNpj/M9AHGAiUh0tFTKiAUHL2rsoKv9DARZDWFr+IwA+hQwMFcQqZDhCrMIIYhWK4FYIYv8444PuV+wK//9/A+UJwBUSCHAL3OEIsdoFyttCpGdiiAtHjoY/RCnk6PlBbBRKrCE6CqcQq5DlDs5whIT3CgUI788EvOEIBCegXB2YPCNMBSNMISqf5TeUjysK90LpP/itfrFEAhZCMHkWdKMYUbk2MAah7BqD02pUYEFkgMu8IE6hD0IdpmegwSejoKLjoY7syaFU7A0HhQA2e4cJytImvAAAAABJRU5ErkJggg==', 
-			'C' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGBbPqVFqAAAAB3RJTUUH0wUOEC4BEGemqAAAAAlwSFlzAAALEgAACxIB0t1+/AAAASlJREFUeNpj/M9AHGAiUt2owkGrkAWV+3TDgRtPPjBwyGiYBOijSv1HAlcCkGUcTiDLISvsQDOeZQp2hQWYDpuCTeEEbD44ganwDgc2vxpgKoyAyUWc+f9hjgCMtwFd4RuYRxog/ueBcl3QFc6BSmj8gfBrwE40yFmCrjABqrAH5mSZgJ4jX7AEjwlU4Zn/OAAsrp9AaRlccc0IzdeMsBilOPWQrBDmtpfEKnwBpZ8qZq58i6IS6vscKHcBcgQYlOz4gh6OK6AKfaB8G5hN6Aq/wBLPHjB3CczCFIzUA0u2PD0v/j9pgaf1ExgK3wgwYAEOWFL4GizqWC5gyzM1mArnEJkLZ2DPhf//n3BAVmeDkq8ZUZPL3TUn7gBLCgYFBYsAcxQZRmKrDwABNsv9SJSDwwAAAABJRU5ErkJggg==', 
-			'D' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGC1+orhOAAAAB3RJTUUH0wUOEC4yr7fHvgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAM9JREFUeNpj/M9AHGAiUt1AKmSBsxiRhXlkNBxCpFFU/ocBTDMyPvxHADwKGRgUbhCpkEHiCZEKGRyIVciwArdCIPPFGg8YzwSvQiBogXFvEFD43wDKnQDl44yZGCh9glAU2sCsJqRQBkq/gMUw3G2wuP6PnU/H9PgRSgsQUvgESosQUngFSqsQUrgCSsNiCFcU7oBx9+CL6w8XamB5SeUPkelxAZEJ1+YPcQolXhCXFTTuEJULOUq+IOVrFgasQELBxMaHG1mEcTiVjwOoEADAIkCnGpmJKgAAAABJRU5ErkJggg==', 
-			'E' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGDeDwEE0AAAAB3RJTUUH0wUOEC8CkHXGUwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAD5JREFUeNpj/M9AHGAiUt2owkGrkAXGYMQqjUgJQ8EzpPsa05+D140oMYTk4KEQ4MMqZqgUhcM1czESW30AABfqB1XDnLzcAAAAAElFTkSuQmCC', 
-			'F' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGQe8AkDZAAAAB3RJTUUH0wUOEC8JB6cf2wAAAAlwSFlzAAALEgAACxIB0t1+/AAAADlJREFUeNpj/M9AHGAiUt3wUsiCYDJikUYE3lDwDDm+xvTp4HUjIoaQXTsUAnxYxcyoQryAcUSWuAAW/gZTg/yEMAAAAABJRU5ErkJggg==', 
-			'G' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGRFI1vWIAAAAB3RJTUUH0wUOEC8QY8y3GwAAAAlwSFlzAAALEgAACxIB0t1+/AAAASZJREFUeNpj/M9AHGAiUt0IVciCwvt7ZM+FOy8+MDBwSEho2AQII8v9R4A/U2RQtHEUfEBIIim8YYBhn8oNLAqP8GBxmcwbDIU3sKljYIhAV/jHgAE7uICmcAJMQqDmwp//D2YowPgxqAr/wPyr8QAi8EEHwleIQFW4BxYicG+eEHEomHECET5QhRVQhQn/cQFoFJ6AKgwgFNcPoFwdnAoZIXmGERahKDwkIdqlR1j4PiRW4RVCCmExvQenQrSYEXiDiAoUBfC4loAK23yBSnzArhCRehRmAJPFnRUxHDgU/lDA7zZECj/Cgl2dAkaeWYNVZcoHDIX/94hgKLM4gS27/v9QIICizGMDkiQjSon7c8eBCw+e/GFgkZEwsHCRRpZiHE5FMwCa2YE+WcAOUwAAAABJRU5ErkJggg==', 
-			'H' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGRw2Z4k1AAAAB3RJTUUH0wUOEC8agxleBQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAD1JREFUeNpj/M9AHGAiUt2oQvyABUozQml4+KMLDAXPDAWFLGh8RlwKh4JnaB88GOlxELhxVCFewDgEynAAN2sFVHAvevkAAAAASUVORK5CYII=', 
-			'I' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGSlg1E0WAAAAB3RJTUUH0wUOEC86uHd+zQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAD5JREFUeNpj/M9AHGAiUt1AKmRBMBkxJJE9OhQ8Q32FjGhxDQsjjCQwFDwzqnCwKkRKZqO5EBMwDqcSl2iFAMMeB0s/kLo2AAAAAElFTkSuQmCC', 
-			'J' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGywiiNsbAAAAB3RJTUUH0wUOEDAFw0tdbgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAKdJREFUeNpj/M9AHGAiUh3xClmwijJCaSR3Ud/qUYWjCklTyIHEhifctw8ePHgCxO+B7L9QMQlsChW+QOiX4gwMd6BiItisVoHSB6AYWQwM/kNBBszkC/9PwKyc8B8B4Ar3YPHMHWwK/xtgqAv4j1XhEfScK/EEu8L/a1BVStz4j0Ph/yPItoe8QFH3nxGlkNq75cKDB0DDVBwitNEcwjhwpdmoQrwAAN6ioiFapgUdAAAAAElFTkSuQmCC', 
-			'K' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHAEoFhGpAAAAB3RJTUUH0wUOEDANzZDVXAAAAAlwSFlzAAALEgAACxIB0t1+/AAAAPZJREFUeNpj/M9AHGAiUt2owgFSyAgFMOGDrDARxkKo0H8wYEDh/b/AAzepACqEVeEdCQx1WBW+0ICry/mPR+EXE7i6kD94FP5xwaYOi8IIrOowFRbA1Xkgq8NQ2ANXZ/PlPx6FS3CpQ1fIAmOIoKn7jxbXf2CMNxvQIxvVRAQQ+YDXaiSQQqxChiOEFGoIQGidP/gVStxogLI68CqUuPH/BzSVcTzAoxCo7v//ObBIxK0QrO7/H1iCXIFT4QkIFxbaMh9wKYQJO0D5OYQUnoDF/QkCCuHJ1+APAYV3YOloAgGF8JTO84SAwjfQiGQIgPAZqV4rAACnKSarzdlc4gAAAABJRU5ErkJggg==', 
-			'L' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHA64qQw4AAAAB3RJTUUH0wUOEDAXMPIsJgAAAAlwSFlzAAALEgAACxIB0t1+/AAAADlJREFUeNpj/M9AHGAiUt2QUMiCYDJCaezhMBQ8M6pwVCEdFLJgCjEisRH5Zyh4hvoKGUdkQUq0QgARaARRV9jUFQAAAABJRU5ErkJggg==', 
-			'M' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHBhMfblpAAAAB3RJTUUH0wUOEDAqaJpgNwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAPNJREFUeNrdlK0OgzAUhS8bCQYxMYmcmEAgEAgejQfZQyG2pAIxOYlATkAu691o2tvSYia2iv7lyzn3NG0jhG1tt5H7Aggom7ZuaKPhBFqKV+pFWDGjjcxStEAYXuvBkrKtoVX+gdRiK9i6sxjgeVGUMJzWwZLACaZOTqoAOAronmrlBuvPkQsIgHn8BqnE2AMmhaaYJ57jqTRFMwsDyW249XaJLhAujizm7UFM5XCUXTqiTvBLQYWRc7H3WWt+3NmlyGbOGh9q/45mjQxUb+CA6A2jSqu5MweX0ooQWLJxLYx6fz0GwmBOsww5GP3At/dX4Ayb7qpFI9y5ygAAAABJRU5ErkJggg==', 
-			'N' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHC6DxyzwAAAAB3RJTUUH0wUOEDAye/b4YQAAAAlwSFlzAAALEgAACxIB0t1+/AAAALRJREFUeNpj/M9AHGAiUt0IV8gIARsRMlAROP8/BEB5Ii/+/0cVgXNRhRk8iFXIMIFYhRxXiFTIYPCDSIUMBcQqZNhDrEKZN0QqZAggViHDHIIKRSAUzx1CCrdAaZM/BBT+z4Eyaggp/KEDYbAcIaDw/wUWCEuBkML/PagBgFvhfxdiFT4RIVLh/zXEKvyfQqzCLypEKvx/hoVIhf9biFX4x4ZIhf8fCBCp8P8KNBHG4VQ0AwDEOyeZhO5p1AAAAABJRU5ErkJggg==', 
-			'O' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHQExDSDoAAAAB3RJTUUH0wUOEDA4myMRfwAAAAlwSFlzAAALEgAACxIB0t1+/AAAATtJREFUeNpj/M9AHGAiUt3wUsiCyv265ciZJ08YGGRkDGwCuFGk/iOBDwU8SDIcGS+Q5JAV7hBBs45nAVaFC1gwXTYBi8IdWNQxMCzAUPhBBJs6Bp4n6AoLYFI6az78f7NEB8ZNQFP4QwAqEfADwg+A+f0NqsI1UHGBDzCnSKC6EhYzB6B0Cj+UwZ+CKgNTeAZKu8C94QGlL6DGjAyU+wAeXC+gIiIQLiM0KzDC9CFCBlWICsnsL3aFMDc+hcs8QZWBKYSF2g24whvYFZpA6T1whUegNCwyoYGxAmYyLGZ+wOxYghqFX2BpO+APmP8nBspHj2uk1LPizf8PGyxgXPTUQ3x6JDqF//8/AYs6bHkGmCYF0O3FnguBCSaFA0kZS8IDJDlG1IIUVFK8eABMWzI6DgHCyDKMI7LEBQCD5YgI9wbKGgAAAABJRU5ErkJggg==', 
-			'P' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHQvR2Mn2AAAAB3RJTUUH0wUOEDEDMzPJGgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAKVJREFUeNpj/M9AHGAiUh05ChlRAKdu4k5Ulf9hANMQiwf/EQCfQgaJB0QqZHAhViHDEbg0AV8vwRM8QN0v5vBAOSfw+BrMWQDl8MClGeEKGGEKQcRXHmQemTGD1RMy+N14o4MDyvGAS7NgGMaIzPHAYyIy4HhBZMy0EBmFIX+IUsjRgqQOi2fAgEVBwyVGGEUEQw2O3EbLzDWSFDIOhtJsVCEWAAC/Yt2X+2PYcgAAAABJRU5ErkJggg==', 
-			'Q' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHRxSC0wxAAAAB3RJTUUH0wUOEDEKSu9xvgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAW1JREFUeNpj/M9AHGAiUt2QUMiCzPm65cCZF08YGGRkDBx8uNFU/oeDDwU8SOIcBS/+IwOEwh0iaEYIrMCqcA4LprsmYFG4A4s6BoYFGAo/iGBTx8DzAl1hAUxKZ8WH/29W6MC4KWgKfwhAJXx+gPl/QmB+/4KqcANUXOQDVPiLBFRkCUwhJGb2wGzihzK4U6CMA6hReAbKc4F7wwFKX0CNGRkoB+HJJ1ARGZgAIziFM8J0IUIGXYjMZPaXkEJYYDyBiz+EuRFVoQKUdwWIz6qWvmRguAMVkUBVaIIUalPu9GgshIefAWrwrIHp//L/DQc4KjFiBi2uQ/7832KB5AX0uP5fAZOx2PDhfwNCIXrq+f9BhgEb4HmCkcL3YE3hSHkBnmfWYFMpsoaYXAgGDgcwFKLlaxYOCG2DqRCYrldkmIACUMIgZsaTI5Cg3IBNISp4AoovlT+EFf7/kYPkb3wK//8/YAGPGcYhUIYDAHBC9Yak1w7iAAAAAElFTkSuQmCC', 
-			'R' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHSkEuIgSAAAAB3RJTUUH0wUOEDEUsOBM3QAAAAlwSFlzAAALEgAACxIB0t1+/AAAAOZJREFUeNpj/M9AHGAiUh0NFLJAaUY0YRkJHYcQdmSh/xCAzRCZHf8RAJ9CBpYNRCpkEHgBV4jfMx+mEOVGIDDAaTWY82aPBZTLgV8hUCkaH6cbP8B8gxHgyODjgwstMDfiVIgWQyFE+lrhB3EBznOFuJgxuUFMXPPEbPmDpA53FH55osKMIoAe4F826MDMvPMfj9WgWFGBBeIf/Ar/H4FxJhBQ+B8WzCIfCCi8A4uvBgIK/2fA/POCgMIXHFBuDqH02ABLM3cIKPwgAuVHEFD4fwJM4AIBhT9goe4AFWAcAsXesFIIAEvJyZHTCSiTAAAAAElFTkSuQmCC', 
-			'S' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHTRnvuTLAAAAB3RJTUUH0wUOEDEbIF9RTAAAAAlwSFlzAAALEgAACxIB0t1+/AAAAVZJREFUeNpj/M9AHGAiUt2oQvyABYX398CWK3de/GBgkVEw8HFgRpH7jwSWqCDLyCxAlkNS+CcG3boY7AozMB3Wgk3hGSw+4HgBl0b4egIWhT9mYPGMBFQg4MH/D2tgvrKASzPC0yMjlP7CDSTOmrDIMDDwiHBsxzSRBypw5j9WgFDoAPNAxIQjX/ApXIDsC4OCLV9wKfzjwIACOEIO4IiZFxbooePzAqvC/z9qONBUStzAqvD//zc9BqgqNX5gVwgETxbkmCClvSk4FYLdsCMCptAGI2YSGV78+PLmz5MX4mDu1ByIMM9n9JiBxe4caGChy8MZMMsUIEFyAMoVwVC4BGaEwpI3/9/MEYGlJQyFPwQYsIE1mL7GlnCR0iNSXLtgqpO4gy1mvtigq1NAxCBKgP9pEUFWxlOCnNIYUYrmn3v23Ljx5gsw88sYOPhwI0sxDoEyHAABtSc836a1EQAAAABJRU5ErkJggg==', 
-			'T' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHgUdTbcyAAAAB3RJTUUH0wUOEDEgkVS4aAAAAAlwSFlzAAALEgAACxIB0t1+/AAAADdJREFUeNpj/M9AHGAiUt0IVcgCpRlxyMODeSh4hmiFjGipB+Z7jEQ1FDwzqnBU4WBSyDicimYAb/AFTaJpyH8AAAAASUVORK5CYII=', 
-			'U' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHhEHl2NPAAAAB3RJTUUH0wUOEDEon48wWgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAKlJREFUeNpj/M9AHGAiUh3xClmgNCOUhrsEXYD6Vo8qHFVIuUIVKP0USr+E0jLoCjWg9A4ovQVNHJjUIaADZsILMPeFApRfA5X/D1N4AaZRYc6b/2+WwNQxXEBX+N8Bqxcc/mMoPMGCRR3LBUyF/2dgUTjjPxaF/6egm8ky5T9Whf9P2KCoMziBJPefEaWQurjnzIMXL34wsMhoWHiYo2hjHLjSbFQhXgAAKzejCLAOcVMAAAAASUVORK5CYII=', 
-			'V' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHh/gL05IAAAAB3RJTUUH0wUOEDEuduyVbwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAVNJREFUeNpj/M9AHGAiUt2owoFRaMgIAYlIMqlQMUMo/z8ITIByRP78hwMRqNgECBei8AULVPQIXN0RqAjLGwgfYrW4B1R4DdzmLVDaQxjZ6v8roDwVuIkqMK3/ka3+/0MAKn4FKn4D5uof/5GtZmCPgEpsQHNDBDsDitVwt5tA+RZQ/pn/qFYj3PQEzHsC5WnA3QyPmQQU3+5AE0VYDTfDBcxzgQbik/8YVv93gMp9AbK/cEAD8T+m1TBb/oD8veEHhs0IE2GmxADZMRAmz4//WKxGkv3DA2Gm/MeqcA/Ujj1w1hHsCv/LQKQz/megRzyawgqIvAxMRwsuhbCEAEvGT3AphEUwNCU5IEv9R8lcUH9/wAxE5HAEgjccSBI8X3CbKOyBxAnhxm3i/w1IEgdQZFA98/+PCFydDKo6VKsZmGPQ0wgOq/+fgYvfQTORkeq1AgCIAvD7+THsDgAAAABJRU5ErkJggg==', 
-			'W' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QFhZRKnzkAAAAB3RJTUUH0wUOEDIR66frkQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAXNJREFUeNrtlK1ywkAUhZdMZsJMKyIqKhAIBAKBiEBEVCDyCJV9iIo+Do9QGRERgUBEVCAqKhAIREVERURnTvfn3t27xSA6g+kOQ/ZkP/aec5NlBHXZSC7k/sE/AhUwoVkDPQ58/2RUQ2IC6B1XpN7MV8tg62/pUdjSDO7OwR2J0pbekpqZYlMG50bNSGwBDQ4pyV5YtCZ7mqZf1mO2IN2Jynba0XRx49pThjQCbEKWFfVRpIlBzlK4PuLdpxEWlTr4LHvYMEDOaTYS3HCW3DAJt8mmaSXYchZbOfEzkyYGZRbrEbX8qe7GMpLqFeyxV9F4fon1pwcxjxbqJpJTBPBJLoyHYSz1I3xq78aOMssepHZZHFjKhbX9/AZd6e9bsdABeyHTQXiE2PLO6PugCwiP/r1QVLYSlpXwKE1Wno7b7jY+hoWj0aegPyA9+jPrzgqwZJ0j8hhMVtElmDoD19FFPAvamc+sOXBm+KdYEzC63p/9D7Tr72kj/8qjAAAAAElFTkSuQmCC', 
-			'X' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHi/G9n7kAAAAB3RJTUUH0wUOEDIXAsROpAAAAAlwSFlzAAALEgAACxIB0t1+/AAAAT9JREFUeNpj/M9AHGAiUt3IVhjKCAFr4RJroSKBMIH/YPBEAMITeQLh//8gAxHggQlAFf6fAdXnA+WnQPkT/qMp/O8AlVkA5h2A8kz+YCi8wQGREngA5PxQgXBYzvzHUPi/A2qIA5BdAmUX/Mei8I8BVHbK/wssEJbMB2wK/5+ASvPcgGlZ8x+rQriFAmghgKHwiwJKXPA8wKXw/x4UhT3/cSr8n4CkzuAPHoVvRODqWE6gyPxHTT1ffiAUCjCgAhRtDkgSFnisnoJixAScCh/wEBk8DmiucsChcA5MQQSMMQWrQlgiZ0iAByey5QiFPlBZnS//v+hgxjZc4QKYKVeAnCswby3AUAi3eAGKNoEn6Ap94A5EjXUfNIUrEA6EALgzl6AohCUGsAMhAOZMkTfICkMw3I5wZgiEyzicimYAFRFkVwgDfJ0AAAAASUVORK5CYII=', 
-			'Y' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHjkyIsu1AAAAB3RJTUUH0wUOEDIkvRQvsgAAAAlwSFlzAAALEgAACxIB0t1+/AAAANJJREFUeNrt1L0NgzAQBWAcUVB6AAZgBAoKhmAICoZgCAoKxmAECkbwABSUlBRILwF8duwYhFJEihJ37+6T5T9g8K6N20X3FdDDNjKKOeTIqZLtWcKBU73bCx1lPhgQNTWieY1zRLmGCZFQp1xTSSmBDUUgW754BF+GQLxAPUkMxMb0FlzUsqpKLXhxQPRqo+oIerggCvuMC7jhFJounA4gWhO2OIL6Jp/uzglHrh0fTyAaDRucQaTkUpxDQVBYDWZ/hYze6bsv/A8/DNlP/kgvwzuer4kCMGPZDgAAAABJRU5ErkJggg==', 
-			'Z' => 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHwfqWOdfAAAAB3RJTUUH0wUOEDIrLasyIwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAL5JREFUeNrl1C0OwkAQBWCWQIJEVPQIFT0GAlHBMRBIBKIHqahAIDlERY9R0UOs3ORh5qVLunmp5GfUZvczbzKzDqtltV7ofgtueHCp16h33xBGwn0KYqoTO/J868Csaj418e0cPujOkLDfmTsECcfcXOGhoC/NZQMUDBUDd5DwxiAtJGzprpCw48xVQcIhM1d6KOgLc/kIBcORgXtIeGGQOyRs6Oq0g7P92YbkRE7bRZhcwhh+6nLF5f7yx30B8Z7FgxzMWtEAAAAASUVORK5CYII=', 
-		);
-
-		return $_png;
-	}
-}
-
-?>
\ No newline at end of file

Modified: trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -20,19 +20,30 @@
 		$_CLASS['core_user']->add_lang('groups');
 
 		$submit	= !empty($_POST['submit']);
-		$group_ids = array_map('intval', request_var('mark', array(0)));
 
-		if ($submit)
+		if (is_array($_POST['group_id']))
 		{
+			$group_id = array_map('intval', get_variable('group_id', 'REQUEST', false, 'array'));
+		}
+		elseif 
+		{
+			if ($group_id = get_variable('group_id', 'REQUEST', false, 'interger'))
+			{
+				$group_id = array($group_id);
+			}
+		}
+	
+
+		if ($submit && !empty($group_id))
+		{
 			require_once($site_file_root.'includes/functions_user.php');
 
 			switch ($_POST['mode'])
 			{
 				case 'resign':
-					
 					$sql = 'SELECT group_id	FROM  ' . GROUPS_TABLE . '
 								WHERE group_type = ' . GROUP_SPECIAL .'
-								AND group_id IN ('. implode(', ', $group_ids) .')';
+								AND group_id IN ('. implode(', ', $group_id) .')';
 					$result = $_CLASS['core_db']->query($sql);
 
 					$special = array();
@@ -42,14 +53,30 @@
 					}
 					$_CLASS['core_db']->free_result($result);
 
-					$group_ids = array_diff($group_ids, $special);
+					$group_id = array_diff($group_id, $special);
 					unset($special);
 
-					groups_user_remove($group_ids, $_CLASS['core_user']->data['user_id']);
+					groups_user_remove($group_id, $_CLASS['core_user']->data['user_id']);
 				break;
 
 				case 'apply':
-					
+					$sql = 'SELECT group_id, group_status, group_type FROM  ' . GROUPS_TABLE . '
+								WHERE group_type IN (' . GROUP_REQUEST .', ' . GROUP_UNRESTRAINED .')
+								AND group_id IN ('. implode(', ', $group_id) .')';
+					$result = $_CLASS['core_db']->query($sql);
+
+					$group_id = array()
+
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						if ($row['user_id'] == STATUS_ACTIVE)
+						{
+							$group_id[] = $row['user_id'];
+						}
+					}
+					$_CLASS['core_db']->free_result($result);
+
+					groups_user_remove($group_ids, $_CLASS['core_user']->data['user_id']);
 				break;		
 			}
 		}
@@ -66,14 +93,15 @@
 		$group_id_ary = array();
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
+			$row['group_status'] = STATUS_ACTIVE;
+
 			$block = ($row['user_status'] == STATUS_LEADER) ? 'leader' : (($row['user_status'] == STATUS_PENDING) ? 'pending' : 'member');
 
 			$_CLASS['core_template']->assign_vars_array($block, array(
 				'GROUP_ID'			=> $row['group_id'],
-				'GROUP_NAME'		=> ($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
-				'GROUP_DESC'		=> ($row['group_type'] <> GROUP_SPECIAL) ? $row['group_description'] : $_CLASS['core_user']->lang['GROUP_IS_SPECIAL'],
-				'GROUP_SPECIAL'		=> ($row['group_type'] <> GROUP_SPECIAL) ? false : true,
-
+				'GROUP_NAME'		=> isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
+				'GROUP_DESC'		=> $row['group_description'],
+				'GROUP_RESIGN'		=> ($row['group_type'] != GROUP_SYSTEM || ($row['group_type'] == GROUP_SPECIAL && $row['user_status'] == STATUS_PENDING),
 				'U_VIEW_GROUP'		=> generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']),
 				'S_GROUP_DEFAULT'	=> ($row['group_id'] == $_CLASS['core_user']->data['group_id']) ? true : false
 			));
@@ -83,7 +111,7 @@
 		$_CLASS['core_db']->free_result($result);
 
 		// Hide hidden groups unless user is an admin with group privileges
-		$sql_and = ($_CLASS['auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? '<> ' . GROUP_SPECIAL : 'NOT IN (' . GROUP_SPECIAL . ', ' . GROUP_HIDDEN . ')';
+		$sql_and = ($_CLASS['auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? '<> ' . GROUP_SYSTEM : 'NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
 
 		$sql = 'SELECT group_id, group_name, group_description, group_type
 			FROM ' . GROUPS_TABLE . '
@@ -94,13 +122,13 @@
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
+			$row['group_status'] = STATUS_ACTIVE;
+
 			$_CLASS['core_template']->assign_vars_array('nonmember', array(
 				'GROUP_ID'		=> $row['group_id'],
-				'GROUP_NAME'	=> ($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
+				'GROUP_NAME'	=> isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
 				'GROUP_DESC'	=> $row['group_description'],
-				'GROUP_SPECIAL'	=> ($row['group_type'] == GROUP_SPECIAL),
-				'GROUP_CLOSED'	=> ($row['group_type'] <> GROUP_CLOSED || $_CLASS['auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? false : true,
-
+				'GROUP_APPLY'	=> ($row['group_type'] != GROUP_SYSTEM && $row['group_status'] == STATUS_ACTIVE),
 				'U_VIEW_GROUP'	=> generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id'])
 			));
 		}

Modified: trunk/modules/Control_Panel/ucp/ucp_main.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_main.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_main.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -17,13 +17,15 @@
 	{
 		global $config, $_CLASS, $site_file_root, $_CORE_CONFIG;
 
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'ERROR' 		=> false,
 			'topicrow'		=> false,
 			'WARNINGS'		=> false,
-			'draftrow'		=> false)
-		);
+			'draftrow'		=> false
+		));
+
 		$_CLASS['core_user']->user_setup();
+
 		switch ($mode)
 		{
 			case 'front':
@@ -44,7 +46,7 @@
 						$_CLASS['core_db']->free_result($result);
 					}
 
-					$sql_from = TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
+					$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
 					$sql_select = ', tt.mark_time';
 
 				}
@@ -54,8 +56,6 @@
 					$sql_select = '';
 				}
 
-				$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
-		
 				// Has to be in while loop if we not only check forum id 0
 				if ($config['load_db_lastread'])
 				{
@@ -63,6 +63,7 @@
 				}
 				else
 				{
+					$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
 					$forum_check = (isset($tracking_topics[0][0])) ? base_convert($tracking_topics[0][0], 36, 10) + $config['board_startdate'] : 0;
 				}
 
@@ -158,7 +159,7 @@
 					
 					// Grab all the relevant data
 					$sql = 'SELECT COUNT(p.post_id) AS num_posts   
-						FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
 						WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
 							AND f.forum_id = p.forum_id 
 							$post_count_sql";
@@ -169,7 +170,7 @@
 					$num_real_posts = min($_CLASS['core_user']->data['user_posts'], $num_posts);
 
 					$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts   
-						FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f 
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f 
 						WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
 							AND f.forum_id = p.forum_id 
 							$post_count_sql
@@ -181,7 +182,7 @@
 					$_CLASS['core_db']->free_result($result);
 
 					$sql = 'SELECT t.topic_id, t.topic_title, COUNT(p.post_id) AS num_posts   
-						FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . ' f  
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . ' f  
 						WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
 							AND t.topic_id = p.topic_id  
 							AND f.forum_id = t.forum_id 
@@ -225,7 +226,7 @@
 				unset($active_t_row);
 
 
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'USER_COLOR'		=> (!empty($_CLASS['core_user']->data['user_colour'])) ? $_CLASS['core_user']->data['user_colour'] : '', 
 					'JOINED'			=> $_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_regdate']),
 					'VISITED'			=> (empty($_CLASS['core_user']->data['user_lastvisit'])) ? ' - ' : $_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_lastvisit']),
@@ -244,6 +245,7 @@
 
 					'U_SEARCH_USER'		=> ($_CLASS['auth']->acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($_CLASS['core_user']->data['username']) . "&amp;show_results=posts") : '',  
 					'U_ACTIVE_FORUM'	=> generate_link('Forums&amp;file=viewforum&amp;f='.$active_f_id),
+					'U_LAST_POST_AUTHOR'	=> ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['topic_last_poster_id']) : false,
 					'U_ACTIVE_TOPIC'	=> generate_link('Forums&amp;file=viewtopic&amp;t='.$active_t_id))
 				);
 
@@ -264,10 +266,11 @@
 					if ($forums || $topics)
 					{
 						$l_unwatch = '';
+
 						if ($forums)
 						{
 							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
-								WHERE forum_id IN ($forums) 
+								WHERE forum_id IN ($forums) AND topic_id = 0
 									AND user_id = " .$_CLASS['core_user']->data['user_id'];
 							$_CLASS['core_db']->query($sql);
 
@@ -276,8 +279,8 @@
 
 						if ($topics)
 						{
-							$sql = 'DELETE FROM ' . TOPICS_WATCH_TABLE . "
-								WHERE topic_id IN ($topics) 
+							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
+								WHERE topic_id IN ($topics)
 									AND user_id = " .$_CLASS['core_user']->data['user_id'];
 							$_CLASS['core_db']->query($sql);
 
@@ -293,12 +296,12 @@
 
 				if ($config['load_db_lastread'])
 				{
-					$sql_from = FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' AND ft.forum_id = f.forum_id)';
+					$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' AND ft.forum_id = f.forum_id)';
 					$lastread_select = ', ft.mark_time ';
 				}
 				else
 				{
-					$sql_from = FORUMS_TABLE . ' f ';
+					$sql_from = FORUMS_FORUMS_TABLE . ' f ';
 					$lastread_select = '';
 
 					$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
@@ -380,23 +383,19 @@
 
 				if ($topics_count)
 				{
-					$_CLASS['core_template']->assign(array(
+					$_CLASS['core_template']->assign_array(array(
 						'PAGINATION'	=> generate_pagination("Control_Panel&amp;i=$id&amp;mode=$mode", $topics_count, $config['topics_per_page'], $start),
 						'PAGE_NUMBER'	=> on_page($topics_count, $config['topics_per_page'], $start),
 						'TOTAL_TOPICS'	=> ($topics_count == 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count))
 					);
 				}
 // Fix this up
-				$sql_from = ($config['load_db_lastread'] || $config['load_db_track']) ? TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')' : TOPICS_TABLE . ' t';
-				$sql_f_tracking = ($config['load_db_lastread']) ? 'LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.forum_id = t.forum_id AND ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . '), ' : '';
-
-				$sql_t_select = ($config['load_db_lastread'] || $config['load_db_track']) ? ', tt.mark_time' : '';
-				$sql_f_select = ($config['load_db_lastread']) ? ', ft.mark_time AS forum_mark_time' : '';
-
+				$sql_from = ($config['load_db_lastread']) ? FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')' : TOPICS_TABLE . ' t';
+				$sql_t_select = ($config['load_db_lastread']) ? ', tt.mark_time' : '';
 //
-				$sql = "SELECT t.* $sql_f_select $sql_t_select 
-					FROM $sql_from $sql_f_tracking " . FORUMS_WATCH_TABLE . ' tw
-					WHERE tw.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+				$sql = "SELECT t.* $sql_t_select 
+					FROM ". FORUMS_WATCH_TABLE . " tw, $sql_from 
+					WHERE tw.user_id = " . $_CLASS['core_user']->data['user_id'] . '
 						AND t.topic_id = tw.topic_id 
 					ORDER BY t.topic_last_post_time DESC';
 				$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
@@ -408,16 +407,13 @@
 					
 					if ($config['load_db_lastread'])
 					{
-						$mark_time_topic = $row['mark_time'];
-						$mark_time_forum = $row['forum_mark_time'];
-					}
-					else
-					{
 						$topic_id36 = base_convert($topic_id, 10, 36);
 						$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : $forum_id;
 						$mark_time_topic = (isset($tracking_topics[$forum_id36][$topic_id36])) ? base_convert($tracking_topics[$forum_id36][$topic_id36], 36, 10) + $config['board_startdate'] : 0;
 
 						$mark_time_forum = (isset($tracking_topics[$forum_id][0])) ? base_convert($tracking_topics[$forum_id][0], 36, 10) + $config['board_startdate'] : 0;
+
+						$row['mark_time'] = max($mark_time_topic, $mark_time_forum);
 					}
 
 					// Replies
@@ -430,8 +426,8 @@
 
 					// Get folder img, topic status/type related informations
 					$folder_img = $folder_alt = $topic_type = '';
-// TEMP max($mark_time_topic, $mark_time_forum)
-					$unread_topic = topic_status($row, $replies, max($mark_time_topic, $mark_time_forum), $folder_img, $folder_alt, $topic_type);
+
+					$unread_topic = topic_status($row, $replies, $row['mark_time'], $folder_img, $folder_alt, $topic_type);
 					$newest_post_img = ($unread_topic) ? '<a href="'. generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread#unread").'">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
 
 					$view_topic_url = "Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id";
@@ -443,7 +439,7 @@
 						'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 						'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
-						'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
+						'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
 						'PAGINATION' 		=> topic_generate_pagination($replies, 'Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . "&amp;t=$topic_id"),
 						'REPLIES' 			=> $replies,
 						'VIEWS' 			=> $row['topic_views'],
@@ -466,9 +462,8 @@
 					
 				}
 				$_CLASS['core_db']->free_result($result);
+			break;
 
-				break;
-
 			case 'bookmarks':
 				
 				if (!$config['allow_bookmarks'])
@@ -482,7 +477,7 @@
 				$move_up = request_var('move_up', 0);
 				$move_down = request_var('move_down', 0);
 
-				$sql = 'SELECT MAX(order_id) as max_order_id FROM ' . BOOKMARKS_TABLE . '
+				$sql = 'SELECT MAX(order_id) as max_order_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
 					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 				$result = $_CLASS['core_db']->query($sql);
 				list($max_order_id) = $_CLASS['core_db']->fetch_row_num($result);
@@ -495,7 +490,7 @@
 						$order = ($move_up) ? $move_up : $move_down;
 						$order_total = $order * 2 + (($move_up) ? -1 : 1);
 		
-						$sql = 'UPDATE ' . BOOKMARKS_TABLE . "
+						$sql = 'UPDATE ' . FORUMS_BOOKMARKS_TABLE . "
 							SET order_id = $order_total - order_id
 							WHERE order_id IN ($order, " . (($move_up) ? $order - 1 : $order + 1) . ')
 								AND user_id = ' . $_CLASS['core_user']->data['user_id'];
@@ -521,13 +516,13 @@
 
 					if (confirm_box(true))
 					{
-						$sql = 'DELETE FROM ' . BOOKMARKS_TABLE . '
+						$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . '
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 								AND topic_id IN (' . implode(', ', $topics) . ')';
 						$_CLASS['core_db']->query($sql);
 
 						// Re-Order bookmarks (possible with one query? This query massaker is not really acceptable...)
-						$sql = 'SELECT topic_id FROM ' . BOOKMARKS_TABLE . '
+						$sql = 'SELECT topic_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 							ORDER BY order_id ASC';
 						$result = $_CLASS['core_db']->query($sql);
@@ -535,7 +530,7 @@
 						$i = 1;
 						while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 						{
-							$_CLASS['core_db']->query('UPDATE ' . BOOKMARKS_TABLE . "
+							$_CLASS['core_db']->query('UPDATE ' . FORUMS_BOOKMARKS_TABLE . "
 								SET order_id = '$i'
 								WHERE topic_id = '{$row['topic_id']}'
 									AND user_id = '{$_CLASS['core_user']->data['user_id']}'");
@@ -557,9 +552,9 @@
 				// NOTE: At the moment bookmarks are not removed with topics, might be useful later (not really sure how though. :D)
 				// But since bookmarks are sensible to the user, they should not be deleted without notice.
 				$sql = 'SELECT b.order_id, b.topic_id as b_topic_id, t.*, f.forum_name
-					FROM ' . BOOKMARKS_TABLE . ' b
-						LEFT JOIN ' . TOPICS_TABLE . ' t ON b.topic_id = t.topic_id
-						LEFT JOIN ' . FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
+					FROM ' . FORUMS_BOOKMARKS_TABLE . ' b
+						LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON b.topic_id = t.topic_id
+						LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
 					WHERE b.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 					ORDER BY b.order_id ASC';
 				$result = $_CLASS['core_db']->query($sql);
@@ -568,7 +563,7 @@
 				{
 					$_CLASS['core_db']->free_result($result);
 					
-					$_CLASS['core_template']->assign(array(
+					$_CLASS['core_template']->assign_array(array(
 							'S_BOOKMARKS'			=> false,
 							'S_BOOKMARKS_DISABLED'	=> false
 					));
@@ -589,9 +584,11 @@
 					$folder_img = $folder_alt = $topic_type = '';
 					$unread_topic = topic_status($row, $replies, time(), time(), $folder_img, $folder_alt, $topic_type);
 
-					$view_topic_url = generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id");
+					$view_topic_url = "Forums&amp;file=viewtopic&amp;t=$topic_id";
 //					$last_post_img = '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=" . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '">' . $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST') . '</a>';
 
+					$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;t='.$topic_id, $replies, $config['posts_per_page'], 0);
+
 					$_CLASS['core_template']->assign_vars_array('forummarks', array(
 						'FORUM_ID' 			=> $forum_id,
 						'TOPIC_ID' 			=> $topic_id,
@@ -605,15 +602,20 @@
 						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 						'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
 						'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
-						'PAGINATION' 		=> topic_generate_pagination($replies, 'Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . "&amp;t=$topic_id"),
-				
+						'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
 
+						'PAGINATION'		=> $pagination['formated'],
+						'PAGINATION_ARRAY'	=> $pagination['array'],
+
 						'POSTED_AT'			=> $_CLASS['core_user']->format_date($row['topic_time']),
 						'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
 						'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', '') : '',
 
-						'U_VIEW_TOPIC'		=> $view_topic_url,
+						'U_VIEW_TOPIC'		=> generate_link($view_topic_url),
 						'U_VIEW_FORUM'		=> generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id),
+						
+						'U_LAST_POST'		=> generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
+						'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
 						'U_MOVE_UP'			=> ($row['order_id'] != 1) ? generate_link("Control_Panel&amp;i=main&amp;mode=bookmarks&amp;move_up={$row['order_id']}") : '',
 						'U_MOVE_DOWN'		=> ($row['order_id'] != $max_order_id) ? generate_link("Control_Panel&amp;i=main&amp;mode=bookmarks&amp;move_down={$row['order_id']}") : '')
 					);
@@ -622,7 +624,7 @@
 
 				$_CLASS['core_db']->free_result($result);
 
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'S_BOOKMARKS'			=> $bookmarks,
 					'S_BOOKMARKS_DISABLED'	=> false
 				));
@@ -650,7 +652,7 @@
 
 					if ($drafts)
 					{
-						$sql = 'DELETE FROM ' . DRAFTS_TABLE . "
+						$sql = 'DELETE FROM ' . FORUMS_DRAFTS_TABLE . "
 							WHERE draft_id IN ($drafts) 
 								AND user_id = " .$_CLASS['core_user']->data['user_id'];
 						$_CLASS['core_db']->query($sql);
@@ -675,7 +677,7 @@
 							'draft_message' => $draft_message
 						);
 
-						$sql = 'UPDATE ' . DRAFTS_TABLE . ' 
+						$sql = 'UPDATE ' . FORUMS_DRAFTS_TABLE . ' 
 							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $draft_row) . " 
 							WHERE draft_id = $draft_id
 								AND user_id = " . $_CLASS['core_user']->data['user_id'];
@@ -695,7 +697,7 @@
 				if (!$pm_drafts)
 				{
 					$sql = 'SELECT d.*, f.forum_name
-						FROM ' . DRAFTS_TABLE . ' d, ' . FORUMS_TABLE . ' f
+						FROM ' . FORUMS_DRAFTS_TABLE . ' d, ' . FORUMS_FORUMS_TABLE . ' f
 						WHERE d.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' ' .
 							(($edit) ? "AND d.draft_id = $draft_id" : '') . '
 							AND f.forum_id = d.forum_id
@@ -703,7 +705,7 @@
 				}
 				else
 				{
-					$sql = 'SELECT * FROM ' . DRAFTS_TABLE . '
+					$sql = 'SELECT * FROM ' . FORUMS_DRAFTS_TABLE . '
 						WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . ' ' .
 							(($edit) ? "AND draft_id = $draft_id" : '') . '
 							AND forum_id = 0 
@@ -727,7 +729,7 @@
 				if (sizeof($topic_ids))
 				{
 					$sql = 'SELECT topic_id, forum_id, topic_title
-						FROM ' . TOPICS_TABLE . '
+						FROM ' . FORUMS_TOPICS_TABLE . '
 						WHERE topic_id IN (' . implode(',', array_unique($topic_ids)) . ')';
 					$result = $_CLASS['core_db']->query($sql);
 
@@ -788,14 +790,14 @@
 						'S_HIDDEN_FIELDS'	=> $s_hidden_fields
 					);
 						
-					($edit) ? $_CLASS['core_template']->assign($template_row) : $_CLASS['core_template']->assign_vars_array('draftrow', $template_row);
+					($edit) ? $_CLASS['core_template']->assign_array($template_row) : $_CLASS['core_template']->assign_vars_array('draftrow', $template_row);
 				}
 
 				break;
 		}
 
 
-		$_CLASS['core_template']->assign(array( 
+		$_CLASS['core_template']->assign_array(array( 
 			'L_TITLE'					=> $_CLASS['core_user']->lang['UCP_MAIN_' . strtoupper($mode)],
 			'S_DISPLAY_MARK_ALL'		=> ($mode == 'watched' || ($mode == 'drafts' && !isset($_GET['edit']))) ? true : false, 
 			'S_HIDDEN_FIELDS'			=> (isset($s_hidden_fields)) ? $s_hidden_fields : '',
@@ -804,27 +806,9 @@
 		));
 		
 		$this->display($_CLASS['core_user']->lang['UCP_MAIN'], 'ucp_main_' . $mode . '.html');
-	}
 
-	function install()
-	{
 	}
 
-	function uninstall()
-	{
-	}
-
-	function module()
-	{
-		$details = array(
-			'name'			=> 'UCP - Main',
-			'description'	=> 'Front end for User Control Panel', 
-			'filename'		=> 'main',
-			'version'		=> '1.0.0', 
-			'phpbbversion'	=> '2.2.0'
-		);
-		return $details;
-	}
 }
 
 ?>
\ No newline at end of file

Modified: trunk/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -183,7 +183,7 @@
 				}
 				else
 				{
-					$folder_id = request_var('f', PRIVMSGS_NO_BOX);
+					$folder_id = request_var('f', PRIVMSGS_INBOX);
 					$action = request_var('action', 'view_folder');
 				}
 
@@ -242,7 +242,7 @@
 				else if ($msg_id && $folder_id == PRIVMSGS_NO_BOX)
 				{
 					$sql = 'SELECT folder_id
-						FROM ' . PRIVMSGS_TO_TABLE . "
+						FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
 						WHERE msg_id = $msg_id
 							AND user_id = " . $_CLASS['core_user']->data['user_id'];
 					$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -265,7 +265,7 @@
 						$sql_ordering = ($view == 'next') ? 'ASC' : 'DESC';
 
 						$sql = 'SELECT t.msg_id
-							FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p, ' . PRIVMSGS_TABLE . " p2
+							FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_PRIVMSGS_TABLE . " p2
 							WHERE p2.msg_id = $msg_id
 								AND t.folder_id = $folder_id
 								AND t.user_id = " . $_CLASS['core_user']->data['user_id'] . "
@@ -286,7 +286,7 @@
 					}
 	
 					$sql = 'SELECT t.*, p.*, u.*
-						FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . ' u
+						FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_USERS_TABLE . ' u
 						WHERE t.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 							AND p.author_id = u.user_id
 							AND t.folder_id = $folder_id

Modified: trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -224,7 +224,7 @@
 		$min_post_time = time() - ($sort_days * 86400);
 
 		$sql = 'SELECT COUNT(t.msg_id) AS pm_count
-			FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . " p
+			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . " p
 			WHERE $folder_sql
 				AND t.user_id = $user_id
 				AND t.msg_id = p.msg_id
@@ -252,7 +252,7 @@
 			if (in_array($folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
 			{
 				$sql = 'SELECT COUNT(t.msg_id) AS pm_count
-					FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . " p
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . " p
 					WHERE $folder_sql
 						AND t.user_id = $user_id
 						AND t.msg_id = p.msg_id";
@@ -260,7 +260,7 @@
 			else
 			{
 				$sql = 'SELECT pm_count 
-					FROM ' . PRIVMSGS_FOLDER_TABLE . " 
+					FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . " 
 					WHERE folder_id = $folder_id
 						AND user_id = $user_id";
 			}
@@ -319,7 +319,7 @@
 	}
 
 	$sql = 'SELECT t.*, p.author_id, p.root_level, p.message_time, p.message_subject, p.icon_id, p.message_reported, p.to_address, p.message_attachment, p.bcc_address, u.username 
-		FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . " u
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . " u
 		WHERE t.user_id = $user_id
 			AND p.author_id = u.user_id
 			AND $folder_sql

Modified: trunk/modules/Control_Panel/ucp/ucp_register.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -24,8 +24,6 @@
 			trigger_error('UCP_REGISTER_DISABLE');
 		}
 
-		//require($site_file_root.'includes/forums/functions_profile_fields.php');
-
 		// Do not alter this first one to use request_var!
 		$confirm_id = request_var('confirm_id', '');
 		$coppa		= (isset($_REQUEST['coppa'])) ? !empty($_REQUEST['coppa']) : null;
@@ -55,7 +53,7 @@
 				$now = explode(':', gmdate('m:j:Y'));
 				$coppa_birthday = $_CLASS['core_user']->format_date(mktime(12, 0, 0, $now[0], $now[1] - 1, $now[2] - 13, 0)); 
 
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'L_COPPA_NO'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_BEFORE'], $coppa_birthday),
 					'L_COPPA_YES'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_ON_AFTER'], $coppa_birthday),
 
@@ -68,7 +66,7 @@
 			}
 			else
 			{
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'S_SHOW_COPPA'		=> false, 
 					'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register'))
 				);
@@ -362,7 +360,7 @@
 					$_CLASS['core_user']->session_data_get('reg_attempts', ($attempts + 1));
 				}
 				
-				$_CLASS['core_user']->session_data_get('confirmation_code', generate_string(6));
+				$_CLASS['core_user']->session_data_set('confirmation_code', generate_string(6));
 			}
 
 			$confirm_image = '<img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" />';

Deleted: trunk/modules/Control_Panel/ucp/ucp_remind.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_remind.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_remind.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,100 +0,0 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_remind.php,v 1.8 2004/02/21 12:47:34 acydburn Exp $
-//
-// FILENAME  : ucp_remind.php
-// STARTED   : Mon May 19, 2003
-// COPYRIGHT : ? 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-class ucp_remind extends module 
-{
-	function ucp_remind($id, $mode)
-	{
-		global $config, $_CLASS, $site_file_root;
-		
-		$_CLASS['core_template']->assign('S_HIDDEN_FIELDS', false);
-
-		$submit = (isset($_POST['submit'])) ? true : false;
-
-		if ($submit)
-		{
-			$username	= request_var('username', '');
-			$email		= request_var('email', '');
-
-			$sql = 'SELECT user_id, username, user_email, user_jabber, user_notify_type, user_type, user_lang
-				FROM ' . USERS_TABLE . "
-				WHERE user_email = '" . $_CLASS['core_db']->sql_escape($email) . "'
-					AND username = '" . $_CLASS['core_db']->sql_escape($username) . "'";
-			$result = $_CLASS['core_db']->sql_query($sql);
-
-			if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
-			{
-				trigger_error('NO_EMAIL_USER');
-			}
-			$_CLASS['core_db']->sql_freeresult($result);
-
-			if ($row['user_type'] == USER_INACTIVE)
-			{
-				trigger_error('ACCOUNT_NOT_ACTIVATED');
-			}
-
-			$server_url = generate_board_url();
-			$username = $row['username'];
-			$user_id = $row['user_id'];
-
-			$key_len = 54 - strlen($server_url);
-			$key_len = ($key_len > 6) ? $key_len : 6;
-			$user_actkey = substr(gen_rand_string(10), 0, $key_len);
-			$user_password = gen_rand_string(8);
-
-			$sql = 'UPDATE ' . USERS_TABLE . "
-				SET user_newpasswd = '" . $_CLASS['core_db']->sql_escape(md5($user_password)) . "', user_actkey = '" . $_CLASS['core_db']->sql_escape($user_actkey) . "'
-				WHERE user_id = " . $row['user_id'];
-			$_CLASS['core_db']->sql_query($sql);
-
-			include_once($site_file_root. 'includes/forums/functions_messenger.php');
-
-			$messenger = new messenger();
-
-			$messenger->template('user_activate_passwd', $row['user_lang']);
-			
-			$messenger->replyto($_CLASS['core_user']->data['user_email']);
-			$messenger->to($row['user_email'], $row['username']);
-			$messenger->im($row['user_jabber'], $row['username']);
-
-			$messenger->assign_vars(array(
-				'SITENAME'		=> $config['site_name'],
-				'USERNAME'		=> $username,
-				'PASSWORD'		=> $user_password,
-				'EMAIL_SIG'		=> str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']),
-				'U_ACTIVATE'	=> generate_link("Control_Panel&mode=activate&u=$user_id&k=$user_actkey", array('full' => true, 'sid' => false)))
-			);
-
-			$messenger->send($row['user_notify_type']);
-			$messenger->save_queue();
-			
-			$_CLASS['core_display']->meta_refresh(3, generate_link());
-
-			$message = $_CLASS['core_user']->lang['PASSWORD_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_INDEX'],  '<a href="' . generate_link() . '">', '</a>');
-			trigger_error($message);
-		}
-		else
-		{
-			$username = $email = '';
-		}
-
-		$_CLASS['core_template']->assign(array(
-			
-			'USERNAME'	=> $username,
-			'EMAIL'		=> $email)
-		);
-
-		$this->display($_CLASS['core_user']->lang['UCP_REMIND'], 'ucp_remind.html');
-	}
-}
-
-?>
\ No newline at end of file

Deleted: trunk/modules/Control_Panel/ucp/ucp_resend.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_resend.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_resend.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,150 +0,0 @@
-<?php
-/** 
-*
-* @package ucp
-* @version $Id: ucp_resend.php,v 1.1 2005/04/09 12:26:57 acydburn Exp $
-* @copyright (c) 2005 phpBB Group 
-* @license http://opensource.org/licenses/gpl-license.php GNU Public License 
-*
-*/
-
-/**
-* @package ucp
-* ucp_resend
-* Resending activation emails
-*/
-class ucp_resend extends module 
-{
-	function ucp_resend($id, $mode)
-	{
-		global $site_file_root, $config, $_CORE_CONFIG, $_CLASS;
-
-		$submit = (isset($_POST['submit'])) ? true : false;
-
-		if ($submit)
-		{
-			$username	= request_var('username', '');
-			$email		= request_var('email', '');
-
-			$sql = 'SELECT user_id, username, user_email, user_type, user_lang, user_actkey
-				FROM ' . USERS_TABLE . "
-				WHERE user_email = '" . $_CLASS['core_db']->sql_escape($email) . "'
-					AND username = '" . $_CLASS['core_db']->sql_escape($username) . "'";
-			$result = $_CLASS['core_db']->sql_query($sql);
-
-			if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
-			{
-				trigger_error('NO_EMAIL_USER');
-			}
-			$_CLASS['core_db']->sql_freeresult($result);
-
-			if (!$row['user_actkey'])
-			{
-				trigger_error('ACCOUNT_ALREADY_ACTIVATED');
-			}
-
-			$server_url = generate_board_url();
-			$username = $row['username'];
-			$user_id = $row['user_id'];
-
-/*			if ($coppa)
-			{
-				$email_template = 'coppa_welcome_inactive';
-			}*/
-			if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
-			{
-				$email_template = 'admin_welcome_inactive';
-			}
-			else
-			{
-				$email_template = 'user_welcome_inactive';
-			}
-
-			include_once($site_file_root.'includes/forums/functions_messenger.php');
-
-			$messenger = new messenger(false);
-
-			if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $coppa)
-			{
-				$messenger->template('user_resend_inactive', $row['user_lang']);
-
-				$messenger->replyto($config['board_contact']);
-				$messenger->to($row['user_email'], $row['username']);
-
-				$messenger->headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-				$messenger->headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']->data['user_id']);
-				$messenger->headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']->data['username']);
-				$messenger->headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']->ip);
-
-				$messenger->assign_vars(array(
-					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
-					'WELCOME_MSG'	=> sprintf($_CLASS['core_user']->lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
-					'USERNAME'		=> $row['username'],
-					'EMAIL_SIG'		=> str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']),
-
-					'U_ACTIVATE'	=> generate_link("Control_Panel&mode=activate&u={$row['user_id']}&k={$row['user_actkey']}", array('full' => true, 'sid' => false)))
-				);
-
-				if ($coppa)
-				{
-					$messenger->assign_vars(array(
-						'FAX_INFO'		=> $_CORE_CONFIG['user']['coppa_fax'],
-						'MAIL_INFO'		=> $_CORE_CONFIG['user']['coppa_mail'],
-						'EMAIL_ADDRESS' => $row['user_email'],
-						'SITENAME'		=> $_CORE_CONFIG['global']['site_name'])
-					);
-				}
-
-				$messenger->send(NOTIFY_EMAIL);
-			}
-
-			if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
-			{
-				// Grab an array of user_id's with a_user permissions ... these users
-				// can activate a user
-				$admin_ary = $_CLASS['auth']->acl_get_list(false, 'a_user', false);
-
-				$sql = 'SELECT user_id, username, user_email, user_lang, user_jabber, user_notify_type
-					FROM ' . USERS_TABLE . '
-					WHERE user_id IN (' . implode(', ', $admin_ary[0]['a_user']) .')';
-				$result = $_CLASS['core_db']->sql_query($sql);
-
-				while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-				{
-					$messenger->template('admin_activate', $row['user_lang']);
-					$messenger->replyto($config['board_contact']);
-					$messenger->to($row['user_email'], $row['username']);
-					$messenger->im($row['user_jabber'], $row['username']);
-
-					$messenger->assign_vars(array(
-						'USERNAME'		=> $row['username'],
-						'EMAIL_SIG'		=> str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']),
-
-						'U_ACTIVATE'	=> generate_link("Control_Panel&mode=activate&u={$row['user_id']}&k={$row['user_actkey']}", array('full' => true, 'sid' => false)))
-					);
-
-					$messenger->send($row['user_notify_type']);
-				}
-				$_CLASS['core_db']->sql_freeresult($result);
-			}
-
-			meta_refresh(3, generate_link());
-
-			$message = $_CLASS['core_user']->lang['ACTIVATION_EMAIL_SENT'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_INDEX'],  '<a href="' . generate_link() . '">', '</a>');
-			trigger_error($message);
-		}
-		else
-		{
-			$username = $email = '';
-		}
-		
-		$_CLASS['core_template']->assign(array(
-			'USERNAME'	=> $username,
-			'EMAIL'		=> $email)
-		);
-		
-		$this->display($_CLASS['core_user']->lang['UCP_RESEND'], 'ucp_resend.html');
-	}
-}
-
-?>

Modified: trunk/modules/Forums/download.php
===================================================================
--- trunk/modules/Forums/download.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/download.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -46,15 +46,15 @@
 }
 
 $sql = 'SELECT attach_id, in_message, post_msg_id, extension
-	FROM ' . ATTACHMENTS_TABLE . "
+	FROM ' . FORUMS_ATTACHMENTS_TABLE . "
 	WHERE attach_id = $download_id";
-$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
+$result = $_CLASS['core_db']->query_limit($sql, 1);
 
-if (!($attachment = $_CLASS['core_db']->sql_fetchrow($result)))
+if (!($attachment = $_CLASS['core_db']->fetch_row_assoc($result)))
 {
 	trigger_error('ERROR_NO_ATTACHMENT');
 }
-$_CLASS['core_db']->sql_freeresult($result);
+$_CLASS['core_db']->free_result($result);
 
 if ((!$attachment['in_message'] && !$config['allow_attachments']) || ($attachment['in_message'] && !$config['allow_pm_attach']))
 {
@@ -64,14 +64,13 @@
 $row = array();
 if (!$attachment['in_message'])
 {
-	// 
 	$sql = 'SELECT p.forum_id, f.forum_password, f.parent_id
-		FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f
+		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
 		WHERE p.post_id = ' . $attachment['post_msg_id'] . '
 			AND p.forum_id = f.forum_id';
-	$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
-	$row = $_CLASS['core_db']->sql_fetchrow($result);
-	$_CLASS['core_db']->sql_freeresult($result);
+	$result = $_CLASS['core_db']->query_limit($sql, 1);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
 
 	if ($_CLASS['auth']->acl_gets('f_download', 'u_download', $row['forum_id']))
 	{
@@ -83,7 +82,7 @@
 	}
 	else
 	{
-		trigger_error('SORRY_AUTH_VIEW_ATTACH');
+		//trigger_error('SORRY_AUTH_VIEW_ATTACH');
 	}
 }
 else
@@ -111,15 +110,15 @@
 
 // Fetching filename here to prevent sniffing of filename
 $sql = 'SELECT attach_id, in_message, post_msg_id, extension, physical_filename, real_filename, mimetype
-	FROM ' . ATTACHMENTS_TABLE . "
+	FROM ' . FORUMS_ATTACHMENTS_TABLE . "
 	WHERE attach_id = $download_id";
-$result = $_CLASS['core_db']->sql_query_limit($sql, 1);
+$result = $_CLASS['core_db']->query_limit($sql, 1);
 
-if (!($attachment = $_CLASS['core_db']->sql_fetchrow($result)))
+if (!($attachment = $_CLASS['core_db']->fetch_row_assoc($result)))
 {
 	trigger_error('ERROR_NO_ATTACHMENT');
 }
-$_CLASS['core_db']->sql_freeresult($result);
+$_CLASS['core_db']->free_result($result);
 
 $attachment['physical_filename'] = basename($attachment['physical_filename']);
 
@@ -131,7 +130,7 @@
 else
 {
 	// Update download count
-	$sql = 'UPDATE ' . ATTACHMENTS_TABLE . ' 
+	$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
 		SET download_count = download_count + 1 
 		WHERE attach_id = ' . $attachment['attach_id'];
 	$_CLASS['core_db']->sql_query($sql);
@@ -297,7 +296,7 @@
 			FROM ' . SITELIST_TABLE;
 		$result = $_CLASS['core_db']->sql_query($sql);
 
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$site_ip = trim($row['site_ip']);
 			$site_hostname = trim($row['site_hostname']);
@@ -338,7 +337,7 @@
 			}
 		}
 
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 	}
 	
 	return $allowed;

Modified: trunk/modules/Forums/faq.php
===================================================================
--- trunk/modules/Forums/faq.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/faq.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -120,8 +120,8 @@
 	'L_BACK_TO_TOP'			=> $_CLASS['core_user']->lang['BACK_TO_TOP'],
 	'L_JUMP_TO'				=> $_CLASS['core_user']->lang['JUMP_TO'],
 	'L_GO'					=> $_CLASS['core_user']->lang['GO'],
-	'S_BACK_TO_TOP'			=> generate_link('Forums&amp;file=faq'.$link.'#Top'))
-);
+	'S_BACK_TO_TOP'			=> generate_link('Forums&amp;file=faq'.$link.'#Top')
+));
 
 
 $_CLASS['core_template']->assign('DISPLAY_STYLESHEET_LINK', ($mode == 'bbcode'));

Modified: trunk/modules/Forums/main.php
===================================================================
--- trunk/modules/Forums/main.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/main.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -81,7 +81,7 @@
 $l_total_topic_s = ($config['num_topics'] == 0) ? 'TOTAL_TOPICS_ZERO' : 'TOTAL_TOPICS_OTHER';
 
 // Assign index specific vars
-$_CLASS['core_template']->assign(array(
+$_CLASS['core_template']->assign_array(array(
 	'TOTAL_POSTS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_post_s), $config['num_posts']),
 	'TOTAL_TOPICS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_topic_s), $config['num_topics']),
 	'TOTAL_USERS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_user_s), $config['num_users']),

Modified: trunk/modules/Forums/posting.php
===================================================================
--- trunk/modules/Forums/posting.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/posting.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -52,7 +52,7 @@
 		}
 
 		$sql = 'SELECT *
-			FROM ' . FORUMS_TABLE . "
+			FROM ' . FORUMS_FORUMS_TABLE . "
 			WHERE forum_id = $forum_id";
 		break;
 
@@ -64,7 +64,7 @@
 		}
 
 		$sql = 'SELECT t.*, f.* 
-			FROM ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . " f
+			FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . " f
 			WHERE t.topic_id = $topic_id
 				AND f.forum_id = t.forum_id";
 	break;
@@ -78,7 +78,7 @@
 		}
 
 		$sql = 'SELECT f.*, t.*, p.*, u.username, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield
-			FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . ' f, ' . USERS_TABLE . " u
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_USERS_TABLE . " u
 			WHERE p.post_id = $post_id
 				AND t.topic_id = p.topic_id
 				AND u.user_id = p.poster_id
@@ -166,7 +166,7 @@
 if ($poll_start)
 {
 	$sql = 'SELECT poll_option_text 
-		FROM ' . POLL_OPTIONS_TABLE . "
+		FROM ' . FORUMS_POLL_OPTIONS_TABLE . "
 		WHERE topic_id = $topic_id
 		ORDER BY poll_option_id";
 	$result = $_CLASS['core_db']->query($sql);
@@ -203,7 +203,7 @@
 if ($post_attachment && !$submit && !$refresh && !$preview && $mode == 'edit')
 {
 	$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
-		FROM ' . ATTACHMENTS_TABLE . "
+		FROM ' . FORUMS_ATTACHMENTS_TABLE . "
 		WHERE post_msg_id = $post_id
 			AND in_message = 0
 		ORDER BY filetime " . ((!$config['display_order']) ? 'DESC' : 'ASC');
@@ -240,7 +240,7 @@
 if ($_CLASS['core_user']->is_user && $_CLASS['auth']->acl_get('u_savedrafts') && $mode != 'delete')
 {
 	$sql = 'SELECT draft_id
-		FROM ' . DRAFTS_TABLE . '
+		FROM ' . FORUMS_DRAFTS_TABLE . '
 		WHERE (forum_id = ' . $forum_id . (($topic_id) ? " OR topic_id = $topic_id" : '') . ')
 			AND user_id = ' . $_CLASS['core_user']->data['user_id'] . 
 			(($draft_id) ? " AND draft_id <> $draft_id" : '');
@@ -400,18 +400,18 @@
 {
 	$_CLASS['core_db']->transaction();
 
-	$_CLASS['core_db']->query('UPDATE ' . POSTS_TABLE . "
+	$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . "
 		SET post_time = $current_time
 		WHERE post_id = $topic_last_post_id
 			AND topic_id = $topic_id");
 
-	$_CLASS['core_db']->query('UPDATE ' . TOPICS_TABLE . "
+	$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . "
 		SET topic_last_post_time = $current_time,
 			topic_bumped = 1,
 			topic_bumper = " . $_CLASS['core_user']->data['user_id'] . "
 		WHERE topic_id = $topic_id");
 
-	$_CLASS['core_db']->query('UPDATE ' . FORUMS_TABLE . '
+	$_CLASS['core_db']->query('UPDATE ' . FORUMS_FORUMS_TABLE . '
 		SET ' . implode(', ', update_last_post_information('forum', $forum_id)) . "
 		WHERE forum_id = $forum_id");
 
@@ -445,7 +445,7 @@
 
 	if ($subject && $message)
 	{
-		$sql = 'INSERT INTO ' . DRAFTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+		$sql = 'INSERT INTO ' . FORUMS_DRAFTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 			'user_id'	=> $_CLASS['core_user']->data['user_id'],
 			'topic_id'	=> $topic_id,
 			'forum_id'	=> $forum_id,
@@ -470,7 +470,7 @@
 }
 
 // Move to where they should be
-$_CLASS['core_template']->assign(array(
+$_CLASS['core_template']->assign_array(array(
 		'S_DRAFT_LOADED'	=> false,
 		'S_SHOW_DRAFTS'		=> false,
 		'S_POST_REVIEW'		=> false,
@@ -487,7 +487,7 @@
 if ($draft_id && $_CLASS['core_user']->is_user && $_CLASS['auth']->acl_get('u_savedrafts'))
 {
 	$sql = 'SELECT draft_subject, draft_message 
-		FROM ' . DRAFTS_TABLE . " 
+		FROM ' . FORUMS_DRAFTS_TABLE . " 
 		WHERE draft_id = $draft_id
 			AND user_id = " . $_CLASS['core_user']->data['user_id'];
 	$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -758,7 +758,7 @@
 		if ($topic_type != POST_GLOBAL)
 		{
 			$sql = 'SELECT topic_type, forum_id
-				FROM ' . TOPICS_TABLE . "
+				FROM ' . FORUMS_TOPICS_TABLE . "
 				WHERE topic_id = $topic_id";
 			$result = $_CLASS['core_db']->query_limit($sql, 1);
 
@@ -770,7 +770,7 @@
 	
 				if (!$to_forum_id)
 				{
-					$_CLASS['core_template']->assign(array(
+					$_CLASS['core_template']->assign_array(array(
 						'S_FORUM_SELECT'	=> make_forum_select(false, false, false, true, true),
 						'S_UNGLOBALISE'		=> true) 
 					);
@@ -906,7 +906,7 @@
 
 		$parse_poll->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies);
 		
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'S_HAS_POLL_OPTIONS'=> (sizeof($poll_options)),
 			'S_IS_MULTI_CHOICE'	=> ($poll_max_options > 1) ? true : false,
 
@@ -954,7 +954,7 @@
 
 	if (!sizeof($error))
 	{
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'PREVIEW_SUBJECT'		=> $preview_subject,
 			'PREVIEW_MESSAGE'		=> $preview_message,
 			'PREVIEW_SIGNATURE'		=> $preview_signature,
@@ -1085,7 +1085,7 @@
 $form_enctype = (@ini_get('file_uploads') == '0' || strtolower(@ini_get('file_uploads')) == 'off' || @ini_get('file_uploads') == '0' || !$config['allow_attachments'] || !$_CLASS['auth']->acl_gets('f_attach', 'u_attach', $forum_id)) ? '' : ' enctype="multipart/form-data"';
 
 // Start assigning vars for main posting page ...
-$_CLASS['core_template']->assign(array(
+$_CLASS['core_template']->assign_array(array(
 	'L_POST_A'				=> $page_title,
 	'L_ICON'				=> ($mode == 'reply' || $mode == 'quote') ? $_CLASS['core_user']->lang['POST_ICON'] : $_CLASS['core_user']->lang['TOPIC_ICON'], 
 	'L_MESSAGE_BODY_EXPLAIN'=> (intval($config['max_post_chars'])) ? sprintf($_CLASS['core_user']->lang['MESSAGE_BODY_EXPLAIN'], intval($config['max_post_chars'])) : '',
@@ -1144,7 +1144,7 @@
 if (($mode == 'post' || ($mode == 'edit' && $post_id == $topic_first_post_id && (!$poll_last_vote || $_CLASS['auth']->acl_get('m_edit', $forum_id))))
 	&& $_CLASS['auth']->acl_get('f_poll', $forum_id))
 {
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_SHOW_POLL_BOX'		=> true,
 		'S_POLL_VOTE_CHANGE'    => ($_CLASS['auth']->acl_get('f_votechg', $forum_id)),
 		'S_POLL_DELETE'			=> ($mode == 'edit' && $poll_options && ((!$poll_last_vote && $poster_id == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id))),
@@ -1159,7 +1159,7 @@
 }
 else
 {
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_SHOW_POLL_BOX'		=> false,
 		'S_POLL_DELETE'			=> false,
 	));
@@ -1372,7 +1372,7 @@
 	{
 		case 'post':
 		case 'reply':
-			$sql_data[POSTS_TABLE]['sql'] = array(
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
 				'forum_id' 			=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
 				'poster_id' 		=> (int) $_CLASS['core_user']->data['user_id'],
 				'icon_id'			=> $data['icon_id'],
@@ -1399,11 +1399,11 @@
 		case 'edit':
 			if (!$_CLASS['auth']->acl_gets('m_', 'a_') || $data['post_edit_reason'])
 			{
-				$sql_data[POSTS_TABLE]['sql'] = array(
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
 					'post_edit_time'	=> $current_time
 				);
 
-				$sql_data[POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
+				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
 			}
 
 		case 'edit_last_post':
@@ -1411,19 +1411,19 @@
 
 			if (($post_mode == 'edit_last_post' || $post_mode == 'edit_topic') && $data['post_edit_reason'])
 			{
-				$sql_data[POSTS_TABLE]['sql'] = array(
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
 					'post_edit_time'	=> $current_time
 				);
 
-				$sql_data[POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
+				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
 			}
 
-			if (!isset($sql_data[POSTS_TABLE]['sql']))
+			if (!isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
 			{
-				$sql_data[POSTS_TABLE]['sql'] = array();
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array();
 			}
 
-			$sql_data[POSTS_TABLE]['sql'] = array_merge($sql_data[POSTS_TABLE]['sql'], array(
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[POSTS_TABLE]['sql'], array(
 				'forum_id' 			=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
 				'poster_id' 		=> $data['poster_id'],
 				'icon_id'			=> $data['icon_id'],
@@ -1446,7 +1446,7 @@
 
 			if ($update_message)
 			{
-				$sql_data[POSTS_TABLE]['sql']['post_text'] = $data['message'];
+				$sql_data[FORUMS_POSTS_TABLE]['sql']['post_text'] = $data['message'];
 			}
 
 			break;
@@ -1456,7 +1456,7 @@
 	switch ($post_mode)
 	{
 		case 'post':
-			$sql_data[TOPICS_TABLE]['sql'] = array(
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
 				'topic_poster'		=> (int) $_CLASS['core_user']->data['user_id'],
 				'topic_time'		=> $current_time,
 				'forum_id' 			=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
@@ -1471,7 +1471,7 @@
 
 			if (isset($poll['poll_options']) && !empty($poll['poll_options']))
 			{
-				$sql_data[TOPICS_TABLE]['sql'] = array_merge($sql_data[TOPICS_TABLE]['sql'], array(
+				$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array_merge($sql_data[TOPICS_TABLE]['sql'], array(
 					'poll_title'		=> $poll['poll_title'],
 					'poll_start'		=> ($poll['poll_start']) ? $poll['poll_start'] : $current_time,
 					'poll_max_options'	=> $poll['poll_max_options'],
@@ -1486,27 +1486,27 @@
 			{
 				if (!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve'))
 				{
-					$sql_data[FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
+					$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
 				}
-				$sql_data[FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? ', forum_topics = forum_topics + 1' : '');
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? ', forum_topics = forum_topics + 1' : '');
 			}
 			
 			break;
 
 		case 'reply':
-			$sql_data[TOPICS_TABLE]['stat'][] = 'topic_replies_real = topic_replies_real + 1, topic_bumped = 0, topic_bumper = 0' . ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? ', topic_replies = topic_replies + 1' : '');
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = 'topic_replies_real = topic_replies_real + 1, topic_bumped = 0, topic_bumper = 0' . ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? ', topic_replies = topic_replies + 1' : '');
 			$sql_data[USERS_TABLE]['stat'][] = "user_last_post_time = $current_time" . (($_CLASS['auth']->acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
 			
 			if ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) && $topic_type != POST_GLOBAL)
 			{
-				$sql_data[FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
 			}
 			break;
 
 		case 'edit_topic':
 		case 'edit_first_post':
 
-			$sql_data[TOPICS_TABLE]['sql'] = array(
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
 				'forum_id' 					=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
 				'icon_id'					=> $data['icon_id'],
 				'topic_approved'			=> ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? 0 : 1,
@@ -1529,16 +1529,16 @@
 	// Submit new topic
 	if ($post_mode == 'post')
 	{
-		$sql = 'INSERT INTO ' . TOPICS_TABLE . ' ' .
-			$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[TOPICS_TABLE]['sql']);
+		$sql = 'INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' .
+			$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_TOPICS_TABLE]['sql']);
 		$_CLASS['core_db']->query($sql);
 
-		$data['topic_id'] = $_CLASS['core_db']->insert_id(TOPICS_TABLE, 'topic_id');
+		$data['topic_id'] = $_CLASS['core_db']->insert_id(FORUMS_TOPICS_TABLE, 'topic_id');
 
-		$sql_data[POSTS_TABLE]['sql'] = array_merge($sql_data[POSTS_TABLE]['sql'], array(
+		$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
 			'topic_id' => $data['topic_id'])
 		);
-		unset($sql_data[TOPICS_TABLE]['sql']);
+		unset($sql_data[FORUMS_TOPICS_TABLE]['sql']);
 	}
 
 	// Submit new post
@@ -1546,19 +1546,19 @@
 	{
 		if ($post_mode == 'reply')
 		{
-			$sql_data[POSTS_TABLE]['sql'] = array_merge($sql_data[POSTS_TABLE]['sql'], array(
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
 				'topic_id' => $data['topic_id'])
 			);
 		}
 
-		$sql = 'INSERT INTO ' . POSTS_TABLE . ' ' .
-			$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[POSTS_TABLE]['sql']);
+		$sql = 'INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .
+			$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']);
 		$_CLASS['core_db']->query($sql);
-		$data['post_id'] = $_CLASS['core_db']->insert_id(POSTS_TABLE, 'post_id');
+		$data['post_id'] = $_CLASS['core_db']->insert_id(FORUMS_POSTS_TABLE, 'post_id');
 
 		if ($post_mode == 'post')
 		{
-			$sql_data[TOPICS_TABLE]['sql'] = array(
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
 				'topic_first_post_id' => $data['post_id'],
 				'topic_last_post_id' => $data['post_id'],
 				'topic_last_post_time' => $current_time,
@@ -1567,7 +1567,7 @@
 			);
 		}
 
-		unset($sql_data[POSTS_TABLE]['sql']);
+		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
 	}
 
 	$make_global = false;
@@ -1576,7 +1576,7 @@
 	if ($post_mode == 'edit_first_post' || $post_mode == 'edit_topic')
 	{
 		$sql = 'SELECT topic_type, topic_replies_real, topic_approved
-			FROM ' . TOPICS_TABLE . '
+			FROM ' . FORUMS_TOPICS_TABLE . '
 			WHERE topic_id = ' . $data['topic_id'];
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -1588,10 +1588,10 @@
 		{
 			// Decrement topic/post count
 			$make_global = true;
-			$sql_data[FORUMS_TABLE]['stat'] = array();
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
 
-			$sql_data[FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts - ' . ($row['topic_replies_real'] + 1);
-			$sql_data[FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real - 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics - 1' : '');
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts - ' . ($row['topic_replies_real'] + 1);
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real - 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics - 1' : '');
 
 			// Update forum_ids for all posts
 			$sql = 'UPDATE ' . POSTS_TABLE . '
@@ -1604,13 +1604,13 @@
 		{
 			// Increment topic/post count
 			$make_global = true;
-			$sql_data[FORUMS_TABLE]['stat'] = array();
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
 
-			$sql_data[FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + ' . ($row['topic_replies_real'] + 1);
-			$sql_data[FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics + 1' : '');
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + ' . ($row['topic_replies_real'] + 1);
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics + 1' : '');
 
 			// Update forum_ids for all posts
-			$sql = 'UPDATE ' . POSTS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 				SET forum_id = ' . $data['forum_id'] . '
 				WHERE topic_id = ' . $data['topic_id'];
 			$_CLASS['core_db']->query($sql);
@@ -1618,18 +1618,18 @@
 	}
 
 	// Update the topics table
-	if (isset($sql_data[TOPICS_TABLE]['sql']))
+	if (isset($sql_data[FORUMS_TOPICS_TABLE]['sql']))
 	{
-		$_CLASS['core_db']->query('UPDATE ' . TOPICS_TABLE . '
-			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[TOPICS_TABLE]['sql']) . '
+		$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . '
+			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[FORUMS_TOPICS_TABLE]['sql']) . '
 			WHERE topic_id = ' . $data['topic_id']);
 	}
 
 	// Update the posts table
-	if (isset($sql_data[POSTS_TABLE]['sql']))
+	if (isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
 	{
-		$_CLASS['core_db']->query('UPDATE ' . POSTS_TABLE . '
-			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[POSTS_TABLE]['sql']) . '
+		$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . '
+			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[FORUMS_POSTS_TABLE]['sql']) . '
 			WHERE post_id = ' . $data['post_id']);
 	}
 
@@ -1640,7 +1640,7 @@
 
 		if ($poll['poll_start'] && $mode == 'edit')
 		{
-			$sql = 'SELECT * FROM ' . POLL_OPTIONS_TABLE . '
+			$sql = 'SELECT * FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
 				WHERE topic_id = ' . $data['topic_id'] . '
 				ORDER BY poll_option_id';
 			$result = $_CLASS['core_db']->query($sql);
@@ -1656,13 +1656,13 @@
 			{
 				if (!$cur_poll_options[$i])
 				{
-					$sql = 'INSERT INTO ' . POLL_OPTIONS_TABLE . "  (poll_option_id, topic_id, poll_option_text)
+					$sql = 'INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . "  (poll_option_id, topic_id, poll_option_text)
 						VALUES ($i, " . $data['topic_id'] . ", '" . $_CLASS['core_db']->sql_escape($poll['poll_options'][$i]) . "')";
 					$_CLASS['core_db']->query($sql);
 				}
 				else if ($poll['poll_options'][$i] != $cur_poll_options[$i])
 				{
-					$sql = "UPDATE " . POLL_OPTIONS_TABLE . "
+					$sql = "UPDATE " . FORUMS_POLL_OPTIONS_TABLE . "
 						SET poll_option_text = '" . $_CLASS['core_db']->sql_escape($poll['poll_options'][$i]) . "'
 						WHERE poll_option_id = " . $cur_poll_options[$i]['poll_option_id'] . "
 							AND topic_id = " . $data['topic_id'];
@@ -1673,7 +1673,7 @@
 
 		if (sizeof($poll['poll_options']) < sizeof($cur_poll_options))
 		{
-			$sql = 'DELETE FROM ' . POLL_OPTIONS_TABLE . '
+			$sql = 'DELETE FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
 				WHERE poll_option_id >= ' . sizeof($poll['poll_options']) . '
 					AND topic_id = ' . $data['topic_id'];
 			$_CLASS['core_db']->query($sql);
@@ -1690,7 +1690,7 @@
 			if ($attach_row['attach_id'])
 			{
 				// update entry in db if attachment already stored in db and filespace
-				$sql = 'UPDATE ' . ATTACHMENTS_TABLE . "
+				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . "
 					SET comment = '" . $_CLASS['core_db']->sql_escape($attach_row['comment']) . "'
 					WHERE attach_id = " . (int) $attach_row['attach_id'];
 				$_CLASS['core_db']->query($sql);
@@ -1718,7 +1718,7 @@
 					'thumbnail'			=> $attach_row['thumbnail']
 				);
 
-				$sql = 'INSERT INTO ' . ATTACHMENTS_TABLE . ' ' .
+				$sql = 'INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' .
 					$_CLASS['core_db']->sql_build_array('INSERT', $attach_sql);
 				$_CLASS['core_db']->query($sql);
 
@@ -1729,12 +1729,12 @@
 
 		if (sizeof($data['attachment_data']))
 		{
-			$sql = 'UPDATE ' . POSTS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 				SET post_attachment = 1
 				WHERE post_id = ' . $data['post_id'];
 			$_CLASS['core_db']->query($sql);
 
-			$sql = 'UPDATE ' . TOPICS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 				SET topic_attachment = 1
 				WHERE topic_id = ' . $data['topic_id'];
 			$_CLASS['core_db']->query($sql);
@@ -1750,19 +1750,19 @@
 	{
 		if ($topic_type != POST_GLOBAL)
 		{
-			$sql_data[FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
 		}
 
 		$update = update_last_post_information('topic', $data['topic_id']);
 		if (sizeof($update))
 		{
-			$sql_data[TOPICS_TABLE]['stat'][] = implode(', ', $update);
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
 		}
 	}
 
 	if ($make_global)
 	{
-		$sql_data[FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
+		$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
 	}
 
 	if ($post_mode == 'edit_topic')
@@ -1770,7 +1770,7 @@
 		$update = update_last_post_information('topic', $data['topic_id']);
 		if (sizeof($update))
 		{
-			$sql_data[TOPICS_TABLE]['stat'][] = implode(', ', $update);
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
 		}
 	}
 
@@ -1792,7 +1792,7 @@
 	// Update forum stats
 	$_CLASS['core_db']->transaction();
 
-	$where_sql = array(POSTS_TABLE => 'post_id = ' . $data['post_id'], TOPICS_TABLE => 'topic_id = ' . $data['topic_id'], FORUMS_TABLE => 'forum_id = ' . $data['forum_id'], USERS_TABLE => 'user_id = ' . $_CLASS['core_user']->data['user_id']);
+	$where_sql = array(FORUMS_POSTS_TABLE => 'post_id = ' . $data['post_id'], FORUMS_TOPICS_TABLE => 'topic_id = ' . $data['topic_id'], FORUMS_FORUMS_TABLE => 'forum_id = ' . $data['forum_id'], USERS_TABLE => 'user_id = ' . $_CLASS['core_user']->data['user_id']);
 
 	foreach ($sql_data as $table => $update_ary)
 	{
@@ -1805,7 +1805,7 @@
 	// Delete topic shadows (if any exist). We do not need a shadow topic for an global announcement
 	if ($make_global)
 	{
-		$_CLASS['core_db']->query('DELETE FROM ' . TOPICS_TABLE . '
+		$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_TOPICS_TABLE . '
 			WHERE topic_moved_id = ' . $data['topic_id']);
 	}
 
@@ -1828,13 +1828,13 @@
 	// Topic Notification
 	if (!$data['notify_set'] && $data['notify'])
 	{
-		$sql = 'INSERT INTO ' . TOPICS_WATCH_TABLE . ' (user_id, topic_id)
+		$sql = 'INSERT INTO ' . FORUMS_TOPICS_WATCH_TABLE . ' (user_id, topic_id)
 			VALUES (' . $_CLASS['core_user']->data['user_id'] . ', ' . $data['topic_id'] . ')';
 		$_CLASS['core_db']->query($sql);
 	}
 	else if ($data['notify_set'] && !$data['notify'])
 	{
-		$sql = 'DELETE FROM ' . TOPICS_WATCH_TABLE . '
+		$sql = 'DELETE FROM ' . FORUMS_TOPICS_WATCH_TABLE . '
 			WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 				AND topic_id = ' . $data['topic_id'];
 		$_CLASS['core_db']->query($sql);

Modified: trunk/modules/Forums/viewforum.php
===================================================================
--- trunk/modules/Forums/viewforum.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/viewforum.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -50,7 +50,7 @@
 if (!$_CLASS['core_user']->is_user)
 {
 	$sql = 'SELECT *
-		FROM ' . FORUMS_TABLE . '
+		FROM ' . FORUMS_FORUMS_TABLE . '
 		WHERE forum_id = ' . $forum_id .'
 		AND forum_status <> '.ITEM_DELETING;
 }
@@ -69,7 +69,7 @@
 		}
 
 		$sql = "SELECT f.*, fw.notify_status $lastread_select 
-			FROM " . FORUMS_TABLE . ' f LEFT JOIN ' . FORUMS_WATCH_TABLE . ' fw ON (fw.forum_id = f.forum_id AND fw.user_id = ' . $_CLASS['core_user']->data['user_id'] . ") $sql_lastread
+			FROM " . FORUMS_FORUMS_TABLE . ' f LEFT JOIN ' . FORUMS_WATCH_TABLE . ' fw ON (fw.forum_id = f.forum_id AND fw.user_id = ' . $_CLASS['core_user']->data['user_id'] . ") $sql_lastread
 			WHERE f.forum_id = $forum_id";
 }
 
@@ -99,7 +99,7 @@
 	// Does it have click tracking enabled?
 	if ($forum_data['forum_flags'] & 1)
 	{
-		$sql = 'UPDATE ' . FORUMS_TABLE . '
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 			SET forum_posts = forum_posts + 1 
 			WHERE forum_id = ' . $forum_id;
 		$_CLASS['core_db']->query($sql);
@@ -202,7 +202,7 @@
 		$min_post_time = time() - ($sort_days * 86400);
 
 		$sql = 'SELECT COUNT(topic_id) AS num_topics
-			FROM ' . TOPICS_TABLE . "
+			FROM ' . FORUMS_TOPICS_TABLE . "
 			WHERE forum_id = $forum_id
 				AND topic_type <> " . POST_ANNOUNCE . "  
 				AND topic_last_post_time >= $min_post_time
@@ -232,12 +232,14 @@
 
 	// Basic pagewide vars
 	$post_alt = ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->lang['FORUM_LOCKED'] : $_CLASS['core_user']->lang['POST_NEW_TOPIC'];
+	$pagination = generate_pagination("Forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param", $topics_count, $config['topics_per_page'], $start);
 
-	$_CLASS['core_template']->assign(array(
-		'PAGINATION'	=> generate_pagination(generate_link("Forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param"), $topics_count, $config['topics_per_page'], $start),
-		'PAGE_NUMBER'	=> on_page($topics_count, $config['topics_per_page'], $start),
-		'TOTAL_TOPICS'	=> ($forum_data['forum_flags'] & 16) ? false : (($topics_count == 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count)),
-		'MODERATORS'	=> (!empty($moderators[$forum_id])) ? implode(', ', $moderators[$forum_id]) : '',
+	$_CLASS['core_template']->assign_array(array(
+		'PAGINATION'		=> $pagination['formated'],
+		'PAGINATION_ARRAY'	=> $pagination['array'],
+		'PAGE_NUMBER'		=> on_page($topics_count, $config['topics_per_page'], $start),
+		'TOTAL_TOPICS'		=> ($forum_data['forum_flags'] & 16) ? false : (($topics_count == 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count)),
+		'MODERATORS'		=> (!empty($moderators[$forum_id])) ? implode(', ', $moderators[$forum_id]) : '',
 
 		'POST_IMG' 				=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', $post_alt) : $_CLASS['core_user']->img('btn_post', $post_alt),
 		'FOLDER_IMG' 			=> $_CLASS['core_user']->img('folder', 'NO_NEW_POSTS'),
@@ -276,13 +278,12 @@
 	);
 
 	// Grab icons
-	$icons = array();
-	obtain_icons($icons);
+	$icons = obtain_icons();
 
 	// Grab all topic data
 	$rowset = $announcement_list = $topic_list = array();
 
-	$sql_from = TOPICS_TABLE.' t ';
+	$sql_from = FORUMS_TOPICS_TABLE.' t ';
 	$sql_from .= ($_CLASS['core_user']->is_user && $config['load_db_lastread']) ? ' LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')' : '';
 
 	$sql_approved = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1';
@@ -421,6 +422,8 @@
 			// Generate all the URIs ...
 			$view_topic_url = 'Forums&amp;file=viewtopic&amp;t='.$topic_id;
 
+			$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;&amp;t='.$topic_id, $replies, $config['posts_per_page']);
+
 			// Send vars to template
 			$_CLASS['core_template']->assign_vars_array('topicrow', array(
 				'FORUM_ID' 			=> $forum_id,
@@ -430,7 +433,8 @@
 				'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 				'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
 				'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
-				'PAGINATION'		=> topic_generate_pagination($replies, 'Forums&amp;file=viewtopic&amp;&amp;t='.$topic_id),
+				'PAGINATION'		=> $pagination['formated'],
+				'PAGINATION_ARRAY'	=> $pagination['array'],
 				'REPLIES' 			=> $replies,
 				'VIEWS' 			=> $row['topic_views'],
 				'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
@@ -471,7 +475,7 @@
 }
 else
 {
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_IS_POSTABLE'			=> false,
 		'S_DISPLAY_ACTIVE'		=> false,
 		'S_DISPLAY_SEARCHBOX'	=> false,

Modified: trunk/modules/Forums/viewtopic.php
===================================================================
--- trunk/modules/Forums/viewtopic.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/viewtopic.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 // -------------------------------------------------------------
 //
@@ -17,7 +25,7 @@
 //
 // FILENAME  : viewtopic.php 
 // STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : ? 2001, 2003 phpBB Group
+// COPYRIGHT : 2001, 2003 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 
@@ -55,12 +63,12 @@
 
 if ($topic_id)
 {
-	$sql = 'SELECT forum_id FROM ' . TOPICS_TABLE . '
+	$sql = 'SELECT forum_id, topic_last_post_time FROM ' . FORUMS_TOPICS_TABLE . '
 		WHERE topic_id = '.$topic_id;
 }
 else
 {
-	$sql = 'SELECT forum_id, topic_id FROM ' . POSTS_TABLE . '
+	$sql = 'SELECT forum_id, topic_id FROM ' . FORUMS_POSTS_TABLE . '
 		WHERE post_id = '.$post_id;
 }
 
@@ -68,17 +76,15 @@
 $row = $_CLASS['core_db']->fetch_row_assoc($result);
 $_CLASS['core_db']->free_result($result);
 
-if ($row)
+if (!$row)
 {
-	$forum_id = $row['forum_id'];
-	$topic_id = ($topic_id) ? $topic_id : $row['topic_id'];
-}
-else
-{
 	trigger_error('NO_TOPIC');
 }
 
-/*
+$forum_id = $row['forum_id'];
+$topic_id = ($topic_id) ? $topic_id : $row['topic_id'];
+$topic_last_post_time = isset($row['topic_last_post_time']) ? $row['topic_last_post_time'] : false;
+
 if ($view)
 {
 	if ($view == 'unread')
@@ -101,8 +107,8 @@
 			// Setup user environment so we can process lang string
 			$_CLASS['core_user']->add_lang('viewtopic');
 
-			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id"));
-			$message = $_CLASS['core_user']->lang['NO_UNREAD_POSTS'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id").'">', '</a>');
+			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id"));
+			$message = $_CLASS['core_user']->lang['NO_UNREAD_POSTS'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id").'">', '</a>');
 			trigger_error($message);
 		}
 
@@ -111,16 +117,34 @@
 	}
 	elseif ($view == 'next' || $view == 'previous')
 	{
-		$sql_condition = ($view == 'next') ? '>' : '<';
-		$sql_ordering = ($view == 'next') ? 'ASC' : 'DESC';
+		if ($view == 'next')
+		{
+			$sql_condition = '>';
+			$sql_ordering = 'ASC';
+		}
+		else
+		{
+			$sql_condition = '<';
+			$sql_ordering = 'DESC';
+		}
 
-		$sql = 'SELECT t.topic_id, t.forum_id
-			FROM ' . TOPICS_TABLE . ' t, ' . TOPICS_TABLE . " t2
-			WHERE t2.topic_id = $topic_id
-				AND t.forum_id = t2.forum_id
-				" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . "
-				AND t.topic_last_post_time $sql_condition t2.topic_last_post_time
-			ORDER BY t.topic_last_post_time $sql_ordering";
+		if (!$topic_last_post_time)
+		{
+			$sql = 'SELECT topic_last_post_time FROM ' . FORUMS_TOPICS_TABLE . '
+						WHERE topic_id = '.$topic_id;
+
+			$result = $_CLASS['core_db']->query($sql);
+			list($topic_last_post_time) = $_CLASS['core_db']->fetch_row_num($result);
+			$_CLASS['core_db']->free_result($result);
+		}
+
+// should we only find the next topic with in the forum ?
+		$sql = 'SELECT topic_id, forum_id
+			FROM ' . FORUMS_TOPICS_TABLE . "
+			 WHERE forum_id = $forum_id AND topic_last_post_time $sql_condition $topic_last_post_time"
+			 . ($_CLASS['auth']->acl_get('m_approve', $forum_id) ? '' : ' AND topic_approved = 1') . "
+			ORDER BY topic_last_post_time $sql_ordering";
+	
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
@@ -133,19 +157,10 @@
 		else
 		{
 			$topic_id = $row['topic_id'];
-	
-			// Check for global announcement correctness?
-			if (!$row['forum_id'] && !$forum_id)
-			{
-				trigger_error('NO_TOPIC');
-			}
-			else if ($row['forum_id'])
-			{
-				$forum_id = $row['forum_id'];
-			}
+			$forum_id = $row['forum_id'];
 		}
 	}
-}*/
+}
 
 /*
 if (!$post_id)
@@ -175,7 +190,7 @@
 	if ($config['allow_bookmarks'])
 	{
 		$extra_fields .= ', bm.order_id as bookmarked';
-		$join_sql_table .= ' LEFT JOIN ' . BOOKMARKS_TABLE . ' bm ON (bm.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+		$join_sql_table .= ' LEFT JOIN ' . FORUMS_BOOKMARKS_TABLE . ' bm ON (bm.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 			AND t.topic_id = bm.topic_id)';
 	}
 }
@@ -187,7 +202,7 @@
 	f.forum_name, f.forum_desc, f.forum_parents, f.parent_id, f.left_id, f.right_id, f.forum_status, f.forum_type,
 	f.forum_id, f.forum_password, f.forum_rules, f.forum_rules_link, f.forum_rules_flags, f.forum_rules_bbcode_uid,
 	f.forum_rules_bbcode_bitfield' . $extra_fields . '
-		FROM ' . FORUMS_TABLE . ' f, ' . TOPICS_TABLE . " t  $join_sql_table 
+		FROM ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . " t  $join_sql_table 
 		WHERE t.topic_id = $topic_id";
 
 $result = $_CLASS['core_db']->query($sql);
@@ -220,11 +235,11 @@
 {
 	if (!$topic_data['bookmarked'])
 	{
-		$sql = 'INSERT INTO ' . BOOKMARKS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+		$sql = 'INSERT INTO ' . FORUMS_BOOKMARKS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 			'user_id'	=> $_CLASS['core_user']->data['user_id'],
 			'topic_id'	=> $topic_id,
-			'order_id'	=> 0)
-		);
+			'order_id'	=> 0
+		));
 		$_CLASS['core_db']->query($sql);
 
 		$where_sql = '';
@@ -232,7 +247,7 @@
 	}
 	else
 	{
-		$sql = 'DELETE FROM ' . BOOKMARKS_TABLE . ' 
+		$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . ' 
 			WHERE user_id = '.$_CLASS['core_user']->data['user_id'].'
 				AND order_id = '.$topic_data['bookmarked'];
 		$_CLASS['core_db']->query($sql);
@@ -243,15 +258,16 @@
 	}
 
 	// Re-Sort Bookmarks
-	$sql = 'UPDATE ' . BOOKMARKS_TABLE . "
+	$sql = 'UPDATE ' . FORUMS_BOOKMARKS_TABLE . "
 		SET order_id = order_id $sign 1
 			WHERE user_id = {$_CLASS['core_user']->data['user_id']}
 			$where_sql";
 	$_CLASS['core_db']->query($sql);
 
-	$_CLASS['core_display']->meta_refresh(3, generate_link($viewtopic_url, false));
-	$message = (($topic_data['bookmarked']) ? $_CLASS['core_user']->lang['BOOKMARK_REMOVED'] : $_CLASS['core_user']->lang['BOOKMARK_ADDED']) . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="' . generate_link($viewtopic_url, false) . '">', '</a>');
-	trigger_error($message);
+	$topic_data['bookmarked'] = ($topic_data['bookmarked']) ? false : true;
+//	$_CLASS['core_display']->meta_refresh(3, generate_link($viewtopic_url, false));
+//	$message = (($topic_data['bookmarked']) ? $_CLASS['core_user']->lang['BOOKMARK_REMOVED'] : $_CLASS['core_user']->lang['BOOKMARK_ADDED']) . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="' . generate_link($viewtopic_url, false) . '">', '</a>');
+//	trigger_error($message);
 }
 
 // We make this check here because the correct forum_id is determined
@@ -265,7 +281,7 @@
 // Check sticky/announcement time limit
 if (($topic_data['topic_type'] == POST_STICKY || $topic_data['topic_type'] == POST_ANNOUNCE) && $topic_data['topic_time_limit'] && $topic_data['topic_time'] + $topic_data['topic_time_limit'] < $_CLASS['core_user']->time)
 {
-	$sql = 'UPDATE ' . TOPICS_TABLE . ' 
+	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' 
 		SET topic_type = ' . POST_NORMAL . ', topic_time_limit = 0
 		WHERE topic_id = ' . $topic_id;
 
@@ -307,7 +323,7 @@
 	$min_post_time = time() - ($sort_days * 86400);
 
 	$sql = 'SELECT COUNT(post_id) AS num_posts
-		FROM ' . POSTS_TABLE . "
+		FROM ' . FORUMS_POSTS_TABLE . "
 		WHERE topic_id = $topic_id
 			AND post_time >= $min_post_time
 		" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND post_approved = 1');
@@ -383,17 +399,20 @@
 $topic_mod .= ($_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_GLOBAL) ? '<option value="make_global">' . $_CLASS['core_user']->lang['MAKE_GLOBAL'] . '</option>' : '';
 $topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="viewlogs">' . $_CLASS['core_user']->lang['VIEW_TOPIC_LOGS'] . '</option>' : '';
 
+$pagination = generate_pagination("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : ''), $total_posts, $config['posts_per_page'], $start);
+
 // Send vars to template
-$_CLASS['core_template']->assign(array(
+$_CLASS['core_template']->assign_array(array(
 	'FORUM_ID' 		=> $forum_id,
 	'FORUM_NAME' 	=> $topic_data['forum_name'],
 	'FORUM_DESC'	=> $topic_data['forum_desc'],
 	'TOPIC_ID' 		=> $topic_id,
 	'TOPIC_TITLE' 	=> censor_text($topic_data['topic_title']),
-	'PAGINATION' 	=> generate_pagination("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : ''), $total_posts, $config['posts_per_page'], $start),
+	'PAGINATION'		=> $pagination['formated'],
+	'PAGINATION_ARRAY'	=> $pagination['array'],
 	'PAGE_NUMBER' 	=> on_page($total_posts, $config['posts_per_page'], $start),
 	'TOTAL_POSTS'	=> ($total_posts == 1) ? $_CLASS['core_user']->lang['VIEW_TOPIC_POST'] : sprintf($_CLASS['core_user']->lang['VIEW_TOPIC_POSTS'], $total_posts), 
-	'U_MCP' 		=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link("Forums&amp;file=mcp&amp;mode=topic_view&amp;f=$forum_id&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param", false, false) : '',
+	'U_MCP' 		=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link("Forums&amp;file=mcp&amp;mode=topic_view&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param", false, false) : '',
 
 	'MODERATORS'	=> (isset($forum_moderators[$forum_id]) && sizeof($forum_moderators[$forum_id])) ? implode(', ', $forum_moderators[$forum_id]) : '',
 
@@ -420,19 +439,19 @@
 	'S_SELECT_SORT_DIR' 	=> $s_sort_dir,
 	'S_SELECT_SORT_KEY' 	=> $s_sort_key,
 	'S_SELECT_SORT_DAYS' 	=> $s_limit_days,
-	'S_TOPIC_ACTION' 		=> generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;start=$start"),
+	'S_TOPIC_ACTION' 		=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;start=$start"),
 	'S_TOPIC_MOD' 			=> ($topic_mod != '') ? '<select name="mode">' . $topic_mod . '</select>' : '',
-	'S_MOD_ACTION' 			=> generate_link("Forums&amp;file=mcp&amp;t=$topic_id&amp;f=$forum_id&amp;quickmod=1", false, false), 
+	'S_MOD_ACTION' 			=> generate_link("Forums&amp;file=mcp&amp;t=$topic_id&amp;quickmod=1", false, false), 
 
 	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['auth']->acl_get('f_search', $forum_id)) ? true : false, 
 	'S_SEARCHBOX_ACTION'	=> generate_link('Forums&amp;file=search&amp;search_forum[]='.$forum_id), 
 
-	'U_TOPIC'				=> (!$view == 'print') ? generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id") : generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id", true, true),
-	'U_VIEW_UNREAD_POST'	=> generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread").'#unread',
+	'U_TOPIC'				=> ($view == 'print') ? generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id, array('full' => true)) : generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id),
+	'U_VIEW_UNREAD_POST'	=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread").'#unread',
 	'U_VIEW_TOPIC' 			=> generate_link($viewtopic_url, false),
 	'U_VIEW_FORUM' 			=> generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id),
-	'U_VIEW_OLDER_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=previous"),
-	'U_VIEW_NEWER_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=next"),
+	'U_VIEW_OLDER_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=previous"),
+	'U_VIEW_NEWER_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=next"),
 	'U_PRINT_TOPIC'			=> ($_CLASS['auth']->acl_get('f_print', $forum_id)) ? generate_link($viewtopic_url . '&amp;view=print', false) : '',
 	'U_EMAIL_TOPIC'			=> ($_CLASS['auth']->acl_get('f_email', $forum_id) && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;t='.$topic_id) : '', 
 
@@ -443,15 +462,15 @@
 	'L_BOOKMARK_TOPIC'		=> ($_CLASS['core_user']->is_user && $config['allow_bookmarks'] && $topic_data['bookmarked']) ? $_CLASS['core_user']->lang['BOOKMARK_TOPIC_REMOVE'] : $_CLASS['core_user']->lang['BOOKMARK_TOPIC'],
 	
 	'U_POST_NEW_TOPIC' 		=> generate_link('Forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id),
-	'U_POST_REPLY_TOPIC' 	=> generate_link("Forums&amp;file=posting&amp;mode=reply&amp;f=$forum_id&amp;t=$topic_id"),
-	'U_BUMP_TOPIC'			=> (bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=bump&amp;f=$forum_id&amp;t=$topic_id") : '')
+	'U_POST_REPLY_TOPIC' 	=> generate_link("Forums&amp;file=posting&amp;mode=reply&amp;t=$topic_id"),
+	'U_BUMP_TOPIC'			=> (bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id") : '')
 );
 
 // Does this topic contain a poll?
 if (!empty($poll_start))
 {
 	$sql = 'SELECT o.*, p.bbcode_bitfield, p.bbcode_uid
-		FROM ' . POLL_OPTIONS_TABLE . ' o, ' . POSTS_TABLE . " p
+		FROM ' . FORUMS_POLL_OPTIONS_TABLE . ' o, ' . FORUMS_POSTS_TABLE . " p
 		WHERE o.topic_id = $topic_id 
 			AND p.post_id = $topic_first_post_id
 			AND p.topic_id = o.topic_id
@@ -469,7 +488,7 @@
 	if ($_CLASS['core_user']->is_user)
 	{
 		$sql = 'SELECT poll_option_id
-			FROM ' . POLL_VOTES_TABLE . '
+			FROM ' . FORUMS_POLL_VOTES_TABLE . '
 			WHERE topic_id = ' . $topic_id . '
 				AND vote_user_id = ' . $_CLASS['core_user']->data['user_id'];
 		$result = $_CLASS['core_db']->query($sql);
@@ -503,10 +522,10 @@
 	{
 		if (!sizeof($voted_id) || sizeof($voted_id) > $poll_max_options)
 		{
-			$_CLASS['core_display']->meta_refresh(5, generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id"));
+			$_CLASS['core_display']->meta_refresh(5, generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id"));
 
 			$message = (!sizeof($voted_id)) ? 'NO_VOTE_OPTION' : 'TOO_MANY_VOTE_OPTIONS';
-			$message = $_CLASS['core_user']->lang[$message] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id").'">', '</a>');
+			$message = $_CLASS['core_user']->lang[$message] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id").'">', '</a>');
 			trigger_error($message);
 		}
 
@@ -517,7 +536,7 @@
 				continue;
 			}
 
-			$sql = 'UPDATE ' . POLL_OPTIONS_TABLE . " 
+			$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . " 
 				SET poll_option_total = poll_option_total + 1 
 				WHERE poll_option_id = $option 
 					AND topic_id = $topic_id";
@@ -525,7 +544,7 @@
 
 			if ($_CLASS['core_user']->is_user)
 			{
-				$sql = 'INSERT INTO  ' . POLL_VOTES_TABLE . " (topic_id, poll_option_id, vote_user_id, vote_user_ip) 
+				$sql = 'INSERT INTO  ' . FORUMS_POLL_VOTES_TABLE . " (topic_id, poll_option_id, vote_user_id, vote_user_ip) 
 					VALUES ($topic_id, $option, " . $_CLASS['core_user']->data['user_id'] . ", '".$_CLASS['core_user']->ip."')";
 				$_CLASS['core_db']->query($sql);
 			}
@@ -535,7 +554,7 @@
 		{
 			if (!in_array($option, $voted_id))
 			{
-				$sql = 'UPDATE ' . POLL_OPTIONS_TABLE . " 
+				$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . " 
 					SET poll_option_total = poll_option_total - 1 
 					WHERE poll_option_id = $option 
 						AND topic_id = $topic_id";
@@ -543,7 +562,7 @@
 
 				if ($_CLASS['core_user']->is_user)
 				{
-					$sql = 'DELETE FROM ' . POLL_VOTES_TABLE . " 
+					$sql = 'DELETE FROM ' . FORUMS_POLL_VOTES_TABLE . " 
 						WHERE topic_id = $topic_id
 							AND poll_option_id = $option 
 							AND vote_user_id = " . $_CLASS['core_user']->data['user_id'];
@@ -557,15 +576,15 @@
 			$_CLASS['core_user']->set_cookie('poll_' . $topic_id, implode(',', $voted_id), time() + 31536000);
 		}
 
-		$sql = 'UPDATE ' . TOPICS_TABLE . ' 
+		$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' 
 			SET poll_last_vote = ' . time() . " 
 			WHERE topic_id = $topic_id";
 			//, topic_last_post_time = ' . time() . " -- for bumping topics with new votes, ignore for now
 		$_CLASS['core_db']->query($sql);
 
-		$_CLASS['core_display']->meta_refresh(5, generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id"));
+		$_CLASS['core_display']->meta_refresh(5, generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id"));
 
-		$message = $_CLASS['core_user']->lang['VOTE_SUBMITTED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id").'">', '</a>');
+		$message = $_CLASS['core_user']->lang['VOTE_SUBMITTED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id").'">', '</a>');
 		trigger_error($message);
 	}
 
@@ -611,7 +630,7 @@
 		);
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'POLL_QUESTION'		=> $poll_title,
 		'TOTAL_VOTES' 		=> $poll_total,
 		'POLL_LEFT_CAP_IMG'	=> $_CLASS['core_user']->img('poll_left'),
@@ -667,7 +686,7 @@
 
 // Go ahead and pull all data for this topic
 $sql = 'SELECT p.post_id
-	FROM ' . POSTS_TABLE . ' p' . (($sort_by_sql[$sort_key]{0} == 'u') ? ', ' . USERS_TABLE . ' u': '') . "
+	FROM ' . FORUMS_POSTS_TABLE . ' p' . (($sort_by_sql[$sort_key]{0} == 'u') ? ', ' . USERS_TABLE . ' u': '') . "
 	WHERE p.topic_id = $topic_id
 		" . ((!$_CLASS['auth']->acl_get('m_approve', $forum_id)) ? 'AND p.post_approved = 1' : '') . "
 		" . (($sort_by_sql[$sort_key]{0} == 'u') ? 'AND u.user_id = p.poster_id': '') . "
@@ -691,7 +710,7 @@
 }
 
 $sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_posts, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_jabber, u.user_regdate, u.user_msnm, u.user_allow_viewemail, u.user_allow_viewonline, u.user_rank, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height, z.friend, z.foe, p.*
-	FROM ' . POSTS_TABLE . ' p
+	FROM ' . FORUMS_POSTS_TABLE . ' p
 	LEFT JOIN ' . ZEBRA_TABLE . ' z ON (z.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' AND z.zebra_id = p.poster_id), ' . USERS_TABLE . ' u
 	WHERE p.post_id IN (' . implode(', ', $post_list) . ')
 		AND u.user_id = p.poster_id';
@@ -900,10 +919,10 @@
 // Generate online information for user
 if ($config['load_onlinetrack'] && sizeof($id_cache))
 {
-	$sql = 'SELECT session_user_id, session_viewonline, MAX(session_time) as online_time
+	$sql = 'SELECT session_user_id, session_hidden, MAX(session_time) as online_time
 		FROM ' . SESSIONS_TABLE . ' 
 		WHERE session_user_id IN (' . implode(', ', $id_cache) . ')
-		GROUP BY session_user_id, session_viewonline';
+		GROUP BY session_user_id, session_hidden';
 
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -911,7 +930,7 @@
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$user_cache[$row['session_user_id']]['online'] = (time() - $update_time < $row['online_time'] && ($row['session_viewonline'] || $_CLASS['auth']->acl_get('u_viewonline'))) ? true : false;
+		$user_cache[$row['session_user_id']]['online'] = (time() - $update_time < $row['online_time'] && (!$row['session_hidden']));
 	}
 }
 unset($id_cache);
@@ -924,7 +943,7 @@
 		include($site_file_root.'includes/forums/functions_display.php');
 
 		$sql = 'SELECT * 
-			FROM ' . ATTACHMENTS_TABLE . '
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 			WHERE post_msg_id IN (' . implode(', ', $attach_list) . ')
 				AND in_message = 0
 			ORDER BY filetime ' . ((!$config['display_order']) ? 'DESC' : 'ASC') . ', post_msg_id ASC';
@@ -939,7 +958,7 @@
 		// No attachments exist, but post table thinks they do so go ahead and reset post_attach flags
 		if (!sizeof($attachments))
 		{
-			$sql = 'UPDATE ' . POSTS_TABLE . ' 
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . ' 
 				SET post_attachment = 0 
 				WHERE post_id IN (' . implode(', ', $attach_list) . ')';
 			$_CLASS['core_db']->query($sql);
@@ -949,7 +968,7 @@
 			{
 				// Not all posts are displayed so we query the db to find if there's any attachment for this topic
 				$sql = 'SELECT a.post_msg_id as post_id
-					FROM ' . ATTACHMENTS_TABLE . ' a, ' . POSTS_TABLE . " p
+					FROM ' . FORUMS_ATTACHMENTS_TABLE . ' a, ' . POSTS_TABLE . " p
 					WHERE p.topic_id = $topic_id
 						AND p.post_approved = 1
 						AND p.topic_id = a.topic_id";
@@ -957,7 +976,7 @@
 
 				if (!$_CLASS['core_db']->fetch_row_assoc($result))
 				{
-					$sql = 'UPDATE ' . TOPICS_TABLE . " 
+					$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . " 
 						SET topic_attachment = 0 
 						WHERE topic_id = $topic_id";
 					$_CLASS['core_db']->query($sql);
@@ -965,7 +984,7 @@
 			}
 			else
 			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . " 
+				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . " 
 					SET topic_attachment = 0 
 					WHERE topic_id = $topic_id";
 				$_CLASS['core_db']->query($sql);
@@ -974,7 +993,7 @@
 		elseif ($has_attachments && !$topic_data['topic_attachment'])
 		{
 			// Topic has approved attachments but its flag is wrong
-			$sql = 'UPDATE ' . TOPICS_TABLE . " 
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . " 
 				SET topic_attachment = 1 
 				WHERE topic_id = $topic_id";
 			$_CLASS['core_db']->query($sql);
@@ -995,12 +1014,10 @@
 	$bbcode = new bbcode($bbcode_bitfield);
 }
 
-$i_total = sizeof($rowset) - 1;
+$i_total = count($rowset) - 1;
 $prev_post_id = '';
 
-$_CLASS['core_template']->assign(array(
-	'S_NUM_POSTS' => sizeof($post_list))
-);
+$_CLASS['core_template']->assign('S_NUM_POSTS', count($post_list));
 
 // Output the posts
 //foreach ($rowset as $i => $row)
@@ -1014,7 +1031,7 @@
 	{
 		$_CLASS['core_template']->assign_vars_array('postrow', array(
 			'S_IGNORE_POST' => true, 
-			'L_IGNORE_POST' => sprintf($_CLASS['core_user']->lang['POST_BY_FOE'], $row['poster'], '<a href="'.generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=" . $row['post_id'] . '&amp;view=show') . '#' . $row['post_id'] . '">', '</a>'))
+			'L_IGNORE_POST' => sprintf($_CLASS['core_user']->lang['POST_BY_FOE'], $row['poster'], '<a href="'.generate_link("forums&amp;file=viewtopic&amp;p=" . $row['post_id'] . '&amp;view=show') . '#' . $row['post_id'] . '">', '</a>'))
 		);
 
 		continue;
@@ -1092,7 +1109,7 @@
 			$post_storage_list = (!$store_reverse) ? array_slice($post_list, $i) : array_slice(array_reverse($post_list), $i);
 
 			$sql = 'SELECT DISTINCT u.user_id, u.username, u.user_colour 
-				FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 				WHERE p.post_id IN (' . implode(', ', $post_storage_list) . ")
 					AND p.post_edit_count <> 0
 					AND p.post_edit_user <> 0
@@ -1119,28 +1136,19 @@
 	}
 
 	// Bump information
-	if ($topic_data['topic_bumped'] && $row['post_id'] == $topic_last_post_id)
+	if ($topic_data['topic_bumped'] && $row['post_id'] == $topic_data['topic_last_post_id'])
 	{
 		// It is safe to grab the username from the user cache array, we are at the last 
 		// post and only the topic poster and last poster are allowed to bump
-		$l_bumped_by = '<br /><br />' . sprintf($_CLASS['core_user']->lang['BUMPED_BY'], $user_cache[$topic_bumper]['username'], $_CLASS['core_user']->format_date($topic_data['topic_last_post_time']));
+		$l_bumped_by = '<br /><br />' . sprintf($_CLASS['core_user']->lang['BUMPED_BY'], $user_cache[$topic_data['topic_bumper']]['username'], $_CLASS['core_user']->format_date($topic_data['topic_last_post_time']));
 	}
 	else
 	{
 		$l_bumped_by = '';
 	}
 
-	$cp_row = array();
-
-	if ($config['load_cpf_viewtopic'])
+	if (empty($icons[$row['icon_id']]))
 	{
-		$cp_row = (isset($profile_fields_cache[$poster_id])) ? $cp->generate_profile_fields_template('show', false, $profile_fields_cache[$poster_id]) : array();
-	}
-	
-	$can_rate = false;
-	
-	if (empty($row['icon_id']) || empty($icons[$row['icon_id']]))
-	{
 		$icons[$row['icon_id']] = array('img' => '' , 'width' => '', 'height' => '');
 	}
 
@@ -1187,10 +1195,10 @@
 
 		'ONLINE_IMG'		=> ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? '' : (($user_cache[$poster_id]['online']) ? $_CLASS['core_user']->img('btn_online', 'ONLINE') : $_CLASS['core_user']->img('btn_offline', 'OFFLINE')), 
 
-		'U_EDIT' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_edit', $forum_id) && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_edit', $forum_id)) ? generate_link("Forums&amp;file=posting&amp;mode=edit&amp;f=$forum_id&amp;p=" . $row['post_id']) : '',
-		'U_QUOTE' 			=> ($_CLASS['auth']->acl_get('f_quote', $forum_id)) ? generate_link("Forums&amp;file=posting&amp;mode=quote&amp;f=$forum_id&amp;p=" . $row['post_id']) : '', 
+		'U_EDIT' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_edit', $forum_id) && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_edit', $forum_id)) ? generate_link("Forums&amp;file=posting&amp;mode=edit&amp;p=" . $row['post_id']) : '',
+		'U_QUOTE' 			=> ($_CLASS['auth']->acl_get('f_quote', $forum_id)) ? generate_link("Forums&amp;file=posting&amp;mode=quote&amp;p=" . $row['post_id']) : '', 
 		'U_INFO'            => ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id'], false, false) : '',
-		'U_DELETE' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_delete', $forum_id) && $topic_data['topic_last_post_id'] == $row['post_id'] && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_delete', $forum_id)) ? generate_link("Forums&amp;file=posting&amp;mode=delete&amp;f=$forum_id&amp;p=" . $row['post_id']) : '',
+		'U_DELETE' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_delete', $forum_id) && $topic_data['topic_last_post_id'] == $row['post_id'] && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_delete', $forum_id)) ? generate_link("Forums&amp;file=posting&amp;mode=delete&amp;p=" . $row['post_id']) : '',
 
 		'U_PROFILE' 		=> $user_cache[$poster_id]['profile'],
 		'U_SEARCH' 			=> $user_cache[$poster_id]['search'],
@@ -1219,25 +1227,11 @@
 		'S_FRIEND'			=> ($row['friend']) ? true : false,
 		'S_UNREAD_POST'		=> $unread,
 		'S_FIRST_UNREAD'	=> ($unread_post_id == $row['post_id']) ? true : false,
-		'S_CUSTOM_FIELDS'	=> (isset($cp_row['row']) && sizeof($cp_row['row'])) ? true : false
 	);
 
-	if (isset($cp_row['row']) && sizeof($cp_row['row']))
-	{
-		$postrow = array_merge($postrow, $cp_row['row']);
-	}
-	
 	// Dump vars into template
 	$_CLASS['core_template']->assign_vars_array('postrow', $postrow);
 	
-	if (isset($cp_row['blockrow']) && sizeof($cp_row['blockrow']))
-	{
-		foreach ($cp_row['blockrow'] as $field_data)
-		{
-			//$_CLASS['core_template']->assign_vars_array('postrow.custom_fields', $field_data);
-		}
-	}
-
 	$prev_post_id = $row['post_id'];
 
 	unset($rowset[$i], $post_attachments);
@@ -1249,17 +1243,19 @@
 
 // Update topic view and if necessary attachment view counters ... but only
 // if this is the first 'page view'
-if (isset($_CLASS['core_user']->data['session_page']) && !preg_match("#&t=$topic_id#", $_CLASS['core_user']->data['session_page']))
+
+//mb_strpos() should never be 0 here
+if (!mb_strpos($_CLASS['core_user']->data['session_url'], '&amp;t='.$topic_id))
 {
-	$sql = 'UPDATE ' . TOPICS_TABLE . '
-		SET topic_views = topic_views + 1, topic_last_view_time = ' . time() . "
+	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+		SET topic_views = topic_views + 1, topic_last_view_time = ' . gmtime() . "
 		WHERE topic_id = $topic_id";
 	$_CLASS['core_db']->query($sql);
 
 	// Update the attachment download counts
 	if (sizeof($update_count))
 	{
-		$sql = 'UPDATE ' . ATTACHMENTS_TABLE . ' 
+		$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
 			SET download_count = download_count + 1 
 			WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
 		$_CLASS['core_db']->query($sql);
@@ -1272,61 +1268,53 @@
 	// Now lets get the all topics that are in the markable range,
 	// with is the max topics displayed on the forum's viewforum page
 // Need forum_topic_per_page along with whatever users have to after listing
-// Global posts make us do this when not needed :-(
-	if ($topic_data['topic_type'] == POST_GLOBAL)
-	{
-		// temp
-		markread('topic', 0, $topic_id, $update_mark);
-	}
-	else
-	{
-		// Get the user's last mark time for this forums
-		$sql = 'SELECT mark_time FROM '.FORUMS_TRACK_TABLE . ' 
-			WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-				AND forum_id = $forum_id AND topic_id = 0";
 
-		$result = $_CLASS['core_db']->query($sql);
-		$forum_marktime = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['mark_time'] : 0;
-		$_CLASS['core_db']->free_result($result);
-			
-		$sql = 'SELECT t.topic_id, t.topic_last_post_time, tr.mark_time FROM ' . TOPICS_TABLE . ' t
-				LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tr ON ( tr.topic_id = t.topic_id AND tr.user_id = '.$_CLASS['core_user']->data['user_id'].")
-					WHERE t.forum_id = $forum_id
-						ORDER BY topic_last_post_time DESC";
+	// Get the user's last mark time for this forums
+	$sql = 'SELECT mark_time FROM '.FORUMS_TRACK_TABLE . ' 
+		WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . " 
+			AND forum_id = $forum_id AND topic_id = 0";
 
-		$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page']);
-		$update_forum_mark = true;
-	
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			// DESC order so the first post is the last post
-			$last_forum_post = $row['topic_last_post_time'];
+	$result = $_CLASS['core_db']->query($sql);
+	$forum_marktime = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['mark_time'] : 0;
+	$_CLASS['core_db']->free_result($result);
+		
+	$sql = 'SELECT t.topic_id, t.topic_last_post_time, tr.mark_time FROM ' . FORUMS_TOPICS_TABLE . ' t
+			LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tr ON ( tr.topic_id = t.topic_id AND tr.user_id = '.$_CLASS['core_user']->data['user_id'].")
+				WHERE t.forum_id = $forum_id
+					ORDER BY topic_last_post_time DESC";
 
-			do
+	$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page']);
+	$update_forum_mark = true;
+
+	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		// DESC order so the first post is the last post
+		$last_forum_post = $row['topic_last_post_time'];
+
+		do
+		{
+			$last_mark_time = max($row['mark_time'], $forum_marktime);
+			if ($row['topic_last_post_time'] > $last_mark_time && $row['topic_id'] != $topic_id)
 			{
-				$last_mark_time = max($row['mark_time'], $forum_marktime);
-				if ($row['topic_last_post_time'] > $last_mark_time && $row['topic_id'] != $topic_id)
-				{
-					// We have a winner/loser
-					// Set so the forum isn't marked
-					$update_forum_mark = false;
-					break;
-				}
+				// We have a winner/loser
+				// Set so the forum isn't marked
+				$update_forum_mark = false;
+				break;
 			}
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 		}
-		$_CLASS['core_db']->free_result($result);
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+	}
+	$_CLASS['core_db']->free_result($result);
 
-		// Was this the last unread topic ?
-		if ($update_forum_mark)
-		{
-			markread('forum', $forum_id, 0, $last_forum_post);
-		}
-		else
-		{
-			markread('topic', $forum_id, $topic_id, $update_mark);
-		}
+	// Was this the last unread topic ?
+	if ($update_forum_mark)
+	{
+		markread('forum', $forum_id, 0, $last_forum_post);
 	}
+	else
+	{
+		markread('topic', $forum_id, $topic_id, $update_mark);
+	}
 }
 
 if ($view == 'print')

Modified: trunk/modules/Quick_Message/index.php
===================================================================
--- trunk/modules/Quick_Message/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Quick_Message/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -10,241 +10,227 @@
 //  of the GNU General Public License version 2					//
 //																//
 //**************************************************************//
-$_CORE_CONFIG['quick_message']['delete_time'] = 18000;
 
 if (!defined('VIPERAL'))
 {
     die;
 }
 
-$_CLASS['core_user']->user_setup();
+if (!defined('QUICK_MESSAGE_TABLE'))
+{
+	define('QUICK_MESSAGE_TABLE', 'test_quick_message');
+}
 
 switch (get_variable('mode', 'GET', false))
 {
 	case 'add':
-		add_message();
-		break;
-		
-	case 'all':
-		show_messages(true);
-		
-	case 'delete':
-		delete_message();
+		if (empty($_POST['submit']) || $_CLASS['core_user']->is_bot)
+		{
+			url_redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
+		}
 	
-	default:
-		show_messages();
-		break;
-}
+		$_CLASS['core_user']->user_setup();
+		$_CLASS['core_user']->add_lang();
 
-script_close(false);
+		$message = trim(get_variable('message', 'POST', false));
+		$_CORE_CONFIG['quick_message']['lastpost_check'] = 300;
 
-function add_message()
-{
-	if (empty($_POST['submit']))
-	{
-		return show_messages();
-	}
+		if (!$message)
+		{
+			trigger_error('NO_MESSAGE'); 
+		}
 
-	global $_CLASS, $prefix, $_CORE_CONFIG;
+		$length = mb_strlen($message);
 
-	if ($_CLASS['core_user']->is_bot)
-	{
-		url_redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
-	}
-		
-	$_CLASS['core_user']->add_lang();
-	$_CORE_CONFIG['quick_message']['lastpost_check'] = 300;
+		if ($length > $_CORE_CONFIG['quick_message']['length_max'])
+		{ 
+			trigger_error('LONG_MESSAGE');
+		}
 
-	$user_id = ($_CLASS['core_user']->is_user) ? $_CLASS['core_user']->data['user_id'] : '';
-	$user_name = ($_CLASS['core_user']->is_user) ? $_CLASS['core_user']->data['username'] : get_username();
-	
-    if(!$message = get_variable('message', 'POST', false))
-    {
-		trigger_error($_CLASS['core_user']->lang['NO_MESSAGE']); 
-    }
-    
-    $length = mb_strlen($message);
-    
-    if($length < 2)
-    {
-		trigger_error($_CLASS['core_user']->lang['SHORT_MESSAGE']); 
-    }
-    
-    if($length > $_CORE_CONFIG['quick_message']['maxlength'])
-    { 
-		trigger_error($_CLASS['core_user']->lang['LONG_MESSAGE']);
-    }
+		$message 	= htmlentities($message, ENT_QUOTES, 'UTF-8');
 
-	$message 	= htmlentities($message, ENT_QUOTES, 'UTF-8');
-	$user_name 	= htmlentities($user_name, ENT_QUOTES, 'UTF-8');
+	// use limit
+		$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['lastpost_check']));
+		$count = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 
-    $result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.$prefix."quick_message WHERE message='".$_CLASS['core_db']->escape($message)."' AND time >= '".(time() - $_CORE_CONFIG['quick_message']['lastpost_check'])."'");
-	$count = $_CLASS['core_db']->fetch_row_assoc($result);
-    $_CLASS['core_db']->free_result($result);
+	// add a count check here so it admin ajustable
+		if ($count['count'] > 0)
+		{
+			trigger_error(sprintf($_CLASS['core_user']->lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['lastpost_check'] / 60));
+		}
 
-// add a count check here so it admin ajustable
-    if ($count['count'] > 0)
-    {
-        trigger_error(sprintf($_CLASS['core_user']->lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['lastpost_check'] / 60));
-    }
+		$_CLASS['core_db']->free_result($result);
 
-    $_CLASS['core_db']->free_result($result);
+		if ($_CLASS['core_user']->is_user)
+		{
+			$user_id =  $_CLASS['core_user']->data['user_id'];
+			$user_name = $_CLASS['core_user']->data['username'];
+		}
+		else
+		{
+			$user_id = 0;
+			$user_name = get_username();
+		}
 
-	$sql = 'INSERT INTO '.$prefix.'quick_message ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-		'user_name'	=> (string) $user_name,
-		'user_id'	=> (int) $user_id ,
-		'message'	=> (string) $message,
-		'time'		=> (int)  $_CLASS['core_user']->time,
-		'ip'		=> (string) $_CLASS['core_user']->ip
-	));
-		
-	$_CLASS['core_db']->query($sql);
-	
-	url_redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
-}
+		htmlentities($user_name, ENT_QUOTES, 'UTF-8');
 
-function show_messages($all = false)
-{
-    global $prefix, $_CLASS, $config, $_CORE_CONFIG;
-	
-	$_CLASS['core_user']->add_lang();
-	$_CLASS['core_user']->add_img(false, 'Forums');
+		$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+			'poster_name'	=> (string) $user_name,
+			'poster_id'		=> (int) $user_id,
+			'poster_ip'		=> (string) $_CLASS['core_user']->ip,
+			'message_text'	=> (string) $message,
+			'message_time'	=> (int) $_CLASS['core_user']->time,
+		));
 
-	$start = ($all) ? '' : get_variable('start', 'GET', 0, 'integer');
-	$limit = ($all) ? '' : $_CORE_CONFIG['quick_message']['number'];
-	
-	//$sql = 'SELECT s.*, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height FROM '.$prefix.'quick_message s LEFT JOIN ' . USERS_TABLE . ' u  ON (u.user_id = s.user_id) ORDER BY time DESC';
-	
-	$result = $_CLASS['core_db']->query_limit('SELECT * FROM '.$prefix.'quick_message ORDER BY time DESC', $limit, $start);
-	$error = (!$row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $_CLASS['core_user']->lang['NO_POSTS'] : false;
+		$_CLASS['core_db']->query($sql);
 
-	$_CLASS['core_template']->assign(array(
-		'L_POSTER'			=> $_CLASS['core_user']->lang['POSTER'],
-		'L_POSTED'			=> $_CLASS['core_user']->lang['POSTED'],
-		'L_MESSAGE'			=> $_CLASS['core_user']->lang['MESSAGE'],
-		'L_DELETE'			=> $_CLASS['core_user']->get_lang('DELETE'),
-		'ERROR'				=> $error, 
-		)
-	);
-	
-	if ($error)
-	{
-		$_CLASS['core_template']->display('modules/Quick_Message/index.html');	
-	}
-	
-	do {
-	
-		if ($row['user_name'])
+		redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
+	break;
+
+	case 'delete':
+		global $_CORE_CONFIG, $_CLASS;
+
+		$id = get_variable('id', 'GET', false, 'integer');
+
+		if (!$id)
 		{
-			$user_name = $row['user_name'];
-			$userlink = ($row['user_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']) : false;
+			die;
 		}
-		else
-		{
-			$user_name = $_CLASS['core_user']->lang['ANONYMOUS'];
-			$userlink = false;
-		}
+
+		$result = $_CLASS['core_db']->query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time', 1);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 		
-		$delete_link = '';
-		
-		if ($row['time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
+		if (!$row)
 		{
-			if (($row['user_id'] && $row['user_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['user_id'] && $row['ip'] == $_CLASS['core_user']->ip))
-			{
-				$delete_link = generate_link('Quick_Message&amp;mode=delete&amp;id='.$row['id']);
-			}
+			trigger_error('NO_MESSAGE');
 		}
 
-		$avatar = false;
-		/*if ($row['user_avatar'] && $_CLASS['core_user']->optionget('viewavatars'))
+		$return = true;
+
+		if ($row['message_id'] != $id)
 		{
-			$avatar_img = '';
-			
-			switch ($row['user_avatar_type'])
+			if ($row['message_time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
 			{
-				case AVATAR_UPLOAD:
-					$avatar_img = $config['avatar_path'] . '/';
-					break;
-				case AVATAR_GALLERY:
-					$avatar_img = $config['avatar_gallery_path'] . '/';
-					break;
+				if (($row['poster_id'] && $row['poster_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['poster_id'] && $row['poster_ip'] == $_CLASS['core_user']->ip))
+				{
+					$return = false;
+				}
 			}
-			
-			$avatar_img .= $row['user_avatar'];
-			$avatar = '<img src="' . $avatar_img . '" width="' . $row['user_avatar_width'] . '" height="' . $row['user_avatar_height'] . '" border="0" alt="" />';
-			
 		}
-*/
 
-		if ($row['user_id'])
+		if ($return)
 		{
-			$row['message'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '<a href="$1" target="_blank">$2</a>', $row['message']);
+			trigger_error('MESSAGE_NOT_DELETABLE');
 		}
-		
-		$_CLASS['core_template']->assign_vars_array('quick_message', array(
-			'USER_NAME'		=> $user_name,
-			'USER_LINK'		=> $userlink,
-			'DELETE_LINK'	=> $delete_link,
-			'MESSAGE'		=> modify_lines($row['message'], '<br />'),
-			'TIME'			=> $_CLASS['core_user']->format_date($row['time']),
-			'POSTER_AVATAR' => $avatar,
-			'U_PROFILE' 	=> ($row['user_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['user_id']) : false,
-		));
-		
-	}
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 
-	$result = $_CLASS['core_db']->query('SELECT COUNT(*) AS total from '.$prefix.'quick_message');
-	$row = $_CLASS['core_db']->fetch_row_assoc($result);
-	$_CLASS['core_db']->free_result($result);	
+		$sql = 'DELETE FROM ' . QUICK_MESSAGE_TABLE . ' WHERE message_id = '.$id;
+		$_CLASS['core_db']->query($sql);
 
-	$_CLASS['core_template']->assign(array(
+		//trigger_error('MESSAGE_DELETED');
+		redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
+	break;
+}
+
+$_CLASS['core_user']->user_setup();
+$_CLASS['core_user']->add_lang();
+
+$start = get_variable('start', 'GET', 0, 'integer');
+$limit = 20;
+
+//$sql = 'SELECT s.*, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height FROM '.$prefix.'quick_message s LEFT JOIN ' . USERS_TABLE . ' u  ON (u.user_id = s.user_id) ORDER BY time DESC';
+$result = $_CLASS['core_db']->query_limit('SELECT * FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', $limit, $start);
+$row = $_CLASS['core_db']->fetch_row_assoc($result);
+
+if (!$row)
+{
+	$_CLASS['core_template']->assign_array(array(
 		'Q_MESSAGE_PAGINATION'	=> generate_pagination('Quick_Message', $row['total'], $limit, $start, false, 'Q_MESSAGE_'),
 		'Q_PAGE_NUMBER'			=> on_page($row['total'], $limit, $start),
 		'Q_TOTAL_MESSAGES'		=> $row['total']
 	));
-	
-	$_CLASS['core_template']->display('modules/Quick_Message/index.html');
+
+	$_CLASS['core_display']->display(false, 'modules/Quick_Message/index.html');
+	script_close();
 }
 
-function delete_message()
+$delete_link = '';
+
+if ($row['message_time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
 {
+	if (($row['poster_id'] && $row['poster_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['poster_id'] && $row['poster_ip'] == $_CLASS['core_user']->ip))
+	{
+		$delete_link = generate_link('Quick_Message&amp;mode=delete&amp;id='.$row['message_id']);
+	}
+}
 
-	global $_CORE_CONFIG, $_CLASS, $prefix;
-	
-	$id = (int) get_variable('id', 'GET');
-	
-// we should only delete last message
-	$result = $_CLASS['core_db']->query('SELECT user_id, time, ip FROM '.$prefix.'quick_message WHERE id='.$id);
-	$row = $_CLASS['core_db']->fetch_row_assoc($result);
-	$_CLASS['core_db']->free_result($result);
-	
-	if (!$row)
+do
+{
+	if ($row['poster_name'])
 	{
-		trigger_error('MESSAGE_NOT_FOUND');
+		$user_name = $row['poster_name'];
+		$userlink = ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : false;
 	}
-	
-	$return = true;
-	
-	if ($row['time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
+	else
 	{
-		if (($row['user_id'] && $row['user_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['user_id'] && $row['ip'] == $_CLASS['core_user']->ip))
+		$user_name = $_CLASS['core_user']->lang['ANONYMOUS'];
+		$userlink = false;
+	}
+
+	$avatar = false;
+	/*if ($row['user_avatar'] && $_CLASS['core_user']->optionget('viewavatars'))
+	{
+		$avatar_img = '';
+		
+		switch ($row['user_avatar_type'])
 		{
-			$return = false;
+			case AVATAR_UPLOAD:
+				$avatar_img = $config['avatar_path'] . '/';
+				break;
+			case AVATAR_GALLERY:
+				$avatar_img = $config['avatar_gallery_path'] . '/';
+				break;
 		}
-	}
-	
-	if ($return)
+		
+		$avatar_img .= $row['user_avatar'];
+		$avatar = '<img src="' . $avatar_img . '" width="' . $row['user_avatar_width'] . '" height="' . $row['user_avatar_height'] . '" border="0" alt="" />';
+		
+	}*/
+
+	if ($row['poster_id'])
 	{
-		trigger_error('MESSAGE_NOT_DELETABLE');
+		$row['message'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '<a href="$1" target="_blank">$2</a>', $row['message_text']);
 	}
 	
-	$sql = 'DELETE FROM '.$prefix.'quick_message WHERE id='.$id;
-	$_CLASS['core_db']->query($sql);
+	$_CLASS['core_template']->assign_vars_array('quick_message', array(
+		'USER_NAME'		=> $user_name,
+		'USER_LINK'		=> $userlink,
+		'DELETE_LINK'	=> $delete_link,
+		'MESSAGE'		=> modify_lines($row['message_text'], '<br />'),
+		'TIME'			=> $_CLASS['core_user']->format_date($row['message_time']),
+		'POSTER_AVATAR' => $avatar,
+		'U_PROFILE' 	=> ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['poster_id']) : false,
+	));
 	
-	trigger_error('MESSAGE_DELETED');
+	$delete_link = '';
 }
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 
+$result = $_CLASS['core_db']->query('SELECT COUNT(*) AS total from '.QUICK_MESSAGE_TABLE);
+$row = $_CLASS['core_db']->fetch_row_assoc($result);
+$_CLASS['core_db']->free_result($result);	
+
+$_CLASS['core_template']->assign_array(array(
+	'Q_MESSAGE_PAGINATION'	=> generate_pagination('Quick_Message', $row['total'], $limit, $start, false, 'Q_MESSAGE_'),
+	'Q_PAGE_NUMBER'			=> on_page($row['total'], $limit, $start),
+	'Q_TOTAL_MESSAGES'		=> $row['total']
+));
+
+$_CLASS['core_display']->display(false, 'modules/Quick_Message/index.html');
+	
+script_close();
+
 function get_username()
 {
 
@@ -254,7 +240,7 @@
 
 	if (!$user_name)
 	{
-		if ($_CORE_CONFIG['quick_message']['allow_anonymous'] == '2')
+		if ($_CORE_CONFIG['quick_message']['anonymous_posting'] == '2')
 		{
 			return false;
 			
@@ -277,6 +263,7 @@
 	}
 	
 	require($site_file_root.'includes/forums/functions_user.php');
+
 	if ($error = validate_username($user_name))
 	{
 		trigger_error($error);

Added: trunk/modules/Quick_Message/install.php
===================================================================
--- trunk/modules/Quick_Message/install.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Quick_Message/install.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -0,0 +1,46 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
+
+$_CLASS['core_db']->table_create('start', $install_prefix.'quick_message');
+
+$_CLASS['core_db']->add_table_field_int('message_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_text('message_text', 200);
+field_unix_time('message_time');
+$_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_char('poster_name', 80);
+$_CLASS['core_db']->add_table_field_char('poster_ip', 18);
+
+$_CLASS['core_db']->add_table_index('message_id', 'primary');
+$_CLASS['core_db']->add_table_index('message_time');
+
+$_CLASS['core_db']->table_create('commit');
+
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'anonymous_posting', '2', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'delete_time', '300', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'height', '200', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'last_post_check', '150', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'length_max', '150', 1)");
+
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."quick_message (poster_id, poster_name, poster_ip, message_text, message_time) VALUES (0, 'Site', '', 'Lets do this !', ".gmtime().")");
+
+$installed = true;
+
+?>
\ No newline at end of file

Deleted: trunk/themes/viperal/blockscript.js
===================================================================
--- trunk/themes/viperal/blockscript.js	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/blockscript.js	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,73 +0,0 @@
-function GetCookie(name) {
-  var arg=name+"=";
-  var alen = arg.length;
-  var clen = document.cookie.length;
-  var i  = 0;
-  while (i < clen) {
-    var j = i + alen;
-    if (document.cookie.substring(i,j) == arg)
-      return getCookieVal (j);
-    i = document.cookie.indexOf(" ", i) + 1;
-    if (i == 0) break;
-  }
-  return null;
-}
-function getCookieVal (offset) {
-   var endstr = document.cookie.indexOf (";", offset);
-     if (endstr == 1)
-       endstr = document.cookie.length;
-     return unescape(document.cookie.substring(offset, endstr));
-}
-function SetCookie (name, value, expires) {
-  var exp = new Date();
-  var expiro = (exp.getTime() + (24 * 60 * 60 * 1000 * expires));
-  exp.setTime(expiro);
-  var expstr = "; expires=" + exp.toGMTString();
-  document.cookie = name + "=" + escape(value) + expstr + "; path=/;";
-  //  "domain=webmonkey.com;";
-}
-function DeleteCookie(name){
-  if (GetCookie(name)) {
-    document.cookie = name + "=:; expires = Thu, 01-Jan-70 00:00:01 GMT; path=/;";
-  }
-}
-var imagepath = "images/";
-
-var hiddenblocks = new Array();
-var blocks = GetCookie('hiddenblocks');
-if (blocks != null) {
-  var hidden = blocks.split(":");
-  for (var loop = 0; loop < hidden.length; loop++) {
-    var hiddenblock = hidden[loop];
-    hiddenblocks[hiddenblock] = hiddenblock;
-  }
-}
-hiddenblocks[88]= "88";
-function blockswitch2(bid, min, max) {
-  var bpe  = document.getElementById('pe'+bid);
-  var bico = document.getElementById('pic'+bid);
-  if (bpe.style.display=="none") {
-    bpe.style.display="";
-    hiddenblocks[bid] = null;
-
-  } else {
-    bpe.style.display="none";
-    hiddenblocks[bid] = bid;
-  }
-  
-  var cookie = null;
-  for (var q = 0; q < hiddenblocks.length; q++) {
-    if (hiddenblocks[q] != null) {
-      if (cookie != null) {
-        cookie = (cookie+":"+hiddenblocks[q]);
-      } else {
-        cookie = hiddenblocks[q];
-      }
-    }
-  }
-  if (cookie != null) {
-    SetCookie('hiddenblocks', cookie, 365);
-  } else {
-    DeleteCookie('hiddenblocks');
-  }
-}
\ No newline at end of file

Modified: trunk/themes/viperal/images/Thumbs.db
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/images/down-logo.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/images/leftbar.gif
===================================================================
(Binary files differ)

Added: trunk/themes/viperal/images/mail.png
===================================================================
(Binary files differ)


Property changes on: trunk/themes/viperal/images/mail.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Deleted: trunk/themes/viperal/images/mainbar.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/images/print.gif
===================================================================
(Binary files differ)

Added: trunk/themes/viperal/images/print.png
===================================================================
(Binary files differ)


Property changes on: trunk/themes/viperal/images/print.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Deleted: trunk/themes/viperal/images/rightbar.gif
===================================================================
(Binary files differ)

Modified: trunk/themes/viperal/index.php
===================================================================
--- trunk/themes/viperal/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -27,7 +27,7 @@
 		$this->table_open	= '<div class="OpenTable"><div class="outer"><div class="inner">';
 		$this->table_close	= '</div></div></div>';
 		
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'A_TABLE_OPEN'	=> $this->table_open,
 			'A_TABLE_CLOSE'	=> $this->table_close,
 			'A_STYLESHEET'	=> '/themes/viperal/style/style.css',
@@ -38,13 +38,13 @@
 	{
 		global $_CORE_CONFIG, $_CORE_MODULE, $_CLASS;
 
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'THEME_MAININDEX'	=> generate_link(),
 			'THEME_SITENAME'	=> $_CORE_CONFIG['global']['site_name'],
-			'THEME_MARGINRIGHT'	=> ($_CLASS['core_blocks']->check_side(BLOCK_RIGHT)) ? '180px' : '0px',
-			'THEME_MARGINLEFT' 	=> ($_CLASS['core_blocks']->check_side(BLOCK_LEFT)) ? '180px' : '0px'
+			'THEME_MARGINRIGHT'	=> $_CLASS['core_blocks']->check_side(BLOCK_RIGHT) ? '180px' : '0px',
+			'THEME_MARGINLEFT' 	=> $_CLASS['core_blocks']->check_side(BLOCK_LEFT) ? '180px' : '0px'
 		));
-		
+
 		if ($_CLASS['core_display']->homepage)
 		{
 			$_CLASS['core_template']->assign('PAGE_TITLE', $_CLASS['core_user']->lang['HOME']);
@@ -62,9 +62,9 @@
 	function theme_footer()
 	{
 		global $_CLASS;
-		
+
 		$_CLASS['core_blocks']->display(BLOCK_RIGHT);
-		
+
 		$_CLASS['core_template']->assign('THEME_FOOTER', $_CLASS['core_display']->footmsg());
 		
 		$_CLASS['core_template']->display('footer.html');

Modified: trunk/themes/viperal/style/images/Thumbs.db
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/cellpic3.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/created_by.jpg
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_faq.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_groups.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_login.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_members.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_message.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_profile.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_register.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_search.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/index.htm
===================================================================
--- trunk/themes/viperal/style/images/index.htm	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/style/images/index.htm	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,16 +0,0 @@
-<html>
-<head>
-<title>subSilver created by subBlue Design</title>
-<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
-</head>
-
-<body bgcolor="#FFFFFF" text="#000000">
-
-<table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0">
-	<tr>
-		<td align="center" valign="middle"><a href="http://www.subblue.com/" target="_new"><img src="created_by.jpg" width="400" height="300" border="0" alt="Created by subBlue Design" /></a></td>
-	</tr>
-</table>
-
-</body>
-</html>
\ No newline at end of file

Deleted: trunk/themes/viperal/style/images/logo-christmas.jpg
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/sitelogo.jpg
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/whosonline.gif
===================================================================
(Binary files differ)

Modified: trunk/themes/viperal/style/style.css
===================================================================
--- trunk/themes/viperal/style/style.css	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/style/style.css	2005-08-15 21:01:36 UTC (rev 82)
@@ -2,11 +2,12 @@
 {
     font-family: Verdana, Helvetica, sans-serif;
     font-size: 10px;
-    /*font: 7pt "Bitstream Vera Sans", verdana, geneva, lucida, 'lucida grande', arial, helvetica, sans-serif;*/
-    margin: 0px;
+
+    /* Needed for opera */
+    margin: 0px; 
+
     padding: 0px;
-    background-color: white;
-    background: url(images/bg.gif);
+    background: url(/images/bg.gif);
 }
 
 .logo
@@ -14,10 +15,10 @@
 	position:fixed;
 	top: -1px;
 	left: -1px;
-	z-index:	1;
+	z-index: 1;
 }
 
-#nav li a, .active
+#nav li a
 {
 	display: block;
 	padding: 5px 10px 5px 5px; 
@@ -25,7 +26,7 @@
 	color: black;
 }
 
-#nav li a:hover, .active
+#nav li a:hover
 {
 	background-color: #FFFFFF;
 	color: black;
@@ -39,21 +40,22 @@
 #page
 {
 	position: relative;
-	height:15px;
+	height: 15px;
 	background: url(images/curve.gif) top left no-repeat;
 	background-color: #eee;
 	color: #999;
-	padding: 0.25em 0 0.25em 2em;
+	padding: 2px;
+	padding-left: 20px;
 }
 
 
 #header
 {
 	position: relative;
-	height:138px;
+	height: 138px;
 	width: 100%;
 	background: url(images/background.gif);
-	border-bottom:1px solid #ccc;
+	border-bottom: 1px solid #ccc;
 }
 	
 #blocksleft
@@ -61,18 +63,18 @@
 	position:absolute;
 	top: 137px;
 	left:0px;
-	width:180px;
+	width: 180px;
 	height:100%;
-	margin:0px 0px 10px 0px;
+	margin: 0px 0px 10px 0px;
 }
 	
 #blocksright
 {
 	position:absolute;
 	top: 160px;
-	right:0px;
-	width:180px;
-	margin:0px 0px 10px 0px;
+	right: 0px;
+	width: 180px;
+	margin: 0px 0px 10px 0px;
 }
 
 /* 
@@ -80,8 +82,8 @@
 */
 .mainbody
 {
-	position:relative;
-	height:100%;
+	position: relative;
+	height: 100%;
 	border-left:1px solid #ccc;
 	border-top:1px solid #ccc;
 	background-color:white;
@@ -89,10 +91,10 @@
 	
 .bodymain
 {
-	position:relative;
-	border-top:1px solid #ccc;
-	height:100%;
-	min-height:1500px;
+	position: relative;
+	border-top: 1px solid #ccc;
+	height: 100%;
+	min-height: 1500px;
 	border-right:1px dashed #ccc;
 }
 
@@ -259,6 +261,22 @@
 	background-color: #ECECEC; padding: 4px;
 }
 
+.page_link_normal
+{
+	background: #F2F1ED;
+	border: 1px solid #A9B8C2;
+	padding: 1px 3px 1px 3px;
+	margin: 2px
+}
+
+.page_link_current
+{
+	background: #F2F1ED;
+	border: 1px solid #A9B8C2;
+	padding: 1px 3px 1px 3px;
+	margin: 2px
+}
+
 /* 
 	TEXT
 */
@@ -328,26 +346,41 @@
 
 .catdiv
 {
-	height: 28px; margin: 0px; padding: 0px; border: 0px; background-color: white; background-image: url('./images/cellpic2.jpg'); background-repeat: repeat-y;
+	height: 28px;
+	margin: 0px;
+	padding: 0px;
+	border: 0px;
+	background-color:white;
+	background-image: url('./images/cellpic2.jpg');
+	background-repeat: repeat-y;
 }
 
 .cat
 {
-	height: 28px; margin: 0px; padding: 0px; border: 0px; background-color: #C7D0D7; background-image: url('../images/cellpic1.gif'); text-indent: 4px;
+	height: 28px;
+	margin: 0px;
+	padding: 0px;
+	border: 0px;
+	background-color: #C7D0D7;
+	background-image: url('../images/cellpic1.gif');
+	text-indent: 4px;
 }
 
 .row1
 {
-	background-color: #ECECEC; padding: 4px;
+	background-color: #ECECEC;
+	padding: 4px;
 }
 .row2
 {
-	background-color: #DCE1E5; padding: 4px;
+	background-color: #DCE1E5;
+	padding: 4px;
 }
 
 .row3
 {
-background-color: #C0C8D0; padding: 4px;
+	background-color: #C0C8D0;
+	padding: 4px;
 }
 
 .spacer
@@ -408,47 +441,49 @@
 	font-size: 100%; color: black; font-family: Verdana, serif; font-weight: normal;
 }
 
-input:focus
+textarea
 {
-	background-color: #C7D0D7;
+	background-color: white;
+	font-family: Verdana, serif;
+	font-size: 110%; font-weight: normal;
 	border:1px solid #999;
+	padding: 3px;
 }
 
-textarea
-{
-	background-color: white; color: black; font-family: Verdana, serif; font-size: 110%; font-weight: normal;
-	border:1px solid #999; 
-}
-
 select
 {
-	background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal;;
+	background-color: white;
+	font-family: Verdana, serif;
+	font-size: 100%;
+	font-weight: normal;;
 }
 
-.button, .btnbbcode
+.button, .btnbbcode, .button_main
 {
 	background-color: #FAFAFA;
 	border: 1px solid #ccc;
 	color: black;
 }
 
+.button_main
+{
+	font-weight: bold;
+}
+
 /* Rename this */
 .post
 {
 	background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;
 }
 
-02.helpline
+.helpline
 {
 	background-color: #DEE3E7; border-style: none;
 }
 
 /* Rename this */
-.btnmain
-{
-	font-weight: bold; background-color: #FAFAFA; border-style: solid; border-width: 1px;
-}
 
+
 /* 
 	BBCODE 
 */

Modified: trunk/themes/viperal/template/blockleft.html
===================================================================
--- trunk/themes/viperal/template/blockleft.html	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/template/blockleft.html	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,18 +1,13 @@
 <!-- IF isset({ $block_left }) -->
 <div id="blocksleft">
-  <!-- LOOP $block_left -->
+	<!-- LOOP $block_left -->
 	<div class="blocks">
-       
-        <div class="top" onclick="blockswitch2('{ $block_left:ID }');" style="cursor:pointer">&nbsp;{ $block_left:TITLE }&nbsp;</div>
-                    
-		<div class="content" id="pe{ $block_left:ID }" { $block_left:COLLAPSE }>
-
-        { $block_left:CONTENT }
-        
-        </div>
-
-	</div>
-  <br />
-  <!-- ENDLOOP $block_left-->
+		<div class="top" onclick="switch_collapse('block_{ $block_left:id }');" style="cursor:pointer">&nbsp;{ $block_left:title }&nbsp;</div>
+			<div<!-- IF { $block_left:collapsed } --> style="display: none;"<!-- ENDIF --> class="content" id="block_{ $block_left:id }">
+			{ $block_left:content }
+			</div>
+		</div>
+	<br />
+	<!-- ENDLOOP $block_left-->
 </div>
 <!-- ENDIF -->
\ No newline at end of file

Modified: trunk/themes/viperal/template/blockright.html
===================================================================
--- trunk/themes/viperal/template/blockright.html	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/template/blockright.html	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,19 +1,13 @@
-<!-- IF isset({ $block_right }) -->
-<div id="blocksright">
-  <!-- LOOP $block_right -->
-	<div class="blocks">
-       
-        <div class="top" onclick="blockswitch2('{ $block_right:ID }');" style="cursor:pointer">&nbsp;{ $block_right:TITLE }&nbsp;</div>
-                    
-		<div class="content" id="pe{ $block_right:ID }" { $block_right:COLLAPSE }>
-
-        { $block_right:CONTENT }
-        
-        </div>
-
-	</div>
-  <br />
-  <!-- ENDLOOP $block_right -->
-
-</div>
+<!-- IF isset({ $block_right }) -->
+<div id="blocksright">
+	<!-- LOOP $block_right -->
+	<div class="blocks">
+		<div class="top" onclick="switch_collapse('block_{ $block_right:id }');" style="cursor:pointer">&nbsp;{ $block_right:title }&nbsp;</div>
+			<div<!-- IF { $block_right:collapsed } --> style="display: none;"<!-- ENDIF --> class="content" id="block_{ $block_right:id }">
+			{ $block_right:content }
+			</div>
+		</div>
+	<br />
+	<!-- ENDLOOP $block_right -->
+</div>
 <!-- ENDIF -->
\ No newline at end of file

Modified: trunk/themes/viperal/template/header.html
===================================================================
--- trunk/themes/viperal/template/header.html	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/template/header.html	2005-08-15 21:01:36 UTC (rev 82)
@@ -6,14 +6,17 @@
 <meta name="author" content="{ $SITE_NAME }" /><meta http-equiv="expires" content="0" />
 <meta name="copyright" content="Copyright { $SITE_NAME } { $SITE_URL }" />
 <meta name="robots" content="index, follow" />
-<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
+<!-- <link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" /> -->
+<style type="text/css">@import "{ $A_STYLESHEET }";</style>
 { $HEADER_REGULAR }
+
 { $HEADER_JS }
-<script type="text/javascript" src="/themes/viperal/blockscript.js"></script>
+<script type="text/javascript" src="/javascript/collapse.js"></script>
 
 <!--[if IE]>
 <style>
-	.bodymain {
+	.bodymain
+	{
 		height:1500px;
 	}
 </style>
@@ -24,8 +27,6 @@
 
 <a name="Top"></a>
 
-<div class="menu"></div>
-
 <div id="header">
 	<a href="{ $THEME_MAININDEX }"><img src="themes/viperal/images/Viperal_Logo.gif" border="0" alt="{ $THEME_SITENAME }" /></a>
 </div>
@@ -39,16 +40,16 @@
 	
 	<div class="bodymain" style="margin-right: { $THEME_MARGINRIGHT }">
 	<!-- IF { $HEADER_MESSAGE }-->
-	{ $A_TABLE_OPEN }<div style="text-align: center;">{ $HEADER_MESSAGE }</div>{ $A_TABLE_CLOSE }
+	<div style="color: #999; border-bottom:1px solid #ccc; padding:2px; background-color: #eee; text-align: center;">{ $HEADER_MESSAGE }</div>
 	<!-- ENDIF -->
 
 	<!-- IF isset({ $message_block_top }) -->
 	<div class="messageblock">
 	<!-- LOOP $message_block_top -->
-		<div class="title" onclick="blockswitch2('{ $message_block_top:ID }');" style="cursor:pointer">{ $message_block_top:TITLE }
-		<!-- IF { $message_block_top:EDIT_LINK } -->[ <!-- IF { $message_block_top:EXPIRES } -->{ $message_block_top:EXPIRES } | <!-- ENDIF -->
-		<a href="{ $message_block_top:EDIT_LINK }" >{ $message_block_top:L_EDIT }</a> ]<!-- ENDIF --></div>
-		<div class="content" { $message_block_top:HIDE } id="pe{ $message_block_top:ID }">{ $message_block_top:CONTENT }</div>
+		<div class="title" onclick="switch_collapse('block_{ $message_block_top:id }');" style="cursor:pointer">{ $message_block_top:title }
+		<!-- IF { $message_block_top:edit_link } -->[ <!-- IF { $message_block_top:expires } -->{ $message_block_top:expires } | <!-- ENDIF -->
+		<a href="{ $message_block_top:edit_link }" >{ $L_EDIT }</a> ]<!-- ENDIF --></div>
+		<div <!-- IF { $message_block_top:collapsed } -->style="display: none;"<!-- ENDIF --> class="content" id="block_{ $message_block_top:id }">{ $message_block_top:content }</div>
 	<br />
 	<!-- ENDLOOP $message_block_top -->
 	</div><br />

Modified: trunk/themes/viperal/template/modules/News/index.html
===================================================================
--- trunk/themes/viperal/template/modules/News/index.html	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/template/modules/News/index.html	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,21 +1,25 @@
-<div class="newsblock">
-<!-- LOOP $news -->
-	<div class="title" onclick="blockswitch2('{ $news:ID }');" style="cursor:pointer">{ $news:TITLE }</div>
-	<div class="content"<!-- IF { $news:COLLAPSE } --> style="display: none"<!-- ENDIF --> id="pe{ $news:ID }">
-	{ $news:CONTENT }
-	<br /><br />
-	<!-- IF { $news:FULL_STORY } --><a href="{ $news:CONTENT_LINK }" > Readmore ..</a><!-- ENDIF -->
-	<hr />
-	
-	 <div style="float: left; Top: -2.5em;"><a onclick="window.open('{ $news:PRINT_LINK }', 'print{ $news:ID }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600');return false;" href="{ $news:PRINT_LINK }" >
-	 <img src="themes/viperal/images/print.gif" alt="" /></a></div>
-	 <div style="float: right; Top: -2.5em;">Posted: { $news:TIME }<br/>
-	<!-- IF { $news:POSTER_LINK } -->By: <a href="{ $news:POSTER_LINK }">{ $news:POSTER } </a><!-- ELSE -->By: { $news:POSTER } <!-- ENDIF --></div></div>
-	<br />
-	<br />
-	<br />
-<!-- ENDLOOP  -->
-<!-- IF { $NEWS_PAGINATION } --><div class="numbering">[ <!-- IF { $NEWS_PREVIOUS_PAGE } --><a href="{ $NEWS_PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;|&nbsp;<!-- ENDIF --> { $NEWS_PAGINATION }
-<!-- IF { $NEWS_NEXT_PAGE } -->&nbsp;|&nbsp;<a href="{ $NEWS_NEXT_PAGE }">{$L_NEXT}</a><!-- ENDIF --> ]</div><br /><!-- ENDIF -->
-</div>
-<br />
\ No newline at end of file
+<!-- DISPLAY_HEADER -->
+
+<div class="newsblock">
+	<!-- LOOP $news -->
+	<div class="title" onclick="switch_collapse('article_{ $news:id }');" style="cursor:pointer">{ $news:title }</div>
+		<div class="content"<!-- IF { $news:collapse } --> style="display: none"<!-- ENDIF --> id="article_{ $news:id }">
+			{ $news:content }
+			<br clear="all">
+			<p>
+				<!-- IF { $news:full_story } --><a href="{ $news:link_content }" > { $L_READMORE } ..</a><!-- ENDIF -->
+				<hr />
+				<div style="float: left; Top: -2.5em;">
+					<a onclick="window.open('{ $news:link_print }', 'print{ $news:id }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600,height=400'); return false;" href="{ $news:link_print }" ><img src="themes/viperal/images/print.png" alt="" /></a>
+					<a onclick="window.open('{ $news:link_send }', 'send{ $news:id }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600'); return false;" href="{ $news:link_send }" ><img src="themes/viperal/images/mail.png" alt="" /></a>
+				</div>
+				<div style="float: right; Top: -2.5em;">{ $L_POSTED } { $news:time }<br/>
+					<!-- IF { $news:link_poster } -->By: <a href="{ $news:link_poster }">{ $news:poster } </a><!-- ELSE -->By: { $news:poster } <!-- ENDIF -->
+				</div>
+			</p>
+		</div>
+	<br /><br />
+	<!-- ENDLOOP  -->
+	<p align="center"> { $NEWS_PAGINATION }</p>
+</div>
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file



From viperal at berlios.de  Wed Aug 17 20:48:40 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 17 Aug 2005 20:48:40 +0200
Subject: [Viperals-svncheckins] r83 - trunk/includes
Message-ID: <200508171848.j7HImedc012015@sheep.berlios.de>

Author: viperal
Date: 2005-08-17 20:48:36 +0200 (Wed, 17 Aug 2005)
New Revision: 83

Modified:
   trunk/includes/session.php
Log:
Just a test

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-15 21:01:36 UTC (rev 82)
+++ trunk/includes/session.php	2005-08-17 18:48:36 UTC (rev 83)
@@ -17,6 +17,13 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
+
+$Id:$
+$Date:$
+$Rev:$
+$Revision:$
 */
 
 class sessions



From viperal at berlios.de  Wed Aug 17 20:55:24 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 17 Aug 2005 20:55:24 +0200
Subject: [Viperals-svncheckins] r84 - trunk/includes
Message-ID: <200508171855.j7HItOpd013286@sheep.berlios.de>

Author: viperal
Date: 2005-08-17 20:55:22 +0200 (Wed, 17 Aug 2005)
New Revision: 84

Modified:
   trunk/includes/session.php
Log:
Just a test

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-17 18:48:36 UTC (rev 83)
+++ trunk/includes/session.php	2005-08-17 18:55:22 UTC (rev 84)
@@ -19,11 +19,6 @@
 ||**************************************************************||
 
 $Id$
-
-$Id:$
-$Date:$
-$Rev:$
-$Revision:$
 */
 
 class sessions


Property changes on: trunk/includes/session.php
___________________________________________________________________
Name: svn:keywords
   + Id



From viperal at berlios.de  Wed Aug 17 21:07:49 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 17 Aug 2005 21:07:49 +0200
Subject: [Viperals-svncheckins] r85 - trunk/includes
Message-ID: <200508171907.j7HJ7nZZ015480@sheep.berlios.de>

Author: viperal
Date: 2005-08-17 21:07:48 +0200 (Wed, 17 Aug 2005)
New Revision: 85

Modified:
   trunk/includes/session.php
Log:


Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-17 18:55:22 UTC (rev 84)
+++ trunk/includes/session.php	2005-08-17 19:07:48 UTC (rev 85)
@@ -19,13 +19,17 @@
 ||**************************************************************||
 
 $Id$
+$Id:$
+$Date:$
+$Rev:$
+$Author:$
 */
 
 class sessions
 {
 	var $load;
 	var $new_session = false;
-	var $save_session = false;
+	var $save  _session = false;
 
 	var $sid_link_prefex = 'sid';
 	var $sid_link = false;


Property changes on: trunk/includes/session.php
___________________________________________________________________
Name: svn:keywords
   - Id
   + Author Rev Date Id



From viperal at berlios.de  Wed Aug 17 21:08:39 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 17 Aug 2005 21:08:39 +0200
Subject: [Viperals-svncheckins] r86 - trunk/includes
Message-ID: <200508171908.j7HJ8drL015649@sheep.berlios.de>

Author: viperal
Date: 2005-08-17 21:08:38 +0200 (Wed, 17 Aug 2005)
New Revision: 86

Modified:
   trunk/includes/session.php
Log:


Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-17 19:07:48 UTC (rev 85)
+++ trunk/includes/session.php	2005-08-17 19:08:38 UTC (rev 86)
@@ -19,17 +19,17 @@
 ||**************************************************************||
 
 $Id$
-$Id:$
-$Date:$
-$Rev:$
-$Author:$
+$Id$
+$Date$
+$Rev$
+$Author$
 */
 
 class sessions
 {
 	var $load;
 	var $new_session = false;
-	var $save  _session = false;
+	var $save_session = false;
 
 	var $sid_link_prefex = 'sid';
 	var $sid_link = false;



From viperal at berlios.de  Fri Aug 19 03:49:41 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 19 Aug 2005 03:49:41 +0200
Subject: [Viperals-svncheckins] r87 - in trunk: admin admin/functions blocks includes includes/db includes/display install javascript modules modules/Control_Panel/ucp modules/Forums modules/Members_List
Message-ID: <200508190149.j7J1nflN026661@sheep.berlios.de>

Author: viperal
Date: 2005-08-19 03:49:31 +0200 (Fri, 19 Aug 2005)
New Revision: 87

Added:
   trunk/admin/users.php
   trunk/javascript/menu.js
Removed:
   trunk/admin/bots.php
   trunk/modules/Submit_News/
   trunk/modules/View_Online/
Modified:
   trunk/admin/blocks.php
   trunk/admin/functions/block_functions.php
   trunk/admin/index.php
   trunk/admin/messages.php
   trunk/blocks/block-theme_select.php
   trunk/includes/db/mysql.php
   trunk/includes/display/display.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/mailer.php
   trunk/includes/session.php
   trunk/includes/user.php
   trunk/install/build_data.php
   trunk/install/build_tables.php
   trunk/modules/Control_Panel/ucp/ucp_zebra.php
   trunk/modules/Forums/faq.php
   trunk/modules/Forums/posting.php
   trunk/modules/Forums/viewforum.php
   trunk/modules/Forums/viewtopic.php
   trunk/modules/Members_List/index.php
Log:


Modified: trunk/admin/blocks.php
===================================================================
--- trunk/admin/blocks.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/admin/blocks.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -1,18 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (VIPERAL !== 'Admin') 
 {
 	die;
@@ -63,18 +71,22 @@
 					blocks_change_position($position, $id);
 				}
 			break;
-	
+
+			case 'edit':
+				block_add($id);
+				script_close(false);
+			break;
+
 			case 'auth':
 				block_auth($id);
 			break;
 		}
 	}
-	
+
 	switch ($_REQUEST['mode'])
 	{
 		case 'add':
-		case 'edit':
-			block_add($id);
+			block_add(false);
 			script_close(false);
 		break;
 		   
@@ -88,7 +100,7 @@
 
 $result = $_CLASS['core_db']->query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_file, block_auth
 	FROM '.BLOCKS_TABLE.'
-	WHERE block_position IN ('.BLOCK_RIGHT.', '.BLOCK_TOP.', '.BLOCK_BOTTOM.', '.BLOCK_LEFT.')  ORDER BY block_position, block_order ASC');
+	WHERE block_position IN ('.BLOCK_RIGHT.', '.BLOCK_TOP.', '.BLOCK_BOTTOM.', '.BLOCK_LEFT.') ORDER BY block_position, block_order ASC');
 
 $block_position = array(BLOCK_RIGHT => 'right', BLOCK_TOP => 'centertop', BLOCK_BOTTOM => 'centerbottom', BLOCK_LEFT => 'left');
 $in_position = false;
@@ -329,9 +341,9 @@
 		$data['block_position'] = BLOCK_RIGHT;
 	}
 
-	$data['block_status'] = (int) get_variable('b_active', 'POST', 0);
-	$data['block_expires'] = get_variable('b_expires', 'POST', '');
-	$data['block_starts'] = get_variable('b_time', 'POST', '');
+	$data['block_status']	= get_variable('b_active', 'POST', 0, 'integer');
+	$data['block_expires']	= get_variable('b_expires', 'POST', '');
+	$data['block_starts']	= get_variable('b_time', 'POST', '');
 
 	$start = $expires = '';
 

Deleted: trunk/admin/bots.php
===================================================================
--- trunk/admin/bots.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/admin/bots.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -1,73 +0,0 @@
-<?php
-
-if (VIPERAL !== 'Admin') 
-{
-	die;
-}
-
-$id = (int) get_variable('id', 'GET', false);
-
-if ($id && isset($_REQUEST['option']))
-{
-	require_once($site_file_root.'includes/functions_user.php');
-
-	switch ($_REQUEST['option'])
-	{
-		case 'activate':
-			user_activate($id);
-		break;
-
-		case 'deactivate':
-			user_disable($id);
-		break;
-	
-		case 'delete':
-			if (display_confirmation())
-			{
-				$sql = 'SELECT user_id, user_type
-					FROM ' . USERS_TABLE . ' 
-					WHERE user_id = '.$id;
-	
-				$result = $_CLASS['core_db']->query($sql);
-				$row = $_CLASS['core_db']>fetch_row_assoc($result);
-				$_CLASS['core_db']->free_result($result);
-	
-				if ($row['user_type'] != USER_BOT)
-				{
-					break;
-				}
-	
-				user_delete($id);
-	
-				trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
-			}
-		break;
-	}
-}
-
-$sql = 'SELECT user_id, username, user_status, user_last_visit 
-	FROM ' . USERS_TABLE . ' u
-	WHERE user_type = ' . USER_BOT . ' ORDER BY user_last_visit DESC';
-
-$result = $_CLASS['core_db']->query($sql);
-
-while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-{
-	$_CLASS['core_template']->assign_vars_array('admin_bots', array(
-		'ACTIVE'		=> ($row['user_status'] == USER_ACTIVE),
-		'NAME'			=> $row['username'],
-		'DELETE_LINK'	=> generate_link('bots&amp;option=delete&amp;id='.$row['user_id'], array('admin' => true)),
-		'STATUS_LINK'	=> generate_link('bots&amp;option='.(($row['user_status'] == USER_ACTIVE) ? 'deactivate' :  'activate').'&amp;id='.$row['user_id'], array('admin' => true)),
-		'EDIT_LINK'		=> generate_link('bots&amp;options=edite&amp;id='.$row['user_id'], array('admin' => true)),
-		'LAST_VISIT'	=> ($row['user_last_visit']) ?  $_CLASS['core_user']->format_date($row['user_last_visit']) : $_CLASS['core_user']->lang['BOT_NEVER'],
-		'L_STATUS'		=> ($row['user_status'] == USER_ACTIVE) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
-	));
-}
-
-$_CLASS['core_db']->free_result($result);
-
-$_CLASS['core_template']->assign('ACTION', generate_link('system&amp;mode=bots', array('admin' => true))); 
-
-$_CLASS['core_display']->display(false, 'admin/bots.html');
-
-?>
\ No newline at end of file

Modified: trunk/admin/functions/block_functions.php
===================================================================
--- trunk/admin/functions/block_functions.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/admin/functions/block_functions.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -1,23 +1,31 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 function block_auth($id)
 {
 	global $_CLASS;
 
-	$result = $_CLASS['core_db']->query('SELECT position, auth FROM ' . BLOCKS_TABLE . ' WHERE id='.$id);
+	$result = $_CLASS['core_db']->query('SELECT block_position, block_auth FROM ' . BLOCKS_TABLE . ' WHERE block_id = '.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 	
@@ -26,27 +34,27 @@
 		trigger_error('BLOCK_NOT_FOUND');
 	}
 	
-	$block['auth'] = ($block['auth']) ? unserialize($block['auth']) : '';
+	$block['block_auth'] = ($block['block_auth']) ? unserialize($block['block_auth']) : '';
 	
-	check_position($block['position']);
+	check_position($block['block_position']);
 	
 	$_CLASS['core_display']->display_header();
 
-	$auth = $_CLASS['core_auth']->generate_auth_options($block['auth']);
+	$auth = $_CLASS['core_auth']->generate_auth_options($block['block_auth']);
 
 	if ($auth !== false)
 	{
 		if (is_null($auth))
 		{
-			$block['auth'] = $auth = '';
+			$block['block_auth'] = $auth = '';
 		}
 		else
 		{
-			$block['auth'] = $auth;
+			$block['block_auth'] = $auth;
 			$auth = $_CLASS['core_db']->escape(serialize($auth));
 		}
 
-		$_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . " SET auth = '$auth' WHERE id = $id");
+		$_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . " SET block_auth = '$auth' WHERE block_id = $id");
 		$_CLASS['core_cache']->destroy('blocks');
 	}
 	
@@ -107,35 +115,35 @@
 			{
 				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position = '.$block['block_position'].' AND block_order='.($block['block_order'] + 1));
 				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = '.($block['block_order'] + 1).' WHERE block_id ='. $id);
+
+				$_CLASS['core_cache']->destroy('blocks');
 			}
-
-			$_CLASS['core_cache']->destroy('blocks');
 		break;
 
 		case 'bottom':
 
-			$result = $_CLASS['core_db']->query('SELECT MAX(weight) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
-			list($max_order) = $_CLASS['core_db']->fetch_row_($result);
+			$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
+			list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 			$_CLASS['core_db']->free_result($result);
 
 			if ($block['block_order'] < $max_order)
 			{
 				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order > '.$block['block_order']);
 				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = '.$max_order.' WHERE block_id = '.$id);
+
+				$_CLASS['core_cache']->destroy('blocks');
 			}
-
-			$_CLASS['core_cache']->destroy('blocks');
 		break;
 
 		case 'up':
 
-			if ($block['block_order'] && $block['weight'] != 1)
+			if ($block['block_order'] && $block['block_order'] != 1)
 			{
 				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order = '.($block['block_order'] - 1));
 				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order='.($block['block_order'] -1 ).' WHERE block_id ='. $id);
+
+				$_CLASS['core_cache']->destroy('blocks');
 			}
-
-			$_CLASS['core_cache']->destroy('blocks');
 		break;
 
 		case 'top':
@@ -144,9 +152,9 @@
 			{
 				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order < '.$block['block_order']);
 				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = 1 WHERE block_id = '.$id);
+
+				$_CLASS['core_cache']->destroy('blocks');
 			}
-
-			$_CLASS['core_cache']->destroy('blocks');
 		break;
 	}
 }

Modified: trunk/admin/index.php
===================================================================
--- trunk/admin/index.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/admin/index.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -61,13 +61,13 @@
 	$sql = 'SELECT user_id, username, user_regdate
 		FROM ' . USERS_TABLE . '
 			WHERE user_type = '.USER_NORMAL.'
-			AND user_status IN (' . USER_DISABLE . ',  '.USER_UNACTIVATED.')';
+			AND user_status IN (' . STATUS_PENDING . ',  ' . STATUS_DISABLED . ')';
 		
 	$result = $_CLASS['core_db']->query_limit($sql, 20);
 	
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$type = ($row['user_id'] == USER_DISABLE) ? 'users_disabled' : 'users_unactivated';
+		$type = ($row['user_id'] == STATUS_DISABLED) ? 'users_disabled' : 'users_unactivated';
 	
 		$_CLASS['core_template']->assign_vars_array($type, array(
 				'user_id'		=> $row['user_id'],

Modified: trunk/admin/messages.php
===================================================================
--- trunk/admin/messages.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/admin/messages.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -1,18 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (VIPERAL !== 'Admin') 
 {
 	die;
@@ -30,8 +38,7 @@
 	{
 		if ($redirect)
 		{
-			url_redirect(generate_link('messages', array('admin' => true)));
-			die;
+			redirect(generate_link('messages', array('admin' => true, 'full' => true)));
 		}
 		return false;
 	}
@@ -39,160 +46,108 @@
 	return true;
 }
 
-function get_id($rediret = true)
-{
-	$id = get_variable('id', 'GET', false, 'integer');
-
-	if (!$id && $rediret)
-	{
-		url_redirect(generate_link('messages', array('admin' => true)));
-		die;
-	}
-	
-	return $id;
-}
-
-switch (get_variable('mode', 'GET', false))
+if (isset($_REQUEST['mode']))
 {
-	case 'change':
-		block_change(get_id());
-		url_redirect(generate_link('messages', array('admin' => true)));
-    break;
-    
-    case 'weight':
-		block_weight(get_id(), get_variable('option', 'GET', false));
-		url_redirect(generate_link('messages', array('admin' => true)));
-    break;
+	if ($id = get_variable('id', 'GET', false, 'integer'))
+	{
+		switch ($_REQUEST['mode'])
+		{
+			case 'change':
+				block_change($id);
+			break;
+			
+			case 'order':
+				block_order($id, get_variable('option', 'GET', false));
+			break;
+		
+			case 'delete':
+				block_delete($id, generate_link('messages', array('admin' => true)));
+			break;
+		  
+			case 'auth':
+				block_auth($id);
+			break;
+		}
+	}
 
-    case 'delete':
-		block_delete(get_id());
-		url_redirect(generate_link('messages', array('admin' => true)));
-    break;
-  
-    case 'edit':
-		message_edit(get_id());
-    break;
-    
-    case 'add':
-		message_edit(false);
-    break;
-       
-    case 'save':
-		message_save();
-    break;
+	switch ($_REQUEST['mode'])
+	{
+		case 'add':
+		case 'edit':
+			message_edit($id);
+			script_close(false);
+		break;
 
-    case 'auth':
-		block_auth(get_id());
-    break;
-
-    default:
-		message_admin();
+		case 'save':
+			message_save($id);
+		break;
+	}
 }
 
-script_close(false);
+$result = $_CLASS['core_db']->query('SELECT block_id, block_position, block_title, block_starts, block_expires, block_order, block_status FROM ' . BLOCKS_TABLE . '
+				WHERE block_position IN ('.BLOCK_MESSAGE_TOP.', '.BLOCK_MESSAGE_BOTTOM.') 
+					 ORDER BY block_position, block_order ASC');
 
-function message_admin()
-{
-    global $prefix, $_CLASS;
+$block_position = array(BLOCK_MESSAGE_TOP => 'top', BLOCK_MESSAGE_BOTTOM => 'bottom');
+$in_position = false;
+$messages = array();
 
-    $result = $_CLASS['core_db']->query('SELECT id, position, title, start, weight, active, expires FROM '.BLOCKS_TABLE.'
-					WHERE position IN ('.BLOCK_MESSAGE_TOP.', '.BLOCK_MESSAGE_BOTTOM.') 
-						ORDER BY weight ASC');
-	$block_position = array(BLOCK_MESSAGE_TOP => 'top', BLOCK_MESSAGE_BOTTOM => 'bottom');
-	$in_position = false;
-	$messages = array();
-
-	while($row = $_CLASS['core_db']->fetch_row_assoc($result))
-    {
-		if ($in_position != $row['position'])
-		{
-			$weigth[$row['position']] = $row['weight'];
-			$in_position == $row['position'];
-		}
-		$messages[] = $row;
+while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	if ($in_position != $row['block_position'])
+	{
+		$weigth[$row['block_position']] = $row['block_order'];
+		$in_position == $row['block_position'];
 	}
-	$_CLASS['core_db']->free_result($result);
+	$messages[] = $row;
+}
 
-	foreach ($messages as $row)
-	{
-		$_CLASS['core_template']->assign_vars_array($block_position[$row['position']].'_admin_messages', array(
-			'ACTIVE'		=> ($row['active']) ? true : false,
-			'CHANGE'		=> ($row['active']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+$_CLASS['core_db']->free_result($result);
 
-			'AUTH_LINK'		=> generate_link('messages&amp;mode=auth&amp;id='.$row['id'], array('admin' => true)),
-			'ACTIVE_LINK'	=> generate_link('messages&amp;mode=change&amp;id='.$row['id'], array('admin' => true)),
-			'VIEW_LINK' 	=> generate_link('messages&amp;mode=show&amp;id='.$row['id'], array('admin' => true)),
-			'EDIT_LINK'		=> generate_link('messages&amp;mode=edit&amp;id='.$row['id'], array('admin' => true)),
-			'DELETE_LINK' 	=> generate_link('messages&amp;mode=delete&amp;id='.$row['id'], array('admin' => true)),
+foreach ($messages as $row)
+{
+	$_CLASS['core_template']->assign_vars_array($block_position[$row['block_position']].'_admin_messages', array(
+		'ACTIVE'		=> ($row['block_status']) ? true : false,
+		'CHANGE'		=> ($row['block_status']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
 
-			'EXPIRES'		=> ($row['expires'] && ($row['expires'] < $_CLASS['core_user']->time)) ? $_CLASS['core_user']->format_date($row['expires']) : false,
-			'STARTS'		=> ($row['start'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['start']) : false,
-			'TITLE'			=> $row['title'],
+		'AUTH_LINK'		=> generate_link('messages&amp;mode=auth&amp;id='.$row['block_id'], array('admin' => true)),
+		'ACTIVE_LINK'	=> generate_link('messages&amp;mode=change&amp;id='.$row['block_id'], array('admin' => true)),
+		'VIEW_LINK' 	=> generate_link('messages&amp;mode=show&amp;id='.$row['block_id'], array('admin' => true)),
+		'EDIT_LINK'		=> generate_link('messages&amp;mode=edit&amp;id='.$row['block_id'], array('admin' => true)),
+		'DELETE_LINK' 	=> generate_link('messages&amp;mode=delete&amp;id='.$row['block_id'], array('admin' => true)),
 
-			'WEIGHT_DOWN' 		=> ($row['weight'] < $weigth[$row['position']]),
-			'WEIGHT_UP'		=> ($row['weight'] > 1),
-
-			'WEIGHT_MOVE_UP' 	=> generate_link('messages&amp;mode=weight&amp;option=up&amp;id='.$row['id'], array('admin' => true)),
-			'WEIGHT_MOVE_TOP' 	=> generate_link('messages&amp;mode=weight&amp;option=top&amp;id='.$row['id'], array('admin' => true)),
-			'WEIGHT_MOVE_DOWN'	=> generate_link('messages&amp;mode=weight&amp;option=down&amp;id='.$row['id'], array('admin' => true)),
-			'WEIGHT_MOVE_BOTTOM'=> generate_link('messages&amp;mode=weight&amp;option=bottom&amp;id='.$row['id'], array('admin' => true)),
-		));
-    }
-    $_CLASS['core_db']->free_result($result);
+		'EXPIRES'		=> ($row['block_expires'] && $row['block_expires'] < $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_expires']) : false,
+		'STARTS'		=> ($row['block_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_starts']) : false,
+		'TITLE'			=> $row['block_title'],
 
-    $_CLASS['core_template']->assign(array(
-		'L_ADD_NEW'			=> 'New Message',
-		'L_BLOCK_HTML'		=> 'Add HTML block',
-		'L_BLOCK_RSS'		=> 'Add RSS block',
-		'B_ACTION'			=> generate_link('messages&amp;mode=add', array('admin' => true))
-	));
+		'ORDER_DOWN' 	=> ($row['block_order'] < $weigth[$row['block_position']]),
+		'ORDER_UP'		=> ($row['block_order'] > 1),
 
-	$_CLASS['core_template']->display('admin/messages/index.html');
+		'LINK_ORDER_UP' 	=> generate_link('messages&amp;mode=order&amp;option=up&amp;id='.$row['block_id'], array('admin' => true)),
+		'LINK_ORDER_TOP' 	=> generate_link('messages&amp;mode=order&amp;option=top&amp;id='.$row['block_id'], array('admin' => true)),
+		'LINK_ORDER_DOWN'	=> generate_link('messages&amp;mode=order&amp;option=down&amp;id='.$row['block_id'], array('admin' => true)),
+		'LINK_ORDER_BOTTOM'	=> generate_link('messages&amp;mode=order&amp;option=bottom&amp;id='.$row['block_id'], array('admin' => true)),
+	));
 }
 
-function message_delete($id)
-{
-    global $_CLASS;
+$_CLASS['core_template']->assign_array(array(
+	'L_ADD_NEW'			=> 'New Message',
+	'L_BLOCK_HTML'		=> 'Add HTML block',
+	'L_BLOCK_RSS'		=> 'Add RSS block',
+	'B_ACTION'			=> generate_link('messages&amp;mode=add', array('admin' => true))
+));
 
-    if (get_variable('ok', 'GET', false))
-    {
-		$result = $_CLASS['core_db']->query('SELECT weight, position FROM '.BLOCKS_TABLE.' WHERE id='.$id);
-		$block = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
+$_CLASS['core_template']->display('admin/messages/index.html');
 
-		if (!$block)
-		{
-			url_redirect(generate_link('messages', array('admin' => true)));
-		}
-		
-		check_position($block['position']);
-				
-        $result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET weight= weight - 1 WHERE position='.$block['position'].' AND weight > '.$block['weight']);
-        $_CLASS['core_db']->query('DELETE from '.BLOCKS_TABLE.' where id='.$id);
+script_close();
 
-        $_CLASS['core_cache']->destroy('blocks');
-		url_redirect(generate_link('messages', array('admin' => true)));
-    }
-    else
-    {
-		$_CLASS['core_display']->display_head();
-		OpenTable();
-		echo '<center>Remove Message ?';
-		echo '<br /><br />[ <a href="'.generate_link("messages&amp;mode=delete&amp;id=$id&amp;ok=1", array('admin' => true)).'">Yes</a> | <a href="'.generate_link('messages', array('admin' => true)).'">No</a> ]</center>';
-		CloseTable();
-        $_CLASS['core_display']->display_footer();
-    }
-}
-
-function message_edit($block = false, $error = false)
+function message_edit($id = false, $block = false, $error = false)
 {
     global $_CLASS;
-    
-    $id = false;
 
-	if (isset($_REQUEST['id']) && $id = get_id())
+	if ($id)
 	{
-		$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+		$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_id = ' . $id);
 		$block = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 		
@@ -201,7 +156,7 @@
 			url_redirect(generate_link('messages', array('admin' => true)));
 		}
 		
-		check_position($block['position']);
+		check_position($block['block_position']);
 
 		if (isset($_POST['submit']))
 		{
@@ -213,20 +168,19 @@
 		unset($block_post);
 	}
 	
-	$_CLASS['core_template']->assign(array(
-		'B_TITLE'			=> $block['title'],
-		'B_CONTENT'			=> $block['content'],
-		'B_ACTIVE'			=> $block['active'],
-		'B_EXPIRES'			=> is_numeric($block['expires']) ? $_CLASS['core_user']->format_date($block['expires'], 'M d, Y h:i a') : $block['expires'],
+	$_CLASS['core_template']->assign_array(array(
+		'B_TITLE'			=> $block['block_title'],
+		'B_CONTENT'			=> $block['block_content'],
+		'B_ACTIVE'			=> $block['block_status'],
+		'B_EXPIRES'			=> is_numeric($block['block_expires']) ? $_CLASS['core_user']->format_date($block['block_expires'], 'M d, Y h:i a') : $block['block_expires'],
 		'B_ERROR'			=> $error,
-		'B_STARTS'			=> is_numeric($block['start']) ? $_CLASS['core_user']->format_date($block['start'], 'M d, Y h:i a') : $block['start'],
-		'B_CURRENT_TIME'	=> $_CLASS['core_user']->format_date($_CLASS['core_user']->time),
-		'B_POSITION'		=> message_position_select($block['position']),
-		'B_TYPE'			=> message_type_select($block['type']),
+		'B_STARTS'			=> is_numeric($block['block_starts']) ? $_CLASS['core_user']->format_date($block['block_starts'], 'M d, Y h:i a') : $block['block_starts'],
+		'B_POSITION'		=> message_position_select($block['block_position']),
+		'B_TYPE'			=> message_type_select($block['block_type']),
 		'B_DELETE_LINK'		=> ($id) ? generate_link('messages&amp;mode=delete&amp;id='.$id, array('admin' => true)) : false,
-		'B_ACTION'			=> generate_link('messages&amp;mode=save'.(($id) ? '&amp;id='.$id : ''), array('admin' => true))
-		)		
-	);
+		'B_ACTION'			=> generate_link('messages&amp;mode=save'.(($id) ? '&amp;id='.$id : ''), array('admin' => true)),
+		'B_CURRENT_TIME'=> $_CLASS['core_user']->format_date($_CLASS['core_user']->time)
+	));
 	
 	$_CLASS['core_template']->display('admin/messages/edit.html');
 }
@@ -243,40 +197,40 @@
 		return;
 	}
 
-	$data['title'] = get_variable('title', 'POST', '');
-	$data['content'] = trim(get_variable('content', 'POST', ''));
+	$data['block_title'] = get_variable('title', 'POST', '');
+	$data['block_content'] = trim(get_variable('content', 'POST', ''));
 	
 	foreach ($data as $field => $value)
 	{
 		if (!$value)
 		{
-			$error .= $_CLASS['core_user']->lang['ERROR_'.$field].'<br />';
+			$error .= $_CLASS['core_user']->get_lang('ERROR_'.$field).'<br />';
 		}
 	}
 	
-	$data['active']		= get_variable('active', 'POST', 0);
-	$data['expires']	= get_variable('expires', 'POST', 0);
-	$data['start']		= get_variable('time', 'POST', '');
-	$data['position']	= get_variable('b_position', 'POST', BLOCK_MESSAGE_TOP, 'integer');
-	$data['type'] 		= (int) get_variable('b_type', 'REQUEST', BLOCKTYPE_MESSAGE);
+	$data['block_status']	= get_variable('active', 'POST', 0);
+	$data['block_expires']	= get_variable('expires', 'POST', 0);
+	$data['block_starts']	= get_variable('time', 'POST', '');
+	$data['block_position']	= get_variable('b_position', 'POST', BLOCK_MESSAGE_TOP, 'integer');
+	$data['block_type'] 	= get_variable('b_type', 'REQUEST', BLOCKTYPE_MESSAGE, 'integer');
 
 	$appoved_types = array(BLOCKTYPE_MESSAGE, BLOCKTYPE_MESSAGE_GLOBAL);
 
-	if (!in_array($data['type'], $appoved_types, true))
+	if (!in_array($data['block_type'], $appoved_types, true))
 	{
-		$data['type'] = BLOCKTYPE_MESSAGE;
+		$data['block_type'] = BLOCKTYPE_MESSAGE;
 	}
 	
-	if (!$data['position'] || !check_position($data['position'], false))
+	if (!$data['block_position'] || !check_position($data['block_position'], false))
 	{
-		$data['position'] = BLOCK_MESSAGE_TOP;
+		$data['block_position'] = BLOCK_MESSAGE_TOP;
 	}
 	
 	$start = $expires = '';
 
-	if ($data['start'])
+	if ($data['block_starts'])
 	{
-		$start = strtotime($data['start']);
+		$start = strtotime($data['block_start']);
 
 		if (!$start || $start == -1)
 		{
@@ -284,9 +238,9 @@
 		}
 	}
 
-	if ($data['expires'])
+	if ($data['block_expires'])
 	{
-		$expires = strtotime($data['expires']);
+		$expires = strtotime($data['block_expires']);
 
 		if (!$expires || $expires == -1)
 		{
@@ -296,36 +250,36 @@
 	
 	if (!$error)
 	{
-		$data['start'] = ($start) ? $_CLASS['core_user']->time_convert($start, 'gmt') : 0;
-		$data['expires'] = ($expires) ? $_CLASS['core_user']->time_convert($expires, 'gmt') : 0;
+		$data['block_starts'] = ($start) ? $_CLASS['core_user']->time_convert($start, 'gmt') : 0;
+		$data['block_expires'] = ($expires) ? $_CLASS['core_user']->time_convert($expires, 'gmt') : 0;
 	}
 }
 
-function message_save()
+function message_save($id = false)
 {
     global $_CLASS;
     
-	if (isset($_REQUEST['id']) && $id = get_id())
+	if ($id)
 	{
-		$result = $_CLASS['core_db']->query('SELECT position FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+		$result = $_CLASS['core_db']->query('SELECT block_position FROM ' . BLOCKS_TABLE . ' WHERE block_id = '. $id);
 		$block = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
-		
+
 		if (!$block)
 		{
 			url_redirect(generate_link('messages', array('admin' => true)));
 		}
-		
-		check_position($block['position']);
+
+		check_position($block['block_position']);
 		// need to validate data with the db type
 		messages_get_data($data, $error);
 		
 		if ($error)
 		{
-			return message_edit($data, $error);
+			return message_edit($id, $data, $error);
 		}
 	
-		$sql = 'UPDATE '.BLOCKS_TABLE.' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE id='.$id;
+		$sql = 'UPDATE ' . BLOCKS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE block_id = '.$id;
 
 		$_CLASS['core_db']->query($sql);
 	}
@@ -335,18 +289,16 @@
 
 		if ($error)
 		{
-			return message_edit($data, $error);
+			return message_edit(false, $data, $error);
 		}
 
-		$result = $_CLASS['core_db']->query('SELECT MAX(weight) as weight FROM '.BLOCKS_TABLE.' WHERE position = '.$data['position']);
-		$maxweight = $_CLASS['core_db']->fetch_row_assoc($result);
+		$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position = '.$data['block_position']);
+		list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 		$_CLASS['core_db']->free_result($result);
 
-		$data['weight'] = (int) $maxweight['weight'] + 1;
+		$data['block_order'] = (int) $max_order + 1;
 
-		$sql = 'INSERT INTO '.BLOCKS_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data);
-
-		$_CLASS['core_db']->query($sql);
+		$_CLASS['core_db']->query('INSERT INTO ' . BLOCKS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data));
 	}
 
 	$_CLASS['core_cache']->destroy('blocks');

Added: trunk/admin/users.php
===================================================================
--- trunk/admin/users.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/admin/users.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -0,0 +1,116 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
+
+if (isset($_REQUEST['mode']) && $_REQUEST['mode'] == 'bots')
+{
+	$id = (int) get_variable('id', 'GET', false);
+	
+	if ($id && isset($_REQUEST['option']))
+	{
+		require_once($site_file_root.'includes/functions_user.php');
+	
+		switch ($_REQUEST['option'])
+		{
+			case 'activate':
+				user_activate($id);
+			break;
+	
+			case 'deactivate':
+				user_disable($id);
+			break;
+		
+			case 'delete':
+				if (display_confirmation())
+				{
+					$sql = 'SELECT user_id, user_type
+						FROM ' . USERS_TABLE . ' 
+						WHERE user_id = '.$id;
+		
+					$result = $_CLASS['core_db']->query($sql);
+					$row = $_CLASS['core_db']>fetch_row_assoc($result);
+					$_CLASS['core_db']->free_result($result);
+		
+					if ($row['user_type'] != USER_BOT)
+					{
+						break;
+					}
+		
+					user_delete($id);
+		
+					trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
+				}
+			break;
+		}
+	}
+	
+	$sql = 'SELECT user_id, username, user_status, user_last_visit 
+		FROM ' . USERS_TABLE . '
+		WHERE user_type = ' . USER_BOT . ' ORDER BY user_last_visit DESC';
+	
+	$result = $_CLASS['core_db']->query($sql);
+	
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$_CLASS['core_template']->assign_vars_array('admin_bots', array(
+			'ACTIVE'		=> ($row['user_status'] == STATUS_ACTIVE),
+			'NAME'			=> $row['username'],
+			'LINK_DELETE'	=> generate_link('users&amp;mode=bots&amp;option=delete&amp;id='.$row['user_id'], array('admin' => true)),
+			'LINK_STATUS'	=> generate_link('users&amp;mode=bots&amp;option='.(($row['user_status'] == STATUS_ACTIVE) ? 'deactivate' :  'activate').'&amp;id='.$row['user_id'], array('admin' => true)),
+			'LINK_EDIT'		=> generate_link('users&amp;mode=bots&amp;options=edit&amp;id='.$row['user_id'], array('admin' => true)),
+			'LAST_VISIT'	=> ($row['user_last_visit']) ?  $_CLASS['core_user']->format_date($row['user_last_visit']) : $_CLASS['core_user']->lang['BOT_NEVER'],
+			'L_STATUS'		=> ($row['user_status'] == STATUS_ACTIVE) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+		));
+	}
+	
+	$_CLASS['core_db']->free_result($result);
+	
+	$_CLASS['core_display']->display(false, 'admin/users/bots.html');
+}
+
+$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM ' . USERS_TABLE . ' WHERE user_type = ' . USER_BOT);
+list($count_bots) = $_CLASS['core_db']->fetch_row_num($result);
+$_CLASS['core_db']->free_result($result);
+
+$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM ' . USERS_TABLE . ' WHERE user_type = ' . USER_NORMAL);
+list($count_users) = $_CLASS['core_db']->fetch_row_num($result);
+$_CLASS['core_db']->free_result($result);
+
+
+$_CLASS['core_template']->assign_array(array(
+	'COUNT_BOTS'	=> $count_bots,
+	'COUNT_USERS'	=> $count_users,
+	'LINK_BOTS'		=> generate_link('users&amp;mode=bots', array('admin' => true)),
+	'LINK_ADD_USER'	=> generate_link('users&amp;mode=add_user', array('admin' => true)),
+	'LINK_EDIT_USER'=> generate_link('users&amp;mode=edit_user', array('admin' => true)),
+	//'LAST_VISIT'	=> ($row['user_last_visit']) ?  $_CLASS['core_user']->format_date($row['user_last_visit']) : $_CLASS['core_user']->lang['BOT_NEVER'],
+	//'L_STATUS'		=> ($row['user_status'] == STATUS_ACTIVE) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+));
+
+$_CLASS['core_display']->display(false, 'admin/users/index.html');
+
+?>
\ No newline at end of file

Modified: trunk/blocks/block-theme_select.php
===================================================================
--- trunk/blocks/block-theme_select.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/blocks/block-theme_select.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -17,7 +17,7 @@
 }
 
 $this->content = '
-<form action="'.generate_link($_CLASS['core_user']->url).'" method="post">
+<form action="" method="post">
 	<p style="text-align: center;">
 		<select name="prevtheme" onchange="this.form.submit();">'.theme_select().'</select>
 		<br /><br /><input class="button" value="Select" type="submit" />

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/includes/db/mysql.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 class db_mysql
@@ -424,7 +426,7 @@
 			return;
 		}
 
-		$message = '<u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br />';
+		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br /></td></tr></table>';
 
 		if ($this->in_transaction)
 		{


Property changes on: trunk/includes/db/mysql.php
___________________________________________________________________
Name: svn:keywords
   + Id

Modified: trunk/includes/display/display.php
===================================================================
--- trunk/includes/display/display.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/includes/display/display.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -111,8 +111,11 @@
 	{
 		global $_CLASS, $_CORE_MODULE;
 
-		$_CORE_MODULE['title'] = $title;
-		
+		if ($title)
+		{
+			$_CORE_MODULE['title'] = $title;
+		}
+
 		if ($template)
 		{
 			$_CLASS['core_template']->display($template);
@@ -166,7 +169,7 @@
 
 		$_CLASS['core_template']->assign_array(array(
 			'SITE_LANG'			=>	$_CLASS['core_user']->lang['LANG'],
-			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.$_CORE_MODULE['title'],
+			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.(is_array($_CORE_MODULE['title']) ? implode(' &gt; ', $_CORE_MODULE['title']) : $_CORE_MODULE['title']),
 			'SITE_BASE'			=>	generate_base_url(),
 			'SITE_CHARSET'		=>	'UTF-8',
 			'SITE_NAME'			=>	$_CORE_CONFIG['global']['site_name'],

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/includes/functions.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 // Redo
@@ -371,7 +373,7 @@
 	{
 		$link = $file;
 
-		if ($options['force_sid'] || ($_CLASS['core_user']->sid_link && $options['sid']))
+		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->sid_link))
 		{
 			$link .= '?'.$_CLASS['core_user']->sid_link;
 		}
@@ -385,7 +387,7 @@
 
 		$link = $file.'?mod='.$link;
 
-		if ($options['force_sid'] || ($_CLASS['core_user']->sid_link && $options['sid']))
+		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->sid_link))
 		{
 			$link .= '&amp;'.$_CLASS['core_user']->sid_link;
 		}
@@ -509,17 +511,17 @@
 {
 	global $_CLASS, $_CORE_CONFIG;
 	
-	$sql = 'UPDATE ' . CORE_CONFIG_TABLE . " SET config_value ='".$_CLASS['core_db']->escape($value) . "'
+	$sql = 'UPDATE ' . CORE_CONFIG_TABLE . " SET config_value = '".$_CLASS['core_db']->escape($value) . "'
 		WHERE config_section = '" . $_CLASS['core_db']->escape($section) . "'
 			AND config_name = '". $_CLASS['core_db']->escape($name) ."'";
 
 	if ($auto_add && (!$_CLASS['core_db']->query($sql) || !$_CLASS['core_db']->affected_rows()))
 	{
 		$sql_array = array(
-			'config_section'	=> (string) $section,
-			'config_name'		=> (string) $name,
-			'config_value'		=> (string) $value,
-			'config_cache'		=> (int) $cache,
+			'config_section'=> (string) $section,
+			'config_name'	=> (string) $name,
+			'config_value'	=> (string) $value,
+			'config_cache'	=> (int) $cache,
 		);
 
 		$_CLASS['core_db']->return_on_error(true);
@@ -690,8 +692,7 @@
 
 function redirect($url = false, $save = false)
 {
-	$url = ($url) ? $url : generate_link(false, array('full' => true));
-	$url = trim(str_replace('&amp;', '&', $url));
+	$url = ($url) ? str_replace('&amp;', '&', $url) : generate_link();
 
 	header('Location: ' . $url);
 


Property changes on: trunk/includes/functions.php
___________________________________________________________________
Name: svn:keywords
   + Id

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/includes/functions_user.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 function user_get_id($username, &$difference)
@@ -90,7 +92,7 @@
 	}
 // hook here -- maybe ?
 	$sql = 'UPDATE ' . USERS_TABLE . '
-		SET user_status = ' . USER_ACTIVE . '
+		SET user_status = ' . STATUS_ACTIVE . '
 			WHERE user_id  IN (' . implode(', ', $user_id) . ')
 			AND user_type <>' . USER_GUEST;
 
@@ -111,7 +113,7 @@
 	}
 // hook here -- maybe ?
 	$sql = 'UPDATE ' . USERS_TABLE . '
-		SET user_status = ' . USER_DISABLE . '
+		SET user_status = ' . STATUS_DISABLED . '
 			WHERE user_id  IN (' . implode(', ', $user_id) . ')
 			AND user_type <>' . USER_GUEST;
 	$_CLASS['core_db']->query($sql);
@@ -119,10 +121,10 @@
 	if (in_array($_CORE_CONFIG['user']['newest_user_id'], $user_id))
 	{
 		$sql = 'SELECT user_id, username FROM ' . USERS_TABLE . '
-			WHERE user_type = '.USER_NORMAL.' AND user_status = '.USER_ACTIVE.'
+			WHERE user_type = '.USER_NORMAL.' AND user_status = '.STATUS_ACTIVE.'
 			ORDER BY user_regdate';
 
-		$result = $_CLASS['core_db']->query($sql);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
@@ -147,7 +149,7 @@
 	}
 // hook here -- maybe ?
 	$sql = 'UPDATE ' . USERS_TABLE . '
-		SET user_status = ' . USER_ACTIVE . '
+		SET user_status = ' . STATUS_ACTIVE . '
 			WHERE user_id  IN (' . implode(', ', $user_id) . ')
 			AND user_type =' . USER_NORMAL;
 


Property changes on: trunk/includes/functions_user.php
___________________________________________________________________
Name: svn:keywords
   + Id

Modified: trunk/includes/mailer.php
===================================================================
--- trunk/includes/mailer.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/includes/mailer.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -1,18 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class core_mailer
 {
 	var $message;
@@ -24,7 +32,7 @@
 	
 	// Needed for some windows sendmail emulator/ SMTP
 	// Set to false is you have problems sending
-	var $named_addresses = true;
+	var $named_addresses = false;
 	var $error = '';
 
 	function core_mailer($html = false)
@@ -174,7 +182,7 @@
 			$message = "\n".strip_tags(preg_replace('#<br */?>#i', "\n", modify_lines($this->message)))."\n";
 		}
 
-		if ($_CORE_CONFIG['email']['smtp'])
+		if (!$_CORE_CONFIG['email']['smtp'])
 		{
 			$smtp = new smtp_mailer;
 			if ($connect = $smtp->connect($_CORE_CONFIG['email']['smtp_host'], $_CORE_CONFIG['email']['smtp_port']))


Property changes on: trunk/includes/mailer.php
___________________________________________________________________
Name: svn:keywords
   + Id

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/includes/session.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -19,10 +19,6 @@
 ||**************************************************************||
 
 $Id$
-$Id$
-$Date$
-$Rev$
-$Author$
 */
 
 class sessions
@@ -69,11 +65,11 @@
 			$this->data = $_CLASS['core_db']->fetch_row_assoc($result);
 			$_CLASS['core_db']->free_result($result);
 
-			if (isset($this->data['user_id']) && ($this->data['user_id'] == ANONYMOUS || $this->data['user_status'] == USER_ACTIVE))
+			if (isset($this->data['user_id']) && ($this->data['user_id'] == ANONYMOUS || $this->data['user_status'] == STATUS_ACTIVE))
 			{
 				$valid  = true;
 
-				if ($_CORE_CONFIG['server']['browser_check'] && ($this->data['session_browser'] != $this->browser))
+				if ($this->data['session_browser'] != $this->browser)
 				{
 					$valid  = false;
 				}


Property changes on: trunk/includes/session.php
___________________________________________________________________
Name: svn:keywords
   - Author Rev Date Id
   + Id

Modified: trunk/includes/user.php
===================================================================
--- trunk/includes/user.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/includes/user.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 // sessions should extend this
@@ -35,6 +37,10 @@
 	var $timezone;
 	var $dst;
 
+	var $is_admin;
+	var $is_bot;
+	var $is_user;
+
 	var $user_setup = false;
 
 	var $lang_name;
@@ -190,56 +196,60 @@
 
 		$this->user_setup = true;
 		$this->data['user_unread_privmsg'] = 0; // TEMP
-		// Do the theme
-		$theme_prev = get_variable('theme_preview', 'REQUEST', false);
-		$theme = ($theme) ? $theme : $_CLASS['core_user']->session_data_get('user_theme');
-		
-		if ($theme_prev && ($theme_prev != $theme) && check_theme($theme_prev))
-		{
-			$theme = $theme_prev;
-
-			if (!get_variable('temp_preview', 'REQUEST', false))
+		
+		if (!is_null($theme))
+		{
+			// Do the theme
+			$theme_prev = get_variable('theme_preview', 'REQUEST', false);
+			$theme = ($theme) ? $theme : $_CLASS['core_user']->session_data_get('user_theme');
+			
+			if ($theme_prev && ($theme_prev != $theme) && check_theme($theme_prev))
 			{
-				$_CLASS['core_user']->session_data_set('user_theme', $theme);
+				$theme = $theme_prev;
+	
+				if (!get_variable('temp_preview', 'REQUEST', false))
+				{
+					$_CLASS['core_user']->session_data_set('user_theme', $theme);
+				}
 			}
-		}
-		elseif (!$theme || !check_theme($theme))
-		{
-			$theme = ($_CLASS['core_user']->data['user_theme']) ? $_CLASS['core_user']->data['user_theme'] : $_CORE_CONFIG['global']['default_theme'];     
-		
-			if (!check_theme($theme))
+			elseif (!$theme || !check_theme($theme))
 			{
-				if (check_theme($_CORE_CONFIG['global']['default_theme']))
+				$theme = ($_CLASS['core_user']->data['user_theme']) ? $_CLASS['core_user']->data['user_theme'] : $_CORE_CONFIG['global']['default_theme'];     
+			
+				if (!check_theme($theme))
 				{
-					$theme = $_CORE_CONFIG['global']['default_theme'];
-				}
-				else
-				{
-					// We need a theme, don't we ?
-					$handle = opendir('themes');
-					$theme = false;
-					
-					while ($file = readdir($handle))
+					if (check_theme($_CORE_CONFIG['global']['default_theme']))
 					{
-						if ($file{0} !== '.' && check_theme($file))
+						$theme = $_CORE_CONFIG['global']['default_theme'];
+					}
+					else
+					{
+						// We need a theme, don't we ?
+						$handle = opendir('themes');
+						$theme = false;
+						
+						while ($file = readdir($handle))
 						{
-							$theme = $file;
-							break;
+							if ($file{0} !== '.' && check_theme($file))
+							{
+								$theme = $file;
+								break;
+							}
 						}
+						closedir($handle);
+						
+						if (!$theme)
+						{
+							trigger_error('Something here');
+						}
 					}
-					closedir($handle);
-					
-					if (!$theme)
-					{
-						trigger_error('Something here');
-					}
 				}
-			}
+			}
+	
+			$path = $site_file_root.'themes/'.$theme;
+			
+			$_CLASS['core_display']->load_theme($theme, $path);
 		}
-
-		$path = $site_file_root.'themes/'.$theme;
-		
-		$_CLASS['core_display']->load_theme($theme, $path);
 
 		$this->lang_name = $_CORE_CONFIG['global']['default_lang'];
 		$this->lang_path = $site_file_root.'language/' . $this->lang_name . '/';


Property changes on: trunk/includes/user.php
___________________________________________________________________
Name: svn:keywords
   + Id

Modified: trunk/install/build_data.php
===================================================================
--- trunk/install/build_data.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/install/build_data.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -1,280 +1,322 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 $install_prefix = 'test_';
 
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."admins (admin_section, member_user_id, admin_status) VALUES ('/all/', 2, 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."admins (user_id, group_id, section, status, options) VALUES (2, 0, '/all/', 1, '')");
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
 
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_name', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_url', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'start_date', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_theme', 'viperal', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot2', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_lang', 'en', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dst', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'only_registered', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'News', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mb_mail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_auth_type', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '[\\w_\\+\\. \\-\\[\\]]+', 1)");
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_mail', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_name_chars', '5', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_reg_attempts', '10', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_name_chars', '50', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_pass_chars', '5', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_pass_chars', '25', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_email_reuse', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_change', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_username', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'activation', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'path', '/', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_name', 'viperal', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_path', '/', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_secure', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_load', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_sessions', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'browser_check', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_domain', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'site_name', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'site_url', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'start_date', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'default_theme', 'viperal')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'foot2', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'default_lang', 'en')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'only_registered', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'default_timezone', '-5')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'link_optimization', '1')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('global', 'index_page', 'News')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('maintenance', 'active', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('maintenance', 'start', '1118095980')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('email', 'allow_html_email', '1')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('email', 'email_enable', '1')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('email', 'email_function_name', 'mail')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('email', 'smtp_auth_type', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('email', 'smtp_username', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('email', 'smtp_password', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('email', 'smtp_host', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'require_activation', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'coppa_enable', '1')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'coppa_fax', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'coppa_mail', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'enable_confirm', '1')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'min_name_chars', '5')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'allow_name_chars', '[\\w_\\+\\. \\-\\[\\]]+')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'max_reg_attempts', '10')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'max_name_chars', '50')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'min_pass_chars', '5')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'max_pass_chars', '25')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'chg_passforce', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'allow_emailreuse', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('user', 'allow_namechange', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'path', '/')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'cookie_domain', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'cookie_name', 'viperal')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'cookie_path', '/')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'cookie_secure', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'limit_load', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'limit_sessions', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'ip_check', '4')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'browser_check', '1')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'session_length', '3600')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'error_options', '0')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'optimize_rate', '1200000')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'optimize_last', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'site_domain', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'site_path', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('server', 'site_port', '')");
 
-
-
-
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_colour, group_legend, group_avatar, group_description) VALUES (1, 'GUESTS', 3, '', 0, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_colour, group_legend, group_avatar, group_description) VALUES (2, 'REGISTERED', 3, '', 0, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_colour, group_legend, group_avatar, group_description) VALUES (3, 'REGISTERED_COPPA', 3, '', 0, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_colour, group_legend, group_avatar, group_description) VALUES (4, 'ADMINISTRATORS', 3, 'AA0000', 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_colour, group_legend, group_avatar, group_description) VALUES (5, 'BOTS', 3, '9E8DA7', 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (1, 'GUESTS', 1, 2, '', 0, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (2, 'REGISTERED', 1, 2, '', 0, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (3, 'REGISTERED_COPPA', 1, 2, '', 0, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (4, 'ADMINISTRATORS', 1, 2, 'AA0000', 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (5, 'BOTS', 1, 2, '9E8DA7', 1, '', '')");
 // To be seperated
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_colour, group_legend, group_avatar, group_description) VALUES (6, 'SUPER_MODERATORS', 3, '00AA00', 0, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (6, 'SUPER_MODERATORS', 1, 2, '00AA00', 0, '', '')");
 
 
 //Admin
-#$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (2, 2, 2)");
-#$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (3, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (4, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (6, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (4, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (6, 2, 2)");
 // Anonymous
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (1, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (1, 1, 1)");
 // Bots
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (5, 3, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (5, 4, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (5, 5, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (5, 6, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (5, 7, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_users (group_id, user_id, user_status) VALUES (5, 8, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 3, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 4, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 5, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 6, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 7, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 8, 1)");
 
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (1, 'blocks', 'Blocks', 0, 0, 0, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (2, 'messages', 'Messages', 0, 0, 0, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (3, 'system', 'System', 0, 0, 0, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (4, 'modules', 'Modules', 0, 0, 0, '', 'add:radio\r\n')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (5, 'News', 'News', 1, 1, 1, '0', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (6, 'Recommend_Us', 'Recommend Us', 1, 1, 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (7, 'Submit_News', 'Submit News', 1, 1, 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (8, 'Forums', 'Forums', 1, 1, 2, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (9, 'View_Online', 'View_Online', 1, 1, 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (10, 'Members_List', 'Members_List', 1, 1, 2, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (11, 'Control_Panel', 'Control_Panel', 1, 1, 2, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (12, 'Calender', 'Calender', 1, 1, 2, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (id, name, title, active, type, sides, auth, admin_options) VALUES (13, 'Quick_Message', 'Quick_Message', 1, 1, 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('blocks', 'Blocks', 0, 2,'')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('groups', 'Groups', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('system', 'System', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('messages', 'Messages', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('modules', 'Modules', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('services', 'Services', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('smiles', 'Smiles', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('users', 'Users', 0, 2, '')");
+
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (5, 'News', 'News', 1, 1, 1, '0', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (6, 'Recommend_Us', 'Recommend Us', 1, 1, 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (7, 'Submit_News', 'Submit News', 1, 1, 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (8, 'Forums', 'Forums', 1, 1, 2, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (9, 'View_Online', 'View_Online', 1, 1, 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (10, 'Members_List', 'Members_List', 1, 1, 2, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (11, 'Control_Panel', 'Control_Panel', 1, 1, 2, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (12, 'Calender', 'Calender', 1, 1, 2, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (13, 'Quick_Message', 'Quick_Message', 1, 1, 1, '', '')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':?:', 'question.png', 'Question', 19, 19, 18)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (code, smiley_url, emotion, smiley_width, smiley_height, smiley_order) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':?:', 'question.png', 'Question', 19, 19, 18)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22)");
 
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username) VALUES (1, 16, 1, 'Anonymous')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_password, user_password_encoding, user_colour) VALUES (2, 148, 4, 'Admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (3, 24, 5, 'Googlebot', '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (4, 24, 5, 'MSN', '65.54.188.', 'msnbot/', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (5, 24, 5, 'Yahoo', '66.196.90.1', 'Yahoo! Slurp', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (6, 24, 5, 'Alexa', '66.28.250.,209.237.238.', 'ia_archiver', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (7, 24, 5, 'NaverBot', '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (8, 24, 5, 'Jetbot', '64.71.144.', 'Jetbot/', '')");
 
+// Forums
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_list', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_read', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_post', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_reply', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_edit', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_user_lock', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_delete', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bump', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_poll', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_vote', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_votechg', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_announce', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sticky', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_icons', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_html', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bbsmiley_code', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_smilies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_img', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_flash', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sigs', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_email', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_rate', 1)");
+#$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_print', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_ignoreflood', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_postcount', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_moderate', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_report', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_subscribe', 1)");
+
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_edit', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_delete', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_move', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_lock', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_split', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_merge', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_approve', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_unrate', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_auth', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_ip', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_info', 1, 1)");
+
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_server', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_defaults', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_board', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cookies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_clearlogs', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_words', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_icons', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_bbsmiley_code', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_email', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_styles', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_user', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_useradd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_userdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ranks', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ban', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_names', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_group', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupadd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forum', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumadd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_prune', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_auth', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authmods', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authadmins', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authusers', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authgroups', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authdeps', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_backup', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_restore', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_events', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cron', 1)");
+
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_readpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendim', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_hideonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewprofile', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgavatar', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chggrp', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgname', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgpasswd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgcensors', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_savedrafts', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sig', 1)");
+
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_html', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_bbsmiley_code', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_smilies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_report', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_edit', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_printpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_emailpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_forward', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_delete', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_img', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_flash', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username) VALUES (1, 2, 1, 'Anonymous')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_password, user_password_encoding, user_colour) VALUES (2, 3, 4, 'Admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (3, 4, 5, 'Googlebot', '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (4, 4, 5, 'MSN', '65.54.188.', 'msnbot/', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (5, 4, 5, 'Yahoo', '66.196.90.1', 'Yahoo! Slurp', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (6, 4, 5, 'Alexa', '66.28.250.,209.237.238.', 'ia_archiver', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (7, 4, 5, 'NaverBot', '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (8, 4, 5, 'Jetbot', '64.71.144.', 'Jetbot/', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 1, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 2, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
 
-
-
-
-// Forums
-
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_list', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_read', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_post', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_reply', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_quote', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_edit', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_user_lock', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_delete', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_bump', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_poll', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_vote', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_votechg', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_announce', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_sticky', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_attach', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_download', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_icons', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_html', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_bbcode', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_smilies', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_img', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_flash', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_sigs', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_search', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_email', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_rate', 1");
-#$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_print', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_ignoreflood', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_postcount', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_moderate', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_report', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local) VALUES ('f_subscribe', 1");
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'm_%';
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'm_%';
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_edit', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_delete', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_move', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_lock', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_split', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_merge', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_approve', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_unrate', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_auth', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_ip', 1, 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_local, is_global) VALUES ('m_info', 1, 1");
+# ADMINISTRATOR group - admin and forum rights
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 7, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%';
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 7, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'a_%';
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 7, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 7, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html');
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_server', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_defaults', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_board', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_cookies', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_clearlogs', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_words', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_icons', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_bbcode', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_attach', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_email', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_styles', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_user', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_useradd', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_userdel', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_ranks', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_ban', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_names', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_group', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_groupadd', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_groupdel', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_forum', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_forumadd', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_forumdel', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_prune', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_auth', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_authmods', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_authadmins', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_authusers', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_authgroups', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_authdeps', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_backup', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_restore', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_search', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_events', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('a_cron', 1");
+# SUPER MODERATOR group - moderator rights
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_chgname');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'm_%';
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_sendemail', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_readpm', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_sendpm', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_sendim', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_hideonline', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_viewonline', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_viewprofile', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_chgavatar', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_chggrp', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_chgemail', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_chgname', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_chgpasswd', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_chgcensors', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_search', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_savedrafts', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_download', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_attach', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_sig', 1");
+# REGISTERED/REGISTERED COPPA groups - common forum rights
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_attach', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_html', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_bbcode', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_smilies', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_download', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_report', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_edit', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_printpm', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_emailpm', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_forward', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_delete', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_img', 1");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."auth_options (auth_option, is_global) VALUES ('u_pm_flash', 1");
+# GUESTS, INACTIVE, INACTIVE_COPPA group - basic rights
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 1, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 1, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 2, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 2, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 3, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 3, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
+
+# BOTS - read/view only
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 8, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read');
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 8, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read');
 
-
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbsmiley_code', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html_tags', 'b,i,u,pre', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_smilies', '1', 0)");
@@ -383,7 +425,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_boxes', '4', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_msgs', '50', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_html_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_bbcode_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_bbsmiley_code_pm', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_smilies_pm', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_download_pm', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_report_pm', '1', 0)");
@@ -412,7 +454,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_karma', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbcode', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_flash', '0', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_html', '0', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)");
@@ -420,30 +462,17 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('database_last_gc', '0', 1)");
 
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'MAIN', 'main', 1, 1, 'front\r\nsubscribed\r\nbookmarks,cfg_allow_bookmarks\r\ndrafts', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PM', 'pm', 2, 1, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions', 'cfg_allow_privmsg')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PROFILE', 'profile', 3, 1, 'profile_info\r\nreg_details\r\nsignature\r\navatar', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PREFS', 'prefs', 4, 1, 'personal\r\nview\r\npost', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ZEBRA', 'zebra', 5, 1, 'friends\r\nfoes', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ATTACHMENTS', 'attachments', 6, 1, '', 'acl_u_attach && cfg_allow_attachments')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'GROUPS', 'groups', 7, 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'CALENDER', 'calender', 3, 1, 'month_view\r\nday_view\r\nadd_event', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'MAIN', 'main', 1, 1, 'front\r\nforum_view\r\ntopic_view\r\npost_details', 'acl_m_')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')");
 
 
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('quick_message', 'time', '1')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('quick_message', 'number', '25')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('quick_message', 'height', '200')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('quick_message', 'allow_anonymous', '2')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (section, name, value) VALUES ('quick_message', 'maxlength', '150')");
-
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."quick_message (id, user_id, user_name, ip, message, time) VALUES (1, 0, 'Site', '', 'Lets do this !', ".gmtime().")");
+//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."quick_message (id, user_id, user_name, ip, message, time) VALUES (1, 0, 'Site', '', 'Lets do this !', ".gmtime().")");
 ?>
\ No newline at end of file

Modified: trunk/install/build_tables.php
===================================================================
--- trunk/install/build_tables.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/install/build_tables.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -1,34 +1,52 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 $install_prefix = 'test_';
-$time_field = 1122762758; // max Friday January 19th 2038
+
+function field_unix_time($name, $null = false)
+{
+	global $_CLASS;
+
+	$_CLASS['core_db']->add_table_field_int(array('name' => $name, 'min' => 0, 'max' => 200000000, 'null' => $null));
+}
 
 /*
 	Admin Auth Table
 */
+
 $_CLASS['core_db']->table_create('start', $install_prefix.'admins');
 
-$_CLASS['core_db']->add_table_field_char('section', 100);
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('group_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('status', 0, 1);
-$_CLASS['core_db']->add_table_field_text('options', 60000);
+$_CLASS['core_db']->add_table_field_char('admin_section', 100);
 
-$_CLASS['core_db']->add_table_index('auth_id', 'primary');
-$_CLASS['core_db']->add_table_index('user_id');
-$_CLASS['core_db']->add_table_index('group_id');
+$_CLASS['core_db']->add_table_field_int('member_user_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('member_group_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('admin_status', array('max' => 10));
+$_CLASS['core_db']->add_table_field_text('admin_options', 60000, true);
 
+$_CLASS['core_db']->add_table_index('member_user_id');
+$_CLASS['core_db']->add_table_index('member_group_id');
+$_CLASS['core_db']->add_table_index('admin_status');
+
 $_CLASS['core_db']->table_create('commit');
 
 /*
@@ -36,85 +54,88 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'blocks');
 
-$_CLASS['core_db']->add_table_field_int('id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_char('title', 100);
-$_CLASS['core_db']->add_table_field_int('type', 0, 1);
-$_CLASS['core_db']->add_table_field_int('position', 0, 1);
-$_CLASS['core_db']->add_table_field_int('weight', 0, 200);
-$_CLASS['core_db']->add_table_field_int('active', 0, 1);
-$_CLASS['core_db']->add_table_field_int('start', 0, $time_field);
-$_CLASS['core_db']->add_table_field_int('expires', 0, $time_field);
-$_CLASS['core_db']->add_table_field_text('content', 60000);
-$_CLASS['core_db']->add_table_field_char('file', 255);
-$_CLASS['core_db']->add_table_field_text('auth', 60000);
-$_CLASS['core_db']->add_table_field_char('rss_url', 255);
-$_CLASS['core_db']->add_table_field_int('rss_rate', 0, 60000);
-$_CLASS['core_db']->add_table_field_int('rss_expires', 0, $time_field);
+$_CLASS['core_db']->add_table_field_int('block_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_char('block_title', 100);
+$_CLASS['core_db']->add_table_field_int('block_type', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('block_status', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('block_position', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('block_order', array('max' => 200));
+field_unix_time('block_starts', true);
+field_unix_time('block_expires', true);
+$_CLASS['core_db']->add_table_field_text('block_content', 60000, true);
+$_CLASS['core_db']->add_table_field_char('block_file', 255, true);
+$_CLASS['core_db']->add_table_field_char('block_rss_url', 255, true);
+$_CLASS['core_db']->add_table_field_int('block_rss_rate', array('min' => -1, 'max' => 60000, 'null' => true));
+field_unix_time('block_rss_expires', true);
+$_CLASS['core_db']->add_table_field_text('block_auth', 60000, true);
 
-$_CLASS['core_db']->add_table_index('id', 'primary');
-$_CLASS['core_db']->add_table_index('type');
-$_CLASS['core_db']->add_table_index('position');
+$_CLASS['core_db']->add_table_index('block_id', 'primary');
+$_CLASS['core_db']->add_table_index('block_type');
+$_CLASS['core_db']->add_table_index('block_position');
 
 $_CLASS['core_db']->table_create('commit');
 
 /*
-	Sessions Table
+	Config Table
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'config');
 
-$_CLASS['core_db']->add_table_field_char('section', 20);
-$_CLASS['core_db']->add_table_field_char('name', 20);
-$_CLASS['core_db']->add_table_field_text('value', 60000);
+$_CLASS['core_db']->add_table_field_char('config_section', 20);
+$_CLASS['core_db']->add_table_field_char('config_name', 20);
+$_CLASS['core_db']->add_table_field_text('config_value', 60000);
+$_CLASS['core_db']->add_table_field_int('config_cache', array('max' => 1, 'null' => true));
 
-$_CLASS['core_db']->add_table_index('section');
-$_CLASS['core_db']->add_table_index('name');
+$_CLASS['core_db']->add_table_index(array('config_section', 'config_name'), 'primary');
+$_CLASS['core_db']->add_table_index('config_cache');
 
-
 $_CLASS['core_db']->table_create('commit');
 
 
 /*
-	Grouyps Table
-	`group_chgpass` smallint(6) NOT NULL default '0',
-
+	Groups Table
 */
+
 $_CLASS['core_db']->table_create('start', $install_prefix.'groups');
 
-$_CLASS['core_db']->add_table_field_int('group_id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_int('group_type', 0, 1, 1);
+$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('group_name', 50);
-$_CLASS['core_db']->add_table_field_int('group_display', 0, 1);
-$_CLASS['core_db']->add_table_field_char('group_avatar', 100);
+$_CLASS['core_db']->add_table_field_int('group_type', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('group_status', array('max' => 10));
 
-$_CLASS['core_db']->add_table_field_int('group_avatar_type', 0, 2000);
-$_CLASS['core_db']->add_table_field_int('group_avatar_width', 0, 2000);
-$_CLASS['core_db']->add_table_field_int('group_avatar_height', 0, 2000);
-$_CLASS['core_db']->add_table_field_int('group_rank', 0, 20000, -1);
-
+$_CLASS['core_db']->add_table_field_int('group_rank', array('max' => 2000));
 $_CLASS['core_db']->add_table_field_char('group_colour', 6);
-$_CLASS['core_db']->add_table_field_int('group_sig_chars', 0, 160000);
-$_CLASS['core_db']->add_table_field_int('group_receive_pm', 0, 1);
-$_CLASS['core_db']->add_table_field_int('group_message_limit', 0, 16000000);
+$_CLASS['core_db']->add_table_field_char('group_avatar', 100);
+$_CLASS['core_db']->add_table_field_int('group_avatar_type', 0, 200);
+$_CLASS['core_db']->add_table_field_int('group_avatar_width', 0, 200);
+$_CLASS['core_db']->add_table_field_int('group_avatar_height', 0, 200);
 
+$_CLASS['core_db']->add_table_field_int('group_sig_chars', array('max' => 160000));
+$_CLASS['core_db']->add_table_field_int('group_receive_pm', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('group_message_limit', array('max' => 10000));
+
 $_CLASS['core_db']->add_table_field_char('group_description', 255);
-$_CLASS['core_db']->add_table_field_int('group_legend', 0, 1);
+$_CLASS['core_db']->add_table_field_int('group_display', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('group_legend', array('max' => 10));
 
+
 $_CLASS['core_db']->add_table_index('group_id', 'primary');
+$_CLASS['core_db']->add_table_index('group_display');
 $_CLASS['core_db']->add_table_index('group_legend');
 
 $_CLASS['core_db']->table_create('commit');
 
 /*
-	Groups Users Table
+	Groups Members Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'groups_users');
+$_CLASS['core_db']->table_create('start', $install_prefix.'groups_members');
 
-$_CLASS['core_db']->add_table_field_int('group_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_char('user_id', 100);
-$_CLASS['core_db']->add_table_field_int('user_status', 0, 1);
+$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('member_user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('member_status', array('max' => 16000000));
 
-$_CLASS['core_db']->add_table_index('user_id');
 $_CLASS['core_db']->add_table_index('group_id');
+$_CLASS['core_db']->add_table_index('member_user_id');
+$_CLASS['core_db']->add_table_index('member_status');
 
 $_CLASS['core_db']->table_create('commit');
 
@@ -123,18 +144,18 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'modules');
 
-$_CLASS['core_db']->add_table_field_int('id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_char('name', 100);
-$_CLASS['core_db']->add_table_field_char('title', 100);
-$_CLASS['core_db']->add_table_field_int('active', 0, 1);
-$_CLASS['core_db']->add_table_field_int('type', 0, 1);
-$_CLASS['core_db']->add_table_field_int('sides', 0, 1);
-$_CLASS['core_db']->add_table_field_text('auth', 60000);
-$_CLASS['core_db']->add_table_field_text('admin_options', 200);
+$_CLASS['core_db']->add_table_field_int('module_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_char('module_name', 100);
+$_CLASS['core_db']->add_table_field_char('module_title', 100);
+$_CLASS['core_db']->add_table_field_int('module_type', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('module_status', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('module_sides', array('max' => 10, 'null' => true));
+$_CLASS['core_db']->add_table_field_text('module_auth', 60000, true);
+$_CLASS['core_db']->add_table_field_text('module_auth_options', 60000, true);
+$_CLASS['core_db']->add_table_field_text('module_admin_options', 6000, true);
 
-$_CLASS['core_db']->add_table_index('id', 'primary');
-$_CLASS['core_db']->add_table_index('name', 'unique');
-$_CLASS['core_db']->add_table_index('homepage'); // to be removed late on
+$_CLASS['core_db']->add_table_index('module_id', 'primary');
+$_CLASS['core_db']->add_table_index('module_name', 'unique');
 
 $_CLASS['core_db']->table_create('commit');
 
@@ -145,17 +166,19 @@
 
 $_CLASS['core_db']->add_table_field_char('session_id', 40);
 $_CLASS['core_db']->add_table_field_int('session_user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('session_last_visit', 0, $time_field);
-$_CLASS['core_db']->add_table_field_int('session_start', 0, $time_field);
-$_CLASS['core_db']->add_table_field_int('session_time', 0, $time_field);
+field_unix_time('session_last_visit');
+field_unix_time('session_start');
+field_unix_time('session_time');
 $_CLASS['core_db']->add_table_field_char('session_ip', 18);
 $_CLASS['core_db']->add_table_field_char('session_browser', 255);
 $_CLASS['core_db']->add_table_field_char('session_page', 100);
 $_CLASS['core_db']->add_table_field_char('session_url', 255);
-$_CLASS['core_db']->add_table_field_int('session_user_type', 0, 1);
-$_CLASS['core_db']->add_table_field_int('session_admin', 0, 1);
-$_CLASS['core_db']->add_table_field_text('session_auth', 60000);
+$_CLASS['core_db']->add_table_field_int('session_user_type', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('session_admin', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('session_hidden', array('max' => 10));
+
 $_CLASS['core_db']->add_table_field_text('session_data', 60000);
+$_CLASS['core_db']->add_table_field_text('session_auth', 60000);
 
 $_CLASS['core_db']->add_table_index('session_id', 'primary');
 $_CLASS['core_db']->add_table_index('session_time');
@@ -164,60 +187,47 @@
 $_CLASS['core_db']->table_create('commit');
 
 /*
-	Smiles Table
+	Sessions Auto login Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'smilies');
+$_CLASS['core_db']->table_create('start', $install_prefix.'sessions_auto_login');
 
-$_CLASS['core_db']->add_table_field_int('smiley_id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_char('code', 10);
-$_CLASS['core_db']->add_table_field_char('emotion', 50);
-$_CLASS['core_db']->add_table_field_char('smiley_url', 50);
-$_CLASS['core_db']->add_table_field_int('smiley_width', 0, 200);
-$_CLASS['core_db']->add_table_field_int('smiley_height', 0, 200);
-$_CLASS['core_db']->add_table_field_int('smiley_order', 0, 200);
-$_CLASS['core_db']->add_table_field_int('display_on_posting', 0, 1);
+$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_char('auto_login_browser', 255);
+$_CLASS['core_db']->add_table_field_char('auto_login_code', 40);
+field_unix_time('auto_login_time');
 
-$_CLASS['core_db']->add_table_index('smiley_id', 'primary');
-$_CLASS['core_db']->add_table_index('display_on_posting');
+$_CLASS['core_db']->add_table_index(array('user_id', 'auto_login_code'), 'primary');
 
 $_CLASS['core_db']->table_create('commit');
 
-//////
-//Quick Message
-//////
+/*
+	Smiles Table
+*/
+$_CLASS['core_db']->table_create('start', $install_prefix.'smilies');
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'quick_message');
+$_CLASS['core_db']->add_table_field_int('smiley_id', array('max' => 16000000, 'auto_increment' => true));
 
-$_CLASS['core_db']->add_table_field_int('id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_char('user_name', 80);
-$_CLASS['core_db']->add_table_field_char('ip', 18);
-$_CLASS['core_db']->add_table_field_text('message', 200);
-$_CLASS['core_db']->add_table_field_int('time', 0, $time_field);
+$_CLASS['core_db']->add_table_field_char('smiley_code', 10);
+$_CLASS['core_db']->add_table_field_char('smiley_src', 200);
+$_CLASS['core_db']->add_table_field_char('smiley_description', 50);
 
-$_CLASS['core_db']->add_table_index('id', 'primary');
-$_CLASS['core_db']->add_table_index('time');
+$_CLASS['core_db']->add_table_field_int('smiley_width', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('smiley_height', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('smiley_order', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('smiley_type', array('max' => 10));
 
+$_CLASS['core_db']->add_table_index('smiley_id', 'primary');
+$_CLASS['core_db']->add_table_index('smiley_type');
+
 $_CLASS['core_db']->table_create('commit');
 
-
 /*
 
-`user_passchg` int(11) NOT NULL default '0',
-`user_timezone` decimal(5,2) NOT NULL default '0.00',
-`user_dst` tinyint(1) NOT NULL default '0',
- `user_unread_privmsg` tinyint(4) unsigned NOT NULL default '0',
-`user_occ` varchar(255) NOT NULL default '',
+`user_unread_privmsg` tinyint(4) unsigned NOT NULL default '0',
 `user_newpasswd` varchar(40) NOT NULL default '',
- `user_emailtime` int(11) NOT NULL default '0',
-  `user_actkey` varchar(32) NOT NULL default '',
-  `user_newpasswd` varchar(40) NOT NULL default '',
-  `user_viewemail` tinyint(1) NOT NULL default '0',
-user_lastpost_time
-  
+`user_viewemail` tinyint(1) NOT NULL default '0',
 */
 
-
 $_CLASS['core_db']->table_create('start', $install_prefix.'users');
 
 $_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000, 0, true);
@@ -230,14 +240,15 @@
 $_CLASS['core_db']->add_table_field_char('user_ip', 255);
 $_CLASS['core_db']->add_table_field_char('user_agent', 255);
 $_CLASS['core_db']->add_table_field_int('user_timezone', -43200 , 46800);
+$_CLASS['core_db']->add_table_field_int('user_dst', 0 , 1);
 
-$_CLASS['core_db']->add_table_field_int('user_regdate', 0, $time_field);
-$_CLASS['core_db']->add_table_field_text('user_permissions', 60000); // phpBBs
+field_unix_time('user_regdate');
+$_CLASS['core_db']->add_table_field_text('user_permissions', 60000); // phpBBs rename user_forums_permissions
 $_CLASS['core_db']->add_table_field_char('user_email', 100);
 $_CLASS['core_db']->add_table_field_char('user_birthday', 10);
 $_CLASS['core_db']->add_table_field_text('user_data', 6000);
-$_CLASS['core_db']->add_table_field_int('user_last_visit', 0, $time_field);
-$_CLASS['core_db']->add_table_field_int('user_last_post_time', 0, $time_field);
+field_unix_time('user_last_visit');
+field_unix_time('user_last_post_time');
 $_CLASS['core_db']->add_table_field_int('user_warnings', 0, 10000);
 $_CLASS['core_db']->add_table_field_char('user_lang', 10);
 $_CLASS['core_db']->add_table_field_char('user_theme', 60);
@@ -258,8 +269,6 @@
 $_CLASS['core_db']->add_table_field_char('user_interests', 255);
 $_CLASS['core_db']->add_table_field_char('user_occ', 255);
 
-$_CLASS['core_db']->add_table_field_int('user_posts', 16000000);
-
 $_CLASS['core_db']->add_table_field_int('user_message_limit', 0, 200);
 $_CLASS['core_db']->add_table_field_int('user_message_rules', 0, 1);
 
@@ -286,6 +295,9 @@
 $_CLASS['core_db']->add_table_field_char('user_post_sortby_type', 1);
 $_CLASS['core_db']->add_table_field_char('user_post_sortby_dir', 1);
 
+$_CLASS['core_db']->add_table_field_int('user_posts', 16000000);
+field_unix_time('user_lastpost_time');
+
 $_CLASS['core_db']->add_table_field_int('user_allow_viewonline', 0, 1, 1);
 $_CLASS['core_db']->add_table_field_int('user_allow_viewemail', 0, 1, 1);
 $_CLASS['core_db']->add_table_field_int('user_allow_massemail', 0, 1, 1);
@@ -296,6 +308,8 @@
 $_CLASS['core_db']->add_table_field_int('user_avatar_height', 0, 100);
 
 $_CLASS['core_db']->add_table_field_char('user_act_key', 40);
+$_CLASS['core_db']->add_table_field_char('user_new_password', 40);
+$_CLASS['core_db']->add_table_field_char('user_new_password_encoding', 10);
 
 $_CLASS['core_db']->add_table_index('user_id', 'primary');
 $_CLASS['core_db']->add_table_index('username');
@@ -326,7 +340,7 @@
 $_CLASS['core_db']->add_table_field_char('extension', 50);
 $_CLASS['core_db']->add_table_field_char('mimetype', 100);
 $_CLASS['core_db']->add_table_field_int('filesize', 0, 1000000000);
-$_CLASS['core_db']->add_table_field_int('filetime', 0, $time_field);
+field_unix_time('filetime');
 
 $_CLASS['core_db']->add_table_index('attach_id', 'primary');
 $_CLASS['core_db']->add_table_index('post_msg_id');
@@ -349,7 +363,6 @@
 $_CLASS['core_db']->add_table_index('user_id');
 $_CLASS['core_db']->add_table_index('group_id');
 $_CLASS['core_db']->add_table_index('auth_option_id');
-#$_CLASS['core_db']->add_table_index('auth_option', 'unique');
 
 $_CLASS['core_db']->table_create('commit');
 
@@ -365,7 +378,7 @@
 $_CLASS['core_db']->add_table_field_int('founder_only', 0, 1);
 
 $_CLASS['core_db']->add_table_index('auth_option_id', 'primary');
-$_CLASS['core_db']->add_table_index('auth_option');
+$_CLASS['core_db']->add_table_index('auth_option', 'unique');
 
 $_CLASS['core_db']->table_create('commit');
 
@@ -435,7 +448,7 @@
 $_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
 $_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
 $_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('save_time', 0, $time_field);
+field_unix_time('save_time');
 $_CLASS['core_db']->add_table_field_char('draft_subject', 50);
 $_CLASS['core_db']->add_table_field_text('draft_message', 0, 16000000);
 
@@ -506,13 +519,13 @@
 $_CLASS['core_db']->add_table_field_int('forum_topics_real', 0, 16000000);
 $_CLASS['core_db']->add_table_field_int('forum_last_post_id', 0, 16000000);
 $_CLASS['core_db']->add_table_field_int('forum_last_poster_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('forum_last_post_time', 0, $time_field);
+field_unix_time('forum_last_post_time');
 $_CLASS['core_db']->add_table_field_char('forum_last_poster_name', 50);
 $_CLASS['core_db']->add_table_field_int('forum_flags', 0, 200);
 $_CLASS['core_db']->add_table_field_int('display_on_index', 0, 1);
 $_CLASS['core_db']->add_table_field_int('enable_indexing', 0, 1);
 $_CLASS['core_db']->add_table_field_int('enable_icons', 0, 1);
-$_CLASS['core_db']->add_table_field_int('prune_next', 0, $time_field);
+field_unix_time('prune_next');
 
 //////
 $_CLASS['core_db']->add_table_field_int('prune_days', 0, 200);
@@ -536,14 +549,14 @@
 $_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000);
 $_CLASS['core_db']->add_table_field_int('right_id', 0, 16000);
 $_CLASS['core_db']->add_table_field_int('poster_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('post_time', 0, $time_field);
+field_unix_time('post_time');
 $_CLASS['core_db']->add_table_field_char('poster_ip', 20);
 $_CLASS['core_db']->add_table_field_char('post_username', 50);
 $_CLASS['core_db']->add_table_field_int('enable_bbcode', 0, 1);
 $_CLASS['core_db']->add_table_field_int('enable_html', 0, 1);
 $_CLASS['core_db']->add_table_field_int('enable_smilies', 0, 1);
 $_CLASS['core_db']->add_table_field_int('enable_sig', 0, 1);
-$_CLASS['core_db']->add_table_field_int('post_edit_time', 0, $time_field);
+field_unix_time('post_edit_time');
 $_CLASS['core_db']->add_table_field_int('post_edit_count', 0, 20000);
 $_CLASS['core_db']->add_table_field_int('post_attachment', 0, 1);
 $_CLASS['core_db']->add_table_field_char('post_subject', 50);
@@ -578,7 +591,7 @@
 $_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
 $_CLASS['core_db']->add_table_field_char('topic_title', 50);
 $_CLASS['core_db']->add_table_field_int('topic_poster', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('topic_time', 0, $time_field);
+field_unix_time('topic_time');
 $_CLASS['core_db']->add_table_field_int('topic_views', 0, 16000000);
 $_CLASS['core_db']->add_table_field_int('topic_replies', 0, 16000000);  
 $_CLASS['core_db']->add_table_field_int('topic_status', 0, 1);
@@ -591,22 +604,22 @@
 $_CLASS['core_db']->add_table_field_int('topic_attachment', 0, 1);
 $_CLASS['core_db']->add_table_field_int('topic_approved', 0, 1, 1);
 $_CLASS['core_db']->add_table_field_int('topic_reported', 0, 1); 
-$_CLASS['core_db']->add_table_field_int('topic_time_limit', 0, $time_field);
+field_unix_time('topic_time_limit');
 $_CLASS['core_db']->add_table_field_int('topic_replies_real', 16000000);
 $_CLASS['core_db']->add_table_field_char('topic_first_poster_name', 50);
 $_CLASS['core_db']->add_table_field_int('topic_last_poster_id', 0, 16000000);
 $_CLASS['core_db']->add_table_field_char('topic_last_poster_name', 50);
-$_CLASS['core_db']->add_table_field_int('topic_last_post_time', 0, $time_field);
-$_CLASS['core_db']->add_table_field_int('topic_last_view_time', 0, $time_field);
+field_unix_time('topic_last_post_time');
+field_unix_time('topic_last_view_time');
 
 $_CLASS['core_db']->add_table_field_int('topic_bumped', 0, 1);
 $_CLASS['core_db']->add_table_field_int('topic_bumper', 0, 16000000);
   
 $_CLASS['core_db']->add_table_field_char('poll_title', 100);
-$_CLASS['core_db']->add_table_field_int('poll_start', 0, $time_field);
-$_CLASS['core_db']->add_table_field_int('poll_length', 0, $time_field); 
+field_unix_time('poll_start');
+field_unix_time('poll_length'); 
 $_CLASS['core_db']->add_table_field_int('poll_max_options', 0, 200, 1);
-$_CLASS['core_db']->add_table_field_int('poll_last_vote', 0, $time_field);
+field_unix_time('poll_last_vote');
 $_CLASS['core_db']->add_table_field_int('poll_vote_change', 0, 1);
 
 $_CLASS['core_db']->add_table_index('topic_id', 'primary');
@@ -625,7 +638,7 @@
 $_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
 $_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
 $_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('mark_time', 0, $time_field);
+field_unix_time('mark_time');
 
 $_CLASS['core_db']->add_table_index('user_id');
 $_CLASS['core_db']->add_table_index('forum_id');
@@ -652,23 +665,9 @@
 /*
 	Forums Forums Watch Table
 */
+
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_watch');
 
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('notify_status', 0, 1);
-
-$_CLASS['core_db']->add_table_index('user_id');
-
-$_CLASS['core_db']->table_create('commit');
-
-//
-//Combine, maybe
-//
-/*
-	Forums Topics Watch Table
-*/
-$_CLASS['core_db']->table_create('start', $install_prefix.'topics_watch');
-
 $_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
 $_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
 $_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);

Added: trunk/javascript/menu.js
===================================================================
--- trunk/javascript/menu.js	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/javascript/menu.js	2005-08-19 01:49:31 UTC (rev 87)
@@ -0,0 +1,151 @@
+// Menu Code by Ryan Marshall ( viperal1 at gmail.com )
+
+/*
+* To do:
+*
+*	Add some kind of slide affect
+*	Menu generator in javascript
+*	Auto closing of menu...
+*	
+*/
+
+var active_menu = false;
+
+function get_offsets(element)
+{
+	var offsets = new Array();
+
+	offsets['top']	= element.offsetTop;
+	offsets['left']	= element.offsetLeft;
+
+	while ((element = element.offsetParent) != null)
+	{
+		offsets['top']	+= element.offsetTop;
+		offsets['left']	+= element.offsetLeft;
+	}
+
+	return offsets;
+}
+
+function menu_init(object_name)
+{
+	var menu		= document.getElementById(object_name + '_menu');
+	var object		= document.getElementById(object_name);
+
+	if (menu == null|| object == null)
+	{
+		return;
+	}
+
+	object.onclick = function()
+	{
+		/* Open or close the menu */
+		if (menu.style.display == 'none')
+		{
+			menu_show(object_name);
+		}
+		else
+		{
+			menu_hide(object_name);
+		}
+
+		return false;
+	}
+	
+/*
+	need to read more to get these working :-(
+
+	object.onmouseover = function()
+	{
+		//menu_show(object_name);
+	}
+	
+	object.onmouseout = function(e)
+	{
+		menu_hide(object_name);
+	}
+
+	menu.onmouseout = function(e)
+	{
+		menu_hide(object_name);
+	}
+
+	menu.onmouseover = function(e)
+	{
+		this.onmouseout = function(e)
+		{
+			menu_hide(object_name);
+		}
+
+		e.preventDefault();
+		e.stopPropagation();
+	}
+
+	menu.onmouseout = function()
+	{
+		menu_hide(object_name);
+	}
+*/
+
+	menu.style.display	= 'none';
+	menu.style.position	= 'absolute';
+	menu.style.zIndex = 1000;
+	object.style.cursor = 'pointer';
+}
+
+function menu_show(object_name)
+{
+	var menu		= document.getElementById(object_name + '_menu');
+	var object		= document.getElementById(object_name);
+
+	if (menu == null|| object == null)
+	{
+		return;
+	}
+
+	// If a menu is open, lets close it
+	if (active_menu)
+	{
+		menu_hide(active_menu);
+	}
+
+	active_menu = object_name;
+
+	// best to do this everytime, incase the windows is resized
+	var object_offsets = get_offsets(object);
+
+	menu.style.display	= '';
+	
+//Move to init function, once done
+	menu.style.position	= 'absolute';
+
+	if ((object_offsets['left'] + menu.offsetWidth) > document.body.clientWidth)
+	{
+		// It to wide to show on the right so we have to put it on the left
+		menu.style.left = (object_offsets['left'] + object.offsetWidth - menu.offsetWidth) + 'px';
+	}
+	else
+	{
+		menu.style.left = object_offsets['left'] + 'px';
+	}
+
+	menu.style.top = (object_offsets['top'] + object.offsetHeight) + 'px';
+}
+
+function menu_hide(object_name)
+{
+	if (!object_name)
+	{
+		object_name = active_menu;
+	}
+
+	var menu		= document.getElementById(object_name + '_menu');
+	var object		= document.getElementById(object_name);
+
+	if (active_menu == object_name)
+	{
+		active_menu = false;
+	}
+	
+	menu.style.display = 'none';	
+}
\ No newline at end of file

Modified: trunk/modules/Control_Panel/ucp/ucp_zebra.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_zebra.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/modules/Control_Panel/ucp/ucp_zebra.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -59,11 +59,11 @@
 				$data['add'] = array_diff($data['add'], $friends, $foes, array($_CLASS['core_user']->data['username']));
 				unset($friends, $foes);
 
-				$data['add'] = implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', "\"'\" . \$_CLASS['core_db']->sql_escape('\\1') . \"'\"", $data['add']));
+				$data['add'] = "'".implode("', '", $_CLASS['core_db']->escape_array($data['add']))."'";
 
 				if ($data['add'])
 				{
-					$sql = 'SELECT user_id, user_type
+					$sql = 'SELECT user_id, user_type, user_status
 						FROM ' . USERS_TABLE . ' 
 						WHERE username IN (' . $data['add'] . ')';
 					$result = $_CLASS['core_db']->query($sql);
@@ -73,7 +73,7 @@
 						$user_id_ary = array();
 						do
 						{
-							if (!in_array($row['user_type'], array(USER_IGNORE, USER_INACTIVE, USER_BOT_ACTIVE, USER_BOT_INACTIVE)))
+							if ($row['user_type'] == USER_NORMAL && $row['user_status'] == STATUS_ACTIVE)
 							{
 								$user_id_ary[] = $row['user_id'];
 							}

Modified: trunk/modules/Forums/faq.php
===================================================================
--- trunk/modules/Forums/faq.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/modules/Forums/faq.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -1,129 +1,106 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
-// -------------------------------------------------------------
-//
-// $Id: faq.php,v 1.27 2004/07/08 22:40:42 acydburn Exp $
-//
-// FILENAME  : faq.php 
-// STARTED   : Mon Jul 8, 2001
-// COPYRIGHT : ? 2001, 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
+$Id$
+*/
 
 if (!defined('VIPERAL'))
 {
-    die();
+    die;
 }
 
-$mode = request_var('mode', '');
-
-// Load the appropriate faq file
-switch ($mode)
+if (isset($_REQUEST['mode']) && $_REQUEST['mode'] == 'bbcode')
 {
-	case 'bbcode':
-		$_CLASS['core_user']->add_lang('help_bbcode','Forums');
-		$l_title = $_CLASS['core_user']->get_lang('BBCODE_GUIDE');
-		$link = '&amp;mode=bbcode';
-	break;
-
-	default:
-		$_CLASS['core_user']->add_lang('help_faq','Forums');
-		$l_title = $_CLASS['core_user']->get_lang('FAQ');
-		$link = '';
-	break;
+	$_CLASS['core_user']->add_lang('help_bbcode','Forums');
+	$l_title = $_CLASS['core_user']->get_lang('BBCODE_GUIDE');
+	$link = '&amp;mode=bbcode';
+	$mode = 'bbcode';
 }
+else
+{
+	$_CLASS['core_user']->add_lang('help_faq','Forums');
+	$l_title = $_CLASS['core_user']->get_lang('FAQ');
+	$link = $mode = '';
+}
 
-// Pull the array data from the lang pack
-$j = 0;
-$counter = 0;
-$counter_2 = 0;
-$help_block = array();
-$help_block_titles = array();
+$_CLASS['core_template']->assign_array(array(
+	'L_FAQ_TITLE'	=> $l_title,
+	'S_BACK_TO_TOP'	=> generate_link('Forums&amp;file=faq'.$link.'#Top')
+));
 
-foreach ($_CLASS['core_user']->lang['help'] as $help_ary)
+$id = 0;
+$next_title = false;
+
+$size = count($_CLASS['core_user']->lang['help']);
+
+for ($i = 0; $i < $size; $i++)
 {
-	if ($help_ary[0] != '--')
+	if ($_CLASS['core_user']->lang['help'][$i][0] == '--')
 	{
-		$help_block[$j][$counter]['id'] = $counter_2;
-		$help_block[$j][$counter]['question'] = $help_ary[0];
-		$help_block[$j][$counter]['answer'] = $help_ary[1];
-
-		$counter++;
-		$counter_2++;
+		if ($next_title !== false)
+		{
+			$_CLASS['core_template']->assign_vars_array('faq_block', array(
+				'BLOCK_TITLE'	=> $_CLASS['core_user']->lang['help'][$next_title][1],
+				'faq_row'		=> $faq_row
+			));
+	
+			$_CLASS['core_template']->assign_vars_array('faq_block_link', array(
+				'BLOCK_TITLE'		=> $_CLASS['core_user']->lang['help'][$next_title][1],
+				'faq_row_link'		=> $faq_row_link
+			));
+		}
+		
+		$next_title = $i;
+		$faq_row = $faq_row_link = array();
 	}
 	else
 	{
-		$j = ($counter != 0) ? $j + 1 : 0;
+		$id ++;
 
-		$help_block_titles[$j] = $help_ary[1];
+		$faq_row[] = array(
+			'FAQ_QUESTION' 		=> $_CLASS['core_user']->lang['help'][$i][0],
+			'FAQ_ANSWER'		=> $_CLASS['core_user']->lang['help'][$i][1],
 
-		$counter = 0;
+			'U_FAQ_ID' 			=> $id
+		);
+
+		$faq_row_link[] = array(
+			'FAQ_LINK' 			=> $_CLASS['core_user']->lang['help'][$i][0],
+			'U_FAQ_LINK'		=> generate_link('Forums&amp;file=faq'.$link.'#' . $id)
+		);
 	}
 }
 
-//
-// Lets build a page ...
-$_CLASS['core_template']->assign('L_FAQ_TITLE', $l_title);
-
-$size = sizeof($help_block);
-for ($i = 0, $size; $i < $size; $i++)
+if ($next_title !== false)
 {
-	if (sizeof($help_block[$i]))
-	{
-		$_size = sizeof($help_block[$i]);
-		$faq_row_link = $faq_row = array();
-		
-		for ($j = 0; $j < $_size; $j++)
-		{
-			$faq_row[] = array(
-				'FAQ_SECTION' 		=> $i,
-				'FAQ_QUESTION' 		=> $help_block[$i][$j]['question'],
-				'FAQ_ANSWER'		=> $help_block[$i][$j]['answer'],
-
-				'U_FAQ_ID' 			=> $help_block[$i][$j]['id']
-			);
-
-			$faq_row_link[] = array(
-				'FAQ_LINK' 			=> $help_block[$i][$j]['question'],
-				'FAQ_SECTION' 		=> $i,
-				'U_FAQ_LINK'		=> generate_link('Forums&amp;file=faq'.$link.'#' . $help_block[$i][$j]['id'])
-			);
-		}
-		
-		$_CLASS['core_template']->assign_vars_array('faq_block', array(
-			'BLOCK_TITLE'	=> $help_block_titles[$i],
-			'faq_row'		=> $faq_row
-		));
-
-		$_CLASS['core_template']->assign_vars_array('faq_block_link', array(
-			'BLOCK_TITLE'		=> $help_block_titles[$i],
-			'faq_row_link'		=> $faq_row_link
-		));
-		
-	}
+	$_CLASS['core_template']->assign_vars_array('faq_block', array(
+		'BLOCK_TITLE'	=> $_CLASS['core_user']->lang['help'][$next_title][1],
+		'faq_row'		=> $faq_row
+	));
+	
+	$_CLASS['core_template']->assign_vars_array('faq_block_link', array(
+		'BLOCK_TITLE'		=> $_CLASS['core_user']->lang['help'][$next_title][1],
+		'faq_row_link'		=> $faq_row_link
+	));
 }
 
-$_CLASS['core_template']->assign(array(
-	'L_BACK_TO_TOP'			=> $_CLASS['core_user']->lang['BACK_TO_TOP'],
-	'L_JUMP_TO'				=> $_CLASS['core_user']->lang['JUMP_TO'],
-	'L_GO'					=> $_CLASS['core_user']->lang['GO'],
-	'S_BACK_TO_TOP'			=> generate_link('Forums&amp;file=faq'.$link.'#Top')
-));
-
-
 $_CLASS['core_template']->assign('DISPLAY_STYLESHEET_LINK', ($mode == 'bbcode'));
 
 page_header();

Modified: trunk/modules/Forums/posting.php
===================================================================
--- trunk/modules/Forums/posting.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/modules/Forums/posting.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -420,7 +420,7 @@
 		WHERE user_id = " . $_CLASS['core_user']->data['user_id']);
 
 	$_CLASS['core_db']->transaction('commit');
-	
+
 	markread('topic', $forum_id, $topic_id, $current_time);
 
 	add_log('mod', $forum_id, $topic_id, sprintf($_CLASS['core_user']->lang['LOGM_BUMP'], $topic_title));

Modified: trunk/modules/Forums/viewforum.php
===================================================================
--- trunk/modules/Forums/viewforum.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/modules/Forums/viewforum.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -145,7 +145,7 @@
 	// Handle marking posts
 	if ($mark_read == 'topics')
 	{
-		markread('mark', $forum_id);
+		markread('forum', $forum_id);
 		
 		$_CLASS['core_display']->meta_refresh(3, generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id));
 
@@ -391,7 +391,7 @@
 			{
 				if ($mark_forum_read)
 				{
-					//$mark_forum_read = ($row['topic_last_post_time'] < $mark_time_topic) ? (int) max($mark_time_topic, $row['topic_last_post_time']) : false;
+					$mark_forum_read = ($row['topic_last_post_time'] <= $mark_time_topic) ? (int) $mark_time_topic : false;
 				}
 				$mark_time = $mark_time_topic;
 			}
@@ -470,7 +470,7 @@
 	// Update the marktime only if $mark_forum_read is set to a time
 	if ($forum_data['forum_type'] == FORUM_POST && is_int($mark_forum_read))
 	{
-		markread('forum', $forum_id, 0, $mark_forum_read);
+		markread('forum', $forum_id, false, $mark_forum_read);
 	}
 }
 else

Modified: trunk/modules/Forums/viewtopic.php
===================================================================
--- trunk/modules/Forums/viewtopic.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/modules/Forums/viewtopic.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -58,9 +58,6 @@
 $sort_key	= request_var('sk', ((!empty($_CLASS['core_user']->data['user_post_sortby_type'])) ? $_CLASS['core_user']->data['user_post_sortby_type'] : 't'));
 $sort_dir	= request_var('sd', ((!empty($_CLASS['core_user']->data['user_post_sortby_dir'])) ? $_CLASS['core_user']->data['user_post_sortby_dir'] : 'a'));
 
-// Find topic id if user requested a newer or older topic
-$unread_post_id = 0;
-
 if ($topic_id)
 {
 	$sql = 'SELECT forum_id, topic_last_post_time FROM ' . FORUMS_TOPICS_TABLE . '
@@ -85,80 +82,48 @@
 $topic_id = ($topic_id) ? $topic_id : $row['topic_id'];
 $topic_last_post_time = isset($row['topic_last_post_time']) ? $row['topic_last_post_time'] : false;
 
-if ($view)
+if ($view == 'next' || $view == 'previous')
 {
-	if ($view == 'unread')
+	if ($view == 'next')
 	{
-		$topic_last_read = topic_last_read($topic_id, $forum_id);
+		$sql_condition = '>';
+		$sql_ordering = 'ASC';
+	}
+	else
+	{
+		$sql_condition = '<';
+		$sql_ordering = 'DESC';
+	}
 
-		$sql = 'SELECT p.post_id, p.topic_id, p.forum_id
-			FROM (' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . " t)
-			WHERE t.topic_id = $topic_id
-				AND p.topic_id = t.topic_id
-				" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND p.post_approved = 1') . "
-				AND p.post_time > $topic_last_read
-			ORDER BY p.post_time ASC";
-		$result = $_CLASS['core_db']->query_limit($sql, 1);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	if (!$topic_last_post_time)
+	{
+		$sql = 'SELECT topic_last_post_time FROM ' . FORUMS_TOPICS_TABLE . '
+					WHERE topic_id = '.$topic_id;
+
+		$result = $_CLASS['core_db']->query($sql);
+		list($topic_last_post_time) = $_CLASS['core_db']->fetch_row_num($result);
 		$_CLASS['core_db']->free_result($result);
+	}
 
-		if (!$row)
-		{
-			// Setup user environment so we can process lang string
-			$_CLASS['core_user']->add_lang('viewtopic');
+	$sql = 'SELECT topic_id, forum_id
+		FROM ' . FORUMS_TOPICS_TABLE . "
+		 WHERE forum_id = $forum_id AND topic_last_post_time $sql_condition $topic_last_post_time"
+		 . ($_CLASS['auth']->acl_get('m_approve', $forum_id) ? '' : ' AND topic_approved = 1') . "
+		ORDER BY topic_last_post_time $sql_ordering";
 
-			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id"));
-			$message = $_CLASS['core_user']->lang['NO_UNREAD_POSTS'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id").'">', '</a>');
-			trigger_error($message);
-		}
+	$result = $_CLASS['core_db']->query_limit($sql, 1);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
 
-		$unread_post_id = $post_id = $row['post_id'];
-		$topic_id = $row['topic_id'];
+	if (!$row)
+	{
+		$message = ($view == 'next') ? 'NO_NEWER_TOPICS' : 'NO_OLDER_TOPICS';
+		trigger_error($message);
 	}
-	elseif ($view == 'next' || $view == 'previous')
+	else
 	{
-		if ($view == 'next')
-		{
-			$sql_condition = '>';
-			$sql_ordering = 'ASC';
-		}
-		else
-		{
-			$sql_condition = '<';
-			$sql_ordering = 'DESC';
-		}
-
-		if (!$topic_last_post_time)
-		{
-			$sql = 'SELECT topic_last_post_time FROM ' . FORUMS_TOPICS_TABLE . '
-						WHERE topic_id = '.$topic_id;
-
-			$result = $_CLASS['core_db']->query($sql);
-			list($topic_last_post_time) = $_CLASS['core_db']->fetch_row_num($result);
-			$_CLASS['core_db']->free_result($result);
-		}
-
-// should we only find the next topic with in the forum ?
-		$sql = 'SELECT topic_id, forum_id
-			FROM ' . FORUMS_TOPICS_TABLE . "
-			 WHERE forum_id = $forum_id AND topic_last_post_time $sql_condition $topic_last_post_time"
-			 . ($_CLASS['auth']->acl_get('m_approve', $forum_id) ? '' : ' AND topic_approved = 1') . "
-			ORDER BY topic_last_post_time $sql_ordering";
-	
-		$result = $_CLASS['core_db']->query_limit($sql, 1);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		if (!$row)
-		{
-			$message = ($view == 'next') ? 'NO_NEWER_TOPICS' : 'NO_OLDER_TOPICS';
-			trigger_error($message);
-		}
-		else
-		{
-			$topic_id = $row['topic_id'];
-			$forum_id = $row['forum_id'];
-		}
+		$topic_id = $row['topic_id'];
+		$forum_id = $row['forum_id'];
 	}
 }
 
@@ -385,87 +350,6 @@
 
 gen_forum_auth_level('topic', $forum_id);
 
-// Quick mod tools
-$topic_mod = '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_lock', $forum_id) || ($_CLASS['auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->data['user_id'] != ANONYMOUS && $_CLASS['core_user']->data['user_id'] == $topic_data['topic_poster'])) ? (($topic_data['topic_status'] == ITEM_UNLOCKED) ? '<option value="lock">' . $_CLASS['core_user']->lang['LOCK_TOPIC'] . '</option>' : '<option value="unlock">' . $_CLASS['core_user']->lang['UNLOCK_TOPIC'] . '</option>') : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_delete', $forum_id)) ? '<option value="delete_topic">' . $_CLASS['core_user']->lang['DELETE_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_move', $forum_id)) ? '<option value="move">' . $_CLASS['core_user']->lang['MOVE_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_split', $forum_id)) ? '<option value="split">' . $_CLASS['core_user']->lang['SPLIT_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_merge', $forum_id)) ? '<option value="merge">' . $_CLASS['core_user']->lang['MERGE_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="fork">' . $_CLASS['core_user']->lang['FORK_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id) && $topic_data['topic_type'] != POST_NORMAL) ? '<option value="make_normal">' . $_CLASS['core_user']->lang['MAKE_NORMAL'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('f_sticky', $forum_id) && $topic_data['topic_type'] != POST_STICKY) ? '<option value="make_sticky">' . $_CLASS['core_user']->lang['MAKE_STICKY'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_ANNOUNCE) ? '<option value="make_announce">' . $_CLASS['core_user']->lang['MAKE_ANNOUNCE'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_GLOBAL) ? '<option value="make_global">' . $_CLASS['core_user']->lang['MAKE_GLOBAL'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="viewlogs">' . $_CLASS['core_user']->lang['VIEW_TOPIC_LOGS'] . '</option>' : '';
-
-$pagination = generate_pagination("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : ''), $total_posts, $config['posts_per_page'], $start);
-
-// Send vars to template
-$_CLASS['core_template']->assign_array(array(
-	'FORUM_ID' 		=> $forum_id,
-	'FORUM_NAME' 	=> $topic_data['forum_name'],
-	'FORUM_DESC'	=> $topic_data['forum_desc'],
-	'TOPIC_ID' 		=> $topic_id,
-	'TOPIC_TITLE' 	=> censor_text($topic_data['topic_title']),
-	'PAGINATION'		=> $pagination['formated'],
-	'PAGINATION_ARRAY'	=> $pagination['array'],
-	'PAGE_NUMBER' 	=> on_page($total_posts, $config['posts_per_page'], $start),
-	'TOTAL_POSTS'	=> ($total_posts == 1) ? $_CLASS['core_user']->lang['VIEW_TOPIC_POST'] : sprintf($_CLASS['core_user']->lang['VIEW_TOPIC_POSTS'], $total_posts), 
-	'U_MCP' 		=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link("Forums&amp;file=mcp&amp;mode=topic_view&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param", false, false) : '',
-
-	'MODERATORS'	=> (isset($forum_moderators[$forum_id]) && sizeof($forum_moderators[$forum_id])) ? implode(', ', $forum_moderators[$forum_id]) : '',
-
-	'POST_IMG' 		=> ($topic_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', 'FORUM_LOCKED') : $_CLASS['core_user']->img('btn_post', 'POST_NEW_TOPIC'),
-	'QUOTE_IMG' 	=> $_CLASS['core_user']->img('btn_quote', 'REPLY_WITH_QUOTE'),
-	'REPLY_IMG'		=> ($topic_data['forum_status'] == ITEM_LOCKED || $topic_data['topic_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', 'TOPIC_LOCKED') : $_CLASS['core_user']->img('btn_reply', 'REPLY_TO_TOPIC'),
-	'EDIT_IMG' 		=> $_CLASS['core_user']->img('btn_edit', 'EDIT_POST'),
-	'DELETE_IMG' 	=> $_CLASS['core_user']->img('btn_delete', 'DELETE_POST'),
-	'INFO_IMG'		=> $_CLASS['core_user']->img('btn_info', 'VIEW_INFO'),
-	'PROFILE_IMG'	=> $_CLASS['core_user']->img('btn_profile', 'READ_PROFILE'), 
-	'SEARCH_IMG'	=> $_CLASS['core_user']->img('btn_search', 'SEARCH_USER_POSTS'),
-	'PM_IMG'		=> $_CLASS['core_user']->img('btn_pm', 'SEND_PRIVATE_MESSAGE'),
-	'EMAIL_IMG' 	=> $_CLASS['core_user']->img('btn_email', 'SEND_EMAIL'),
-	'WWW_IMG' 		=> $_CLASS['core_user']->img('btn_www', 'VISIT_WEBSITE'),
-	'ICQ_IMG' 		=> $_CLASS['core_user']->img('btn_icq', 'ICQ'),
-	'AIM_IMG' 		=> $_CLASS['core_user']->img('btn_aim', 'AIM'),
-	'MSN_IMG' 		=> $_CLASS['core_user']->img('btn_msnm', 'MSNM'),
-	'YIM_IMG' 		=> $_CLASS['core_user']->img('btn_yim', 'YIM'),
-	'JABBER_IMG'	=> $_CLASS['core_user']->img('btn_jabber', 'JABBER') ,
-	'REPORT_IMG'	=> $_CLASS['core_user']->img('btn_report', 'REPORT_POST'),
-	'REPORTED_IMG'	=> $_CLASS['core_user']->img('icon_reported', 'POST_REPORTED'),
-	'UNAPPROVED_IMG'=> $_CLASS['core_user']->img('icon_unapproved', 'POST_UNAPPROVED'),
-	
-	'S_SELECT_SORT_DIR' 	=> $s_sort_dir,
-	'S_SELECT_SORT_KEY' 	=> $s_sort_key,
-	'S_SELECT_SORT_DAYS' 	=> $s_limit_days,
-	'S_TOPIC_ACTION' 		=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;start=$start"),
-	'S_TOPIC_MOD' 			=> ($topic_mod != '') ? '<select name="mode">' . $topic_mod . '</select>' : '',
-	'S_MOD_ACTION' 			=> generate_link("Forums&amp;file=mcp&amp;t=$topic_id&amp;quickmod=1", false, false), 
-
-	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['auth']->acl_get('f_search', $forum_id)) ? true : false, 
-	'S_SEARCHBOX_ACTION'	=> generate_link('Forums&amp;file=search&amp;search_forum[]='.$forum_id), 
-
-	'U_TOPIC'				=> ($view == 'print') ? generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id, array('full' => true)) : generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id),
-	'U_VIEW_UNREAD_POST'	=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread").'#unread',
-	'U_VIEW_TOPIC' 			=> generate_link($viewtopic_url, false),
-	'U_VIEW_FORUM' 			=> generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id),
-	'U_VIEW_OLDER_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=previous"),
-	'U_VIEW_NEWER_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=next"),
-	'U_PRINT_TOPIC'			=> ($_CLASS['auth']->acl_get('f_print', $forum_id)) ? generate_link($viewtopic_url . '&amp;view=print', false) : '',
-	'U_EMAIL_TOPIC'			=> ($_CLASS['auth']->acl_get('f_email', $forum_id) && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;t='.$topic_id) : '', 
-
-	'U_WATCH_TOPIC' 		=> $s_watching_topic['link'], 
-	'L_WATCH_TOPIC' 		=> $s_watching_topic['title'], 
-
-	'U_BOOKMARK_TOPIC'		=> ($_CLASS['core_user']->is_user && $config['allow_bookmarks']) ? generate_link($viewtopic_url . '&amp;bookmark=1', false) : '',
-	'L_BOOKMARK_TOPIC'		=> ($_CLASS['core_user']->is_user && $config['allow_bookmarks'] && $topic_data['bookmarked']) ? $_CLASS['core_user']->lang['BOOKMARK_TOPIC_REMOVE'] : $_CLASS['core_user']->lang['BOOKMARK_TOPIC'],
-	
-	'U_POST_NEW_TOPIC' 		=> generate_link('Forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id),
-	'U_POST_REPLY_TOPIC' 	=> generate_link("Forums&amp;file=posting&amp;mode=reply&amp;t=$topic_id"),
-	'U_BUMP_TOPIC'			=> (bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id") : '')
-);
-
 // Does this topic contain a poll?
 if (!empty($poll_start))
 {
@@ -1016,11 +900,13 @@
 
 $i_total = count($rowset) - 1;
 $prev_post_id = '';
+$first_unread_makred = false;
 
 $_CLASS['core_template']->assign('S_NUM_POSTS', count($post_list));
 
 // Output the posts
 //foreach ($rowset as $i => $row)
+
 for ($i = 0, $end = sizeof($post_list); $i < $end; ++$i)
 {
 	$row =& $rowset[$post_list[$i]];
@@ -1226,21 +1112,106 @@
 		'S_DISPLAY_NOTICE'	=> ($display_notice && $row['post_attachment']) ? true : false, 
 		'S_FRIEND'			=> ($row['friend']) ? true : false,
 		'S_UNREAD_POST'		=> $unread,
-		'S_FIRST_UNREAD'	=> ($unread_post_id == $row['post_id']) ? true : false,
+		'S_FIRST_UNREAD'	=> false,
 	);
 
+	if ($unread && !$first_unread_makred)
+	{
+		$postrow['S_FIRST_UNREAD'] = true;
+		$first_unread_makred = true;
+	}
+
 	// Dump vars into template
 	$_CLASS['core_template']->assign_vars_array('postrow', $postrow);
 	
 	$prev_post_id = $row['post_id'];
 
-	unset($rowset[$i], $post_attachments);
-	unset($attachments[$row['post_id']]);
+	unset($rowset[$i], $post_attachments, $attachments[$row['post_id']]);
 }
 
-unset($rowset);
-unset($user_cache);
+unset($rowset, $user_cache);
 
+// Quick mod tools
+$topic_mod = '';
+$topic_mod .= ($_CLASS['auth']->acl_get('m_lock', $forum_id) || ($_CLASS['auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->data['user_id'] != ANONYMOUS && $_CLASS['core_user']->data['user_id'] == $topic_data['topic_poster'])) ? (($topic_data['topic_status'] == ITEM_UNLOCKED) ? '<option value="lock">' . $_CLASS['core_user']->lang['LOCK_TOPIC'] . '</option>' : '<option value="unlock">' . $_CLASS['core_user']->lang['UNLOCK_TOPIC'] . '</option>') : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('m_delete', $forum_id)) ? '<option value="delete_topic">' . $_CLASS['core_user']->lang['DELETE_TOPIC'] . '</option>' : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('m_move', $forum_id)) ? '<option value="move">' . $_CLASS['core_user']->lang['MOVE_TOPIC'] . '</option>' : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('m_split', $forum_id)) ? '<option value="split">' . $_CLASS['core_user']->lang['SPLIT_TOPIC'] . '</option>' : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('m_merge', $forum_id)) ? '<option value="merge">' . $_CLASS['core_user']->lang['MERGE_TOPIC'] . '</option>' : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="fork">' . $_CLASS['core_user']->lang['FORK_TOPIC'] . '</option>' : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id) && $topic_data['topic_type'] != POST_NORMAL) ? '<option value="make_normal">' . $_CLASS['core_user']->lang['MAKE_NORMAL'] . '</option>' : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('f_sticky', $forum_id) && $topic_data['topic_type'] != POST_STICKY) ? '<option value="make_sticky">' . $_CLASS['core_user']->lang['MAKE_STICKY'] . '</option>' : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_ANNOUNCE) ? '<option value="make_announce">' . $_CLASS['core_user']->lang['MAKE_ANNOUNCE'] . '</option>' : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_GLOBAL) ? '<option value="make_global">' . $_CLASS['core_user']->lang['MAKE_GLOBAL'] . '</option>' : '';
+$topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="viewlogs">' . $_CLASS['core_user']->lang['VIEW_TOPIC_LOGS'] . '</option>' : '';
+
+$pagination = generate_pagination("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : ''), $total_posts, $config['posts_per_page'], $start);
+
+// Send vars to template
+$_CLASS['core_template']->assign_array(array(
+	'FORUM_ID' 			=> $forum_id,
+	'FORUM_NAME' 		=> $topic_data['forum_name'],
+	'FORUM_DESC'		=> $topic_data['forum_desc'],
+	'TOPIC_ID' 			=> $topic_id,
+	'TOPIC_TITLE' 		=> censor_text($topic_data['topic_title']),
+	'PAGINATION'		=> $pagination['formated'],
+	'PAGINATION_ARRAY'	=> $pagination['array'],
+	'PAGE_NUMBER' 		=> on_page($total_posts, $config['posts_per_page'], $start),
+	'TOTAL_POSTS'		=> ($total_posts == 1) ? $_CLASS['core_user']->lang['VIEW_TOPIC_POST'] : sprintf($_CLASS['core_user']->lang['VIEW_TOPIC_POSTS'], $total_posts), 
+	'U_MCP' 			=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link("Forums&amp;file=mcp&amp;mode=topic_view&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param", false, false) : '',
+
+	'MODERATORS'	=> (isset($forum_moderators[$forum_id]) && sizeof($forum_moderators[$forum_id])) ? implode(', ', $forum_moderators[$forum_id]) : '',
+
+	'POST_IMG' 		=> ($topic_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', 'FORUM_LOCKED') : $_CLASS['core_user']->img('btn_post', 'POST_NEW_TOPIC'),
+	'QUOTE_IMG' 	=> $_CLASS['core_user']->img('btn_quote', 'REPLY_WITH_QUOTE'),
+	'REPLY_IMG'		=> ($topic_data['forum_status'] == ITEM_LOCKED || $topic_data['topic_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', 'TOPIC_LOCKED') : $_CLASS['core_user']->img('btn_reply', 'REPLY_TO_TOPIC'),
+	'EDIT_IMG' 		=> $_CLASS['core_user']->img('btn_edit', 'EDIT_POST'),
+	'DELETE_IMG' 	=> $_CLASS['core_user']->img('btn_delete', 'DELETE_POST'),
+	'INFO_IMG'		=> $_CLASS['core_user']->img('btn_info', 'VIEW_INFO'),
+	'PROFILE_IMG'	=> $_CLASS['core_user']->img('btn_profile', 'READ_PROFILE'), 
+	'SEARCH_IMG'	=> $_CLASS['core_user']->img('btn_search', 'SEARCH_USER_POSTS'),
+	'PM_IMG'		=> $_CLASS['core_user']->img('btn_pm', 'SEND_PRIVATE_MESSAGE'),
+	'EMAIL_IMG' 	=> $_CLASS['core_user']->img('btn_email', 'SEND_EMAIL'),
+	'WWW_IMG' 		=> $_CLASS['core_user']->img('btn_www', 'VISIT_WEBSITE'),
+	'ICQ_IMG' 		=> $_CLASS['core_user']->img('btn_icq', 'ICQ'),
+	'AIM_IMG' 		=> $_CLASS['core_user']->img('btn_aim', 'AIM'),
+	'MSN_IMG' 		=> $_CLASS['core_user']->img('btn_msnm', 'MSNM'),
+	'YIM_IMG' 		=> $_CLASS['core_user']->img('btn_yim', 'YIM'),
+	'JABBER_IMG'	=> $_CLASS['core_user']->img('btn_jabber', 'JABBER') ,
+	'REPORT_IMG'	=> $_CLASS['core_user']->img('btn_report', 'REPORT_POST'),
+	'REPORTED_IMG'	=> $_CLASS['core_user']->img('icon_reported', 'POST_REPORTED'),
+	'UNAPPROVED_IMG'=> $_CLASS['core_user']->img('icon_unapproved', 'POST_UNAPPROVED'),
+	
+	'S_SELECT_SORT_DIR' 	=> $s_sort_dir,
+	'S_SELECT_SORT_KEY' 	=> $s_sort_key,
+	'S_SELECT_SORT_DAYS' 	=> $s_limit_days,
+	'S_TOPIC_ACTION' 		=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;start=$start"),
+	'S_TOPIC_MOD' 			=> ($topic_mod) ? '<select name="mode">' . $topic_mod . '</select>' : '',
+	'S_MOD_ACTION' 			=> generate_link("Forums&amp;file=mcp&amp;t=$topic_id&amp;quickmod=1", false, false), 
+
+	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['auth']->acl_get('f_search', $forum_id)) ? true : false, 
+	'S_SEARCHBOX_ACTION'	=> generate_link('Forums&amp;file=search&amp;search_forum[]='.$forum_id), 
+
+	'U_TOPIC'				=> ($view == 'print') ? generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id, array('full' => true)) : generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id),
+	'U_VIEW_UNREAD_POST'	=> ($first_unread_makred) ? generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id#unread") : false,
+	'U_VIEW_TOPIC' 			=> generate_link($viewtopic_url),
+	'U_VIEW_FORUM' 			=> generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id),
+	'U_VIEW_OLDER_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=previous"),
+	'U_VIEW_NEWER_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=next"),
+	'U_PRINT_TOPIC'			=> ($_CLASS['auth']->acl_get('f_print', $forum_id)) ? generate_link($viewtopic_url . '&amp;view=print') : '',
+	'U_EMAIL_TOPIC'			=> ($_CLASS['auth']->acl_get('f_email', $forum_id) && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;t='.$topic_id) : '', 
+
+	'U_WATCH_TOPIC' 		=> $s_watching_topic['link'], 
+	'L_WATCH_TOPIC' 		=> $s_watching_topic['title'], 
+
+	'U_BOOKMARK_TOPIC'		=> ($_CLASS['core_user']->is_user && $config['allow_bookmarks']) ? generate_link($viewtopic_url . '&amp;bookmark=1') : '',
+	'L_BOOKMARK_TOPIC'		=> ($_CLASS['core_user']->is_user && $config['allow_bookmarks'] && $topic_data['bookmarked']) ? $_CLASS['core_user']->lang['BOOKMARK_TOPIC_REMOVE'] : $_CLASS['core_user']->lang['BOOKMARK_TOPIC'],
+	
+	'U_POST_NEW_TOPIC' 		=> generate_link('Forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id),
+	'U_POST_REPLY_TOPIC' 	=> generate_link("Forums&amp;file=posting&amp;mode=reply&amp;t=$topic_id"),
+	'U_BUMP_TOPIC'			=> (bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id") : '')
+);
+
 // Update topic view and if necessary attachment view counters ... but only
 // if this is the first 'page view'
 

Modified: trunk/modules/Members_List/index.php
===================================================================
--- trunk/modules/Members_List/index.php	2005-08-17 19:08:38 UTC (rev 86)
+++ trunk/modules/Members_List/index.php	2005-08-19 01:49:31 UTC (rev 87)
@@ -36,7 +36,7 @@
 $_CLASS['core_user']->add_lang();
 $_CLASS['core_user']->add_img(false, 'Forums');
 
-$_CLASS['core_template']->assign(array(
+$_CLASS['core_template']->assign_array(array(
 	'S_SEARCH_USER'	=> false,
 	'S_SHOW_GROUP'	=> false
 	));
@@ -157,13 +157,11 @@
 		}
 		$_CLASS['core_db']->free_result($result);
 
-		$_CLASS['core_template']->assign(array(
-			'PM_IMG'		=> $_CLASS['core_user']->img('btn_pm', $_CLASS['core_user']->lang['MESSAGE']))
-		);
+		$_CLASS['core_template']->assign('PM_IMG', $_CLASS['core_user']->img('btn_pm', $_CLASS['core_user']->lang['MESSAGE']));
 		break;
 
 	case 'contact':
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'S_SEND_ICQ'	=> false,
 			'S_SEND_AIM'	=> false,
 			'S_SEND_JABBER' => false,
@@ -218,7 +216,7 @@
 		$sql = "SELECT user_id, username, user_email, user_lang, $sql_field
 			FROM " . USERS_TABLE . "
 			WHERE user_id = $user_id
-				AND user_type = " . USER_NORMAL;
+				AND user_type = " . USER_NORMAL .' AND user_status = ' . STATUS_ACTIVE;
 		$result = $_CLASS['core_db']->query($sql);
 
 		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
@@ -267,8 +265,7 @@
 				break;
 		}
 
-		$_CLASS['core_template']->assign(array(
-		
+		$_CLASS['core_template']->assign_array(array(
 			'CONTACT_NAME'	=> $row[$sql_field],
 			'IM_CONTACT'	=> $row[$sql_field],
 			'USERNAME'		=> addslashes($row['username']),
@@ -302,14 +299,12 @@
 		$member = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
-		if (!$member || (!$_CLASS['core_auth']->admin_power('users') && $member['user_status'] != USER_ACTIVE))
+		if (!$member || (!$_CLASS['core_auth']->admin_power('users') && $member['user_status'] != STATUS_ACTIVE))
 		{
 			$_CLASS['core_db']->free_result($result);
 			trigger_error(($member) ? 'USER_INACTIVE' : 'NO_USER');
 		}
 		
-		
-
 		$sql = 'SELECT g.group_id, g.group_name, g.group_type
 			FROM ' . USER_GROUP_TABLE . ' ug, ' . GROUPS_TABLE . " g
 			WHERE ug.user_id = $user_id
@@ -358,7 +353,7 @@
 
 		// Grab all the relevant data
 		$sql = 'SELECT COUNT(p.post_id) AS num_posts
-			FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . " f
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . " f
 			WHERE p.poster_id = $user_id
 				AND f.forum_id = p.forum_id
 				$post_count_sql";
@@ -386,7 +381,7 @@
 		if ($post_count_sql)
 		{
 			$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts
-				FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . " f
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . " f
 				WHERE p.poster_id = $user_id
 					AND f.forum_id = p.forum_id
 					$post_count_sql
@@ -398,7 +393,7 @@
 			$_CLASS['core_db']->free_result($result);
 
 			$sql = 'SELECT t.topic_id, t.topic_title, COUNT(p.post_id) AS num_posts
-				FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . " f
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . " f
 				WHERE p.poster_id = $user_id
 					AND t.topic_id = p.topic_id
 					AND f.forum_id = t.forum_id
@@ -470,9 +465,9 @@
 			$poster_avatar = '<img src="' . $poster_avatar . '" width="' . $member['user_avatar_width'] . '" height="' . $member['user_avatar_height'] . '" border="0" alt="" />';
 		}
 
-		$_CLASS['core_template']->assign(show_profile($member));
+		$_CLASS['core_template']->assign_array(show_profile($member));
 		
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'POSTS_DAY'			=> sprintf($_CLASS['core_user']->lang['POST_DAY'], $posts_per_day),
 			'POSTS_PCT'			=> sprintf($_CLASS['core_user']->lang['POST_PCT'], $percentage),
 			'ACTIVE_FORUM'		=> $active_f_name,
@@ -529,7 +524,7 @@
 		$page_title = $_CLASS['core_user']->lang['SEND_EMAIL'];
 		$template_html = 'memberlist_email.html';
 		
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'MESSAGE' => false,
 			'SUBJECT' => false)
 		);
@@ -570,7 +565,7 @@
 			$sql = 'SELECT username, user_email, user_allow_viewemail, user_lang, user_jabber, user_notify_type
 				FROM ' . USERS_TABLE . "
 				WHERE user_id = $user_id
-					AND user_type = ". USER_NORMAL;
+					AND user_type = ". USER_NORMAL . ' AND u.user_status = ' . STATUS_ACTIVE;
 			$result = $_CLASS['core_db']->query($sql);
 
 			if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
@@ -588,7 +583,7 @@
 		else
 		{
 			$sql = 'SELECT forum_id, topic_title
-				FROM ' . TOPICS_TABLE . "
+				FROM ' . FORUMS_TOPICS_TABLE . "
 				WHERE topic_id = $topic_id";
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -641,7 +636,7 @@
 			if (!sizeof($error))
 			{
 				$sql = 'UPDATE ' . USERS_TABLE . '
-					SET user_emailtime = ' . time() . '
+					SET user_emailtime = ' . gmtime() . '
 					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 				$result = $_CLASS['core_db']->query($sql);
 
@@ -697,7 +692,7 @@
 
 		if ($topic_id)
 		{
-			$_CLASS['core_template']->assign(array(
+			$_CLASS['core_template']->assign_array(array(
 				'EMAIL'			=> htmlspecialchars($email),
 				'NAME'			=> htmlspecialchars($name),
 				'TOPIC_TITLE'	=> $row['topic_title'],
@@ -706,7 +701,7 @@
 				'S_LANG_OPTIONS'=> ($topic_id) ? language_select($email_lang) : '')
 			);
 		}
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'USERNAME'		=> (!$topic_id) ? addslashes($row['username']) : '',
 			'ERROR_MESSAGE'	=> (sizeof($error)) ? implode('<br />', $error) : '',
 
@@ -812,7 +807,7 @@
 				$ips = (preg_match('#[a-z]#', $ipdomain)) ? implode(', ', preg_replace('#([0-9]{1,3}\.[0-9]{1,3}[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})#', "'\\1'", gethostbynamel($ipdomain))) : "'" . str_replace('*', '%', $ipdomain) . "'";
 
 				$sql = 'SELECT DISTINCT poster_id
-					FROM ' . POSTS_TABLE . '
+					FROM ' . FORUMS_POSTS_TABLE . '
 					WHERE poster_ip ' . ((preg_match('#%#', $ips)) ? 'LIKE' : 'IN') . " ($ips)";
 				$result = $_CLASS['core_db']->query($sql);
 
@@ -859,7 +854,8 @@
 			$sql = 'SELECT g.*, ug.user_id
 				FROM ' . GROUPS_TABLE . ' g
 				LEFT JOIN ' . USER_GROUP_TABLE . ' ug ON (ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . " AND ug.group_id = $group_id)
-				WHERE g.group_id = $group_id";
+				WHERE g.group_id = $group_id
+				AND group_status = ".STATUS_ACTIVE;
 	
 			$result = $_CLASS['core_db']->query($sql);
 			$group_row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -872,13 +868,14 @@
 
 			switch ($group_row['group_type'])
 			{
-				case GROUP_OPEN:
+// rename the lang names
+				case GROUP_REQUEST:
 					$group_row['group_type'] = 'OPEN';
-					break;
+				break;
 
 				case GROUP_CLOSED:
 					$group_row['group_type'] = 'CLOSED';
-					break;
+				break;
 
 				case GROUP_HIDDEN:
 					$group_row['group_type'] = 'HIDDEN';
@@ -888,13 +885,14 @@
 					{
 						trigger_error('NO_GROUP');
 					}
-					break;
+				break;
 
+				case GROUP_SYSTEM:
 				case GROUP_SPECIAL:
 					$group_row['group_type'] = 'SPECIAL';
-					break;
+				break;
 
-				case GROUP_FREE:
+				case GROUP_UNRESTRAINED:
 					$group_row['group_type'] = 'FREE';
 					break;
 			}
@@ -917,13 +915,14 @@
 			}
 
 			$rank_title = $rank_img = '';
-			if ($group_row['group_rank'] != -1)
+	
+			if (isset($ranks['special'][$group_row['group_rank']]))
 			{
 				$rank_title = $ranks['special'][$group_row['group_rank']]['rank_title'];
-				$rank_img = (!empty($ranks['special'][$group_row['group_rank']]['rank_image'])) ? '<img src="' . $config['ranks_path'] . '/' . $ranks['special'][$group_row['group_rank']]['rank_image'] . '" border="0" alt="' . $ranks['special'][$group_row['group_rank']]['rank_title'] . '" title="' . $ranks['special'][$group_row['group_rank']]['rank_title'] . '" /><br />' : '';	
+				$rank_img = empty($ranks['special'][$group_row['group_rank']]['rank_image']) ? '' : '<img src="' . $config['ranks_path'] . '/' . $ranks['special'][$group_row['group_rank']]['rank_image'] . '" border="0" alt="' . $ranks['special'][$group_row['group_rank']]['rank_title'] . '" title="' . $ranks['special'][$group_row['group_rank']]['rank_title'] . '" /><br />';	
 			}
 
-			$_CLASS['core_template']->assign(array(
+			$_CLASS['core_template']->assign_array(array(
 				'GROUP_DESC'    => $group_row['group_description'],
 				'GROUP_NAME'    => $group_row['group_name'],
 				'GROUP_COLOR'   => $group_row['group_colour'],
@@ -936,7 +935,7 @@
 				'U_PM'			=> ($_CLASS['auth']->acl_get('u_sendpm') && $group_row['group_receive_pm'] && $config['allow_mass_pm']) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;g='.$group_id) : '',)
 			);
 
-			$sql_fields = ', ug.user_status';
+			$sql_fields = ', ug.member_status';
 			$sql_from = ', ' . USER_GROUP_TABLE . ' ug ';
 			$sql_where .= " AND u.user_id = ug.user_id AND ug.group_id = $group_id";
 		}
@@ -949,7 +948,7 @@
 		{
 			$sql = 'SELECT COUNT(u.user_id) AS total_users
 				FROM ' . USERS_TABLE . " u$sql_from
-				WHERE u.user_type = " . USER_NORMAL ."
+				WHERE u.user_type = " . USER_NORMAL .' AND u.user_status = ' . STATUS_ACTIVE ."
 				$sql_where";
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -974,6 +973,7 @@
 
 		// Build a relevant pagination_url
 		$global_var = ($submit) ? '_POST' : '_GET';
+
 		foreach ($$global_var as $key => $var)
 		{
 			// what don't we need ?
@@ -992,7 +992,7 @@
 		// Some search user specific data
 		if ($mode == 'searchuser' && ($config['load_search'] || $_CLASS['auth']->acl_get('a_')))
 		{
-			$_CLASS['core_template']->assign(array(
+			$_CLASS['core_template']->assign_array(array(
 				'USERNAME'	=> $username,
 				'EMAIL'		=> $email,
 				'ICQ'		=> $icq,
@@ -1033,7 +1033,7 @@
 		// Do the SQL thang
 		$sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_allow_viewemail, u.user_posts, u.user_regdate, u.user_rank, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_msnm, u.user_jabber, u.user_avatar, u.user_avatar_type, u.user_last_visit 
 			'. $sql_fields .' FROM ' . USERS_TABLE . " u$sql_from
-			WHERE u.user_type = " . USER_NORMAL . "
+			WHERE u.user_type = " . USER_NORMAL . ' AND u.user_status = ' . STATUS_ACTIVE ."
 				$sql_where
 			ORDER BY $order_by";
 		$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
@@ -1041,7 +1041,7 @@
 		$id_cache = array();
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			if ($mode == 'group' && $row['user_status'] == STATUS_PENDING)
+			if ($mode == 'group' && $row['member_status'] == STATUS_PENDING)
 			{
 				 continue;
 			}
@@ -1053,7 +1053,7 @@
 		
 		foreach ($id_cache as $user_id => $row)
 		{
-			$option_row = ($mode == 'group' && $row['user_status'] == STATUS_LEADER) ? 'leader_row' : 'member_row';
+			$option_row = ($mode == 'group' && $row['member_status'] == STATUS_LEADER) ? 'leader_row' : 'member_row';
 
 			$$option_row = array_merge(show_profile($row), array(
 				'U_VIEWPROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']))
@@ -1065,7 +1065,7 @@
 	}
 
 	// Generate page
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'PAGINATION' 	=> generate_pagination($pagination_url2, $total_users, $config['topics_per_page'], $start),
 		'PAGE_NUMBER' 	=> on_page($total_users, $config['topics_per_page'], $start),
 		'TOTAL_USERS'	=> ($total_users == 1) ? $_CLASS['core_user']->lang['LIST_USER'] : sprintf($_CLASS['core_user']->lang['LIST_USERS'], $total_users),
@@ -1109,10 +1109,10 @@
 
 // Output the page
 $_CLASS['core_template']->assign('DISPLAY_STYLESHEET_LINK', $window);
-
 page_header();
-$_CLASS['core_template']->display('modules/Members_List/'.$template_html);
 
+$_CLASS['core_display']->display($page_title, 'modules/Members_List/'.$template_html);
+
 script_close();
 // ---------
 // FUNCTIONS



From viperal at berlios.de  Mon Aug 22 17:55:14 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Mon, 22 Aug 2005 17:55:14 +0200
Subject: [Viperals-svncheckins] r88 - in trunk: admin images includes includes/auth includes/crons includes/forums includes/forums/admin includes/templates includes/templates/admin includes/templates/admin/blocks includes/templates/admin/messages includes/templates/admin/modules includes/templates/admin/system includes/templates/admin/users includes/templates/modules includes/templates/modules/Control_Panel includes/templates/modules/Forums includes/templates/modules/Quick_Message install modules/Control_Panel modules/Control_Panel/ucp modules/Quick_Message
Message-ID: <200508221555.j7MFtE3a026851@sheep.berlios.de>

Author: viperal
Date: 2005-08-22 17:55:13 +0200 (Mon, 22 Aug 2005)
New Revision: 88

Added:
   trunk/admin/menu.php
   trunk/images/add_user.png
   trunk/images/calender.png
   trunk/images/calender_small.png
   trunk/includes/crons/session.php
   trunk/includes/templates/admin/users/
   trunk/includes/templates/admin/users/bots.html
   trunk/includes/templates/admin/users/header.html
   trunk/includes/templates/admin/users/index.html
   trunk/includes/templates/admin/users/unactivated.html
   trunk/includes/templates/confirmation.html
   trunk/includes/templates/message.html
   trunk/install/installer.php
Removed:
   trunk/includes/forums/admin/admin_ban.php
   trunk/includes/templates/admin/system/bots.html
   trunk/includes/templates/modules/Submit_News/
   trunk/includes/templates/modules/View_Online/
Modified:
   trunk/admin/index.php
   trunk/admin/system.php
   trunk/admin/users.php
   trunk/includes/auth/auth.php
   trunk/includes/forums/admin/admin_board.php
   trunk/includes/forums/admin/admin_forums.php
   trunk/includes/forums/admin/admin_icons.php
   trunk/includes/forums/admin/admin_permissions.php
   trunk/includes/forums/admin/links.php
   trunk/includes/forums/admin/main.php
   trunk/includes/forums/auth.php
   trunk/includes/forums/bbcode.php
   trunk/includes/forums/functions.php
   trunk/includes/forums/functions_admin.php
   trunk/includes/forums/functions_display.php
   trunk/includes/forums/functions_posting.php
   trunk/includes/forums/functions_privmsgs.php
   trunk/includes/forums/message_parser.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/session.php
   trunk/includes/system.php
   trunk/includes/templates/admin/blocks/edit.html
   trunk/includes/templates/admin/blocks/index.html
   trunk/includes/templates/admin/index.html
   trunk/includes/templates/admin/messages/edit.html
   trunk/includes/templates/admin/messages/index.html
   trunk/includes/templates/admin/modules/index.html
   trunk/includes/templates/admin/system/index.html
   trunk/includes/templates/login_admin.html
   trunk/includes/templates/login_body.html
   trunk/includes/templates/login_body_full.html
   trunk/includes/templates/modules/Control_Panel/ucp_agreement.html
   trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html
   trunk/includes/templates/modules/Control_Panel/ucp_posting_body.html
   trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html
   trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html
   trunk/includes/templates/modules/Control_Panel/ucp_register.html
   trunk/includes/templates/modules/Forums/faq_body.html
   trunk/includes/templates/modules/Forums/overall_header.html
   trunk/includes/templates/modules/Forums/posting_body.html
   trunk/includes/templates/modules/Forums/viewforum_body.html
   trunk/includes/templates/modules/Forums/viewtopic_body.html
   trunk/includes/templates/modules/Quick_Message/index.html
   trunk/includes/templates/permission.html
   trunk/includes/user.php
   trunk/install/build_data.php
   trunk/install/build_tables.php
   trunk/modules/Control_Panel/index.php
   trunk/modules/Control_Panel/ucp/ucp_register.php
   trunk/modules/Quick_Message/index.php
   trunk/modules/Quick_Message/install.php
Log:


Modified: trunk/admin/index.php
===================================================================
--- trunk/admin/index.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/admin/index.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,4 +1,26 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 if (VIPERAL !== 'Admin') 
 {
 	die;
@@ -57,30 +79,38 @@
 
 if ($_CLASS['core_auth']->admin_power('users'))
 {
-	// seperate this
-	$sql = 'SELECT user_id, username, user_regdate
-		FROM ' . USERS_TABLE . '
-			WHERE user_type = '.USER_NORMAL.'
-			AND user_status IN (' . STATUS_PENDING . ',  ' . STATUS_DISABLED . ')';
-		
-	$result = $_CLASS['core_db']->query_limit($sql, 20);
-	
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	$user_status = array(STATUS_PENDING, STATUS_DISABLED);
+	$count = 0;
+
+	foreach ($user_status as $status)
 	{
-		$type = ($row['user_id'] == STATUS_DISABLED) ? 'users_disabled' : 'users_unactivated';
-	
-		$_CLASS['core_template']->assign_vars_array($type, array(
-				'user_id'		=> $row['user_id'],
-				'user_name'		=> $row['username'],
-				'registered'	=> $_CLASS['core_user']->format_time($row['user_regdate']),
-				'link_profile'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
-				'link_activate'	=> generate_link('&amp;user_mode=activate&amp;id=' . $row['user_id'], array('admin' => true)),
-				'link_remove'	=> generate_link('&amp;user_mode=remove&amp;id=' . $row['user_id'], array('admin' => true)),
-				'link_remind'	=> generate_link('&amp;user_mode=remind&amp;id=' . $row['user_id'], array('admin' => true)),
-				'link_details'	=> '',
-		));
+		$sql = 'SELECT user_id, username, user_regdate
+			FROM ' . USERS_TABLE . '
+				WHERE user_type = '.USER_NORMAL.'
+				AND user_status = '.$status;
+		
+		$limit = ($count) ? 10 : 20 - $count;
+		$result = $_CLASS['core_db']->query_limit($sql, $limit);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$type = ($status == STATUS_DISABLED) ? 'users_disabled' : 'users_unactivated';
+		
+			$_CLASS['core_template']->assign_vars_array($type, array(
+					'user_id'		=> $row['user_id'],
+					'user_name'		=> $row['username'],
+					'registered'	=> $_CLASS['core_user']->format_time($row['user_regdate']),
+					'link_profile'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+					'link_activate'	=> generate_link('&amp;user_mode=activate&amp;id=' . $row['user_id'], array('admin' => true)),
+					'link_remove'	=> generate_link('&amp;user_mode=remove&amp;id=' . $row['user_id'], array('admin' => true)),
+					'link_remind'	=> generate_link('&amp;user_mode=remind&amp;id=' . $row['user_id'], array('admin' => true)),
+					'link_details'	=> '',
+			));
+			
+			$count ++;
+		}
+		$_CLASS['core_db']->free_result($result);
 	}
-	$_CLASS['core_db']->free_result($result);
 }
 
 $_CLASS['core_template']->display('admin/index.html');

Added: trunk/admin/menu.php
===================================================================
--- trunk/admin/menu.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/admin/menu.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -0,0 +1,108 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+/*
+	this is temp.. until I know if I want to make this a class and how i'm going to do the styles
+*/
+// add spacer
+
+$menu['blocks'][] = array('lang' => $_CLASS['core_user']->get_lang('BLOCKS'), 'link' => generate_link('blocks', array('admin' => true)));
+$menu['blocks'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE'), 'link' => generate_link('blocks', array('admin' => true)));
+$menu['blocks'][] = '';
+$menu['blocks'][] = array('lang' => 'Add Regular Block', 'link' => generate_link('blocks&mode=add&type=0', array('admin' => true)));
+$menu['blocks'][] = array('lang' => 'Add Feed Block', 'link' => generate_link('blocks&mode=add&type=1', array('admin' => true)));
+$menu['blocks'][] = array('lang' => 'Add HTML Block', 'link' => generate_link('blocks&mode=add&type=2', array('admin' => true)));
+
+
+$menu['messages'][] = array('lang' => $_CLASS['core_user']->get_lang('MESSAGES'), 'link' => generate_link('messages', array('admin' => true)));
+$menu['messages'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE'), 'link' => generate_link('messages', array('admin' => true)));
+$menu['messages'][] = '';
+$menu['messages'][] = array('lang' => 'Add Message', 'link' => generate_link('messages&amp;mode=add', array('admin' => true)));
+
+$menu['modules'][] = array('lang' => $_CLASS['core_user']->get_lang('MODULES'), 'link' => generate_link('modules', array('admin' => true)));
+$menu['modules'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE'), 'link' => generate_link('modules', array('admin' => true)));
+$menu['modules'][] = '';
+
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('FORUMS'), 'link' => generate_link('Forums', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('ADMIN_INDEX'), 'link' => generate_link('Forums', array('admin' => true)));
+$menu['forums'][] = '';
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE_FORUMS'), 'link' => generate_link('Forums&amp;file=admin_forums', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('PERMISSIONS'), 'link' => generate_link('Forums&amp;file=admin_permissions&amp;mode=forum', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('ADMINISTRATORS'), 'link' => generate_link('Forums&amp;file=admin_permissions&amp;mode=admin', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('MODERATORS'), 'link' => generate_link('Forums&amp;file=admin_permissions&amp;mode=mod', array('admin' => true)));
+
+$menu['system'][] = array('lang' => $_CLASS['core_user']->get_lang('SYSTEM'), 'link' => generate_link('system', array('admin' => true)));
+$menu['system'][] = array('lang' => $_CLASS['core_user']->get_lang('SITE_SETTINGS'), 'link' => generate_link('system&amp;mode=site', array('admin' => true)));
+$menu['system'][] = array('lang' => $_CLASS['core_user']->get_lang('SYSTEM_SETTINGS'), 'link' => generate_link('system&amp;mode=system', array('admin' => true)));
+$menu['system'][] = array('lang' => $_CLASS['core_user']->get_lang('BOTS'), 'link' => generate_link('users&amp;mode=bots', array('admin' => true)));
+
+function build_menu($menu)
+{
+	$names = array_keys($menu);
+	
+	$script = '<script type="text/javascript">';
+	$menu_items = '';
+
+	foreach ($names as $name)
+	{
+		if (isset($menu[$name][0]))
+		{
+			$menu_items .= '<td id="'.$name.'" nowrap="nowrap" class="row2"><a href="'.$menu[$name][0]['link'].'">'.$menu[$name][0]['lang'].'</a></td>';
+			unset($menu[$name][0]);
+		}
+
+		$content[$name] = '<div id="'.$name.'_menu" style="display: none;"><table class="tablebg" border="0" cellpadding="4" cellspacing="1">';
+
+		foreach ($menu[$name] as $item)
+		{
+			if (is_array($item))
+			{
+				$content[$name] .= '
+				<tr>
+					<td class="row1" onmouseover="this.className=\'row2\'" onmouseout="this.className=\'row1\'"  onclick="location.href=\''.$item['link'].'\'" nowrap="nowrap"><a href="'.$item['link'].'" title="">'.$item['lang'].'</a></td>
+				</tr>
+				';
+			}
+			else
+			{
+				$content[$name] .= '
+				<tr>
+					<td class="row2" nowrap="nowrap"></td>
+				</tr>
+				';
+			}
+		}
+
+		$content[$name] .= '</table></div>';
+
+		$script .= "menu_init('$name');\n";
+	}
+
+	$script .= '</script>';
+
+	$return['content'] = implode("\n", $content)."\n$script";
+	$return['menu'] = $menu_items;
+
+	return $return;
+}
+?>
\ No newline at end of file

Modified: trunk/admin/system.php
===================================================================
--- trunk/admin/system.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/admin/system.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,5 +1,26 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (VIPERAL !== 'Admin') 
 {
 	die;
@@ -66,11 +87,9 @@
 		$data = array('global'	=> array(
 			'default_theme'		=> array('post_name' => 'default_theme'),
 			'link_optimization' => array('post_name' => 'link_optimization'),
-			'site_logo'			=> array('post_name' => 'site_logo'),
 			'site_name'			=> array('post_name' => 'site_name'),
 			'site_url'			=> array('post_name' => 'site_url'),
-			'slogan'			=> array('post_name' => 'slogan'),
-			'startdate'			=> array('post_name' => 'startdate')
+			'start_date'		=> array('post_name' => 'start_date')
 			)
 		);
 		admin_save($data);
@@ -118,7 +137,11 @@
 {
 	if ($save)
 	{
-		$_POST['maintenance_start'] = (($expires = strtotime($_POST['maintenance_start'])) === -1) ? '' : $expires;
+		if (!empty($_POST['maintenance_start']))
+		{
+			$expires = strtotime($_POST['maintenance_start']);
+			$_POST['maintenance_start'] = (!$expires || $expires == -1) ? '' : $expires;
+		}
 
 		$data = array(
 			'maintenance' => array(
@@ -136,7 +159,6 @@
 				'site_port' 	=> array('post_name' => 'site_port'),
 				'site_path' 	=> array('post_name' => 'site_path'),
 				'ip_check' 		=> array('post_name' => 'ip_check'),
-				'browser_check' => array('post_name' => 'browser_check'),
 				'limit_load' 	=> array('post_name' => 'limit_load'),
 				'limit_sessions'	=> array('post_name' => 'limit_sessions'),
 				'session_length'	=> array('post_name' => 'session_length'),

Modified: trunk/admin/users.php
===================================================================
--- trunk/admin/users.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/admin/users.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -26,72 +26,7 @@
 	die;
 }
 
-if (isset($_REQUEST['mode']) && $_REQUEST['mode'] == 'bots')
-{
-	$id = (int) get_variable('id', 'GET', false);
-	
-	if ($id && isset($_REQUEST['option']))
-	{
-		require_once($site_file_root.'includes/functions_user.php');
-	
-		switch ($_REQUEST['option'])
-		{
-			case 'activate':
-				user_activate($id);
-			break;
-	
-			case 'deactivate':
-				user_disable($id);
-			break;
-		
-			case 'delete':
-				if (display_confirmation())
-				{
-					$sql = 'SELECT user_id, user_type
-						FROM ' . USERS_TABLE . ' 
-						WHERE user_id = '.$id;
-		
-					$result = $_CLASS['core_db']->query($sql);
-					$row = $_CLASS['core_db']>fetch_row_assoc($result);
-					$_CLASS['core_db']->free_result($result);
-		
-					if ($row['user_type'] != USER_BOT)
-					{
-						break;
-					}
-		
-					user_delete($id);
-		
-					trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
-				}
-			break;
-		}
-	}
-	
-	$sql = 'SELECT user_id, username, user_status, user_last_visit 
-		FROM ' . USERS_TABLE . '
-		WHERE user_type = ' . USER_BOT . ' ORDER BY user_last_visit DESC';
-	
-	$result = $_CLASS['core_db']->query($sql);
-	
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$_CLASS['core_template']->assign_vars_array('admin_bots', array(
-			'ACTIVE'		=> ($row['user_status'] == STATUS_ACTIVE),
-			'NAME'			=> $row['username'],
-			'LINK_DELETE'	=> generate_link('users&amp;mode=bots&amp;option=delete&amp;id='.$row['user_id'], array('admin' => true)),
-			'LINK_STATUS'	=> generate_link('users&amp;mode=bots&amp;option='.(($row['user_status'] == STATUS_ACTIVE) ? 'deactivate' :  'activate').'&amp;id='.$row['user_id'], array('admin' => true)),
-			'LINK_EDIT'		=> generate_link('users&amp;mode=bots&amp;options=edit&amp;id='.$row['user_id'], array('admin' => true)),
-			'LAST_VISIT'	=> ($row['user_last_visit']) ?  $_CLASS['core_user']->format_date($row['user_last_visit']) : $_CLASS['core_user']->lang['BOT_NEVER'],
-			'L_STATUS'		=> ($row['user_status'] == STATUS_ACTIVE) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
-		));
-	}
-	
-	$_CLASS['core_db']->free_result($result);
-	
-	$_CLASS['core_display']->display(false, 'admin/users/bots.html');
-}
-
+// Just testing the layout, i know they not acurrate
 $result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM ' . USERS_TABLE . ' WHERE user_type = ' . USER_BOT);
 list($count_bots) = $_CLASS['core_db']->fetch_row_num($result);
 $_CLASS['core_db']->free_result($result);
@@ -104,13 +39,173 @@
 $_CLASS['core_template']->assign_array(array(
 	'COUNT_BOTS'	=> $count_bots,
 	'COUNT_USERS'	=> $count_users,
-	'LINK_BOTS'		=> generate_link('users&amp;mode=bots', array('admin' => true)),
 	'LINK_ADD_USER'	=> generate_link('users&amp;mode=add_user', array('admin' => true)),
 	'LINK_EDIT_USER'=> generate_link('users&amp;mode=edit_user', array('admin' => true)),
-	//'LAST_VISIT'	=> ($row['user_last_visit']) ?  $_CLASS['core_user']->format_date($row['user_last_visit']) : $_CLASS['core_user']->lang['BOT_NEVER'],
-	//'L_STATUS'		=> ($row['user_status'] == STATUS_ACTIVE) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+	
+	'LINK_USER_INDEX'		=> generate_link('users', array('admin' => true)),
+	'LINK_VIEW_BOTS'		=> generate_link('users&amp;mode=bots', array('admin' => true)),
+	'LINK_VIEW_DISABLED'	=> generate_link('users&amp;mode=disabled', array('admin' => true)),
+	'LINK_VIEW_UNACTIVATED'	=> generate_link('users&amp;mode=unactivated', array('admin' => true)),
 ));
 
+if (isset($_REQUEST['mode']))
+{
+	switch ($_REQUEST['mode'])
+	{
+		case 'bots':
+			$id = (int) get_variable('id', 'GET', false);
+			
+			if ($id && isset($_REQUEST['option']))
+			{
+				require_once($site_file_root.'includes/functions_user.php');
+			
+				switch ($_REQUEST['option'])
+				{
+					case 'activate':
+						user_activate($id);
+					break;
+			
+					case 'deactivate':
+						user_disable($id);
+					break;
+				
+					case 'delete':
+						if (display_confirmation())
+						{
+							$sql = 'SELECT user_id, user_type
+								FROM ' . USERS_TABLE . ' 
+								WHERE user_id = '.$id;
+				
+							$result = $_CLASS['core_db']->query($sql);
+							$row = $_CLASS['core_db']>fetch_row_assoc($result);
+							$_CLASS['core_db']->free_result($result);
+				
+							if ($row['user_type'] != USER_BOT)
+							{
+								break;
+							}
+				
+							user_delete($id);
+				
+							trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
+						}
+					break;
+				}
+			}
+			
+			$sql = 'SELECT user_id, username, user_status, user_last_visit 
+				FROM ' . USERS_TABLE . '
+				WHERE user_type = ' . USER_BOT . ' ORDER BY user_last_visit DESC';
+			
+			$result = $_CLASS['core_db']->query($sql);
+			
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$_CLASS['core_template']->assign_vars_array('admin_bots', array(
+					'ACTIVE'		=> ($row['user_status'] == STATUS_ACTIVE),
+					'NAME'			=> $row['username'],
+					'LINK_DELETE'	=> generate_link('users&amp;mode=bots&amp;option=delete&amp;id='.$row['user_id'], array('admin' => true)),
+					'LINK_STATUS'	=> generate_link('users&amp;mode=bots&amp;option='.(($row['user_status'] == STATUS_ACTIVE) ? 'deactivate' :  'activate').'&amp;id='.$row['user_id'], array('admin' => true)),
+					'LINK_EDIT'		=> generate_link('users&amp;mode=bots&amp;options=edit&amp;id='.$row['user_id'], array('admin' => true)),
+					'LAST_VISIT'	=> ($row['user_last_visit']) ?  $_CLASS['core_user']->format_date($row['user_last_visit']) : $_CLASS['core_user']->lang['BOT_NEVER'],
+					'L_STATUS'		=> ($row['user_status'] == STATUS_ACTIVE) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+				));
+			}
+			
+			$_CLASS['core_db']->free_result($result);
+			
+			$_CLASS['core_display']->display(false, 'admin/users/bots.html');
+		break;
+
+		case 'disabled':
+		case 'unactivated':
+			if ($_REQUEST['mode'] == 'unactivated')
+			{
+				$status = STATUS_PENDING;
+				$template = 'admin/users/unactivated.html';
+				$link = 'users&amp;mode=unactivated';
+			}
+			else
+			{
+				$status = STATUS_DISABLED;
+				$template = 'admin/users/disabled.html';
+				$link = 'users&amp;mode=disabled';
+			}
+$status = STATUS_DISABLED;
+			$start = get_variable('start', 'GET', false, 'integer');
+
+			$sql = 'SELECT user_id, username, user_regdate
+				FROM ' . USERS_TABLE . '
+					WHERE user_type = '.USER_NORMAL.'
+					AND user_status = '.$status;
+
+			$result = $_CLASS['core_db']->query_limit($sql, 20, $start);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$_CLASS['core_template']->assign_vars_array('users_admin', array(
+						'user_id'		=> $row['user_id'],
+						'user_name'		=> $row['username'],
+						'registered'	=> $_CLASS['core_user']->format_time($row['user_regdate']),
+						'link_profile'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+						'link_activate'	=> generate_link('&amp;user_mode=activate&amp;id=' . $row['user_id'], array('admin' => true)),
+						'link_remove'	=> generate_link('&amp;user_mode=remove&amp;id=' . $row['user_id'], array('admin' => true)),
+						'link_remind'	=> generate_link('&amp;user_mode=remind&amp;id=' . $row['user_id'], array('admin' => true)),
+						'link_details'	=> '',
+				));
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			$sql = 'SELECT count(*) as count FROM ' . USERS_TABLE . '
+				WHERE user_type = '.USER_NORMAL.'
+				AND user_status = '.$status;
+		
+			$result = $_CLASS['core_db']->query($sql);
+			list($count) = $_CLASS['core_db']->fetch_row_num($result);
+			$_CLASS['core_db']->free_result($result);
+			
+			$pagination = generate_pagination($link, $count, 20, $start, true);
+			$_CLASS['core_template']->assign('USERS_PAGINATION', $pagination['formated']);
+
+			$_CLASS['core_display']->display(false, $template);
+		break;
+	}
+}
+
+$user_status = array(STATUS_PENDING, STATUS_DISABLED);
+$count = 0;
+
+// needed view more
+foreach ($user_status as $status)
+{
+	$sql = 'SELECT user_id, username, user_regdate
+		FROM ' . USERS_TABLE . '
+			WHERE user_type = '.USER_NORMAL.'
+			AND user_status = '.$status;
+
+	$limit = ($count) ? 10 : 20 - $count;
+	$result = $_CLASS['core_db']->query_limit($sql, $limit);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$type = ($status == STATUS_DISABLED) ? 'users_disabled' : 'users_unactivated';
+	
+		$_CLASS['core_template']->assign_vars_array($type, array(
+				'user_id'		=> $row['user_id'],
+				'user_name'		=> $row['username'],
+				'registered'	=> $_CLASS['core_user']->format_time($row['user_regdate']),
+				'link_profile'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+				'link_activate'	=> generate_link('&amp;user_mode=activate&amp;id=' . $row['user_id'], array('admin' => true)),
+				'link_remove'	=> generate_link('&amp;user_mode=remove&amp;id=' . $row['user_id'], array('admin' => true)),
+				'link_remind'	=> generate_link('&amp;user_mode=remind&amp;id=' . $row['user_id'], array('admin' => true)),
+				'link_details'	=> '',
+		));
+		
+		$count ++;
+	}
+	$_CLASS['core_db']->free_result($result);
+}
+
 $_CLASS['core_display']->display(false, 'admin/users/index.html');
 
 ?>
\ No newline at end of file

Added: trunk/images/add_user.png
===================================================================
(Binary files differ)


Property changes on: trunk/images/add_user.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/images/calender.png
===================================================================
(Binary files differ)


Property changes on: trunk/images/calender.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/images/calender_small.png
===================================================================
(Binary files differ)


Property changes on: trunk/images/calender_small.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/includes/auth/auth.php
===================================================================
--- trunk/includes/auth/auth.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/auth/auth.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -50,9 +50,9 @@
 		{
 			if (encode_password($user_password, $row['user_password_encoding']) == $row['user_password'])
 			{
-				if ($row['user_status'] == USER_DISABLE || $row['user_status'] == USER_UNACTIVATED)
+				if ($row['user_status'] != STATUS_ACTIVE)
 				{
-					$status =  ($row['user_type'] == USER_INACTIVE) ? 'ACTIVE_ERROR' : 'UNACTIVATED_ERROR';
+					$status =  ($row['user_status'] == STATUS_DISABLED) ? 'ACTIVE_ERROR' : 'UNACTIVATED_ERROR';
 				}
 
 				return (int) $row['user_id'];
@@ -111,16 +111,16 @@
 	{
 		global $_CLASS;
 
-		if (!$_CLASS['core_user']->is_admin || !$this->admin_auth() || !isset($this->_admin_permission[$section]))
+		if (!$_CLASS['core_user']->is_admin || !$this->admin_auth())
 		{
-			if (isset($this->_admin_permission['/all/']))
-			{
-				return true;
-			}
-
 			return false;
 		}
 
+		if (!isset($this->_admin_permission[$section]))
+		{
+			return isset($this->_admin_permission['/all/']) ?  true : false;
+		}
+
 		if ($option)
 		{
 			return isset($this->_admin_permission[$section][$option]) ? false : $this->_admin_permission[$section][$option];
@@ -178,7 +178,7 @@
 				{
 					$_CLASS['core_user']->login($result, $login_array['admin_login'], !empty($_POST['hidden']), !empty($_POST['auto_login']));
 
-					$login_array['redirect'] = generate_link(get_variable('redirect', 'POST', $login_array['redirect']), array('admin' => $data['admin_login']));	
+					$login_array['redirect'] = generate_link(get_variable('redirect', 'POST', $login_array['redirect']), array('admin' => $login_array['admin_login']));	
 
 					$_CLASS['core_display']->meta_refresh(5, $login_array['redirect']);
 					$message = (($login_array['success']) ? $_CLASS['core_user']->get_lang($login_array['success']) : $_CLASS['core_user']->lang['LOGIN_REDIRECT']) . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $login_array['redirect'] . '">', '</a> ');
@@ -324,7 +324,7 @@
 
 					if (count($setup['users']))
 					{
-						$setup['users'] = user_get_id($setup['users']);
+						$setup['users'] = user_get_id($setup['users'], $null);
 					}
 
 					if (count($setup['groups']))
@@ -440,7 +440,7 @@
 				$group_auth_type = isset($auth_options['groups'][1][$row['group_id']]['core_status']) ? 1 : 0;
 				$group_list = ($auth_options['groups'][$group_auth_type][$row['group_id']]['core_status']) ? 'allowed_group_list' : 'disallowed_group_list';
 				
-				$$group_list .= '<option' . (($group_auth_type == 1) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+				$$group_list .= '<option' . (($group_auth_type == 1) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
 				
 			}
 			$_CLASS['core_db']->free_result($result);
@@ -454,7 +454,7 @@
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$group_list .= '<option value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+			$group_list .= '<option value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
 		}
 		$_CLASS['core_db']->free_result($result);
 	

Added: trunk/includes/crons/session.php
===================================================================
--- trunk/includes/crons/session.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/crons/session.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -0,0 +1,41 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+$sql = 'UPDATE ' . USERS_TABLE. ' u, ' . SESSIONS_TABLE . ' s
+			SET u.user_last_visit = s.session_time
+			WHERE s.session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']) . '
+				AND s.session_user_id <> ' . ANONYMOUS .'
+				AND u.user_id = s.session_user_id';
+$_CLASS['core_db']->sql_query($sql);
+
+$sql = 'DELETE FROM ' . SESSIONS_AUTOLOGIN_TABLE . '
+			WHERE auto_login_time < ' . ($time - 2592000);
+$_CLASS['core_db']->query($sql);
+
+$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
+			WHERE session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
+$_CLASS['core_db']->query($sql);
+
+$_CLASS['core_db']->optimize_tables(SESSIONS_TABLE);
+
+?>
\ No newline at end of file

Deleted: trunk/includes/forums/admin/admin_ban.php
===================================================================
--- trunk/includes/forums/admin/admin_ban.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/admin/admin_ban.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,289 +0,0 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: admin_ban.php,v 1.11 2004/08/01 21:01:23 psotfx Exp $
-//
-// FILENAME  : admin_ban.php
-// STARTED   : Tue Jul 31, 2001
-// COPYRIGHT : ? 2001,2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
-//
-// -------------------------------------------------------------
-
-// Do we have ban permissions?
-if (!$auth->acl_get('a_ban'))
-{
-	trigger_error($user->lang['NO_ADMIN']);
-}
-
-include('includes/forums/functions_user.'.$phpEx);
-
-// Mode setting
-$mode		= request_var('mode', '');
-$bansubmit	= (isset($_POST['bansubmit'])) ? true : false;
-$unbansubmit= (isset($_POST['unbansubmit'])) ? true : false;
-
-// Set some vars
-$current_time = time();
-
-// Start program
-if ($bansubmit)
-{
-	// Grab the list of entries
-	$ban			= request_var('ban', '');
-	$ban_len		= request_var('banlength', 0);
-	$ban_len_other	= request_var('banlengthother', '');
-	$ban_exclude	= request_var('banexclude', 0);
-	$ban_reason		= request_var('banreason', '');
-
-	user_ban($mode, $ban, $ban_len, $ban_len_other, $ban_exclude, $ban_reason);
-
-	trigger_error($user->lang['BAN_UPDATE_SUCESSFUL']);
-}
-else if ($unbansubmit)
-{
-	$ban = request_var('unban', '');
-
-	user_unban($mode, $ban);
-
-	trigger_error($user->lang['BAN_UPDATE_SUCESSFUL']);
-}
-
-//
-// Output relevant entry page
-//
-
-
-//
-// Ban length options
-//
-$ban_end_text = array(0 => $user->lang['PERMANENT'], 30 => $user->lang['30_MINS'], 60 => $user->lang['1_HOUR'], 360 => $user->lang['6_HOURS'], 1440 => $user->lang['1_DAY'], 10080 => $user->lang['7_DAYS'], 20160 => $user->lang['2_WEEKS'], 40320 => $user->lang['1_MONTH'], -1 => $user->lang['OTHER'] . ' -&gt; ');
-
-$ban_end_options = '';
-foreach ($ban_end_text as $length => $text)
-{
-	$ban_end_options .= '<option value="' . $length . '">' . $text . '</option>';
-}
-
-// Title
-switch ($mode)
-{
-	case 'user':
-		$l_title = $user->lang['BAN_USERS'];
-		break;
-	case 'email':
-		$l_title = $user->lang['BAN_EMAILS'];
-		break;
-	case 'ip':
-		$l_title = $user->lang['BAN_IPS'];
-		break;
-}
-
-// Output page
-adm_page_header($l_title);
-
-?>
-
-<p><?php echo $user->lang['BAN_EXPLAIN']; ?></p>
-
-<?php
-
-switch ($mode)
-{
-	case 'user':
-
-		$field = 'username';
-		$l_ban_title = $user->lang['BAN_USERS'];
-		$l_ban_explain = $user->lang['BAN_USERNAME_EXPLAIN'];
-		$l_ban_exclude_explain = $user->lang['BAN_USER_EXCLUDE_EXPLAIN'];
-		$l_unban_title = $user->lang['UNBAN_USERNAME'];
-		$l_unban_explain = $user->lang['UNBAN_USERNAME_EXPLAIN'];
-		$l_ban_cell = $user->lang['USERNAME'] . ': <br /><span class="gensmall">[ <a href="' . getlink('Members_List'.$SID.'&amp;mode=searchuser&amp;form=banning&amp;field=ban').'" onclick="window.open(\''.getlink('Members_List'.$SID.'&amp;mode=searchuser&amp;form=banning&amp;field=ban')."', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;\">" . $user->lang['FIND_USERNAME'] .'</a> ]</span>';
-		$l_no_ban_cell = $user->lang['NO_BANNED_USERS'];
-
-		$sql = 'SELECT b.*, u.user_id, u.username
-			FROM ' . BANLIST_TABLE . ' b, ' . USERS_TABLE . ' u
-			WHERE (b.ban_end >= ' . time() . '
-					OR b.ban_end = 0)
-				AND u.user_id = b.ban_userid
-				AND b.ban_userid <> 0
-				AND u.user_id <> ' . ANONYMOUS . '
-			ORDER BY u.user_id ASC';
-		break;
-
-	case 'ip':
-
-		$field = 'ban_ip';
-		$l_ban_title = $user->lang['BAN_IPS'];
-		$l_ban_explain = $user->lang['BAN_IP_EXPLAIN'];
-		$l_ban_exclude_explain = $user->lang['BAN_IP_EXCLUDE_EXPLAIN'];
-		$l_unban_title = $user->lang['UNBAN_IP'];
-		$l_unban_explain = $user->lang['UNBAN_IP_EXPLAIN'];
-		$l_ban_cell = $user->lang['IP_HOSTNAME'] . ':';
-		$l_no_ban_cell = $user->lang['NO_BANNED_IP'];
-
-		$sql = 'SELECT *
-			FROM ' . BANLIST_TABLE . '
-			WHERE (ban_end >= ' . time() . "
-					OR ban_end = 0)
-				AND ban_ip <> ''";
-		break;
-
-	case 'email':
-
-		$field = 'ban_email';
-		$l_ban_title = $user->lang['BAN_EMAILS'];
-		$l_ban_explain = $user->lang['BAN_EMAIL_EXPLAIN'];
-		$l_ban_exclude_explain = $user->lang['BAN_EMAIL_EXCLUDE_EXPLAIN'];
-		$l_unban_title = $user->lang['UNBAN_EMAIL'];
-		$l_unban_explain = $user->lang['UNBAN_EMAIL_EXPLAIN'];
-		$l_ban_cell = $user->lang['EMAIL_ADDRESS'] . ':';
-		$l_no_ban_cell = $user->lang['NO_BANNED_EMAIL'];
-
-		$sql = 'SELECT *
-			FROM ' . BANLIST_TABLE . '
-			WHERE (ban_end >= ' . time() . "
-					OR ban_end = 0)
-				AND ban_email <> ''";
-		break;
-}
-$result = $db->sql_query($sql);
-
-$banned_options = '';
-$ban_length = $ban_reasons = array();
-if ($row = $db->sql_fetchrow($result))
-{
-	do
-	{
-
-		$banned_options .=  '<option' . (($row['ban_exclude']) ? ' class="sep"' : '') . ' value="' . $row['ban_id'] . '">' . $row[$field] . '</option>';
-
-		$time_length = (!empty($row['ban_end'])) ? ($row['ban_end'] - $row['ban_start']) / 60 : 0;
-		$ban_length[$row['ban_id']] = (!empty($ban_end_text[$time_length])) ? $ban_end_text[$time_length] : $user->lang['OTHER'] . ' -> ' . gmdate('Y-m-d', $row['ban_end']);
-
-		$ban_reasons[$row['ban_id']] = addslashes($row['ban_reason']);
-	}
-	while ($row = $db->sql_fetchrow($result));
-}
-$db->sql_freeresult($result);
-
-?>
-
-<h1><?php echo $l_ban_title; ?></h1>
-
-<p><?php echo $l_ban_explain; ?></p>
-
-<script language="Javascript" type="text/javascript">
-<!--
-
-var ban_length = new Array();
-<?php
-
-	if (sizeof($ban_length))
-	{
-		foreach ($ban_length as $ban_id => $length)
-		{
-			echo "ban_length['$ban_id'] = \"$length\";\n";
-		}
-	}
-
-?>
-
-var ban_reason = new Array();
-<?php
-
-	if (sizeof($ban_reasons))
-	{
-		foreach ($ban_reasons as $ban_id => $reason)
-		{
-			echo "ban_reason['$ban_id'] = \"$reason\";\n";
-		}
-	}
-?>
-
-function display_details(option)
-{
-	document.forms[0].unbanreason.value = ban_reason[option];
-	document.forms[0].unbanlength.value = ban_length[option];
-}
-
-//-->
-</script>
-
-<form name="banning" method="post" action="<?php echo "admin_ban.$phpEx$SID&amp;mode=$mode"; ?>"><table class="bg" width="80%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $l_ban_title; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $l_ban_cell; ?></td>
-		<td class="row2"><textarea cols="40" rows="3" name="ban"></textarea></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_LENGTH']; ?>:</td>
-		<td class="row2"><select name="banlength"><?php echo $ban_end_options; ?></select>&nbsp; <input class="post" type="text" name="banlengthother" maxlength="10" size="10" /></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_EXCLUDE']; ?>: <br /><span class="gensmall"><?php echo $l_ban_exclude_explain;;?></span></td>
-		<td class="row2"><input type="radio" name="banexclude" value="1" /> <?php echo $user->lang['YES']; ?> &nbsp; <input type="radio" name="banexclude" value="0" checked="checked" /> <?php echo $user->lang['NO']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_REASON']; ?>:</td>
-		<td class="row2"><input class="post" type="text" name="banreason" maxlength="255" size="40" /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center"> <input type="submit" name="bansubmit" value="<?php echo $user->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $user->lang['RESET']; ?>" class="btnlite" />&nbsp;</td>
-	</tr>
-</table>
-
-<h1><?php echo $l_unban_title; ?></h1>
-
-<p><?php echo $l_unban_explain; ?></p>
-
-<table class="bg" width="80%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $l_unban_title; ?></th>
-	</tr>
-<?php
-
-	if ($banned_options)
-	{
-
-?>
-	<tr>
-		<td class="row1" width="45%"><?php echo $l_ban_cell; ?>: <br /></td>
-		<td class="row2"> <select name="unban[]" multiple="multiple" size="5" onchange="display_details(this.options[this.selectedIndex].value)"><?php echo $banned_options; ?></select></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_REASON']; ?>:</td>
-		<td class="row2"><input class="row1" style="border:0px" type="text" name="unbanreason" size="40" /></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_LENGTH']; ?>:</td>
-		<td class="row2"><input class="row1" style="border:0px" type="text" name="unbanlength" size="40" /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center"><input type="submit" name="unbansubmit" value="<?php echo $user->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $user->lang['RESET']; ?>" class="btnlite" /></td>
-	</tr>
-<?php
-
-	}
-	else
-	{
-
-?>
-	<tr>
-		<td class="row2" colspan="2" align="center"><?php echo $l_no_ban_cell;  ?></td>
-	</tr>
-<?php
-
-	}
-
-?>
-</table></form>
-
-<?php
-
-adm_page_footer();
-
-?>
\ No newline at end of file

Modified: trunk/includes/forums/admin/admin_board.php
===================================================================
--- trunk/includes/forums/admin/admin_board.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/admin/admin_board.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -81,14 +81,9 @@
 		'auth'	=> 'a_defaults',
 		'title'	=> 'BOARD_DEFAULTS',
 		'vars'	=> array(
-			'default_lang'			=> array('lang' => 'DEFAULT_LANGUAGE',		'type' => 'select', 'options' => 'language_select(\'{VALUE}\')', 'explain' => false),
-			'default_dateformat'	=> array('lang' => 'DEFAULT_DATE_FORMAT',	'type' => 'text::255', 'explain' => true),
-			'board_timezone'		=> array('lang' => 'SYSTEM_TIMEZONE',		'type' => 'select', 'options' => 'tz_select(\'{VALUE}\')', 'explain' => false),
-			'board_dst'				=> array('lang' => 'SYSTEM_DST',			'type' => 'radio:yes_no', 'explain' => false),
 			'allow_privmsg'			=> array('lang' => 'BOARD_PM',				'type' => 'radio:yes_no', 'explain' => true),
 			'allow_topic_notify'	=> array('lang' => 'ALLOW_TOPIC_NOTIFY',	'type' => 'radio:yes_no', 'explain' => false),
 			'allow_forum_notify'	=> array('lang' => 'ALLOW_FORUM_NOTIFY',	'type' => 'radio:yes_no', 'explain' => false),
-			//'allow_namechange'		=> array('lang' => 'ALLOW_NAME_CHANGE',		'type' => 'radio:yes_no', 'explain' => false),
 			'allow_attachments'		=> array('lang' => 'ALLOW_ATTACHMENTS',		'type' => 'radio:yes_no', 'explain' => false),
 			'allow_html'			=> array('lang' => 'ALLOW_HTML',			'type' => 'radio:yes_no', 'explain' => false),
 			'allow_html_tags'		=> array('lang' => 'ALLOWED_TAGS',			'type' => 'text:30:255', 'explain' => true),
@@ -116,7 +111,6 @@
 			'allow_pm_attach'		=> array('lang' => 'ALLOW_PM_ATTACHMENTS',	'type' => 'radio:yes_no', 'explain' => false),
 			'auth_download_pm'		=> array('lang' => 'ALLOW_DOWNLOAD_PM',		'type' => 'radio:yes_no', 'explain' => false),
 			'allow_sig_pm'			=> array('lang' => 'ALLOW_SIG_PM',			'type' => 'radio:yes_no', 'explain' => false),
-			//'enable_karma_pm'		=> array('lang' => 'ENABLE_KARMA_PM',		'type' => 'radio:yes_no', 'explain' => false),
 			'auth_report_pm'		=> array('lang' => 'ALLOW_REPORT_PM',		'type' => 'radio:yes_no', 'explain' => false),
 			'auth_quote_pm'			=> array('lang' => 'ALLOW_QUOTE_PM',		'type' => 'radio:yes_no', 'explain' => false),
 			'print_pm'				=> array('lang' => 'ALLOW_PRINT_PM',		'type' => 'radio:yes_no', 'explain' => false),

Modified: trunk/includes/forums/admin/admin_forums.php
===================================================================
--- trunk/includes/forums/admin/admin_forums.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/admin/admin_forums.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -29,12 +29,15 @@
 {
 	case 'add':
 		$acl = 'a_forumadd';
-		break;
+	break;
+
 	case 'delete':
 		$acl = 'a_forumdel';
-		break;
+	break;
+
 	default:
 		$acl = 'a_forum';
+	break;
 }
 
 if (!$_CLASS['auth']->acl_get($acl))
@@ -49,6 +52,11 @@
 	switch ($mode)
 	{
 		case 'delete':
+			if (!$forum_id)
+			{
+				trigger_error('NO_FORUM');
+			}
+
 			$action_subforums	= request_var('action_subforums', '');
 			$subforums_to_id	= request_var('subforums_to_id', 0);
 			$action_posts		= request_var('action_posts', '');
@@ -56,14 +64,18 @@
 
 			delete_forum($forum_id, $action_posts, $action_subforums, $posts_to_id, $subforums_to_id);
 
-			//
 			$_CLASS['auth']->acl_clear_prefetch();
 
 			$show_prev_info = false;
-			trigger_error($_CLASS['core_user']->lang['FORUM_DELETED']);
-			break;
+			trigger_error('FORUM_DELETED');
+		break;
 
 		case 'edit':
+			if (!$forum_id)
+			{
+				trigger_error('NO_FORUM');
+			}
+
 			$forum_data = array(
 				'forum_id'		=>	$forum_id
 			);
@@ -97,7 +109,6 @@
 				'forum_password_confirm'=> request_var('forum_password_confirm', '')
 			);
 
-
 			if ($forum_data['forum_rules'])
 			{
 				require_once($site_file_root.'includes/forums/message_parser.php');
@@ -333,7 +344,7 @@
 ?><br /><input type="radio" name="action" value="delete" checked="checked" /> <?php echo $_CLASS['core_user']->lang['DELETE_ALL_POSTS'];
 
 			$sql = 'SELECT forum_id
-				FROM ' . FORUMS_TABLE . '
+				FROM ' . FORUMS_FORUMS_TABLE . '
 				WHERE forum_type = ' . FORUM_POST . "
 					AND forum_id <> $forum_id";
 			$result = $_CLASS['core_db']->query($sql);
@@ -580,7 +591,7 @@
 <?php
 
 			$sql = 'SELECT forum_id
-				FROM ' . FORUMS_TABLE . '
+				FROM ' . FORUMS_FORUMS_TABLE . '
 				WHERE forum_type = ' . FORUM_POST . "
 					AND forum_id <> $forum_id";
 			$result = $_CLASS['core_db']->query($sql);
@@ -635,7 +646,7 @@
 	case 'move_up':
 	case 'move_down':
 		$sql = 'SELECT parent_id, left_id, right_id
-			FROM ' . FORUMS_TABLE . "
+			FROM ' . FORUMS_FORUMS_TABLE . "
 			WHERE forum_id = $forum_id";
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -650,7 +661,7 @@
 
 		// Get the adjacent forum
 		$sql = 'SELECT forum_id, forum_name, left_id, right_id
-			FROM ' . FORUMS_TABLE . "
+			FROM ' . FORUMS_FORUMS_TABLE . "
 			WHERE parent_id = $parent_id
 				AND " . (($mode == 'move_up') ? "right_id < $right_id ORDER BY right_id DESC" : "left_id > $left_id ORDER BY left_id ASC");
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -682,7 +693,7 @@
 
 		$forum_ids = array();
 		$sql = 'SELECT forum_id
-			FROM ' . FORUMS_TABLE . '
+			FROM ' . FORUMS_FORUMS_TABLE . '
 			WHERE left_id > ' . $forum_info[$up_id]['left_id'] . '
 				AND right_id < ' . $forum_info[$up_id]['right_id'];
 		$result = $_CLASS['core_db']->query($sql);
@@ -696,7 +707,7 @@
 		// Start transaction
 		$_CLASS['core_db']->transaction();
 
-		$sql = 'UPDATE ' . FORUMS_TABLE . '
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 			SET left_id = left_id + ' . ($diff_up + 1) . ', right_id = right_id + ' . ($diff_up + 1) . '
 			WHERE left_id > ' . $forum_info[$down_id]['left_id'] . '
 				AND right_id < ' . $forum_info[$down_id]['right_id'];
@@ -704,18 +715,18 @@
 
 		if (count($forum_ids))
 		{
-			$sql = 'UPDATE ' . FORUMS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 				SET left_id = left_id - ' . ($diff_down + 1) . ', right_id = right_id - ' . ($diff_down + 1) . '
 				WHERE forum_id IN (' . implode(', ', $forum_ids) . ')';
 			$_CLASS['core_db']->query($sql);
 		}
 
-		$sql = 'UPDATE ' . FORUMS_TABLE . '
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 			SET left_id = ' . $forum_info[$down_id]['left_id'] . ', right_id = ' . ($forum_info[$down_id]['left_id'] + $diff_up) . '
 			WHERE forum_id = ' . $up_id;
 		$_CLASS['core_db']->query($sql);
 
-		$sql = 'UPDATE ' . FORUMS_TABLE . '
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 			SET left_id = ' . ($forum_info[$up_id]['right_id'] - $diff_down) . ', right_id = ' . $forum_info[$up_id]['right_id'] . '
 			WHERE forum_id = ' . $down_id;
 		$_CLASS['core_db']->query($sql);
@@ -731,11 +742,11 @@
 	case 'sync':
 		if (!$forum_id)
 		{
-			trigger_error($_CLASS['core_user']->lang['NO_FORUM']);
+			trigger_error('NO_FORUM');
 		}
 
 		$sql = "SELECT forum_name
-			FROM " . FORUMS_TABLE . "
+			FROM " . FORUMS_FORUMS_TABLE . "
 			WHERE forum_id = $forum_id";
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -805,7 +816,7 @@
 <?php
 
 $sql = 'SELECT *
-	FROM ' . FORUMS_TABLE . "
+	FROM ' . FORUMS_FORUMS_TABLE . "
 	WHERE parent_id = $parent_id
 	ORDER BY left_id";
 $result = $_CLASS['core_db']->query($sql);
@@ -910,7 +921,7 @@
 	global $_CLASS;
 
 	$sql = 'SELECT *
-		FROM ' . FORUMS_TABLE . "
+		FROM ' . FORUMS_FORUMS_TABLE . "
 		WHERE forum_id = $forum_id";
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -982,7 +993,7 @@
 		if ($forum_data['parent_id'])
 		{
 			$sql = 'SELECT left_id, right_id
-				FROM ' . FORUMS_TABLE . '
+				FROM ' . FORUMS_FORUMS_TABLE . '
 				WHERE forum_id = ' . $forum_data['parent_id'];
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -992,12 +1003,12 @@
 			}
 			$_CLASS['core_db']->free_result($result);
 
-			$sql = 'UPDATE ' . FORUMS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 				SET left_id = left_id + 2, right_id = right_id + 2
 				WHERE left_id > ' . $row['right_id'];
 			$_CLASS['core_db']->query($sql);
 
-			$sql = 'UPDATE ' . FORUMS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 				SET right_id = right_id + 2
 				WHERE ' . $row['left_id'] . ' BETWEEN left_id AND right_id';
 			$_CLASS['core_db']->query($sql);
@@ -1008,7 +1019,7 @@
 		else
 		{
 			$sql = 'SELECT MAX(right_id) AS right_id
-				FROM ' . FORUMS_TABLE;
+				FROM ' . FORUMS_FORUMS_TABLE;
 			$result = $_CLASS['core_db']->query($sql);
 
 			$row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -1018,12 +1029,12 @@
 			$forum_data['right_id'] = $row['right_id'] + 2;
 		}
 
-		$sql = 'INSERT INTO ' . FORUMS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $forum_data);
+		$sql = 'INSERT INTO ' . FORUMS_FORUMS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $forum_data);
 		$_CLASS['core_db']->query($sql);
 		
 		$_CLASS['core_db']->transaction('commit');
 
-		$forum_data['forum_id'] = $_CLASS['core_db']->insert_id(FORUMS_TABLE, 'forum_id');
+		$forum_data['forum_id'] = $_CLASS['core_db']->insert_id(FORUMS_FORUMS_TABLE, 'forum_id');
 		add_log('admin', 'LOG_FORUM_ADD', $forum_data['forum_name']);
 	}
 	else
@@ -1069,7 +1080,7 @@
 		{
 			// the forum name has changed, clear the parents list of child forums
 
-			$sql = 'UPDATE ' . FORUMS_TABLE . "
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 				SET forum_parents = ''
 				WHERE left_id > " . $row['left_id'] . '
 					AND right_id < ' . $row['right_id'];
@@ -1081,7 +1092,7 @@
 			return $errors;
 		}
 
-		$sql = 'UPDATE ' . FORUMS_TABLE . '
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $forum_data) . '
 			WHERE forum_id = ' . $forum_data['forum_id'];
 		$_CLASS['core_db']->query($sql);
@@ -1105,14 +1116,14 @@
 	}
 
 	// Resync parents
-	$sql = 'UPDATE ' . FORUMS_TABLE . "
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 		SET right_id = right_id - $diff, forum_parents = ''
 		WHERE left_id < " . $from_data['right_id'] . "
 			AND right_id > " . $from_data['right_id'];
 	$_CLASS['core_db']->query($sql);
 
 	// Resync righthand side of tree
-	$sql = 'UPDATE ' . FORUMS_TABLE . "
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 		SET left_id = left_id - $diff, right_id = right_id - $diff, forum_parents = ''
 		WHERE left_id > " . $from_data['right_id'];
 	$_CLASS['core_db']->query($sql);
@@ -1122,14 +1133,14 @@
 		$to_data = get_forum_info($to_id);
 
 		// Resync new parents
-		$sql = 'UPDATE ' . FORUMS_TABLE . "
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 			SET right_id = right_id + $diff, forum_parents = ''
 			WHERE " . $to_data['right_id'] . ' BETWEEN left_id AND right_id
 				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
 		$_CLASS['core_db']->query($sql);
 
 		// Resync the righthand side of the tree
-		$sql = 'UPDATE ' . FORUMS_TABLE . "
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 			SET left_id = left_id + $diff, right_id = right_id + $diff, forum_parents = ''
 			WHERE left_id > " . $to_data['right_id'] . '
 				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
@@ -1149,7 +1160,7 @@
 	else
 	{
 		$sql = 'SELECT MAX(right_id) AS right_id
-			FROM ' . FORUMS_TABLE . '
+			FROM ' . FORUMS_FORUMS_TABLE . '
 			WHERE forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -1159,7 +1170,7 @@
 		$diff = '+ ' . ($row['right_id'] - $from_data['left_id'] + 1);
 	}
 
-	$sql = 'UPDATE ' . FORUMS_TABLE . "
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 		SET left_id = left_id $diff, right_id = right_id $diff, forum_parents = ''
 		WHERE forum_id IN (" . implode(', ', $moved_ids) . ')';
 	$_CLASS['core_db']->query($sql);
@@ -1203,10 +1214,14 @@
 
 	if ($action_posts == 'delete')
 	{
-		$_CLASS['core_db']->query('UPDATE '.FORUMS_TABLE." SET forum_status = '".ITEM_DELETING."' WHERE forum_id = $forum_id");
+		$_CLASS['core_db']->query('UPDATE '.FORUMS_FORUMS_TABLE.' SET forum_status = '.ITEM_DELETING.' WHERE forum_id = '.$forum_id);
 
 		$log_action_posts = 'POSTS';
-		$errors[] = delete_forum_content($forum_id);
+		
+		if ($delete_error = delete_forum_content($forum_id))
+		{
+			$errors[] = $delete_error;
+		}
 	}
 	elseif ($action_posts == 'move')
 	{
@@ -1219,7 +1234,7 @@
 			$log_action_posts = 'MOVE_POSTS';
 
 			$sql = 'SELECT forum_name 
-				FROM ' . FORUMS_TABLE . '
+				FROM ' . FORUMS_FORUMS_TABLE . '
 				WHERE forum_id = ' . $posts_to_id;
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -1256,11 +1271,14 @@
 		}
 		unset($rows);
 
-		$_CLASS['core_db']->query('UPDATE '.FORUMS_TABLE." SET forum_status = '".ITEM_DELETING."' WHERE forum_id  IN (" . implode(', ', $forum_ids) . ')');
+		$_CLASS['core_db']->query('UPDATE '.FORUMS_FORUMS_TABLE.'  SET forum_status = '.ITEM_DELETING.' WHERE forum_id  IN (' . implode(', ', $forum_ids) . ')');
 
 		foreach ($forum_ids as $forum_id)
 		{
-			$errors[] = delete_forum_content($forum_id);
+			if ($delete_error = delete_forum_content($forum_id))
+			{
+				$errors[] = $delete_error;
+			}
 		}
 
 		if (count($errors))
@@ -1270,7 +1288,7 @@
 
 		$diff = count($forum_ids) * 2;
 
-		$sql = 'DELETE FROM ' . FORUMS_TABLE . '
+		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . '
 			WHERE forum_id IN (' . implode(', ', $forum_ids) . ')';
 		$_CLASS['core_db']->query($sql);
 	}
@@ -1285,7 +1303,7 @@
 			$log_action_forums = 'MOVE_FORUMS';
 
 			$sql = 'SELECT forum_name 
-				FROM ' . FORUMS_TABLE . '
+				FROM ' . FORUMS_FORUMS_TABLE . '
 				WHERE forum_id = ' . $subforums_to_id;
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -1299,7 +1317,7 @@
 				unset($row);
 
 				$sql = 'SELECT forum_id
-					FROM ' . FORUMS_TABLE . "
+					FROM ' . FORUMS_FORUMS_TABLE . "
 					WHERE parent_id = $forum_id";
 				$result = $_CLASS['core_db']->query($sql);
 
@@ -1309,13 +1327,13 @@
 				}
 				$_CLASS['core_db']->free_result($result);
 
-				$sql = 'UPDATE ' . FORUMS_TABLE . "
+				$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 					SET parent_id = $subforums_to_id
 					WHERE parent_id = $forum_id";
 				$_CLASS['core_db']->query($sql);
 
 				$diff = 2;
-				$sql = 'DELETE FROM ' . FORUMS_TABLE . "
+				$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . "
 					WHERE forum_id = $forum_id";
 				$_CLASS['core_db']->query($sql);
 			}
@@ -1329,18 +1347,18 @@
 	else
 	{
 		$diff = 2;
-		$sql = 'DELETE FROM ' . FORUMS_TABLE . "
+		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . "
 			WHERE forum_id = $forum_id";
 		$_CLASS['core_db']->query($sql);
 	}
 
 	// Resync tree
-	$sql = 'UPDATE ' . FORUMS_TABLE . "
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 		SET right_id = right_id - $diff
 		WHERE left_id < $right_id AND right_id > $right_id";
 	$_CLASS['core_db']->query($sql);
 
-	$sql = 'UPDATE ' . FORUMS_TABLE . "
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 		SET left_id = left_id - $diff, right_id = right_id - $diff
 		WHERE left_id > $right_id";
 	$_CLASS['core_db']->query($sql);
@@ -1407,7 +1425,7 @@
 
 	$_CLASS['core_db']->transaction();
 
-	switch (SQL_LAYER)
+	switch ($_CLASS['core_db']->db_layer)
 	{
 // Needs updating and testing
 /*		case 'mysql4':
@@ -1469,7 +1487,7 @@
 		default:
 			// Select then delete all attachments
 			$sql = 'SELECT a.attach_id, a.physical_filename, a.thumbnail
-				FROM ' . POSTS_TABLE . ' p, ' . ATTACHMENTS_TABLE . " a
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_ATTACHMENTS_TABLE . " a
 				WHERE p.forum_id = $forum_id
 					AND a.in_message = 0
 					AND a.post_msg_id = p.post_id";
@@ -1481,6 +1499,7 @@
 				$attach_ids[] = $row['attach_id'];
 
 				phpbb_unlink($row['physical_filename'], 'file');
+
 				if ($row['thumbnail'])
 				{
 					phpbb_unlink($row['physical_filename'], 'thumbnail');
@@ -1491,71 +1510,68 @@
 			if (count($attach_ids))
 			{
 				$attach_id_list = implode(',', array_unique($attach_ids));
-				$_CLASS['core_db']->query('DELETE FROM ' . ATTACHMENTS_TABLE . " WHERE attach_id IN ($attach_id_list)");
+				$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . " WHERE attach_id IN ($attach_id_list)");
 				unset($attach_ids, $attach_id_list);
 			}
 
 			// Delete everything else and curse your DB for not offering multi-table deletion
 			$tables_ary = array(
 				'post_id'	=>	array(
-					SEARCH_MATCH_TABLE,
-					REPORTS_TABLE,
+					FORUMS_SEARCH_MATCH_TABLE,
+					FORUMS_REPORTS_TABLE,
 				),
 				
 				'topic_id'	=>	array(
-					BOOKMARKS_TABLE,
-					TOPICS_WATCH_TABLE,
-					TOPICS_TRACK_TABLE,
-					POLL_OPTIONS_TABLE,
-					POLL_VOTES_TABLE
+					FORUMS_BOOKMARKS_TABLE,
+					FORUMS_WATCH_TABLE,
+					FORUMS_TRACK_TABLE,
+					FORUMS_POLL_OPTIONS_TABLE,
+					FORUMS_POLL_VOTES_TABLE
 				)
 			);
 
 			foreach ($tables_ary as $field => $tables)
 			{
 				$start = 0;
-				$ids = array();
+				$id_array = array();
 
 				$sql = "SELECT $field
-					FROM " . POSTS_TABLE . '
+					FROM " . FORUMS_POSTS_TABLE . '
 					WHERE forum_id = ' . $forum_id;
 				$result = $_CLASS['core_db']->query($sql);
 
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
-					$ids[] = $row[$field];
+					$id_array[] = $row[$field];
 				}
 				$_CLASS['core_db']->free_result($result);
 
-				if (!count($ids))
+				if (empty($id_array))
 				{
 					continue;
 				}
 
-				$id_list = implode(',', $ids);
-
 				foreach ($tables as $table)
 				{
-					$_CLASS['core_db']->query("DELETE FROM $table WHERE $field IN ($id_list)");
+					$_CLASS['core_db']->query("DELETE FROM $table WHERE $field IN (".implode(',', $id_array).')');
 				}
 			}
-			unset($ids, $id_list);
+			unset($id_array);
 
-			$table_ary = array(POSTS_TABLE, FORUMS_ACCESS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, TOPICS_TABLE, ACL_GROUPS_TABLE, ACL_USERS_TABLE, MODERATOR_TABLE, LOG_TABLE);
+			$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_TOPICS_TABLE, FORUMS_ACL_TABLE, FORUMS_MODERATOR_TABLE, FORUMS_LOG_TABLE);
 
 			foreach ($table_ary as $table)
 			{
 				$_CLASS['core_db']->query("DELETE FROM $table WHERE forum_id = $forum_id");
 			}
-
-			// NEED to have this done at the end, maybe a cran
-			$tables = array_merge($tables_ary['post_id'], $tables_ary['topic_id'], $table_ary, array(ATTACHMENTS_TABLE));
-			$_CLASS['core_db']->optimize_tables($tables);
+		break;
 	}
 
 	$_CLASS['core_db']->transaction('commit');
 	
-	return array();
+	// NEED to have this done at the end, maybe a cran
+	$tables = array_unique(array_merge($tables_ary['post_id'], $tables_ary['topic_id'], $table_ary, array(FORUMS_ATTACHMENTS_TABLE)));
+	$_CLASS['core_db']->optimize_tables($tables);
 }
 
 function recalc_btree()
@@ -1563,7 +1579,7 @@
 	global $_CLASS;
 
 	$sql = 'SELECT forum_id, parent_id, left_id, right_id 
-		FROM ' . FORUMS_TABLE . '
+		FROM ' . FORUMS_FORUMS_TABLE . '
 		ORDER BY parent_id ASC';
 	$f_result = $_CLASS['core_db']->query($sql);
 
@@ -1572,23 +1588,23 @@
 		if ($forum_data['parent_id'])
 		{
 			$sql = 'SELECT left_id, right_id
-				FROM ' . FORUMS_TABLE . '
+				FROM ' . FORUMS_FORUMS_TABLE . '
 				WHERE forum_id = ' . $forum_data['parent_id'];
 			$result = $_CLASS['core_db']->query($sql);
 
 			if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$sql = 'UPDATE ' . FORUMS_TABLE . ' SET parent_id = 0 WHERE forum_id = ' . $forum_data['forum_id'];
+				$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . ' SET parent_id = 0 WHERE forum_id = ' . $forum_data['forum_id'];
 				$_CLASS['core_db']->query($sql);
 			}
 			$_CLASS['core_db']->free_result($result);
 
-			$sql = 'UPDATE ' . FORUMS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 				SET left_id = left_id + 2, right_id = right_id + 2
 				WHERE left_id > ' . $row['right_id'];
 			$_CLASS['core_db']->query($sql);
 
-			$sql = 'UPDATE ' . FORUMS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 				SET right_id = right_id + 2
 				WHERE ' . $row['left_id'] . ' BETWEEN left_id AND right_id';
 			$_CLASS['core_db']->query($sql);
@@ -1599,7 +1615,7 @@
 		else
 		{
 			$sql = 'SELECT MAX(right_id) AS right_id
-				FROM ' . FORUMS_TABLE;
+				FROM ' . FORUMS_FORUMS_TABLE;
 			$result = $_CLASS['core_db']->query($sql);
 
 			$row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -1609,7 +1625,7 @@
 			$forum_data['right_id'] = $row['right_id'] + 2;
 		}
 	
-		$sql = 'UPDATE ' . FORUMS_TABLE . '
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 			SET left_id = ' . $forum_data['left_id'] . ', right_id = ' . $forum_data['right_id'] . '
 			WHERE forum_id = ' . $forum_data['forum_id'];
 		$_CLASS['core_db']->query($sql);

Modified: trunk/includes/forums/admin/admin_icons.php
===================================================================
--- trunk/includes/forums/admin/admin_icons.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/admin/admin_icons.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -31,19 +31,20 @@
 // What are we working on?
 switch ($mode)
 {
-	case 'smilies':
-		$table = SMILIES_TABLE;
+/*	case 'smilies':
+		$table = FORUMS_SMILIES_TABLE;
 		$lang = 'SMILIES';
 		$fields = 'smiley';
 		$img_path = $config['smilies_path'];
-		break;
+	break;*/
 
-	case 'icons':
-		$table = ICONS_TABLE;
+	//case 'icons':
+	default:
+		$table = FORUMS_ICONS_TABLE;
 		$lang = 'ICONS';
 		$fields = 'icons';
 		$img_path = $config['icons_path'];
-		break;
+	break;
 }
 
 // Clear some arrays
@@ -96,9 +97,9 @@
 		$sql = "SELECT * 
 			FROM $table 
 			ORDER BY {$fields}_order " . (($id || $action == 'add') ? 'DESC' : 'ASC');
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			do
 			{
@@ -130,9 +131,9 @@
 					$order_list = '<option value="' . ($row[$fields . '_order']) . '"' . $selected . '>' . sprintf($_CLASS['core_user']->lang['AFTER_' . $lang], ' -&gt; ' . htmlspecialchars($after_txt)) . '</option>' . $order_list;
 				}
 			}
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result));
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
 		$order_list = '<option value="1"' . ((!isset($after)) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['FIRST'] . '</option>' . $order_list;
 
@@ -312,12 +313,12 @@
 					$sql = "UPDATE $table
 						SET " . $_CLASS['core_db']->sql_build_array('UPDATE', $img_sql) . " 
 						WHERE {$fields}_id = " . $image_id[$image];
-					$_CLASS['core_db']->sql_query($sql);
+					$_CLASS['core_db']->query($sql);
 				}
 				else
 				{
 					$sql = "INSERT INTO $table " . $_CLASS['core_db']->sql_build_array('INSERT', $img_sql);
-					$_CLASS['core_db']->sql_query($sql);
+					$_CLASS['core_db']->query($sql);
 				}
 
 				$update = FALSE;
@@ -326,7 +327,7 @@
 				{
 					$update = TRUE;
 
-					$result = $_CLASS['core_db']->sql_query("SELECT {$fields}_order 
+					$result = $_CLASS['core_db']->query("SELECT {$fields}_order 
 						FROM $table
 						WHERE {$fields}_id = " . $image_id[$image]);
 					$order_old = $_CLASS['core_db']->sql_fetchfield($fields . '_order', 0, $result);
@@ -354,7 +355,7 @@
 					$sql = "UPDATE $table
 						SET {$fields}_order = {$fields}_order $sign 1
 						WHERE $where";
-					$_CLASS['core_db']->sql_query($sql);
+					$_CLASS['core_db']->query($sql);
 				}
 			
 			}
@@ -385,7 +386,7 @@
 			// The user has already selected a smilies_pak file
 			if ($current == 'delete')
 			{
-				$_CLASS['core_db']->sql_query("TRUNCATE $table");
+				$_CLASS['core_db']->query("TRUNCATE $table");
 
 				switch ($mode)
 				{
@@ -394,9 +395,9 @@
 
 					case 'icons':
 						// Reset all icon_ids
-						$_CLASS['core_db']->sql_query('UPDATE ' . TOPICS_TABLE . ' 
+						$_CLASS['core_db']->query('UPDATE ' . TOPICS_TABLE . ' 
 							SET icon_id = 0');
-						$_CLASS['core_db']->sql_query('UPDATE ' . POSTS_TABLE . ' 
+						$_CLASS['core_db']->query('UPDATE ' . POSTS_TABLE . ' 
 							SET icon_id = 0');
 						break;
 				}
@@ -406,14 +407,14 @@
 				$cur_img = array();
 
 				$field_sql = ($mode == 'smilies') ? 'code' : 'icons_url';
-				$result = $_CLASS['core_db']->sql_query("SELECT $field_sql FROM $table");
+				$result = $_CLASS['core_db']->query("SELECT $field_sql FROM $table");
 
-				while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
 					++$order;
 					$cur_img[$row[$field_sql]] = 1;
 				}
-				$_CLASS['core_db']->sql_freeresult($result);
+				$_CLASS['core_db']->free_result($result);
 			}
 
 			if (!($pak_ary = @file($img_path . '/' . $pak)))
@@ -458,7 +459,7 @@
 							));
 						}
 
-						$_CLASS['core_db']->sql_query("UPDATE $table SET " . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . " 
+						$_CLASS['core_db']->query("UPDATE $table SET " . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . " 
 							WHERE $field_sql = '" . $_CLASS['core_db']->sql_escape($replace_sql) . "'");
 					}
 					else
@@ -479,7 +480,7 @@
 								'emotion'	=>	$emotion
 							));
 						}
-						$_CLASS['core_db']->sql_query("INSERT INTO $table " . $_CLASS['core_db']->sql_build_array('INSERT', $sql));
+						$_CLASS['core_db']->query("INSERT INTO $table " . $_CLASS['core_db']->sql_build_array('INSERT', $sql));
 					}
 
 				}
@@ -559,10 +560,10 @@
 		$sql = "SELECT * 
 			FROM $table
 			ORDER BY {$fields}_order";
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
 		$pak = '';
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$pak .= "'" . addslashes($row[$fields . '_url']) . "', ";
 			$pak .= "'" . addslashes($row[$fields . '_height']) . "', ";
@@ -574,7 +575,7 @@
 			}
 			$pak .= "\n";
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
 		if ($pak != '')
 		{
@@ -593,7 +594,7 @@
 
 	case 'delete':
 
-		$_CLASS['core_db']->sql_query("DELETE FROM $table 
+		$_CLASS['core_db']->query("DELETE FROM $table 
 			WHERE {$fields}_id = $id");
 
 		switch ($mode)
@@ -603,10 +604,10 @@
 
 			case 'icons':
 				// Reset appropriate icon_ids
-				$_CLASS['core_db']->sql_query('UPDATE ' . TOPICS_TABLE . " 
+				$_CLASS['core_db']->query('UPDATE ' . TOPICS_TABLE . " 
 					SET icon_id = 0 
 					WHERE icon_id = $id");
-				$_CLASS['core_db']->sql_query('UPDATE ' . POSTS_TABLE . " 
+				$_CLASS['core_db']->query('UPDATE ' . POSTS_TABLE . " 
 					SET icon_id = 0 
 					WHERE icon_id = $id");
 				break;
@@ -625,7 +626,7 @@
 			$sql = 'UPDATE ' . $table . '
 				SET ' . $fields . "_order = $order_total - " . $fields . '_order
 				WHERE ' . $fields . "_order IN ($image_order, " . (($action == 'move_up') ? $image_order - 1 : $image_order + 1) . ')';
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			$_CLASS['core_cache']->destroy('icons');
 
@@ -638,9 +639,9 @@
 		$sql = "SELECT {$fields}_id AS order_id, {$fields}_order AS fields_order
 			FROM $table
 			ORDER BY {$fields}_order";
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$order = 0;
 			do
@@ -648,14 +649,14 @@
 				++$order;
 				if ($row['fields_order'] != $order)
 				{
-					$_CLASS['core_db']->sql_query("UPDATE $table
+					$_CLASS['core_db']->query("UPDATE $table
 						SET {$fields}_order = $order
 						WHERE {$fields}_id = " . $row['order_id']);
 				}
 			}
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result));
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
 		// Output the page
 		adm_page_header($_CLASS['core_user']->lang[$lang]);
@@ -707,11 +708,11 @@
 		$sql = "SELECT * 
 			FROM $table
 			ORDER BY display_on_posting DESC, {$fields}_order ASC";
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 		
 		$row_class = 'row1';
 
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			if (!$spacer && !$row['display_on_posting'])
 			{
@@ -744,7 +745,7 @@
 <?php
 
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
 ?>
 		<tr>

Modified: trunk/includes/forums/admin/admin_permissions.php
===================================================================
--- trunk/includes/forums/admin/admin_permissions.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/admin/admin_permissions.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -112,10 +112,12 @@
 {
 	$forum_id[$which_mode][] = 0;
 }
+
 $sql_forum_id = implode(', ', array_map('intval', $forum_id[$which_mode]));
 
 // Generate list of forum id's
 $s_forum_id = '';
+
 foreach ($forum_id as $forum_submode => $forum_submode_ids)
 {
 	foreach ($forum_submode_ids as $submode_forum_id)
@@ -229,17 +231,18 @@
 			$l_ug_list = '';
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) && $row['group_type'] == GROUP_SPECIAL) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
+				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . (($row['group_type'] == GROUP_SYSTEM) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
 			}
 			$_CLASS['core_db']->free_result($result);
 
-			foreach (array_keys($auth_settings) as $submode)
+			$auth_submode = array_keys($auth_settings);
+			foreach ($auth_submode as $sub_mode)
 			{
-				if (!in_array(0, $forum_id[$submode]))
+				if (!in_array(0, $forum_id[$sub_mode]))
 				{
 					// Grab the forum details if non-zero forum_id
 					$sql = 'SELECT forum_name  
-						FROM ' . FORUMS_TABLE . "
+						FROM ' . FORUMS_FORUMS_TABLE . "
 						WHERE forum_id IN ($sql_forum_id)";
 					$result = $_CLASS['core_db']->query($sql);
 
@@ -250,11 +253,11 @@
 					}
 					$_CLASS['core_db']->free_result($result);
 
-					add_log('admin', 'LOG_ACL_' . strtoupper($submode) . '_ADD', $l_forum_list, $l_ug_list);
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_forum_list, $l_ug_list);
 				}
 				else
 				{
-					add_log('admin', 'LOG_ACL_' . strtoupper($submode) . '_ADD', $l_ug_list);
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_ug_list);
 				}
 			}
 			unset($l_ug_list);
@@ -268,7 +271,7 @@
 	case 'delete':
 
 		$sql = "SELECT auth_option_id
-			FROM " . ACL_OPTIONS_TABLE . "
+			FROM " . FORUMS_ACL_OPTIONS_TABLE . "
 			WHERE auth_option LIKE '{$sql_option_mode}_%'";
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -297,7 +300,6 @@
 			cache_moderators();
 		}
 
-
 		// Logging ... first grab user or groupnames ...
 		$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
 		$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
@@ -315,7 +317,7 @@
 		if (!in_array(0, $forum_id[$which_mode]))
 		{
 			$sql = 'SELECT forum_name  
-				FROM ' . FORUMS_TABLE . "
+				FROM ' . FORUMS_FORUMS_TABLE . "
 				WHERE forum_id IN ($sql_forum_id)";
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -373,7 +375,7 @@
 		
 		if (!empty($sql['preset_name']) || $_POST['presetoption'] != -1)
 		{
-			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql) : 'UPDATE ' . ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . intval($_POST['presetoption']);
+			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . FORUMS_ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql) : 'UPDATE ' . FORUMS_ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . intval($_POST['presetoption']);
 			$_CLASS['core_db']->query($sql);
 
 			add_log('admin', 'LOG_ACL_PRESET_ADD', $sql['preset_name']);
@@ -387,15 +389,15 @@
 		if (!empty($_POST['presetoption']))
 		{
 			$sql = "SELECT preset_name 
-				FROM " . ACL_PRESETS_TABLE . " 
-				WHERE preset_id = " . intval($_POST['presetoption']);
+				FROM " . FORUMS_ACL_PRESETS_TABLE . " 
+				WHERE preset_id = " . (int) $_POST['presetoption'];
 			$result = $_CLASS['core_db']->query($sql);
 
 			$row = $_CLASS['core_db']->fetch_row_assoc($result);
 			$_CLASS['core_db']->free_result($result);
 
-			$sql = "DELETE FROM " . ACL_PRESETS_TABLE . " 
-				WHERE preset_id = " . intval($_POST['presetoption']);
+			$sql = "DELETE FROM " . FORUMS_ACL_PRESETS_TABLE . " 
+				WHERE preset_id = " . (int) $_POST['presetoption'];
 			$_CLASS['core_db']->query($sql);
 
 			add_log('admin', 'LOG_ACL_PRESET_DEL', $row['preset_name']);
@@ -531,7 +533,7 @@
 				<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php
 			
 	$sql = "SELECT u.user_id, u.username
-		FROM " . USERS_TABLE . " u, " . ACL_TABLE . " a, " . ACL_OPTIONS_TABLE . " o
+		FROM " . USERS_TABLE . " u, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
 		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
 			AND a.auth_option_id = o.auth_option_id
 			AND a.forum_id IN ($sql_forum_id)
@@ -561,7 +563,7 @@
 			<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php 
 	
 	$sql = "SELECT DISTINCT g.group_id, g.group_name, g.group_type 
-		FROM " . GROUPS_TABLE . " g, " . ACL_TABLE . " a, " . ACL_OPTIONS_TABLE . " o
+		FROM " . GROUPS_TABLE . " g, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
 		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
 			AND a.forum_id IN ($sql_forum_id)
 			AND a.auth_option_id = o.auth_option_id
@@ -572,7 +574,7 @@
 	$groups = '';
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		echo '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
 	}
 	$_CLASS['core_db']->free_result($result);
 
@@ -613,7 +615,7 @@
 	$group_list = '';
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		echo '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
 	}
 	$_CLASS['core_db']->free_result($result);
 		
@@ -654,7 +656,7 @@
 	if (!in_array(0, $forum_id[$which_mode]))
 	{
 		$sql = 'SELECT forum_id, forum_name, parent_id  
-			FROM ' . FORUMS_TABLE . "
+			FROM ' . FORUMS_FORUMS_TABLE . "
 			WHERE forum_id IN ($sql_forum_id)";
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -680,25 +682,24 @@
 
 	// Grab relevant user or group information
 	$ug_ids = $l_ug_list = $ug_hidden = $l_no_error = '';
+// need some work ( array_mapping()) blaa blaa
 	switch ($ug_type)
 	{
 		case 'user':
-			// If we've just come from the usergroup form then user will actually
-			// be a username rather than a user_id, so act appropriately
 			$l_no_error = $_CLASS['core_user']->lang['NO_USER'];
 			$sql = 'SELECT user_id AS id, username AS name 
 				FROM ' . USERS_TABLE . ' 
 				WHERE ';
-			$sql .= ($submit == 'add_options') ? ' username IN (' . implode(', ', array_unique(preg_replace('#^[\s]*?(.*?)[\s]*?$#', "'\\1'", explode("\n", $ug_data[0])))) . ')' : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', $ug_data) . ')' : '= ' . $ug_data);
-			break;
+			$sql .= ($submit == 'add_options') ? " username IN ('" . implode("', '", $_CLASS['core_db']->escape_array(array_unique(explode("\n", modify_lines($ug_data[0], "\n"))))) . "')" : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : '= ' . (int) $ug_data);
+		break;
 
 		case 'group':
 			$l_no_error = $_CLASS['core_user']->lang['NO_GROUP'];
 			$sql = 'SELECT group_id AS id, group_name AS name, group_type  
 				FROM ' . GROUPS_TABLE . '
 				WHERE group_id';
-			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', $ug_data) . ')' : ' = ' . $ug_data;
-			break;
+			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : ' = ' . (int) $ug_data;
+		break;
 	}
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -721,13 +722,11 @@
 
 	// Grab the list of options ... if we're in deps mode we want all options, 
 	// else we skip the master options
-	$sql_founder = ($_CLASS['core_user']->data['user_type'] == USER_FOUNDER) ? ' AND founder_only <> 1' : '';
 	$sql_limit_option = ($mode == 'deps') ? '' : "AND auth_option <> '" . $sql_option_mode . "_'";
 	$sql = "SELECT auth_option_id, auth_option
-		FROM " . ACL_OPTIONS_TABLE . "
+		FROM " . FORUMS_ACL_OPTIONS_TABLE . "
 		WHERE auth_option LIKE '" . $sql_option_mode . "_%' 
-			$sql_limit_option 
-			$sql_founder";
+			$sql_limit_option";
 	$result = $_CLASS['core_db']->query($sql);
 
 	$auth_options = array();
@@ -751,7 +750,7 @@
 
 		 
 		$sql = "SELECT o.auth_option, a.auth_setting
-					FROM " . ACL_TABLE . " a, " . ACL_OPTIONS_TABLE . " o 
+					FROM " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o 
 					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
 						AND a.auth_option_id = o.auth_option_id AND a.forum_id = " . $forum_data['parent_id'] . '
 						AND a.'.(($ug_type == 'group') ? 'group_id' : 'user_id')." IN ($ug_ids)";
@@ -789,7 +788,7 @@
 
 	// Look for custom presets
 	$sql = "SELECT preset_id, preset_name, preset_data  
-		FROM " . ACL_PRESETS_TABLE . " 
+		FROM " . FORUMS_ACL_PRESETS_TABLE . " 
 		WHERE preset_type = '" . (($mode == 'deps') ? 'f' : $sql_option_mode) . "' 
 		ORDER BY preset_id ASC";
 	$result = $_CLASS['core_db']->query($sql);
@@ -821,7 +820,7 @@
 		if ($which_mode == $mode)
 		{
 			$sql = 'SELECT o.auth_option, MIN(a.auth_setting) AS min_auth_setting 
-					FROM '.ACL_TABLE.' a, ' . ACL_OPTIONS_TABLE . " o 
+					FROM '. FORUMS_ACL_TABLE .' a, ' . FORUMS_ACL_OPTIONS_TABLE . " o 
 					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
 						AND a.auth_option_id = o.auth_option_id 
 						AND a.forum_id IN ($sql_forum_id) 

Modified: trunk/includes/forums/admin/links.php
===================================================================
--- trunk/includes/forums/admin/links.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/admin/links.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -18,10 +18,7 @@
 	
 $module['DB']['SEARCH_INDEX'] 				= ($_CLASS['auth']->acl_get('a_search')) ? generate_link('Forums&amp;file=admin_search', array('admin' => true)) : false;
 
-$module['USER']['BOTS'] 					= ($_CLASS['auth']->acl_get('a_server')) ? generate_link('Forums&amp;file=admin_bots', array('admin' => true)) : false;
-$module['USER']['MANAGE_USERS']				= ($_CLASS['auth']->acl_gets('a_user', 'a_useradd', 'a_userdel')) ? generate_link('Forums&amp;file=admin_users', array('admin' => true)) : '';
 $module['USER']['RANKS']					= ($_CLASS['auth']->acl_get('a_ranks')) ? generate_link('Forums&amp;file=admin_ranks', array('admin' => true)) : '';
-$module['USER']['GROUP_MANAGE'] 			= ($_CLASS['auth']->acl_get('a_group')) ? generate_link('Forums&amp;file=admin_groups&amp;mode=manage', array('admin' => true)) : '';
 $module['USER']['DISALLOW']					= ($_CLASS['auth']->acl_get('a_names')) ? generate_link('Forums&amp;file=admin_disallow', array('admin' => true)) : '';
 
 $module['FORUM']['MANAGE']					= ($_CLASS['auth']->acl_gets('a_forum', 'a_forumadd', 'a_forumdel')) ? generate_link('Forums&amp;file=admin_forums', array('admin' => true)) : false;
@@ -48,7 +45,6 @@
 
 $module['POST']['ATTACHMENTS'] 				= ($_CLASS['auth']->acl_get('a_attach')) ? generate_link('Forums&amp;file=admin_attachments&amp;mode=ext_groups', array('admin' => true)) : '';
 $module['POST']['BBCODES']					= ($_CLASS['auth']->acl_get('a_bbcode')) ? generate_link('Forums&amp;file=admin_bbcodes', array('admin' => true)) : '';
-$module['POST']['SMILIES']					= ($_CLASS['auth']->acl_get('a_icons')) ? generate_link('Forums&amp;file=admin_icons&amp;mode=smilies', array('admin' => true)) : '';
 $module['POST']['ICONS']					= ($_CLASS['auth']->acl_get('a_icons')) ? generate_link('Forums&amp;file=admin_icons&amp;mode=icons', array('admin' => true)) : '';
 
 ?>
\ No newline at end of file

Modified: trunk/includes/forums/admin/main.php
===================================================================
--- trunk/includes/forums/admin/main.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/admin/main.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -26,17 +26,6 @@
 
 switch ($action)
 {
-	case 'online':
-		if (!$_CLASS['auth']->acl_get('a_defaults'))
-		{
-			trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-		}
-
-		set_config('record_online_users', 1, true);
-		set_config('record_online_date', time(), true);
-		add_log('admin', 'LOG_RESET_ONLINE');
-		break;
-
 	case 'stats':
 		if (!$_CLASS['auth']->acl_get('a_defaults'))
 		{
@@ -44,48 +33,41 @@
 		}
 
 		$sql = 'SELECT COUNT(post_id) AS stat 
-			FROM ' . POSTS_TABLE . '
+			FROM ' . FORUMS_POSTS_TABLE . '
 			WHERE post_approved = 1';
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		$row = $_CLASS['core_db']->sql_fetchrow($result);
-		$_CLASS['core_db']->sql_freeresult($result);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 		set_config('num_posts', (int) $row['stat'], true);
 
 		$sql = 'SELECT COUNT(topic_id) AS stat
-			FROM ' . TOPICS_TABLE . '
+			FROM ' . FORUMS_TOPICS_TABLE . '
 			WHERE topic_approved = 1';
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		$row = $_CLASS['core_db']->sql_fetchrow($result);
-		$_CLASS['core_db']->sql_freeresult($result);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 		set_config('num_topics', (int) $row['stat'], true);
 
-		$sql = 'SELECT COUNT(user_id) AS stat
-			FROM ' . USERS_TABLE . '
-			WHERE user_type IN (' . USER_NORMAL . ',' . USER_FOUNDER . ')';
-		$result = $_CLASS['core_db']->sql_query($sql);
-
-		$row = $_CLASS['core_db']->sql_fetchrow($result);
-		$_CLASS['core_db']->sql_freeresult($result);
-		set_config('num_users', (int) $row['stat'], true);
-
 		$sql = 'SELECT COUNT(attach_id) as stat
-			FROM ' . ATTACHMENTS_TABLE;
-		$result = $_CLASS['core_db']->sql_query($sql);
+			FROM ' . FORUMS_ATTACHMENTS_TABLE;
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	
+		set_config('num_files', (int) $row['stat'], true);
+		$_CLASS['core_db']->free_result($result);
 
-		set_config('num_files', (int) $_CLASS['core_db']->sql_fetchfield('stat', 0, $result), true);
-		$_CLASS['core_db']->sql_freeresult($result);
-
 		$sql = 'SELECT SUM(filesize) as stat
-			FROM ' . ATTACHMENTS_TABLE;
-		$result = $_CLASS['core_db']->sql_query($sql);
+			FROM ' . FORUMS_ATTACHMENTS_TABLE;
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 
-		set_config('upload_dir_size', (int) $_CLASS['core_db']->sql_fetchfield('stat', 0, $result), true);
-		$_CLASS['core_db']->sql_freeresult($result);
+		set_config('upload_dir_size', (int) $row['stat'], true);
+		$_CLASS['core_db']->free_result($result);
 
 		add_log('admin', 'LOG_RESYNC_STATS');
-		break;
+	break;
 		
 	case 'user':
 		if (!$_CLASS['auth']->acl_get('a_defaults'))
@@ -106,36 +88,26 @@
 		
 		if (!sizeof($forum_ary))
 		{
-			$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . ' SET user_posts = 0');
+			$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . ' SET user_posts = 0');
 		}
 		else
 		{
 			$sql = 'SELECT COUNT(post_id) AS num_posts, poster_id
-				FROM ' . POSTS_TABLE . '
+				FROM ' . FORUMS_POSTS_TABLE . '
 				WHERE poster_id <> ' . ANONYMOUS . '
 					AND forum_id IN (' . implode(', ', $forum_ary) . ')
 				GROUP BY poster_id';
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . " SET user_posts = {$row['num_posts']} WHERE user_id = {$row['poster_id']}");
+				$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . " SET user_posts = {$row['num_posts']} WHERE user_id = {$row['poster_id']}");
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 		}
 
 		add_log('admin', 'LOG_RESYNC_POSTCOUNTS');
 		break;
-		
-	case 'date':
-		if (!$_CLASS['auth']->acl_get('a_defaults'))
-		{
-			trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-		}
-
-		set_config('board_startdate', time() - 1);
-		add_log('admin', 'LOG_RESET_DATE');
-		break;
 }
 
 // Get forum statistics
@@ -146,7 +118,7 @@
 
 $start_date = $_CLASS['core_user']->format_date($config['board_startdate']);
 
-$boarddays = (time() - $config['board_startdate']) / 86400;
+$boarddays = (gmtime() - $config['board_startdate']) / 86400;
 
 $posts_per_day = sprintf('%.2f', $total_posts / $boarddays);
 $topics_per_day = sprintf('%.2f', $total_topics / $boarddays);

Modified: trunk/includes/forums/auth.php
===================================================================
--- trunk/includes/forums/auth.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/auth.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -34,7 +34,7 @@
 		if (is_null($this->acl_options = $_CLASS['core_cache']->get('acl_options')))
 		{
 			$sql = 'SELECT auth_option, is_global, is_local
-				FROM ' . ACL_OPTIONS_TABLE . '
+				FROM ' . FORUMS_ACL_OPTIONS_TABLE . '
 				ORDER BY auth_option_id';
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -257,7 +257,7 @@
 		$sql_opts = ($opts) ? (is_array($opts) ? ' AND ao.auth_option IN (' . implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', "\"'\" . \$_CLASS['core_db']->escape('\\1') . \"'\"", $opts)) . ')' : "AND ao.auth_option = '".$_CLASS['core_db']->escape($opts)."'") : '';
 		$groups = $group_members = $hold_ary = array();
 
-		$sql = 'SELECT group_id, user_id FROM ' . USER_GROUP_TABLE ." WHERE $sql_user AND user_status <> ".STATUS_PENDING;
+		$sql = 'SELECT group_id, user_id FROM ' . USER_GROUP_TABLE ." WHERE $sql_user AND member_status <> ".STATUS_PENDING;
 // This is the why phpBB3 seems to be, the why they wanted it to act may have been the above.
 // atleast when you look at the coding....	
 		//$sql = 'SELECT group_id, user_id FROM ' . USERS_TABLE .' WHERE '.$sql_user;
@@ -274,7 +274,7 @@
 
 		// Sort by group_id since we want user setting to over right grp..  specific > broad
 		$sql = 'SELECT ao.auth_option, a.user_id, a.group_id, a.forum_id, a.auth_setting
-					FROM ' . ACL_TABLE . ' a, ' . ACL_OPTIONS_TABLE . " ao
+					FROM ' . FORUMS_ACL_TABLE . ' a, ' . FORUMS_ACL_OPTIONS_TABLE . " ao
 					WHERE a.auth_option_id = ao.auth_option_id 
 						$sql_user $sql_forum $sql_opts
 						ORDER BY a.group_id";
@@ -331,7 +331,7 @@
 
 		// Grab group settings ... ACL_NO overrides ACL_YES so act appropriatley
 		$sql = 'SELECT a.group_id, ao.auth_option, a.forum_id, a.auth_setting
-			FROM ' . ACL_OPTIONS_TABLE . ' ao, ' . ACL_GROUPS_TABLE . ' a
+			FROM ' . FORUMS_ACL_OPTIONS_TABLE . ' ao, ' . FORUMS_ACL_GROUPS_TABLE . ' a
 			WHERE ao.auth_option_id = a.auth_option_id
 				' . (($sql_group) ? 'AND a.' . $sql_group : '') . "
 				$sql_forum

Modified: trunk/includes/forums/bbcode.php
===================================================================
--- trunk/includes/forums/bbcode.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/bbcode.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -227,7 +227,7 @@
 			$rowset = array();
 
 			$sql = 'SELECT *
-				FROM ' . BBCODES_TABLE . "
+				FROM ' . FORUMS_BBCODES_TABLE . "
 				WHERE bbcode_id IN ($sql)";
 
 			$result = $_CLASS['core_db']->query($sql);

Modified: trunk/includes/forums/functions.php
===================================================================
--- trunk/includes/forums/functions.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/functions.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -23,12 +23,16 @@
 // 
 // -------------------------------------------------------------
 
+// Error messages just incase we can't get our configs
+$config_error = '<center>There is currently a problem with the site<br/>';
+$config_error .= 'Please try again later<br /><br />Error Code: DB3</center>';
+
 if (is_null($config = $_CLASS['core_cache']->get('config')))
 {
 	$config = $cached_config = array();
 
 	$sql = 'SELECT config_name, config_value, is_dynamic
-		FROM ' . CONFIG_TABLE;
+		FROM ' . FORUMS_CONFIG_TABLE;
 			
 	if (!$result = $_CLASS['core_db']->query($sql))
 	{
@@ -53,33 +57,31 @@
 else
 {
 	$sql = 'SELECT config_name, config_value
-		FROM ' . CONFIG_TABLE . '
+		FROM ' . FORUMS_CONFIG_TABLE . '
 		WHERE is_dynamic = 1';
 	$result = $_CLASS['core_db']->query($sql);
 	
-	if (is_array($result))
+	if ($result = $_CLASS['core_db']->query($sql))
 	{
-		trigger_error($config_error, E_USER_ERROR);
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$config[$row['config_name']] = $row['config_value'];
+		}
 	}
-	
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$config[$row['config_name']] = $row['config_value'];
-	}
 }
 
 function set_config($config_name, $config_value, $is_dynamic = false)
 {
 	global $_CLASS, $config;
 
-	$sql = 'UPDATE ' . CONFIG_TABLE . "
+	$sql = 'UPDATE ' . FORUMS_CONFIG_TABLE . "
 		SET config_value = '" . $_CLASS['core_db']->escape($config_value) . "'
 		WHERE config_name = '" . $_CLASS['core_db']->escape($config_name) . "'";
 	$_CLASS['core_db']->query($sql);
 
 	if (!$_CLASS['core_db']->affected_rows() && !isset($config[$config_name]))
 	{
-		$sql = 'INSERT INTO ' . CONFIG_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+		$sql = 'INSERT INTO ' . FORUMS_CONFIG_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 			'config_name'	=> $config_name,
 			'config_value'	=> $config_value,
 			'is_dynamic'	=> ($is_dynamic) ? 1 : 0));
@@ -220,7 +222,7 @@
 		unset($bbcode);
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_FORUM_RULES'	=> true,
 		'U_FORUM_RULES'	=> $forum_data['forum_rules_link'],
 		'FORUM_RULES'   => $forum_data['forum_rules'])
@@ -262,7 +264,7 @@
 		)
 	);
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'FORUM_ID' 		=> $forum_data['forum_id'],
 		'FORUM_NAME'	=> $forum_data['forum_name'],
 		'FORUM_DESC'	=> strip_tags($forum_data['forum_desc']))
@@ -283,7 +285,7 @@
 		if ($forum_data['forum_parents'] == '')
 		{
 			$sql = 'SELECT forum_id, forum_name, forum_type
-				FROM ' . FORUMS_TABLE . '
+				FROM ' . FORUMS_FORUMS_TABLE . '
 				WHERE left_id < ' . $forum_data['left_id'] . '
 					AND right_id > ' . $forum_data['right_id'] . '
 				ORDER BY left_id ASC';
@@ -297,7 +299,7 @@
 
 			$forum_data['forum_parents'] = serialize($forum_parents);
 
-			$sql = 'UPDATE ' . FORUMS_TABLE . "
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 				SET forum_parents = '" . $_CLASS['core_db']->escape($forum_data['forum_parents']) . "'
 				WHERE parent_id = " . $forum_data['parent_id'];
 			$_CLASS['core_db']->query($sql);
@@ -331,7 +333,7 @@
 	}
 
 	$sql = 'SELECT *
-		FROM ' . MODERATOR_TABLE . "
+		FROM ' . FORUMS_MODERATOR_TABLE . "
 		WHERE display_on_index = 1
 			$forum_sql";
 	$result = $_CLASS['core_db']->query($sql);
@@ -418,7 +420,7 @@
 	}
 
 	$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, left_id, right_id
-		FROM ' . FORUMS_TABLE . '
+		FROM ' . FORUMS_FORUMS_TABLE . '
 		ORDER BY left_id ASC';
 	$result = $_CLASS['core_db']->query($sql, 600);
 
@@ -489,7 +491,7 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_DISPLAY_JUMPBOX'	=> $display_jumpbox,
 		'S_JUMPBOX_ACTION'	=> $action)
 	);
@@ -621,7 +623,7 @@
 	switch ($mode)
 	{
 		case 'forum':
-			$forum_id = (is_array($forum_id)) ? array_map('intval', $forum_id) : array($forum_id);
+			$forum_id = is_array($forum_id) ? array_map('intval', $forum_id) : array($forum_id);
 
 			if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
 			{
@@ -649,7 +651,7 @@
 				{
 					$sql = 'DELETE FROM ' . FORUMS_TRACK_TABLE . '
 						WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-							AND forum_id IN (' . implode(', ', $delete_array) . ')';
+							AND forum_id IN (' . implode(', ', $delete_array) . ') AND  topic_id <> 0';
 					$_CLASS['core_db']->query($sql);
 				}
 				unset($delete_array);
@@ -659,44 +661,19 @@
 					$sql = 'UPDATE ' . FORUMS_TRACK_TABLE . "
 						SET mark_time = $time 
 						WHERE user_id = " . $_CLASS['core_user']->data['user_id'] . '
-							AND forum_id IN (' . implode(', ', $sql_update) . ')
+							AND forum_id IN (' . implode(', ', $update_array) . ')
 							AND topic_id = 0';
 					$_CLASS['core_db']->query($sql);
 				}
 
 				if ($sql_insert = array_diff($forum_id, $update_array))
 				{
-					$sql = '';
-
 					foreach ($sql_insert as $forum_id)
 					{
-						switch ($_CLASS['core_db']->db_layer)
-						{
-							case 'mysql':
-							
-								$sql .= (($sql != '') ? ', ' : '') . '(' . $_CLASS['core_user']->data['user_id'] . ", $forum_id, $time)";
-								$sql = 'VALUES ' . $sql;
-								break;
+						$sql = 'INSERT INTO ' . FORUMS_TRACK_TABLE . ' (user_id, forum_id, mark_time)
+							VALUES (' . $_CLASS['core_user']->data['user_id'] . ", $forum_id, $time)";
 
-							case 'mysql4':
-							case 'mssql':
-							case 'mysqli':
-							case 'sqlite':
-								$sql .= (($sql != '') ? ' UNION ALL ' : '') . ' SELECT ' . $_CLASS['core_user']->data['user_id'] . ", $forum_id, $time";
-								break;
-
-							default:
-								$sql = 'INSERT INTO ' . FORUMS_TRACK_TABLE . ' (user_id, forum_id, mark_time)
-									VALUES (' . $_CLASS['core_user']->data['user_id'] . ", $forum_id, $time)";
-								$_CLASS['core_db']->query($sql);
-								$sql = '';
-						}
-
-						if ($sql)
-						{
-							$sql = 'INSERT INTO ' . FORUMS_TRACK_TABLE . " (user_id, forum_id, mark_time) $sql";
-							$_CLASS['core_db']->query($sql);
-						}
+						$_CLASS['core_db']->query($sql);
 					}
 				}
 			}
@@ -719,15 +696,12 @@
 			settype($topic_id, 'integer');
 			settype($forum_id, 'integer');
 
-//if ($_CLASS['core_user']->is_user && ($config['load_db_lastread'] || ($config['load_db_track'] && $type == TRACK_POSTED)))
-// what is this $config['load_db_track'] ?
-
 			if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
 			{
 				$sql = 'UPDATE ' . FORUMS_TRACK_TABLE . "
 							SET forum_id = $forum_id, mark_time = $time
 								WHERE topic_id = $topic_id
-								AND user_id = {$_CLASS['core_user']->data['user_id']}";
+								AND user_id = ".$_CLASS['core_user']->data['user_id'];
 
 				if (!$_CLASS['core_db']->query($sql) || !$_CLASS['core_db']->affected_rows())
 				{
@@ -741,8 +715,7 @@
 					$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TRACK_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
 				}
 			}
-
-			if (!$config['load_db_lastread'])
+			else
 			{
 				$tracking = array();
 				if (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track']))
@@ -798,7 +771,7 @@
 	if (is_null($censors = $_CLASS['core_cache']->get('word_censors')))
 	{
 		$sql = 'SELECT word, replacement
-			FROM  ' . WORDS_TABLE;
+			FROM  ' . FORUMS_WORDS_TABLE;
 		$result = $_CLASS['core_db']->query($sql);
 
 		$censors = array();
@@ -825,7 +798,7 @@
 	if (is_null($icons = $_CLASS['core_cache']->get('icons')))
 	{
 		$sql = 'SELECT *
-			FROM ' . ICONS_TABLE . ' 
+			FROM ' . FORUMS_ICONS_TABLE . ' 
 			ORDER BY icons_order';
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -855,7 +828,7 @@
 	if (is_null($ranks = $_CLASS['core_cache']->get('ranks')))
 	{
 		$sql = 'SELECT *
-			FROM ' . RANKS_TABLE . '
+			FROM ' . FORUMS_RANKS_TABLE . '
 			ORDER BY rank_min DESC';
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -891,9 +864,7 @@
 {
 	global $_CLASS;
 
-	$extensions = $_CLASS['core_cache']->get('extensions');
-
-	if (is_null($extensions))
+	if (is_null($extensions = $_CLASS['core_cache']->get('extensions')))
 	{
 		// The rule is to only allow those extensions defined. ;)
 		$sql = 'SELECT e.extension, g.*
@@ -974,42 +945,6 @@
 	return (($config['cookie_secure']) ? 'https://' : 'http://') . preg_replace('#^/?(.*?)/?$#', '\1', trim($config['server_name'])) . (($config['server_port'] <> 80) ? ':' . trim($config['server_port']) : '') . (($path) ? '/' . $path : '');
 }
 
-// Redirects the user to another page then exits the script nicely
-function redirect($url)
-{
-	global $_CLASS, $config;
-
-	script_close();
-
-	// Make sure no &amp;'s are in, this will break the redirect
-	$url = str_replace('&amp;', '&', $url);
-	
-	// Local redirect? If not, prepend the boards url
-	if (strpos($url, '://') === false && $url{0} != '/')
-	{
-		$url = generate_board_url() . preg_replace('#^/?(.*?)/?$#', '/\1', trim($url));
-	}
-
-	// Redirect via an HTML form for PITA webservers
-	if (@preg_match('#Microsoft|WebSTAR|Xitami#', getenv('SERVER_SOFTWARE')))
-	{
-		header('Refresh: 0; URL=' . $url);
-		echo '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html><head><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"><meta http-equiv="refresh" content="0; url=' . $url . '"><title>Redirect</title></head><body><div align="center">' . sprintf($_CLASS['core_user']->lang['URL_REDIRECT'], '<a href="' . $url . '">', '</a>') . '</div></body></html>';
-		exit;
-	}
-
-	// Behave as per HTTP/1.1 spec for others
-	header('Location: ' . $url);
-	exit;
-}
-
-// Build Confirm box
-// something is wrong with $check in this function
-function confirm_box($check, $title = '', $hidden = '', $html_body = 'confirm_body.html')
-{
-
-}
-
 // Generate forum login box
 function login_forum_box($forum_data)
 {
@@ -1064,9 +999,9 @@
 
 		$_CLASS['core_template']->assign('LOGIN_ERROR', $_CLASS['core_user']->lang['WRONG_PASSWORD']);
 	}
-	
+
 	page_header();
-	
+
 	$_CLASS['core_template']->display('modules/Forums/login_forum.html');
 
 	script_close();
@@ -1265,7 +1200,7 @@
 						$row['username'] = '<b style="color:#' . $row['user_colour'] . '">' . $row['username'] . '</b>';
 					}
 
-					if ($row['user_allow_viewonline'] && $row['session_viewonline'])
+					if ($row['user_allow_viewonline'] && !$row['session_hidden'])
 					{
 						$user_online_link = $row['username'];
 						$logged_visible_online++;
@@ -1275,7 +1210,7 @@
 						$user_online_link = '<i>' . $row['username'] . '</i>';
 						$logged_hidden_online++;
 					}
-
+// Fix this
 					if ($row['user_allow_viewonline'] || $_CLASS['auth']->acl_get('u_viewonline'))
 					{
 						$user_online_link = ($row['user_type'] & USER_BOT) ? "<a href=\"" . generate_link('Members_List&amp;&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '">' . $user_online_link . '</a>' : $user_online_link;
@@ -1389,7 +1324,7 @@
 
 	// The following assigns all _common_ variables that may be used at any point
 	// in a template.
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'LAST_VISIT_DATE' 			=> sprintf($_CLASS['core_user']->lang['YOU_LAST_VISIT'], $s_last_visit),
 		'CURRENT_TIME'				=> sprintf($_CLASS['core_user']->lang['CURRENT_TIME'], $_CLASS['core_user']->format_date(time(), false, true)),
 		'TOTAL_USERS_ONLINE' 		=> $l_online_users,

Modified: trunk/includes/forums/functions_admin.php
===================================================================
--- trunk/includes/forums/functions_admin.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/functions_admin.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -32,7 +32,7 @@
 
 	// This query is identical to the jumpbox one
 	$sql = 'SELECT forum_id, parent_id, forum_name, forum_type, left_id, right_id
-		FROM ' . FORUMS_TABLE . '
+		FROM ' . FORUMS_FORUMS_TABLE . '
 		ORDER BY left_id ASC';
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -123,7 +123,7 @@
 		// This query is identical to the jumpbox one
 		$expire_time = ($no_cache) ? 0 : 120;
 		$sql = 'SELECT forum_id, parent_id, forum_name, forum_type, left_id, right_id
-			FROM ' . FORUMS_TABLE . '
+			FROM ' . FORUMS_FORUMS_TABLE . '
 			ORDER BY left_id ASC';
 		$result = $_CLASS['core_db']->query($sql, $expire_time);
 
@@ -172,8 +172,8 @@
 	$rows = array();
 
 	$sql = 'SELECT f2.*
-		FROM ' . FORUMS_TABLE . ' f1
-		LEFT JOIN ' . FORUMS_TABLE . " f2 ON $condition
+		FROM ' . FORUMS_FORUMS_TABLE . ' f1
+		LEFT JOIN ' . FORUMS_FORUMS_TABLE . " f2 ON $condition
 		WHERE f1.forum_id = $forum_id
 		ORDER BY f2.left_id " . (($order == 'descending') ? 'ASC' : 'DESC');
 	$result = $_CLASS['core_db']->query($sql);
@@ -234,7 +234,7 @@
 	$forum_ids = array($forum_id);
 	$sql_where = (is_array($topic_ids)) ? 'IN (' . implode(', ', $topic_ids) . ')' : '= ' . $topic_ids;
 
-	$sql = 'DELETE FROM ' . TOPICS_TABLE . "
+	$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . "
 		WHERE topic_moved_id $sql_where
 			AND forum_id = " . $forum_id;
 	$_CLASS['core_db']->query($sql);
@@ -242,7 +242,7 @@
 	if ($auto_sync)
 	{
 		$sql = 'SELECT DISTINCT forum_id
-			FROM ' . TOPICS_TABLE . '
+			FROM ' . FORUMS_TOPICS_TABLE . '
 			WHERE topic_id ' . $sql_where;
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -253,7 +253,7 @@
 		$_CLASS['core_db']->free_result($result);
 	}
 	
-	$table_ary = array(TOPICS_TABLE, POSTS_TABLE, LOG_TABLE);
+	$table_ary = array(FORUMS_TOPICS_TABLE, FORUMS_POSTS_TABLE, FORUMS_LOG_TABLE);
 	foreach ($table_ary as $table)
 	{
 		$sql = "UPDATE $table
@@ -285,7 +285,7 @@
 		$topic_ids = array($topic_id);
 
 		$sql = 'SELECT DISTINCT topic_id, forum_id
-			FROM ' . POSTS_TABLE . '
+			FROM ' . FORUMS_POSTS_TABLE . '
 			WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -298,7 +298,7 @@
 	}
 
 	$sql = 'SELECT forum_id 
-		FROM ' . TOPICS_TABLE . ' 
+		FROM ' . FORUMS_TOPICS_TABLE . ' 
 		WHERE topic_id = ' . $topic_id;
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -308,12 +308,12 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	$sql = 'UPDATE ' . POSTS_TABLE . '
+	$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 		SET forum_id = ' . $row['forum_id'] . ", topic_id = $topic_id
 		WHERE post_id IN (" . implode(', ', $post_ids) . ')';
 	$_CLASS['core_db']->query($sql);
 
-	$sql = 'UPDATE ' . ATTACHMENTS_TABLE . "
+	$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . "
 		SET topic_id = $topic_id
 			AND in_message = 0
 		WHERE post_msg_id IN (" . implode(', ', $post_ids) . ')';
@@ -349,7 +349,7 @@
 	);
 
 	$sql = 'SELECT topic_id, forum_id
-		FROM ' . TOPICS_TABLE . "
+		FROM ' . FORUMS_TOPICS_TABLE . "
 		WHERE $where_type " . ((!is_array($where_ids)) ? "= $where_ids" : 'IN (' . implode(', ', $where_ids) . ')');
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -371,9 +371,9 @@
 
 	$sql_where = ' IN (' . implode(', ', $topic_ids) . ')';
 
-	$_CLASS['core_db']->sql_transaction('begin');
+	$_CLASS['core_db']->transaction();
 
-	$table_ary = array(TOPICS_TRACK_TABLE, POLL_VOTES_TABLE, POLL_OPTIONS_TABLE, TOPICS_WATCH_TABLE, TOPICS_TABLE);
+	$table_ary = array(FORUMS_TRACK_TABLE, FORUMS_POLL_VOTES_TABLE, FORUMS_POLL_OPTIONS_TABLE, FORUMS_WATCH_TABLE, FORUMS_TOPICS_TABLE);
 	foreach ($table_ary as $table)
 	{
 		$sql = "DELETE FROM $table 
@@ -382,11 +382,11 @@
 	}
 	unset($table_ary);
 
-	$sql = 'DELETE FROM ' . TOPICS_TABLE . ' 
+	$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . ' 
 		WHERE topic_moved_id' . $sql_where;
 	$_CLASS['core_db']->query($sql);
 
-	$_CLASS['core_db']->sql_transaction('commit');
+	$_CLASS['core_db']->transaction('commit');
 
 	if ($auto_sync)
 	{
@@ -405,14 +405,16 @@
 	{
 		$where_ids = array_unique($where_ids);
 	}
+
 	if (empty($where_ids))
 	{
 		return false;
 	}
+
 	$post_ids = $topic_ids = $forum_ids = array();
 
 	$sql = 'SELECT post_id, topic_id, forum_id
-		FROM ' . POSTS_TABLE . "
+		FROM ' . FORUMS_POSTS_TABLE . "
 		WHERE $where_type " . ((!is_array($where_ids)) ? "= $where_ids" : 'IN (' . implode(', ', $where_ids) . ')');
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -432,8 +434,7 @@
 
 	$_CLASS['core_db']->sql_transaction('begin');
 
-	$table_ary = array(POSTS_TABLE, RATINGS_TABLE, REPORTS_TABLE, SEARCH_MATCH_TABLE);
-	//$table_ary = array(POSTS_TABLE, REPORTS_TABLE, SEARCH_MATCH_TABLE);
+	$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_REPORTS_TABLE, FORUMS_SEARCH_MATCH_TABLE);
 	
 	foreach ($table_ary as $table)
 	{
@@ -445,7 +446,7 @@
 
 	delete_attachments('post', $post_ids, false);
 
-	$_CLASS['core_db']->sql_transaction('commit');
+	$_CLASS['core_db']->transaction('commit');
 
 	if ($auto_sync)
 	{
@@ -483,7 +484,7 @@
 	if ($mode == 'attach' || $mode == 'user' || ($mode == 'topic' && $resync))
 	{
 		$sql = 'SELECT post_msg_id as post_id, topic_id, physical_filename, thumbnail, filesize
-			FROM ' . ATTACHMENTS_TABLE . '
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 			WHERE ' . $sql_id . ' IN (' . implode(', ', $ids) . ')';
 		$result = $_CLASS['core_db']->query($sql);
 			
@@ -499,7 +500,7 @@
 	if ($mode == 'post')
 	{
 		$sql = 'SELECT topic_id, physical_filename, thumbnail, filesize
-			FROM ' . ATTACHMENTS_TABLE . '
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 			WHERE post_msg_id IN (' . implode(', ', $ids) . ')
 				AND in_message = 0';
 		$result = $_CLASS['core_db']->query($sql);
@@ -513,8 +514,8 @@
 	}
 
 	// Delete attachments
-	$_CLASS['core_db']->query('DELETE FROM ' . ATTACHMENTS_TABLE . ' WHERE ' . $sql_id . ' IN (' . implode(', ', $ids) . ')');
-	$num_deleted = $_CLASS['core_db']->sql_affectedrows();
+	$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . ' WHERE ' . $sql_id . ' IN (' . implode(', ', $ids) . ')');
+	$num_deleted = $_CLASS['core_db']->affected_rows();
 
 	if (!$num_deleted)
 	{
@@ -536,6 +537,7 @@
 			phpbb_unlink($file_ary['filename'], 'thumbnail');
 		}
 	}
+
 	set_config('upload_dir_size', $config['upload_dir_size'] - $space_removed, true);
 	set_config('num_files', $config['num_files'] - $files_removed, true);
 
@@ -558,7 +560,7 @@
 	{
 		if ($mode == 'post' || $mode == 'topic')
 		{
-			$_CLASS['core_db']->query('UPDATE ' . POSTS_TABLE . ' 
+			$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . ' 
 				SET post_attachment = 0
 				WHERE post_id IN (' . implode(', ', $post_ids) . ')');
 		}
@@ -568,7 +570,7 @@
 			$remaining = array();
 
 			$sql = 'SELECT post_msg_id
-					FROM ' . ATTACHMENTS_TABLE . ' 
+					FROM ' . FORUMS_ATTACHMENTS_TABLE . ' 
 					WHERE post_msg_id IN (' . implode(', ', $post_ids) . ')
 						AND in_message = 0';
 			$result = $_CLASS['core_db']->query($sql);
@@ -582,7 +584,7 @@
 			$unset_ids = array_diff($post_ids, $remaining);
 			if (sizeof($unset_ids))
 			{
-				$_CLASS['core_db']->query('UPDATE ' . POSTS_TABLE . ' 
+				$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . ' 
 					SET post_attachment = 0
 					WHERE post_id IN (' . implode(', ', $unset_ids) . ')');
 			}
@@ -590,7 +592,7 @@
 			$remaining = array();
 
 			$sql = 'SELECT post_msg_id
-					FROM ' . ATTACHMENTS_TABLE . ' 
+					FROM ' . FORUMS_ATTACHMENTS_TABLE . ' 
 					WHERE post_msg_id IN (' . implode(', ', $post_ids) . ')
 						AND in_message = 1';
 			$result = $_CLASS['core_db']->query($sql);
@@ -604,7 +606,7 @@
 			$unset_ids = array_diff($post_ids, $remaining);
 			if (sizeof($unset_ids))
 			{
-				$_CLASS['core_db']->query('UPDATE ' . PRIVMSGS_TABLE . ' 
+				$_CLASS['core_db']->query('UPDATE ' . FORUMS_PRIVMSGS_TABLE . ' 
 					SET message_attachment = 0
 					WHERE msg_id IN (' . implode(', ', $unset_ids) . ')');
 			}
@@ -616,7 +618,7 @@
 		// Update topic indicator
 		if ($mode == 'topic')
 		{
-			$_CLASS['core_db']->query('UPDATE ' . TOPICS_TABLE . '
+			$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . '
 				SET topic_attachment = 0
 				WHERE topic_id IN (' . implode(', ', $topic_ids) . ')');
 		}
@@ -626,7 +628,7 @@
 			$remaining = array();
 
 			$sql = 'SELECT topic_id
-					FROM ' . ATTACHMENTS_TABLE . ' 
+					FROM ' . FORUMS_ATTACHMENTS_TABLE . ' 
 					WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -639,7 +641,7 @@
 			$unset_ids = array_diff($topic_ids, $remaining);
 			if (sizeof($unset_ids))
 			{
-				$_CLASS['core_db']->query('UPDATE ' . TOPICS_TABLE . ' 
+				$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . ' 
 					SET topic_attachment = 0
 					WHERE topic_id IN (' . implode(', ', $unset_ids) . ')');
 			}
@@ -658,18 +660,18 @@
 		case 'mysql4':
 		case 'mysqli':
 			$sql = 'DELETE t.*
-				FROM ' . TOPICS_TABLE . ' t, ' . TOPICS_TABLE . ' t2
+				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_TOPICS_TABLE . ' t2
 				WHERE t.topic_moved_id = t2.topic_id
-					AND t.topic_time < ' . (time() - $max_age)
+					AND t.topic_time < ' . (gmtime() - $max_age)
 				. $where;
 			$_CLASS['core_db']->query($sql);
 		break;
 	
 		default:
 			$sql = 'SELECT t.topic_id
-				FROM ' . TOPICS_TABLE . ' t, ' . TOPICS_TABLE . ' t2
+				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_TOPICS_TABLE . ' t2
 				WHERE t.topic_moved_id = t2.topic_id
-					AND t.topic_time < ' . (time() - $max_age)
+					AND t.topic_time < ' . (gmtime() - $max_age)
 				. $where;
 			$result = $_CLASS['core_db']->query($sql);
 			
@@ -681,7 +683,7 @@
 
 			if (sizeof($topic_ids))
 			{
-				$sql = 'DELETE FROM ' . TOPICS_TABLE . '
+				$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . '
 					WHERE topic_id IN (' . implode(',', $topic_ids) . ')';
 				$_CLASS['core_db']->query($sql);
 			}
@@ -777,8 +779,8 @@
 			{
 				case 'mysql4':
 				case 'mysqli':
-					$sql = 'DELETE FROM ' . TOPICS_TABLE . '
-						USING ' . TOPICS_TABLE . ' t1, ' . TOPICS_TABLE . " t2
+					$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . '
+						USING ' . FORUMS_TOPICS_TABLE . ' t1, ' . FORUMS_TOPICS_TABLE . " t2
 						WHERE t1.topic_moved_id = t2.topic_id
 							AND t1.forum_id = t2.forum_id";
 					$_CLASS['core_db']->query($sql);
@@ -786,7 +788,7 @@
 			
 				default:
 					$sql = 'SELECT t1.topic_id
-						FROM ' .TOPICS_TABLE . ' t1, ' . TOPICS_TABLE . " t2
+						FROM ' .FORUMS_TOPICS_TABLE . ' t1, ' . FORUMS_TOPICS_TABLE . " t2
 						WHERE t1.topic_moved_id = t2.topic_id
 							AND t1.forum_id = t2.forum_id";
 					$result = $_CLASS['core_db']->query($sql);
@@ -814,7 +816,7 @@
 			{
 				case 'mysql4':
 				case 'mysqli':
-					$sql = 'UPDATE ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . " p
+					$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . " p
 						SET t.topic_approved = p.post_approved
 						$where_sql_and t.topic_first_post_id = p.post_id";
 					$_CLASS['core_db']->query($sql);
@@ -822,7 +824,7 @@
 			
 				default:
 					$sql = 'SELECT t.topic_id, p.post_approved
-						FROM ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . " p
+						FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . " p
 						$where_sql_and p.post_id = t.topic_first_post_id
 							AND p.post_approved <> t.topic_approved";
 					$result = $_CLASS['core_db']->query($sql);
@@ -839,7 +841,7 @@
 						return;
 					}
 
-					$sql = 'UPDATE ' . TOPICS_TABLE . '
+					$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 						SET topic_approved = 1 - topic_approved
 						WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
 					$_CLASS['core_db']->query($sql);
@@ -850,7 +852,7 @@
 			$post_ids = $post_reported = array();
 
 			$sql = 'SELECT p.post_id, p.post_reported
-				FROM ' . POSTS_TABLE . " p
+				FROM ' . FORUMS_POSTS_TABLE . " p
 				$where_sql
 				GROUP BY p.post_id, p.post_reported";
 			$result = $_CLASS['core_db']->query($sql);
@@ -864,7 +866,7 @@
 			}
 
 			$sql = 'SELECT DISTINCT(post_id)
-				FROM ' . REPORTS_TABLE . '
+				FROM ' . FORUMS_REPORTS_TABLE . '
 				WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -890,7 +892,7 @@
 
 			if (sizeof($post_ids))
 			{
-				$sql = 'UPDATE ' . POSTS_TABLE . '
+				$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 					SET post_reported = 1 - post_reported
 					WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 				$_CLASS['core_db']->query($sql);
@@ -906,7 +908,7 @@
 			$topic_ids = $topic_reported = array();
 
 			$sql = 'SELECT DISTINCT(t.topic_id)
-				FROM ' . POSTS_TABLE . " t
+				FROM ' . FORUMS_POSTS_TABLE . " t
 				$where_sql_and t.post_reported = 1";
 			$result = $_CLASS['core_db']->query($sql);
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -915,7 +917,7 @@
 			}
 
 			$sql = 'SELECT t.topic_id, t.topic_reported
-				FROM ' . TOPICS_TABLE . " t
+				FROM ' . FORUMS_TOPICS_TABLE . " t
 				$where_sql";
 			$result = $_CLASS['core_db']->query($sql);
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -928,7 +930,7 @@
 
 			if (sizeof($topic_ids))
 			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . '
+				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 					SET topic_reported = 1 - topic_reported
 					WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
 				$_CLASS['core_db']->query($sql);
@@ -939,7 +941,7 @@
 			$post_ids = $post_attachment = array();
 
 			$sql = 'SELECT p.post_id, p.post_attachment
-				FROM ' . POSTS_TABLE . " p
+				FROM ' . FORUMS_POSTS_TABLE . " p
 				$where_sql
 				GROUP BY p.post_id, p.post_attachment";
 			$result = $_CLASS['core_db']->query($sql);
@@ -953,7 +955,7 @@
 			}
 
 			$sql = 'SELECT DISTINCT(post_msg_id)
-				FROM ' . ATTACHMENTS_TABLE . '
+				FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 				WHERE post_msg_id IN (' . implode(', ', $post_ids) . ')
 					AND in_message = 0';
 
@@ -980,7 +982,7 @@
 
 			if (sizeof($post_ids))
 			{
-				$sql = 'UPDATE ' . POSTS_TABLE . '
+				$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 					SET post_attachment = 1 - post_attachment
 					WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 				$_CLASS['core_db']->query($sql);
@@ -996,7 +998,7 @@
 			$topic_ids = $topic_attachment = array();
 
 			$sql = 'SELECT DISTINCT(t.topic_id)
-				FROM ' . POSTS_TABLE . " t
+				FROM ' . FORUMS_POSTS_TABLE . " t
 				$where_sql_and t.post_attachment = 1";
 			$result = $_CLASS['core_db']->query($sql);
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -1005,7 +1007,7 @@
 			}
 
 			$sql = 'SELECT t.topic_id, t.topic_attachment
-				FROM ' . TOPICS_TABLE . " t
+				FROM ' . FORUMS_TOPICS_TABLE . " t
 				$where_sql";
 			$result = $_CLASS['core_db']->query($sql);
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -1018,7 +1020,7 @@
 
 			if (sizeof($topic_ids))
 			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . '
+				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 					SET topic_attachment = 1 - topic_attachment
 					WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
 				$_CLASS['core_db']->query($sql);
@@ -1028,7 +1030,7 @@
 		case 'forum':
 			// 1: Get the list of all forums
 			$sql = 'SELECT f.*
-				FROM ' . FORUMS_TABLE . " f
+				FROM ' . FORUMS_FORUMS_TABLE . " f
 				$where_sql";
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -1055,7 +1057,7 @@
 
 			// 2: Get topic counts for each forum
 			$sql = 'SELECT forum_id, topic_approved, COUNT(topic_id) AS forum_topics
-				FROM ' . TOPICS_TABLE . '
+				FROM ' . FORUMS_TOPICS_TABLE . '
 				WHERE forum_id IN (' . implode(', ', $forum_ids) . ')
 				GROUP BY forum_id, topic_approved';
 			$result = $_CLASS['core_db']->query($sql);
@@ -1072,7 +1074,7 @@
 
 			// 3: Get post count and last_post_id for each forum
 			$sql = 'SELECT forum_id, COUNT(post_id) AS forum_posts, MAX(post_id) AS last_post_id
-				FROM ' . POSTS_TABLE . '
+				FROM ' . FORUMS_POSTS_TABLE . '
 				WHERE forum_id IN (' . implode(', ', $forum_ids) . ')
 					AND post_approved = 1
 				GROUP BY forum_id';
@@ -1091,7 +1093,7 @@
 			if (sizeof($post_ids))
 			{
 				$sql = 'SELECT p.post_id, p.poster_id, p.post_time, p.post_username, u.username
-					FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 					WHERE p.post_id IN (' . implode(', ', $post_ids) . ')
 						AND p.poster_id = u.user_id';
 				$result = $_CLASS['core_db']->query($sql);
@@ -1148,7 +1150,7 @@
 
 				if (sizeof($sql))
 				{
-					$sql = 'UPDATE ' . FORUMS_TABLE . '
+					$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 						SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . '
 						WHERE forum_id = ' . $forum_id;
 					$_CLASS['core_db']->query($sql);
@@ -1160,7 +1162,7 @@
 			$topic_data = $post_ids = $approved_unapproved_ids = $resync_forums = $delete_topics = $delete_posts = array();
 
 			$sql = 'SELECT t.topic_id, t.forum_id, t.topic_approved, ' . (($sync_extra) ? 't.topic_attachment, t.topic_reported, ' : '') . 't.topic_poster, t.topic_time, t.topic_replies, t.topic_replies_real, t.topic_first_post_id, t.topic_first_poster_name, t.topic_last_post_id, t.topic_last_poster_id, t.topic_last_poster_name, t.topic_last_post_time
-				FROM ' . TOPICS_TABLE . " t
+				FROM ' . FORUMS_TOPICS_TABLE . " t
 				$where_sql";
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -1187,7 +1189,7 @@
 			// Use "t" as table alias because of the $where_sql clause
          // NOTE: 't.post_approved' in the GROUP BY is causing a major slowdown.
 			$sql = 'SELECT t.topic_id, t.post_approved, COUNT(t.post_id) AS total_posts, MIN(t.post_id) AS first_post_id, MAX(t.post_id) AS last_post_id
-				FROM ' . POSTS_TABLE . " t
+				FROM ' . FORUMS_POSTS_TABLE . " t
 				$where_sql
 				GROUP BY t.topic_id"; //, t.post_approved";
 			$result = $_CLASS['core_db']->query($sql);
@@ -1257,7 +1259,7 @@
 			}
 
 			$sql = 'SELECT p.post_id, p.topic_id, p.post_approved, p.poster_id, p.post_username, p.post_time, u.username
-				FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 				WHERE p.post_id IN (' . implode(',', $post_ids) . ')
 					AND u.user_id = p.poster_id';
 			$result = $_CLASS['core_db']->query($sql);
@@ -1304,7 +1306,7 @@
 				// This routine assumes that post_reported values are correct
 				// if they are not, use sync('post_reported') first
 				$sql = 'SELECT t.topic_id, p.post_id
-					FROM ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . " p
+					FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . " p
 					$where_sql_and p.topic_id = t.topic_id
 						AND p.post_reported = 1
 					GROUP BY t.topic_id";
@@ -1689,36 +1691,37 @@
 	$args = func_get_args();
 
 	$mode			= array_shift($args);
-	$reportee_id	= ($mode == 'user') ? intval(array_shift($args)) : '';
-	$forum_id		= ($mode == 'mod') ? intval(array_shift($args)) : '';
-	$topic_id		= ($mode == 'mod') ? intval(array_shift($args)) : '';
+	$reportee_id	= ($mode == 'user') ? (int) array_shift($args) : '';
+	$forum_id		= ($mode == 'mod') ? (int) array_shift($args) : '';
+	$topic_id		= ($mode == 'mod') ? (int) array_shift($args) : '';
 	$action			= array_shift($args);
-	$data			= (!sizeof($args)) ? '' : $_CLASS['core_db']->escape(serialize($args));
+	$data			= empty($args) ? '' : $_CLASS['core_db']->escape(serialize($args));
 
 	switch ($mode)
 	{
 		case 'admin':
-			$sql = 'INSERT INTO ' . LOG_TABLE . ' (log_type, user_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_ADMIN . ', ' . $_CLASS['core_user']->data['user_id'] . ", '".$_CLASS['core_user']->ip."', " . time() . ", '$action', '$data')";
-			break;
+			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, log_ip, log_time, log_operation, log_data)
+				VALUES (' . LOG_ADMIN . ', ' . $_CLASS['core_user']->data['user_id'] . ", '".$_CLASS['core_user']->ip."', " . gmtime() . ", '$action', '$data')";
+		break;
 		
 		case 'mod':
-			$sql = 'INSERT INTO ' . LOG_TABLE . ' (log_type, user_id, forum_id, topic_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_MOD . ', ' . $_CLASS['core_user']->data['user_id'] . ", $forum_id, $topic_id, '".$_CLASS['core_user']->ip."', " . time() . ", '$action', '$data')";
-			break;
+			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, forum_id, topic_id, log_ip, log_time, log_operation, log_data)
+				VALUES (' . LOG_MOD . ', ' . $_CLASS['core_user']->data['user_id'] . ", $forum_id, $topic_id, '".$_CLASS['core_user']->ip."', " . gmtime() . ", '$action', '$data')";
+		break;
 
 		case 'user':
-			$sql = 'INSERT INTO ' . LOG_TABLE . ' (log_type, user_id, reportee_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_USERS . ', ' . $_CLASS['core_user']->data['user_id'] . ", $reportee_id, '".$_CLASS['core_user']->ip."', " . time() . ", '$action', '$data')";
-			break;
+			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, reportee_id, log_ip, log_time, log_operation, log_data)
+				VALUES (' . LOG_USERS . ', ' . $_CLASS['core_user']->data['user_id'] . ", $reportee_id, '".$_CLASS['core_user']->ip."', " . gmtime() . ", '$action', '$data')";
+		break;
 
 		case 'critical':
-			$sql = 'INSERT INTO ' . LOG_TABLE . ' (log_type, user_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_CRITICAL . ', ' . $_CLASS['core_user']->data['user_id'] . ", '".$_CLASS['core_user']->ip."', " . time() . ", '$action', '$data')";
-			break;
+			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, log_ip, log_time, log_operation, log_data)
+				VALUES (' . LOG_CRITICAL . ', ' . $_CLASS['core_user']->data['user_id'] . ", '".$_CLASS['core_user']->ip."', " . gmtime() . ", '$action', '$data')";
+		break;
 		
 		default:
 			return;
+		break;
 	}
 
 	$_CLASS['core_db']->query($sql);
@@ -1770,7 +1773,7 @@
 	}
 
 	$sql = "SELECT l.*, u.username
-		FROM " . LOG_TABLE . " l, " . USERS_TABLE . " u
+		FROM " . FORUMS_LOG_TABLE . " l, " . USERS_TABLE . " u
 		WHERE l.log_type = $log_type
 			AND u.user_id = l.user_id
 			" . (($limit_days) ? "AND l.log_time >= $limit_days" : '') . "
@@ -1829,8 +1832,8 @@
 		// This query is not really needed if move_topics() updates the forum_id field, 
 		// altough it's also used to determine if the topic still exists in the database
 		$sql = 'SELECT topic_id, forum_id
-			FROM ' . TOPICS_TABLE . '
-			WHERE topic_id IN (' . implode(', ', array_map('intval', $topic_id_list)) . ')';
+			FROM ' . FORUMS_TOPICS_TABLE . '
+			WHERE topic_id IN (' . implode(', ', $topic_id_list) . ')';
 		$result = $_CLASS['core_db']->query($sql);
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -1856,7 +1859,7 @@
 	}
 
 	$sql = 'SELECT COUNT(l.log_id) AS total_entries
-		FROM ' . LOG_TABLE . " l
+		FROM ' . FORUMS_LOG_TABLE . " l
 		WHERE l.log_type = $log_type
 			AND l.log_time >= $limit_days
 			$sql_forum";
@@ -1904,7 +1907,7 @@
 			}
 
 			$sql = 'SELECT auth_option_id, auth_option
-				FROM ' . ACL_OPTIONS_TABLE;
+				FROM ' . FORUMS_ACL_OPTIONS_TABLE;
 			$result = $_CLASS['core_db']->query($sql);
 
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -1917,7 +1920,7 @@
 			$id_field  = $ug_type . '_id';
 
 			$sql =  'SELECT o.auth_option_id, o.auth_option, a.forum_id, a.auth_setting
-						FROM ' . ACL_TABLE . ' a, ' . ACL_OPTIONS_TABLE . " o
+						FROM ' . FORUMS_ACL_TABLE . ' a, ' . FORUMS_ACL_OPTIONS_TABLE . " o
 							WHERE a.auth_option_id = o.auth_option_id $sql_forum
 							AND a.$id_field = $ug_id";
 
@@ -1964,7 +1967,7 @@
 				{
 					foreach ($update_option_ids as $setting => $option_ids)
 					{
-						$sql_ary['update'][] = 'UPDATE ' . ACL_TABLE . " 
+						$sql_ary['update'][] = 'UPDATE ' . FORUMS_ACL_TABLE . " 
 							SET auth_setting = $setting 
 							WHERE $id_field = $ug_id 
 								AND forum_id = $forum 
@@ -1974,7 +1977,7 @@
 
 				if (!empty($delete_option_ids))
 				{
-					$sql_ary['delete'][] = 'DELETE FROM '.ACL_TABLE ."
+					$sql_ary['delete'][] = 'DELETE FROM '.FORUMS_ACL_TABLE ."
 					WHERE $id_field = $ug_id
 						AND forum_id = $forum
 						AND auth_option_id IN (" . implode(', ', $delete_option_ids) . ')';
@@ -2006,7 +2009,7 @@
 							default:
 								foreach ($sql_subary as $sql)
 								{
-									$sql = 'INSERT INTO '.ACL_TABLE." ($id_field, forum_id, auth_option_id, auth_setting) VALUES ($sql)";
+									$sql = 'INSERT INTO '.FORUMS_ACL_TABLE." ($id_field, forum_id, auth_option_id, auth_setting) VALUES ($sql)";
 									$_CLASS['core_db']->query($sql);
 								}
 								$sql = '';
@@ -2015,7 +2018,7 @@
 
 						if ($sql)
 						{
-							$sql = 'INSERT INTO '.ACL_TABLE." ($id_field, forum_id, auth_option_id, auth_setting) $sql";
+							$sql = 'INSERT INTO '.FORUMS_ACL_TABLE." ($id_field, forum_id, auth_option_id, auth_setting) $sql";
 							$_CLASS['core_db']->query($sql);
 						}
 					break;
@@ -2137,7 +2140,7 @@
 							$sql .= (($sql != '') ? ', ' : '') . "('$option', " . $type_sql[$type] . ")";
 							break;
 							
-						case 'mysql4':
+						case 'mysql':
 						case 'mysqli':
 						case 'mssql':
 						case 'sqlite':

Modified: trunk/includes/forums/functions_display.php
===================================================================
--- trunk/includes/forums/functions_display.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/functions_display.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -60,7 +60,7 @@
 	}
 
 	$sql = "SELECT f.* $lastread_select 
-		FROM ". FORUMS_TABLE . " f $sql_from
+		FROM ". FORUMS_FORUMS_TABLE . " f $sql_from
 		WHERE forum_status <> ".ITEM_DELETING."
 		$sql_where
 		ORDER BY f.left_id";
@@ -328,11 +328,9 @@
 		);
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'U_MARK_FORUMS'		=> generate_link('Forums&amp;file=viewforum&amp;f=' . $root_data['forum_id'] . '&amp;mark=Forums'), 
-
 		'S_HAS_SUBFORUM'	=>	($visible_forums) ? true : false,
-
 		'L_SUBFORUM'		=>	($visible_forums == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] : $_CLASS['core_user']->lang['SUBFORUMS']
 	));
 
@@ -350,40 +348,6 @@
 	return $topic_author;
 }
 
-function topic_generate_pagination($replies, $url)
-{
-	global $config, $_CLASS;
-
-	if (($replies + 1) > $config['posts_per_page'])
-	{
-		$total_pages = ceil(($replies + 1) / $config['posts_per_page']);
-		$pagination = '';
-	
-		$times = 1;
-		for ($j = 0; $j < $replies + 1; $j += $config['posts_per_page'])
-		{
-			$pagination .= '<a href="'.generate_link($url.'&amp;start='.$j).'">'.$times.'</a>';
-			if ($times == 1 && $total_pages > 4)
-			{
-				$pagination .= ' ... ';
-				$times = $total_pages - 3;
-				$j += ($total_pages - 4) * $config['posts_per_page'];
-			}
-			else if ($times < $total_pages)
-			{
-				$pagination .= $_CLASS['core_user']->img['pagination_sep'];
-			}
-			$times++;
-		}
-	}
-	else
-	{
-		$pagination = '';
-	}
-
-	return $pagination;
-}
-
 function topic_status(&$topic_row, $replies, $mark_time, &$folder_img, &$folder_alt, &$topic_type)
 {
 	global $_CLASS, $config;

Modified: trunk/includes/forums/functions_posting.php
===================================================================
--- trunk/includes/forums/functions_posting.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/functions_posting.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -35,7 +35,7 @@
 	{
 		$sql = 'SELECT smiley_id
 			FROM ' . SMILIES_TABLE . '
-			WHERE display_on_posting = 0';
+			WHERE smiley_type = 0';
 		$result = $_CLASS['core_db']->query_limit($sql, 1, 0);
 
 		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -51,18 +51,18 @@
 
 		$sql = 'SELECT *
 			FROM ' . SMILIES_TABLE .' 
-				WHERE display_on_posting ='.(($mode == 'inline') ? '1' : '0') . '
+				WHERE smiley_type ='.(($mode == 'inline') ? '1' : '0') . '
 					ORDER BY smiley_order';
 		$result = $_CLASS['core_db']->query($sql);
 	
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$smiley[] = array(
-				'SMILEY_CODE' 	=> $row['code'],
-				'SMILEY_IMG' 	=> $row['smiley_url'],
+				'SMILEY_CODE' 	=> $row['smiley_code'],
+				'SMILEY_IMG' 	=> $row['smiley_src'],
 				'SMILEY_WIDTH'  => $row['smiley_width'],
 				'SMILEY_HEIGHT' => $row['smiley_height'],
-				'SMILEY_DESC'   => $row['emotion']
+				'SMILEY_DESC'   => $row['smiley_description']
 			);
 		}
 
@@ -74,7 +74,7 @@
 
 	if ($mode == 'inline')
 	{
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'S_SHOW_SMILEY_LINK' 	=> ($display_link) ? true : false,
 			'U_MORE_SMILIES' 		=> generate_link('Forums&amp;file=posting&amp;mode=smilies&amp;f='.$forum_id))
 		);
@@ -99,7 +99,7 @@
 	$update_sql = array();
 
 	$sql = 'SELECT MAX(p.post_id) as last_post_id
-		FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . " t
+		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . " t
 		WHERE p.topic_id = t.topic_id
 			AND p.post_approved = 1
 			AND t.topic_approved = 1
@@ -111,7 +111,7 @@
 	if ((int) $row['last_post_id'])
 	{
 		$sql = 'SELECT p.post_id, p.poster_id, p.post_time, u.username, p.post_username
-			FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 			WHERE p.poster_id = u.user_id
 				AND p.post_id = ' . $row['last_post_id'];
 		$result = $_CLASS['core_db']->query($sql);
@@ -568,7 +568,7 @@
 			$_CLASS['core_template']->assign_vars_array('topic_type', $array);
 		}
 
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'S_TOPIC_TYPE_STICKY'	=> ($_CLASS['auth']->acl_get('f_sticky', $forum_id)),
 			'S_TOPIC_TYPE_ANNOUNCE'	=> ($_CLASS['auth']->acl_get('f_announce', $forum_id)))
 		);
@@ -581,15 +581,11 @@
 {
 	global $_CLASS, $config;
 		
-	$_CLASS['core_template']->assign(array(
-		'S_SHOW_ATTACH_BOX'	=> true)
-	);
+	$_CLASS['core_template']->assign('S_SHOW_ATTACH_BOX', true);
 
 	if (sizeof($attachment_data))
 	{
-		$_CLASS['core_template']->assign(array(
-			'S_HAS_ATTACHMENTS'	=> true)
-		);
+		$_CLASS['core_template']->assign('S_HAS_ATTACHMENTS', true);
 		
 		$count = 0;
 		foreach ($attachment_data as $attach_row)
@@ -619,7 +615,7 @@
 		}
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'FILE_COMMENT'  => $filename_data['filecomment'],
 		'FILESIZE'		=> $config['max_filesize'])
 	);
@@ -682,10 +678,7 @@
 	
 	if (sizeof($draftrows))
 	{
-		$_CLASS['core_template']->assign(array(
-				'S_SHOW_DRAFTS' => true,
-				'L_FORUM'		=> $_CLASS['core_user']->lang['FORUM']
-			));
+		$_CLASS['core_template']->assign_array('S_SHOW_DRAFTS', true);
 
 		foreach ($draftrows as $draft)
 		{
@@ -740,7 +733,7 @@
 
 	// Go ahead and pull all data for this topic
 	$sql = 'SELECT u.username, u.user_id, p.post_id, p.post_username, p.post_subject, p.post_text, p.enable_smilies, p.bbcode_uid, p.bbcode_bitfield, p.post_time
-		FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . " u
+		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . " u
 		WHERE p.topic_id = $topic_id
 			AND p.poster_id = u.user_id
 			" . ((!$_CLASS['auth']->acl_get('m_approve', $forum_id)) ? 'AND p.post_approved = 1' : '') . '

Modified: trunk/includes/forums/functions_privmsgs.php
===================================================================
--- trunk/includes/forums/functions_privmsgs.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/functions_privmsgs.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -124,7 +124,7 @@
 
 	// Get folder informations
 	$sql = 'SELECT folder_id, COUNT(msg_id) as num_messages, SUM(unread) as num_unread
-		FROM ' . PRIVMSGS_TO_TABLE . "
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
 		WHERE user_id = $user_id
 			AND folder_id <> " . PRIVMSGS_NO_BOX . '
 		GROUP BY folder_id';
@@ -159,7 +159,7 @@
 
 	// Custom Folder
 	$sql = 'SELECT folder_id, folder_name, pm_count
-		FROM ' . PRIVMSGS_FOLDER_TABLE . "
+		FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
 			WHERE user_id = $user_id";
 	$result = $_CLASS['core_db']->query($sql);
 			
@@ -202,7 +202,7 @@
 	{
 		// Delete old messages
 		$sql = 'SELECT t.msg_id
-			FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p
+			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p
 			WHERE t.msg_id = p.msg_id
 				AND t.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 				AND t.folder_id = ' . PRIVMSGS_SENTBOX . '
@@ -282,7 +282,7 @@
 	if ($user_message_rules)
 	{
 		$sql = 'SELECT * 
-			FROM ' . PRIVMSGS_RULES_TABLE . "
+			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . "
 			WHERE user_id = $user_id";
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -306,7 +306,7 @@
 
 	if ($release)
 	{
-		$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . ' 
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
 			SET folder_id = ' . PRIVMSGS_NO_BOX . '
 			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . "
 				AND user_id = $user_id";
@@ -316,7 +316,7 @@
 	// Get those messages not yet placed into any box
 	// NOTE: Expand Group Information to all groups the user/author is in? 
 	$sql = 'SELECT t.*, p.*, u.username, u.group_id as author_in_group
-		FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . " u
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . " u
 		WHERE t.user_id = $user_id
 			AND p.author_id = u.user_id
 			AND t.folder_id = " . PRIVMSGS_NO_BOX . '
@@ -419,7 +419,7 @@
 	// Set messages to Unread
 	if (sizeof($unread_ids))
 	{
-		$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . ' 
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
 			SET unread = 0
 			WHERE msg_id IN (' . implode(', ', $unread_ids) . ")
 				AND user_id = $user_id
@@ -430,7 +430,7 @@
 	// mark messages as important
 	if (sizeof($important_ids))
 	{
-		$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . '
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
 			SET marked = !marked
 			WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
 				AND user_id = $user_id
@@ -447,7 +447,7 @@
 		$full_folder_action = ($_CLASS['core_user']->data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']->data['user_full_folder'];
 
 		$sql = 'SELECT folder_id, pm_count 
-			FROM ' . PRIVMSGS_FOLDER_TABLE . '
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 			WHERE folder_id IN (' . implode(', ', array_keys($move_into_folder)) . (($full_folder_action >= 0) ? ', ' . $full_folder_action : '') . ")
 				AND user_id = $user_id";
 		$result = $_CLASS['core_db']->query($sql);
@@ -461,7 +461,7 @@
 		if (in_array(PRIVMSGS_INBOX, array_keys($move_into_folder)))
 		{
 			$sql = 'SELECT folder_id, COUNT(msg_id) as num_messages
-				FROM ' . PRIVMSGS_TO_TABLE . "
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
 				WHERE user_id = $user_id
 					AND folder_id = " . PRIVMSGS_INBOX . "
 				GROUP BY folder_id";
@@ -501,7 +501,7 @@
 			{
 				// Delete some messages ;)
 				$sql = 'SELECT t.msg_id
-					FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . " p
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . " p
 					WHERE t.msg_id = p.msg_id
 						AND t.user_id = $user_id
 						AND t.folder_id = $dest_folder
@@ -521,7 +521,7 @@
 		if ($full_folder_action == FULL_FOLDER_HOLD)
 		{
 			$num_not_moved += sizeof($msg_ary);
-			$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
 				SET folder_id = ' . PRIVMSGS_HOLD_BOX . '
 				WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
 					AND user_id = $user_id
@@ -530,7 +530,7 @@
 		}
 		else
 		{
-			$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . " 
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . " 
 				SET folder_id = $dest_folder, new = 0
 				WHERE folder_id = " . PRIVMSGS_NO_BOX . "
 					AND user_id = $user_id
@@ -540,7 +540,7 @@
 
 			if ($dest_folder != PRIVMSGS_INBOX)
 			{
-				$sql = 'UPDATE ' . PRIVMSGS_FOLDER_TABLE . '
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']->sql_affectedrows() . "
 					WHERE folder_id = $dest_folder
 						AND user_id = $user_id";
@@ -557,7 +557,7 @@
 	{
 		// Move from OUTBOX to SENTBOX
 		// We are not checking any full folder status here... SENTBOX is a special treatment (old messages get deleted)
-		$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . ' 
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
 			SET folder_id = ' . PRIVMSGS_SENTBOX . '
 			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
 				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
@@ -601,7 +601,7 @@
 		if ($dest_folder != PRIVMSGS_INBOX)
 		{
 			$sql = 'SELECT folder_id, folder_name, pm_count
-				FROM ' . PRIVMSGS_FOLDER_TABLE . "
+				FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
 				WHERE folder_id = $dest_folder
 					AND user_id = $user_id";
 			$result = $_CLASS['core_db']->query($sql);
@@ -622,7 +622,7 @@
 		else
 		{
 			$sql = 'SELECT COUNT(msg_id) as num_messages
-				FROM ' . PRIVMSGS_TO_TABLE . '
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 				WHERE folder_id = ' . PRIVMSGS_INBOX . "
 					AND user_id = $user_id";
 			$result = $_CLASS['core_db']->query($sql);
@@ -634,7 +634,7 @@
 			}
 		}
 
-		$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . "
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . "
 			SET folder_id = $dest_folder
 			WHERE folder_id = $cur_folder_id
 				AND user_id = $user_id
@@ -647,7 +647,7 @@
 		{
 			if (!in_array($cur_folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
 			{
-				$sql = 'UPDATE ' . PRIVMSGS_FOLDER_TABLE . "
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
 					SET pm_count = pm_count - $num_moved
 					WHERE folder_id = $cur_folder_id
 						AND user_id = $user_id";
@@ -656,7 +656,7 @@
 
 			if ($dest_folder != PRIVMSGS_INBOX)
 			{
-				$sql = 'UPDATE ' . PRIVMSGS_FOLDER_TABLE . "
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
 					SET pm_count = pm_count + $num_moved
 					WHERE folder_id = $dest_folder
 						AND user_id = $user_id";
@@ -678,7 +678,7 @@
 
 	global $_CLASS;
 
-	$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . " 
+	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . " 
 		SET unread = 0
 		WHERE msg_id = $msg_id
 			AND user_id = $user_id
@@ -709,7 +709,7 @@
 	{
 		case 'mark_important':
 
-			$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . "
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . "
 				SET marked = !marked
 				WHERE folder_id = $cur_folder_id
 					AND user_id = $user_id
@@ -798,7 +798,7 @@
 
 	// Get PM Informations for later deleting
 	$sql = 'SELECT msg_id, unread, new
-		FROM ' . PRIVMSGS_TO_TABLE . '
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 		WHERE msg_id IN (' . implode(', ', array_map('intval', $msg_ids)) . ")
 			AND folder_id = $folder_id
 			AND user_id = $user_id";
@@ -826,19 +826,19 @@
 	if ($folder_id == PRIVMSGS_OUTBOX)
 	{
 		// Remove PM from Outbox
-		$sql = 'DELETE FROM ' . PRIVMSGS_TO_TABLE . "
+		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
 			WHERE user_id = $user_id AND folder_id = " . PRIVMSGS_OUTBOX . '
 				AND msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
 		$_CLASS['core_db']->query($sql);
 
 		// Update PM Information for safety
-		$sql = 'UPDATE ' . PRIVMSGS_TABLE . " SET message_text = ''
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . " SET message_text = ''
 			WHERE msg_id IN (" . implode(', ', array_keys($delete_rows)) . ')';
 		$_CLASS['core_db']->query($sql);
 
 		// Set delete flag for those intended to receive the PM
 		// We do not remove the message actually, to retain some basic informations (sent time for example)
-		$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . '
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
 			SET deleted = 1
 			WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
 		$_CLASS['core_db']->query($sql);
@@ -848,7 +848,7 @@
 	else
 	{
 		// Delete Private Message Informations
-		$sql = 'DELETE FROM ' . PRIVMSGS_TO_TABLE . "
+		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
 			WHERE user_id = $user_id
 				AND folder_id = $folder_id
 				AND msg_id IN (" . implode(', ', array_keys($delete_rows)) . ')';
@@ -859,7 +859,7 @@
 	// if folder id is user defined folder then decrease pm_count
 	if (!in_array($folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX, PRIVMSGS_NO_BOX)))
 	{
-		$sql = 'UPDATE ' . PRIVMSGS_FOLDER_TABLE . " 
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . " 
 			SET pm_count = pm_count - $num_deleted 
 			WHERE folder_id = $folder_id";
 		$_CLASS['core_db']->query($sql);
@@ -880,7 +880,7 @@
 	
 	// Now we have to check which messages we can delete completely	
 	$sql = 'SELECT msg_id 
-		FROM ' . PRIVMSGS_TO_TABLE . '
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 		WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -894,7 +894,7 @@
 
 	if ($delete_ids)
 	{
-		$sql = 'DELETE FROM ' . PRIVMSGS_TABLE . '
+		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TABLE . '
 			WHERE msg_id IN (' . $delete_ids . ')';
 		$_CLASS['core_db']->query($sql);
 	}
@@ -1151,7 +1151,7 @@
 			$root_level = ($data['reply_from_root_level']) ? $data['reply_from_root_level'] : $data['reply_from_msg_id']; 
 
 			// Set message_replied switch for this user
-			$sql = 'UPDATE ' . PRIVMSGS_TO_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
 				SET replied = 1
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 					AND msg_id = ' . $data['reply_from_msg_id'];
@@ -1205,12 +1205,12 @@
 	{
 		if ($mode == 'post' || $mode == 'reply' || $mode == 'quote' || $mode == 'forward')
 		{
-			$_CLASS['core_db']->query('INSERT INTO ' . PRIVMSGS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_data));
-			$data['msg_id'] = $_CLASS['core_db']->insert_id(PRIVMSGS_TABLE, 'msg_id');
+			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_data));
+			$data['msg_id'] = $_CLASS['core_db']->insert_id(FORUMS_PRIVMSGS_TABLE, 'msg_id');
 		}
 		else if ($mode == 'edit')
 		{
-			$sql = 'UPDATE ' . PRIVMSGS_TABLE . ' 
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . ' 
 				SET message_edit_count = message_edit_count + 1, ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data) . ' 
 				WHERE msg_id = ' . $data['msg_id'];
 			$_CLASS['core_db']->query($sql);
@@ -1227,7 +1227,7 @@
 
 		foreach ($recipients as $user_id => $type)
 		{
-			$_CLASS['core_db']->query('INSERT INTO ' . PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 				'msg_id'	=> $data['msg_id'],
 				'user_id'	=> $user_id,
 				'author_id'	=> $_CLASS['core_user']->data['user_id'],
@@ -1246,7 +1246,7 @@
 		// Put PM into outbox
 		if ($put_in_outbox)
 		{
-			$_CLASS['core_db']->query('INSERT INTO ' . PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 				'msg_id'	=> (int) $data['msg_id'],
 				'user_id'	=> (int) $_CLASS['core_user']->data['user_id'],
 				'author_id'	=> (int) $_CLASS['core_user']->data['user_id'],
@@ -1311,7 +1311,7 @@
 		
 		if (sizeof($data['attachment_data']))
 		{
-			$sql = 'UPDATE ' . PRIVMSGS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . '
 				SET message_attachment = 1
 				WHERE msg_id = ' . $data['msg_id'];
 			$_CLASS['core_db']->query($sql);

Modified: trunk/includes/forums/message_parser.php
===================================================================
--- trunk/includes/forums/message_parser.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/forums/message_parser.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -128,7 +128,7 @@
 			$rowset = array();
 
 			$sql = 'SELECT bbcode_id, bbcode_tag, first_pass_match, first_pass_replace
-				FROM ' . BBCODES_TABLE;
+				FROM ' . FORUMS_BBCODES_TABLE;
 
 			$result = $_CLASS['core_db']->query($sql);
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -941,25 +941,10 @@
   	    {
 			// NOTE: obtain_* function? chaching the table contents?
 			
-			// For now setting the ttl to 10 minutes
-			switch ($_CLASS['core_db']->db_layer)
-			{
-				case 'mssql':
-				case 'mssql-odbc':
-					$sql = 'SELECT * 
-						FROM ' . SMILIES_TABLE . '
-						ORDER BY LEN(code) DESC';
-					break;
-	
-				// LENGTH supported by MySQL, IBM DB2, Oracle and Access for sure...
-				default:
-					$sql = 'SELECT * 
-						FROM ' . SMILIES_TABLE . '
-						ORDER BY LENGTH(code) DESC';
-					break;
-			}
-			$result = $_CLASS['core_db']->query($sql, 600);
 
+			$sql = 'SELECT * FROM ' . SMILIES_TABLE;
+			$result = $_CLASS['core_db']->query($sql);
+
 			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$match = $replace = array();
@@ -967,8 +952,8 @@
 				do
 				{
 					// (assertion)
-					$match[] = '#(?<=^|[\n ]|\.)' . preg_quote($row['code'], '#') . '#';
-					$replace[] = '<!-- s' . $row['code'] . ' --><img src="{SMILIES_PATH}/' . $row['smiley_url'] . '" border="0" alt="' . $row['emotion'] . '" title="' . $row['emotion'] . '" /><!-- s' . $row['code'] . ' -->';
+					$match[] = '#(?<=^|[\n ]|\.)' . preg_quote($row['smiley_code'], '#') . '#';
+					$replace[] = '<!-- s' . $row['smiley_code'] . ' --><img src="{SMILIES_PATH}/' . $row['smiley_src'] . '" border="0" alt="' . $row['smiley_description'] . '" title="' . $row['smiley_description'] . '" /><!-- s' . $row['smiley_code'] . ' -->';
 				}
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 			}
@@ -1326,7 +1311,7 @@
 		if ($mode == 'edit')
 		{
 			$sql = 'SELECT w.word_id, w.word_text, m.title_match
-				FROM ' . SEARCH_WORD_TABLE . ' w, ' . SEARCH_MATCH_TABLE . " m
+				FROM ' . FORUMS_SEARCH_WORD_TABLE . ' w, ' . FORUMS_SEARCH_MATCH_TABLE . " m
 				WHERE m.post_id = $post_id 
 					AND w.word_id = m.word_id";
 			$result = $_CLASS['core_db']->query($sql);
@@ -1362,7 +1347,7 @@
 		if (sizeof($unique_add_words))
 		{
 			$sql = 'SELECT word_id, word_text
-				FROM ' . SEARCH_WORD_TABLE . '
+				FROM ' . FORUMS_SEARCH_WORD_TABLE . '
 				WHERE word_text IN (' . implode(', ', preg_replace('#^(.*)$#', '\'$1\'', $unique_add_words)) . ")";
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -1381,7 +1366,7 @@
 				switch ($_CLASS['core_db']->db_layer)
 				{
 					case 'mysql':
-						$sql = 'INSERT INTO ' . SEARCH_WORD_TABLE . ' (word_text)
+						$sql = 'INSERT INTO ' . FORUMS_SEARCH_WORD_TABLE . ' (word_text)
 							VALUES ' . implode(', ', preg_replace('#^(.*)$#', '(\'$1\')',  $new_words));
 						$_CLASS['core_db']->query($sql);
 						break;
@@ -1390,14 +1375,14 @@
 					case 'mysqli':
 					case 'mssql':
 					case 'sqlite':
-						$sql = 'INSERT INTO ' . SEARCH_WORD_TABLE . ' (word_text) ' . implode(' UNION ALL ', preg_replace('#^(.*)$#', "SELECT '\$1'",  $new_words));
+						$sql = 'INSERT INTO ' . FORUMS_SEARCH_WORD_TABLE . ' (word_text) ' . implode(' UNION ALL ', preg_replace('#^(.*)$#', "SELECT '\$1'",  $new_words));
 						$_CLASS['core_db']->query($sql);
 						break;
 
 					default:
 						foreach ($new_words as $word)
 						{
-							$sql = 'INSERT INTO ' . SEARCH_WORD_TABLE . " (word_text)
+							$sql = 'INSERT INTO ' . FORUMS_SEARCH_WORD_TABLE . " (word_text)
 								VALUES ('$word')";
 							$_CLASS['core_db']->query($sql);
 						}
@@ -1419,7 +1404,7 @@
 					$sql_in[] = $cur_words[$word_in][$word];
 				}
 
-				$sql = 'DELETE FROM ' . SEARCH_MATCH_TABLE . ' 
+				$sql = 'DELETE FROM ' . FORUMS_SEARCH_MATCH_TABLE . ' 
 					WHERE word_id IN (' . implode(', ', $sql_in) . ') 
 						AND post_id = ' . intval($post_id) . " 
 						AND title_match = $title_match";
@@ -1434,9 +1419,9 @@
 
 			if (sizeof($word_ary))
 			{
-				$sql = 'INSERT INTO ' . SEARCH_MATCH_TABLE . " (post_id, word_id, title_match) 
+				$sql = 'INSERT INTO ' . FORUMS_SEARCH_MATCH_TABLE . " (post_id, word_id, title_match) 
 					SELECT $post_id, word_id, $title_match 
-					FROM " . SEARCH_WORD_TABLE . ' 
+					FROM " . FORUMS_SEARCH_WORD_TABLE . ' 
 					WHERE word_text IN (' . implode(', ', preg_replace('#^(.*)$#', '\'$1\'', $word_ary)) . ')';
 				$_CLASS['core_db']->query($sql);
 			}
@@ -1466,7 +1451,7 @@
 
 		// Remove common (> 60% of posts ) words
 		$sql = 'SELECT SUM(forum_posts) AS total_posts 
-			FROM ' . FORUMS_TABLE;
+			FROM ' . FORUMS_FORUMS_TABLE;
 		$result = $_CLASS['core_db']->query($sql);
 
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -1475,7 +1460,7 @@
 		if ($row['total_posts'] >= 100)
 		{
 			$sql = 'SELECT word_id
-				FROM ' . SEARCH_MATCH_TABLE . '
+				FROM ' . FORUMS_SEARCH_MATCH_TABLE . '
 				GROUP BY word_id
 				HAVING COUNT(word_id) > ' . floor($row['total_posts'] * 0.6);
 			$result = $_CLASS['core_db']->query($sql);
@@ -1491,12 +1476,12 @@
 
 				$sql_in = implode(', ', $sql_in);
 
-				$sql = 'UPDATE ' . SEARCH_WORD_TABLE . "
+				$sql = 'UPDATE ' . FORUMS_SEARCH_WORD_TABLE . "
 					SET word_common = 1
 					WHERE word_id IN ($sql_in)";
 				$_CLASS['core_db']->query($sql);
 
-				$sql = 'DELETE FROM ' . SEARCH_MATCH_TABLE . "
+				$sql = 'DELETE FROM ' . FORUMS_SEARCH_MATCH_TABLE . "
 					WHERE word_id IN ($sql_in)";
 				$_CLASS['core_db']->query($sql);
 				unset($sql_in);
@@ -1506,8 +1491,8 @@
 
 		// Remove words with no matches ... this is a potentially nasty query
 		$sql = 'SELECT w.word_id
-			FROM ' . SEARCH_WORD_TABLE . ' w
-			LEFT JOIN ' . SEARCH_MATCH_TABLE . ' m ON w.word_id = m.word_id
+			FROM ' . FORUMS_SEARCH_WORD_TABLE . ' w
+			LEFT JOIN ' . FORUMS_SEARCH_MATCH_TABLE . ' m ON w.word_id = m.word_id
 				WHERE w.word_common = 0 AND m.word_id IS NULL
 			GROUP BY m.word_id';
 		$result = $_CLASS['core_db']->query($sql);
@@ -1521,7 +1506,7 @@
 			}
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 
-			$sql = 'DELETE FROM ' . SEARCH_WORD_TABLE . '
+			$sql = 'DELETE FROM ' . FORUMS_SEARCH_WORD_TABLE . '
 				WHERE word_id IN (' . implode(', ', $sql_in) . ')';
 			$_CLASS['core_db']->query($sql);
 			unset($sql_in);

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/functions.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -433,8 +433,8 @@
 			$end = min($total_pages, $current_page + 2);
 			$start = ($end > $total_pages - 2) ? $total_pages - 4 : $current_page - 2;
 
-			$display['array'][] = array('page' => 1, 'link' => generate_link($base_url, $admin_link), 'seperator' => 'after');
-			$display['formated'] = sprintf($wrapper['first'], generate_link($base_url, $admin_link), 1);
+			$display['array'][] = array('page' => 1, 'link' => generate_link($base_url, array('admin' => $admin_link)), 'seperator' => 'after');
+			$display['formated'] = sprintf($wrapper['first'], generate_link($base_url, array('admin' => $admin_link)), 1);
 		}
 	}
 	else
@@ -448,13 +448,13 @@
 		$display['array'][] = array('page' => $i, 'link' => generate_link($base_url.'&amp;start='.(($i - 1) * $per_page)), 'seperator' => false);
 		
 		$this_wrapper = ($current_page == $i) ? $wrapper['current'] : $wrapper['normal'];
-		$display['formated'] .= sprintf($this_wrapper, generate_link($base_url.'&amp;start='.(($i - 1) * $per_page)), $i);
+		$display['formated'] .= sprintf($this_wrapper, generate_link($base_url.'&amp;start='.(($i - 1) * $per_page), array('admin' => $admin_link)), $i);
 	}
 
 	if ($end != $total_pages)
 	{
-		$display['array'][] = array('page' => $total_pages, 'link' => generate_link($base_url.'&amp;start='.(($total_pages - 1) * $per_page), $admin_link), 'seperator' => 'before');
-		$display['formated'] .= sprintf($wrapper['last'], generate_link($base_url.'&amp;start='.(($total_pages - 1)  * $per_page), $admin_link), $total_pages);
+		$display['array'][] = array('page' => $total_pages, 'link' => generate_link($base_url.'&amp;start='.(($total_pages - 1) * $per_page), array('admin' => $admin_link)), 'seperator' => 'before');
+		$display['formated'] .= sprintf($wrapper['last'], generate_link($base_url.'&amp;start='.(($total_pages - 1)  * $per_page), array('admin' => $admin_link)), $total_pages);
 	}
 
 	return $display;
@@ -514,8 +514,9 @@
 	$sql = 'UPDATE ' . CORE_CONFIG_TABLE . " SET config_value = '".$_CLASS['core_db']->escape($value) . "'
 		WHERE config_section = '" . $_CLASS['core_db']->escape($section) . "'
 			AND config_name = '". $_CLASS['core_db']->escape($name) ."'";
+	$result = $_CLASS['core_db']->query($sql);
 
-	if ($auto_add && (!$_CLASS['core_db']->query($sql) || !$_CLASS['core_db']->affected_rows()))
+	if ($auto_add && (!$result || !$_CLASS['core_db']->affected_rows()))
 	{
 		$sql_array = array(
 			'config_section'=> (string) $section,

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/functions_user.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -21,63 +21,74 @@
 $Id$
 */
 
-function user_get_id($username, &$difference)
+function check_user_id(&$user_id, $bypass = false)
 {
-	global $_CLASS;
+	// should we just return false, if this array map is different from the one sent
 
-	$difference = array();
+	$user_id = array_map('intval', $user_id);
+	$user_id = array_unique($user_id);
 
-	$username = is_array($username) ? $username : array($username);
+	// array map should make 0 values for notint values
+	if (($key = array_search(0, $user_id)) === false)
+	{
+		unset($user_id[$key]);
+	}
 
-	$data = array('user_id' => array(), 'username' => array());
+// make bypass an array maybe, along with protected id. would be better if you want to extend this
+	if ($bypass)
+	{
+		// You shouldn'y do anything to guest
+		if (($key = array_search(1, $user_id)) === false)
+		{
+			unset($user_id[$key]);
+		}
+	
+		// First admin is always specail
+		if (($key = array_search(2, $user_id)) === false)
+		{
+			unset($user_id[$key]);
+		}
+	}
 
-	$sql = 'SELECT user_id, username
-				FROM ' . USERS_TABLE . " 
-				WHERE username IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array($username)) . "')";
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	if (empty($user_id))
 	{
-		$data['user_id'][] = $row['user_id'];
-		$data['username'][] = $row['username'];
+		return false;
 	}
-	$_CLASS['core_db']->free_result($result);
-
-	$difference = array_diff($username, $data['username']);
-
-	return $data['user_id'];
+	
+	return $user_id;
 }
 
-function user_get_name($user_id, &$difference)
+function user_add($data)
 {
-	global $_CLASS;
+	global $_CLASS, $_CORE_CONFIG;
 
-	$difference = array();
+	$default_data = array(
+		'user_allow_viewonline' => 1,
+		'user_allow_viewemail' => 1,
+		'user_allow_massemail' => 1,
+		'user_new_privmsg' => 0,
+		'user_allow_pm' => 1,
+		'user_allow_email' => 1,
+	);
 
-	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+	$data = array_merge($default_data, $data);
 
-	if (empty($user_id))
-	{
-		return;
-	}
+// add a required array here, then find feilds that are not in the data array
+	$_CLASS['core_db']->transaction();
 
-	$data = array('user_id' => array(), 'username' => array());
+	$sql = 'INSERT INTO ' . USERS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data);
+	$_CLASS['core_db']->query($sql);
 
-	$sql = 'SELECT user_id, username
-				FROM ' . USERS_TABLE . ' 
-				WHERE user_id IN (' . implode(', ', $user_id) . ')';
-	$result = $_CLASS['core_db']->query($sql);
+	$user_id = $_CLASS['core_db']->insert_id(USERS_TABLE, 'user_id');
+				
+	$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+		'group_id'		=> (int) $data['user_group'],
+		'member_user_id'=> (int) $user_id,
+		'member_status'	=> $data['user_status']
+	);
+	$_CLASS['core_db']->query($sql);
 
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$data['user_id'][] = $row['user_id'];
-		$data['username'][] = $row['username'];
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$difference = array_diff($user_id, $data['user_id']);
-
-	return $data['username'];
+	$_CLASS['core_db']->transaction('commit');
 }
 
 function user_activate($user_id)
@@ -97,27 +108,51 @@
 			AND user_type <>' . USER_GUEST;
 
 	$_CLASS['core_db']->query($sql);
+
+	$sql = 'UPDATE ' . USER_GROUP_TABLE . '
+		SET member_status = ' . STATUS_ACTIVE . '
+			WHERE user_id  IN (' . implode(', ', $user_id) . ')';
+			//AND group_id =' .; get default group/s then add update, also update all group where the status is disabled
+
+	$_CLASS['core_db']->query($sql);
 	
 	set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + count($user_id));
 }
 
+function user_activate_reminder($user_id)
+{
+
+}
+
 function user_disable($user_id)
 {
 	global $_CLASS, $_CORE_CONFIG;
 
-	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
-	if (empty($user_id))
+	if (check_user_id($user_id) == false)
 	{
 		return;
 	}
+
 // hook here -- maybe ?
+
+	// disabled the user first
 	$sql = 'UPDATE ' . USERS_TABLE . '
 		SET user_status = ' . STATUS_DISABLED . '
 			WHERE user_id  IN (' . implode(', ', $user_id) . ')
 			AND user_type <>' . USER_GUEST;
 	$_CLASS['core_db']->query($sql);
 
+	// Now we disable the user in his active groups
+	//	( note disable is not uses for group removal, the entry is just deleted )
+// should also remove all pending groups
+	$sql = 'UPDATE ' . USER_GROUP_TABLE . '
+		SET member_status = ' . STATUS_DISABLED . '
+			WHERE user_id  IN (' . implode(', ', $user_id) . ')
+			AND member_status = ' . STATUS_ACTIVE;
+	$_CLASS['core_db']->query($sql);
+
 	if (in_array($_CORE_CONFIG['user']['newest_user_id'], $user_id))
 	{
 		$sql = 'SELECT user_id, username FROM ' . USERS_TABLE . '
@@ -137,29 +172,17 @@
 	$_CLASS['core_cache']->destroy('core_config');
 }
 
-function user_activate_reminder($user_id)
+function user_delete($user_id, $quick = false)
 {
 	global $_CLASS;
 
-	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
-	if (empty($user_id))
+	if (check_user_id($user_id) == false)
 	{
 		return;
 	}
-// hook here -- maybe ?
-	$sql = 'UPDATE ' . USERS_TABLE . '
-		SET user_status = ' . STATUS_ACTIVE . '
-			WHERE user_id  IN (' . implode(', ', $user_id) . ')
-			AND user_type =' . USER_NORMAL;
-
-	$_CLASS['core_db']->query($sql);
-}
 
-function user_delete($user_id, $quick = false)
-{
-	global $_CLASS;
-
 	if ($quick)
 	{
 		$sql = "DELETE FROM USERS_TABLE
@@ -168,18 +191,12 @@
 		
 		return;
 	}
-	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
 
 // Maybe we should make this a cron
 // and just set the user type to deleted or something
 	set_time_limit(0);
 	ignore_user_abort(true);
 
-	if (empty($user_id))
-	{
-		return;
-	}
-
 	// We disable users first to make sure things go right
 	user_disable($user_id);
 
@@ -237,6 +254,65 @@
 	$_CLASS['core_db']->optimize_tables($optimize_array);
 }
 
+function user_get_id($username, &$difference)
+{
+	global $_CLASS;
+
+	$difference = array();
+
+	$username = is_array($username) ? $username : array($username);
+
+	$data = array('user_id' => array(), 'username' => array());
+
+	$sql = 'SELECT user_id, username
+				FROM ' . USERS_TABLE . " 
+				WHERE username IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array($username)) . "')";
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$data['user_id'][] = $row['user_id'];
+		$data['username'][] = $row['username'];
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	$difference = array_diff($username, $data['username']);
+
+	return $data['user_id'];
+}
+
+function user_get_name($user_id, &$difference)
+{
+	global $_CLASS;
+
+	$difference = array();
+
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+
+	if (empty($user_id))
+	{
+		return;
+	}
+
+	$data = array('user_id' => array(), 'username' => array());
+
+	$sql = 'SELECT user_id, username
+				FROM ' . USERS_TABLE . ' 
+				WHERE user_id IN (' . implode(', ', $user_id) . ')';
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$data['user_id'][] = $row['user_id'];
+		$data['username'][] = $row['username'];
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	$difference = array_diff($user_id, $data['user_id']);
+
+	return $data['username'];
+}
+
 function groups_user_remove($group_id, $user_id)
 {
 	global $_CLASS;
@@ -245,13 +321,17 @@
 	$user_ids = is_array($user_id) ? $user_id : array($user_id);
 
 	$group_id = array_map('intval', $group_id);
-	$user_id = array_map('intval', $user_id);
 
-	if (empty($group_id) || empty($user_id))
+	if (check_user_id($user_id) == false)
 	{
 		return;
 	}
 
+	if (empty($group_id))
+	{
+		return;
+	}
+
 	$sql = 'SELECT user_id FROM ' . USERS_TABLE . ' 
 				WHERE group_id IN (' . implode(', ', $group_id) . ')
 				AND user_id IN (' . implode(', ', $user_id) . ')';
@@ -341,4 +421,42 @@
 	$result = $_CLASS['core_db']->query($sql);
 }
 
+function validate_username($username)
+{
+	global $_CORE_CONFIG, $_CLASS;
+
+	$username = strtolower($username);
+
+	if (strtolower($_CLASS['core_user']->data['username']) == $username)
+	{
+		return 'USERNAME_TAKEN';
+	}
+
+	$length = mb_strlen($username);
+
+	if ($length > $_CORE_CONFIG['user']['max_name_chars'] || $length < $_CORE_CONFIG['user']['min_name_chars'])
+	{
+		return 'INVALID_LENGHT';
+	}
+
+	if (!preg_match('#^' . $_CORE_CONFIG['user']['allow_name_chars'] . '$#i', $username))
+	{
+		return 'INVALID_CHARS';
+	}
+
+	$sql = 'SELECT COUNT(*) as count
+		FROM ' . USERS_TABLE . "
+		WHERE LOWER(username) = '" . $_CLASS['core_db']->escape($username) . "'";
+	$result = $_CLASS['core_db']->query($sql);
+	list($count) = $_CLASS['core_db']->fetch_row_num($result);
+	$_CLASS['core_db']->free_result($result);
+
+	if ($count)
+	{
+		return 'USERNAME_TAKEN';
+	}
+	
+	return true;
+}
+
 ?>
\ No newline at end of file

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/session.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -175,7 +175,7 @@
 			'session_start'		=> (int) $this->time,
 			'session_time'		=> (int) $this->time,
 			'session_browser'	=> (string) $this->browser,
-			'session_page'		=> (string) $this->page,
+			'session_page'		=> (string) $this->page, // need to be added back
 			'session_url'		=> (string) $this->url,
 			'session_ip'		=> (string) $this->ip,
 			'session_user_type'	=> (int) $this->data['user_type'],
@@ -221,73 +221,124 @@
 
 		$data_array = array(
 			'user_id'				=> (int) $this->data['user_id'],
-			'auto_login_browser'	=> (string) $this->browser,
-			'auto_login_code'		=> $code,
-			'auto_login_time'		=> (int) $this->time,
+			'auto_login_code'		=> (string) $code,
+			'auto_login_browser'	=> $this->browser,
+			'auto_login_time'		=> $this->time,
 		);
 		
 		$_CLASS['core_db']->query('INSERT INTO ' . SESSIONS_AUTOLOGIN_TABLE . ' '.	$_CLASS['core_db']->sql_build_array('INSERT', $data_array));
 	
-		$this->set_cookie('ali', $this->data['user_id'], $this->time + 31536000);
-		$this->set_cookie('alc', $code, $this->time + 31536000);
+		$this->set_cookie('ali', $this->data['user_id'], $this->time + 2592000);
+		$this->set_cookie('alc', $code, $this->time + 2592000);
 	}
 
 	function autologin_retrieve($user_id, $code)
 	{
 		global $_CLASS;
-		
-		$sql = 'SELECT *
-			FROM ' . SESSIONS_AUTOLOGIN_TABLE . " 
-			WHERE user_id = $user_id
-			AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
-				
+
+		settype($user_id, 'int');
+
+		$sql = 'SELECT * FROM ' . SESSIONS_AUTOLOGIN_TABLE . " 
+					WHERE user_id = $user_id
+					AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
+
 		$result = $_CLASS['core_db']->query($sql);
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
-		// This is about all you can validate other than the code, and user_id
-		return ($row && $row['auto_login_browser'] == $this->browser) ? $user_id : false;
+		$return = false;
+
+		// This is about all we can validate other than the code, and user_id
+		if ($row && $row['auto_login_browser'] == $this->browser)
+		{
+			$return = $user_id;
+			
+			$new_code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
+
+			$data_array = array(
+				'auto_login_code'		=> (string) $new_code,
+				'auto_login_time'		=> (int) $this->time,
+			);
+		
+			$sql = 'UPDATE ' . SESSIONS_AUTOLOGIN_TABLE . '	SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data_array) . "
+						WHERE user_id = $user_id
+						AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
+			$_CLASS['core_db']->sql_query($sql);
+
+			// need to update both the code and the user_id,
+			// since user_id cookie has an expiry time
+			$this->set_cookie('alc', $new_code, $this->time + 2592000);
+			$this->set_cookie('ali', $user_id, $this->time + 2592000);
+		}
+
+		return $return;
 	}
 
-	function session_destroy($session_id = false, $remove_cookie = true)
+	function autologin_destroy($user_id, $code)
 	{
 		global $_CLASS;
+		
+		$sql = 'DELETE FROM ' . SESSIONS_AUTOLOGIN_TABLE . " 
+			WHERE user_id = $user_id
+			AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
+				
+		$_CLASS['core_db']->query($sql);
+	}
 
+	function session_destroy($session_id = false, $logout = true)
+	{
+		global $_CLASS;
+
 		if (!$session_id)
 		{
 			$session_id = $this->data['session_id'];
 			
-			if ($remove_cookie)
-			{
-				$this->set_cookie('sid', '', $this->time - 31536000);
-			}
+			$this->set_cookie('sid', '', $this->time - 31536000);
+		}
 
-			if ($this->data['session_time'])
-			{
-				$sql = 'UPDATE ' . USERS_TABLE . '
-					SET user_last_visit = ' . $this->data['session_time'] . '
-					WHERE user_id = ' . $this->data['user_id'];
-				$_CLASS['core_db']->query($sql);
-			}
+		if ($logout)
+		{
+			
 		}
-		
+
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . "
 			WHERE session_id = '" . $_CLASS['core_db']->escape($session_id)."'";
 
 		$_CLASS['core_db']->query($sql);
+
+		$_CLASS['core_db']->optimize_tables(SESSIONS_TABLE);
 	}
 
 	function gc($time)
 	{
 // Add auto login cleaning
-// Move to cron
+// Move to cron		
+
 		global $_CORE_CONFIG, $_CLASS;
 
+/*
+		// keep the next query less demanding
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
-			WHERE session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
+			WHERE session_user_id = ' . ANONYMOUS . '
+			AND session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
+		$_CLASS['core_db']->query($sql);
+*/
 
-		$result = $_CLASS['core_db']->query($sql);
+		$sql = 'UPDATE ' . USERS_TABLE. ' u, ' . SESSIONS_TABLE . ' s
+					SET u.user_last_visit = s.session_time
+					WHERE s.session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']) . '
+						AND s.session_user_id <> ' . ANONYMOUS .'
+						AND u.user_id = s.session_user_id';
+		$_CLASS['core_db']->sql_query($sql);
 
+		$sql = 'DELETE FROM ' . SESSIONS_AUTOLOGIN_TABLE . '
+					WHERE auto_login_time < ' . ($time - 2592000);
+		$_CLASS['core_db']->query($sql);
+
+		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
+					WHERE session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
+		$_CLASS['core_db']->query($sql);
+		
 		$_CLASS['core_db']->optimize_tables(SESSIONS_TABLE);
 	}
 

Modified: trunk/includes/system.php
===================================================================
--- trunk/includes/system.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/system.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 function confirmation_image($code = false, $size = false)

Modified: trunk/includes/templates/admin/blocks/edit.html
===================================================================
--- trunk/includes/templates/admin/blocks/edit.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/blocks/edit.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,11 +1,12 @@
 <!-- DISPLAY_HEADER -->
 
-<style type="text/css">@import url(java/jscalendar/skins/aqua/theme.css);</style>
-<script type="text/javascript" src="java/jscalendar/calendar_stripped.js"></script>
-<script type="text/javascript" src="java/jscalendar/lang/calendar-en.js"></script>
-<script type="text/javascript" src="java/jscalendar/calendar-setup.js"></script>
+<style type="text/css">@import url(javascript/jscalendar/skins/aqua/theme.css);</style>
+<script type="text/javascript" src="javascript/jscalendar/calendar.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/calendar-setup.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/lang/calendar-en.js"></script>
 
 { $A_TABLE_OPEN }
+
 <form action="{ $B_ACTION }" method="post">
 	<table class="tablebg" align="center" border="0" cellpadding="4" cellspacing="1" width="100%">
 		<tbody>
@@ -32,8 +33,7 @@
 				<td class="row1"><b class="genmed">{ $L_STARTS }: </b></td>
 				<td class="row2" >
 					<input class="post" id="b_time" name="b_time" size="35" maxlength="100" value="{ $B_STARTS }" type="text" />
-					<img src="java/jscalendar/calendar.png" style="cursor: pointer;" id="time_trigger" />
-					<!-- IF { $B_STARTS } -->   Currently Set:  { $B_STARTS }<!-- ENDIF -->
+					<img src="images/calender_small.png" style="cursor: pointer;" id="time_trigger" />
 				</td>
 				<td class="row1" align="center" rowspan="2"><b class="genmed">Current Server Time:</b><br/>{ $B_CURRENT_TIME } </td>
 			</tr>
@@ -41,8 +41,7 @@
 				<td class="row1"><b class="genmed">{ $L_EXPIRES }: </b></td>
 				<td class="row2">
 					<input class="post" id="b_expires" name="b_expires" size="35" maxlength="100" value="{ $B_EXPIRES }" type="text" />
-					<img src="java/jscalendar/calendar.png" style="cursor: pointer;"  id="expires_trigger" />
-					<!-- IF { $B_EXPIRES } -->    Currently Set:  { $B_EXPIRES }<!-- ENDIF -->
+					<img src="images/calender_small.png" style="cursor: pointer;"  id="expires_trigger" />
 				</td>
 			</tr>
 			<!-- IF { $B_POSITION } -->

Modified: trunk/includes/templates/admin/blocks/index.html
===================================================================
--- trunk/includes/templates/admin/blocks/index.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/blocks/index.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,12 +1,13 @@
 <!-- DISPLAY_HEADER -->
 
 { $A_TABLE_OPEN }
+
 <table border="0" class="tablebg" cellpadding="4" cellspacing="1" width="100%">
 	<tbody>
 		<tr>
-			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_FILE }'"><a href="{ $N_BLOCK_FILE }">{ $L_BLOCK_REGULAR }</a></td>
-			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_FEED }'"><a href="{ $N_BLOCK_FEED }">{ $L_BLOCK_FEED }</a></td>
-			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_HTML }'"><a href="{ $N_BLOCK_HTML }">{ $L_BLOCK_HTML }</a></td>
+			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_FILE }'; return false;"><a href="{ $N_BLOCK_FILE }">{ $L_BLOCK_REGULAR }</a></td>
+			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_FEED }'; return false;"><a href="{ $N_BLOCK_FEED }">{ $L_BLOCK_FEED }</a></td>
+			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_HTML }'; return false;"><a href="{ $N_BLOCK_HTML }">{ $L_BLOCK_HTML }</a></td>
 		</tr>
 	</tbody>
 </table>
@@ -14,11 +15,11 @@
 <table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
     <tbody>
 		<tr>
-			<th width="25%" align="center">{ $L_TITLE }</b></th>
-			<th colspan="2">{ $L_WEIGHT }</th>
-			<th>{ $L_TYPE }</td>
-			<th>{ $L_ACTIVE }</th>
-			<th colspan="2">{ $L_OPTIONS }</th>
+			<th align="center" width="25%">{ $L_TITLE }</b></th>
+			<th align="center" colspan="2">{ $L_ORDER }</th>
+			<th align="center">{ $L_TYPE }</td>
+			<th align="center">{ $L_ACTIVE }</th>
+			<th align="center" colspan="2">{ $L_OPTIONS }</th>
 		</tr>
 		<!-- IF isset({ $left_admin_blocks }) -->
     	<tr>
@@ -30,24 +31,24 @@
 		<!-- ENDIF -->
 		<!-- LOOP $left_admin_blocks -->
 		<tr>
-			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $left_admin_blocks:EDIT_LINK }'">
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $left_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $left_admin_blocks:EDIT_LINK }">{ $left_admin_blocks:TITLE }</a>
 				<!-- IF { $left_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $left_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
-				<!-- IF { $left_admin_blocks:WEIGHT_UP } -->
-				<a href="{ $left_admin_blocks:WEIGHT_MOVE_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
-				<a href="{ $left_admin_blocks:WEIGHT_MOVE_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- IF { $left_admin_blocks:ORDER_UP } -->
+				<a href="{ $left_admin_blocks:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $left_admin_blocks:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row1" align="center">
-				<!-- IF { $left_admin_blocks:WEIGHT_DOWN } -->
-				<a href="{ $left_admin_blocks:WEIGHT_MOVE_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
-				<a href="{ $left_admin_blocks:WEIGHT_MOVE_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- IF { $left_admin_blocks:ORDER_DOWN } -->
+				<a href="{ $left_admin_blocks:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $left_admin_blocks:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row2" align="center">{ $left_admin_blocks:TYPE }</td>
-			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $left_admin_blocks:ACTIVE_LINK }'">
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $left_admin_blocks:ACTIVE_LINK }'; return false;">
 				<a href="{ $left_admin_blocks:ACTIVE_LINK }">{ $left_admin_blocks:CHANGE }</a>
 			</td>
 			<td class="row1" align="center">
@@ -73,24 +74,24 @@
 		<!-- ENDIF -->
 		<!-- LOOP $centertop_admin_blocks -->
 		<tr>
-			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centertop_admin_blocks:EDIT_LINK }'">
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centertop_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $centertop_admin_blocks:EDIT_LINK }">{ $centertop_admin_blocks:TITLE }</a>
 				<!-- IF { $centertop_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $centertop_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
-				<!-- IF { $centertop_admin_blocks:WEIGHT_UP } -->
-				<a href="{ $centertop_admin_blocks:WEIGHT_MOVE_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
-				<a href="{ $centertop_admin_blocks:WEIGHT_MOVE_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- IF { $centertop_admin_blocks:ORDER_UP } -->
+				<a href="{ $centertop_admin_blocks:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $centertop_admin_blocks:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row1" align="center">
-				<!-- IF { $centertop_admin_blocks:WEIGHT_DOWN } -->
-				<a href="{ $centertop_admin_blocks:WEIGHT_MOVE_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
-				<a href="{ $centertop_admin_blocks:WEIGHT_MOVE_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- IF { $centertop_admin_blocks:ORDER_DOWN } -->
+				<a href="{ $centertop_admin_blocks:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $centertop_admin_blocks:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row2" align="center">{ $centertop_admin_blocks:TYPE }</td>
-			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centertop_admin_blocks:ACTIVE_LINK }'">
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centertop_admin_blocks:ACTIVE_LINK }'; return false;">
 				<a href="{ $centertop_admin_blocks:ACTIVE_LINK }">{ $centertop_admin_blocks:CHANGE }</a>
 			</td>
 			
@@ -117,24 +118,24 @@
 		<!-- ENDIF -->
 		<!-- LOOP $centerbottom_admin_blocks -->
 		<tr>
-			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centerbottom_admin_blocks:EDIT_LINK }'">
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centerbottom_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $centerbottom_admin_blocks:EDIT_LINK }">{ $centerbottom_admin_blocks:TITLE }</a>
 				<!-- IF { $centerbottom_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $centerbottom_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
-				<!-- IF { $centerbottom_admin_blocks:WEIGHT_UP } -->
-				<a href="{ $centerbottom_admin_blocks:WEIGHT_MOVE_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
-				<a href="{ $centerbottom_admin_blocks:WEIGHT_MOVE_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- IF { $centerbottom_admin_blocks:ORDER_UP } -->
+				<a href="{ $centerbottom_admin_blocks:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $centerbottom_admin_blocks:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row1" align="center">
-				<!-- IF { $centerbottom_admin_blocks:WEIGHT_DOWN } -->
-				<a href="{ $centerbottom_admin_blocks:WEIGHT_MOVE_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
-				<a href="{ $centerbottom_admin_blocks:WEIGHT_MOVE_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- IF { $centerbottom_admin_blocks:ORDER_DOWN } -->
+				<a href="{ $centerbottom_admin_blocks:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $centerbottom_admin_blocks:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row2" align="center">{ $centerbottom_admin_blocks:TYPE }</td>
-			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centerbottom_admin_blocks:ACTIVE_LINK }'">
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centerbottom_admin_blocks:ACTIVE_LINK }'; return false;">
 				<a href="{ $centerbottom_admin_blocks:ACTIVE_LINK }">{ $right_admin_blocks:CHANGE }</a>
 			</td>
 			<td class="row1" align="center">
@@ -159,24 +160,24 @@
 		<!-- ENDIF -->
 		<!-- LOOP $right_admin_blocks -->
 		<tr>
-			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $right_admin_blocks:EDIT_LINK }'">
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $right_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $right_admin_blocks:EDIT_LINK }">{ $right_admin_blocks:TITLE }</a>
 				<!-- IF { $right_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $right_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
-				<!-- IF { $right_admin_blocks:WEIGHT_UP } -->
-				<a href="{ $right_admin_blocks:WEIGHT_MOVE_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
-				<a href="{ $right_admin_blocks:WEIGHT_MOVE_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- IF { $right_admin_blocks:ORDER_UP } -->
+				<a href="{ $right_admin_blocks:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $right_admin_blocks:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row1" align="center">
-				<!-- IF { $right_admin_blocks:WEIGHT_DOWN } -->
-				<a href="{ $right_admin_blocks:WEIGHT_MOVE_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
-				<a href="{ $right_admin_blocks:WEIGHT_MOVE_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- IF { $right_admin_blocks:ORDER_DOWN } -->
+				<a href="{ $right_admin_blocks:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $right_admin_blocks:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row2" align="center">{ $right_admin_blocks:TYPE }</td>
-			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $right_admin_blocks:ACTIVE_LINK }'">
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $right_admin_blocks:ACTIVE_LINK }'; return false;">
 				<a href="{ $right_admin_blocks:ACTIVE_LINK }">{ $right_admin_blocks:CHANGE }</a>
 			</td>
 			<td class="row1" align="center">
@@ -199,9 +200,9 @@
 <table border="0" class="tablebg" cellpadding="4" cellspacing="1" width="100%">
 	<tbody>
 		<tr>
-			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_FILE }'"><a href="{ $N_BLOCK_FILE }">{ $L_BLOCK_REGULAR }</a></td>
-			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_FEED }'"><a href="{ $N_BLOCK_FEED }">{ $L_BLOCK_FEED }</a></td>
-			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_HTML }'"><a href="{ $N_BLOCK_HTML }">{ $L_BLOCK_HTML }</a></td>
+			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_FILE }'; return false;"><a href="{ $N_BLOCK_FILE }">{ $L_BLOCK_REGULAR }</a></td>
+			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_FEED }'; return false;"><a href="{ $N_BLOCK_FEED }">{ $L_BLOCK_FEED }</a></td>
+			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $N_BLOCK_HTML }'; return false;"><a href="{ $N_BLOCK_HTML }">{ $L_BLOCK_HTML }</a></td>
 		</tr>
 	</tbody>
 </table>

Modified: trunk/includes/templates/admin/index.html
===================================================================
--- trunk/includes/templates/admin/index.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/index.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,3 +1,5 @@
+<!-- DISPLAY_HEADER -->
+
 { $A_TABLE_OPEN }
 
 <table border="0" cellpadding="4" cellspacing="1" width="100%">
@@ -126,70 +128,94 @@
     </tbody>
 </table>
 <br/>
-<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+<table class="tablebg" border="0" cellspacing="1" width="100%">
     <tbody>
 		<tr>
-			<th colspan="3" align="center"><b>Inactive Users</b></th>
+			<th colspan="6" align="center">{ $L_INACTIVE_USERS }</th>
 		</tr>
 		<tr>
-			<td colspan="3" class="row2"></td>
+			<td colspan="6" class="row2"></td>
 		</tr>
 		<tr>
-			<th width="20%" height="25" nowrap="nowrap">Username</th>
-			<th width="45%">Options</th>
-			<th width="5%" nowrap="nowrap">Options</th>
+			<th width="20px"></th>
+			<th>{ $L_USERNAME }</th>
+			<th>{ $L_REGISTED }</th>
+			<th colspan="3" >{ $L_OPTIONS }</th>
 		</tr>
 		<tr>
-			<td colspan="3" class="row2">{ $L_DISABLED_USERS }</td>
+			<td colspan="6" class="row2">{ $L_UNACTIVATED_USERS }</td>
 		</tr>
-		<!-- LOOP $users_disabled -->
+		<!-- LOOP $users_unactivated -->
 		<tr>
-			<td class="row1">
-				<a href="{ $users_disabled:link_profile }">{ $users_disabled:user_name }</a>
+			<td height="25" class="row1">
+				<input name="mark_id[]" value="{ $users_unactivated:user_id }" type="checkbox">
 			</td>
-			<td class="row1">
-				{ $users_disabled:user_name }
+			<td height="25" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_unactivated:link_profile }'; return false;">
+				<a href="{ $users_unactivated:link_profile }">{ $users_unactivated:user_name }</a>
 			</td>
-			<td class="row1">
-				{ $users_disabled:user_name }
+			<td width="150" class="row1" align="center">
+				{ $users_unactivated:registered }
 			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_unactivated:link_activate }'; return false;">
+				<a href="{ $users_unactivated:link_activate }">{ $L_ACTIVATE }</a>
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_unactivated:link_remove }'; return false;">
+				<a href="{ $users_unactivated:link_remove }">{ $L_REMOVE }</a>
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_unactivated:link_remind }'; return false;">
+				<a href="{ $users_unactivated:link_remind }">{ $L_REMIND }</a> 
+			</td>
 		</tr>
 		<tr>
-			<td class="spacer" colspan="3" height="7"></td>
+			<td class="spacer" colspan="6" height="7"></td>
 		</tr>
 		<!-- LOOPELSE -->
 		<tr>
-			<td colspan="3" align="center" class="row1">
-				{ $L_NO_DISABLED_USERS }
+			<td colspan="6" align="center" class="row1">
+				{ $L_NO_UNACTIVATED_USERS }
 			</td>
 		</tr>
 		<!-- ENDLOOP -->
 		<tr>
-			<td colspan="3" class="row2">{ $L_UNACTIVATED_USERS }</td>
+			<td colspan="6" class="row2">{ $L_DISABLED_USERS }</td>
 		</tr>
-		<!-- LOOP $users_unactivated -->
+		<!-- LOOP $users_disabled -->
 		<tr>
-			<td class="row1">
-				<a href="{ $users_unactivated:link_profile }">{ $users_unactivated:user_name }</a>
+			<td height="25" class="row1">
+				<input name="mark_id[]" value="{ $users_disabled:user_id }" type="checkbox">
 			</td>
-			<td class="row1">
-				{ $users_unactivated:user_name }
+			<td height="25" class="row1">
+				<a href="{ $users_disabled:link_profile }">{ $users_disabled:user_name }</a>
 			</td>
-			<td class="row1">
-				{ $users_unactivated:user_name }
+			<td width="150" class="row1" align="center">
+				{ $users_disabled:registered }
 			</td>
+			<td width="60" align="center" class="row1"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_disabled:link_activate }'; return false;">
+				<a href="{ $users_disabled:link_activate }">{ $L_ACTIVATE }</a>
+			</td>
+			<td width="60" align="center" class="row1"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_disabled:link_activate }'; return false;">
+				<a href="{ $users_disabled:link_activate }">{ $L_REMOVE }</a>
+			</td>
+			<td width="60" align="center" class="row1"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_disabled:link_activate }'; return false;">
+				<a href="{ $users_disabled:link_activate }">{ $L_VIEW_REASON }</a> 
+			</td>
 		</tr>
 		<tr>
-			<td class="spacer" colspan="3" height="7"></td>
+			<td class="spacer" colspan="6" height="7"></td>
 		</tr>
 		<!-- LOOPELSE -->
 		<tr>
-			<td colspan="3" align="center" class="row1">
-				{ $L_NO_UNACTIVATED_USERS }
+			<td colspan="6" align="center" class="row1">
+				{ $L_NO_DISABLED_USERS }
 			</td>
 		</tr>
 		<!-- ENDLOOP -->
+		<tr>
+			<td colspan="6" class="cat" align="right"><select name="mark_option"><option value="activate">{ $L_ACTIVATE }</option><option value="remove">{ $L_REMOVE }</option></select>&nbsp;<input class="bottom" name="submit" value="{ $L_SUBMIT }" type="submit">&nbsp;</td>
+		</tr>
     </tbody>
 </table>
 
-{ $A_TABLE_CLOSE }
\ No newline at end of file
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: trunk/includes/templates/admin/messages/edit.html
===================================================================
--- trunk/includes/templates/admin/messages/edit.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/messages/edit.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,14 +1,14 @@
 <!-- DISPLAY_HEADER -->
 
-<style type="text/css">@import url(java/jscalendar/skins/aqua/theme.css);</style>
-<script type="text/javascript" src="java/jscalendar/calendar_stripped.js"></script>
-<script type="text/javascript" src="java/jscalendar/lang/calendar-en.js"></script>
-<script type="text/javascript" src="java/jscalendar/calendar-setup.js"></script>
+<style type="text/css">@import url(javascript/jscalendar/skins/aqua/theme.css);</style>
+<script type="text/javascript" src="javascript/jscalendar/calendar.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/calendar-setup.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/lang/calendar-en.js"></script>
 
 { $A_TABLE_OPEN }
 
 <form action="{ $B_ACTION }" name="message" method="post">
-	<table class="tablebg" align="center" border="0" cellpadding="4" cellspacing="1" width="100%">
+	<table class="tablebg" align="center" cellpadding="4" cellspacing="1" width="100%">
 		<tbody>
 			<!-- IF { $B_ERROR } -->
 			<tr> 
@@ -43,8 +43,7 @@
 				<td class="row1"><b class="genmed">{ $L_STARTS }: </b></td>
 				<td class="row2" >
 					<input class="post" id="time" name="time" size="35" maxlength="100" value="{ $B_STARTS }" type="text">
-					<img src="java/jscalendar/calendar.png" style="cursor: pointer;" id="time_trigger"/>
-					<!-- IF { $B_STARTS } -->   Currently Set:  { $B_STARTS }<!-- ENDIF -->
+					<img src="images/calender_small.png" style="cursor: pointer;" id="time_trigger"/>
 				</td>
 				<td class="row1" align="center" rowspan="2"><b class="genmed">Current Server Time:<br/>{ $B_CURRENT_TIME }: </b></td>
 			</tr>
@@ -52,14 +51,13 @@
 				<td class="row1"><b class="genmed">{ $L_EXPIRES }: </b></td>
 				<td class="row2">
 					<input class="post" id="expires" name="expires" size="35" maxlength="100" value="{ $B_EXPIRES }" type="text" />
-					<img src="java/jscalendar/calendar.png" style="cursor: pointer;"  id="expires_trigger" />
-					<!-- IF { $B_EXPIRES } -->    Currently Set:  { $B_EXPIRES }<!-- ENDIF -->
+					<img src="images/calender_small.png" style="cursor: pointer;"  id="expires_trigger" />
 				</td>
 			</tr>
 			<tr> 
 				<td class="row1" valign="top" ><b class="genmed">{ $L_MESSAGE }: </b></td>
-				<td class="row2" colspan="2"><div id="message_preview" style="display: none; padding:5"></div>
-				<textarea name="content" id="content" editor_enabled="true" style="width:90%; height:400px; display: ;" cols="63" rows="15">{ $B_CONTENT }</textarea><br /><br /></td>
+				<td class="row2" colspan="2"><div id="message_preview" style="display: none; padding:5px"></div>
+				<textarea name="content" id="content" editor_enabled="true" style="width:90%; height:400px;" cols="63" rows="15">{ $B_CONTENT }</textarea><br /><br /></td>
 			</tr>
 			<tr>
 				<td class="cat" colspan="3" align="center" height="28">

Modified: trunk/includes/templates/admin/messages/index.html
===================================================================
--- trunk/includes/templates/admin/messages/index.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/messages/index.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -5,8 +5,8 @@
 <table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
     <tbody>
 		<tr>
-			<th align="center">{$L_TITLE}</th>
-			<th align="center" colspan="2">{ $L_POSITION }</th>
+			<th align="center" width="25%">{$L_TITLE}</th>
+			<th align="center" colspan="2">{ $L_ORDER }</th>
 			<th align="center">{ $L_STATUS }</th>
 			<th align="center">{ $L_FUNCTIONS }</th>
 		</tr>
@@ -19,24 +19,24 @@
 		</tr>
 	<!-- LOOP $top_admin_messages -->
 		<tr>
-			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $top_admin_messages:EDIT_LINK }'">
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $top_admin_messages:EDIT_LINK }'; return false;">
 				<a href="{ $top_admin_messages:EDIT_LINK }" title="{ $L_EDIT }">{ $top_admin_messages:TITLE }</a><br />
 				<!-- IF { $top_admin_messages:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $top_admin_messages:STARTS }<!-- ENDIF -->
 				<!-- IF { $top_admin_messages:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $top_admin_messages:EXPIRES }<!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
-				<!-- IF { $top_admin_messages:WEIGHT_UP } -->
-				<a href="{ $top_admin_messages:WEIGHT_MOVE_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
-				<a href="{ $top_admin_messages:WEIGHT_MOVE_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- IF { $top_admin_messages:ORDER_UP } -->
+				<a href="{ $top_admin_messages:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $top_admin_messages:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row1" align="center">
-				<!-- IF { $top_admin_messages:WEIGHT_DOWN } -->
-				<a href="{ $top_admin_messages:WEIGHT_MOVE_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
-				<a href="{ $top_admin_messages:WEIGHT_MOVE_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- IF { $top_admin_messages:ORDER_DOWN } -->
+				<a href="{ $top_admin_messages:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $top_admin_messages:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
-			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $top_admin_messages:ACTIVE_LINK }'">
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $top_admin_messages:ACTIVE_LINK }'; return false;">
 				<a href="{ $top_admin_messages:ACTIVE_LINK }">{ $top_admin_messages:CHANGE }</a>
 			</td>
 			<td class="row1" align="center">
@@ -51,7 +51,7 @@
 		<tr>
 			<td class="spacer" colspan="8" height="7"></td>
 		</tr>
-	<!-- ENDLOOP -->
+	<!-- ENDLOOP $top_admin_messages -->
 	<!-- ENDIF -->
 
 	<!-- IF isset({ $bottom_admin_messages }) -->
@@ -63,24 +63,24 @@
 		</tr>
 	<!-- LOOP $bottom_admin_messages -->
 		<tr>
-			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $bottom_admin_messages:EDIT_LINK }'">
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $bottom_admin_messages:EDIT_LINK }'; return false;">
 				<a href="{ $bottom_admin_messages:EDIT_LINK }" title="{ $L_EDIT }">{ $bottom_admin_messages:TITLE }</a><br />
 				<!-- IF { $bottom_admin_messages:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $bottom_admin_messages:STARTS }<!-- ENDIF -->
 				<!-- IF { $bottom_admin_messages:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $bottom_admin_messages:EXPIRES }<!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
-				<!-- IF { $bottom_admin_messages:WEIGHT_UP } -->
-				<a href="{ $bottom_admin_messages:WEIGHT_MOVE_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
-				<a href="{ $bottom_admin_messages:WEIGHT_MOVE_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- IF { $bottom_admin_messages:ORDER_UP } -->
+				<a href="{ $bottom_admin_messages:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $bottom_admin_messages:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
 			<td class="row1" align="center">
-				<!-- IF { $bottom_admin_messages:WEIGHT_DOWN } -->
-				<a href="{ $bottom_admin_messages:WEIGHT_MOVE_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
-				<a href="{ $bottom_admin_messages:WEIGHT_MOVE_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- IF { $bottom_admin_messages:ORDER_DOWN } -->
+				<a href="{ $bottom_admin_messages:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $bottom_admin_messages:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
 				<!-- ENDIF -->
 			</td>
-			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $bottom_admin_messages:ACTIVE_LINK }'">
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $bottom_admin_messages:ACTIVE_LINK }'; return false;">
 				<a href="{ $bottom_admin_messages:ACTIVE_LINK }">{ $bottom_admin_messages:CHANGE }</a>
 			</td>
 			<td class="row1" align="center">
@@ -95,7 +95,7 @@
 		<tr>
 			<td class="spacer" colspan="8" height="7"></td>
 		</tr>
-	<!-- ENDLOOP -->
+	<!-- ENDLOOP $bottom_admin_messages -->
 	<!-- ENDIF -->
 	 		  <tr>
 			<td class="cat" colspan="8">

Modified: trunk/includes/templates/admin/modules/index.html
===================================================================
--- trunk/includes/templates/admin/modules/index.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/modules/index.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,3 +1,5 @@
+<!-- DISPLAY_HEADER -->
+
 { $A_TABLE_OPEN }
 
 <table class="tablebg" cellpadding="4" cellspacing="1" width="100%">
@@ -25,11 +27,11 @@
 				<!-- IF { $normal_modules:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $normal_modules:ERROR }</span><!-- ENDIF -->
 			</td>
 			<!-- IF { $normal_modules:ACTIVE } -->
-			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'">
+			<td align="center" class="row2" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'; return false;">
 				<a href="{ $normal_modules:ACTIVE_LINK }">{ $normal_modules:CHANGE }</a>
 			</td>
 			<!-- ELSE -->
-			<td align="center" class="row2" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'">
+			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'; return false;">
 				<a href="{ $normal_modules:ACTIVE_LINK }">{ $normal_modules:CHANGE }</a>
 			</td>
 			<!-- ENDIF -->
@@ -64,7 +66,7 @@
 		</tr>
 		<!-- LOOP $system_modules -->
 		<tr>
-			<td colspan="3" height="24" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $system_modules:EDIT_LINK }'">
+			<td colspan="3" height="24" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $system_modules:EDIT_LINK }'; return false;">
 				<a href="{ $system_modules:EDIT_LINK }">{ $system_modules:TITLE }</a>
 			</td>
 			<!-- IF { $S_ADMIN_AUTH_LINK } -->
@@ -81,4 +83,6 @@
 	</tbody>
 </table>
 
-{ $A_TABLE_CLOSE }
\ No newline at end of file
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: trunk/includes/templates/admin/system/bots.html
===================================================================
--- trunk/includes/templates/admin/system/bots.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/system/bots.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,18 +0,0 @@
-<table class="tablebg" cellspacing="1" cellpadding="4" border="0">
-	<tr>
-		<th nowrap="nowrap">Bot name</th>
-		<th nowrap="nowrap">Last visit</th>
-		<th colspan="3" nowrap="nowrap">Options</th>
-
-	</tr>
-	{ section name=admin_bots_loop loop=$admin_bots }
-	<tr>
-		<td class="row1" width="25%">{ $admin_bots[admin_bots_loop].NAME }</td>
-		<td class="row1" width="15%" align="center" nowrap="nowrap">{ $admin_bots[admin_bots_loop].LAST_VISIT }</td>
-		<td class="row1" width="1%"align="center">&nbsp;<a href="{ $admin_bots[admin_bots_loop].STATUS_LINK }">{ $admin_bots[admin_bots_loop].STATUS }</a>&nbsp;</td>
-		<td class="row1" width="1%" align="center">&nbsp;<a href="{ $admin_bots[admin_bots_loop].LAST_VISIT }">Edit</a>&nbsp;</td>
-
-		<td class="row1" width="1%" align="center">&nbsp;<a href="{ $admin_bots[admin_bots_loop].DELETE_LINK }">Delete</a>&nbsp;</td>
-	</tr>
-	{ /section }
-</table>
\ No newline at end of file

Modified: trunk/includes/templates/admin/system/index.html
===================================================================
--- trunk/includes/templates/admin/system/index.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/system/index.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,248 +1,250 @@
-<style type="text/css">@import url(java/jscalendar/skins/aqua/theme.css);</style>
-<script type="text/javascript" src="java/jscalendar/calendar_stripped.js"></script>
-<script type="text/javascript" src="java/jscalendar/lang/calendar-en.js"></script>
-<script type="text/javascript" src="java/jscalendar/calendar-setup.js"></script>
+<!-- DISPLAY_HEADER -->
 
+<style type="text/css">@import url(javascript/jscalendar/skins/aqua/theme.css);</style>
+<script type="text/javascript" src="javascript/jscalendar/calendar.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/calendar-setup.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/lang/calendar-en.js"></script>
+
 { $A_TABLE_OPEN }
 
-<table class="tablebg" style="width:100%" cellpadding="4" cellspacing="1">
-	<tr>
-<!-- LOOP $a_options -->
-	<th width="25%"><!-- IF { $a_options:ACTIVE } -->{ $a_options:LANG }<!-- ELSE --><a href="{ $a_options:LINK }"><b>{ $a_options:LANG }</b></a><!-- ENDIF --></th>
-<!-- ENDLOOP -->
-	</tr>
-</table>
-<table cellpadding="4" cellspacing="1">
-	<tr>
-		<td></th>
-	</tr>
-</table>
-<form action="{ $ACTION }" method="post">
-<table class="tablebg" align="center" border="0" cellpadding="4" cellspacing="1" width="100%">
-	<tbody>
-	<!-- IF { $A_OPTION } == 'site' -->
-	<tr>
-		<th colspan="2">{ $L_SITE }</th>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_SITE_NAME }: </b></td>
-		<td class="row2"><input class="post" size="40" maxlength="255" name="site_name" value="{ $SITE_NAME }" type="text"></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_SITE_URL }: </b></td>
-		<td class="row2"><input class="post" size="40" maxlength="255" name="site_url" value="{ $SITE_URL }" type="text"></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_SITE_LOGO }: </b></td>
-		<td class="row2"><input class="post" size="40" maxlength="255" name="site_logo" value="{ $SITE_LOGO }" type="text"></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_SLOGAN }: </b></td>
-		<td class="row2"><input class="post" size="40" maxlength="255" name="slogan" value="{ $SLOGAN }" type="text"></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_START_DATE }: </b></td>
-		<td class="row2"><input class="post" size="40" maxlength="255" name="startdate" value="{ $START_DATE }" type="text"></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_LINK_OPTIMIZATION }: </b></td>
-		<td class="row2"><input name="link_optimization" value="1" <!-- IF { $LINK_OPTIMIZATION } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_YES }&nbsp;&nbsp;<input name="link_optimization" value="0" <!-- IF !{ $LINK_OPTIMIZATION } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
-	</tr>
-	<tr>
 
-		<td class="row1" width="50%"><b>{ $L_DEFAULT_THEME }: </b></td>
-		<td class="row2">
-			<select name="default_theme">
-			<!-- LOOP $site_theme -->
-				<option value="{ $site_theme:FILE }" <!-- IF { $site_theme:FILE } == { $DEFAULT_THEME } --> selected="selected" <!-- ENDIF -->> { $site_theme:NAME }</option>
-			<!-- ENDLOOP -->
-			</select>
-		</td>
-	</tr>
-	<tr>
-	<td class="row1" width="50%" valign="top"><b>{ $L_FOOTER_MESSAGE }: </b></td>
-		<td class="row2">
-		<textarea name="foot1" rows="5" cols="40">{ $FOOTER_FIRST }</textarea><br /><br />
-		<textarea name="foot2" rows="5" cols="40">{ $FOOTER_SECOND }</textarea>
-	</tr>
-<!-- ELSEIF { $A_OPTION } == 'system' -->
-	<tr>
-		<th colspan="2">{ $L_MAINTENANCE }</th>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_MAINTENANCE }: </b></td>
-		<td class="row2"><input name="maintenance" value="1" <!-- IF { $MAINTENANCE } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_YES }&nbsp;&nbsp;<input name="maintenance" value="0" <!-- IF !{ $MAINTENANCE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }<br /></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_MAINTENANCE_START }: </b></td>
-		<td class="row2">
-		<input class="post" size="40" maxlength="255" id="maintenance_start" name="maintenance_start" value="{ $MAINTENANCE_START }" type="text">
-			<img src="java/jscalendar/calendar.png" style="cursor: pointer;" id="time_trigger" />
-			
-		</td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%" valign="top"><b>{ $L_MAINTENANCE_TEXT }: </b></td>
-		<td class="row2"><br /><textarea name="maintenance_text" rows="5" cols="40">{ $MAINTENANCE_MSG }</textarea></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_DEBUGGING }: </b></td>
-		<td class="row2"><select name="error_options"><option value="0"<!-- IF { $ERROR } == '0' --> selected="selected" <!-- ENDIF -->>None</option><option value="1"<!-- IF { $ERROR } == '1' --> selected="selected" <!-- ENDIF -->>On page</option><option value="2"<!-- IF { $ERROR } == '2' --> selected="selected" <!-- ENDIF -->>Debug Screen</option></select></td>
-	</tr>
-	<tr>
-		<th colspan="2">Server Settings</th>
-	</tr>
 
-	<tr>
-		<td class="row1" width="50%"><b>Domain Name: </b><br><span class="gensmall">The domain name this board runs from</span></td>
-		<td class="row2"><input class="post" size="40" maxlength="255" name="site_domain" value="{ $SITE_DOMAIN }" type="text"></td>
-	</tr>
+<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+	<tbody>
+		<tr>
+		<!-- IF { $SYSTEM_MODE } == 'site' -->
+			<td width="50%" class="row2" align="center">{ $L_SITE_SETTINGS }</td>
+			<td width="50%" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_SYSTEM }'; return false;" align="center"><a href="{ $LINK_SYSTEM }">{ $L_SYSTEM_SETTINGS }</a></td>
+		<!-- ELSE -->
+			<td width="50%" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_SITE }'; return false;" align="center"><a href="{ $LINK_SITE }">{ $L_SITE_SETTINGS }</a></td>
+			<td width="50%" class="row2" align="center">{ $L_SYSTEM_SETTINGS }</td>
+		<!-- ENDIF -->
+		</tr>
+	</tbody>
+</table>
 
+<div style="padding: 3px"></div>
 
-	<tr>
-		<td class="row1" width="50%"><b>Server Port: </b><br><span class="gensmall">The port your server is running on, usually 80, only change if different</span></td>
-		<td class="row2"><input class="post" size="5" maxlength="5" name="site_port" value="{ $SITE_PORT }" type="text"></td>
-	</tr>
+<form action="{ $ACTION }" method="post">
+	<table class="tablebg" align="center" border="0" cellpadding="4" cellspacing="1" width="100%">
+		<tbody>
+		<!-- IF { $SYSTEM_MODE } == 'site' -->
+		<tr>
+			<th colspan="2">{ $L_SITE }</th>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SITE_NAME }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="site_name" value="{ $SITE_NAME }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SITE_URL }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="site_url" value="{ $SITE_URL }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_START_DATE }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="startdate" value="{ $START_DATE }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_LINK_OPTIMIZATION }: </b></td>
+			<td class="row2"><input name="link_optimization" value="1" <!-- IF { $LINK_OPTIMIZATION } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_YES }&nbsp;&nbsp;<input name="link_optimization" value="0" <!-- IF !{ $LINK_OPTIMIZATION } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+		</tr>
+		<tr>
+	
+			<td class="row1" width="50%"><b>{ $L_DEFAULT_THEME }: </b></td>
+			<td class="row2">
+				<select name="default_theme">
+				<!-- LOOP $site_theme -->
+					<option value="{ $site_theme:FILE }" <!-- IF { $site_theme:FILE } == { $DEFAULT_THEME } --> selected="selected" <!-- ENDIF -->> { $site_theme:NAME }</option>
+				<!-- ENDLOOP -->
+				</select>
+			</td>
+		</tr>
+		<tr>
+		<td class="row1" width="50%" valign="top"><b>{ $L_FOOTER_MESSAGE }: </b></td>
+			<td class="row2">
+			<textarea name="foot1" rows="5" cols="40">{ $FOOTER_FIRST }</textarea><br /><br />
+			<textarea name="foot2" rows="5" cols="40">{ $FOOTER_SECOND }</textarea>
+		</tr>
+	<!-- ELSEIF { $SYSTEM_MODE } == 'system' -->
+		<tr>
+			<th colspan="2">{ $L_MAINTENANCE }</th>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_MAINTENANCE }: </b></td>
+			<td class="row2"><input name="maintenance" value="1" <!-- IF { $MAINTENANCE } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_YES }&nbsp;&nbsp;<input name="maintenance" value="0" <!-- IF !{ $MAINTENANCE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }<br /></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_MAINTENANCE_START }: </b></td>
+			<td class="row2">
+			<input class="post" size="40" maxlength="255" id="maintenance_start" name="maintenance_start" value="{ $MAINTENANCE_START }" type="text">
+				<img src="java/jscalendar/calendar.png" style="cursor: pointer;" id="time_trigger" />
+				
+			</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%" valign="top"><b>{ $L_MAINTENANCE_TEXT }: </b></td>
+			<td class="row2"><br /><textarea name="maintenance_text" rows="5" cols="40">{ $MAINTENANCE_MSG }</textarea></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_DEBUGGING }: </b></td>
+			<td class="row2"><select name="error_options"><option value="0"<!-- IF { $ERROR } == '0' --> selected="selected" <!-- ENDIF -->>None</option><option value="1"<!-- IF { $ERROR } == '1' --> selected="selected" <!-- ENDIF -->>On page</option><option value="2"<!-- IF { $ERROR } == '2' --> selected="selected" <!-- ENDIF -->>Debug Screen</option></select></td>
+		</tr>
+		<tr>
+			<th colspan="2">Server Settings</th>
+		</tr>
+	
+		<tr>
+			<td class="row1" width="50%"><b>Domain Name: </b><br><span class="gensmall">The domain name this board runs from</span></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="site_domain" value="{ $SITE_DOMAIN }" type="text"></td>
+		</tr>
+	
+	
+		<tr>
+			<td class="row1" width="50%"><b>Server Port: </b><br><span class="gensmall">The port your server is running on, usually 80, only change if different</span></td>
+			<td class="row2"><input class="post" size="5" maxlength="5" name="site_port" value="{ $SITE_PORT }" type="text"></td>
+		</tr>
+	
+	
+		<tr>
+			<td class="row1" width="50%"><b>Script path: </b><br><span class="gensmall">Site located relative to the domain name</span></td>
+	
+			<td class="row2"><input class="post" maxlength="255" name="site_path" value="{ $SITE_PATH }" type="text"></td>
+		</tr>
+	
+	
+		<tr>
+			<td class="row1" width="50%"><b>Session IP validation: </b><br><span class="gensmall">Determines how much of the users IP is used to validate a session; All compares the complete address, A.B.C the first x.x.x, A.B the first x.x, None disables checking.</span></td>
+			<td class="row2"><input name="ip_check" value="4" <!-- IF { $IP_CHECK } == 4  -->checked="checked" <!-- ENDIF -->type="radio"> All&nbsp;&nbsp;<input name="ip_check" value="3" <!-- IF { $IP_CHECK } == 3 -->checked="checked" <!-- ENDIF --> type="radio"> A.B.C&nbsp;&nbsp;<input name="ip_check" value="2" <!-- IF { $IP_CHECK } == 2 --> checked="checked" <!-- ENDIF --> type="radio"> A.B&nbsp;&nbsp;<input name="ip_check" value="0" <!-- IF { $IP_CHECK } == 0 --> checked="checked" <!-- ENDIF --> type="radio"> None&nbsp;&nbsp;</td>
+	
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>Limit system load: </b><br><span class="gensmall">If the 1 minute system load exceeds this value the board will go offline, 1.0 equals ~100% utilisation of one processor. This only functions on UNIX based servers.</span></td>
+			<td class="row2"><input class="post" size="4" maxlength="4" name="limit_load" value="{ $LIMIT_LOAD }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>Limit sessions: </b><br><span class="gensmall">If the number of sessions exceeds this value within a one minute period the board will go offline. Set to 0 for unlimited sessions.</span></td>
+	
+			<td class="row2"><input class="post" size="4" maxlength="4" name="limit_sessions" value="{ $LIMIT_SESSIONS }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>Session length: </b><br><span class="gensmall">Sessions will expire after this time, in seconds.</span></td>
+			<td class="row2"><input class="post" size="5" maxlength="5" name="session_length" value="{ $SESSION_LENGTH }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>Session Autologin length: </b><br><span class="gensmall">Session Autologin will expire after this time, in seconds.</span></td>
+			<td class="row2"><input class="post" size="5" maxlength="5" name="session_length" value="{ $SESSION_LENGTH }" type="text"></td>
+		</tr>
+		<tr>
+			<th colspan="2">{ $L_COOKIE_SETTINGS }</th>
+		</tr>
+		<tr>
+			<td colspan="2" class="row1">{ $L_COOKIE_SETTINGS_EXPLAIN }</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_COOKIE_DOMAIN }: </b></td>
+			<td class="row2"><input class="post" maxlength="255" name="cookie_domain" value="{ $COOKIE_DOMAIN }" type="text"></td>
+		</tr>
+	
+	
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_COOKIE_NAME }: </b></td>
+			<td class="row2"><input class="post" maxlength="16" name="cookie_name" value="{ $COOKIE_NAME }" type="text"></td>
+		</tr>
+	
+	
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_COOKIE_PATH }: </b></td>
+	
+			<td class="row2"><input class="post" maxlength="255" name="cookie_path" value="{ $COOKIE_PATH }" type="text"></td>
+		</tr>
+	
+	
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_COOKIE_SECURE }: </b><br><span class="gensmall">{ $L_COOKIE_SECURE_EXPLAIN }</span></td>
+			<td class="row2"><input name="cookie_secure" value="0" <!-- IF !{ $COOKIE_SECURE } --> checked="checked" <!-- ENDIF --> type="radio">Disabled&nbsp;&nbsp;<input name="cookie_secure" value="1" <!-- IF { $COOKIE_SECURE } --> checked="checked" <!-- ENDIF --> type="radio">Enabled</td>
+		</tr>
+		<script type="text/javascript">
+			  Calendar.setup(
+				{
+				  inputField  : "maintenance_start",
+				  button      : "time_trigger"
+				}
+			  );
+		</script>
+	<!-- ELSEIF { $SYSTEM_MODE } == 'users' -->
+		<tr>
+			<th colspan="2">{ $L_USER_OPTIONS }</th>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_ACC_ACTIVATION }: </b><br><span class="gensmall">{ $L_ACC_ACTIVATION_EXPLAIN }</span></td>
+	
+			<td class="row2">
+			<!-- LOOP $A_ACC_OPTION -->
+				<input name="require_activation" value="{$A_ACC_OPTION:OPTION}" <!-- IF { $A_ACC_OPTION:OPTION } == { $ACTIVATION_OPTION } --> checked="checked" <!-- ENDIF --> type="radio"> {$A_ACC_OPTION:LANG}&nbsp;&nbsp;
+			<!-- ENDLOOP -->
+			</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_ENABLE_COPPA }: </b><br><span class="gensmall">{ $L_ENABLE_COPPA_EXPLAIN }</span></td>
+	
+			<td class="row2"><input name="coppa_enable" value="1" <!-- IF { $COPPA_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="coppa_enable" value="0" <!-- IF !{ $COPPA_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_COPPA_FAX }: </b></td>
+			<td class="row2"><input class="post" size="25" maxlength="100" name="coppa_fax" value="{ $COPPA_FAX }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_COPPA_MAIL }: </b><br><span class="gensmall">{ $L_COPPA_MAIL_EXPLAIN }</span></td>
+			<td class="row2"><textarea name="coppa_mail" rows="5" cols="40">{ $COPPA_MAIL }</textarea></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_VISUAL_CONFIRM }: </b><br><span class="gensmall">{ $L_VISUAL_CONFIRM_EXPLAIN }</span></td>
+	
+			<td class="row2"><input name="enable_confirm" value="1" <!-- IF { $CONFIRM_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="enable_confirm" value="0" <!-- IF !{ $CONFIRM_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_REG_LIMIT }: </b><br><span class="gensmall">{ $L_REG_LIMIT_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" size="4" maxlength="4" name="max_reg_attempts" value="{ $MAX_REG_ATTEMPTS }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_USERNAME_LENGTH }: </b><br><span class="gensmall">{ $L_USERNAME_LENGTH_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" size="3" maxlength="3" name="min_name_chars" value="{ $MIN_NAME_CHARS }" type="text"> Min&nbsp;&nbsp;<input class="post" size="3" maxlength="3" name="max_name_chars" value="{ $MAX_NAME_CHARS }" type="text"> Max</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_USERNAME_CHARS }: </b><br><span class="gensmall">{ $L_USERNAME_CHARS_EXPLAIN }</span></td>
+			<td class="row2"><select name="allow_name_chars"><option value=".*" <!-- IF { $ALLOW_NAME_CHARS } == '.*' --> selected="selected" <!-- ENDIF -->>Any character</option><option value="[\w]+" <!-- IF { $ALLOW_NAME_CHARS } == '[\w]+' --> selected="selected" <!-- ENDIF -->>Alphanumeric only</option><option value="[\w_\+\. \-\[\]]+" <!-- IF { $ALLOW_NAME_CHARS } == '[\w_\+\. \-\[\]]+' --> selected="selected" <!-- ENDIF -->>Alphanumeric and spacers</option></select></td>
+		</tr>
+		<tr>
+	
+			<td class="row1" width="50%"><b>{ $L_PASSWORD_LENGTH }: </b><br><span class="gensmall">{ $L_PASSWORD_LENGTH_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" size="3" maxlength="3" name="min_pass_chars" value="{ $MIN_PASS_CHARS }" type="text"> Min&nbsp;&nbsp;<input class="post" size="3" maxlength="3" name="max_pass_chars" value="{ $MAX_PASS_CHARS }" type="text"> Max</td>
+		</tr>
+	
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_PASSWORD_CHARS }: </b><br><span class="gensmall">{ $L_USERNAME_CHARS_EXPLAIN }</span></td>
+			<td class="row2"><select name="pass_complex"><option value=".*">No requirements</option><option value="[a-zA-Z]">Must be mixed case</option><option value="[a-zA-Z0-9]">Must contain alphanumerics</option><option value="[a-zA-Z\W]">Must contain symbols</option></select></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_FORCE_PASS_CHANGE }: </b><br><span class="gensmall">{ $L_FORCE_PASS_CHANGE_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" size="3" maxlength="3" name="chg_passforce" value="{ $CHG_PASSFORCE }" type="text"></td>
+	
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_ALLOW_EMAIL_REUSE }: </b><br><span class="gensmall">{ $L_ALLOW_EMAIL_REUSE_EXPLAIN }</span></td>
+			<td class="row2"><input name="allow_emailreuse" value="1" <!-- IF { $ALLOW_EMAILREUSE } --> checked="checked" <!-- ENDIF -->  type="radio">{ $L_YES }&nbsp;&nbsp;<input name="allow_emailreuse" value="0" <!-- IF !{ $ALLOW_EMAILREUSE } --> checked="checked" <!-- ENDIF --> type="radio">No</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_ALLOW_NAME_CHANGE }: </b></td>
+			<td class="row2"><input name="allow_namechange" value="1" <!-- IF { $ALLOW_NAMECHANGE } --> checked="checked" <!-- ENDIF -->  type="radio">{ $L_YES }&nbsp;&nbsp;<input name="allow_namechange" value="0" <!-- IF !{ $ALLOW_NAMECHANGE } --> checked="checked" <!-- ENDIF --> type="radio">No</td>
+		</tr>
+	<!-- ENDIF -->
+		<tr>
+			<td class="cat" colspan="2" align="center"><input name="submit" value="Submit" class="btnmain" type="submit">&nbsp;&nbsp;<input value="Reset" class="button" type="reset"></td>
+		</tr>
+	</tbody>
+	</table>
+</form>
 
+{ $A_TABLE_CLOSE }
 
-	<tr>
-		<td class="row1" width="50%"><b>Script path: </b><br><span class="gensmall">Site located relative to the domain name</span></td>
-
-		<td class="row2"><input class="post" maxlength="255" name="site_path" value="{ $SITE_PATH }" type="text"></td>
-	</tr>
-
-
-	<tr>
-		<td class="row1" width="50%"><b>Session IP validation: </b><br><span class="gensmall">Determines how much of the users IP is used to validate a session; All compares the complete address, A.B.C the first x.x.x, A.B the first x.x, None disables checking.</span></td>
-		<td class="row2"><input name="ip_check" value="4" <!-- IF { $IP_CHECK } == 4  -->checked="checked" <!-- ENDIF -->type="radio"> All&nbsp;&nbsp;<input name="ip_check" value="3" <!-- IF { $IP_CHECK } == 3 -->checked="checked" <!-- ENDIF --> type="radio"> A.B.C&nbsp;&nbsp;<input name="ip_check" value="2" <!-- IF { $IP_CHECK } == 2 --> checked="checked" <!-- ENDIF --> type="radio"> A.B&nbsp;&nbsp;<input name="ip_check" value="0" <!-- IF { $IP_CHECK } == 0 --> checked="checked" <!-- ENDIF --> type="radio"> None&nbsp;&nbsp;</td>
-
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>Validate browser: </b><br><span class="gensmall">Enables browser validation for each session inproving security.</span></td>
-		<td class="row2"><input name="browser_check" value="1" <!-- IF { $BROWSER_CHECK } --> checked="checked" <!-- ENDIF -->type="radio">Yes&nbsp;&nbsp;<input name="browser_check" value="0" <!-- IF !{ $BROWSER_CHECK } --> checked="checked" <!-- ENDIF --> type="radio">No</td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>Limit system load: </b><br><span class="gensmall">If the 1 minute system load exceeds this value the board will go offline, 1.0 equals ~100% utilisation of one processor. This only functions on UNIX based servers.</span></td>
-		<td class="row2"><input class="post" size="4" maxlength="4" name="limit_load" value="{ $LIMIT_LOAD }" type="text"></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>Limit sessions: </b><br><span class="gensmall">If the number of sessions exceeds this value within a one minute period the board will go offline. Set to 0 for unlimited sessions.</span></td>
-
-		<td class="row2"><input class="post" size="4" maxlength="4" name="limit_sessions" value="{ $LIMIT_SESSIONS }" type="text"></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>Session length: </b><br><span class="gensmall">Sessions will expire after this time, in seconds.</span></td>
-		<td class="row2"><input class="post" size="5" maxlength="5" name="session_length" value="{ $SESSION_LENGTH }" type="text"></td>
-	</tr>
-	<tr>
-		<th colspan="2">{ $L_COOKIE_SETTINGS }</th>
-	</tr>
-	<tr>
-		<td colspan="2" class="row1">{ $L_COOKIE_SETTINGS_EXPLAIN }</td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_COOKIE_DOMAIN }: </b></td>
-		<td class="row2"><input class="post" maxlength="255" name="cookie_domain" value="{ $COOKIE_DOMAIN }" type="text"></td>
-	</tr>
-
-
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_COOKIE_NAME }: </b></td>
-		<td class="row2"><input class="post" maxlength="16" name="cookie_name" value="{ $COOKIE_NAME }" type="text"></td>
-	</tr>
-
-
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_COOKIE_PATH }: </b></td>
-
-		<td class="row2"><input class="post" maxlength="255" name="cookie_path" value="{ $COOKIE_PATH }" type="text"></td>
-	</tr>
-
-
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_COOKIE_SECURE }: </b><br><span class="gensmall">{ $L_COOKIE_SECURE_EXPLAIN }</span></td>
-		<td class="row2"><input name="cookie_secure" value="0" <!-- IF !{ $COOKIE_SECURE } --> checked="checked" <!-- ENDIF --> type="radio">Disabled&nbsp;&nbsp;<input name="cookie_secure" value="1" <!-- IF { $COOKIE_SECURE } --> checked="checked" <!-- ENDIF --> type="radio">Enabled</td>
-	</tr>
-	<script type="text/javascript">
-		  Calendar.setup(
-			{
-			  inputField  : "maintenance_start",
-			  button      : "time_trigger"
-			}
-		  );
-	</script>
-<!-- ELSEIF { $A_OPTION } == 'users' -->
-	<tr>
-		<th colspan="2">{ $L_USER_OPTIONS }</th>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_ACC_ACTIVATION }: </b><br><span class="gensmall">{ $L_ACC_ACTIVATION_EXPLAIN }</span></td>
-
-		<td class="row2">
-		<!-- LOOP $A_ACC_OPTION -->
-			<input name="require_activation" value="{$A_ACC_OPTION:OPTION}" <!-- IF { $A_ACC_OPTION:OPTION } == { $ACTIVATION_OPTION } --> checked="checked" <!-- ENDIF --> type="radio"> {$A_ACC_OPTION:LANG}&nbsp;&nbsp;
-		<!-- ENDLOOP -->
-		</td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_ENABLE_COPPA }: </b><br><span class="gensmall">{ $L_ENABLE_COPPA_EXPLAIN }</span></td>
-
-		<td class="row2"><input name="coppa_enable" value="1" <!-- IF { $COPPA_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="coppa_enable" value="0" <!-- IF !{ $COPPA_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_COPPA_FAX }: </b></td>
-		<td class="row2"><input class="post" size="25" maxlength="100" name="coppa_fax" value="{ $COPPA_FAX }" type="text"></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_COPPA_MAIL }: </b><br><span class="gensmall">{ $L_COPPA_MAIL_EXPLAIN }</span></td>
-		<td class="row2"><textarea name="coppa_mail" rows="5" cols="40">{ $COPPA_MAIL }</textarea></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_VISUAL_CONFIRM }: </b><br><span class="gensmall">{ $L_VISUAL_CONFIRM_EXPLAIN }</span></td>
-
-		<td class="row2"><input name="enable_confirm" value="1" <!-- IF { $CONFIRM_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="enable_confirm" value="0" <!-- IF !{ $CONFIRM_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_REG_LIMIT }: </b><br><span class="gensmall">{ $L_REG_LIMIT_EXPLAIN }</span></td>
-		<td class="row2"><input class="post" size="4" maxlength="4" name="max_reg_attempts" value="{ $MAX_REG_ATTEMPTS }" type="text"></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_USERNAME_LENGTH }: </b><br><span class="gensmall">{ $L_USERNAME_LENGTH_EXPLAIN }</span></td>
-		<td class="row2"><input class="post" size="3" maxlength="3" name="min_name_chars" value="{ $MIN_NAME_CHARS }" type="text"> Min&nbsp;&nbsp;<input class="post" size="3" maxlength="3" name="max_name_chars" value="{ $MAX_NAME_CHARS }" type="text"> Max</td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_USERNAME_CHARS }: </b><br><span class="gensmall">{ $L_USERNAME_CHARS_EXPLAIN }</span></td>
-		<td class="row2"><select name="allow_name_chars"><option value=".*" <!-- IF { $ALLOW_NAME_CHARS } == '.*' --> selected="selected" <!-- ENDIF -->>Any character</option><option value="[\w]+" <!-- IF { $ALLOW_NAME_CHARS } == '[\w]+' --> selected="selected" <!-- ENDIF -->>Alphanumeric only</option><option value="[\w_\+\. \-\[\]]+" <!-- IF { $ALLOW_NAME_CHARS } == '[\w_\+\. \-\[\]]+' --> selected="selected" <!-- ENDIF -->>Alphanumeric and spacers</option></select></td>
-	</tr>
-	<tr>
-
-		<td class="row1" width="50%"><b>{ $L_PASSWORD_LENGTH }: </b><br><span class="gensmall">{ $L_PASSWORD_LENGTH_EXPLAIN }</span></td>
-		<td class="row2"><input class="post" size="3" maxlength="3" name="min_pass_chars" value="{ $MIN_PASS_CHARS }" type="text"> Min&nbsp;&nbsp;<input class="post" size="3" maxlength="3" name="max_pass_chars" value="{ $MAX_PASS_CHARS }" type="text"> Max</td>
-	</tr>
-
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_PASSWORD_CHARS }: </b><br><span class="gensmall">{ $L_USERNAME_CHARS_EXPLAIN }</span></td>
-		<td class="row2"><select name="pass_complex"><option value=".*">No requirements</option><option value="[a-zA-Z]">Must be mixed case</option><option value="[a-zA-Z0-9]">Must contain alphanumerics</option><option value="[a-zA-Z\W]">Must contain symbols</option></select></td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_FORCE_PASS_CHANGE }: </b><br><span class="gensmall">{ $L_FORCE_PASS_CHANGE_EXPLAIN }</span></td>
-		<td class="row2"><input class="post" size="3" maxlength="3" name="chg_passforce" value="{ $CHG_PASSFORCE }" type="text"></td>
-
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_ALLOW_EMAIL_REUSE }: </b><br><span class="gensmall">{ $L_ALLOW_EMAIL_REUSE_EXPLAIN }</span></td>
-		<td class="row2"><input name="allow_emailreuse" value="1" <!-- IF { $ALLOW_EMAILREUSE } --> checked="checked" <!-- ENDIF -->  type="radio">{ $L_YES }&nbsp;&nbsp;<input name="allow_emailreuse" value="0" <!-- IF !{ $ALLOW_EMAILREUSE } --> checked="checked" <!-- ENDIF --> type="radio">No</td>
-	</tr>
-	<tr>
-		<td class="row1" width="50%"><b>{ $L_ALLOW_NAME_CHANGE }: </b></td>
-		<td class="row2"><input name="allow_namechange" value="1" <!-- IF { $ALLOW_NAMECHANGE } --> checked="checked" <!-- ENDIF -->  type="radio">{ $L_YES }&nbsp;&nbsp;<input name="allow_namechange" value="0" <!-- IF !{ $ALLOW_NAMECHANGE } --> checked="checked" <!-- ENDIF --> type="radio">No</td>
-	</tr>
-<!-- ENDIF -->
-	<tr>
-		<td class="cat" colspan="2" align="center"><input name="submit" value="Submit" class="btnmain" type="submit">&nbsp;&nbsp;<input value="Reset" class="button" type="reset"></td>
-	</tr>
-</tbody>
-</table>
-</form>
-
-{ $A_TABLE_CLOSE }
\ No newline at end of file
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: trunk/includes/templates/admin/users/bots.html
===================================================================
--- trunk/includes/templates/admin/users/bots.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/users/bots.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -0,0 +1,28 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<!-- INCLUDE admin/users/header.html -->
+
+<table class="tablebg" cellspacing="1" cellpadding="4" border="0">
+	<tr>
+		<th nowrap="nowrap">Bot name</th>
+		<th nowrap="nowrap">Last visit</th>
+		<th colspan="3" nowrap="nowrap">Options</th>
+
+	</tr>
+	<!-- LOOP $admin_bots -->
+	<tr>
+		<td class="row1" width="25%">{ $admin_bots:NAME }</td>
+		<td class="row1" width="15%" align="center" nowrap="nowrap">{ $admin_bots:LAST_VISIT }</td>
+		<td class="row1" width="1%"align="center">&nbsp;<a href="{ $admin_bots:LINK_STATUS }">{ $admin_bots:L_STATUS }</a>&nbsp;</td>
+		<td class="row1" width="1%" align="center">&nbsp;<a href="{ $admin_bots:LINK_EDIT }">{ $L_EDIT }</a>&nbsp;</td>
+
+		<td class="row1" width="1%" align="center">&nbsp;<a href="{ $admin_bots:LINK_DELETE }">{ $L_DELETE }</a>&nbsp;</td>
+	</tr>
+	<!-- ENDLOOP $admin_bots -->
+</table>
+
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: trunk/includes/templates/admin/users/header.html
===================================================================
--- trunk/includes/templates/admin/users/header.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/users/header.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -0,0 +1,82 @@
+<table border="0" cellpadding="4" cellspacing="1" width="100%">
+	<tbody>
+		<tr>
+			<td width="80%" valign="top">
+				<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+					<tbody>
+						<tr>
+							<th colspan="4" align="center"><b>System Info</b></td>
+						</tr>
+						<tr class="row1">
+							<td width="20%">
+								{ $L_TOTAL_USERS }
+							</td>
+							<td>
+								{ $COUNT_USERS }
+							</td>
+							<td width="20%">
+								{ $L_TOTAL_BOTS }
+							</td>
+							<td>
+								{ $COUNT_BOTS }
+							</td>
+						</tr>
+						<tr class="row1">
+							<td width="20%">
+								{ $L_TOTAL_USERS }
+							</td>
+							<td>
+								{ $COUNT_USERS }
+							</td>
+							<td width="20%">
+								{ $L_TOTAL_BOTS }
+							</td>
+							<td>
+								{ $COUNT_BOTS }
+							</td>
+						</tr>
+						<tr class="row1">
+							<td colspan="4">
+								<img src="images/add_user.png" alt="{ $L_ADD_USER }" title="{ $L_ADD_USER }" border="0">
+							</td>
+						</tr>
+					</tbody>
+				</table>
+			</td>
+			<td width="20%" valign="top">
+				<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+					<tbody>
+						<tr>
+							<th width="25%" align="center"><b>Options</b></td>
+						</tr>
+						<tr>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_USER_INDEX }'; return false;">
+								<a href="{ $LINK_USER_INDEX }" title="{ $L_USERS_INDEX }">{ $L_USERS_INDEX }</a>
+							</td>
+						</tr>
+						<tr>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_BOTS }'; return false;">
+								<a href="{ $LINK_VIEW_BOTS }" title="{ $L_VIEW_BOTS }">{ $L_VIEW_BOTS }</a>
+							</td>
+						</tr>
+						<tr>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_VIEW_DISABLED }'; return false;">
+								<a href="{ $LINK_VIEW_DISABLED }" title="{ $L_VIEW_DISABLED }">{ $L_VIEW_DISABLED }</a>
+							</td>
+						</tr>
+						<tr>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_VIEW_UNACTIVATED }'; return false;">
+								<a href="{ $LINK_VIEW_UNACTIVATED }" title="{ $L_VIEW_UNACTIVATED }">{ $L_VIEW_UNACTIVATED }</a>
+							</td>
+						</tr>
+						<tr>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_ADD_USER }'; return false;">
+								<a href="{ $LINK_ADD_USER }" title="{ $L_VIEW_BOTS }">{ $L_VIEW_BOTS }</a>
+							</td>
+						</tr>
+					</tbody>
+				</table>
+			</td>
+		</tr>
+    </tbody>
+</table>
\ No newline at end of file

Added: trunk/includes/templates/admin/users/index.html
===================================================================
--- trunk/includes/templates/admin/users/index.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/users/index.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -0,0 +1,96 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<!-- INCLUDE admin/users/header.html -->
+
+<table class="tablebg" border="0" cellspacing="1" width="100%">
+    <tbody>
+		<tr>
+			<th colspan="6" align="center">{ $L_INACTIVE_USERS }</th>
+		</tr>
+		<tr>
+			<td colspan="6" class="row2"></td>
+		</tr>
+		<tr>
+			<th width="20px"></th>
+			<th>{ $L_USERNAME }</th>
+			<th>{ $L_REGISTED }</th>
+			<th colspan="3" >{ $L_OPTIONS }</th>
+		</tr>
+		<tr>
+			<td colspan="6" class="row2">{ $L_UNACTIVATED_USERS }</td>
+		</tr>
+		<!-- LOOP $users_unactivated -->
+		<tr>
+			<td height="25" class="row1">
+				<input name="mark_id[]" value="{ $users_unactivated:user_id }" type="checkbox">
+			</td>
+			<td height="25" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_unactivated:link_profile }'; return false;">
+				<a href="{ $users_unactivated:link_profile }">{ $users_unactivated:user_name }</a>
+			</td>
+			<td width="150" class="row1" align="center">
+				{ $users_unactivated:registered }
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_unactivated:link_activate }'; return false;">
+				<a href="{ $users_unactivated:link_activate }">{ $L_ACTIVATE }</a>
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_unactivated:link_remove }'; return false;">
+				<a href="{ $users_unactivated:link_remove }">{ $L_REMOVE }</a>
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_unactivated:link_remind }'; return false;">
+				<a href="{ $users_unactivated:link_remind }">{ $L_REMIND }</a> 
+			</td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="6" height="7"></td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr>
+			<td colspan="6" align="center" class="row1">
+				{ $L_NO_UNACTIVATED_USERS }
+			</td>
+		</tr>
+		<!-- ENDLOOP -->
+		<tr>
+			<td colspan="6" class="row2">{ $L_DISABLED_USERS }</td>
+		</tr>
+		<!-- LOOP $users_disabled -->
+		<tr>
+			<td height="25" class="row1">
+				<input name="mark_id[]" value="{ $users_disabled:user_id }" type="checkbox">
+			</td>
+			<td height="25" class="row1">
+				<a href="{ $users_disabled:link_profile }">{ $users_disabled:user_name }</a>
+			</td>
+			<td width="150" class="row1" align="center">
+				{ $users_disabled:registered }
+			</td>
+			<td width="60" align="center" class="row1"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_disabled:link_activate }'; return false;">
+				<a href="{ $users_disabled:link_activate }">{ $L_ACTIVATE }</a>
+			</td>
+			<td width="60" align="center" class="row1"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_disabled:link_activate }'; return false;">
+				<a href="{ $users_disabled:link_activate }">{ $L_REMOVE }</a>
+			</td>
+			<td width="60" align="center" class="row1"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_disabled:link_activate }'; return false;">
+				<a href="{ $users_disabled:link_activate }">{ $L_VIEW_REASON }</a> 
+			</td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="6" height="7"></td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr>
+			<td colspan="6" align="center" class="row1">
+				{ $L_NO_DISABLED_USERS }
+			</td>
+		</tr>
+		<!-- ENDLOOP -->
+		<tr>
+			<td colspan="6" class="cat" align="right"><select name="mark_option"><option value="activate">{ $L_ACTIVATE }</option><option value="remove">{ $L_REMOVE }</option></select>&nbsp;<input class="bottom" name="submit" value="{ $L_SUBMIT }" type="submit">&nbsp;</td>
+		</tr>
+    </tbody>
+</table>
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: trunk/includes/templates/admin/users/unactivated.html
===================================================================
--- trunk/includes/templates/admin/users/unactivated.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/admin/users/unactivated.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -0,0 +1,69 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<!-- INCLUDE admin/users/header.html -->
+
+<table class="tablebg" border="0" cellspacing="1" width="100%">
+    <tbody>
+		<tr>
+			<th colspan="6" align="center">{ $L_INACTIVE_USERS }</th>
+		</tr>
+		<tr>
+			<td colspan="6" class="row2"></td>
+		</tr>
+		<tr>
+			<th width="20px"></th>
+			<th>{ $L_USERNAME }</th>
+			<th>{ $L_REGISTED }</th>
+			<th colspan="3" >{ $L_OPTIONS }</th>
+		</tr>
+		<tr>
+			<td colspan="6" class="row2">{ $L_UNACTIVATED_USERS }</td>
+		</tr>
+		<!-- LOOP $users_admin -->
+		<tr>
+			<td height="25" class="row1">
+				<input name="mark_id[]" value="{ $users_admin:user_id }" type="checkbox">
+			</td>
+			<td height="25" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_admin:link_profile }'; return false;">
+				<a href="{ $users_admin:link_profile }">{ $users_admin:user_name }</a>
+			</td>
+			<td width="150" class="row1" align="center">
+				{ $users_admin:registered }
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_admin:link_activate }'; return false;">
+				<a href="{ $users_admin:link_activate }">{ $L_ACTIVATE }</a>
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_admin:link_remove }'; return false;">
+				<a href="{ $users_admin:link_remove }">{ $L_REMOVE }</a>
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_admin:link_remind }'; return false;">
+				<a href="{ $users_admin:link_remind }">{ $L_REMIND }</a> 
+			</td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="6" height="7"></td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr>
+			<td colspan="6" align="center" class="row1">
+				{ $L_NO_UNACTIVATED_USERS }
+			</td>
+		</tr>
+		<!-- ENDLOOP -->
+		<tr>
+			<td colspan="6" class="cat" align="right"><select name="mark_option"><option value="activate">{ $L_ACTIVATE }</option><option value="remove">{ $L_REMOVE }</option><option value="remind">{ $L_REMIND }</option></select>&nbsp;<input class="bottom" name="submit" value="{ $L_SUBMIT }" type="submit">&nbsp;</td>
+		</tr>
+		<!-- IF { $USERS_PAGINATION } -->
+		<tr class="row2">
+			<td style="padding: 5px;" valign="middle" colspan="6">
+				<div>{ $USERS_PAGINATION }</div>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+    </tbody>
+</table>
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: trunk/includes/templates/confirmation.html
===================================================================
--- trunk/includes/templates/confirmation.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/confirmation.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -0,0 +1,24 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<form action="" method="post">
+	<table class="tablebg" border="0" cellpadding="0" cellspacing="1" width="100%">
+		<tbody>
+			<tr>
+				<td class="row1" colspan="4" align="center" height="28">
+					{ $MESSAGE }{ $HIDDEN_FIELDS }
+				</td>
+			</tr>
+			<tr>
+				<td class="row1" colspan="4" align="center" height="28">
+					<input class="button" name="confirm" value="Submit" type="submit" />&nbsp;&nbsp;<input class="button" value="{ $L_CANCEL }" name="cancel" type="submit" />
+				</td>
+			</tr>
+		</tbody>
+	</table>
+</form>
+
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: trunk/includes/templates/login_admin.html
===================================================================
--- trunk/includes/templates/login_admin.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/login_admin.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -63,64 +63,78 @@
 form { margin: 0px; padding: 0px; border: 0px; }
 input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
 select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
-.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
 -->
 </style>
 
 <body>
 
-<div id="container"><div id="wrapper">
-<form action="{$S_LOGIN_ACTION}" method="post">
-	<table align="center" class="tablebg" width="100%" cellspacing="1">
-		<tr> 
-			<th align="center">Login Info</th>
-		</tr>
-		<!-- IF { $LOGIN_EXPLAIN } -->
-		<tr>
-			<td class="row1" colspan="2" align="center"><span class="gensmall">{ $LOGIN_EXPLAIN }</td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row2">
-			<table width="100%" cellspacing="1" cellpadding="4">
-				<!-- IF { $LOGIN_ERROR } -->
+<div id="container">
+	<div id="wrapper">
+		<form action="{$S_LOGIN_ACTION}" method="post">
+			<table align="center" class="tablebg" width="100%" cellspacing="1">
+				<tr> 
+					<th align="center">Login Info</th>
+				</tr>
+				<!-- IF { $LOGIN_EXPLAIN } -->
 				<tr>
-					<td class="gensmall" colspan="2" align="center"><span class="error">{$LOGIN_ERROR}</span></td>
+					<td class="row1" colspan="2" align="center"><span class="gensmall">{ $LOGIN_EXPLAIN }</td>
 				</tr>
 				<!-- ENDIF -->
 				<tr> 
-					<td valign="top"><b class="gensmall">{$L_USERNAME}:</b></td>
-					<td><input class="post" type="text" name="username" size="25" maxlength="40" value="{$USERNAME}" tabindex="1" /></td>
+					<td class="row2">
+					<table width="100%" cellspacing="1" cellpadding="4">
+						<!-- IF { $LOGIN_ERROR } -->
+						<tr>
+							<td class="gensmall" colspan="2" align="center"><span class="error">{$LOGIN_ERROR}</span></td>
+						</tr>
+						<!-- ENDIF -->
+						<tr> 
+							<td valign="top"><b class="gensmall">{$L_USERNAME}:</b></td>
+							<td><input class="post" type="text" name="username" size="25" maxlength="40" value="{$USERNAME}" tabindex="1" /><br /><a class="gensmall" href="{$U_REGISTER}">{$L_REGISTER}</a></td>
+						</tr>
+						<tr> 
+							<td valign="top"><b class="gensmall">{$L_PASSWORD}:</b></td>
+							<td>
+								<input class="post" type="password" name="password" size="25" maxlength="25" tabindex="2" />
+								<!-- IF { $U_SEND_PASSWORD } --><br /><a class="gensmall" href="{ $U_SEND_PASSWORD }">{ $L_FORGOT_PASS }</a><!-- ENDIF -->
+								<!-- IF { $U_RESEND_ACTIVATION } --><br /><a class="gensmall" href="{ $U_RESEND_ACTIVATION }">{ $L_RESEND_ACTIVATION }</a><!-- ENDIF -->
+							 </td>
+						</tr>
+						<!-- IF { $S_DISPLAY_FULL_LOGIN } -->
+						<tr> 
+							<td>&nbsp;</td>
+							<td><input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{$L_LOG_ME_IN}</span></td>
+						</tr>
+						<tr>
+							<td>&nbsp;</td>
+							<td><input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{$L_HIDE_ME}</span></td>
+						</tr>
+						<!-- ENDIF -->
+					</table>
+					</td>
 				</tr>
+				<!-- IF { $U_CONFIRM_IMAGE } -->
 				<tr> 
-					<td valign="top"><b class="gensmall">{$L_PASSWORD}:</b></td>
-					<td>
-						<input class="post" type="password" name="password" size="25" maxlength="25" tabindex="2" />
-						<!-- IF { $U_SEND_PASSWORD } --><br /><a class="gensmall" href="{ $U_SEND_PASSWORD }">{ $L_FORGOT_PASS }</a><!-- ENDIF -->
-					 </td>
+					<th  align="center">{ $L_CONFIRMATION_CODE }</th>
 				</tr>
+				<tr> 
+					<td align="center" class="row1"><span class="gensmall">Enter the code exactly as you see it in the image<br/><b>This is case sensitive</b></span></td>
+				</tr>
+				<tr>
+					<td align="center" class="row2">{ $U_CONFIRM_IMAGE }</td>
+				</tr>
+				<tr>
+					<td align="center" class="row1"><input class="post" name="confirm_code" size="10" maxlength="6" type="text"></td>
+				</tr>
+				<!-- ENDIF -->
+				<tr> 
+					<th colspan="2" align="center">{$S_HIDDEN_FIELDS}<input type="submit" name="login" class="button" value="{$L_LOGIN}" tabindex="3" /></td>
+				</tr>
 			</table>
-			</td>
-		</tr>
-		<!-- IF { $U_CONFIRM_IMAGE } -->
-		<tr> 
-			<th  align="center">{ $L_CONFIRMATION_CODE }</th>
-		</tr>
-		<tr> 
-			<td align="center" class="row1"><span class="gensmall">Enter the code exactly as you see it in the image<br/><b>This is case sensitive</b></span></td>
-		</tr>
-		<tr>
-			<td align="center" class="row2">{ $U_CONFIRM_IMAGE }</td>
-		</tr>
-		<tr>
-			<td align="center" class="row1"><input class="post" name="confirm_code" size="10" maxlength="6" type="text"></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<th colspan="2" align="center">{$S_HIDDEN_FIELDS}<input type="submit" name="login" class="button" value="{$L_LOGIN}" tabindex="3" /></td>
-		</tr>
-	</table>
-</form>
-</div></div>
+		</form>
+	</div>
+</div>
 
-<body>
\ No newline at end of file
+</body>
\ No newline at end of file

Modified: trunk/includes/templates/login_body.html
===================================================================
--- trunk/includes/templates/login_body.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/login_body.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -13,8 +13,8 @@
 	<tr>
 		<td class="row1" colspan="2" align="center"><span class="gensmall">{ $LOGIN_EXPLAIN }</td>
 		<td class="row1" valign="top" rowspan="<!-- IF { $U_CONFIRM_IMAGE } -->7<!-- ELSE -->3<!-- ENDIF -->">
-					<input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{ $L_LOG_ME_IN }</span><br/>
-					<input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{ $L_HIDE_ME }</span>
+					<input type="checkbox" name="auto_login" tabindex="4" /> <span class="gensmall">{ $L_LOG_ME_IN }</span><br/>
+					<input type="checkbox" name="hidden" tabindex="5" /> <span class="gensmall">{ $L_HIDE_ME }</span>
 		</td>
 	</tr>
 	<!-- ENDIF -->
@@ -23,8 +23,8 @@
 				<td class="row1" class="gensmall" colspan="2" align="center"><span class="error">{ $LOGIN_ERROR }</span></td>
 				<!-- IF !{ $LOGIN_EXPLAIN } -->
 				<td class="row1" valign="top" rowspan="<!-- IF { $U_CONFIRM_IMAGE } -->7<!-- ELSE -->3<!-- ENDIF -->">
-					<input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{ $L_LOG_ME_IN }</span><br/>
-					<input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{ $L_HIDE_ME }</span>
+					<input type="checkbox" name="auto_login" tabindex="4" /> <span class="gensmall">{ $L_LOG_ME_IN }</span><br/>
+					<input type="checkbox" name="hidden" tabindex="5" /> <span class="gensmall">{ $L_HIDE_ME }</span>
 				</td>
 				<!-- ENDIF -->
 			</tr>
@@ -34,8 +34,8 @@
 				<td><input class="post" type="text" name="username" size="25" maxlength="40" value="{ $USERNAME }" tabindex="1" /><br /><a class="gensmall" href="{ $U_REGISTER }">{ $L_REGISTER }</a></td>
 				<!-- IF !{ $LOGIN_ERROR } && !{ $LOGIN_EXPLAIN } -->
 				<td class="row1" valign="top" rowspan="<!-- IF { $U_CONFIRM_IMAGE } -->6<!-- ELSE -->2<!-- ENDIF -->">
-					<input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{ $L_LOG_ME_IN }</span><br/>
-					<input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{ $L_HIDE_ME }</span>
+					<input type="checkbox" name="auto_login" tabindex="4" /> <span class="gensmall">{ $L_LOG_ME_IN }</span><br/>
+					<input type="checkbox" name="hidden" tabindex="5" /> <span class="gensmall">{ $L_HIDE_ME }</span>
 				</td>
 				<!-- ENDIF -->
 			</tr>
@@ -67,11 +67,11 @@
 				<td colspan="2" align="center" class="row2">{ $U_CONFIRM_IMAGE }</td>
 			</tr>
 			<tr>
-				<td colspan="2" align="center" class="row1"><input class="post" name="confirm_code" size="10" maxlength="6" type="text"></td>
+				<td colspan="2" align="center" class="row1"><input class="post" name="confirm_code" size="10" maxlength="6" type="text" tabindex="3"></td>
 			</tr>
 			<!-- ENDIF -->
 	<tr> 
-		<td class="cat" colspan="3" align="center">{ $S_HIDDEN_FIELDS }<input type="submit" name="login" class="btnmain" value="{ $L_LOGIN }" tabindex="3" /></td>
+		<td class="cat" colspan="3" align="center">{ $S_HIDDEN_FIELDS }<input type="submit" name="login" class="button" value="{ $L_LOGIN }" tabindex="4"/></td>
 	</tr>
 </table></form>
 

Modified: trunk/includes/templates/login_body_full.html
===================================================================
--- trunk/includes/templates/login_body_full.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/login_body_full.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -69,7 +69,6 @@
 </style>
 
 <body>
-<style type="text/css">
 
 <div id="container">
 	<div id="wrapper">
@@ -138,4 +137,4 @@
 	</div>
 </div>
 
-<body>
\ No newline at end of file
+</body>
\ No newline at end of file

Added: trunk/includes/templates/message.html
===================================================================
--- trunk/includes/templates/message.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/message.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -0,0 +1,22 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
+<title>Error</title>
+</head>
+<body style="background: url(/bg.gif);">
+
+<table style="position: absolute; left: 25%; top: 25%;">
+	<tr>
+		<td>
+			<img src="/paladin.png" />
+		</td>
+		<td valign="top">
+			{ $MESSAGE_TEXT }
+		</td>
+	</tr>
+</table>
+
+
+</body>
+</html>
\ No newline at end of file

Modified: trunk/includes/templates/modules/Control_Panel/ucp_agreement.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_agreement.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Control_Panel/ucp_agreement.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -6,13 +6,15 @@
 
 <table class="tablebg" width="100%" cellspacing="1" cellpadding="0" border="0">
 	<tr>
-		<th height="25">{ $SITENAME } - { $L_REGISTRATION }</th>
+		<th height="25">{ $L_REGISTRATION }</th>
 	</tr>
 	<tr>
 		<td class="row1">
+		{ $S_HIDDEN_FIELDS }
 		<!-- IF { $S_SHOW_COPPA } -->
 			<div align="center">
-				<br />{ $L_COPPA_BIRTHDAY }<br /><br /><a href="{ $U_COPPA_NO }">{ $L_COPPA_NO }</a> :: <a href="{ $U_COPPA_YES }">{ $L_COPPA_YES }</a><br /><br />
+				<br />{ $L_COPPA_BIRTHDAY }<br /><br />
+				<a href="{ $U_COPPA_NO }">{ $L_COPPA_NO }</a> :: <a href="{ $U_COPPA_YES }">{ $L_COPPA_YES }</a><br /><br />
 			</div>
 		<!-- ELSE -->
 			<div style="padding: 10px" class="genmed"><br />{ $L_TERMS_OF_USE_CONTENT }<br /><br /></div>

Modified: trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -2,73 +2,67 @@
 
 <table class="tablebg" width="100%" cellspacing="1">
 	<tr>
-		<th colspan="3">{ $L_USERGROUPS }</th>
+		<th colspan="2">{ $L_USERGROUPS }</th>
 	</tr>
 	<tr>
-		<td class="row3" colspan="3"><span class="genmed">{ $L_GROUPS_EXPLAIN }</span></td>
+		<td class="row3" colspan="2"><span class="genmed">{ $L_GROUPS_EXPLAIN }</span></td>
 	</tr>
 
 	<tr>
-		<th colspan="2">{ $L_GROUP_DETAILS }</td>
+		<th colspan="1">{ $L_GROUP_DETAILS }</td>
 		<th>{ $L_MARK }</td>
 	</tr>
 
-	<!-- LOOP $leader -->
-	<!-- IF !({ $leader:#LOOP_INDEX }) -->
+	<!-- IF isset({ $leader }) -->
 	<tr>
-		<td class="row3" colspan="3"><b class="gensmall">{ $L_GROUP_LEADER }</b></td>
+		<td class="row3" colspan="2"><b class="gensmall">{ $L_GROUP_LEADER }</b></td>
 	</tr>
 	<!-- ENDIF -->
+	<!-- LOOP $leader -->
 	<tr>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $S_CHANGE_DEFAULT } --><input type="radio" name="default"<!-- IF { $leader:S_GROUP_DEFAULT } --> checked="checked"<!-- ENDIF --> /><!-- ENDIF --></td>
 		<td class="row1"><b class="genmed"><a href="{ $leader:U_VIEW_GROUP }">{ $leader:GROUP_NAME }</a></b><!-- IF { $leader:GROUP_DESC } --><p class="forumdesc">{ $leader:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF !{ $leader:GROUP_SPECIAL } --><input type="checkbox" name="mark[{ $leader:GROUP_ID }]" /><!-- ENDIF --></td>
+		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $leader:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
 	</tr>
 	<!-- ENDLOOP -->
-	
-	<!-- LOOP $member -->
-	<!-- IF !({ $member:#LOOP_INDEX }) -->
+
+	<!-- IF isset({ $member }) -->
 	<tr>
-		<td class="row3" colspan="3"><b class="gensmall">{ $L_GROUP_MEMBER }</b></td>
+		<td class="row3" colspan="2"><b class="gensmall">{ $L_GROUP_MEMBER }</b></td>
 	</tr>
 	<!-- ENDIF -->
+	<!-- LOOP $member -->
 	<tr>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $S_CHANGE_DEFAULT } --><input type="radio" name="default"<!-- IF { $member:S_GROUP_DEFAULT } --> checked="checked"<!-- ENDIF --> /><!-- ENDIF --></td>
 		<td class="row1"><b class="genmed"><a href="{ $member:U_VIEW_GROUP }">{ $member:GROUP_NAME }</a></b><!-- IF { $member:GROUP_DESC } --><p class="forumdesc">{ $member:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF !{ $member:GROUP_SPECIAL } --><input type="checkbox" name="mark[{ $member:GROUP_ID }]" /><!-- ENDIF --></td>
+		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $member:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
 	</tr>
 	<!-- ENDLOOP -->
 	
-	<!-- LOOP $pending -->
-	<!-- IF !({ $pending:#LOOP_INDEX }) -->
+	<!-- IF isset({ $pending }) -->
 	<tr>
-		<td class="row3" colspan="3"><b class="gensmall">{$L_GROUP_PENDING}</b></td>
+		<td class="row3" colspan="2"><b class="gensmall">{$L_GROUP_PENDING}</b></td>
 	</tr>
 	<!-- ENDIF -->
+	<!-- LOOP $pending -->
 	<tr>
-		<td class="row1" width="6%" align="center" nowrap="nowrap">&nbsp;</td>
 		<td class="row1"><b class="genmed"><a href="{ $pending:U_VIEW_GROUP }">{ $pending:GROUP_NAME }</a></b><!-- IF { $pending:GROUP_DESC } --><p class="forumdesc">{ $pending:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF !{ $pending:GROUP_SPECIAL } --><input type="checkbox" name="mark[{ $pending:GROUP_ID }]" /><!-- ENDIF --></td>
+		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $pending:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
 	</tr>
 	<!-- ENDLOOP -->
 	
+	<!-- IF isset({ $nonmember }) -->
+	<tr>
+		<td class="row3" colspan="3"><b class="gensmall">{$L_GROUP_NONMEMBER}</b></td>
+	</tr>
+	<!-- ENDIF -->
 	<!-- LOOP $nonmember -->
-	<!-- IF !({ $nonmember:#LOOP_INDEX }) -->
-		<tr>
-			<td class="row3" colspan="3"><b class="gensmall">{$L_GROUP_NONMEMBER}</b></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr>
-			<td class="row1" width="6%" align="center" nowrap="nowrap">&nbsp;</td>
-			<td class="row1"><b class="genmed"><a href="{$nonmember:U_VIEW_GROUP}">{ $nonmember:GROUP_NAME }</a></b><!-- IF { $nonmember:GROUP_DESC } --><p class="forumdesc">{ $nonmember:GROUP_DESC }</p><!-- ENDIF --></td>
-			<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF !{ $nonmember:GROUP_SPECIAL } --><input type="checkbox" name="mark[{$nonmember:GROUP_ID}]" /><!-- ENDIF --></td>
-		</tr>
-		<!-- ENDLOOP -->
-
 	<tr>
+		<td class="row1"><b class="genmed"><a href="{$nonmember:U_VIEW_GROUP}">{ $nonmember:GROUP_NAME }</a></b><!-- IF { $nonmember:GROUP_DESC } --><p class="forumdesc">{ $nonmember:GROUP_DESC }</p><!-- ENDIF --></td>
+		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $nonmember:GROUP_APPLY } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
+	</tr>
+	<!-- ENDLOOP -->
+	<tr>
 		<td class="cat" colspan="3"></div><div style="float:right"><span class="genmed">Select: </span><select name="mode"><option value="join">Join marked</option><option value="resign">Resign marked</option><option value="demote">Demote marked</option></select>&nbsp;<input class="btnmain" type="submit" name="submit" value="{$L_SUBMIT}" />&nbsp;</div></td>
 	</tr>
-
 </table>
 
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: trunk/includes/templates/modules/Control_Panel/ucp_posting_body.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_posting_body.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Control_Panel/ucp_posting_body.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,5 +1,4 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
 <script language="javascript" type="text/javascript">
 <!--
 
@@ -40,7 +39,7 @@
 
 //-->
 </script>
-<script language="javascript" type="text/javascript" src="java/editor.js"></script>
+<script language="javascript" type="text/javascript" src="javascript/editor.js"></script>
 
 <form action="{ $S_POST_ACTION }" method="post" name="post" { $S_FORM_ENCTYPE }>
 
@@ -288,7 +287,7 @@
 	<!-- IF { $S_SHOW_ATTACH_BOX } --><!-- INCLUDE modules/Control_Panel/ucp_posting_attach_body.html --><!-- ENDIF -->
 
 	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="bottom" type="submit" tabindex="5" name="preview" value="{ $L_PREVIEW }" />&nbsp; <input class="btnmain" type="submit" accesskey="s" tabindex="6" name="post" value="{$L_SUBMIT}" /><!-- IF { $S_SAVE_ALLOWED } -->&nbsp; <input class="bottom" type="submit" accesskey="k" tabindex="8" name="save" value="{$L_SAVE}" /><!-- ENDIF --><!-- IF { $S_HAS_DRAFTS } -->&nbsp; <input class="bottom" type="submit" accesskey="d" tabindex="9" name="load" value="{$L_LOAD}" /><!-- ENDIF -->&nbsp; <input class="bottom" type="submit" accesskey="c" tabindex="7" name="cancel" value="{ $L_CANCEL }" /></td>
+		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" tabindex="5" name="preview" value="{ $L_PREVIEW }" />&nbsp; <input class="btnmain" type="submit" accesskey="s" tabindex="6" name="post" value="{$L_SUBMIT}" /><!-- IF { $S_SAVE_ALLOWED } -->&nbsp; <input class="bottom" type="submit" accesskey="k" tabindex="8" name="save" value="{$L_SAVE}" /><!-- ENDIF --><!-- IF { $S_HAS_DRAFTS } -->&nbsp; <input class="bottom" type="submit" accesskey="d" tabindex="9" name="load" value="{$L_LOAD}" /><!-- ENDIF -->&nbsp; <input class="button" type="submit" accesskey="c" tabindex="7" name="cancel" value="{ $L_CANCEL }" /></td>
 	</tr>
 </table>
 </form>

Modified: trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -37,7 +37,7 @@
 		<td class="row1" width="35%"><b class="genmed">{ $L_AVATAR_GALLERY }: </b></td>
 		<td class="row2"><input class="btnlite" type="submit" name="display_gallery" value="{ $L_DISPLAY_GALLERY }" /></td>
 	</tr>
-	<!-- ENDIF --><!-- IF { $S_DISPLAY_GALLERY } -->
+	<!-- ENDIF --><!-- IF isset({ $S_DISPLAY_GALLERY }) -->
 	<tr> 
 		<th colspan="2">{ $L_AVATAR_GALLERY }</th>
 	</tr>
@@ -60,7 +60,7 @@
 	</tr>
 	<!-- ENDIF -->
 	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<!-- IF { $S_DISPLAY_GALLERY } --><input class="button" type="submit" name="cancel" value="{ $L_CANCEL }" /><!-- ELSE --><input class="btnlite" type="reset" value="{ $L_RESET }" name="reset" /><!-- ENDIF --></td>
+		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<!-- IF isset({ $S_DISPLAY_GALLERY }) --><input class="button" type="submit" name="cancel" value="{ $L_CANCEL }" /><!-- ELSE --><input class="button" type="reset" value="{ $L_RESET }" name="reset" /><!-- ENDIF --></td>
 	</tr>
 </table>
 

Modified: trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -41,7 +41,7 @@
 
 //-->
 </script>
-<script language="javascript" type="text/javascript" src="java/editor.js"></script>
+<script language="javascript" type="text/javascript" src="javascript/editor.js"></script>
 
 <table class="tablebg" width="100%" cellspacing="1">
 	<tr>
@@ -169,7 +169,7 @@
 	</tr>
 	<!-- ENDIF -->
 	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnlite" type="submit" name="preview" value="{ $L_PREVIEW }" />&nbsp;&nbsp;<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="preview" value="{ $L_PREVIEW }" />&nbsp;&nbsp;<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
 	</tr>
 </table>
 

Modified: trunk/includes/templates/modules/Control_Panel/ucp_register.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_register.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Control_Panel/ucp_register.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -44,17 +44,19 @@
 		</tr>
 		<tr> 
 			<td class="row1"><b class="genmed">{ $L_CONFIRM_PASSWORD }: </b></td>
-			<td class="row2"><input class="post" type="password" name="password_confirm" size="25" maxlength="100" value="{ $PASSWORD_CONFIRM }" /></td>
+			<td class="row2"><input class="post" type="password" name="password_confirm" size="25" maxlength="100" value="" /></td>
 		</tr>
+		<!--
 		<tr> 
 			<td class="row1"><b class="genmed">{ $L_LANGUAGE }: </b></td>
 			<td class="row2"><select name="lang" onchange="javascript:change_language(this.value);">{ $S_LANG_OPTIONS }</select></td>
 		</tr>
+		-->
 		<tr> 
 			<td class="row1"><b class="genmed">{ $L_TIMEZONE }: </b></td>
 			<td class="row2"><select name="tz">{ $S_TZ_OPTIONS }</select></td>
 		</tr>
-		<!-- IF { $S_CONFIRM_CODE } -->
+		<!-- IF { $CONFIRM_IMG } -->
 		<tr> 
 			<th colspan="2" height="28" valign="middle">{ $L_CONFIRMATION }</th>
 		</tr>
@@ -77,7 +79,7 @@
 		</tr>
 		<!-- ENDIF -->
 		<tr>
-			<td class="cat" colspan="2" align="center" height="28">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
+			<td class="cat" colspan="2" align="center" height="28">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
 		</tr>
 	</table>
 </form>

Modified: trunk/includes/templates/modules/Forums/faq_body.html
===================================================================
--- trunk/includes/templates/modules/Forums/faq_body.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Forums/faq_body.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,8 +1,8 @@
 <!-- IF { $DISPLAY_STYLESHEET_LINK } -->
-	<!-- INCLUDE modules/Forums/simple_header.html -->
+<!-- INCLUDE modules/Forums/simple_header.html -->
 <!-- ELSE -->
-	<!-- DISPLAY_HEADER -->
-	<!-- INCLUDE modules/Forums/overall_header.html -->
+<!-- DISPLAY_HEADER -->
+<!-- INCLUDE modules/Forums/overall_header.html -->
 <!-- ENDIF -->
 
 <a name="Top"></a>

Modified: trunk/includes/templates/modules/Forums/overall_header.html
===================================================================
--- trunk/includes/templates/modules/Forums/overall_header.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Forums/overall_header.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -7,9 +7,9 @@
 	return false;
 }
 
+<!-- IF isset({ $ON_PAGE }) -->
 function jumpto()
 {
-
 	var page = prompt('{ $L_JUMP_PAGE }:', '{ $ON_PAGE }');
 	var perpage = '{ $PER_PAGE }';
 	var base_url = '{ $BASE_URL }';
@@ -19,7 +19,7 @@
 		document.location.href = base_url.replace('&amp;', '&') + '&start=' + ((page - 1) * perpage);
 	}
 }
-
+<!-- ENDIF -->
 //-->
 </script>
 

Modified: trunk/includes/templates/modules/Forums/posting_body.html
===================================================================
--- trunk/includes/templates/modules/Forums/posting_body.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Forums/posting_body.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -42,7 +42,7 @@
 
 //-->
 </script>
-<script language="javascript" type="text/javascript" src="java/editor.js"></script>
+<script language="javascript" type="text/javascript" src="javascript/editor.js"></script>
 
 <!-- IF { $S_FORUM_RULES } -->
 <div class="forumrules">

Modified: trunk/includes/templates/modules/Forums/viewforum_body.html
===================================================================
--- trunk/includes/templates/modules/Forums/viewforum_body.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Forums/viewforum_body.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -154,7 +154,7 @@
 		<!-- IF { $S_TOPIC_ICONS } -->
 		<td class="row1" width="25" nowrap="nowrap" align="center"><!-- IF { $topicrow:TOPIC_ICON_IMG } --><img src="{ $T_ICONS_PATH }{ $topicrow:TOPIC_ICON_IMG }" width="{ $topicrow:TOPIC_ICON_IMG_WIDTH }" height="{ $topicrow:TOPIC_ICON_IMG_HEIGHT }" alt="" title="" /><!-- ENDIF --></td>
 		<!-- ENDIF -->
-		<td  width="100%" class="row1">
+		<td class="row1">
 			<!-- IF { $topicrow:S_TOPIC_UNAPPROVED } -->
 				<a href="{ $topicrow:U_MCP_QUEUE }">{ $UNAPPROVED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
@@ -166,10 +166,10 @@
 			<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
 			<!-- ENDIF -->
 		</td>
-		<td class="row2" align="center"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
-		<td class="row1" nowrap="nowrap" align="center"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
-		<td class="row2" align="center"><p class="topicdetails">{ $topicrow:VIEWS }</p></td>
-		<td class="row1" nowrap="nowrap" align="center">
+		<td class="row2" width="80" align="center"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
+		<td class="row1" width="50" align="center"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
+		<td class="row2" width="50" align="center"><p class="topicdetails">{ $topicrow:VIEWS }</p></td>
+		<td class="row1" width="150" nowrap="nowrap" align="center">
 			<p class="topicdetails">{ $topicrow:LAST_POST_TIME }</p>
 			<p class="topicdetails"><!-- IF { $topicrow:U_LAST_POST_AUTHOR } --><a href="{ $topicrow:U_LAST_POST_AUTHOR }">{ $topicrow:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $topicrow:LAST_POST_AUTHOR }<!-- ENDIF -->
 			<a href="{ $topicrow:U_LAST_POST }">{ $topicrow:LAST_POST_IMG }</a>

Modified: trunk/includes/templates/modules/Forums/viewtopic_body.html
===================================================================
--- trunk/includes/templates/modules/Forums/viewtopic_body.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Forums/viewtopic_body.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -14,7 +14,7 @@
 
 	<br clear="all" />
 	<!-- ENDIF -->
-	
+
 	<h2><a class="titles" href="{ $U_VIEW_TOPIC }">{ $TOPIC_TITLE }</a></h2>
 
 	<!-- IF { $MODERATORS } -->
@@ -47,7 +47,7 @@
 					<!-- IF { $U_EMAIL_TOPIC } --><a href="{ $U_EMAIL_TOPIC }" title="{ $L_EMAIL_TOPIC }">{ $L_EMAIL_TOPIC }</a><!-- IF { $U_BUMP_TOPIC } --> | <!-- ENDIF --><!-- ENDIF -->
 					<!-- IF { $U_BUMP_TOPIC } --><a href="{ $U_BUMP_TOPIC }" title="{ $L_BUMP_TOPIC }">{ $L_BUMP_TOPIC }</a><!-- ENDIF -->
 					</td>
-					<td class="nav" align="right" nowrap="nowrap"><a href="{ $U_VIEW_OLDER_TOPIC }">{ $L_VIEW_PREVIOUS_TOPIC }</a> | <a href="{ $U_VIEW_UNREAD_POST }">{ $L_VIEW_UNREAD_POST }</a> | <a href="{ $U_VIEW_NEWER_TOPIC }">{ $L_VIEW_NEXT_TOPIC }</a>&nbsp;</td>
+					<td class="nav" align="right" nowrap="nowrap"><a href="{ $U_VIEW_OLDER_TOPIC }">{ $L_VIEW_PREVIOUS_TOPIC }</a><!-- IF { $U_VIEW_UNREAD_POST } -->| <a href="{ $U_VIEW_UNREAD_POST }">{ $L_VIEW_UNREAD_POST }</a><!-- ENDIF --> | <a href="{ $U_VIEW_NEWER_TOPIC }">{ $L_VIEW_NEXT_TOPIC }</a>&nbsp;</td>
 				</tr>
 			</table></td>
 		</tr>

Modified: trunk/includes/templates/modules/Quick_Message/index.html
===================================================================
--- trunk/includes/templates/modules/Quick_Message/index.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/modules/Quick_Message/index.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -36,15 +36,16 @@
 		</tr>
 		<!-- LOOPELSE -->
 			<tr class="row2">
-				<td colspan="2">
-					{ $ERROR }
+				<td align="center" colspan="2">
+					{ $L_NO_POST }
 				</td>
 			</tr>
 		<!-- ENDLOOP -->
+
 		<!-- IF { $Q_MESSAGE_PAGINATION } -->
 		<tr class="row2">
 			<td style="padding: 5px;" valign="middle" colspan="2">
-				<div style="padding-right: 5px; text-align: right;" class="numbering">[ <!-- IF { $Q_MESSAGE_PREVIOUS_PAGE } --><a href="{ $Q_MESSAGE_PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;|&nbsp;<!-- ENDIF --> { $Q_MESSAGE_PAGINATION } <!-- IF { $Q_MESSAGE_NEXT_PAGE } -->&nbsp;|&nbsp;<a href="{ $Q_MESSAGE_NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --> ]</div>
+				<div style="padding-right: 5px; text-align: right;">{ $Q_MESSAGE_PAGINATION }</div>
 			</td>
 		</tr>
 		<!-- ENDIF -->

Modified: trunk/includes/templates/permission.html
===================================================================
--- trunk/includes/templates/permission.html	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/templates/permission.html	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,5 +1,6 @@
 { $A_TABLE_OPEN }
 <form method="post" action="">
+<!-- IF { $P_CURRENT_GROUPS } || { $P_DCURRENT_GROUPS } || { $P_CURRENT_USERS } || { $P_DCURRENT_USERS }-->
 	<table class="tablebg" border="0" cellpadding="0" cellspacing="1" width="100%">
 		<tbody>
 			<!-- IF { $P_CURRENT_GROUPS } || { $P_DCURRENT_GROUPS } -->
@@ -15,7 +16,7 @@
 					<table class="tablebg" align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
 						<tbody>
 							<tr>
-								<td class="row1" align="center"><select style="width: 280px;" name="dg_current[]" multiple="multiple" size="5">{ $P_DCURRENT_GROUPS }</select></td>
+								<td class="row1" align="center"><select style="width: 280px;" name="groups_current[]" multiple="multiple" size="5">{ $P_DCURRENT_GROUPS }</select></td>
 							</tr>
 						</tbody>
 					</table>
@@ -25,17 +26,17 @@
 						<tbody>
 
 							<tr>
-								<td class="row1" align="center"><select style="width: 280px;" name="g_current[]" multiple="multiple" size="5">{ $P_CURRENT_GROUPS }</select></td>
+								<td class="row1" align="center"><select style="width: 280px;" name="groups_current[]" multiple="multiple" size="5">{ $P_CURRENT_GROUPS }</select></td>
 							</tr>
 						</tbody>
 					</table>
 				</td>
 			</tr>
 			<!-- ENDIF -->
+			<!-- IF { $P_CURRENT_USERS } || { $P_DCURRENT_USERS } -->
 			<tr>
 				<th colspan="2">{ $L_USERS }</th>
 			</tr>
-			<!-- IF { $P_CURRENT_USERS } || { $P_DCURRENT_USERS } -->
 			<tr>
 				<td  class="row1" align="center">{ $L_DISALLOWED }</td>
 				<td  class="row1" align="center">{ $L_ALLOWED }</ttd>
@@ -45,7 +46,7 @@
 					<table class="tablebg" align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
 						<tbody>
 							<tr>
-								<td class="row1" align="center"><select style="width: 280px;" name="du_current[]" multiple="multiple" size="5">{ $P_DCURRENT_USERS }</select></td>
+								<td class="row1" align="center"><select style="width: 280px;" name="users_current[]" multiple="multiple" size="5">{ $P_DCURRENT_USERS }</select></td>
 							</tr>
 						</tbody>
 					</table>
@@ -54,7 +55,7 @@
 					<table class="tablebg" align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
 						<tbody>
 							<tr>
-								<td class="row1" align="center"><select style="width: 280px;" name="u_current[]" multiple="multiple" size="5">{ $P_CURRENT_USERS }</select></td>
+								<td class="row1" align="center"><select style="width: 280px;" name="users_current[]" multiple="multiple" size="5">{ $P_CURRENT_USERS }</select></td>
 							</tr>
 						</tbody>
 					</table>
@@ -68,14 +69,12 @@
 			</tr>
 		</tbody>
 	</table>
-
 	<br/>
-
+<!-- ENDIF -->
 	<table class="tablebg" border="0" cellpadding="0" cellspacing="1" width="100%">
 		<tbody>
-
 			<tr>	
-				<td>
+				<td colspan="2">
 					<table class="tablebg" align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
 						<tbody>
 							<tr>
@@ -88,7 +87,7 @@
 						</tbody>
 					</table>
 				</td>
-				<td>
+				<td colspan="2">
 					<table class="tablebg" align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
 						<tbody>
 							<tr>
@@ -101,8 +100,17 @@
 					</table>
 				</td>
 			</tr>
+			<tr>
+				<th colspan="4">{ $L_OPTIONS }</th>
+			</tr>
 			<tr>
-				<td class="cat" colspan="3" align="center" height="28">
+			<td class="row1"><b class="genmed">{ $L_ACCESS }</b></td>
+			<td class="row2"><input name="auth_options[core_status]" value="1" checked="checked" type="radio">{ $L_ALLOWED }&nbsp;&nbsp;<input name="auth_options[core_status]" value="0" type="radio">{ $L_DENIED }</td>
+			<td class="row1"><b class="genmed">{ $L_GROUP_ALLOWANCE }</b></td>
+			<td class="row2"><input name="auth_options[core_auth_type]" value="1" checked="checked" type="radio">{ $L_ONLY_DEFAULT }&nbsp;&nbsp;<input name="auth_options[core_auth_type]" value="0" type="radio">{ $L_ALL_MEMBERS }</td>
+			</tr>
+			<tr>
+				<td class="cat" colspan="4" align="center" height="28">
 					<input class="btnmain" name="add" value="Submit" type="submit" />&nbsp;&nbsp;<input class="button" value="Reset" name="reset" type="reset" />
 				</td>
 			</tr>

Modified: trunk/includes/user.php
===================================================================
--- trunk/includes/user.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/includes/user.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -51,7 +51,7 @@
 		$this->browser = mb_substr((empty($_SERVER['HTTP_USER_AGENT']) ? getenv('HTTP_USER_AGENT') : $_SERVER['HTTP_USER_AGENT']), 0, 255);
 		$this->url	= empty($_SERVER['REQUEST_URI']) ? getenv('REQUEST_URI') : $_SERVER['REQUEST_URI'];
 		$this->ip	= empty($_SERVER['REMOTE_ADDR']) ? getenv('REMOTE_ADDR') : $_SERVER['REMOTE_ADDR'];
-		$this->time	= gmtime();
+		$this->time	= (int) gmtime();
 
 		if (($pos = mb_strpos($this->url, INDEX_PAGE.'?mod=')) !== false)
 		{
@@ -79,7 +79,7 @@
 
 	function format_time($gmtime, $format = false)
 	{
-		settype($gmtime, 'integer');
+		settype($gmtime, 'int');
 
 		if (!$gmtime)
 		{
@@ -105,6 +105,8 @@
 	function login($id = ANONYMOUS, $admin_login = false, $hidden = false, $auto_log = false)
 	{
 		global $_CLASS;
+
+		settype($id, 'int');
 
 		if ($bot = check_bot_status($this->browser, $this->ip))
 		{
@@ -123,7 +125,7 @@
 			script_close(false);
 		}
 
-		$result = $_CLASS['core_db']->query('SELECT * FROM ' . USERS_TABLE . ' WHERE user_id = '.$id);
+		$result = $_CLASS['core_db']->query('SELECT * FROM ' . USERS_TABLE . ' WHERE user_id = '. $id);
 		$this->data = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 		
@@ -143,23 +145,14 @@
 
 		load_class(false, 'core_auth', 'auth_db');
 		
-		if ($this->is_bot)
-		{
-			$this->data['session_admin'] = ADMIN_NOT_ADMIN;
-		}
-		else
+		$this->data['session_admin'] = ADMIN_NOT_ADMIN;
+
+		if (!$this->is_bot && $_CLASS['core_auth']->admin_auth())
 		{
-			if ($_CLASS['core_auth']->admin_auth())
-			{
-				$this->data['session_admin'] = ($admin_login) ? ADMIN_IS_ADMIN : ADMIN_NOT_LOGGED;
-			}
-			else
-			{
-				$this->data['session_admin'] = ADMIN_NOT_ADMIN;
-			}
+			$this->data['session_admin'] = ($admin_login) ? ADMIN_IS_ADMIN : ADMIN_NOT_LOGGED;
 		}
 
-		$this->is_admin = ($this->data['session_admin'] == ADMIN_IS_ADMIN);
+		$this->is_admin = ($this->data['session_admin'] === ADMIN_IS_ADMIN);
 		$this->data['session_hidden'] = $hidden;
 
 		$this->session_create($auto_log);
@@ -169,8 +162,16 @@
 	{
 		global $_CLASS;
 
-		$this->session_destroy();
-// do last visit update here
+		if ($this->is_user)
+		{
+			$sql = 'UPDATE ' . USERS_TABLE . '
+				SET user_last_visit = ' . (int) $this->data['session_time'] . '
+				WHERE user_id = ' . (int) $this->data['user_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+
+		$this->session_destroy(false, true);
+
 		$sql = 'SELECT *
 			FROM ' . USERS_TABLE . '
 			WHERE user_id = ' . ANONYMOUS;
@@ -365,12 +366,12 @@
 
 	function user_data_get($name, $default = false)
 	{
-		return (empty($this->data['user_data'][$name])) ? $default : $this->data['user_data'][$name];
+		return isset($this->data['user_data'][$name]) ? $this->data['user_data'][$name] : $default;
 	}
 
 	function user_data_kill($name)
 	{
-		if (empty($this->data['user_data'][$name]))
+		if (!isset($this->data['user_data'][$name]))
 		{
 			return;
 		}
@@ -381,10 +382,10 @@
 
 	function user_data_set($name, $value, $save = false)
 	{
-		/*if (!empty($this->data['user_data'][$name]) && ($this->data['user_data'][$name] == $value))
+		if (isset($this->data['user_data'][$name]) && ($this->data['user_data'][$name] == $value))
 		{
 			return;
-		}*/
+		}
 
 		$this->data['user_data'][$name] = $value;
 
@@ -393,17 +394,22 @@
 		}
 	}
 
-	function set_cookie($name, $cookiedata, $cookietime)
+	function set_cookie($name, $cookie_data, $cookie_time)
 	{
 		global $_CORE_CONFIG;
 
+		if ($_CORE_CONFIG['server']['cookie_name'])
+		{
+			$name = $_CORE_CONFIG['server']['cookie_name'] . '_' . $name;
+		}
+
 		if ($this->server_local)
 		{
-			setcookie($_CORE_CONFIG['server']['cookie_name'] . '_' . $name, $cookiedata, $cookietime, $_CORE_CONFIG['server']['cookie_path']);
+			setcookie($name, $cookie_data, $cookie_time, $_CORE_CONFIG['server']['cookie_path']);
 		}
 		else
 		{
-			setcookie($_CORE_CONFIG['server']['cookie_name'] . '_' . $name, $cookiedata, $cookietime, $_CORE_CONFIG['server']['cookie_path'], $_CORE_CONFIG['server']['cookie_domain'], $_CORE_CONFIG['server']['cookie_secure']);
+			setcookie($name, $cookie_data, $cookie_time, $_CORE_CONFIG['server']['cookie_path'], $_CORE_CONFIG['server']['cookie_domain'], $_CORE_CONFIG['server']['cookie_secure']);
 		}
 	}
 	

Modified: trunk/install/build_data.php
===================================================================
--- trunk/install/build_data.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/install/build_data.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -50,7 +50,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '[\\w_\\+\\. \\-\\[\\]]+', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '[\w_\+\. \-\[\]]+', 1)");
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)");
@@ -74,7 +74,6 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_load', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_sessions', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'browser_check', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)");
 
@@ -186,7 +185,6 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_search', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_email', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_rate', 1)");
-#$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_print', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_ignoreflood', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_postcount', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_moderate', 1)");
@@ -205,7 +203,8 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_auth', 1, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_ip', 1, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_info', 1, 1)");
-
+
+// this should be replaced by beta
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_server', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_defaults', 1)");
@@ -277,44 +276,31 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_img', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_flash', 1)");
 
+/*
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 1, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 2, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+*/
 
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'm_%';
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'm_%';
-
-# ADMINISTRATOR group - admin and forum rights
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 7, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%';
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 7, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'a_%';
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 7, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 7, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html');
-
-# SUPER MODERATOR group - moderator rights
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_chgname');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'm_%';
-
+// ADMINISTRATOR group
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+
+// SUPER MODERATOR group
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'm_%'");
+
 # REGISTERED/REGISTERED COPPA groups - common forum rights
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname');
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
+
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname');
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
-# GUESTS, INACTIVE, INACTIVE_COPPA group - basic rights
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 1, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 1, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 2, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 2, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 3, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 3, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_bbsmiley_code', 'f_search', 'f_print');
-
-# BOTS - read/view only
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 8, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 8, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_list', 'f_read');
-
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbsmiley_code', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html', '1', 0)");
@@ -474,5 +460,4 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')");
 
 
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."quick_message (id, user_id, user_name, ip, message, time) VALUES (1, 0, 'Site', '', 'Lets do this !', ".gmtime().")");
 ?>
\ No newline at end of file

Modified: trunk/install/build_tables.php
===================================================================
--- trunk/install/build_tables.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/install/build_tables.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -224,92 +224,91 @@
 /*
 
 `user_unread_privmsg` tinyint(4) unsigned NOT NULL default '0',
-`user_newpasswd` varchar(40) NOT NULL default '',
-`user_viewemail` tinyint(1) NOT NULL default '0',
 */
 
 $_CLASS['core_db']->table_create('start', $install_prefix.'users');
 
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000, 0, true);
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('username', 80);
 $_CLASS['core_db']->add_table_field_char('user_password', 40);
 $_CLASS['core_db']->add_table_field_char('user_password_encoding', 10);
+$_CLASS['core_db']->add_table_field_char('user_email', 100);
 $_CLASS['core_db']->add_table_field_int('user_type', 0, 1);
-$_CLASS['core_db']->add_table_field_int('group_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('user_rank', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('user_status', 0, 10);
+$_CLASS['core_db']->add_table_field_int('user_group', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('user_ip', 255);
-$_CLASS['core_db']->add_table_field_char('user_agent', 255);
-$_CLASS['core_db']->add_table_field_int('user_timezone', -43200 , 46800);
-$_CLASS['core_db']->add_table_field_int('user_dst', 0 , 1);
+$_CLASS['core_db']->add_table_field_char('user_agent', 255, null);
+$_CLASS['core_db']->add_table_field_char('user_birthday', 10, true);
+$_CLASS['core_db']->add_table_field_text('user_data', 6000, true);
 
-field_unix_time('user_regdate');
-$_CLASS['core_db']->add_table_field_text('user_permissions', 60000); // phpBBs rename user_forums_permissions
-$_CLASS['core_db']->add_table_field_char('user_email', 100);
-$_CLASS['core_db']->add_table_field_char('user_birthday', 10);
-$_CLASS['core_db']->add_table_field_text('user_data', 6000);
-field_unix_time('user_last_visit');
-field_unix_time('user_last_post_time');
-$_CLASS['core_db']->add_table_field_int('user_warnings', 0, 10000);
-$_CLASS['core_db']->add_table_field_char('user_lang', 10);
-$_CLASS['core_db']->add_table_field_char('user_theme', 60);
-$_CLASS['core_db']->add_table_field_int('user_rank', 0, 16000000);
-$_CLASS['core_db']->add_table_field_char('user_colour', 6);
-$_CLASS['core_db']->add_table_field_char('user_dateformat', 14);
-$_CLASS['core_db']->add_table_field_int('user_new_privmsg', 0, 1);
+$_CLASS['core_db']->add_table_field_char('user_act_key', 10, null);
+$_CLASS['core_db']->add_table_field_char('user_new_password', 40);
+$_CLASS['core_db']->add_table_field_char('user_new_password_encoding', 10);
 
-$_CLASS['core_db']->add_table_field_text('user_sig', 60000);
-$_CLASS['core_db']->add_table_field_char('user_from', 100);
-$_CLASS['core_db']->add_table_field_char('user_icq', 15);
-$_CLASS['core_db']->add_table_field_char('user_aim', 255);
-$_CLASS['core_db']->add_table_field_char('user_yim', 255);
-$_CLASS['core_db']->add_table_field_char('user_msnm', 255);
-$_CLASS['core_db']->add_table_field_char('user_jabber', 255);
-$_CLASS['core_db']->add_table_field_char('user_website', 255);
+field_unix_time('user_reg_date');
+field_unix_time('user_last_visit', true);
 
-$_CLASS['core_db']->add_table_field_char('user_interests', 255);
-$_CLASS['core_db']->add_table_field_char('user_occ', 255);
+$_CLASS['core_db']->add_table_field_int('user_dst',  array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('user_lang', 10, true);
+$_CLASS['core_db']->add_table_field_char('user_time_format', 20, true);
+$_CLASS['core_db']->add_table_field_int('user_timezone', array('min' => -43200, 'max' => 46800, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('user_theme', 60, true);
+$_CLASS['core_db']->add_table_field_char('user_colour', 6, true);
 
-$_CLASS['core_db']->add_table_field_int('user_message_limit', 0, 200);
-$_CLASS['core_db']->add_table_field_int('user_message_rules', 0, 1);
+$_CLASS['core_db']->add_table_field_int('user_allow_viewonline', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('user_allow_viewemail', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('user_allow_massemail', array('max' => 1));
 
+$_CLASS['core_db']->add_table_field_int('user_new_privmsg', array('max' => 1));
+
+$_CLASS['core_db']->add_table_field_text('user_sig', 60000, true);
+$_CLASS['core_db']->add_table_field_char('user_from', 100, true);
+$_CLASS['core_db']->add_table_field_char('user_icq', 15, true);
+$_CLASS['core_db']->add_table_field_char('user_aim', 255, true);
+$_CLASS['core_db']->add_table_field_char('user_yim', 255, true);
+$_CLASS['core_db']->add_table_field_char('user_msnm', 255, true);
+$_CLASS['core_db']->add_table_field_char('user_jabber', 255, true);
+$_CLASS['core_db']->add_table_field_char('user_website', 255, true);
+$_CLASS['core_db']->add_table_field_char('user_interests', 255, true);
+$_CLASS['core_db']->add_table_field_char('user_occ', 255, true);
+
 // look at these
+$_CLASS['core_db']->add_table_field_int('user_message_limit', 0, 200);
+$_CLASS['core_db']->add_table_field_int('user_message_rules', 0, 1);
 $_CLASS['core_db']->add_table_field_int('user_full_folder', -10, 16000000, -3);
 $_CLASS['core_db']->add_table_field_int('user_attachsig', 0, 1, 1);
 ///
 
-$_CLASS['core_db']->add_table_field_int('user_notify', 0, 1);
-$_CLASS['core_db']->add_table_field_int('user_notify_pm', 0, 1);
-$_CLASS['core_db']->add_table_field_int('user_notify_type', 0, 200);
+$_CLASS['core_db']->add_table_field_int('user_notify', array('max' => 1));
+//$_CLASS['core_db']->add_table_field_int('user_notify_pm', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('user_notify_type', array('max' => 10));
 
-$_CLASS['core_db']->add_table_field_int('user_allow_pm', 0, 1, 1);
-$_CLASS['core_db']->add_table_field_int('user_allow_email', 0, 1, 1);
+$_CLASS['core_db']->add_table_field_int('user_allow_pm', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('user_allow_email', array('max' => 1));
 
 $_CLASS['core_db']->add_table_field_char('user_sig_bbcode_uid', 5);
-$_CLASS['core_db']->add_table_field_int('user_sig_bbcode_bitfield', 0, 1600);
+$_CLASS['core_db']->add_table_field_int('user_sig_bbcode_bitfield', array('max' => 1600));
 
-$_CLASS['core_db']->add_table_field_int('user_topic_show_days', 0, 200);
+$_CLASS['core_db']->add_table_field_int('user_topic_show_days', array('max' => 200));
 $_CLASS['core_db']->add_table_field_char('user_topic_sortby_type', 1);
 $_CLASS['core_db']->add_table_field_char('user_topic_sortby_dir', 1);
 
-$_CLASS['core_db']->add_table_field_int('user_post_show_days', 0, 200);
+$_CLASS['core_db']->add_table_field_int('user_post_show_days', array('max' => 200));
 $_CLASS['core_db']->add_table_field_char('user_post_sortby_type', 1);
 $_CLASS['core_db']->add_table_field_char('user_post_sortby_dir', 1);
 
-$_CLASS['core_db']->add_table_field_int('user_posts', 16000000);
-field_unix_time('user_lastpost_time');
+$_CLASS['core_db']->add_table_field_int('user_posts', array('max' => 16000000));
+field_unix_time('user_last_post_time');
 
-$_CLASS['core_db']->add_table_field_int('user_allow_viewonline', 0, 1, 1);
-$_CLASS['core_db']->add_table_field_int('user_allow_viewemail', 0, 1, 1);
-$_CLASS['core_db']->add_table_field_int('user_allow_massemail', 0, 1, 1);
+$_CLASS['core_db']->add_table_field_text('user_permissions', 60000); // phpBBs rename user_forums_permissions
 
-$_CLASS['core_db']->add_table_field_char('user_avatar', 200);
-$_CLASS['core_db']->add_table_field_int('user_avatar_type', 0, 10);
-$_CLASS['core_db']->add_table_field_int('user_avatar_width', 0, 100);
-$_CLASS['core_db']->add_table_field_int('user_avatar_height', 0, 100);
+// these can be null I think
+$_CLASS['core_db']->add_table_field_char('user_avatar', 200, null);
+$_CLASS['core_db']->add_table_field_int('user_avatar_type', array('max' => 10, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('user_avatar_width', array('max' => 100, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('user_avatar_height', array('max' => 100, 'null' => true));
 
-$_CLASS['core_db']->add_table_field_char('user_act_key', 40);
-$_CLASS['core_db']->add_table_field_char('user_new_password', 40);
-$_CLASS['core_db']->add_table_field_char('user_new_password_encoding', 10);
+$_CLASS['core_db']->add_table_field_int('user_rank', array('max' => 16000000, 'null' => true));
 
 $_CLASS['core_db']->add_table_index('user_id', 'primary');
 $_CLASS['core_db']->add_table_index('username');

Added: trunk/install/installer.php
===================================================================
--- trunk/install/installer.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/install/installer.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -0,0 +1,24 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+?>
\ No newline at end of file

Modified: trunk/modules/Control_Panel/index.php
===================================================================
--- trunk/modules/Control_Panel/index.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/modules/Control_Panel/index.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -29,7 +29,7 @@
 
 $ucp = new module();
 
-require($site_file_root.'includes/forums/functions_user.php');
+//require($site_file_root.'includes/forums/functions_user.php');
 
 //define the undefineds
 $_CLASS['core_template']->assign_array(array(

Modified: trunk/modules/Control_Panel/ucp/ucp_register.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -1,58 +1,54 @@
 <?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_register.php,v 1.28 2004/06/07 11:43:51 psotfx Exp $
-//
-// FILENAME  : ucp_register.php
-// STARTED   : Mon May 19, 2003
-// COPYRIGHT : ? 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class ucp_register extends module 
 {
 	function ucp_register($id, $mode)
 	{
 		global $site_file_root, $config, $_CLASS, $_CORE_CONFIG;
 		
-		$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link('Control_Panel&amp;mode=register'));
-		
 		if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_DISABLE)
 		{
 			trigger_error('UCP_REGISTER_DISABLE');
 		}
 
-		// Do not alter this first one to use request_var!
-		$confirm_id = request_var('confirm_id', '');
-		$coppa		= (isset($_REQUEST['coppa'])) ? !empty($_REQUEST['coppa']) : null;
-		$agreed		= (!empty($_POST['agreed'])) ? 1 : 0;
-		$submit		= (isset($_POST['submit'])) ? true : false;
-		$change_lang = request_var('change_lang', '');
-		$change_lang = (file_exists($site_file_root.'language/' . $change_lang . '/common.php')) ? $change_lang : '';
+		$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link('Control_Panel&amp;mode=register'));
 
-		if ($change_lang)
-		{
-			$submit = false;
-			$lang = $change_lang;
-			$_CLASS['core_user']->lang_name = $lang = $change_lang;
-			$_CLASS['core_user']->lang_path = $site_file_root.'language/' . $lang . '/';
-			$_CLASS['core_user']->lang = array();
-			$_CLASS['core_user']->add_lang(array('common', 'ucp'));
-		}
-		
-		//$cp = new custom_profile();
+		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
+		$submit		= isset($_POST['submit']);
 
-		$error = $data = $cp_data = $cp_error = array();
+		$error = $data = array();
+		$s_hidden_fields = '';
 
-		if (!$agreed)
+
+		if (!isset($_POST['agreed']))
 		{
 			if ($_CORE_CONFIG['user']['coppa_enable'] && is_null($coppa))
 			{
 				$now = explode(':', gmdate('m:j:Y'));
-				$coppa_birthday = $_CLASS['core_user']->format_date(mktime(12, 0, 0, $now[0], $now[1] - 1, $now[2] - 13, 0)); 
 
+				$coppa_birthday = $_CLASS['core_user']->format_date(mktime(12, 0, 0, $now[0], $now[1], $now[2] - 13), 'D M d, Y'); 
+
 				$_CLASS['core_template']->assign_array(array(
 					'L_COPPA_NO'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_BEFORE'], $coppa_birthday),
 					'L_COPPA_YES'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_ON_AFTER'], $coppa_birthday),
@@ -61,292 +57,147 @@
 					'U_COPPA_YES'		=> generate_link('Control_Panel&amp;mode=register&amp;coppa=1'), 
 
 					'S_SHOW_COPPA'		=> true, 
+					'S_HIDDEN_FIELDS'	=> $s_hidden_fields,
 					'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register'))
 				);
 			}
 			else
 			{
+				$s_hidden_fields .= '<input type="hidden" name="coppa" value="' . $coppa . '" />';
+
 				$_CLASS['core_template']->assign_array(array(
-					'S_SHOW_COPPA'		=> false, 
-					'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register'))
-				);
+					'S_SHOW_COPPA'		=> false,
+					'S_HIDDEN_FIELDS'	=> $s_hidden_fields,
+					'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register')
+				));
 			}
-			
+
 			$this->display($_CLASS['core_user']->lang['REGISTER'], 'ucp_agreement.html');
 
 			script_close();
 		}
-		
-		$var_ary = array(
-			'username'			=> (string) '',
-			'password_confirm'	=> (string) '',
-			'new_password'		=> (string) '',
-			'cur_password'		=> (string) '',
-			'email'				=> (string) '',
-			'email_confirm'		=> (string) '',
-			'confirm_code'		=> (string) '',
-			'lang'				=> (string) $_CORE_CONFIG['global']['default_lang'],
-			'tz'				=> (float) $_CORE_CONFIG['global']['default_timezone'],
-		);
 
-		// If we change the language inline, we do not want to display errors, but pre-fill already filled out values
-		if ($change_lang)
-		{
-			foreach ($var_ary as $var => $default)
-			{
-				$$var = request_var($var, $default);
-			}
-		}
-		
-		// Check and initialize some variables if needed
 		if ($submit)
 		{
-			foreach ($var_ary as $var => $default)
-			{
-				$data[$var] = request_var($var, $default);
-			}
+			require_once($site_file_root.'includes/functions_user.php');
 
-			$var_ary = array(
-				'username'			=> array(
-					array('string', false, $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
-					array('username')),
-				'password_confirm'	=> array('string', false, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
-				'new_password'		=> array('string', false, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
-				'email'				=> array(
-					array('string', false, 6, 60), 
-					array('email')),
-				'email_confirm'		=> array('string', false, 6, 60), 
-				'confirm_code'		=> array('string', !($_CORE_CONFIG['user']['enable_confirm']), 6, 6), 
-				'tz'				=> array('num', false, -13, 13),
-				'lang'				=> array('match', false, '#^[a-z_]{2,}$#i'),
-			);
+			$error = array();
 
-			$error = validate_data($data, $var_ary);
-			extract($data);
-			unset($data);
+			$username	= get_variable('username', 'POST', false);
+			$password	= get_variable('password', 'POST', false);
+			$email		= get_variable('email', 'POST', false);
+			
+			//when we add this make sure to confirm that it's one of the installed langs
+			$lang		= $_CORE_CONFIG['global']['default_lang'];
+			$tz			= get_variable('tz', 'POST', false);
 
-			// Replace "error" strings with their real, localised form
-			$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
+			if (strpos($username, "\n"))
+			{
+				die;
+			}
 
-			// validate custom profile fields
-			//$cp->submit_cp_field('register', $_CLASS['core_user']->get_iso_lang_id(), $cp_data, $error);
+			$username_validate = validate_username($username);
 
-			// Visual Confirmation handling
-			$wrong_confirm = false;
-			
-			if ($_CORE_CONFIG['user']['enable_confirm'])
+			if ($username_validate !== true)
 			{
-				$code = $_CLASS['core_user']->session_data_get('confirmation_code');
+				$error[] = $username_validate;
+			}
 
-				if (!$code || !$confirm_code || $code !== $confirm_code)
-				{
-					$error[] = $_CLASS['core_user']->lang['CONFIRM_CODE_WRONG'];
-					$wrong_confirm = true;
-				}
+			if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
+			{
+				$error[] = 'PASSWORD_ERROR';
 			}
 
-			if (!sizeof($error))
+			if (!$email || $email !== get_variable('email_confirm', 'POST', ''))
 			{
-				if ($new_password != $password_confirm)
-				{
-					$error[] = 'NEW_PASSWORD_ERROR';
-				}
-				
-				if ($email != $email_confirm)
-				{
-					$error[] = 'NEW_EMAIL_ERROR';
-				}
+				$error[] = 'PASSWORD_ERROR';
 			}
-			
-			if (!sizeof($error))
+
+			if ($_CORE_CONFIG['user']['enable_confirm'])
 			{
-				$server_url = generate_board_url();
+				$confirmation_code = $_CLASS['core_user']->session_data_get('confirmation_code');
+				$confirm_code = trim(get_variable('confirm_code', 'POST', false));
 
-				// Which group by default?
-				$group_reg = ($coppa) ? 'REGISTERED_COPPA' : 'REGISTERED';
-				$group_inactive = ($coppa) ? 'INACTIVE_COPPA' : 'INACTIVE';
-				$group_name = ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_NONE) ? $group_reg : $group_inactive;
-
-				$sql = 'SELECT group_id
-					FROM ' . GROUPS_TABLE . " 
-					WHERE group_name = '$group_name'
-						AND group_type = " . GROUP_SPECIAL;
-				$result = $_CLASS['core_db']->query($sql);
-
-				if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
+				if (!$confirm_code || !$confirmation_code || $confirm_code != $confirmation_code)
 				{
-					trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
+					$error[] = $_CLASS['core_user']->lang['CONFIRM_CODE_WRONG'];
 				}
-				$_CLASS['core_db']->sql_freeresult($result);
 
-				$group_id = $row['group_id'];
+				// we don't need this any more
+				$_CLASS['core_user']->user_data_kill('confirmation_code');
+			}
 
-				if (($coppa || 
-					$_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || 
-					$_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN) && $_CORE_CONFIG['email']['email_enable'])
+		//$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
+			if (empty($error))
+			{
+				// Tz need to be moved out of the lang file, only use it for languages
+				if (!$tz || !in_array($tz, $_CLASS['core_user']->lang['tz']['zones']))
 				{
-					$user_actkey = gen_rand_string(10);
-					$key_len = 54 - (strlen($server_url));
-					$key_len = ($key_len > 6) ? $key_len : 6;
-					$user_actkey = substr($user_actkey, 0, $key_len);
-					$user_type = USER_INACTIVE;
+					$tz = null;
 				}
-				else
+	
+				$password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
+	
+				if (!$password)
 				{
-					$user_type = USER_NORMAL;
-					$user_actkey = '';
+					//do some admin contact thing here
+					die('Try again later');
 				}
-
-				// Begin transaction ... should this screw up we can rollback
-				$_CLASS['core_db']->transaction();
-		
-				$sql_ary = array(
-					'username'			=> $username, 
-					'user_password'		=> md5($new_password),
-					'user_email'		=> $email, 
-					'group_id'			=> (int) $group_id, 
-					'user_timezone'		=> (float) $tz,
-					'user_lang'			=> $lang,
-					'user_allow_pm'		=> 1,
-					'user_type'			=> $user_type,
-					'user_actkey'		=> $user_actkey, 
-					'user_ip'			=> $_CLASS['core_user']->ip, 
-					'user_regdate'		=> time(),
-				);
-
-				$sql = 'INSERT INTO ' . USERS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary);
-				$_CLASS['core_db']->query($sql);
-
-				$user_id = $_CLASS['core_db']->insert_id();
-
-				// Insert Custom Profile Fields
-				/*if (sizeof($cp_data))
+	
+				if ($coppa || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
 				{
-					$cp_data['user_id'] = (int) $user_id;
-					$sql = 'INSERT INTO ' . PROFILE_DATA_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $cp->build_insert_sql_array($cp_data));
-					$_CLASS['core_db']->query($sql);
-				}*/
-
-				// Place into appropriate group, either REGISTERED(_COPPA) or INACTIVE(_COPPA) depending on config
-				$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-					'user_id'		=> (int) $user_id,
-					'group_id'		=> (int) $group_id,
-					'user_pending'	=> 0)
-				);
-				$_CLASS['core_db']->query($sql);
-
-				$_CLASS['core_db']->transaction('commit');
-
-				if ($coppa && $_CORE_CONFIG['email']['email_enable'])
-				{
-					$message = $_CLASS['core_user']->lang['ACCOUNT_COPPA'];
-					$email_template = 'coppa_welcome_inactive';
+					if (!$_CORE_CONFIG['email']['email_enable'])
+					{
+						//do some admin contact thing here
+						die('Try again later');
+					}
+	
+					$user_status = STATUS_PENDING;
+					$user_act_key = generate_string(10);
 				}
-				elseif ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF && $_CORE_CONFIG['email']['email_enable'])
-				{
-					$message = $_CLASS['core_user']->lang['ACCOUNT_INACTIVE'];
-					$email_template = 'user_welcome_inactive';
-				}
-				elseif ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN && $_CORE_CONFIG['email']['email_enable'])
-				{
-					$message = $_CLASS['core_user']->lang['ACCOUNT_INACTIVE_ADMIN'];
-					$email_template = 'admin_welcome_inactive';
-				}
 				else
 				{
-					$message = $_CLASS['core_user']->lang['ACCOUNT_ADDED'];
-					$email_template = 'user_welcome';
+					$user_status = STATUS_ACTIVE;
+					$user_act_key = null;
 				}
-
-				if ($_CORE_CONFIG['email']['email_enable'])
+	
+				if ($user_status === STATUS_ACTIVE)
 				{
-					require_once($site_file_root.'includes/forums/functions_messenger.php');
-
-					$messenger = new messenger(false);
-
-					$messenger->template($email_template, $lang);
-					
-					$messenger->replyto($config['board_contact']);
-					$messenger->to($email, $username);
-
-					$messenger->headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-					$messenger->headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']->data['user_id']);
-					$messenger->headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']->data['username']);
-					$messenger->headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']->ip);
-
-					$messenger->assign_vars(array(
-						'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
-						'WELCOME_MSG'   => sprintf($_CLASS['core_user']->lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
-						'USERNAME'		=> $username,
-						'PASSWORD'		=> $password_confirm,
-						'EMAIL_SIG'		=> str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']),
-						'U_ACTIVATE'	=> generate_link("Control_Panel&amp;mode=activate&u=$user_id&k=$user_actkey", array('sid' => false, 'full' => true))
-					));
-
-					if ($coppa)
-					{
-						$messenger->assign_vars(array(
-							'FAX_INFO'		=> $_CORE_CONFIG['user']['coppa_fax'],
-							'MAIL_INFO'		=> $_CORE_CONFIG['user']['coppa_mail'],
-							'EMAIL_ADDRESS' => $email,
-							'SITENAME'		=> $_CORE_CONFIG['global']['site_name'])
-						);
-					}
-
-					$messenger->send(NOTIFY_EMAIL);
-
-					if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
-					{
-						// Grab an array of user_id's with a_user permissions ... these users
-						// can activate a user
-						$admin_ary = $_CLASS['auth']->acl_get_list(false, 'a_user', false);
-
-						$sql = 'SELECT user_id, username, user_email, user_lang, user_jabber, user_notify_type
-							FROM ' . USERS_TABLE . ' 
-							WHERE user_id IN (' . implode(', ', $admin_ary[0]['a_user']) .')';
-						$result = $_CLASS['core_db']->query($sql);
-
-						while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-						{
-							$messenger->template('admin_activate', $row['user_lang']);
-							$messenger->replyto($config['board_contact']);
-							$messenger->to($row['user_email'], $row['username']);
-							$messenger->im($row['user_jabber'], $row['username']);
-
-							$messenger->assign_vars(array(
-								'USERNAME'		=> $username,
-								'EMAIL_SIG'		=> str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']),
-								'U_ACTIVATE'	=> generate_link("Control_Panel&amp;mode=activate&u=$user_id&k=$user_actkey", array('sid' => false, 'full' => true))
-							));
-
-							$messenger->send($row['user_notify_type']);
-						}
-						$_CLASS['core_db']->sql_freeresult($result);
-					}
+					set_core_config('user', 'newest_user_id', $row['user_id'], false);
+					set_core_config('user', 'newest_username', $row['username'], false);
+					set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + 1, false);
 				}
+	
+				$data = array(
+					'username'		=> $username,
+					'user_email'	=> $email,
+// add an option so admin can set with group they added to
+					'user_group'	=> ($coppa) ? 3 : 2,
+					'user_reg_date'	=> gmtime(),
+					'user_timezone'	=> $tz,
 
-				if ($user_type == USER_NORMAL || !$_CORE_CONFIG['email']['email_enable'])
-				{
-					set_config('newest_user_id', $user_id);
-					set_config('newest_username', $username);
-					set_config('num_users', $config['num_users'] + 1, true);
-				}
-				unset($data);
+					'user_password'			=> $password,
+					'user_password_encoding'=> $_CORE_CONFIG['user']['password_encoding'],
 
-				$message = $message . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_INDEX'],  '<a href="'. generate_link() .'">', '</a>');
-				trigger_error($message);
+					'user_lang'			=> ($lang == $_CORE_CONFIG['global']['default_lang']) ? null :$lang ,
+					'user_type'			=> USER_NORMAL,
+					'user_status'		=> $user_status,
+					'user_act_key'		=> $user_act_key,
+					'user_ip'			=> $_CLASS['core_user']->ip,
+				);
+
+				user_add($data);
 			}
 		}
 
-		$s_hidden_fields = '<input type="hidden" name="agreed" value="true" /><input type="hidden" name="coppa" value="' . $coppa . '" />';
-		$s_hidden_fields .= '<input type="hidden" name="change_lang" value="0" />';
-		
+		$s_hidden_fields .= '<input type="hidden" name="coppa" value="' . $coppa . '" />';
+		$s_hidden_fields .= '<input type="hidden" name="agreed" value="true" />';
 		$confirm_image = '';
 		
 		// Visual Confirmation - Show images
 		if ($_CORE_CONFIG['user']['enable_confirm'])
 		{
-			if (!$change_lang)
+			if ($submit)
 			{
 				if ($_CORE_CONFIG['user']['max_reg_attempts'])
 				{
@@ -359,59 +210,48 @@
 
 					$_CLASS['core_user']->session_data_get('reg_attempts', ($attempts + 1));
 				}
-				
+
 				$_CLASS['core_user']->session_data_set('confirmation_code', generate_string(6));
 			}
 
 			$confirm_image = '<img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" />';
 		}
 
-		// 
 		$l_reg_cond = '';
+
 		switch ($_CORE_CONFIG['user']['require_activation'])
 		{
 			case USER_ACTIVATION_SELF:
 				$l_reg_cond = $_CLASS['core_user']->lang['UCP_EMAIL_ACTIVATE'];
-				break;
+			break;
 
 			case USER_ACTIVATION_ADMIN:
 				$l_reg_cond = $_CLASS['core_user']->lang['UCP_ADMIN_ACTIVATE'];
-				break;
+			break;
 		}
 
 		$user_char_ary = array('.*' => 'USERNAME_CHARS_ANY', '[\w]+' => 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' => 'USERNAME_ALPHA_SPACERS');
 
-		$lang = (isset($lang)) ? $lang : $_CORE_CONFIG['global']['default_lang'];
-		$tz = (isset($tz)) ? $tz : $_CORE_CONFIG['global']['default_timezone'];
-
-		
 		$_CLASS['core_template']->assign(array(
-			'ERROR'						=> (sizeof($error)) ? implode('<br />', $error) : '', 
-			'USERNAME'					=> (isset($username)) ? $username : '',
-			'PASSWORD'					=> (isset($password)) ? $password : '',
-			'PASSWORD_CONFIRM'			=> (isset($password_confirm)) ? $password_confirm : '',
-			'EMAIL'						=> (isset($email)) ? $email : '',
-			'EMAIL_CONFIRM'				=> (isset($email_confirm)) ? $email_confirm : '',
+			'ERROR'						=> empty($error) ? false : implode('<br />', $error), 
+			'USERNAME'					=> isset($username) ? $username : '',
+			'PASSWORD'					=> isset($password) ? $password : '',
+			'EMAIL'						=> isset($email) ? $email : '',
+			'EMAIL_CONFIRM'				=> isset($email_confirm) ? $email_confirm : '', // should remove this also maybe
 			'CONFIRM_IMG'				=> $confirm_image,
 
 			'L_CONFIRM_EXPLAIN'			=> sprintf($_CLASS['core_user']->lang['CONFIRM_EXPLAIN'], '<a href="mailto:' . htmlentities($config['board_contact']) . '">', '</a>'), 
 			'L_ITEMS_REQUIRED'			=> $l_reg_cond, 
-			'L_USERNAME_EXPLAIN'		=> sprintf($_CLASS['core_user']->lang[$user_char_ary[str_replace('\\\\', '\\', $_CORE_CONFIG['user']['allow_name_chars'])] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
+			'L_USERNAME_EXPLAIN'		=> sprintf($_CLASS['core_user']->lang[$user_char_ary[$_CORE_CONFIG['user']['allow_name_chars']] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
 			'L_NEW_PASSWORD_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['NEW_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
 
-			'S_LANG_OPTIONS'	=> language_select($lang), 
-			'S_TZ_OPTIONS'		=> tz_select($tz),
-			'S_CONFIRM_CODE'	=> ($_CORE_CONFIG['user']['enable_confirm']),
+			//'S_LANG_OPTIONS'	=> language_select($lang), 
+			'S_TZ_OPTIONS'		=> tz_select(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
 			'S_COPPA'			=> $coppa, 
 			'S_HIDDEN_FIELDS'	=> $s_hidden_fields,
 			'S_UCP_ACTION'		=> generate_link("Control_Panel&amp;mode=register"))
 		);
 		
-		$_CLASS['core_user']->profile_fields = array();
-
-		// Generate profile fields -> Template Block Variable profile_fields
-		//$cp->generate_profile_fields('register', $_CLASS['core_user']->get_iso_lang_id());
-		
 		$this->display($_CLASS['core_user']->lang['REGISTER'], 'ucp_register.html');
 	}
 }

Modified: trunk/modules/Quick_Message/index.php
===================================================================
--- trunk/modules/Quick_Message/index.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/modules/Quick_Message/index.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -21,6 +21,9 @@
 	define('QUICK_MESSAGE_TABLE', 'test_quick_message');
 }
 
+$_CLASS['core_user']->user_setup();
+$_CLASS['core_user']->add_lang();
+
 switch (get_variable('mode', 'GET', false))
 {
 	case 'add':
@@ -28,12 +31,8 @@
 		{
 			url_redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
 		}
-	
-		$_CLASS['core_user']->user_setup();
-		$_CLASS['core_user']->add_lang();
 
 		$message = trim(get_variable('message', 'POST', false));
-		$_CORE_CONFIG['quick_message']['lastpost_check'] = 300;
 
 		if (!$message)
 		{
@@ -50,14 +49,14 @@
 		$message 	= htmlentities($message, ENT_QUOTES, 'UTF-8');
 
 	// use limit
-		$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['lastpost_check']));
+		$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['last_post_check']));
 		$count = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
 	// add a count check here so it admin ajustable
 		if ($count['count'] > 0)
 		{
-			trigger_error(sprintf($_CLASS['core_user']->lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['lastpost_check'] / 60));
+			trigger_error(sprintf($_CLASS['core_user']->lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['last_post_check'] / 60));
 		}
 
 		$_CLASS['core_db']->free_result($result);
@@ -133,9 +132,6 @@
 	break;
 }
 
-$_CLASS['core_user']->user_setup();
-$_CLASS['core_user']->add_lang();
-
 $start = get_variable('start', 'GET', 0, 'integer');
 $limit = 20;
 
@@ -221,10 +217,13 @@
 $row = $_CLASS['core_db']->fetch_row_assoc($result);
 $_CLASS['core_db']->free_result($result);	
 
+$pagination = generate_pagination('Quick_Message', $row['total'], $limit, $start);
+
 $_CLASS['core_template']->assign_array(array(
-	'Q_MESSAGE_PAGINATION'	=> generate_pagination('Quick_Message', $row['total'], $limit, $start, false, 'Q_MESSAGE_'),
-	'Q_PAGE_NUMBER'			=> on_page($row['total'], $limit, $start),
-	'Q_TOTAL_MESSAGES'		=> $row['total']
+	'Q_MESSAGE_PAGINATION'			=> $pagination['formated'],
+	'Q_MESSAGE_PAGINATION_ARRAY'	=> $pagination['array'],
+	'Q_PAGE_NUMBER'					=> on_page($row['total'], $limit, $start),
+	'Q_TOTAL_MESSAGES'				=> $row['total']
 ));
 
 $_CLASS['core_display']->display(false, 'modules/Quick_Message/index.html');

Modified: trunk/modules/Quick_Message/install.php
===================================================================
--- trunk/modules/Quick_Message/install.php	2005-08-19 01:49:31 UTC (rev 87)
+++ trunk/modules/Quick_Message/install.php	2005-08-22 15:55:13 UTC (rev 88)
@@ -33,6 +33,7 @@
 
 $_CLASS['core_db']->table_create('commit');
 
+// use set config ?
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'anonymous_posting', '2', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'delete_time', '300', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'height', '200', 1)");



From viperal at berlios.de  Wed Aug 24 17:00:32 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 24 Aug 2005 17:00:32 +0200
Subject: [Viperals-svncheckins] r89 - in trunk: blocks includes includes/db includes/forums includes/forums/admin javascript modules/Control_Panel/ucp
Message-ID: <200508241500.j7OF0WQC026303@sheep.berlios.de>

Author: viperal
Date: 2005-08-24 17:00:26 +0200 (Wed, 24 Aug 2005)
New Revision: 89

Removed:
   trunk/includes/forums/admin/admin_bots.php
   trunk/includes/forums/admin/admin_groups.php
   trunk/includes/forums/admin/admin_users.php
Modified:
   trunk/blocks/block-Demo_Block.php
   trunk/blocks/block-Google.php
   trunk/blocks/block-theme_select.php
   trunk/includes/db/mysql.php
   trunk/includes/forums/functions.php
   trunk/includes/forums/message_parser.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/session.php
   trunk/javascript/collapse.js
   trunk/javascript/menu.js
   trunk/modules/Control_Panel/ucp/ucp_groups.php
   trunk/modules/Control_Panel/ucp/ucp_prefs.php
   trunk/modules/Control_Panel/ucp/ucp_register.php
Log:


Modified: trunk/blocks/block-Demo_Block.php
===================================================================
--- trunk/blocks/block-Demo_Block.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/blocks/block-Demo_Block.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,16 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (!defined('VIPERAL'))
 {
     die;

Modified: trunk/blocks/block-Google.php
===================================================================
--- trunk/blocks/block-Google.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/blocks/block-Google.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,15 +1,25 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
 
 if (!defined('VIPERAL'))
 {
@@ -29,7 +39,7 @@
 	<input name="domains" value="'.$Site_domain.'" type="hidden" />
 	<input name="q" size="15" maxlength="200" value="" type="text" />
 	<input name="sitesearch" value="'.$Site_domain.'" type="hidden" />
-	<br /><br /><input class="bottom" name="btnG" value="Search" type="submit" />
+	<br /><br /><input class="button" name="btnG" value="Search" type="submit" />
 </form>
 </div>';
 

Modified: trunk/blocks/block-theme_select.php
===================================================================
--- trunk/blocks/block-theme_select.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/blocks/block-theme_select.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,16 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (!defined('VIPERAL'))
 {
     die;
@@ -19,7 +29,7 @@
 $this->content = '
 <form action="" method="post">
 	<p style="text-align: center;">
-		<select name="prevtheme" onchange="this.form.submit();">'.theme_select().'</select>
+		<select name="prevtheme" onchange="this.form.submit();">'.select_theme().'</select>
 		<br /><br /><input class="button" value="Select" type="submit" />
 	</p>
 </form>';

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/db/mysql.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -449,9 +449,10 @@
 		switch ($mode)
 		{
 			case 'start':
-				if (empty($_CORE_CONFIG['global']['error']) || $_CORE_CONFIG['global']['error'] == ERROR_DEBUGGER)
+// this is done even for none admins ( need to fix this )
+				if (empty($_CORE_CONFIG['server']['error_options']) || $_CORE_CONFIG['server']['error_options'] == ERROR_DEBUGGER)
 				{
-					if (strpos('SELECT', $this->last_query) === 0)
+					if (strpos($this->last_query, 'SELECT') !== false)
 					{
 						if ($result = @mysql_query('EXPLAIN '.$this->last_query, $this->link_identifier))
 						{
@@ -478,7 +479,7 @@
 				$end_time = $end_time[0] + $end_time[1];
 				$this->queries_time += $end_time - $start_time;
 
-				if (empty($_CORE_CONFIG['global']['error']) || $_CORE_CONFIG['global']['error'] == ERROR_DEBUGGER)
+				if (empty($_CORE_CONFIG['server']['error_options']) || $_CORE_CONFIG['server']['error_options'] == ERROR_DEBUGGER)
 				{
 					if ($this->last_result !== false)
 					{

Deleted: trunk/includes/forums/admin/admin_bots.php
===================================================================
--- trunk/includes/forums/admin/admin_bots.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/admin/admin_bots.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,372 +0,0 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: admin_bots.php,v 1.3 2003/10/21 00:15:28 psotfx Exp $
-//
-// FILENAME  : admin_bots.php 
-// STARTED   : Tue Oct 15, 2003
-// COPYRIGHT : ? 2001, 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Do we have permission?
-if (!$_CLASS['auth']->acl_get('a_server'))
-{
-	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-}
-
-// Set various vars
-$submit = (isset($_POST['submit'])) ? true : false;
-$action = request_var('action', '');
-$mark	= request_var('mark', 0);
-$id		= request_var('id', 0);
-
-if (isset($_POST['add']))
-{
-	$action = 'add';
-}
-
-$error = array();
-
-// User wants to do something, how inconsiderate of them!
-switch ($action)
-{
-	case 'activate':
-		if ($id || $mark)
-		{
-			$id = ($id) ? " = $id" : ' IN (' . implode(', ', $mark) . ')';
-			$sql = 'UPDATE ' . BOTS_TABLE . " 
-				SET bot_active = 1
-				WHERE bot_id $id";
-			$db->sql_query($sql);
-		}
-		break;
-
-	case 'deactivate':
-		if ($id || $mark)
-		{
-			$id = ($id) ? " = $id" : ' IN (' . implode(', ', $mark) . ')';
-			$sql = 'UPDATE ' . BOTS_TABLE . " 
-				SET bot_active = 0
-				WHERE bot_id $id";
-			$db->sql_query($sql);
-		}
-		break;
-
-	case 'delete':
-		if ($id || $mark)
-		{
-			// We need to delete the relevant user, usergroup and bot entries ...
-			$id = ($id) ? " = $id" : ' IN (' . implode(', ', $mark) . ')';
-			$sql = 'SELECT bot_name, user_id 
-				FROM ' . BOTS_TABLE . " 
-				WHERE bot_id $id";
-			$result = $db->sql_query($sql);
-
-			$user_id_ary = $bot_name_ary = array();
-			while ($row = $db->sql_fetchrow($result))
-			{
-				$user_id_ary[] = (int) $row['user_id'];
-				$bot_name_ary[] = $row['bot_name'];
-			}
-			$db->sql_freeresult($result);
-
-			$db->sql_transaction();
-
-			$sql = 'DELETE FROM ' . BOTS_TABLE . " 
-				WHERE bot_id $id";
-			$db->sql_query($sql);
-
-			foreach (array(USERS_TABLE, USER_GROUP_TABLE) as $table)
-			{
-				$sql = "DELETE FROM $table
-					WHERE user_id IN (" . implode(', ', $user_id_ary) . ')';
-				$db->sql_query($sql);
-			}
-
-			$db->sql_transaction('commit');
-
-			add_log('admin', 'LOG_BOT_DELETE', implode(', ', $bot_name_ary));
-			trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
-		}
-		break;
-
-	case 'edit':
-	case 'add':
-		$bot_name	= request_var('bot_name', '');
-		$bot_agent	= request_var('bot_agent', '');
-		$bot_ip		= request_var('bot_ip', '');
-		$bot_active = request_var('bot_active', true);
-		$bot_lang	= request_var('bot_lang', $_CORE_CONFIG['global']['default_lang']);
-		$bot_theme	= request_var('bot_theme' , $_CORE_CONFIG['global']['default_theme']);
-
-		if ($submit)
-		{
-			if (!$bot_agent && !$bot_ip)
-			{
-				$error[] = $_CLASS['core_user']->lang['ERR_BOT_NO_MATCHES'];
-			}
-			if ($bot_ip && !preg_match('#^[\d\.,:]+$#', $bot_ip))
-			{
-				if (!$ip_list = gethostbynamel($bot_ip))
-				{
-					$error[] = $_CLASS['core_user']->lang['ERR_BOT_NO_IP'];
-				}
-				else
-				{
-					$bot_ip = implode(',', $ip_list);
-				}
-			}
-			$bot_ip = str_replace(' ', '', $bot_ip);
-
-			if (!sizeof($error))
-			{
-				$db->sql_transaction();
-
-				// New bot? Create a new user and group entry
-				if ($action == 'add')
-				{
-					$sql = 'SELECT group_id, group_colour 
-						FROM ' . GROUPS_TABLE . " 
-						WHERE group_name = 'BOTS' 
-							AND group_type = " . GROUP_SPECIAL;
-					$result = $db->sql_query($sql);
-
-					if (!extract($db->sql_fetchrow($result)))
-					{
-						trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-					}
-					$db->sql_freeresult($result);
-
-					$sql = 'INSERT INTO ' . USERS_TABLE . ' ' . $db->sql_build_array('INSERT', array(
-						'group_id'		=> (int) $group_id, 
-						'username'		=> (string) $bot_name, 
-						'user_type'		=> (int) USER_IGNORE, 
-						'user_colour'	=> (string) $group_colour,
-						'user_lang'		=> (string) $bot_lang, 
-						'theme'			=> (string) $bot_theme,
-						'user_options'	=> 0)
-					);
-					$db->sql_query($sql);
-
-					$user_id = $db->sql_nextid();
-
-					// Add to Bots usergroup
-					$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $db->sql_build_array('INSERT', array(
-						'user_id'	=> $user_id, 
-						'group_id'	=> $group_id)
-					);
-					$db->sql_query($sql);
-
-					$sql = 'INSERT INTO ' . BOTS_TABLE . ' ' . $db->sql_build_array('INSERT', array(
-						'user_id'		=> (int) $user_id,
-						'bot_name'		=> (string) $bot_name, 
-						'bot_active'	=> (int) $bot_active, 
-						'bot_agent'		=> (string) $bot_agent,
-						'bot_ip'		=> (string) $bot_ip,)
-					);
-
-					$log = 'ADDED';
-				}
-				else
-				{
-					$sql = 'SELECT user_id 
-						FROM ' . BOTS_TABLE . " 
-						WHERE bot_id = $id";
-					$result = $db->sql_query($sql);
-
-					if (!extract($db->sql_fetchrow($result)))
-					{
-						trigger_error($_CLASS['core_user']->lang['NO_BOT']);
-					}
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $db->sql_build_array('UPDATE', array(
-						'theme'			=> (string) $bot_theme,
-						'user_lang'		=> (string) $bot_lang,)
-					) . " WHERE user_id = $user_id";
-					$db->sql_query($sql);
-
-					$sql = 'UPDATE ' . BOTS_TABLE . ' SET ' . $db->sql_build_array('UPDATE', array(
-						'bot_name'		=> (string) $bot_name, 
-						'bot_active'	=> (int) $bot_active, 
-						'bot_agent'		=> (string) $bot_agent,
-						'bot_ip'		=> (string) $bot_ip,)
-					) . " WHERE bot_id = $id";
-
-					$log = 'UPDATED';
-				}
-				$db->sql_query($sql);
-
-				$db->sql_transaction('commit');
-
-				add_log('admin', 'LOG_BOT_' . $log, $bot_name);
-				trigger_error($_CLASS['core_user']->lang['BOT_' . $log]);
-			}
-		}
-		else if ($id)
-		{
-			$sql = 'SELECT b.*, u.user_lang, u.theme 
-				FROM ' . BOTS_TABLE . ' b, ' . USERS_TABLE . " u
-				WHERE b.bot_id = $id
-					AND u.user_id = b.user_id";
-			$result = $db->sql_query($sql);
-
-			if (!extract($db->sql_fetchrow($result)))
-			{
-				trigger_error($_CLASS['core_user']->lang['NO_BOT']);
-			}
-			$db->sql_freeresult($result);
-
-			$bot_lang = $user_lang;
-			$bot_theme = $theme;
-		}
-
-		$s_active_options = '';
-		foreach (array('0' => 'NO', '1' => 'YES') as $value => $lang)
-		{
-			$selected = ($bot_active == $value) ? ' selected="selected"' : '';
-			$s_active_options .= '<option value="' . $value . '"' . $selected . '>' . $_CLASS['core_user']->lang[$lang] . '</option>';
-		}
-
-		$theme_select = theme_select($bot_theme);
-		$lang_select = language_select($bot_lang);
-
-		$l_title = ($action == 'edit') ? 'EDIT' : 'ADD';
-
-		// Output relevant page
-		adm_page_header($_CLASS['core_user']->lang['BOT_' . $l_title]);
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['BOT_' . $l_title]; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['BOT_EDIT_EXPLAIN']; ?></p>
-
-<form method="post" action="<?php echo adminlink("forums&amp;file=admin_bots&amp;action=$action&amp;id=$id"); ?>"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['BOT_' . $l_title]; ?></th>
-	</tr>
-<?php
-
-	if (sizeof($error))
-	{
-
-?>
-	<tr>
-		<td class="row3" colspan="2" align="center"><span style="color:red"><?php echo implode('<br />', $error); ?></span></td>
-	</tr>
-<?php
-
-	}
-
-?>
-	<tr>
-		<td class="row1" width="40%"><b class="genmed"><?php echo $_CLASS['core_user']->lang['BOT_NAME']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['BOT_NAME_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" name="bot_name" size="30" maxlength="255" value="<?php echo $bot_name; ?>" /></td>
-	</tr>
-	<tr>
-		<td class="row1" width="40%"><b class="genmed"><?php echo $_CLASS['core_user']->lang['BOT_STYLE']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['BOT_STYLE_EXPLAIN']; ?></span></td>
-		<td class="row2"><select name="bot_theme"><?php echo $theme_select; ?></select></td>
-	</tr>
-	<tr>
-		<td class="row1" width="40%"><b class="genmed"><?php echo $_CLASS['core_user']->lang['BOT_LANG']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['BOT_LANG_EXPLAIN']; ?></span></td>
-		<td class="row2"><select name="bot_lang"><?php echo $lang_select; ?></select></td>
-	</tr>
-	<tr>
-		<td class="row1" width="40%"><b class="genmed"><?php echo $_CLASS['core_user']->lang['BOT_ACTIVE']; ?>: </b></td>
-		<td class="row2"><select name="bot_active"><?php echo $s_active_options; ?></select></td>
-	</tr>
-	<tr>
-		<td class="row1" width="40%"><b class="genmed"><?php echo $_CLASS['core_user']->lang['BOT_AGENT']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['BOT_AGENT_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" name="bot_agent" size="30" maxlength="255" value="<?php echo $bot_agent; ?>" /></td>
-	</tr>
-	<tr>
-		<td class="row1" width="40%"><b class="genmed"><?php echo $_CLASS['core_user']->lang['BOT_IP']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['BOT_IP_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" name="bot_ip" size="30" maxlength="255" value="<?php echo $bot_ip; ?>" /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="submit" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-	</tr>
-</table></form>
-
-<?php
-
-		adm_page_footer();
-
-		break;
-}
-
-// Output relevant page
-adm_page_header($_CLASS['core_user']->lang['BOTS']);
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['BOTS']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['BOTS_EXPLAIN']; ?></p>
-
-<form method="post" action="<?php adminlink('forums&amp;file=admin_bots'); ?>"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['BOT_NAME']; ?></th>
-		<th nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['BOT_LAST_VISIT']; ?></th>
-		<th colspan="3" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['OPTIONS']; ?></th>
-		<th nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['MARK']; ?></th>
-	</tr>
-<?php
-
-$s_options = '';
-foreach (array('activate' => 'BOT_ACTIVATE', 'deactivate' => 'BOT_DEACTIVATE', 'delete' => 'DELETE') as $value => $lang)
-{
-	$s_options .= '<option value="' . $value . '">' . $_CLASS['core_user']->lang[$lang] . '</option>';
-}
-
-$sql = 'SELECT b.bot_id, b.bot_name, b.bot_active, u.user_lastvisit 
-	FROM ' . BOTS_TABLE . ' b, ' . USERS_TABLE . ' u
-	WHERE u.user_id = b.user_id
-	ORDER BY u.user_lastvisit DESC';
-$result = $db->sql_query($sql);
-
-$row_class = 'row1';
-while ($row = $db->sql_fetchrow($result))
-{
-	$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-	$active_lang = (!$row['bot_active']) ? 'BOT_ACTIVATE' : 'BOT_DEACTIVATE';
-	$active_value = (!$row['bot_active']) ? 'activate' : 'deactivate';
-	$id = $row['bot_id'];
-
-?>	
-	<tr>
-		<td class="<?php echo $row_class; ?>" width="50%"><?php echo $row['bot_name']; ?></td>
-		<td class="<?php echo $row_class; ?>" width="15%" align="center" nowrap="nowrap">&nbsp;<?php echo ($row['user_lastvisit']) ?  $_CLASS['core_user']->format_date($row['user_lastvisit']) : $_CLASS['core_user']->lang['BOT_NEVER']; ?>&nbsp;</td>
-		<td class="<?php echo $row_class; ?>" width="1%"align="center">&nbsp;<a href="<?php echo adminlink("forums&amp;file=admin_bots&amp;id=$id&amp;action=$active_value"); ?>"><?php echo $_CLASS['core_user']->lang[$active_lang]; ?></a>&nbsp;</td>
-		<td class="<?php echo $row_class; ?>" width="1%" align="center">&nbsp;<a href="<?php echo adminlink("forums&amp;file=admin_bots&amp;id=$id&amp;action=edit"); ?>"><?php echo $_CLASS['core_user']->lang['EDIT']; ?></a>&nbsp;</td>
-		<td class="<?php echo $row_class; ?>" width="1%" align="center">&nbsp;<a href="<?php echo adminlink("forums&amp;file=admin_bots&amp;id=$id&amp;action=delete"); ?>"><?php echo $_CLASS['core_user']->lang['DELETE']; ?></a>&nbsp;</td>
-		<td class="<?php echo $row_class; ?>" width="1%" align="center"><input type="checkbox" name="mark[]" value="<?php echo $id; ?>" /></td>
-	</tr>
-<?php
-
-}
-$db->sql_freeresult($result);
-
-?>
-	<tr>
-		<td class="cat" colspan="6"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-			<tr>
-				<td><input class="btnlite" type="submit" name="add" value="<?php echo $_CLASS['core_user']->lang['BOT_ADD']; ?>" /></td>
-				<td align="right"><select name="action"><?php echo $s_options; ?></select> <input class="btnlite" type="submit" name="submit" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" /></td>
-			</tr>
-		</table></td>
-	</tr>
-</table></form>
-<?php
-
-adm_page_footer();
-
-?>
\ No newline at end of file

Deleted: trunk/includes/forums/admin/admin_groups.php
===================================================================
--- trunk/includes/forums/admin/admin_groups.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/admin/admin_groups.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,902 +0,0 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: admin_groups.php,v 1.18 2004/05/02 13:05:36 acydburn Exp $
-//
-// FILENAME  : admin_groups.php
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : ? 2001,2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-// TODO
-// Avatar gallery ...
-// Mass user pref setting via group membership
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-require_once($site_file_root.'includes/forums/functions_user.'.$phpEx);
-
-// Do we have general permissions?
-if (!$_CLASS['auth']->acl_get('a_group'))
-{
-	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-}
-
-// Check and set some common vars
-$mode		= request_var('mode', '');
-$action		= (isset($_POST['add'])) ? 'add' : ((isset($_POST['addusers'])) ? 'addusers' : request_var('action', ''));
-$group_id	= request_var('g', 0);
-$mark_ary   = request_var('mark', array(0));
-$name_ary	= request_var('usernames', '');
-$leader		= request_var('leader', 0);
-$default	= request_var('default', 0);
-$start		= request_var('start', 0);
-$update		= (isset($_POST['update'])) ? true : false;
-$confirm	= (isset($_POST['confirm'])) ? true : false;
-$cancel		= (isset($_POST['cancel'])) ? true : false;
-
-// Clear some vars
-$can_upload = (file_exists($config['avatar_path']) && is_writeable($config['avatar_path']) && $file_uploads) ? true : false;
-
-$group_type = $group_name = $group_desc = $group_colour = $group_rank = $group_avatar = false;
-
-// Grab basic data for group, if group_id is set and exists
-if ($group_id)
-{
-	$sql = 'SELECT * 
-		FROM ' . GROUPS_TABLE . " 
-		WHERE group_id = $group_id";
-	$result = $db->sql_query($sql);
-
-	if (!extract($db->sql_fetchrow($result)))
-	{
-		trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-	}
-	$db->sql_freeresult($result);
-}
-
-switch ($mode)
-{
-	case 'manage':
-		// Page header
-		adm_page_header($_CLASS['core_user']->lang['MANAGE']);
-
-		// Common javascript
-?>
-
-<script language="Javascript" type="text/javascript">
-<!--
-function marklist(match, status)
-{
-	len = eval('document.' + match + '.length');
-	for (i = 0; i < len; i++)
-	{
-		eval('document.' + match + '.elements[i].checked = ' + status);
-	}
-}
-
-//-->
-</script>
-
-<?php
-
-		// Which page?
-		switch ($action)
-		{
-			case 'approve':
-			case 'demote':
-			case 'promote':
-				if (!$group_id)
-				{
-					trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-				}
-
-				group_user_attributes($action, $group_id, $mark_ary, false, $group_name);
-
-				switch ($action)
-				{
-					case 'demote':
-						$message = 'GROUP_MODS_DEMOTED';
-						break;
-					case 'promote':
-						$message = 'GROUP_MODS_PROMOTED';
-						break;
-					case 'approve':
-						$message = 'USERS_APPROVED';
-						break;
-				}
-				trigger_error($_CLASS['core_user']->lang[$message]);
-				break;
-
-			case 'default':
-				if (!$group_id)
-				{
-					trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-				}
-
-				if (!$mark_ary)
-				{
-					$start = 0;
-					do
-					{
-						$sql = 'SELECT user_id 
-							FROM ' . USER_GROUP_TABLE . "
-							WHERE group_id = $group_id 
-							ORDER BY user_id 
-							LIMIT $start, 200";
-						$result = $db->sql_query($sql);
-
-						$mark_ary = array();
-						if ($row = $db->sql_fetchrow($result))
-						{
-							do
-							{
-								$mark_ary[] = $row['user_id'];
-							}
-							while ($row = $db->sql_fetchrow($result));
-
-							group_user_attributes('default', $group_id, $mark_ary, false, $group_name, $group_colour, $group_rank, $group_avatar, $group_avatar_type, $group_avatar_width, $group_avatar_height);
-
-							$start = (sizeof($user_id_ary) < 200) ? 0 : $start + 200;
-						}
-						else
-						{
-							$start = 0;
-						}
-						$db->sql_freeresult($result);
-					}
-					while ($start);
-				}
-				else
-				{
-					group_user_attributes('default', $group_id, $mark_ary, false, $group_name, $group_colour, $group_rank, $group_avatar, $group_avatar_type, $group_avatar_width, $group_avatar_height);
-				}
-
-				trigger_error($_CLASS['core_user']->lang['GROUP_DEFS_UPDATED']);
-				break;
-
-			case 'deleteusers':
-			case 'delete':
-				if (!$cancel && !$confirm)
-				{
-					adm_page_confirm($_CLASS['core_user']->lang['CONFIRM'], $_CLASS['core_user']->lang['CONFIRM_OPERATION']);
-				}
-				else
-				{
-					if (!$group_id)
-					{
-						trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-					}
-
-					switch ($action)
-					{
-						case 'delete':
-							$error = group_delete($group_id, $group_name);
-							break;
-
-						case 'deleteusers':
-							$error = group_user_del($group_id, $mark_ary, false, $group_name);
-							break;
-					}
-
-					if ($error)
-					{
-						trigger_error($_CLASS['core_user']->lang[$error]);
-					}
-
-					$message = ($action == 'delete') ? 'GROUP_DELETED' : 'GROUP_USERS_REMOVE';
-					trigger_error($_CLASS['core_user']->lang[$message]);
-				}
-				break;
-
-			case 'addusers':
-				if (!$group_id)
-				{
-					trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-				}
-
-				if (!$name_ary)
-				{
-					trigger_error($_CLASS['core_user']->lang['NO_USERS']);
-				}
-
-				$name_ary = array_unique(explode("\n", $name_ary));
-
-				// Add user/s to group
-				if ($error = group_user_add($group_id, false, $name_ary, $group_name, $default, $leader, $group_colour, $group_rank, $group_avatar, $group_avatar_type, $group_avatar_width, $group_avatar_height))
-				{
-					trigger_error($_CLASS['core_user']->lang[$error]);
-				}
-
-				$message = ($action == 'addleaders') ? 'GROUP_MODS_ADDED' : 'GROUP_USERS_ADDED';
-				trigger_error($_CLASS['core_user']->lang[$message]);
-				break;
-
-			case 'edit':
-			case 'add':
-
-				if ($action == 'edit' && !$group_id)
-				{
-					trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-				}
-
-				// Did we submit?
-				if ($update)
-				{
-					$group_name	= request_var('group_name', '');
-					$group_desc	= request_var('group_description', '');
-					$group_type	= request_var('group_type', 0);
-
-					$colour		= request_var('group_colour', '');
-					$rank		= request_var('group_rank', 0);
-
-					$data['uploadurl']	= request_var('uploadurl', '');
-					$data['remotelink'] = request_var('remotelink', '');
-					$delete				= request_var('delete', '');
-					$receive_pm			= isset($_REQUEST['group_receive_pm']) ? 1 : 0;
-					$message_limit		= request_var('group_message_limit', 0);
-
-					if (!empty($_FILES['uploadfile']['tmp_name']) || $data['uploadurl'] || $data['remotelink'])
-					{
-						$data['width']		= request_var('width', '');
-						$data['height']		= request_var('height', '');
-
-						// Avatar stuff
-						$var_ary = array(
-							'uploadurl'		=> array('string', true, 5, 255), 
-							'remotelink'	=> array('string', true, 5, 255), 
-							'width'			=> array('string', true, 1, 3), 
-							'height'		=> array('string', true, 1, 3), 
-						);
-
-						if (!($error = validate_data($data, $var_ary)))
-						{
-							$data['user_id'] = "g$group_id";
-
-							if ((!empty($_FILES['uploadfile']['tmp_name']) || $data['uploadurl']) && $can_upload)
-							{
-								list($avatar_type, $avatar, $avatar_width, $avatar_height) = avatar_upload($data, $error);
-							}
-							else if ($data['remotelink'])
-							{
-								list($avatar_type, $avatar, $avatar_width, $avatar_height) = avatar_remote($data, $error);
-							}
-						}
-					}
-					else if ($delete)
-					{
-						$avatar = '';
-						$avatar_type = $avatar_width = $avatar_height = 0;
-					}
-
-					if (($avatar && $group_avatar != $avatar) || $delete)
-					{
-						avatar_delete($group_avatar);
-					}
-
-					// Only set the rank, colour, etc. if it's changed or if we're adding a new
-					// group. This prevents existing group members being updated if no changes 
-					// were made.
-					foreach (array('rank', 'colour', 'avatar', 'avatar_type', 'avatar_width', 'avatar_height', 'receive_pm', 'message_limit') as $test)
-					{
-						${'group_' . $test} = ($action == 'add' || (isset($$test) && $$test != ${'group_' . $test})) ? $$test : false;
-					}
-
-					if (!($error = group_create($group_id, $group_type, $group_name, $group_description, $group_colour, $group_rank, $group_avatar, $group_avatar_type, $group_avatar_width, $group_avatar_height, $group_receive_pm, $group_message_limit)))
-					{
-						$message = ($action == 'edit') ? 'GROUP_UPDATED' : 'GROUP_CREATED';
-						trigger_error($message);
-					}
-				}
-				else if (!$group_id)
-				{
-					$group_name = request_var('group_name', '');
-					$group_description = $group_colour = $group_avatar = '';
-					$group_type = GROUP_FREE;
-				}
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['MANAGE']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['GROUP_EDIT_EXPLAIN']; ?></p>
-
-<?php 
-
-				$sql = 'SELECT * 
-					FROM ' . RANKS_TABLE . '
-					WHERE rank_special = 1
-					ORDER BY rank_title';
-				$result = $db->sql_query($sql);
-
-				$rank_options = '<option value="-1"' . ((empty($group_rank)) ? 'selected="selected" ' : '') . '>' . $_CLASS['core_user']->lang['USER_DEFAULT'] . '</option>';
-				if ($row = $db->sql_fetchrow($result))
-				{
-					do
-					{
-						$selected = (!empty($group_rank) && $row['rank_id'] == $group_rank) ? ' selected="selected"' : '';
-						$rank_options .= '<option value="' . $row['rank_id'] . '"' . $selected . '>' . $row['rank_title'] . '</option>';
-					}
-					while ($row = $db->sql_fetchrow($result));
-				}
-				$db->sql_freeresult($result);
-
-				$type_free		= ($group_type == GROUP_FREE) ? ' checked="checked"' : '';
-				$type_open		= ($group_type == GROUP_OPEN) ? ' checked="checked"' : '';
-				$type_closed	= ($group_type == GROUP_CLOSED) ? ' checked="checked"' : '';
-				$type_hidden	= ($group_type == GROUP_HIDDEN) ? ' checked="checked"' : '';
-
-				if ($group_avatar)
-				{
-					switch ($group_avatar_type)
-					{
-						case AVATAR_UPLOAD:
-							$avatar_img = $config['avatar_path'] . '/';
-							break;
-						case AVATAR_GALLERY:
-							$avatar_img = $config['avatar_gallery_path'] . '/';
-							break;
-					}
-					$avatar_img .= $group_avatar;
-
-					$avatar_img = '<img src="' . $avatar_img . '" width="' . $group_avatar_width . '" height="' . $group_avatar_height . '" border="0" alt="" />';
-				}
-				else
-				{
-					$avatar_img = '<img src="images/no_avatar.gif" alt="" />';
-				}
-
-?>
-
-<script language="javascript" type="text/javascript">
-<!--
-
-function swatch()
-{
-	window.open('<?php echo adminlink('forums&amp;file=swatch'); ?>?form=settings&name=group_colour', '_swatch', 'HEIGHT=115,resizable=yes,scrollbars=no,WIDTH=636');
-	return false;
-}
-
-//-->
-</script>
-
-<form name="settings" method="post" action="<?php echo adminlink("forums&amp;file=admin_groups&amp;mode=$mode&amp;action=$action&amp;g=$group_id"); ?>"<?php echo ($can_upload) ? ' enctype="multipart/form-data"' : ''; ?>><table class="bg" width="95%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['GROUP_DETAILS']; ?></th>
-	</tr>
-<?php
-
-				if (sizeof($error))
-				{
-
-?>
-	<tr>
-		<td class="row1" colspan="2" align="center"><span style="color:red"><?php echo implode('<br />', $error); ?></span></td>
-	</tr>
-<?php
-
-				}
-
-?>
-	<tr>
-		<td class="row2" width="40%"><b><?php echo $_CLASS['core_user']->lang['GROUP_NAME']; ?>:</b></td>
-		<td class="row1"><?php 
-	
-				if ($group_type != GROUP_SPECIAL)
-				{
-		
-?><input class="post" type="text" name="group_name" value="<?php echo (!empty($group_name)) ? $group_name : ''; ?>" size="40" maxlength="40" /><?php
-			
-				}
-				else
-				{
-				
-?><b><?php echo ($group_type == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $group_name] : $group_name; ?></b><?php
-	
-				}
-	
-?></td>
-	</tr>
-	<tr>
-		<td class="row2"><b><?php echo $_CLASS['core_user']->lang['GROUP_DESC']; ?>:</b></td>
-		<td class="row1"><input class="post" type="text" name="group_description" value="<?php echo (!empty($group_description)) ? $group_description : ''; ?>" size="40" maxlength="255" /></td>
-	</tr>
-<?php
-
-				if ($group_type != GROUP_SPECIAL)
-				{
-
-?>
-	<tr>
-		<td class="row2"><b><?php echo $_CLASS['core_user']->lang['GROUP_TYPE']; ?>:</b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['GROUP_TYPE_EXPLAIN']; ?></span></td>
-		<td class="row1" nowrap="nowrap"><input type="radio" name="group_type" value="<?php echo GROUP_FREE . '"' . $type_free; ?> /> <?php echo $_CLASS['core_user']->lang['GROUP_OPEN']; ?> &nbsp; <input type="radio" name="group_type" value="<?php echo GROUP_OPEN . '"' . $type_open; ?> /> <?php echo $_CLASS['core_user']->lang['GROUP_REQUEST']; ?> &nbsp; <input type="radio" name="group_type" value="<?php echo GROUP_CLOSED . '"' . $type_closed; ?> /> <?php echo $_CLASS['core_user']->lang['GROUP_CLOSED']; ?> &nbsp; <input type="radio" name="group_type" value="<?php echo GROUP_HIDDEN . '"' . $type_hidden; ?>" /> <?php echo $_CLASS['core_user']->lang['GROUP_HIDDEN']; ?></td>
-	</tr>
-<?php
-
-				}
-
-?>
-	<tr>
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['GROUP_SETTINGS_SAVE']; ?></th>
-	</tr>
-	<tr>
-		<td class="row2"><b><?php echo $_CLASS['core_user']->lang['GROUP_RECEIVE_PM']; ?>:</b></td>
-		<td class="row1" nowrap="nowrap"><input type="checkbox" name="group_receive_pm"<?php echo ($group_receive_pm) ? ' checked="checked"' : ''; ?> /></td>
-	</tr>
-	<tr>
-		<td class="row2"><b><?php echo $_CLASS['core_user']->lang['GROUP_MESSAGE_LIMIT']; ?>:</b></td>
-		<td class="row1" nowrap="nowrap"><input class="post" type="text" maxlength="4" size="4" name="group_message_limit" value="<?php echo $group_message_limit; ?>" /></td>
-	</tr>
-	<tr>
-		<td class="row2"><b><?php echo $_CLASS['core_user']->lang['GROUP_COLOR']; ?>:</b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['GROUP_COLOR_EXPLAIN']; ?></span></td>
-		<td class="row1" nowrap="nowrap"><input class="post" type="text" name="group_colour" value="<?php echo (!empty($group_colour)) ? $group_colour : ''; ?>" size="6" maxlength="6" /> &nbsp; [ <a href="<?php echo adminlink('forums&amp;file=swatch'); ?>" onclick="swatch();return false" target="_swatch"><?php echo $_CLASS['core_user']->lang['COLOUR_SWATCH']; ?></a> ]</td>
-	</tr>
-	<tr>
-		<td class="row2"><b><?php echo $_CLASS['core_user']->lang['GROUP_RANK']; ?>:</b></td>
-		<td class="row1"><select name="group_rank"><?php echo $rank_options; ?></select></td>
-	</tr>
-	<tr>
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['GROUP_AVATAR']; ?></th>
-	</tr>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['CURRENT_IMAGE']; ?>: </b><br /><span class="gensmall"><?php echo sprintf($_CLASS['core_user']->lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)); ?></span></td>
-		<td class="row1" align="center"><br /><?php echo $avatar_img; ?><br /><br /><input type="checkbox" name="delete" />&nbsp;<span class="gensmall"><?php echo $_CLASS['core_user']->lang['DELETE_AVATAR']; ?></span></td>
-	</tr>
-<?php
-
-			// Can we upload?
-			if ($can_upload)
-			{
-
-?>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['UPLOAD_AVATAR_FILE']; ?>: </b></td>
-		<td class="row1"><input type="hidden" name="MAX_FILE_SIZE" value="<?php echo $config['avatar_max_filesize']; ?>" /><input class="post" type="file" name="uploadfile" /></td>
-	</tr>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['UPLOAD_AVATAR_URL']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['UPLOAD_AVATAR_URL_EXPLAIN']; ?></span></td>
-		<td class="row1"><input class="post" type="text" name="uploadurl" size="40" value="<?php echo $avatar_url; ?>" /></td>
-	</tr>
-<?php
-
-			}
-
-?>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['LINK_REMOTE_AVATAR']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['LINK_REMOTE_AVATAR_EXPLAIN']; ?></span></td>
-		<td class="row1"><input class="post" type="text" name="remotelink" size="40" value="<?php echo $avatar_url; ?>" /></td>
-	</tr>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['LINK_REMOTE_SIZE']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['LINK_REMOTE_SIZE_EXPLAIN']; ?></span></td>
-		<td class="row1"><input class="post" type="text" name="width" size="3" value="<?php echo $group_avatar_width; ?>" /> <span class="gen">px X </span> <input class="post" type="text" name="height" size="3" value="<?php echo $group_avatar_height; ?>" /> <span class="gen">px</span></td>
-	</tr>
-<?php
-
-			// Do we have a gallery?
-			if ($config['null'] && !$display_gallery)
-			{
-
-?>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['AVATAR_GALLERY']; ?>: </b></td>
-		<td class="row1"><input class="btnlite" type="submit" name="displaygallery" value="<?php echo $_CLASS['core_user']->lang['DISPLAY_GALLERY']; ?>" /></td>
-	</tr>
-<?php
-			}
-
-			// Do we want to display it?
-			if ($config['null'] && $display_gallery)
-			{
-
-?>
-	<tr> 
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['AVATAR_GALLERY']; ?></th>
-	</tr>
-	<tr> 
-		<td class="cat" colspan="2" align="center" valign="middle"><span class="genmed"><?php echo $_CLASS['core_user']->lang['AVATAR_CATEGORY']; ?>: </span><select name="avatarcat">{S_CAT_OPTIONS}</select>&nbsp; <span class="genmed"><?php echo $_CLASS['core_user']->lang['AVATAR_PAGE']; ?>: </span><select name="avatarpage">{S_PAGE_OPTIONS}</select>&nbsp;<input class="btnlite" type="submit" value="<?php echo $_CLASS['core_user']->lang['GO']; ?>" name="avatargallery" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" colspan="2" align="center"><table cellspacing="1" cellpadding="4" border="0">
-		
-			<!-- BEGIN avatar_row -->
-			<tr> 
-				<!-- BEGIN avatar_column -->
-				<td class="row1" align="center"><img src="{avatar_row.avatar_column.AVATAR_IMAGE}" alt="{avatar_row.avatar_column.AVATAR_NAME}" title="{avatar_row.avatar_column.AVATAR_NAME}" /></td>
-				<!-- END avatar_column -->
-			</tr>
-			<tr>
-				<!-- BEGIN avatar_option_column -->
-				<td class="row2" align="center"><input type="radio" name="avatarselect" value="{avatar_row.avatar_option_column.S_OPTIONS_AVATAR}" /></td>
-				<!-- END avatar_option_column -->
-			</tr>
-			<!-- END avatar_row -->
-
-		</table></td>
-	</tr>
-<?php
-
-			}
-
-?>
-	<tr>
-		<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" /> &nbsp; <input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-	</tr>
-</table></form>
-<?php
-
-				adm_page_footer();
-				break;
-		}
-
-		if ($mode == 'list' || $group_id)
-		{
-			if (!$group_id)
-			{
-				trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-			}
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['GROUP_MEMBERS']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['GROUP_MEMBERS_EXPLAIN']; ?></p>
-
-<form name="list" method="post" action="<?php echo adminlink("forums&amp;file=admin_groups&amp;mode=$mode&amp;g=$group_id"); ?>"><table class="bg" width="95%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th width="55%"><?php echo $_CLASS['core_user']->lang['USERNAME']; ?></th>
-		<th width="3%" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['DEFAULT']; ?></th>
-		<th width="20%"><?php echo $_CLASS['core_user']->lang['JOINED']; ?></th>
-		<th width="20%"><?php echo $_CLASS['core_user']->lang['POSTS']; ?></th>
-		<th width="2%"><?php echo $_CLASS['core_user']->lang['MARK']; ?></th>
-	</tr>
-<?php
-
-				// Total number of group leaders
-				$sql = 'SELECT COUNT(user_id) AS total_leaders 
-					FROM ' . USER_GROUP_TABLE . " 
-					WHERE group_id = $group_id 
-						AND group_leader = 1";
-				$result = $db->sql_query($sql);
-
-				$total_leaders = ($row = $db->sql_fetchrow($result)) ? $row['total_leaders'] : 0;
-				$db->sql_freeresult($result);
-
-				// Total number of group members (non-leaders)
-				$sql = 'SELECT COUNT(user_id) AS total_members 
-					FROM ' . USER_GROUP_TABLE . " 
-					WHERE group_id = $group_id 
-						AND group_leader <> 1";
-				$result = $db->sql_query($sql);
-
-				$total_members = ($row = $db->sql_fetchrow($result)) ? $row['total_members'] : 0;
-				$db->sql_freeresult($result);
-
-				// Grab the members
-				$sql = 'SELECT u.user_id, u.username, u.user_regdate, u.user_posts, u.group_id, ug.group_leader, ug.user_pending 
-					FROM ' . USERS_TABLE . ' u, ' . USER_GROUP_TABLE . " ug 
-					WHERE ug.group_id = $group_id 
-						AND u.user_id = ug.user_id 
-					ORDER BY ug.group_leader DESC, ug.user_pending DESC, u.username 
-					LIMIT $start, " . $config['topics_per_page'];
-				$result = $db->sql_query($sql);
-
-				$leader = $member = 0;
-				$group_data = array();
-				if ($row = $db->sql_fetchrow($result))
-				{
-					do
-					{
-						$type = ($row['group_leader']) ? 'leader' : 'member';
-
-						$group_data[$type][$$type]['user_id'] = $row['user_id'];
-						$group_data[$type][$$type]['group_id'] = $row['group_id'];
-						$group_data[$type][$$type]['username'] = $row['username'];
-						$group_data[$type][$$type]['user_regdate'] = $row['user_regdate'];
-						$group_data[$type][$$type]['user_posts'] = $row['user_posts'];
-						$group_data[$type][$$type]['user_pending'] = ($row['user_pending']) ? 1 : 0;
-
-						$$type++;
-					}
-					while ($row = $db->sql_fetchrow($result));
-				}
-				$db->sql_freeresult($result);
-
-				if ($group_type != GROUP_SPECIAL)
-				{
-
-?>
-	<tr>
-		<td class="row3" colspan="5"><b><?php echo $_CLASS['core_user']->lang['GROUP_LEAD']; ?></b></td>
-	</tr>
-<?php
-
-					if (sizeof($group_data['leader']))
-					{
-						$row_class = '';
-						foreach ($group_data['leader'] as $row)
-						{
-							$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?>
-	<tr>
-		<td class="<?php echo $row_class; ?>"><a href="<?php echo adminlink('forums&amp;file=admin_users&amp;mode=edit&amp;u=' . $row['user_id']); ?>"><?php echo $row['username']; ?></a></td>
-		<td class="<?php echo $row_class; ?>" align="center"><?php echo ($row['group_id'] == $group_id) ? $_CLASS['core_user']->lang['YES'] : $_CLASS['core_user']->lang['NO']; ?></td>
-		<td class="<?php echo $row_class; ?>" align="center"><?php echo $_CLASS['core_user']->format_date($row['user_regdate'], $_CLASS['core_user']->lang['DATE_FORMAT']); ?></td>
-		<td class="<?php echo $row_class; ?>" align="center"><?php echo $row['user_posts']; ?></td>
-		<td class="<?php echo $row_class; ?>" align="center"><input class="checkbox" type="checkbox" name="mark[]" value="<?php echo $row['user_id']; ?>" /></td>
-	</tr>
-<?php	
-
-						}
-					}
-					else
-					{
-
-?>
-	<tr>
-		<td class="row1" colspan="5" align="center"><?php echo $_CLASS['core_user']->lang['GROUPS_NO_MODS']; ?></td>
-	</tr>
-<?php
-
-					}
-				}
-
-?>
-	<tr>
-		<td class="row3" colspan="5"><b><?php echo $_CLASS['core_user']->lang['GROUP_APPROVED']; ?></b></td>
-	</tr>
-<?php
-				if (!empty($group_data['member']) && sizeof($group_data['member']))
-				{
-					$pending = $group_data['member'][0]['user_pending'];
-
-					foreach ($group_data['member'] as $row)
-					{
-						if ($pending)
-						{
-
-?>
-	<tr>
-		<td class="row3" colspan="5"><b><?php echo $_CLASS['core_user']->lang['GROUP_PENDING']; ?></b></td>
-	</tr>
-<?php
-
-						}
-
-						$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?>
-	<tr>
-		<td class="<?php echo $row_class; ?>"><a href="<?php echo adminlink('forums&amp;file=admin_users&amp;mode=edit&amp;u=' . $row['user_id']); ?>"><?php echo $row['username']; ?></a></td>
-		<td class="<?php echo $row_class; ?>" align="center"><?php echo ($row['group_id'] == $group_id) ? $_CLASS['core_user']->lang['YES'] : $_CLASS['core_user']->lang['NO']; ?></td>
-		<td class="<?php echo $row_class; ?>" align="center"><?php echo ($row['user_regdate']) ? $_CLASS['core_user']->format_date($row['user_regdate'], $_CLASS['core_user']->lang['DATE_FORMAT']) : '-'; ?></td>
-		<td class="<?php echo $row_class; ?>" align="center"><?php echo $row['user_posts']; ?></td>
-		<td class="<?php echo $row_class; ?>" align="center"><input class="checkbox" type="checkbox" name="mark[]" value="<?php echo $row['user_id']; ?>" /></td>
-	</tr>
-<?php
-
-					}
-				}
-				else
-				{
-
-?>
-	<tr>
-		<td class="row1" colspan="5" align="center"><?php echo $_CLASS['core_user']->lang['GROUPS_NO_MEMBERS']; ?></td>
-	</tr>
-<?php
-
-				}
-
-?>
-	<tr>
-		<td class="cat" colspan="5" align="right"><select name="action"><option class="sep" value=""><?php echo $_CLASS['core_user']->lang['SELECT_OPTION']; ?></option><?php
-
-				foreach(array('default' => 'DEFAULT', 'approve' => 'APPROVE', 'demote' => 'DEMOTE', 'promote' => 'PROMOTE', 'deleteusers' => 'DELETE') as $option => $lang)
-				{
-					echo '<option value="' . $option . '">' . $_CLASS['core_user']->lang['GROUP_' . $lang] . '</option>';
-				}
-
-?></select> <input class="btnmain" type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;</td>
-	</tr>
-</table>
-
-<table width="95%" cellspacing="1" cellpadding="1" border="0" align="center">
-	<tr>
-		<td valign="top"><?php echo on_page($total_members, $config['topics_per_page'], $start); ?></td>
-		<td align="right"><b><span class="gensmall"><a href="javascript:marklist('list', true);" class="gensmall"><?php echo $_CLASS['core_user']->lang['MARK_ALL']; ?></a> :: <a href="javascript:marklist('list', false);" class="gensmall"><?php echo $_CLASS['core_user']->lang['UNMARK_ALL']; ?></a></span></b>&nbsp;<br /><span class="nav"><?php echo generate_pagination('admin_groups&amp;action=list&amp;mode=member&amp;g='.$group_id, $total_members, $config['topics_per_page'], $start); ?></span></td>
-	</tr>
-</table>
-
-
-<h1><?php echo $_CLASS['core_user']->lang['ADD_USERS']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['ADD_USERS_EXPLAIN']; ?></p>
-
-<table class="bg" width="95%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['ADD_USERS']; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" width="40%"><b><?php echo $_CLASS['core_user']->lang['USER_GROUP_LEADER']; ?>:</b></span></td>
-		<td class="row2"><input type="radio" name="leader" value="1" /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="leader" value="0" checked="checked" /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['USER_GROUP_DEFAULT']; ?>:</b> <br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['USER_GROUP_DEFAULT_EXPLAIN']; ?></span></td>
-		<td class="row2"><input type="radio" name="default" value="1" /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="default" value="0" checked="checked" /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['USERNAME']; ?>:</b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['USERNAMES_EXPLAIN']; ?><br />[ <a href="<?php echo getlink('Members_List&amp;mode=searchuser&amp;form=mod&amp;field=usernames'); ?>"><?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?></a> ]</span></td>
-		<td class="row2"><textarea name="usernames" cols="40" rows="5"></textarea></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="addusers" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" /></td>
-	</tr>
-</table>
-
-</form>
-
-<?php
-
-			adm_page_footer();
-		}
-
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['MANAGE']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['GROUP_MANAGE_EXPLAIN']; ?></p>
-
-<h1><?php echo $_CLASS['core_user']->lang['USER_DEF_GROUPS']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['USER_DEF_GROUPS_EXPLAIN']; ?></p>
-
-<form method="post" action="<?php echo adminlink('forums&amp;file=admin_groups&amp;mode='.$mode); ?>"><table class="bg" width="95%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th width="95%"><?php echo $_CLASS['core_user']->lang['MANAGE']; ?></th>
-		<th nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['TOTAL_MEMBERS']; ?></th>
-		<th colspan="3"><?php echo $_CLASS['core_user']->lang['OPTIONS']; ?></th>
-	</tr>
-<?php
-
-				$sql = 'SELECT g.group_id, g.group_name, g.group_type, COUNT(ug.user_id) AS total_members 
-					FROM (' . GROUPS_TABLE . ' g
-					LEFT JOIN ' . USER_GROUP_TABLE . ' ug USING (group_id)) 
-					GROUP BY g.group_id 
-					ORDER BY g.group_type ASC, g.group_name';
-				$result = $db->sql_query($sql);
-
-				$special = $normal = 0;
-				$group_ary = array();
-				while ($row = $db->sql_fetchrow($result) )
-				{
-					$type = ($row['group_type'] == GROUP_SPECIAL) ? 'special' : 'normal';
-
-					$group_ary[$type][$$type]['group_id'] = $row['group_id'];
-					$group_ary[$type][$$type]['group_name'] = $row['group_name'];
-					$group_ary[$type][$$type]['group_type'] = $row['group_type'];
-					$group_ary[$type][$$type]['total_members'] = $row['total_members'];
-
-					$$type++;
-				}
-				$db->sql_freeresult($result);
-
-				$special_toggle = false;
-				foreach ($group_ary as $type => $row_ary)
-				{
-					if ($type == 'special')
-					{
-
-?>
-	<tr>
-		<td class="cat" colspan="5" align="right"><?php echo $_CLASS['core_user']->lang['CREATE_GROUP']; ?>: <input class="post" type="text" name="group_name" maxlength="30" /> <input class="btnmain" type="submit" name="add" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" /></td>
-	</tr>
-</table>
-
-<h1><?php echo $_CLASS['core_user']->lang['SPECIAL_GROUPS']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['SPECIAL_GROUPS_EXPLAIN']; ?></p>
-
-<table class="bg" width="95%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th width="95%"><?php echo $_CLASS['core_user']->lang['MANAGE']; ?></th>
-		<th><?php echo $_CLASS['core_user']->lang['TOTAL_MEMBERS']; ?></th>
-		<th colspan="3"><?php echo $_CLASS['core_user']->lang['OPTIONS']; ?></th>
-	</tr>
-<?php
-
-					}
-					$row_class = '';
-					foreach ($row_ary as $row)
-					{
-						$row_class = ($row_class != 'row1') ? 'row1' : 'row2';
-
-						$group_id = $row['group_id'];
-						$group_name = (!empty($_CLASS['core_user']->lang['G_' . $row['group_name']]))? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'];
-
-?>
-	<tr>
-		<td width="95%" class="<?php echo $row_class; ?>"><a href="<?php echo adminlink("forums&amp;file=admin_groups&amp;mode=$mode&amp;action=list&amp;g=$group_id"); ?>"><?php echo $group_name;?></a></td>
-		<td class="<?php echo $row_class; ?>" align="center" nowrap="nowrap">&nbsp;<?php echo $row['total_members']; ?>&nbsp;</td>
-		<td class="<?php echo $row_class; ?>" align="center" nowrap="nowrap">&nbsp;<a href="<?php echo adminlink("forums&amp;file=admin_groups&amp;mode=$mode&amp;action=default&amp;g=$group_id"); ?>">Default</a>&nbsp;</td>
-		<td class="<?php echo $row_class; ?>" align="center" nowrap="nowrap">&nbsp;<a href="<?php echo adminlink("forums&amp;file=admin_groups&amp;mode=$mode&amp;action=edit&amp;g=$group_id"); ?>"><?php echo $_CLASS['core_user']->lang['EDIT']; ?></a>&nbsp;</td>
-		<td class="<?php echo $row_class; ?>" align="center" nowrap="nowrap">&nbsp;<?php 
-	
-						echo ($row['group_type'] != GROUP_SPECIAL) ? '<a href="'.adminlink("forums&amp;file=admin_groups&amp;mode=$mode&amp;action=delete&amp;g=$group_id").'">' . $_CLASS['core_user']->lang['DELETE'] . '</a>' : $_CLASS['core_user']->lang['DELETE'];
-
-?>&nbsp;</td>
-	</tr>
-<?php
-
-					}
-				}
-
-?>
-	<tr>
-		<td class="cat" colspan="5">&nbsp;</td>
-	</tr>
-</table></form>
-
-<?php
-
-		adm_page_footer();
-		break;
-
-	// Setting groupwide preferences
-	case 'prefs':
-		adm_page_header($_CLASS['core_user']->lang['GROUP_PREFS']);
-
-		if ($update)
-		{
-			$user_lang	= request_var('lang', '');
-			$user_tz	= request_var('tz', 0.0);
-			$user_dst	= request_var('dst', 0);
-		}
-		else
-		{
-		}
-
-?>
-<h1><?php echo $_CLASS['core_user']->lang['GROUP_SETTINGS']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['GROUP_SETTINGS_EXPLAIN']; ?></p>
-
-<form method="post" action="<?php echo adminlink("forums&amp;file=admin_groups&amp;action=edit&amp;g=$group_id"); ?>"><table class="bg" width="90%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['GROUP_SETTINGS']; ?></th>
-	</tr>
-	<tr>
-		<td class="row2"><?php echo $_CLASS['core_user']->lang['GROUP_LANG']; ?>:</td>
-		<td class="row1"><select name="user_lang"><?php echo '<option value="-1" selected="selected">' . $_CLASS['core_user']->lang['USER_DEFAULT'] . '</option>' . language_select(); ?></select></td>
-	</tr>
-	<tr>
-		<td class="row2"><?php echo $_CLASS['core_user']->lang['GROUP_TIMEZONE']; ?>:</td>
-		<td class="row1"><select name="user_tz"><?php echo '<option value="-14" selected="selected">' . $_CLASS['core_user']->lang['USER_DEFAULT'] . '</option>' . tz_select(); ?></select></td>
-	</tr>
-	<tr>
-		<td class="row2"><?php echo $_CLASS['core_user']->lang['GROUP_DST']; ?>:</td>
-		<td class="row1" nowrap="nowrap"><input type="radio" name="user_dst" value="0" /> <?php echo $_CLASS['core_user']->lang['DISABLED']; ?> &nbsp; <input type="radio" name="user_dst" value="1" /> <?php echo $_CLASS['core_user']->lang['ENABLED']; ?> &nbsp; <input type="radio" name="user_dst" value="-1" checked="checked" /> <?php echo $_CLASS['core_user']->lang['USER_DEFAULT']; ?></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="submitprefs" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" /> &nbsp; <input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-	</tr>
-</table></form>
-
-<?php
-
-		adm_page_footer();
-		break;
-
-	default:
-		trigger_error($_CLASS['core_user']->lang['NO_MODE']);
-}
-
-exit;
-
-?>
\ No newline at end of file

Deleted: trunk/includes/forums/admin/admin_users.php
===================================================================
--- trunk/includes/forums/admin/admin_users.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/admin/admin_users.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,2025 +0,0 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: admin_users.php,v 1.18 2004/05/31 17:59:52 acydburn Exp $
-//
-// FILENAME  : admin_users.php
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : ? 2001,2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Do we have permission?
-if (!$_CLASS['auth']->acl_get('a_user'))
-{
-	trigger_error($_CLASS['core_user']->lang['No_admin']);
-}
-
-
-// Include files
-require_once($site_file_root.'includes/forums/functions_user.'.$phpEx);
-require_once($site_file_root.'includes/forums/functions_profile_fields.'.$phpEx);
-
-$_CLASS['core_user']->add_lang(array('posting', 'ucp'), 'Forums');
-
-//
-// Get and set basic vars
-//
-$mode		= request_var('mode', 'overview');
-$action		= request_var('action', '');
-
-$username	= request_var('username', '');
-$user_id	= request_var('u', 0);
-$gid		= request_var('g', 0);
-
-$start		= request_var('start', 0);
-$ip			= request_var('ip', '');
-$start		= request_var('start', 0);
-$delete		= request_var('delete', '');
-$deletetype	= request_var('deletetype', '');
-$marked		= request_var('mark', 0);
-$quicktools	= request_var('quicktools', '');
-
-$st			= request_var('st', 0);
-$sk			= request_var('sk', 'a');
-$sd			= request_var('sd', 'd');
-
-$submit		= (isset($_POST['update'])) ? true : false;
-$confirm	= (isset($_POST['confirm'])) ? true : false;
-$cancel		= (isset($_POST['cancel'])) ? true : false;
-$preview	= (isset($_POST['preview'])) ? true : false;
-$deletemark = (isset($_POST['delmarked'])) ? true : false;
-$deleteall	= (isset($_POST['delall'])) ? true : false;
-
-$error = array();
-$colspan = 0;
-
-//
-// Whois output
-//
-if ($action == 'whois')
-{
-	// Output relevant page
-	adm_page_header($_CLASS['core_user']->lang['WHOIS']);
-
-	if ($ip && $domain = gethostbyaddr($ip))
-	{
-?>
-
-<table class="bg" width="90%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th>IP whois for <?php echo $domain; ?></th>
-	</tr>
-	<tr>
-		<td class="row1"><?php
-
-		if ($ipwhois = user_ipwhois($ip))
-		{
-			$ipwhois = preg_replace('#(\s+?)([\w\-\._\+]+?@[\w\-\.]+?)(\s+?)#s', '\1<a href="mailto:\2">\2</a>\3', $ipwhois);
-			echo '<br /><pre align="left">' . trim($ipwhois) . '</pre>';
-		}
-
-?></td>
-	</tr>
-</table>
-
-<br clear="all" />
-
-<?php
-
-	}
-
-	adm_page_footer();
-}
-
-//
-// Obtain user information if appropriate
-//
-if ($username || $user_id)
-{
-	$session_time = 0;
-	$sql_where = ($user_id) ? "user_id = $user_id" : "username = '" . $db->sql_escape($username) . "'";
-	$sql = ($action == 'overview') ? 'SELECT u.*, s.session_time, s.session_page, s.session_ip FROM (' . USERS_TABLE . ' u LEFT JOIN ' . SESSIONS_TABLE . " s ON s.session_user_id = u.user_id) WHERE u.$sql_where ORDER BY s.session_time DESC" : 'SELECT * FROM ' . USERS_TABLE . " WHERE $sql_where";
-	$result = $db->sql_query($sql);
-
-	if (!extract($db->sql_fetchrow($result)))
-	{
-		trigger_error($_CLASS['core_user']->lang['NO_USER']);
-	}
-	$db->sql_freeresult($result);
-
-	if ($session_time > $user_lastvisit)
-	{
-		$user_lastvisit = $session_time;
-		$user_lastpage = $session_page;
-	}
-	
-	$user_password = '';
-}
-
-// Output page
-adm_page_header($_CLASS['core_user']->lang['MANAGE']);
-
-
-//
-// Output forms
-//
-
-// Begin program
-if ($username || $user_id)
-{
-	// Generate overall "header" for user admin
-	$form_options = '';
-	$forms_ary = array('overview' => 'OVERVIEW', 'feedback' => 'FEEDBACK', 'profile' => 'PROFILE', 'prefs' => 'PREFS', 'avatar' => 'AVATAR', 'sig' => 'SIG', 'groups' => 'GROUP', 'perm' => 'PERM', 'attach' => 'ATTACH');
-
-	foreach ($forms_ary as $value => $lang)
-	{
-		$selected = ($mode == $value) ? ' selected="selected"' : '';
-		$form_options .= '<option value="' . $value . '"' . $selected . '>' . $_CLASS['core_user']->lang['USER_ADMIN_' . $lang]  . '</option>';
-	}
-
-	$pagination = '';
-
-?>
-
-<script language="javascript" type="text/javascript">
-<!--
-
-var form_name = 'admin';
-var text_name = 'signature';
-
-// Define the bbCode tags
-bbcode = new Array();
-bbtags = new Array('[b]','[/b]','[i]','[/i]','[u]','[/u]','[quote]','[/quote]','[code]','[/code]','[list]','[/list]','[list=]','[/list]','[img]','[/img]','[url]','[/url]');
-imageTag = false;
-
-// Helpline messages
-b_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_B_HELP']; ?>";
-i_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_I_HELP']; ?>";
-u_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_U_HELP']; ?>";
-q_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_Q_HELP']; ?>";
-c_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_C_HELP']; ?>";
-l_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_L_HELP']; ?>";
-o_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_O_HELP']; ?>";
-p_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_P_HELP']; ?>";
-w_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_W_HELP']; ?>";
-a_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_A_HELP']; ?>";
-s_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_S_HELP']; ?>";
-f_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_F_HELP']; ?>";
-e_help = "<?php echo $_CLASS['core_user']->lang['BBCODE_E_HELP']; ?>";
-
-//-->
-</script>
-<script language="javascript" type="text/javascript" src="editor.js"></script>
-
-<h1><?php echo $_CLASS['core_user']->lang['USER_ADMIN']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['USER_ADMIN_EXPLAIN']; ?></p>
-
-<form method="post" name="admin" action="<?php echo adminlink("forums&amp;file=admin_users&amp;mode=$mode&amp;u=$user_id"); ?>"<?php echo ($file_uploads) ? ' enctype="multipart/form-data"' : ''; ?>><table width="100%" cellspacing="2" cellpadding="0" border="0" align="center">
-	<tr>
-		<td align="right"><?php echo $_CLASS['core_user']->lang['SELECT_FORM']; ?>: <select name="mode" onchange="if (this.options[this.selectedIndex].value != '') this.form.submit();"><?php echo $form_options; ?></select></td>
-	</tr>
-	<tr>
-		<td><table class="bg" width="100%" cellspacing="1" cellpadding="4" border="0">
-<?php
-
-	if (sizeof($error))
-	{
-
-?>
-			<tr>
-				<td class="row3" colspan="" align="center"><span class="error"><?php echo implode('<br />', $error); ?></span></td>
-			</tr>
-<?php
-
-	}
-
-
-	switch ($mode)
-	{
-		case 'overview':
-
-			if ($submit)
-			{
-				if ($delete && $user_type != USER_FOUNDER)
-				{
-					if (!$_CLASS['auth']->acl_get('a_userdel'))
-					{
-						trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-					}
-
-					if (!$cancel && !$confirm)
-					{
-						adm_page_confirm($_CLASS['core_user']->lang['CONFIRM'], $_CLASS['core_user']->lang['CONFIRM_OPERATION']);
-					}
-					else if (!$cancel) 
-					{
-						user_delete($deletetype, $user_id);
-
-						add_log('admin', 'LOG_USER_DELETED', $username);
-						trigger_error($_CLASS['core_user']->lang['USER_DELETED']);
-					}
-				}
-
-				// Handle quicktool actions
-				if ($quicktools && $user_type != USER_FOUNDER)
-				{
-					switch ($quicktools)
-					{
-						case 'banuser':
-						case 'banemail':
-						case 'banip':
-							$ban = array();
-
-							switch ($quicktools)
-							{
-								case 'banuser':
-									$ban[] = $username;
-									$reason = 'USER_ADMIN_BAN_NAME_REASON';
-									$log = 'LOG_BAN_USERNAME_USER';
-									break;
-
-								case 'banemail':
-									$ban[] = $user_email;
-									$reason = 'USER_ADMIN_BAN_EMAIL_REASON';
-									$log = 'LOG_BAN_EMAIL_USER';
-									break;
-
-								case 'banip':
-									$ban[] = $user_ip;
-
-									$sql = 'SELECT DISTINCT poster_ip 
-										FROM ' . POSTS_TABLE . " 
-										WHERE poster_id = $user_id";
-									$result = $db->sql_query($sql);
-
-									while ($row = $db->sql_fetchrow($result))
-									{
-										$ban[] = $row['poster_ip'];
-									}
-									$db->sql_freeresult($result);
-
-									$reason = 'USER_ADMIN_BAN_IP_REASON';
-									$log = 'LOG_BAN_IP_USER';
-									break;
-							}
-
-							user_ban(substr($quicktools, 3), $ban, 0, 0, 0, $_CLASS['core_user']->lang[$reason]);
-
-							add_log('user', $user_id, $log);
-
-							trigger_error($_CLASS['core_user']->lang['BAN_UPDATE_SUCESSFUL']);
-
-							break;
-
-						case 'reactivate':
-
-							if ($config['email_enable'])
-							{
-								require_once($site_file_root.'includes/forums/functions_messenger.'.$phpEx);
-
-								$user_actkey = gen_rand_string(10);
-								$key_len = 54 - (strlen($server_url));
-								$key_len = ($key_len > 6) ? $key_len : 6;
-								$user_actkey = substr($user_actkey, 0, $key_len);
-
-								user_active_flip($user_id, $user_type, $user_actkey, $username);
-
-								$messenger = new messenger();
-
-								$messenger->template('user_welcome_inactive', $user_lang);
-								$messenger->subject();
-
-								$messenger->replyto($config['board_contact']);
-								$messenger->to($user_email, $username);
-
-								$messenger->headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-								$messenger->headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']->data['user_id']);
-								$messenger->headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']->data['username']);
-								$messenger->headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']->ip);
-
-								$messenger->assign_vars(array(
-									'SITENAME'		=> $config['sitename'],
-									'WELCOME_MSG'	=> sprintf($_CLASS['core_user']->lang['WELCOME_SUBJECT'], $config['sitename']),
-									'USERNAME'		=> $username,
-									'PASSWORD'		=> $password_confirm,
-									'EMAIL_SIG'		=> str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']),
-
-									'U_ACTIVATE'	=> getlink("Control_Panel&mode=activate&u=$user_id&k=$user_actkey"))
-								);
-
-								$messenger->send(NOTIFY_EMAIL);
-								$messenger->queue->save();
-
-								add_log('admin', 'LOG_USER_REACTIVATE', $username);
-								add_log('user', $user_id, 'LOG_USER_REACTIVATE_USER');
-
-								trigger_error($_CLASS['core_user']->lang['USER_ADMIN_REACTIVATE']);
-							}
-
-							break;
-
-						case 'active':
-
-							user_active_flip($user_id, $user_type, false, $username);
-
-							$message = ($user_type == USER_NORMAL) ? 'USER_ADMIN_INACTIVE' : 'USER_ADMIN_ACTIVE';
-							$log = ($user_type == USER_NORMAL) ? 'LOG_USER_INACTIVE' : 'LOG_USER_ACTIVE';
-
-							add_log('admin', $log, $username);
-							add_log('user', $user_id, $log . '_USER');
-
-							trigger_error($_CLASS['core_user']->lang[$message]);
-							break;
-
-						case 'moveposts':
-
-							if (!($new_forum_id = request_var('new_f', 0)))
-							{
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['USER_ADMIN']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['USER_ADMIN_EXPLAIN']; ?></p>
-
-<form method="post" action="<?php echo adminlink("forums&amp;file=admin_users&amp;action=$action&amp;quicktools=moveposts&amp;u=$user_id"); ?>"><table class="bg" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th align="center"><?php echo $_CLASS['core_user']->lang['USER_ADMIN_MOVE_POSTS']; ?></th>
-	</tr>
-	<tr>
-		<td class="row2" align="center" valign="middle"><?php echo $_CLASS['core_user']->lang['MOVE_POSTS_EXPLAIN']; ?><br /><br /><select name="new_f"><?php 
-	
-							echo make_forum_select(false, false, false, true);
-			
-?></select>&nbsp;</td>
-	</tr>
-	<tr>
-		<td class="cat" align="center"><input type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" /></td>
-	</tr>
-</table>
-<?php
-
-								adm_page_footer();
-							}
-							else
-							{
-								// Two stage?
-								// Move topics comprising only posts from this user
-								$topic_id_ary = array();
-								$forum_id_ary = array($new_forum_id);
-
-								$sql = 'SELECT topic_id, COUNT(post_id) AS total_posts 
-									FROM ' . POSTS_TABLE . " 
-									WHERE poster_id = $user_id
-										AND forum_id <> $new_forum_id
-									GROUP BY topic_id";
-								$result = $db->sql_query($sql);
-
-								while ($row = $db->sql_fetchrow($result))
-								{
-									$topic_id_ary[$row['topic_id']] = $row['total_posts'];
-								}
-								$db->sql_freeresult($result);
-
-								$sql = 'SELECT topic_id, forum_id, topic_title, topic_replies, topic_replies_real 
-									FROM ' . TOPICS_TABLE . ' 
-									WHERE topic_id IN (' . implode(', ', array_keys($topic_id_ary)) . ')';
-								$result = $db->sql_query($sql);
-
-								$move_topic_ary = $move_post_ary = array();
-								while ($row = $db->sql_fetchrow($result))
-								{
-									if (max($row['topic_replies'], $row['topic_replies_real']) + 1 == $topic_id_ary[$row['topic_id']])
-									{
-										$move_topic_ary[] = $row['topic_id'];
-									}
-									else
-									{
-										$move_post_ary[$row['topic_id']]['title'] = $row['topic_title'];
-										$move_post_ary[$row['topic_id']]['attach'] = ($row['attach']) ? 1 : 0;
-									}
-
-									$forum_id_ary[] = $row['forum_id'];
-								}
-								$db->sql_freeresult($result);
-
-								// Entire topic comprises posts by this user, move these topics
-								if (sizeof($move_topic_ary))
-								{
-									move_topics($move_topic_ary, $new_forum_id, false);
-								}
-
-								if (sizeof($move_post_ary))
-								{
-									// Create new topic
-									// Update post_ids, report_ids, attachment_ids
-									foreach ($move_post_ary as $topic_id => $post_ary)
-									{
-										// Create new topic
-										$sql = 'INSERT INTO ' . TOPICS_TABLE . ' ' . $db->sql_build_array('INSERT', array(
-											'topic_poster'				=> $user_id,
-											'topic_time'				=> time(),
-											'forum_id' 					=> $new_forum_id,
-											'icon_id'					=> 0,
-											'topic_approved'			=> 1, 
-											'topic_title' 				=> $post_ary['title'],
-											'topic_first_poster_name'	=> $username,
-											'topic_type'				=> POST_NORMAL,
-											'topic_time_limit'			=> 0,
-											'topic_attachment'			=> $post_ary['attach'],)
-										);
-										$db->sql_query($sql);
-
-										$new_topic_id = $db->sql_nextid();
-
-										// Move posts
-										$sql = 'UPDATE ' . POSTS_TABLE . "
-											SET forum_id = $new_forum_id, topic_id = $new_topic_id 
-											WHERE topic_id = $topic_id
-												AND poster_id = $user_id";
-										$db->sql_query($sql);
-
-										if ($post_ary['attach'])
-										{
-											$sql = 'UPDATE ' . ATTACHMENTS_TABLE . "
-												SET topic_id = $new_topic_id
-												WHERE topic_id = $topic_id
-													AND poster_id = $user_id";
-											$db->sql_query($sql);
-										}
-
-										$new_topic_id_ary[] = $new_topic_id;
-									}
-								}
-
-								$forum_id_ary = array_unique($forum_id_ary);
-								$topic_id_ary = array_unique(array_merge($topic_id_ary, $new_topic_id_ary));
-
-								sync('reported', 'topic_id', $topic_id_ary);
-								sync('topic', 'topic_id', $topic_id_ary);
-								sync('forum', 'forum_id', $forum_id_ary);
-							}
-
-							break;
-					}
-
-					$sql = 'SELECT forum_name
-						FROM ' . TOPICS_TABLE . " 
-						WHERE topic_id = $new_forum_id";
-					$result = $db->sql_query($sql);
-
-					extract($db->sql_fetchrow($result));
-					$db->sql_freeresult($result);
-
-					add_log('admin', 'LOG_USER_MOVE_POSTS', $forum_name, $username);
-					add_log('user', $user_id, 'LOG_USER_MOVE_POSTS_USER', $forum_name);
-
-					trigger_error($_CLASS['core_user']->lang['USER_ADMIN_MOVE']);
-				}
-
-				// Handle registration info updates
-				$var_ary = array(
-					'username'			=> (string) $username, 
-					'user_founder'		=> (int) $user_founder, 
-					'user_type'			=> (int) $user_type, 
-					'user_email'		=> (string) $user_email, 
-					'email_confirm'		=> (string) '',
-					'user_password'		=> (string) '', 
-					'password_confirm'	=> (string) '', 
-					'user_warnings'		=> (int) $user_warnings, 
-				);
-
-				foreach ($var_ary as $var => $default)
-				{
-					$data[$var] = request_var($var, $default);
-				}
-
-				$var_ary = array(
-					'password_confirm'	=> array('string', true, $config['min_pass_chars'], $config['max_pass_chars']), 
-					'user_password'		=> array('string', true, $config['min_pass_chars'], $config['max_pass_chars']), 
-					'user_email'		=> array(
-						array('string', false, 6, 60), 
-						array('email', $email)), 
-					'email_confirm'		=> array('string', true, 6, 60), 
-					'user_warnings'		=> array('num', 0, $config['max_warnings']), 
-				);
-
-				// Check username if altered
-				if ($username != $data['username'])
-				{
-					$var_ary += array(
-						'username'			=> array(
-							array('string', false, $config['min_name_chars'], $config['max_name_chars']), 
-							array('username', $username)),
-					);
-				}
-
-				$error = validate_data($data, $var_ary);
-
-				if ($data['user_password'] && $data['password_confirm'] != $data['user_password'])
-				{
-					$error[] = 'NEW_PASSWORD_ERROR';
-				}
-
-				if ($user_email != $data['user_email'] && $data['email_confirm'] != $data['user_email'])
-				{
-					$error[] = 'NEW_EMAIL_ERROR';
-				}
-
-				// Which updates do we need to do?
-				$update_warning = ($user_warnings != $data['user_warnings']) ? true : false;
-				$update_username = ($username != $data['username']) ? $username : false;
-				$update_password = ($user_password != $data['user_password']) ? true : false;
-
-				extract($data);
-				unset($data);
-
-				if (!sizeof($error))
-				{
-					$sql_ary = array(
-						'username'			=> $username, 
-						'user_founder'		=> $user_founder, 
-						'user_email'		=> $user_email, 
-						'user_email_hash'	=> crc32(strtolower($user_email)) . strlen($user_email), 
-						'user_warnings'		=> $user_warnings, 
-					);
-
-					if ($update_password)
-					{
-						$sql_ary += array(
-							'user_password' => md5($user_password),
-							'user_passchg'	=> time(),
-						);
-					}
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' 
-						SET ' . $db->sql_build_array('UPDATE', $sql_ary) . ' 
-						WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-					$db->sql_query($sql);
-
-					// TODO
-					if ($update_warning)
-					{
-					}
-
-					if ($update_username)
-					{
-						user_update_name($update_username, $username);
-					}
-
-					trigger_error($_CLASS['core_user']->lang['USER_OVERVIEW_UPDATED']);
-				}
-
-				// Replace "error" strings with their real, localised form
-				$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
-			}
-
-			$colspan = 2;
-
-			$user_char_ary = array('.*' => 'USERNAME_CHARS_ANY', '[\w]+' => 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' => 'USERNAME_ALPHA_SPACERS');
-			$quick_tool_ary = array('banuser' => 'BAN_USER', 'banemail' => 'BAN_EMAIL', 'banip' => 'BAN_IP', 'active' => (($user_type == USER_INACTIVE) ? 'ACTIVATE' : 'DEACTIVATE'), 'delsig' => 'DEL_SIG', 'delavatar' => 'DEL_AVATAR', 'moveposts' => 'MOVE_POSTS', 'delposts' => 'DEL_POSTS', 'delattach' => 'DEL_ATTACH');
-			if ($config['email_enable']) 
-			{
-				$quick_tool_ary['reactivate'] = 'FORCE';
-			}
-
-			$options = '<option class="sep" value="">' . $_CLASS['core_user']->lang['SELECT_OPTION'] . '</option>';
-			foreach ($quick_tool_ary as $value => $lang)
-			{
-				$options .= '<option value="' . $value . '">' . $_CLASS['core_user']->lang['USER_ADMIN_' . $lang]  . '</option>';
-			}
-
-			$user_founder_yes = ($user_type == USER_FOUNDER) ? ' checked="checked"' : '';
-			$user_founder_no = ($user_type != USER_FOUNDER) ? ' checked="checked"' : (($_CLASS['core_user']->data['user_type'] != USER_FOUNDER) ? ' disabled="disabled"' : '');
-
-?>	
-			<tr>
-				<th colspan="2"><?php echo $_CLASS['core_user']->lang['USER_ADMIN_OVERVIEW']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" width="40%"><?php echo $_CLASS['core_user']->lang['USERNAME']; ?>: <br /><span class="gensmall"><?php echo sprintf($_CLASS['core_user']->lang[$user_char_ary[str_replace('\\\\', '\\', $config['allow_name_chars'])] . '_EXPLAIN'], $config['min_name_chars'], $config['max_name_chars']); ?></span></td>
-				<td class="row2"><input class="post" type="text" name="username" value="<?php echo $username; ?>" maxlength="60" /></td>
-			</tr>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['REGISTERED']; ?>: </td>
-				<td class="row2"><strong><?php echo $_CLASS['core_user']->format_date($user_regdate); ?></strong></td>
-			</tr>
-<?php
-
-			if ($user_ip)
-			{
-
-?>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['REGISTERED_IP']; ?>: </td>
-				<td class="row2"><strong><a href="<?php echo adminlink("forums&amp;file=admin_users&amp;action=$action&amp;u=$user_id&amp;ip=" . ((!$ip || $ip == 'ip') ? 'hostname' : 'ip')) . '">' . (($ip == 'hostname') ? gethostbyaddr($user_ip) : $user_ip) . '</a> [ <a href="'.adminlink('forums&amp;file=admin_users&amp;action=whois&amp;ip='.$user_ip)."\" onclick=\"window.open('".adminlink('forums&amp;file=admin_users&amp;action=whois&amp;ip='.$user_ip)."', '', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=600');return false;\">" . $_CLASS['core_user']->lang['WHOIS'] . '</a> ]'; ?></strong></td>
-			</tr>
-<?php
-						
-			}
-			
-?>
-			<tr>
-				<td class="row1" width="40%"><?php echo $_CLASS['core_user']->lang['LAST_ACTIVE']; ?>: </td>
-				<td class="row2"><strong><?php echo $_CLASS['core_user']->format_date($user_lastvisit); ?></strong></td>
-			</tr>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['FOUNDER']; ?>: <br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FOUNDER_EXPLAIN']; ?></span></td>
-				<td class="row2"><input type="radio" name="user_founder" value="1"<?php echo $user_founder_yes; ?> /><?php echo $_CLASS['core_user']->lang['YES']; ?>&nbsp;<input type="radio" name="user_founder" value="0"<?php echo $user_founder_no; ?> /><?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-			</tr>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['EMAIL']; ?>: </td>
-				<td class="row2"><input class="post" type="text" name="user_email" value="<?php echo $user_email; ?>" maxlength="60" /></td>
-			</tr>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['CONFIRM_EMAIL']; ?>: <br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['CONFIRM_EMAIL_EXPLAIN']; ?></span></td>
-				<td class="row2"><input class="post" type="text" name="email_confirm" value="<?php echo $email_confirm; ?>" maxlength="60" /></td>
-			</tr>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['NEW_PASSWORD']; ?>: <br /><span class="gensmall"><?php echo sprintf($_CLASS['core_user']->lang['CHANGE_PASSWORD_EXPLAIN'], $config['min_pass_chars'], $config['max_pass_chars']) ?></span></td>
-				<td class="row2"><input class="post" type="password" name="user_password" value="<?php echo ($submit) ? $user_password : ''; ?>" maxlength="60" /></td>
-			</tr>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['CONFIRM_PASSWORD']; ?>: <br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['CONFIRM_PASSWORD_EXPLAIN']; ?></span></td>
-				<td class="row2"><input class="post" type="password" name="password_confirm" value="<?php echo ($submit) ? $user_password_confirm : ''; ?>" maxlength="60" /></td>
-			</tr>
-<?php
-
-			if ($user_type != USER_FOUNDER)
-			{
-
-?>
-			<tr>
-				<th colspan="2"><?php echo $_CLASS['core_user']->lang['USER_TOOLS']; ?></td>
-			</tr>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['WARNINGS']; ?>: <br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['WARNINGS_EXPLAIN']; ?></span></td>
-				<td class="row2"><input class="post" type="text" name="warnings" size="2" maxlength="2" value="<?php echo $_CLASS['core_user']->data['user_warnings']; ?>" /></td>
-			</tr>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['QUICK_TOOLS']; ?>: </td>
-				<td class="row2"><select name="quicktools"><?php echo $options; ?></select></td>
-			</tr>
-			<tr>
-				<td class="row1"><?php echo $_CLASS['core_user']->lang['DELETE_USER']; ?>: <br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['DELETE_USER_EXPLAIN']; ?></span></td>
-				<td class="row2"><select name="deletetype"><option value="retain"><?php echo $_CLASS['core_user']->lang['RETAIN_POSTS']; ?></option><option value="remove"><?php echo $_CLASS['core_user']->lang['DELETE_POSTS']; ?></option></select> <input type="checkbox" name="delete" value="1" /> </td>
-			</tr>
-<?php
-
-			}
-
-?>
-			<tr>
-				<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-			</tr>
-<?php
-
-			break;
-
-		case 'feedback':
-
-			if ($submit)
-			{
-				if (($deletemark || $deleteall) && $_CLASS['auth']->acl_get('a_clearlogs'))
-				{
-					$where_sql = '';
-					if ($deletemark && $marked)
-					{
-						$sql_in = array();
-						foreach ($marked as $mark)
-						{
-							$sql_in[] =  $mark;
-						}
-						$where_sql = ' AND log_id IN (' . implode(', ', $sql_in) . ')';
-						unset($sql_in);
-					}
-
-					$sql = 'DELETE FROM ' . LOG_TABLE . '
-						WHERE log_type = ' . LOG_USERS . " 
-							$where_sql";
-					$db->sql_query($sql);
-
-					add_log('admin', 'LOG_USERS_CLEAR');
-					trigger_error("");
-				}
-
-				if ($message = request_var('message', ''))
-				{
-					add_log('admin', 'LOG_USER_FEEDBACK', $username);
-					add_log('user', $user_id, 'LOG_USER_GENERAL', $message);
-
-					trigger_error($_CLASS['core_user']->lang['USER_FEEDBACK_ADDED']);
-				}
-			}
-
-			$colspan = 2;
-
-			$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_ENTRIES'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
-			$sort_by_text = array('a' => $_CLASS['core_user']->lang['SORT_USERNAME'], 'b' => $_CLASS['core_user']->lang['SORT_DATE'], 'c' => $_CLASS['core_user']->lang['SORT_IP'], 'd' => $_CLASS['core_user']->lang['SORT_ACTION']);
-			$sort_by_sql = array('a' => 'l.user_id', 'b' => 'l.log_time', 'c' => 'l.log_ip', 'd' => 'l.log_operation');
-
-			$s_limit_days = $s_sort_key = $s_sort_dir = '';
-			gen_sort_selects($limit_days, $sort_by_text, $st, $sk, $sd, $s_limit_days, $s_sort_key, $s_sort_dir);
-
-			// Define where and sort sql for use in displaying logs
-			$sql_where = ($st) ? (time() - ($st * 86400)) : 0;
-			$sql_sort = $sort_by_sql[$sk] . ' ' . (($sd == 'd') ? 'DESC' : 'ASC');
-
-?>
-			<tr>
-				<th colspan="2"><?php echo $_CLASS['core_user']->lang['USER_ADMIN_FEEDBACK']; ?></th>
-			</tr>
-			<tr>
-				<td class="cat" colspan="2" align="center"><?php echo $_CLASS['core_user']->lang['DISPLAY_LOG']; ?>: &nbsp;<?php echo $s_limit_days; ?>&nbsp;<?php echo $_CLASS['core_user']->lang['SORT_BY']; ?>: <?php echo $s_sort_key; ?> <?php echo $s_sort_dir; ?>&nbsp;<input class="btnlite" type="submit" value="<?php echo $_CLASS['core_user']->lang['GO']; ?>" name="sort" /></td>
-			</tr>
-<?php
-
-			$log_data = array();
-			$log_count = 0;
-			view_log('user', $log_data, $log_count, $config['posts_per_page'], $start, 0, 0, $user_id, $sql_where, $sql_sort);
-
-			if ($log_count)
-			{
-				for($i = 0; $i < sizeof($log_data); $i++)
-				{
-					$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?>
-				<tr>
-					<td class="<?php echo $row_class; ?>"><span class="gensmall">Report by: <b><?php echo $log_data[$i]['username']; ?></b> on <?php echo $_CLASS['core_user']->format_date($log_data[$i]['time']); ?></span><hr /><?php echo $log_data[$i]['action']; ?></td>
-					<td class="<?php echo $row_class; ?>" width="5%" align="center"><input type="checkbox" name="mark[]" value="<?php echo $log_data[$i]['id']; ?>" /></td>
-				</tr>
-<?php
-
-				}
-			}
-			else
-			{
-
-?>
-				<tr>
-					<td class="row1" colspan="2" align="center">No reports exist for this user</td>
-				</tr>
-<?php
-
-			}
-
-
-?>
-			<tr>
-				<td class="cat" colspan="2" align="right"><?php
-	
-			if ($_CLASS['auth']->acl_get('a_clearlogs'))
-			{
-
-?><input class="btnlite" type="submit" name="delmarked" value="<?php echo $_CLASS['core_user']->lang['DELETE_MARKED']; ?>" />&nbsp; <input class="btnlite" type="submit" name="delall" value="<?php echo $_CLASS['core_user']->lang['DELETE_ALL']; ?>" /><?php
-	
-			}
-			
-?>&nbsp;</td>
-			</tr>
-		</table></td>
-	</tr>
-	<tr>
-		<td class="nav"><div style="float:left;"><?php echo on_page($log_count, $config['topics_per_page'], $start); ?></div><div  style="float:right;"><b><a href="javascript:marklist('admin', true);"><?php echo $_CLASS['core_user']->lang['MARK_ALL']; ?></a> :: <a href="javascript:marklist('admin', false);"><?php echo $_CLASS['core_user']->lang['UNMARK_ALL']; ?></a></b>&nbsp;<br /><br /><?php
-
-			echo generate_pagination("admin_users&amp;action=$action&amp;u=$user_id&amp;st=$st&amp;sk=$sk&amp;sd=$sd", $log_count, $config['posts_per_page'], $start); 
-	
-?></div></td>
-	</tr>
-</table>
-
-<script language="Javascript" type="text/javascript">
-<!--
-function marklist(match, status)
-{
-	len = eval('document.' + match + '.length');
-	for (i = 0; i < len; i++)
-	{
-		eval('document.' + match + '.elements[i].checked = ' + status);
-	}
-}
-//-->
-</script>
-
-<h1><?php echo $_CLASS['core_user']->lang['ADD_FEEDBACK']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['ADD_FEEDBACK_EXPLAIN']; ?></p>
-
-<table width="100%" cellspacing="2" cellpadding="0" border="0" align="center">
-	<tr>
-		<td><table class="bg" width="100%" cellspacing="1" cellpadding="4" border="0">
-			<tr>
-				<th colspan="2"><?php echo $_CLASS['core_user']->lang['USER_ADMIN_' . strtoupper($action)]; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" colspan="2" align="center"><textarea name="message" rows="10" cols="76"></textarea></td>
-			</tr>
-			<tr>
-				<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-			</tr>
-<?php
-
-
-			break;
-
-
-		case 'profile':
-
-			if ($submit)
-			{
-				$var_ary = array(
-					'icq'			=> (string) '', 
-					'aim'			=> (string) '', 
-					'msn'			=> (string) '', 
-					'yim'			=> (string) '', 
-					'jabber'		=> (string) '', 
-					'website'		=> (string) '', 
-					'location'		=> (string) '',
-					'occupation'	=> (string) '',
-					'interests'		=> (string) '',
-					'bday_day'		=> 0,
-					'bday_month'	=> 0,
-					'bday_year'		=> 0,
-				);
-
-				foreach ($var_ary as $var => $default)
-				{
-					$data[$var] = request_var($var, $default);
-				}
-
-				$var_ary = array(
-					'icq'			=> array(
-						array('string', true, 3, 15), 
-						array('match', true, '#^[0-9]+$#i')), 
-					'aim'			=> array('string', true, 5, 255), 
-					'msn'			=> array('string', true, 5, 255), 
-					'jabber'		=> array(
-						array('string', true, 5, 255), 
-						array('match', true, '#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}(/.*)?$#i')),
-					'yim'			=> array('string', true, 5, 255), 
-					'website'		=> array(
-						array('string', true, 12, 255), 
-						array('match', true, '#^http[s]?://(.*?\.)*?[a-z0-9\-]+\.[a-z]{2,4}#i')), 
-					'location'		=> array('string', true, 2, 255), 
-					'occupation'	=> array('string', true, 2, 500), 
-					'interests'		=> array('string', true, 2, 500), 
-					'bday_day'		=> array('num', true, 1, 31),
-					'bday_month'	=> array('num', true, 1, 12),
-					'bday_year'		=> array('num', true, 1901, gmdate('Y', time())),
-				);
-
-				$error = validate_data($data, $var_ary);
-				extract($data);
-				unset($data);
-
-				// validate custom profile fields
-	//			$cp->submit_cp_field('profile', $cp_data, $cp_error);
-
-				if (!sizeof($error) && !sizeof($cp_error))
-				{
-					$sql_ary = array(
-						'user_icq'		=> $icq,
-						'user_aim'		=> $aim,
-						'user_msnm'		=> $msn,
-						'user_yim'		=> $yim,
-						'user_jabber'	=> $jabber,
-						'user_website'	=> $website,
-						'user_from'		=> $location,
-						'user_occ'		=> $occupation,
-						'user_interests'=> $interests,
-						'user_birthday'	=> sprintf('%2d-%2d-%4d', $bday_day, $bday_month, $bday_year),
-					);
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' 
-						SET ' . $db->sql_build_array('UPDATE', $sql_ary) . "
-						WHERE user_id = $user_id";
-					$db->sql_query($sql);
-
-	/*
-					// Update Custom Fields
-					if (sizeof($cp_data))
-					{
-						$sql = 'UPDATE ' . PROFILE_DATA_TABLE . '
-							SET ' . $db->sql_build_array('UPDATE', $cp_data) . "
-							WHERE user_id = $user_id";
-						$db->sql_query($sql);
-
-						if (!$db->sql_affectedrows())
-						{
-							$cp_data['user_id'] = $user_id;
-
-							$db->return_on_error = true;
-
-							$sql = 'INSERT INTO ' . PROFILE_DATA_TABLE . ' ' . $db->sql_build_array('INSERT', $cp_data);
-							$db->sql_query();
-
-							$db->return_on_error = false;
-						}
-					}
-	*/
-					trigger_error($_CLASS['core_user']->lang['USER_PROFILE_UPDATED']);
-				}
-			}
-
-			$colspan = 2;
-
-			$cp = new custom_profile();
-
-			$cp_data = $cp_error = array();
-
-			if (!isset($bday_day))
-			{
-				list($bday_day, $bday_month, $bday_year) = explode('-', $user_birthday);
-			}
-
-			$s_birthday_day_options = '<option value="0"' . ((!$bday_day) ? ' selected="selected"' : '') . '>--</option>';
-			for ($i = 1; $i < 32; $i++)
-			{
-				$selected = ($i == $bday_day) ? ' selected="selected"' : '';
-				$s_birthday_day_options .= "<option value=\"$i\"$selected>$i</option>";
-			}
-
-			$s_birthday_month_options = '<option value="0"' . ((!$bday_month) ? ' selected="selected"' : '') . '>--</option>';
-			for ($i = 1; $i < 13; $i++)
-			{
-				$selected = ($i == $bday_month) ? ' selected="selected"' : '';
-				$s_birthday_month_options .= "<option value=\"$i\"$selected>$i</option>";
-			}
-			$s_birthday_year_options = '';
-
-			$now = getdate();
-			$s_birthday_year_options = '<option value="0"' . ((!$bday_year) ? ' selected="selected"' : '') . '>--</option>';
-			for ($i = $now['year'] - 100; $i < $now['year']; $i++)
-			{
-				$selected = ($i == $bday_year) ? ' selected="selected"' : '';
-				$s_birthday_year_options .= "<option value=\"$i\"$selected>$i</option>";
-			}
-			unset($now);
-
-			// Get additional profile fields and assign them to the template block var 'profile_fields'
-//			$_CLASS['core_user']->get_profile_fields($_CLASS['core_user']->data['user_id']);
-//			$cp->generate_profile_fields('profile', $_CLASS['core_user']->get_iso_lang_id(), $cp_error);
-
-
-?>
-			<tr>
-				<th colspan="2"><?php echo $_CLASS['core_user']->lang['USER_ADMIN_SIG']; ?></th>
-			</tr>
-			<tr> 
-				<td class="row1" width="40%"><b><?php echo $_CLASS['core_user']->lang['UCP_ICQ']; ?>: </b></td>
-				<td class="row2"><input class="post" type="text" name="icq" size="30" maxlength="15" value="<?php echo $user_icq; ?>" /></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['UCP_AIM']; ?>: </b></td>
-				<td class="row2"><input class="post" type="text" name="aim" size="30" maxlength="255" value="<?php echo $user_aim; ?>" /></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['UCP_MSNM']; ?>: </b></td>
-				<td class="row2"><input class="post" type="text" name="msn" size="30" maxlength="255" value="<?php echo $user_msnm; ?>" /></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['UCP_YIM']; ?>: </b></td>
-				<td class="row2"><input class="post" type="text" name="yim" size="30" maxlength="255" value="<?php echo $user_yim; ?>" /></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['UCP_JABBER']; ?>: </b></td>
-				<td class="row2"><input class="post" type="text" name="jabber" size="30" maxlength="255" value="<?php echo $user_jabber; ?>" /></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['WEBSITE']; ?>: </b></td>
-				<td class="row2"><input class="post" type="text" name="website" size="30" maxlength="255" value="<?php echo $user_website; ?>" /></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['LOCATION']; ?>: </b></td>
-				<td class="row2"><input class="post" type="text" name="location" size="30" maxlength="100" value="<?php echo $user_location; ?>" /></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['OCCUPATION']; ?>: </b></td>
-				<td class="row2"><textarea class="post" name="occ" rows="3" cols="30"><?php echo $user_occ; ?></textarea></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['INTERESTS']; ?>: </b></td>
-				<td class="row2"><textarea class="post" name="interests" rows="3" cols="30"><?php echo $user_interests; ?></textarea></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['BIRTHDAY']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['BIRTHDAY_EXPLAIN']; ?></span></td>
-				<td class="row2"><span class="genmed"><?php echo $_CLASS['core_user']->lang['DAY']; ?>:</span> <select name="bday_day"><?php echo $s_birthday_day_options; ?></select> <span class="genmed"><?php echo $_CLASS['core_user']->lang['MONTH']; ?>:</span> <select name="bday_month"><?php echo $s_birthday_month_options; ?></select> <span class="genmed"><?php echo $_CLASS['core_user']->lang['YEAR']; ?>:</span> <select name="bday_year"><?php echo $s_birthday_year_options; ?></select></td>
-			</tr>
-			<tr>
-				<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-			</tr>
-<?php
-
-			break;
-
-
-		case 'prefs':
-
-			if ($submit)
-			{
-				$var_ary = array(
-					'user_dateformat'		=> (string) $config['default_dateformat'], 
-					'user_lang'				=> (string) $config['default_lang'], 
-					'user_tz'				=> (float) $config['board_timezone'],
-					'user_style'			=> (int) $config['default_style'], 
-					'user_dst'				=> (bool) $config['board_dst'], 
-					'user_allow_viewemail'	=> false, 
-					'user_allow_massemail'	=> true, 
-					'user_allow_viewonline'	=> true, 
-					'user_notify_type'		=> 0, 
-					'user_notify_pm'		=> true, 
-					'user_allow_pm'			=> true, 
-					'user_notify'			=> false, 
-					'user_min_karma'		=> (int) -5, 
-
-					'sk'		=> (string) 't', 
-					'sd'		=> (string) 'd', 
-					'st'		=> 0,
-
-					'popuppm'		=> false, 
-					'viewimg'		=> true, 
-					'viewflash'		=> false, 
-					'viewsmilies'	=> true, 
-					'viewsigs'		=> true, 
-					'viewavatars'	=> true, 
-					'viewcensors'	=> false, 
-					'bbcode'		=> true, 
-					'html'			=> false, 
-					'smile'			=> true,
-					'attachsig'		=> true, 
-				);
-
-				foreach ($var_ary as $var => $default)
-				{
-					$data[$var] = request_var($var, $default);
-				}
-
-				$var_ary = array(
-					'user_dateformat'	=> array('string', false, 3, 15), 
-					'user_lang'			=> array('match', false, '#^[a-z_]{2,}$#i'),
-					'user_tz'			=> array('num', false, -13, 13),
-					'user_min_karma'	=> array('num', false, -5, 5),
-
-					'sk'	=> array('string', false, 1, 1), 
-					'sd'	=> array('string', false, 1, 1), 
-				);
-
-				$error = validate_data($data, $var_ary);
-				extract($data);
-				unset($data);
-
-				// Set the popuppm option
-				$option_ary = array('popuppm', 'viewimg', 'viewflash', 'viewsmilies', 'viewsigs', 'viewavatars', 'viewcensors', 'bbcode', 'html', 'smile', 'attachsig');
-
-				foreach ($option_ary as $option)
-				{
-					$user_options = $_CLASS['core_user']->optionset($option, $$option, $user_options);
-				}
-
-				if (!sizeof($error))
-				{
-					$sql_ary = array(
-						'user_allow_pm'			=> $user_allow_pm, 
-						'user_allow_viewemail'	=> $user_allow_viewemail, 
-						'user_allow_massemail'	=> $user_allow_massemail, 
-						'user_allow_viewonline'	=> $user_allow_viewonline, 
-						'user_notify_type'		=> $user_notify_type, 
-						'user_notify_pm'		=> $user_notify_pm,
-						'user_options'			=> $user_options, 
-						'user_notify'			=> $user_notify,
-						'user_min_karma'		=> $user_min_karma, 
-						'user_dst'				=> $user_dst,
-						'user_dateformat'		=> $user_dateformat,
-						'user_lang'				=> $user_lang,
-						'user_timezone'			=> $user_tz,
-						'user_style'			=> $user_style,
-						'user_sortby_type'		=> $sk,
-						'user_sortby_dir'		=> $sd,
-						'user_show_days'		=> $st, 
-					);
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' 
-						SET ' . $db->sql_build_array('UPDATE', $sql_ary) . "
-						WHERE user_id = $user_id";
-					$db->sql_query($sql);
-
-					trigger_error($_CLASS['core_user']->lang['USER_PREFS_UPDATED']);
-				}
-
-				$user_sortby_type = $sk;
-				$user_sortby_dir = $sd;
-				$user_show_days = $st;
-			}
-
-			$colspan = 2;
-
-			$option_ary = array('user_allow_viewemail', 'user_allow_massemail', 'user_allow_pm', 'user_allow_viewonline', 'user_notify_pm', 'user_dst', 'user_notify', 'user_min_karma');
-
-			foreach ($option_ary as $option)
-			{
-				${$option . '_yes'} = ($$option) ? ' checked="checked"' : '';
-				${$option . '_no'} = (!$$option) ? ' checked="checked"' : '';
-			}
-			unset($option_ary);
-
-			$option_ary = array('popuppm', 'viewimg', 'viewflash', 'viewsmilies', 'viewsigs', 'viewavatars', 'viewcensors', 'bbcode', 'html', 'smile', 'attachsig');
-
-			foreach ($option_ary as $option)
-			{
-				${$option . '_yes'} = ($_CLASS['core_user']->optionget($option, $user_options)) ? ' checked="checked"' : '';
-				${$option . '_no'} = (!$_CLASS['core_user']->optionget($option, $user_options)) ? ' checked="checked"' : '';
-			}
-
-			$notify_email	= ($user_notify_type == NOTIFY_EMAIL) ? ' checked="checked"' : '';
-			$notify_im		= ($user_notify_type == NOTIFY_IM) ? ' checked="checked"' : '';
-			$notify_both	= ($user_notify_type == NOTIFY_BOTH) ? ' checked="checked"' : '';
-
-			// Topic ordering display
-			$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_TOPICS'], 0 => $_CLASS['core_user']->lang['ALL_TOPICS'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
-
-			$sort_by_text = array('a' => $_CLASS['core_user']->lang['AUTHOR'], 't' => $_CLASS['core_user']->lang['POST_TIME'], 'r' => $_CLASS['core_user']->lang['REPLIES'], 's' => $_CLASS['core_user']->lang['SUBJECT'], 'v' => $_CLASS['core_user']->lang['VIEWS']);
-			$sort_by_sql = array('a' => 't.topic_first_poster_name', 't' => 't.topic_last_post_time', 'r' => 't.topic_replies', 's' => 't.topic_title', 'v' => 't.topic_views');
-
-			$s_limit_days = $s_sort_key = $s_sort_dir = '';
-			gen_sort_selects($limit_days, $sort_by_text, $user_show_days, $user_sortby_type, $user_sortby_dir, $s_limit_days, $s_sort_key, $s_sort_dir);
-
-?>
-			<tr>
-				<th colspan="2"><?php echo $_CLASS['core_user']->lang['USER_ADMIN_PREFS']; ?></th>
-			</tr>
-			<tr> 
-				<td class="row1" width="40%"><b><?php echo $_CLASS['core_user']->lang['VIEW_IMAGES']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="viewimg" value="1"<?php echo $viewimg_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="viewimg" value="0"<?php echo $viewimg_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['VIEW_FLASH']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="viewflash" value="1"<?php echo $viewflash_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="viewflash" value="0"<?php echo $viewflash_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['VIEW_SMILIES']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="viewsmilies" value="1"<?php echo $viewsmilies_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="viewsmilies" value="0"<?php echo $viewsmilies_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['VIEW_SIGS']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="viewsigs" value="1"<?php echo $viewsigs_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="viewsigs" value="0"<?php echo $viewsigs_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['VIEW_AVATARS']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="viewavatars" value="1"<?php echo $viewavatars_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="viewavatars" value="0"<?php echo $viewavatars_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['DISABLE_CENSORS']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="viewcensors" value="1"<?php echo $viewcensors_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="viewcensors" value="0"<?php echo $viewcensors_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<!-- tr>
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['MINIMUM_KARMA']; ?>:</b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['MINIMUM_KARMA_EXPLAIN']; ?></span></td>
-				<td class="row2"><select name="user_min_karma">{S_MIN_KARMA_OPTIONS}</select></td>
-			</tr-->
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['VIEW_TOPICS_DAYS']; ?>:</b></td>
-				<td class="row2"><?php echo $s_limit_days; ?></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['VIEW_TOPICS_KEY']; ?>:</b></td>
-				<td class="row2"><?php echo $s_sort_key; ?></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['VIEW_TOPICS_DIR']; ?>:</b></td>
-				<td class="row2"><?php echo $s_sort_dir; ?></td>
-			</tr>
-			<tr>
-				<th colspan="2"><?php echo $_CLASS['core_user']->lang['USER_POSTING_PREFS']; ?></th>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['DEFAULT_BBCODE']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="bbcode" value="1"<?php echo $bbcode_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="bbcode" value="0"<?php echo $bbcode_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['DEFAULT_HTML']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="html" value="1"<?php echo $html_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="html" value="0"<?php echo $html_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['DEFAULT_SMILE']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="smile" value="1"<?php echo $smile_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="smile" value="0"<?php echo $smile_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['DEFAULT_ADD_SIG']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="attachsig" value="1"<?php echo $attachsig_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="attachsig" value="0"<?php echo $attachsig_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['DEFAULT_NOTIFY']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="user_notify" value="1"<?php echo $user_notify_yes; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="user_notify" value="0"<?php echo $user_notify_no; ?> /><span class="gen"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr>
-				<th colspan="2"></th>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['SHOW_EMAIL']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="user_allow_viewemail" value="1"<?php echo $user_allow_viewemail_yes; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="user_allow_viewemail" value="0"<?php echo $user_allow_viewemail_no; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['ADMIN_EMAIL']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="user_allow_massemail" value="1"<?php echo $user_allow_massemail_yes; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="user_allow_massemail" value="0"<?php echo $user_allow_massemail_no; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['ALLOW_PM']; ?>:</b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['ALLOW_PM_EXPLAIN']; ?></span></td>
-				<td class="row2"><input type="radio" name="user_allow_pm" value="1"<?php echo $user_allow_pm_yes; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="user_allow_pm" value="0"<?php echo $user_allow_pm_no; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['HIDE_ONLINE']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="user_allow_viewonline" value="0"<?php echo $user_allow_viewonline_no; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="user_allow_viewonline" value="1"<?php echo $user_allow_viewonline_yes; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['NOTIFY_METHOD']; ?>:</b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['NOTIFY_METHOD_EXPLAIN']; ?></span></td>
-				<td class="row2"><input type="radio" name="user_notify_type" value="0"<?php echo $notify_email; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NOTIFY_METHOD_EMAIL']; ?></span>&nbsp;&nbsp;<input type="radio" name="user_notify_type" value="1"<?php echo $notify_im; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NOTIFY_METHOD_IM']; ?></span>&nbsp;&nbsp;<input type="radio" name="user_notify_type" value="2"<?php echo $notify_both; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NOTIFY_METHOD_BOTH']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['NOTIFY_ON_PM']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="user_notify_pm" value="1"<?php echo $user_notify_pm_yes; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="user_notify_pm" value="0"<?php echo $user_notify_pm_no; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['POPUP_ON_PM']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="popuppm" value="1"<?php echo $popuppm_yes; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="popuppm" value="0"<?php echo $popuppm_no; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['BOARD_LANGUAGE']; ?>:</b></td>
-				<td class="row2"><select name="user_lang"><?php echo language_select($user_lang); ?></select></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['BOARD_STYLE']; ?>:</b></td>
-				<td class="row2"><select name="user_style"><?php echo style_select($user_style); ?></select></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['BOARD_TIMEZONE']; ?>:</b></td>
-				<td class="row2"><select name="user_tz"><?php echo tz_select($user_timezone); ?></select></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['BOARD_DST']; ?>:</b></td>
-				<td class="row2"><input type="radio" name="user_dst" value="1"<?php echo $user_dst_yes; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['YES']; ?></span>&nbsp;&nbsp;<input type="radio" name="user_dst" value="0"<?php echo $user_dst_no; ?> /><span class="genmed"><?php echo $_CLASS['core_user']->lang['NO']; ?></span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b><?php echo $_CLASS['core_user']->lang['BOARD_DATE_FORMAT']; ?>:</b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['BOARD_DATE_FORMAT_EXPLAIN']; ?></span></td>
-				<td class="row2"><input type="text" name="user_dateformat" value="<?php echo $user_dateformat; ?>" maxlength="14" class="post" /></td>
-			</tr>
-			<tr>
-				<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-			</tr>
-<?php
-
-			break;
-
-		case 'avatar':
-
-			$can_upload = (file_exists($config['avatar_path']) && is_writeable($config['avatar_path']) && $file_uploads) ? true : false;
-
-			if ($submit)
-			{
-				$var_ary = array(
-					'uploadurl'		=> (string) '', 
-					'remotelink'	=> (string) '', 
-					'width'			=> (string) '',
-					'height'		=> (string) '', 
-				);
-
-				foreach ($var_ary as $var => $default)
-				{
-					$data[$var] = request_var($var, $default);
-				}
-
-				$var_ary = array(
-					'uploadurl'		=> array('string', true, 5, 255), 
-					'remotelink'	=> array('string', true, 5, 255), 
-					'width'			=> array('string', true, 1, 3), 
-					'height'		=> array('string', true, 1, 3), 
-				);
-
-				$error = validate_data($data, $var_ary);
-
-				if (!sizeof($error))
-				{
-					$data['user_id'] = $user_id;
-
-					if ((!empty($_FILES['uploadfile']['tmp_name']) || $data['uploadurl']) && $can_upload)
-					{
-						list($type, $filename, $width, $height) = avatar_upload($data, $error);
-					}
-					else if ($data['remotelink'])
-					{
-						list($type, $filename, $width, $height) = avatar_remote($data, $error);
-					}
-					else if ($delete)
-					{
-						$type = $filename = $width = $height = '';
-					}
-				}
-
-				if (!sizeof($error))
-				{
-					// Do we actually have any data to update?
-					if (sizeof($data))
-					{
-						$sql_ary = array(
-							'user_avatar'			=> $filename, 
-							'user_avatar_type'		=> $type, 
-							'user_avatar_width'		=> $width, 
-							'user_avatar_height'	=> $height, 
-						);
-
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $db->sql_build_array('UPDATE', $sql_ary) . " 
-							WHERE user_id = $user_id";
-						$db->sql_query($sql);
-
-						// Delete old avatar if present
-						if ($user_avatar && $filename != $user_avatar)
-						{
-							avatar_delete($user_avatar);
-						}
-					}
-
-					trigger_error($message);
-				}
-
-				extract($data);
-				unset($data);
-			}
-
-			$colspan = 2;
-
-			$display_gallery = (isset($_POST['displaygallery'])) ? true : false;
-			$avatar_category = request_var('category', '');
-
-			// Generate users avatar
-			$avatar_img = '';
-			if ($user_avatar)
-			{
-				switch ($user_avatar_type)
-				{
-					case AVATAR_UPLOAD:
-						$avatar_img = $config['avatar_path'] . '/';
-						break;
-					case AVATAR_GALLERY:
-						$avatar_img = $config['avatar_gallery_path'] . '/';
-						break;
-				}
-				$avatar_img .= $user_avatar;
-
-				$avatar_img = '<img src="' . $avatar_img . '" width="' . $user_avatar_width . '" height="' . $user_avatar_height . '" border="0" alt="" />';
-			}
-			else
-			{
-				$avatar_img = '<img src="images/no_avatar.gif" alt="" />';
-			}
-
-?>
-			<tr>
-				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['USER_ADMIN_AVATAR']; ?></th>
-			</tr>
-			<tr> 
-				<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['CURRENT_IMAGE']; ?>: </b><br /><span class="gensmall"><?php echo sprintf($_CLASS['core_user']->lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)); ?></span></td>
-				<td class="row1" align="center"><br /><?php echo $avatar_img; ?><br /><br /><input type="checkbox" name="delete" />&nbsp;<span class="gensmall"><?php echo $_CLASS['core_user']->lang['DELETE_AVATAR']; ?></span></td>
-			</tr>
-<?php
-
-			// Can we upload?
-			if ($can_upload)
-			{
-
-?>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['UPLOAD_AVATAR_FILE']; ?>: </b></td>
-		<td class="row1"><input type="hidden" name="MAX_FILE_SIZE" value="<?php echo $config['avatar_max_filesize']; ?>" /><input class="post" type="file" name="uploadfile" /></td>
-	</tr>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['UPLOAD_AVATAR_URL']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['UPLOAD_AVATAR_URL_EXPLAIN']; ?></span></td>
-		<td class="row1"><input class="post" type="text" name="uploadurl" size="40" value="<?php echo $avatar_url; ?>" /></td>
-	</tr>
-<?php
-
-			}
-
-?>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['LINK_REMOTE_AVATAR']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['LINK_REMOTE_AVATAR_EXPLAIN']; ?></span></td>
-		<td class="row1"><input class="post" type="text" name="remotelink" size="40" value="<?php echo $avatar_url; ?>" /></td>
-	</tr>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['LINK_REMOTE_SIZE']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['LINK_REMOTE_SIZE_EXPLAIN']; ?></span></td>
-		<td class="row1"><input class="post" type="text" name="width" size="3" value="<?php echo $user_avatar_width; ?>" /> <span class="gen">px X </span> <input class="post" type="text" name="height" size="3" value="<?php echo $user_avatar_height; ?>" /> <span class="gen">px</span></td>
-	</tr>
-<?php
-
-			// Do we have a gallery?
-			if ($config['null'] && !$display_gallery)
-			{
-
-?>
-	<tr> 
-		<td class="row2" width="35%"><b><?php echo $_CLASS['core_user']->lang['AVATAR_GALLERY']; ?>: </b></td>
-		<td class="row1"><input class="btnlite" type="submit" name="displaygallery" value="<?php echo $_CLASS['core_user']->lang['DISPLAY_GALLERY']; ?>" /></td>
-	</tr>
-<?php
-			}
-
-			// Do we want to display it?
-			if ($config['null'] && $display_gallery)
-			{
-
-?>
-	<tr> 
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['AVATAR_GALLERY']; ?></th>
-	</tr>
-	<tr> 
-		<td class="cat" colspan="2" align="center" valign="middle"><span class="genmed"><?php echo $_CLASS['core_user']->lang['AVATAR_CATEGORY']; ?>: </span><select name="avatarcat">{S_CAT_OPTIONS}</select>&nbsp; <span class="genmed"><?php echo $_CLASS['core_user']->lang['AVATAR_PAGE']; ?>: </span><select name="avatarpage">{S_PAGE_OPTIONS}</select>&nbsp;<input class="btnlite" type="submit" value="<?php echo $_CLASS['core_user']->lang['GO']; ?>" name="avatargallery" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" colspan="2" align="center"><table cellspacing="1" cellpadding="4" border="0">
-		
-			<!-- BEGIN avatar_row -->
-			<tr> 
-				<!-- BEGIN avatar_column -->
-				<td class="row1" align="center"><img src="{avatar_row.avatar_column.AVATAR_IMAGE}" alt="{avatar_row.avatar_column.AVATAR_NAME}" title="{avatar_row.avatar_column.AVATAR_NAME}" /></td>
-				<!-- END avatar_column -->
-			</tr>
-			<tr>
-				<!-- BEGIN avatar_option_column -->
-				<td class="row2" align="center"><input type="radio" name="avatarselect" value="{avatar_row.avatar_option_column.S_OPTIONS_AVATAR}" /></td>
-				<!-- END avatar_option_column -->
-			</tr>
-			<!-- END avatar_row -->
-
-		</table></td>
-	</tr>
-<?php
-
-			}
-
-?>
-			<tr>
-				<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-			</tr>
-<?php
-
-			break;
-
-
-		case 'sig':
-
-			if ($submit || $preview)
-			{
-				$var_ary = array(
-					'enable_html'		=> (bool) $config['allow_html'], 
-					'enable_bbcode'		=> (bool) $config['allow_bbcode'], 
-					'enable_smilies'	=> (bool) $config['allow_smilies'],
-					'enable_urls'		=> true,  
-					'signature'			=> (string) $user_sig, 
-
-				);
-
-				foreach ($var_ary as $var => $default)
-				{
-					$$var = request_var($var, $default);
-				}
-
-				$img_status = ($config['allow_img']) ? true : false;
-				$flash_status = ($config['allow_flash']) ? true : false;
-				
-					require_once($site_file_root.'includes/forums/message_parser.'.$phpEx);
-					// Allowing Quote BBCode
-					$message_parser->parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, true);
-					
-					if ($submit)
-					{
-
-					$message_parser = new parse_message($signature);
-
-					$sql_ary = array(
-						'user_sig'					=> (string) $message_parser->message, 
-						'user_sig_bbcode_uid'		=> (string) $message_parser->bbcode_uid, 
-						'user_sig_bbcode_bitfield'	=> (int) $message_parser->bbcode_bitfield
-					);
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' 
-						SET ' . $db->sql_build_array('UPDATE', $sql_ary) . " 
-						WHERE user_id = $user_id";
-					$db->sql_query($sql);
-					
-					unset($message_parser);
-
-					trigger_error($_CLASS['core_user']->lang['PROFILE_UPDATED']);
-				}
-			}
-
-			$colspan = 2;
-
-			require_once($site_file_root.'includes/forums/functions_posting.'.$phpEx);
-
-			$signature_preview = '';
-			if ($preview)
-			{
-				// Now parse it for displaying
-				$signature_preview = $message_parser->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
-				unset($message_parser);
-			}
-
-			decode_message($user_sig, $user_sig_bbcode_uid);
-
-?>
-			<tr>
-				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['USER_ADMIN_SIG']; ?></th>
-			</tr>
-			<tr> 
-				<td class="row1" width="40%"><b class="genmed"><?php echo $_CLASS['core_user']->lang['SIGNATURE']; ?>: </b></td>
-				<td class="row2"><table cellspacing="0" cellpadding="2" border="0">
-					<tr align="center" valign="middle">
-						<td><input class="btnlite" type="button" accesskey="b" name="addbbcode0" value=" B " style="font-weight:bold; width: 30px" onclick="bbstyle(0)" onmouseover="helpline('b')" /></td>
-						<td><input class="btnlite" type="button" accesskey="i" name="addbbcode2" value=" i " style="font-style:italic; width: 30px" onclick="bbstyle(2)" onmouseover="helpline('i')" /></td>
-						<td><input class="btnlite" type="button" accesskey="u" name="addbbcode4" value=" u " style="text-decoration: underline; width: 30px" onclick="bbstyle(4)" onmouseover="helpline('u')" /></td>
-						<td><input class="btnlite" type="button" accesskey="q" name="addbbcode6" value="Quote" style="width: 50px" onclick="bbstyle(6)" onmouseover="helpline('q')" /></td>
-						<td><input class="btnlite" type="button" accesskey="c" name="addbbcode8" value="Code" style="width: 40px" onclick="bbstyle(8)" onmouseover="helpline('c')" /></td>
-						<td><input class="btnlite" type="button" accesskey="l" name="addbbcode10" value="List" style="width: 40px" onclick="bbstyle(10)" onmouseover="helpline('l')" /></td>
-						<td><input class="btnlite" type="button" accesskey="o" name="addbbcode12" value="List=" style="width: 40px" onclick="bbstyle(12)" onmouseover="helpline('o')" /></td>
-						<td><input class="btnlite" type="button" accesskey="p" name="addbbcode14" value="Img" style="width: 40px"  onclick="bbstyle(14)" onmouseover="helpline('p')" /></td>
-						<td><input class="btnlite" type="button" accesskey="w" name="addbbcode18" value="URL" style="text-decoration: underline; width: 40px" onclick="bbstyle(18)" onmouseover="helpline('w')" /></td>
-					</tr>
-					<tr>
-						<td colspan="9"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-							<tr>
-								<td><span class="genmed"> &nbsp;<?php echo $_CLASS['core_user']->lang['FONT_SIZE']; ?>:</span> <select name="addbbcode20" onchange="bbfontstyle('[size=' + this.form.addbbcode20.options[this.form.addbbcode20.selectedIndex].value + ']', '[/size]');this.form.addbbcode20.selectedIndex = 2;" onmouseover="helpline('f')">
-									<option value="7"><?php echo $_CLASS['core_user']->lang['FONT_TINY']; ?></option>
-									<option value="9"><?php echo $_CLASS['core_user']->lang['FONT_SMALL']; ?></option>
-									<option value="12" selected="selected"><?php echo $_CLASS['core_user']->lang['FONT_NORMAL']; ?></option>
-									<option value="18"><?php echo $_CLASS['core_user']->lang['FONT_LARGE']; ?></option>
-									<option  value="24"><?php echo $_CLASS['core_user']->lang['FONT_HUGE']; ?></option>
-								</select></td>
-								<td class="gensmall" nowrap="nowrap" align="right"><a href="javascript:bbstyle(-1)" onmouseover="helpline('a')"><?php echo $_CLASS['core_user']->lang['CLOSE_TAGS']; ?></a></td>
-							</tr>
-						</table></td>
-					</tr>
-					<tr>
-						<td colspan="9"><input class="helpline" type="text" name="helpbox" size="45" maxlength="100" value="<?php echo $_CLASS['core_user']->lang['STYLES_TIP']; ?>" /></td>
-					</tr>
-					<tr>
-						<td colspan="9"><textarea name="signature" rows="6" cols="60" tabindex="3" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);"><?php echo $user_sig; ?></textarea></td>
-					</tr>
-					<tr>
-						<td colspan="9"><table cellspacing="0" cellpadding="0" border="0">
-							<tr>
-								<td bgcolor="black"><script language="javascript" type="text/javascript"><!--
-
-								colorPalette('h', 14, 5)
-
-								//--></script></td>
-							</tr>
-						</table></td>
-					</tr>
-				</table></td>
-			</tr>
-			<tr>
-				<td class="row1" valign="top"><b class="genmed"><?php echo $_CLASS['core_user']->lang['OPTIONS']; ?></b><br /><table cellspacing="2" cellpadding="0" border="0">
-					<tr>
-						<td class="gensmall"><?php echo ($config['allow_html']) ? $_CLASS['core_user']->lang['HTML_IS_ON'] : $_CLASS['core_user']->lang['HTML_IS_OFF']; ?></td>
-					</tr>
-					<tr>
-						<td class="gensmall"><?php echo ($config['allow_bbcode']) ? sprintf($_CLASS['core_user']->lang['BBCODE_IS_ON'], '<a href="'.getlink('Forums&amp;file=&amp;mode=bbcode').'" target="_blank">', '</a>') : sprintf($_CLASS['core_user']->lang['BBCODE_IS_OFF'], '<a href="'.getlink('Forums&amp;file=&amp;mode=bbcode').'" target="_blank">', '</a>'); ?></td>
-					</tr>
-					<tr>
-						<td class="gensmall"><?php echo ($config['allow_img']) ? $_CLASS['core_user']->lang['IMAGES_ARE_ON'] : $_CLASS['core_user']->lang['IMAGES_ARE_OFF']; ?></td>
-					</tr>
-					<tr>
-						<td class="gensmall"><?php echo ($config['allow_flash']) ? $_CLASS['core_user']->lang['FLASH_IS_ON'] : $_CLASS['core_user']->lang['FLASH_IS_OFF']; ?></td>
-					</tr>
-					<tr>
-						<td class="gensmall"><?php echo ($config['allow_smilies']) ? $_CLASS['core_user']->lang['SMILIES_ARE_ON'] : $_CLASS['core_user']->lang['SMILIES_ARE_OFF']; ?></td>
-					</tr>
-				</table></td>
-				<td class="row2" valign="top"><table cellspacing="0" cellpadding="1" border="0">
-<?php
-
-			if ($config['allow_html'])
-			{
-			
-?>
-					<tr>
-						<td><input type="checkbox" name="disable_html" /></td>
-						<td class="gen"><?php echo $_CLASS['core_user']->lang['DISABLE_HTML']; ?></td>
-					</tr>
-<?php
-
-			}
-
-			if ($config['allow_bbcode'])
-			{
-			
-?>
-					<tr>
-						<td><input type="checkbox" name="disable_bbcode" /></td>
-						<td class="gen"><?php echo $_CLASS['core_user']->lang['DISABLE_BBCODE']; ?></td>
-					</tr>
-<?php
-
-			}
-
-			if ($config['allow_smilies'])
-			{
-			
-?>
-					<tr>
-						<td><input type="checkbox" name="disable_smilies" /></td>
-						<td class="gen"><?php echo $_CLASS['core_user']->lang['DISABLE_SMILIES']; ?></td>
-					</tr>
-<?php
-
-			}
-			
-?>
-					<tr>
-						<td><input type="checkbox" name="disable_magic_url" /></td>
-						<td class="gen"><?php echo $_CLASS['core_user']->lang['DISABLE_MAGIC_URL']; ?></td>
-					</tr>
-				</table></td>
-			</tr>
-			<tr>
-				<td class="cat" colspan="2" align="center"><input class="btnlite" type="submit" name="preview" value="<?php echo $_CLASS['core_user']->lang['PREVIEW']; ?>" />&nbsp;&nbsp;<input class="btnmain" type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-			</tr>
-<?php
-
-			if ($signature_preview)
-			{
-			
-?>
-			<tr>
-				<th colspan="2" valign="middle"><?php echo $_CLASS['core_user']->lang['ADMIN_SIGNATURE_PREVIEW']; ?></th>
-			</tr>
-			<tr> 
-				<td class="row1" colspan="2"><div class="postdetails" style="padding: 6px;"><?php echo $signature_preview; ?></div></td>
-			</tr>
-<?php
-
-			}
-			
-?>
-<?php
-
-			break;
-
-		case 'groups':
-
-			switch ($action)
-			{
-				case 'demote':
-				case 'promote':
-				case 'default':
-					group_user_attributes($action, $gid, $user_id);
-
-					if ($action == 'default')
-					{
-						$group_id = $gid;
-					}
-					break;
-
-				case 'delete':
-					if (!$cancel && !$confirm)
-					{
-						adm_page_confirm($_CLASS['core_user']->lang['CONFIRM'], $_CLASS['core_user']->lang['CONFIRM_OPERATION']);
-					}
-					else if (!$cancel) 
-					{
-						if (!$gid)
-						{
-							trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-						}
-
-						if ($error = group_user_del($gid, $user_id))
-						{
-							trigger_error($_CLASS['core_user']->lang[$error]);
-						}
-					}
-				break;
-			}
-
-			// Add user to group?
-			if ($submit)
-			{
-				if (!$gid)
-				{
-					trigger_error($_CLASS['core_user']->lang['NO_GROUP']);
-				}
-
-				// Add user/s to group
-				if ($error = group_user_add($gid, $user_id))
-				{
-					trigger_error($_CLASS['core_user']->lang[$error]);
-				}
-			}
-
-			$colspan = 4;
-
-?>
-			<tr>
-				<th colspan="4"><?php echo $_CLASS['core_user']->lang['USER_ADMIN_GROUPS']; ?></th>
-			</tr>
-<?php
-
-			$sql = 'SELECT ug.group_leader, g.* 
-				FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . " ug 
-				WHERE ug.user_id = $user_id
-					AND g.group_id = ug.group_id
-				ORDER BY g.group_type DESC, ug.user_pending ASC, g.group_name";
-			$result = $db->sql_query($sql);
-	
-			$i = 0;
-			$group_data = $id_ary = array();
-			while ($row = $db->sql_fetchrow($result))
-			{
-				$type = ($row['group_type'] == GROUP_SPECIAL) ? 'special' : (($row['user_pending']) ? 'pending' : 'normal');
-
-				$group_data[$type][$i]['group_id']		= $row['group_id'];
-				$group_data[$type][$i]['group_name']	= $row['group_name'];
-				$group_data[$type][$i]['group_leader']	= ($row['group_leader']) ? 1 : 0;
-
-				$id_ary[] = $row['group_id'];
-
-				$i++;
-			}
-			$db->sql_freeresult($result);
-
-			// Select box for other groups
-			$sql = 'SELECT group_id, group_name, group_type 
-				FROM ' . GROUPS_TABLE . ' 
-				WHERE group_id NOT IN (' . implode(', ', $id_ary) . ')
-				ORDER BY group_type DESC, group_name ASC';
-			$result = $db->sql_query($sql);
-
-			$group_options = '';
-			while ($row = $db->sql_fetchrow($result))
-			{
-				$group_options .= '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
-			}
-			$db->sql_freeresult($result);
-
-			$current_type = '';
-			foreach ($group_data as $group_type => $data_ary)
-			{
-				if ($current_type != $group_type)
-				{
-
-?>
-			<tr>
-				<td class="row3" colspan="4"><strong><?php echo $_CLASS['core_user']->lang['USER_GROUP_' . strtoupper($group_type)]; ?></strong></td>
-			</tr>
-<?php
-
-				}
-
-				foreach ($data_ary as $data)
-				{
-					$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?>
-			<tr>
-				<td class="<?php echo $row_class; ?>"><a href="<?php echo adminlink('forums&amp;file=admin_groups&amp;mode=manage&amp;action=edit&amp;g=' . $data['group_id']); ?>"><?php echo ($group_type == 'special') ? $_CLASS['core_user']->lang['G_' . $data['group_name']] : $data['group_name']; ?></a></td>
-				<td class="<?php echo $row_class; ?>" width="10%" nowrap="nowrap">&nbsp;<?php 
-
-					if ($group_id != $data['group_id'])
-					{
-
-?><a href="<?php echo adminlink("forums&amp;file=admin_users&amp;mode=$mode&amp;action=default&amp;u=$user_id&amp;g=" . $data['group_id']); ?>"><?php echo $_CLASS['core_user']->lang['GROUP_DEFAULT']; ?></a><?php
-	
-					}
-					else
-					{
-						echo $_CLASS['core_user']->lang['GROUP_DEFAULT'];
-					}
-					
-?>&nbsp;</td>
-				<td class="<?php echo $row_class; ?>" width="10%" nowrap="nowrap">&nbsp;<?php
-	
-					if ($group_type != 'special')
-					{
-
-?><a href="<?php echo adminlink("forums&amp;file=admin_users&amp;mode=$mode&amp;action=" . (($data['group_leader']) ? 'demote' : 'promote') . "&amp;u=$user_id&amp;g=" . $data['group_id']); ?>"><?php echo ($data['group_leader']) ? $_CLASS['core_user']->lang['GROUP_DEMOTE'] : $_CLASS['core_user']->lang['GROUP_PROMOTE']; ?></a>&nbsp;<?php
-	
-					}
-					
-?></td>
-				<td class="<?php echo $row_class; ?>" width="10%" nowrap="nowrap">&nbsp;<a href="<?php echo adminlink("forums&amp;file=&amp;mode=$mode&amp;action=delete&amp;u=$user_id&amp;g=" . $data['group_id']); ?>"><?php echo $_CLASS['core_user']->lang['GROUP_DELETE']; ?></a>&nbsp;</td>
-			</tr>
-<?php
-
-				}
-			}
-
-?>
-			<tr>
-				<td class="cat" colspan="4" align="right"><?php echo $_CLASS['core_user']->lang['USER_GROUP_ADD']; ?>: <select name="g"><?php echo $group_options; ?></select> <input class="btnmain" type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;</td>
-			</tr>
-<?php
-
-			break;
-
-
-		case 'perm':
-			break;
-
-
-		case 'attach':
-
-			if ($deletemark && $marked)
-			{
-				if (!$cancel && !$confirm)
-				{
-					adm_page_confirm($_CLASS['core_user']->lang['CONFIRM'], $_CLASS['core_user']->lang['CONFIRM_OPERATION']);
-				}
-				else if (!$cancel) 
-				{
-					$sql = 'SELECT real_filename
-						FROM ' . ATTACHMENTS_TABLE . '
-						WHERE attach_id IN (' . implode(', ', $marked) . ')';
-					$result = $db->sql_query($sql);
-
-					$log_attachments = array();
-					while ($row = $db->sql_fetchrow($result))
-					{
-						$log_attachments[] = $row['real_filename'];
-					}
-					$db->sql_freeresult($result);
-
-					delete_attachments('attach', $marked);
-
-					$log = (sizeof($delete_ids) == 1) ? 'ATTACHMENT_DELETED' : 'ATTACHMENTS_DELETED';
-					$meesage = (sizeof($delete_ids) == 1) ? $_CLASS['core_user']->lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']->lang['ATTACHMENTS_DELETED'];
-
-					add_log('admin', $log, implode(', ', $log_attachments));
-					trigger_error($message);
-				}
-			}
-
-			$colspan = 6;
-	
-			$uri = "forums&amp;file=admin_users&amp;mode=$mode&amp;action=$action&amp;u=$user_id";
-
-			$sk_text = array('a' => $_CLASS['core_user']->lang['SORT_FILENAME'], 'b' => $_CLASS['core_user']->lang['SORT_COMMENT'], 'c' => $_CLASS['core_user']->lang['SORT_EXTENSION'], 'd' => $_CLASS['core_user']->lang['SORT_SIZE'], 'e' => $_CLASS['core_user']->lang['SORT_DOWNLOADS'], 'f' => $_CLASS['core_user']->lang['SORT_POST_TIME'], 'g' => $_CLASS['core_user']->lang['SORT_TOPIC_TITLE']);
-			$sk_sql = array('a' => 'a.real_filename', 'b' => 'a.comment', 'c' => 'a.extension', 'd' => 'a.filesize', 'e' => 'a.download_count', 'f' => 'a.filetime', 'g' => 't.topic_title');
-
-			$sd_text = array('a' => $_CLASS['core_user']->lang['ASCENDING'], 'd' => $_CLASS['core_user']->lang['DESCENDING']);
-	
-			$s_sort_key = '';
-			foreach ($sk_text as $key => $value)
-			{
-				$selected = ($sk == $key) ? ' selected="selected"' : '';
-				$s_sort_key .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
-			}
-
-			$s_sort_dir = '';
-			foreach ($sd_text as $key => $value)
-			{
-				$selected = ($sd == $key) ? ' selected="selected"' : '';
-				$s_sort_dir .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
-			}
-
-			$order_by = $sk_sql[$sk] . '  ' . (($sd == 'a') ? 'ASC' : 'DESC');
-	
-			$sql = 'SELECT COUNT(*) as num_attachments
-				FROM ' . ATTACHMENTS_TABLE . "
-				WHERE poster_id = $user_id";
-			$result = $db->sql_query_limit($sql, 1);
-
-			$num_attachments = $db->sql_fetchfield('num_attachments', 0, $result);
-			$db->sql_freeresult($result);
-
-			$sql = 'SELECT a.*, t.topic_title
-				FROM ' . ATTACHMENTS_TABLE . ' a, ' . TOPICS_TABLE . " t
-				WHERE a.topic_id = t.topic_id
-					AND a.poster_id = $user_id
-				ORDER BY $order_by";
-			$result = $db->sql_query_limit($sql, $config['posts_per_page'], $start);
-
-			$row_count = 0;
-			if ($row = $db->sql_fetchrow($result))
-			{
-				$class = 'row2';
-
-?>
-				<tr>
-					<th nowrap="nowrap">#</th>
-					<th nowrap="nowrap" width="15%"><a class="th" href="<?php echo adminlink("$uri&amp;sk=a&amp;sd=" . (($sk == 'a' && $sd == 'a') ? 'd' : 'a')); ?>"><?php echo $_CLASS['core_user']->lang['FILENAME']; ?></a></th>
-					<th nowrap="nowrap" width="5%"><a class="th" href="<?php echo adminlink("$uri&amp;sk=f&amp;sd=" . (($sk == 'f' && $sd == 'a') ? 'd' : 'a')); ?>"><?php echo $_CLASS['core_user']->lang['POST_TIME']; ?></a></th>
-					<th nowrap="nowrap" width="5%"><a class="th" href="<?php echo adminlink("$uri&amp;sk=d&amp;sd=" . (($sk == 'd' && $sd == 'a') ? 'd' : 'a')); ?>"><?php echo $_CLASS['core_user']->lang['FILESIZE']; ?></a></th>
-					<th nowrap="nowrap" width="5%"><a class="th" href="<?php echo adminlink("$uri&amp;sk=e&amp;sd=" . (($sk == 'e' && $sd == 'a') ? 'd' : 'a')); ?>"><?php echo $_CLASS['core_user']->lang['DOWNLOADS']; ?></a></th>
-					<th width="2%" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['DELETE']; ?></th>
-				</tr>
-<?php
-
-				do
-				{
-					$view_topic = getlink('Forums&amp;file=viewtopic&amp;t=' . $row['topic_id'] . '&amp;p=' . $row['post_id'] . '#' . $row['post_id']);
-
-					$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?>
-					<tr>
-						<td class="<?php echo $row_class; ?>" style="padding: 4px;" width="2%" align="center"><span class="gen">&nbsp;<?php echo $row_count + ($start + 1); ?>&nbsp;</span></td>
-						<td class="<?php echo $row_class; ?>" style="padding: 4px;"><a class="gen" href="<?php echo getlink('Forums&amp;file=download&amp;id=' . $row['attach_id']); ?>" target="_blank"><?php echo $row['real_filename']; ?></a><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['TOPIC']; ?>: <a href="<?php echo $view_topic; ?>" target="_blank"><?php echo $row['topic_title']; ?></a></span></td>
-						<td class="<?php echo $row_class; ?>" class="gensmall" style="padding: 4px;" align="center" nowrap="nowrap">&nbsp;<?php echo $_CLASS['core_user']->format_date($row['filetime'], $_CLASS['core_user']->lang['DATE_FORMAT']); ?>&nbsp;</td>
-						<td class="<?php echo $row_class; ?>" style="padding: 4px;" align="center" nowrap="nowrap"><span class="gen"><?php echo ($row['filesize'] >= 1048576) ? (round($row['filesize'] / 1048576 * 100) / 100) . ' ' . $_CLASS['core_user']->lang['MB'] : (($row['filesize'] >= 1024) ? (round($row['filesize'] / 1024 * 100) / 100) . ' ' . $_CLASS['core_user']->lang['KB'] : $row['filesize'] . ' ' . $_CLASS['core_user']->lang['BYTES']); ?></span></td>
-						<td class="<?php echo $row_class; ?>" style="padding: 4px;" align="center"><span class="gen"><?php echo $row['download_count']; ?></span></td>
-						<td class="<?php echo $row_class; ?>" style="padding: 4px;" align="center"><input type="checkbox" name="mark[]" value="<?php echo $row['attach_id']; ?>" /></td>
-					</tr>
-<?php
-
-					$row_count++;
-				} 
-				while ($row = $db->sql_fetchrow($result));
-			}
-			$db->sql_freeresult($result);
-			
-			$pagination = generate_pagination("$uri&amp;sk=$sk&amp;sd=$sd", $num_attachments, $config['topics_per_page'], $start);
-
-?>
-					<tr>
-						<td class="cat" colspan="<?php echo $colspan; ?>"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-							<tr>
-								<td width="100%" align="center"><span class="gensmall"><?php echo $_CLASS['core_user']->lang['SORT_BY']; ?>: </span><select name="sk"><?php echo $s_sort_key; ?></select> <select name="sd"><?php echo $s_sort_dir; ?></select>&nbsp;<input class="btnlite" type="submit" name="sort" value="<?php echo $_CLASS['core_user']->lang['SORT']; ?>" /></td>
-								<td align="right"><input class="btnlite" type="submit" name="delmarked" value="<?php echo $_CLASS['core_user']->lang['DELETE_MARKED']; ?>" />&nbsp;</td>
-							</tr>
-						</table></td>
-					</tr>
-				</table></td>
-			</tr>
-<?php
-
-			break;
-	}
-
-
-?>
-		</table></td>
-	</tr>
-
-<?php
-
-
-	if ($pagination)
-	{
-
-?>
-	<tr>
-		<td align="right"><?php echo $pagination; ?></td>
-	</tr>
-<?php
-
-	}
-
-?>
-</table></form>
-
-<?php
-
-	adm_page_footer();
-
-}
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['USER_ADMIN']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['USER_ADMIN_EXPLAIN']; ?></p>
-
-<form method="post" name="post" action="<?php echo adminlink('forums&amp;file=admin_users'); ?>"><table class="bg" width="75%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"align="center"><?php echo $_CLASS['core_user']->lang['SELECT_USER']; ?></th>
-	</tr>
-	<tr> 
-		<td class="row1" width="40%"><b><?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?>: </b><br /><span class="gensmall">[ <a href="<?php echo getlink('Members_List&amp;mode=searchuser&amp;field=username'); ?>" onclick="window.open('<?php echo getlink('Members_List&amp;mode=searchuser&amp;field=username')?>', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;"><?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?></a> ]</span></td>
-		<td class="row2"><input type="text" class="post" name="username" maxlength="50" size="20" /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center"><input type="submit" name="submituser" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" /></td>
-	</tr>
-</table></form>
-
-<?php
-
-adm_page_footer();
-
-
-// Module class
-class acp_admin_users extends module
-{
-
-
-
-
-}
-
-?>
\ No newline at end of file

Modified: trunk/includes/forums/functions.php
===================================================================
--- trunk/includes/forums/functions.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/functions.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -499,28 +499,6 @@
 	return;
 }
 
-function language_select($default = '')
-{
-}
-
-// Pick a timezone
-function tz_select($default = '')
-{
-	global $sys_timezone, $_CLASS;
-
-	$tz_select = '';
-	foreach ($_CLASS['core_user']->lang['tz']['zones'] as $offset => $zone)
-	{
-		if (is_numeric($offset))
-		{
-			$selected = ($offset == $default) ? ' selected="selected"' : '';
-			$tz_select .= '<option value="' . $offset . '"' . $selected . '>' . $zone . '</option>';
-		}
-	}
-
-	return $tz_select;
-}
-
 // Topic and forum watching common code
 function watch_topic_forum($mode, &$s_watching, $user_id, $match_id, $notify_status = 'unset', $start = 0)
 {

Modified: trunk/includes/forums/message_parser.php
===================================================================
--- trunk/includes/forums/message_parser.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/message_parser.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -942,7 +942,7 @@
 			// NOTE: obtain_* function? chaching the table contents?
 			
 
-			$sql = 'SELECT * FROM ' . SMILIES_TABLE;
+			$sql = 'SELECT * FROM ' . SMILIES_TABLE .' ORDER BY LENGTH(smiley_code) DESC';;
 			$result = $_CLASS['core_db']->query($sql);
 
 			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/functions.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -647,45 +647,6 @@
 	return (STRIP_SLASHES) ? stripslashes($str) : $str ;
 }
 
-function theme_select($default = false)
-{
-	global $site_file_root, $_CLASS;
-	
-	$themetmp = array();
-	$default = ($default) ? $default : $_CLASS['core_display']->theme_name;
-	
-	$theme = '';
-	$handle = opendir($site_file_root.'themes');
-	while ($file = readdir($handle))
-	{
-		if ($file{0} !== '.')
-		{
-			if (file_exists($site_file_root."themes/$file/index.php"))
-			{
-				$themetmp[] = array('file' => $file, 'template'=> true);
-			}
-		}
-	}
-	
-	closedir($handle);
-	
-	$count = count($themetmp);
-	
-	for ($i = 0; $i < $count; $i++)
-	{
-		if ($themetmp[$i]['file'] == $default)
-		{
-			$theme .= '<option value="'.$themetmp[$i]['file'].'" selected="selected">'.$themetmp[$i]['file'].'</option>';
-		}
-		else
-		{
-			$theme .= '<option value="'.$themetmp[$i]['file'].'">'.$themetmp[$i]['file'].'</option>';
-		}
-	}
-	
-	return $theme;
-}
-
 function modify_lines($text, $replacement = '')
 {
 	return str_replace(array("\r\n", "\r", "\n"), $replacement, $text);
@@ -717,6 +678,78 @@
 	script_close($save);
 }
 
+function select_language($default = '')
+{
+}
+
+function select_theme($default = false)
+{
+	global $site_file_root, $_CLASS;
+	
+	if (!$default)
+	{
+		$default = $_CLASS['core_display']->theme_name;
+	}
+	
+	$theme_array = array();
+	$handle = opendir($site_file_root.'themes');
+	
+	while ($file = readdir($handle))
+	{
+		if ($file{0} !== '.')
+		{
+			if (file_exists($site_file_root."themes/$file/index.php"))
+			{
+				$theme_array[] = array('file' => $file, 'template'=> true);
+			}
+		}
+	}
+	
+	closedir($handle);
+	
+	$count = count($theme_array);
+	$select = '';
+
+	for ($i = 0; $i < $count; $i++)
+	{
+		$selected = ($theme_array[$i]['file'] == $default) ? ' selected="selected"' : '';
+		$select .= '<option value="'.$theme_array[$i]['file']."\" $selected>".$theme_array[$i]['file']."</option>\n";
+	}
+
+	return $select;
+}
+
+function tz_array()
+{
+	return array('-12', '-11', '-10', '-9', '-8', '-7', '-6', '-5', '-4', '-3.5', '-3', '-2', '-1', '0', 
+			'1', '2', '3','3.5', '4', '4.5', '5', '5.5', '6', '6.5', '7', '8', '9.5', '10', '11', '12');
+}
+
+function select_tz($default = false)
+{
+	global $_CLASS;
+
+	$tz_array = tz_array();
+
+	$count = count($tz_array);
+	$select = '';
+	
+	/*if (!$default)
+	{
+		$default = $_CORE_CONFIG['global']['default_timezone'];
+	}*/
+	
+	for ($i = 0; $i < $count; $i++)
+	{
+		$selected = ($tz_array[$i] == $default) ? ' selected="selected"' : '';
+		$tz_dis = isset($_CLASS['core_user']->lang['tz']['zones'][$tz_array[$i]]) ? $_CLASS['core_user']->lang['tz']['zones'][$tz_array[$i]] : 'Zone '.$tz_array[$i];
+
+		$select .= '<option value="'.$tz_array[$i]."\" $selected>$tz_dis</option>\n";
+	}
+
+	return $select;
+}
+
 function url_redirect($url = false, $save = false)
 {
 	redirect($url = false, $save = false);

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/functions_user.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -85,7 +85,8 @@
 		'group_id'		=> (int) $data['user_group'],
 		'member_user_id'=> (int) $user_id,
 		'member_status'	=> $data['user_status']
-	);
+	));
+	
 	$_CLASS['core_db']->query($sql);
 
 	$_CLASS['core_db']->transaction('commit');
@@ -317,8 +318,8 @@
 {
 	global $_CLASS;
 
-	$group_ids = is_array($group_id) ? $group_id : array($group_id);
-	$user_ids = is_array($user_id) ? $user_id : array($user_id);
+	$group_id = is_array($group_id) ? $group_id : array($group_id);
+	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
 	$group_id = array_map('intval', $group_id);
 
@@ -372,8 +373,8 @@
 {
 	global $_CLASS;
 
-	$group_ids = is_array($group_id) ? $group_id : array($group_id);
-	$user_ids = is_array($user_id) ? $user_id : array($user_id);
+	$group_id = is_array($group_id) ? $group_id : array($group_id);
+	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
 	$group_id = array_map('intval', $group_id);
 	$user_id = array_map('intval', $user_id);
@@ -383,42 +384,23 @@
 		return;
 	}
 
-	$sql = 'SELECT member_user_id, member_status FROM ' . USER_GROUP_TABLE . ' 
-				WHERE group_id IN (' . implode(', ', $group_id) . ')
-				AND member_user_id IN (' . implode(', ', $user_id) . ')
-				AND  = '.$status;
-	$result = $_CLASS['core_db']->query($sql);
+	$_CLASS['core_db']->transaction();
 
-	$update_array = array();
-	$ignore_array = array();
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	foreach ($user_id as $u_id)
 	{
-		$update_id[] = $row['user_id'];
+		foreach ($group_id as $g_id)
+		{
+			$data = array(
+				'group_id'		=> (int) $g_id,
+				'user_id'		=> (int) $u_id,
+				'member_status'	=> (int) $status,
+			);
+		
+			$_CLASS['core_db']->query('INSERT INTO '.USER_GROUP_TABLE.' '.$_CLASS['core_db']->sql_build_array('INSERT', $data));
+		}
 	}
-	$_CLASS['core_db']->free_result($result);
-	
-	// We move all users that are removed from the default groups to
-	// REGISTERED / REGISTERED_COPPA
-	if (!empty($defaults))
-	{
-// need to update/completion
-		$result = $_CLASS['core_db']->query('SELECT * FROM ' . GROUPS_TABLE . ' 	WHERE group_id = 4');
 
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		$sql = 'UPDATE FROM '. USERS_TABLE .' 
-					SET group_id = 4, user_rank = -1
-					WHERE user_id IN (' . implode(', ', $group_id) . ')';
-		$result = $_CLASS['core_db']->query($sql);
-	}
-
-	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . '
-		WHERE group_id IN ('. implode(', ', $group_id) . ')
-		AND user_id IN ('. implode(', ', $user_id) .')';
-
-	$result = $_CLASS['core_db']->query($sql);
+	$_CLASS['core_db']->transaction('commit');
 }
 
 function validate_username($username)
@@ -436,14 +418,15 @@
 
 	if ($length > $_CORE_CONFIG['user']['max_name_chars'] || $length < $_CORE_CONFIG['user']['min_name_chars'])
 	{
-		return 'INVALID_LENGHT';
+		return 'USERNAME_INVALID_LENGHT';
 	}
 
 	if (!preg_match('#^' . $_CORE_CONFIG['user']['allow_name_chars'] . '$#i', $username))
 	{
-		return 'INVALID_CHARS';
+		return 'USERNAME_INVALID_CHARS';
 	}
-
+
+// wouldn't select limit be better ?
 	$sql = 'SELECT COUNT(*) as count
 		FROM ' . USERS_TABLE . "
 		WHERE LOWER(username) = '" . $_CLASS['core_db']->escape($username) . "'";

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/session.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -30,6 +30,8 @@
 	var $sid_link_prefex = 'sid';
 	var $sid_link = false;
 
+	var $autologin_code = false;
+
 	function start()
 	{
 		global $_CLASS, $_CORE_CONFIG, $SID, $mod;
@@ -253,10 +255,10 @@
 		{
 			$return = $user_id;
 			
-			$new_code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
+			$this->autologin_code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
 
 			$data_array = array(
-				'auto_login_code'		=> (string) $new_code,
+				'auto_login_code'		=> (string) $this->autologin_code,
 				'auto_login_time'		=> (int) $this->time,
 			);
 		
@@ -267,7 +269,7 @@
 
 			// need to update both the code and the user_id,
 			// since user_id cookie has an expiry time
-			$this->set_cookie('alc', $new_code, $this->time + 2592000);
+			$this->set_cookie('alc', $this->autologin_code, $this->time + 2592000);
 			$this->set_cookie('ali', $user_id, $this->time + 2592000);
 		}
 
@@ -293,14 +295,17 @@
 		{
 			$session_id = $this->data['session_id'];
 			
-			$this->set_cookie('sid', '', $this->time - 31536000);
+			if ($logout)
+			{
+				$this->set_cookie('sid', '', $this->time - 31536000);
+	
+				if ($this->autologin_code)
+				{
+					$this->autologin_destroy($this->data['user_id'], $this->autologin_code);
+				}
+			}
 		}
 
-		if ($logout)
-		{
-			
-		}
-
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . "
 			WHERE session_id = '" . $_CLASS['core_db']->escape($session_id)."'";
 

Modified: trunk/javascript/collapse.js
===================================================================
--- trunk/javascript/collapse.js	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/javascript/collapse.js	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,41 +1,46 @@
 // Collapse Code by Ryan Marshall ( viperal1 at gmail.com )
 
-// If we use this on news, we need some kind of true gc.
-// May not be possible tho without some php stuff
+/*
+* To do:
+*
+*	Add some kind of slide effect
+*	Auto opening on mouse over maybe ( closeing on mouse out ) ?	
+*/
 
-function get_cookie(Name)
+function get_cookie(cookie_name)
 {
-	var cookie_name = Name + "=";
+	var cookie_prefix = cookie_name + "=";
 	var cookie_length = document.cookie.length;
 
 	if (cookie_length > 0)
 	{
-		var offset = document.cookie.indexOf(cookie_name);
+		var start = document.cookie.indexOf(cookie_prefix);
 
-		if (offset != -1)
+		if (start != -1)
 		{
-			offset += cookie_name.length;
-			var end = document.cookie.indexOf(';', offset);
+			start += cookie_prefix.length;
+			var end = document.cookie.indexOf(';', start);
 
 			if (end == -1)
 			{
 				end = cookie_length;
 			}
 
-			return unescape(document.cookie.substring(offset, end));
+			return unescape(document.cookie.substring(start, end));
 		}
-	}
+	}
+
 	return null;
 }
 
-function set_cookie(name, value, expires)
+function set_cookie(cookie_name, value, expires)
 {
-	document.cookie = name + '=' + escape(value) + '; path=/; expires=' + expires.toGMTString();
+	document.cookie = cookie_name + '=' + escape(value) + '; path=/; expires=' + expires.toGMTString();
 }
 
-function delete_cookie(name)
+function delete_cookie(cookie_name)
 {
-	document.cookie = name + '=' + '; expires=Thu, 01-Jan-70 00:00:01 GMT' +  '; path=/';
+	document.cookie = cookie_name + '=' + '; expires=Thu, 01-Jan-70 00:00:01 GMT' +  '; path=/';
 }
 
 function array_search(needle, haystack, strict)
@@ -50,55 +55,57 @@
 
 	return null;
 }
-
-function switch_collapse(id, name)
+
+function switch_collapse(identifier, cookie)
 {
-	var area = document.getElementById(id);
+	var area = document.getElementById(identifier);
+	var img = document.getElementById(identifier + '_img');
+
+	var item = document.getElementById(identifier + '_item');
 
 	if (area.style.display == 'none')
 	{
 		area.style.display = '';
-		switch_collapse_save(id, false, name);
+		switch_collapse_save(identifier, false, cookie);
+		
+		if (img)
+		{
+			img.src = img.src.replace('show', 'hide');
+		}
+
+		if (item)
+		{
+			item.className = item.className.replace('show', 'hide');
+		}
 	}
 	else
 	{
 		area.style.display = 'none';
-		switch_collapse_save(id, id, name);
-	}
-}
+		switch_collapse_save(identifier, true, cookie);
+		
+		if (img)
+		{
+			img.src = img.src.replace('hide', 'show');
+		}
 
-function switch_collapse_img(id, img_show, img_hide, name)
-{
-	var area = document.getElementById(id);
-	var img = document.getElementById(id+'_img');
-
-	if (area.style.display == 'none')
-	{
-		area.style.display = '';
-		img.src = img_show;
-
-		switch_collapse_save(id, false, name);
+		if (item)
+		{
+			item.className = item.className.replace('hide', 'show');
+		}
 	}
-	else
-	{
-		area.style.display = 'none';
-		img.src = img_hide;
-
-		switch_collapse_save(id, id, name);
-	}
 }
 
-function switch_collapse_save(id, save, name)
+function switch_collapse_save(identifier, save, cookie_name)
 {
 	// typeof name == 'undefined'
-	if (!name)
+	if (!cookie_name)
 	{
-		name = 'collapsed_items';
+		cookie_name = 'collapsed_items';
 	}
 
-	//alert(name);
+	//alert(cookie_name);
 
-	var collapsed_cookie = get_cookie(name);
+	var collapsed_cookie = get_cookie(cookie_name);
 	var collapsed_items = new Array();
 	var set = false;
 
@@ -108,7 +115,7 @@
 
 		for (var i in collapsed_cookie)
 		{
-			if (collapsed_cookie[i] == id)
+			if (collapsed_cookie[i] == identifier)
 			{
 				if (set == false)
 				{
@@ -116,7 +123,7 @@
 
 					if (save != false)
 					{
-						collapsed_items.push(id);
+						collapsed_items.push(identifier);
 					}
 				}
 			}
@@ -129,7 +136,7 @@
 
 	if (set == false && save != false)
 	{
-		collapsed_items.push(id);
+		collapsed_items.push(identifier);
 	}
 
 	//alert(collapsed_items.join(':'));
@@ -138,10 +145,10 @@
 		var expires = new Date()
 
 		expires.setTime(expires.getTime() + 31536000000);
-		set_cookie(name, collapsed_items.join(':'), expires)
+		set_cookie(cookie_name, collapsed_items.join(':'), expires)
 	}
 	else
 	{
-		delete_cookie(name)
+		delete_cookie(cookie_name)
 	}
 }
\ No newline at end of file

Modified: trunk/javascript/menu.js
===================================================================
--- trunk/javascript/menu.js	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/javascript/menu.js	2005-08-24 15:00:26 UTC (rev 89)
@@ -116,9 +116,6 @@
 
 	menu.style.display	= '';
 	
-//Move to init function, once done
-	menu.style.position	= 'absolute';
-
 	if ((object_offsets['left'] + menu.offsetWidth) > document.body.clientWidth)
 	{
 		// It to wide to show on the right so we have to put it on the left

Modified: trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,16 +1,26 @@
 <?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_groups.php,v 1.1 2004/09/01 15:47:45 psotfx Exp $
-//
-// FILENAME  : ucp_groups.php
-// STARTED   : Sun Jun 6, 2004
-// COPYRIGHT : ? 2001, 2004 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
-//
-// -------------------------------------------------------------
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class ucp_groups extends module
 {
 	function ucp_groups($id, $mode)
@@ -19,30 +29,34 @@
 
 		$_CLASS['core_user']->add_lang('groups');
 
-		$submit	= !empty($_POST['submit']);
+		$submit	= isset($_POST['submit']) ? $_POST['submit'] : false;
 
-		if (is_array($_POST['group_id']))
+		if ($submit && !empty($_POST['group_id']))
 		{
-			$group_id = array_map('intval', get_variable('group_id', 'REQUEST', false, 'array'));
-		}
-		elseif 
-		{
-			if ($group_id = get_variable('group_id', 'REQUEST', false, 'interger'))
+			if (is_array($_POST['group_id']))
 			{
-				$group_id = array($group_id);
+				$group_id = array_map('intval', get_variable('group_id', 'REQUEST', false, 'array'));
 			}
-		}
-	
-
-		if ($submit && !empty($group_id))
-		{
+			else
+			{
+				if ($group_id = get_variable('group_id', 'REQUEST', false, 'interger'))
+				{
+					$group_id = array($group_id);
+				}
+				else
+				{
+					die;
+				}
+			}
+//empty(array())
 			require_once($site_file_root.'includes/functions_user.php');
 
 			switch ($_POST['mode'])
 			{
 				case 'resign':
+// need to get member status and add other group types ( pending members can resign from all )
 					$sql = 'SELECT group_id	FROM  ' . GROUPS_TABLE . '
-								WHERE group_type = ' . GROUP_SPECIAL .'
+								WHERE group_type = ' . GROUP_SYSTEM .'
 								AND group_id IN ('. implode(', ', $group_id) .')';
 					$result = $_CLASS['core_db']->query($sql);
 
@@ -60,30 +74,47 @@
 				break;
 
 				case 'apply':
+// users can be added 2x here, check to see if they are in the group first
+					$sql = 'SELECT group_id, FROM ' . USER_GROUP_TABLE . '
+						WHERE  group_id IN ('. implode(', ', $group_id) .')';
+					$result = $_CLASS['core_db']->query($sql);
+
+					$unset = array();
+
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						$unset[] = $row['group_id'];
+					}
+					$_CLASS['core_db']->free_result($result);
+
 					$sql = 'SELECT group_id, group_status, group_type FROM  ' . GROUPS_TABLE . '
-								WHERE group_type IN (' . GROUP_REQUEST .', ' . GROUP_UNRESTRAINED .')
-								AND group_id IN ('. implode(', ', $group_id) .')';
+								WHERE group_id IN ('. implode(', ', $group_id) .')';
 					$result = $_CLASS['core_db']->query($sql);
 
-					$group_id = array()
+					$group_id = array();
 
 					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 					{
-						if ($row['user_id'] == STATUS_ACTIVE)
+						$status = ($row['group_type'] == GROUP_UNRESTRAINED) ? STATUS_ACTIVE : STATUS_PENDING;
+
+						if ($row['group_status'] == STATUS_ACTIVE)
 						{
-							$group_id[] = $row['user_id'];
+							$group_id[$status][] = $row['group_id'];
 						}
 					}
 					$_CLASS['core_db']->free_result($result);
 
-					groups_user_remove($group_ids, $_CLASS['core_user']->data['user_id']);
+					foreach ($group_id as $status => $ids)
+					{
+						groups_user_add($ids, $_CLASS['core_user']->data['user_id'], $status);
+					}
 				break;		
 			}
 		}
 
 		$error = $data = array();
 
-		$sql = 'SELECT g.group_id, g.group_name, g.group_description, g.group_type, ug.user_status
+		$sql = 'SELECT g.group_id, g.group_name, g.group_description, g.group_type, ug.member_status
 			FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . ' ug
 			WHERE ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 				AND g.group_id = ug.group_id
@@ -95,13 +126,13 @@
 		{
 			$row['group_status'] = STATUS_ACTIVE;
 
-			$block = ($row['user_status'] == STATUS_LEADER) ? 'leader' : (($row['user_status'] == STATUS_PENDING) ? 'pending' : 'member');
+			$block = ($row['member_status'] == STATUS_LEADER) ? 'leader' : (($row['member_status'] == STATUS_PENDING) ? 'pending' : 'member');
 
 			$_CLASS['core_template']->assign_vars_array($block, array(
 				'GROUP_ID'			=> $row['group_id'],
 				'GROUP_NAME'		=> isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
 				'GROUP_DESC'		=> $row['group_description'],
-				'GROUP_RESIGN'		=> ($row['group_type'] != GROUP_SYSTEM || ($row['group_type'] == GROUP_SPECIAL && $row['user_status'] == STATUS_PENDING),
+				'GROUP_RESIGN'		=> ($row['group_type'] != GROUP_SYSTEM || ($row['group_type'] == GROUP_SPECIAL && $row['member_status'] == STATUS_PENDING)),
 				'U_VIEW_GROUP'		=> generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']),
 				'S_GROUP_DEFAULT'	=> ($row['group_id'] == $_CLASS['core_user']->data['group_id']) ? true : false
 			));
@@ -110,33 +141,30 @@
 		}
 		$_CLASS['core_db']->free_result($result);
 
-		// Hide hidden groups unless user is an admin with group privileges
-		$sql_and = ($_CLASS['auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? '<> ' . GROUP_SYSTEM : 'NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
+		$sql_and = 'NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
 
 		$sql = 'SELECT group_id, group_name, group_description, group_type
 			FROM ' . GROUPS_TABLE . '
-			WHERE group_id NOT IN (' . implode(', ', $group_id_ary) . ")
-				AND group_type $sql_and
+			WHERE group_id NOT IN (' . implode(', ', $group_id_ary) . ')
+				AND group_status = '. STATUS_ACTIVE ."
 			ORDER BY group_type DESC, group_name";
 		$result = $_CLASS['core_db']->query($sql);
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$row['group_status'] = STATUS_ACTIVE;
-
 			$_CLASS['core_template']->assign_vars_array('nonmember', array(
 				'GROUP_ID'		=> $row['group_id'],
 				'GROUP_NAME'	=> isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
 				'GROUP_DESC'	=> $row['group_description'],
-				'GROUP_APPLY'	=> ($row['group_type'] != GROUP_SYSTEM && $row['group_status'] == STATUS_ACTIVE),
+				'GROUP_APPLY'	=> true,
 				'U_VIEW_GROUP'	=> generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id'])
 			));
 		}
 		$_CLASS['core_db']->free_result($result);
 
 		$_CLASS['core_template']->assign(array(
-		'S_DISPLAY_FORM', true,
-		'S_UCP_ACTION' => ''
+			'S_DISPLAY_FORM', true,
+			'S_UCP_ACTION' => ''
 		));
 
 		$this->display($_CLASS['core_user']->get_lang('UCP_GROUPS'), 'ucp_groups_membership.html');

Modified: trunk/modules/Control_Panel/ucp/ucp_prefs.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -153,9 +153,9 @@
 
 					'DATE_FORMAT'		=> $dateformat, 
 
-					'S_LANG_OPTIONS'	=> language_select($lang), 
-					'S_THEME_OPTIONS'	=> theme_select($theme),
-					'S_TZ_OPTIONS'		=> tz_select($tz),
+					'S_LANG_OPTIONS'	=> select_language($lang), 
+					'S_THEME_OPTIONS'	=> select_theme($theme),
+					'S_TZ_OPTIONS'		=> select_tz($tz),
 					'S_CAN_HIDE_ONLINE'	=> true, 
 					'S_SELECT_NOTIFY'	=> ($config['jab_enable'] && $_CLASS['core_user']->data['user_jabber'] && @extension_loaded('xml')) ? true : false)
 				);

Modified: trunk/modules/Control_Panel/ucp/ucp_register.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -27,16 +27,18 @@
 	{
 		global $site_file_root, $config, $_CLASS, $_CORE_CONFIG;
 		
-		if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_DISABLE)
+		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
+		$submit		= isset($_POST['submit']);
+
+		if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_DISABLE
+			|| ($coppa || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
+			&& !$_CORE_CONFIG['email']['email_enable'])
 		{
 			trigger_error('UCP_REGISTER_DISABLE');
 		}
 
 		$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link('Control_Panel&amp;mode=register'));
 
-		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
-		$submit		= isset($_POST['submit']);
-
 		$error = $data = array();
 		$s_hidden_fields = '';
 
@@ -85,8 +87,10 @@
 
 			$username	= get_variable('username', 'POST', false);
 			$password	= get_variable('password', 'POST', false);
-			$email		= get_variable('email', 'POST', false);
-			
+
+			$email			= get_variable('email', 'POST', false);
+			$email_confirm	= get_variable('email_confirm', 'POST', '');
+
 			//when we add this make sure to confirm that it's one of the installed langs
 			$lang		= $_CORE_CONFIG['global']['default_lang'];
 			$tz			= get_variable('tz', 'POST', false);
@@ -100,19 +104,28 @@
 
 			if ($username_validate !== true)
 			{
-				$error[] = $username_validate;
+				$error[] = $_CLASS['core_user']->get_lang($username_validate);
 			}
 
 			if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
 			{
-				$error[] = 'PASSWORD_ERROR';
+				$error[] = $_CLASS['core_user']->get_lang('PASSWORD_ERROR');
 			}
 
-			if (!$email || $email !== get_variable('email_confirm', 'POST', ''))
+			if (!$email || $email !== $email_confirm)
 			{
-				$error[] = 'PASSWORD_ERROR';
+				$error[] = $_CLASS['core_user']->get_lang('EMAIL_ERROR');
 			}
+			elseif (!check_email($email))
+			{
+				$error[] = $_CLASS['core_user']->get_lang('EMAIL_INVALID');
+			}
 
+			if (!$tz || !in_array($tz, tz_array()))
+			{
+				$tz = null;
+			}
+
 			if ($_CORE_CONFIG['user']['enable_confirm'])
 			{
 				$confirmation_code = $_CLASS['core_user']->session_data_get('confirmation_code');
@@ -120,22 +133,15 @@
 
 				if (!$confirm_code || !$confirmation_code || $confirm_code != $confirmation_code)
 				{
-					$error[] = $_CLASS['core_user']->lang['CONFIRM_CODE_WRONG'];
+					$error[] = $_CLASS['core_user']->get_lang('CONFIRM_CODE_WRONG');
 				}
 
 				// we don't need this any more
 				$_CLASS['core_user']->user_data_kill('confirmation_code');
 			}
 
-		//$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
 			if (empty($error))
 			{
-				// Tz need to be moved out of the lang file, only use it for languages
-				if (!$tz || !in_array($tz, $_CLASS['core_user']->lang['tz']['zones']))
-				{
-					$tz = null;
-				}
-	
 				$password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
 	
 				if (!$password)
@@ -151,14 +157,33 @@
 						//do some admin contact thing here
 						die('Try again later');
 					}
-	
+
 					$user_status = STATUS_PENDING;
 					$user_act_key = generate_string(10);
+
+					if ($coppa)
+					{
+						$message = $_CLASS['core_user']->lang['ACCOUNT_COPPA'];
+						$email_template = 'coppa_welcome_inactive';
+					}
+					elseif ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF)
+					{
+						$message = $_CLASS['core_user']->lang['ACCOUNT_INACTIVE'];
+						$email_template = 'user_welcome_inactive';
+					}
+					elseif ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
+					{
+						$message = $_CLASS['core_user']->lang['ACCOUNT_INACTIVE_ADMIN'];
+						$email_template = 'admin_welcome_inactive';
+					}
 				}
 				else
 				{
 					$user_status = STATUS_ACTIVE;
 					$user_act_key = null;
+
+					$email_template = 'user_welcome';
+					$message = $_CLASS['core_user']->lang['ACCOUNT_ADDED'];
 				}
 	
 				if ($user_status === STATUS_ACTIVE)
@@ -167,7 +192,7 @@
 					set_core_config('user', 'newest_username', $row['username'], false);
 					set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + 1, false);
 				}
-	
+
 				$data = array(
 					'username'		=> $username,
 					'user_email'	=> $email,
@@ -179,7 +204,7 @@
 					'user_password'			=> $password,
 					'user_password_encoding'=> $_CORE_CONFIG['user']['password_encoding'],
 
-					'user_lang'			=> ($lang == $_CORE_CONFIG['global']['default_lang']) ? null :$lang ,
+					'user_lang'			=> ($lang == $_CORE_CONFIG['global']['default_lang']) ? null : $lang,
 					'user_type'			=> USER_NORMAL,
 					'user_status'		=> $user_status,
 					'user_act_key'		=> $user_act_key,
@@ -187,38 +212,72 @@
 				);
 
 				user_add($data);
+				unset($data);
+
+				require_once($site_file_root.'includes/mailer.php');
+		
+				$mailer = new core_mailer();
+
+				$mailer->to($email, $username);
+				$mailer->subject($subject);
+
+				// change this don't want to use phpBBs template
+				$_CLASS['core_template']->assign_array(array(
+					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
+					'WELCOME_MSG'   => sprintf($_CLASS['core_user']->lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
+					'USERNAME'		=> $username,
+					'PASSWORD'		=> $password,
+					'EMAIL_SIG'		=> '', //I like this
+					'U_ACTIVATE'	=> generate_link("system&amp;mode=activate&user_id=$user_id&key=$user_act_key", array('sid' => false, 'full' => true))
+				));
+
+				if ($coppa)
+				{
+					$_CLASS['core_template']->assign_array(array(
+						'FAX_INFO'		=> $_CORE_CONFIG['user']['coppa_fax'],
+						'MAIL_INFO'		=> $_CORE_CONFIG['user']['coppa_mail'],
+						'EMAIL_ADDRESS' => $email,
+						'SITENAME'		=> $_CORE_CONFIG['global']['site_name'])
+					);
+				}
+
+				$mailer->message = trim($_CLASS['core_template']->display('modules/Control_Panel/email/'.$email_template, true));
+
+				$mailer->send();
+
+				$message = $message . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_INDEX'],  '<a href="'. generate_link() .'">', '</a>');
+				trigger_error($message);
 			}
 		}
 
 		$s_hidden_fields .= '<input type="hidden" name="coppa" value="' . $coppa . '" />';
 		$s_hidden_fields .= '<input type="hidden" name="agreed" value="true" />';
-		$confirm_image = '';
 		
-		// Visual Confirmation - Show images
 		if ($_CORE_CONFIG['user']['enable_confirm'])
 		{
-			if ($submit)
+			$_CLASS['core_user']->session_data_set('confirmation_code', generate_string(6));
+			$confirm_image = '<img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" />';
+		}
+		else
+		{
+			$confirm_image = false;
+		}
+
+		if ($submit)
+		{
+			if ($_CORE_CONFIG['user']['max_reg_attempts'])
 			{
-				if ($_CORE_CONFIG['user']['max_reg_attempts'])
+				$attempts = (int) $_CLASS['core_user']->session_data_get('reg_attempts', 0);
+
+				if ($attempts > $_CORE_CONFIG['user']['max_reg_attempts'])
 				{
-					$attempts = (int) $_CLASS['core_user']->session_data_get('reg_attempts');
-
-					if ($attempts >= $_CORE_CONFIG['user']['max_reg_attempts'])
-					{
-						trigger_error($_CLASS['core_user']->lang['TOO_MANY_REGISTERS']);
-					}
-
-					$_CLASS['core_user']->session_data_get('reg_attempts', ($attempts + 1));
+					trigger_error($_CLASS['core_user']->lang['TOO_MANY_REGISTERS']);
 				}
 
-				$_CLASS['core_user']->session_data_set('confirmation_code', generate_string(6));
+				$_CLASS['core_user']->session_data_get('reg_attempts', ($attempts + 1));
 			}
-
-			$confirm_image = '<img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" />';
 		}
 
-		$l_reg_cond = '';
-
 		switch ($_CORE_CONFIG['user']['require_activation'])
 		{
 			case USER_ACTIVATION_SELF:
@@ -228,25 +287,29 @@
 			case USER_ACTIVATION_ADMIN:
 				$l_reg_cond = $_CLASS['core_user']->lang['UCP_ADMIN_ACTIVATE'];
 			break;
+			
+			default:
+				$l_reg_cond = '';
+			break;
 		}
 
 		$user_char_ary = array('.*' => 'USERNAME_CHARS_ANY', '[\w]+' => 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' => 'USERNAME_ALPHA_SPACERS');
 
-		$_CLASS['core_template']->assign(array(
-			'ERROR'						=> empty($error) ? false : implode('<br />', $error), 
-			'USERNAME'					=> isset($username) ? $username : '',
-			'PASSWORD'					=> isset($password) ? $password : '',
-			'EMAIL'						=> isset($email) ? $email : '',
-			'EMAIL_CONFIRM'				=> isset($email_confirm) ? $email_confirm : '', // should remove this also maybe
-			'CONFIRM_IMG'				=> $confirm_image,
+		$_CLASS['core_template']->assign_array(array(
+			'ERROR'			=> empty($error) ? false : implode('<br />', $error), 
+			'USERNAME'		=> isset($username) ? $username : '',
+			'PASSWORD'		=> isset($password) ? $password : '',
+			'EMAIL'			=> isset($email) ? $email : '',
+			'EMAIL_CONFIRM'	=> isset($email_confirm) ? $email_confirm : '',
+			'CONFIRM_IMG'	=> $confirm_image,
+			'SELECT_TZ'		=> select_tz(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
 
 			'L_CONFIRM_EXPLAIN'			=> sprintf($_CLASS['core_user']->lang['CONFIRM_EXPLAIN'], '<a href="mailto:' . htmlentities($config['board_contact']) . '">', '</a>'), 
 			'L_ITEMS_REQUIRED'			=> $l_reg_cond, 
 			'L_USERNAME_EXPLAIN'		=> sprintf($_CLASS['core_user']->lang[$user_char_ary[$_CORE_CONFIG['user']['allow_name_chars']] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
 			'L_NEW_PASSWORD_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['NEW_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
 
-			//'S_LANG_OPTIONS'	=> language_select($lang), 
-			'S_TZ_OPTIONS'		=> tz_select(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
+
 			'S_COPPA'			=> $coppa, 
 			'S_HIDDEN_FIELDS'	=> $s_hidden_fields,
 			'S_UCP_ACTION'		=> generate_link("Control_Panel&amp;mode=register"))



From viperal at berlios.de  Wed Aug 24 21:26:10 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 24 Aug 2005 21:26:10 +0200
Subject: [Viperals-svncheckins] r90 - in trunk: . admin blocks includes includes/templates/admin includes/templates/admin/users
Message-ID: <200508241926.j7OJQASj029728@sheep.berlios.de>

Author: viperal
Date: 2005-08-24 21:26:07 +0200 (Wed, 24 Aug 2005)
New Revision: 90

Added:
   trunk/includes/templates/admin/users/add.html
   trunk/includes/templates/admin/users/disabled.html
Modified:
   trunk/admin.php
   trunk/admin/index.php
   trunk/admin/users.php
   trunk/blocks/block-Quick_Message.php
   trunk/includes/functions_user.php
   trunk/includes/templates/admin/index.html
   trunk/includes/templates/admin/users/bots.html
   trunk/includes/templates/admin/users/header.html
   trunk/includes/templates/admin/users/index.html
Log:


Modified: trunk/admin/index.php
===================================================================
--- trunk/admin/index.php	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/admin/index.php	2005-08-24 19:26:07 UTC (rev 90)
@@ -80,16 +80,41 @@
 if ($_CLASS['core_auth']->admin_power('users'))
 {
 	$user_status = array(STATUS_PENDING, STATUS_DISABLED);
-	$count = 0;
+	$last_count = 0;
 
 	foreach ($user_status as $status)
 	{
+		$limit = ($last_count) ? 10 : 20 - $last_count;
+
+		$sql = 'SELECT COUNT(*)	FROM ' . USERS_TABLE . '
+					WHERE user_type = '.USER_NORMAL.'
+					AND user_status = '.$status;
+		$result = $_CLASS['core_db']->query($sql);
+		list($count) = $_CLASS['core_db']->fetch_row_num($result);
+
+		$last_count = $last_count + min($count, $limit);
+
+		if ($status === STATUS_PENDING)
+		{
+			$more = 'MORE_PENDING';
+			$link = generate_link('users&amp;mode=unactivated', array('admin' => true));
+		}
+		else
+		{
+			$more = 'MORE_DISABLED';
+			$link = generate_link('users&amp;mode=disabled', array('admin' => true));
+		}
+	
+		$_CLASS['core_template']->assign_array(array(
+			$more			=> ($count > $limit),
+			'LINK_'.$more	=> $link,
+		));
+		
 		$sql = 'SELECT user_id, username, user_regdate
 			FROM ' . USERS_TABLE . '
 				WHERE user_type = '.USER_NORMAL.'
 				AND user_status = '.$status;
 		
-		$limit = ($count) ? 10 : 20 - $count;
 		$result = $_CLASS['core_db']->query_limit($sql, $limit);
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -106,8 +131,6 @@
 					'link_remind'	=> generate_link('&amp;user_mode=remind&amp;id=' . $row['user_id'], array('admin' => true)),
 					'link_details'	=> '',
 			));
-			
-			$count ++;
 		}
 		$_CLASS['core_db']->free_result($result);
 	}

Modified: trunk/admin/users.php
===================================================================
--- trunk/admin/users.php	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/admin/users.php	2005-08-24 19:26:07 UTC (rev 90)
@@ -48,13 +48,110 @@
 	'LINK_VIEW_UNACTIVATED'	=> generate_link('users&amp;mode=unactivated', array('admin' => true)),
 ));
 
+$id = (int) get_variable('id', 'GET', false);
+
 if (isset($_REQUEST['mode']))
 {
 	switch ($_REQUEST['mode'])
 	{
+		case 'add_user':
+			if (isset($_POST['submit']))
+			{
+				require_once($site_file_root.'includes/functions_user.php');
+	
+				$error = array();
+	
+				$username	= get_variable('username', 'POST', false);
+				$password	= get_variable('password', 'POST', false);
+				$email		= get_variable('email', 'POST', false);
+				$tz			= get_variable('tz', 'POST', false);
+				$error		= array();
+
+				//when we add this make sure to confirm that it's one of the installed langs
+				$lang		= $_CORE_CONFIG['global']['default_lang'];
+	
+				if (strpos($username, "\n"))
+				{
+					die;
+				}
+
+				$username_validate = validate_username($username);
+	
+				if ($username_validate !== true)
+				{
+					$error[] = $_CLASS['core_user']->get_lang($username_validate);
+				}
+	
+				if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
+				{
+					$error[] = $_CLASS['core_user']->get_lang('PASSWORD_ERROR');
+				}
+	
+				if (!$email)
+				{
+					$error[] = $_CLASS['core_user']->get_lang('EMAIL_ERROR');
+				}
+				elseif (!check_email($email)) // we can maybe remove this check
+				{
+					$error[] = $_CLASS['core_user']->get_lang('EMAIL_INVALID');
+				}
+	
+				if (!$tz || !in_array($tz, tz_array()))
+				{
+					$tz = null;
+				}
+
+				if (empty($error))
+				{
+					$password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
+		
+					if (!$password)
+					{
+						//do some admin contact thing here
+						die('Try again later');
+					}
+
+					$data = array(
+						'username'		=> (string) $username,
+						'user_email'	=> (string) $email,
+						'user_group'	=> (int) ($coppa) ? 3 : 2,
+						'user_reg_date'	=> (int) gmtime(),
+						'user_timezone'	=> $tz,
+	
+						'user_password'			=> (string) $password,
+						'user_password_encoding'=> (string) $_CORE_CONFIG['user']['password_encoding'],
+	
+						'user_lang'			=> ($lang == $_CORE_CONFIG['global']['default_lang']) ? null : $lang,
+						'user_type'			=> USER_NORMAL,
+						'user_status'		=> STATUS_ACTIVE,
+						'user_act_key'		=> null,
+						'user_ip'			=> '',
+					);
+	
+					user_add($data);
+					
+					set_core_config('user', 'newest_user_id', $row['user_id'], false);
+					set_core_config('user', 'newest_username', $row['username'], false);
+					set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + 1, false);
+				}
+			}
+
+			$_CLASS['core_template']->assign_array(array(
+				'COPPA'			=> isset($coppa) ? $coppa : false, 
+				'EMAIL'			=> isset($email) ? $email : '',
+				'ERROR'			=> empty($error) ? false : implode('<br />', $error),
+
+				'PASSWORD'		=> isset($password) ? $password : '',
+				'USERNAME'		=> isset($username) ? $username : '',
+
+				'SELECT_TZ'		=> select_tz(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
+				'S_ACTION'		=> generate_link('users&amp;mode=add_user', array('admin' => true))
+			));
+	
+			$_CLASS['core_display']->display(false, 'admin/users/add.html');
+		break;
+
 		case 'bots':
-			$id = (int) get_variable('id', 'GET', false);
-			
 			if ($id && isset($_REQUEST['option']))
 			{
 				require_once($site_file_root.'includes/functions_user.php');
@@ -119,6 +216,40 @@
 
 		case 'disabled':
 		case 'unactivated':
+			if ($id && isset($_REQUEST['option']))
+			{
+				require_once($site_file_root.'includes/functions_user.php');
+
+				switch ($_REQUEST['option'])
+				{
+					case 'activate':
+						user_activate($id);
+					break;
+			
+					case 'delete':
+						if (display_confirmation())
+						{
+							$sql = 'SELECT user_id, user_type
+								FROM ' . USERS_TABLE . ' 
+								WHERE user_id = '.$id;
+				
+							$result = $_CLASS['core_db']->query($sql);
+							$row = $_CLASS['core_db']>fetch_row_assoc($result);
+							$_CLASS['core_db']->free_result($result);
+				
+							if ($row['user_type'] != USER_BOT)
+							{
+								break;
+							}
+				
+							user_delete($id);
+				
+							trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
+						}
+					break;
+				}
+			}
+
 			if ($_REQUEST['mode'] == 'unactivated')
 			{
 				$status = STATUS_PENDING;
@@ -131,7 +262,7 @@
 				$template = 'admin/users/disabled.html';
 				$link = 'users&amp;mode=disabled';
 			}
-$status = STATUS_DISABLED;
+
 			$start = get_variable('start', 'GET', false, 'integer');
 
 			$sql = 'SELECT user_id, username, user_regdate
@@ -148,9 +279,9 @@
 						'user_name'		=> $row['username'],
 						'registered'	=> $_CLASS['core_user']->format_time($row['user_regdate']),
 						'link_profile'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
-						'link_activate'	=> generate_link('&amp;user_mode=activate&amp;id=' . $row['user_id'], array('admin' => true)),
-						'link_remove'	=> generate_link('&amp;user_mode=remove&amp;id=' . $row['user_id'], array('admin' => true)),
-						'link_remind'	=> generate_link('&amp;user_mode=remind&amp;id=' . $row['user_id'], array('admin' => true)),
+						'link_activate'	=> generate_link($link.'&amp;option=activate&amp;id=' . $row['user_id'], array('admin' => true)),
+						'link_remove'	=> generate_link($link.'&amp;option=delete&amp;id=' . $row['user_id'], array('admin' => true)),
+						'link_remind'	=> generate_link($link.'&amp;option=remind&amp;id=' . $row['user_id'], array('admin' => true)),
 						'link_details'	=> '',
 				));
 			}
@@ -173,17 +304,42 @@
 }
 
 $user_status = array(STATUS_PENDING, STATUS_DISABLED);
-$count = 0;
+$last_count = 0;
 
 // needed view more
 foreach ($user_status as $status)
 {
+	$limit = ($last_count) ? 10 : 20 - $last_count;
+
+	$sql = 'SELECT COUNT(*)	FROM ' . USERS_TABLE . '
+				WHERE user_type = '.USER_NORMAL.'
+				AND user_status = '.$status;
+	$result = $_CLASS['core_db']->query($sql);
+	list($count) = $_CLASS['core_db']->fetch_row_num($result);
+
+	$last_count = $last_count + min($count, $limit);
+
+	if ($status === STATUS_PENDING)
+	{
+		$more = 'MORE_PENDING';
+		$link = generate_link('users&amp;mode=unactivated', array('admin' => true));
+	}
+	else
+	{
+		$more = 'MORE_DISABLED';
+		$link = generate_link('users&amp;mode=disabled', array('admin' => true));
+	}
+
+	$_CLASS['core_template']->assign_array(array(
+		$more			=> ($count > $limit),
+		'LINK_'.$more	=> $link,
+	));
+
 	$sql = 'SELECT user_id, username, user_regdate
 		FROM ' . USERS_TABLE . '
 			WHERE user_type = '.USER_NORMAL.'
 			AND user_status = '.$status;
 
-	$limit = ($count) ? 10 : 20 - $count;
 	$result = $_CLASS['core_db']->query_limit($sql, $limit);
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -200,8 +356,6 @@
 				'link_remind'	=> generate_link('&amp;user_mode=remind&amp;id=' . $row['user_id'], array('admin' => true)),
 				'link_details'	=> '',
 		));
-		
-		$count ++;
 	}
 	$_CLASS['core_db']->free_result($result);
 }

Modified: trunk/admin.php
===================================================================
--- trunk/admin.php	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/admin.php	2005-08-24 19:26:07 UTC (rev 90)
@@ -20,7 +20,9 @@
 
 require($site_file_root.'core.php');
 
-$_CLASS['core_user']->user_setup();
+$_CLASS['core_user']->user_setup(null);
+$_CLASS['core_display']->load_theme('viperal_admin', $site_file_root.'themes_admin/viperal_admin');
+
 $_CLASS['core_user']->add_lang('admin/common.php');
 
 $_CORE_MODULE['title'] = $_CLASS['core_user']->lang['ADMIN'];
@@ -90,12 +92,19 @@
 $_CORE_MODULE['title'] = $_CLASS['core_user']->lang['ADMIN'].' &gt; '.$_CORE_MODULE['title'];
 $_CORE_MODULE['sides'] = BLOCK_ALL;
 	
-$_CLASS['core_blocks']->add_block(array(
-		'block_title'		=> 'Administration',
-		'block_position'	=> BLOCK_LEFT,
-		'block_file'		=> 'block-Admin.php',
-	));
+require($site_file_root.'admin/menu.php');
 
+$main_menu = build_menu($menu);
+
+$_CLASS['core_template']->assign_array(array(
+		'LINK_HOME'		=> generate_link(),
+		'LINK_ADMIN'	=> generate_link(false, array('admin' => true)),
+
+		'MENU_MAIN'			=> $main_menu['content'],
+		'MENU_MAIN_ITEMS'	=> $main_menu['menu'],
+));
+
+
 //load_class($site_file_root.'includes/core_editor.php', 'core_editor');
 //$_CLASS['core_editor']->setup();
 require($file_path);

Modified: trunk/blocks/block-Quick_Message.php
===================================================================
--- trunk/blocks/block-Quick_Message.php	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/blocks/block-Quick_Message.php	2005-08-24 19:26:07 UTC (rev 90)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 if (!defined('VIPERAL'))
@@ -54,7 +56,7 @@
 		}
     }
 
-	htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8');
+	$row['message_text'] = htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8');
 
 	unset($words_array, $words);
 	

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/includes/functions_user.php	2005-08-24 19:26:07 UTC (rev 90)
@@ -29,7 +29,9 @@
 	$user_id = array_unique($user_id);
 
 	// array map should make 0 values for notint values
-	if (($key = array_search(0, $user_id)) === false)
+	$key = array_search(0, $user_id);
+
+	if ($key !== false && !is_null($key))
 	{
 		unset($user_id[$key]);
 	}

Modified: trunk/includes/templates/admin/index.html
===================================================================
--- trunk/includes/templates/admin/index.html	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/includes/templates/admin/index.html	2005-08-24 19:26:07 UTC (rev 90)
@@ -176,7 +176,14 @@
 			</td>
 		</tr>
 		<!-- ENDLOOP -->
+		<!-- IF { $MORE_PENDING } -->
 		<tr>
+			<td colspan="6" align="center" class="row1">
+				<a href="{ $LINK_MORE_PENDING }"><b>{ $L_VIEW_MORE_PENDING }</b></a>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
 			<td colspan="6" class="row2">{ $L_DISABLED_USERS }</td>
 		</tr>
 		<!-- LOOP $users_disabled -->
@@ -210,7 +217,14 @@
 			</td>
 		</tr>
 		<!-- ENDLOOP -->
+		<!-- IF { $MORE_DISABLED } -->
 		<tr>
+			<td colspan="6" align="center" class="row1">
+				<a href="{ $LINK_MORE_DISABLED }"><b>{ $L_VIEW_MORE_DISABLED }</b></a>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
 			<td colspan="6" class="cat" align="right"><select name="mark_option"><option value="activate">{ $L_ACTIVATE }</option><option value="remove">{ $L_REMOVE }</option></select>&nbsp;<input class="bottom" name="submit" value="{ $L_SUBMIT }" type="submit">&nbsp;</td>
 		</tr>
     </tbody>

Added: trunk/includes/templates/admin/users/add.html
===================================================================
--- trunk/includes/templates/admin/users/add.html	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/includes/templates/admin/users/add.html	2005-08-24 19:26:07 UTC (rev 90)
@@ -0,0 +1,45 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<!-- INCLUDE admin/users/header.html -->
+<form method="post" action="{ $S_ACTION }">
+	<table class="tablebg" cellspacing="1" cellpadding="4" width="100%">
+		<!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row1" width="38%"><b class="genmed">{ $L_USERNAME }: </b></td>
+			<td class="row2"><input class="post" type="text"  name="username" size="25" maxlength="40" value="{ $USERNAME }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1"><b class="genmed">{ $L_PASSWORD }: </b></td>
+			<td class="row2"><input class="post" type="password" name="password" size="25" maxlength="100" value="{ $PASSWORD }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1"><b class="genmed">{ $L_CONFIRM_PASSWORD }: </b></td>
+			<td class="row2"><input class="post" type="password" name="password_confirm" size="25" maxlength="100" value="" /></td>
+		</tr>
+		<tr> 
+			<td class="row1"><b class="genmed">{ $L_EMAIL_ADDRESS }: </b></td>
+			<td class="row2"><input class="post" type="text" name="email" size="25" maxlength="255" value="{ $EMAIL }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1"><b class="genmed">{ $L_COPPA }: </b></td>
+			<td class="row2"><input name="coppa" value="1" <!-- IF { $COPPA } -->checked="checked"<!-- ENDIF --> type="radio"><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input name="coppa" value="0" <!-- IF !{ $COPPA } -->checked="checked"<!-- ENDIF --> type="radio"><span class="genmed">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1"><b class="genmed">{ $L_TIMEZONE }: </b></td>
+			<td class="row2"><select name="tz">{ $SELECT_TZ }</select></td>
+		</tr>
+		<tr>
+			<td class="cat" colspan="2" align="center" height="28"><input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		</tr>
+	</table>
+</form>
+
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: trunk/includes/templates/admin/users/bots.html
===================================================================
--- trunk/includes/templates/admin/users/bots.html	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/includes/templates/admin/users/bots.html	2005-08-24 19:26:07 UTC (rev 90)
@@ -4,7 +4,7 @@
 
 <!-- INCLUDE admin/users/header.html -->
 
-<table class="tablebg" cellspacing="1" cellpadding="4" border="0">
+<table class="tablebg" cellspacing="1" cellpadding="4" width="100%">
 	<tr>
 		<th nowrap="nowrap">Bot name</th>
 		<th nowrap="nowrap">Last visit</th>
@@ -13,12 +13,17 @@
 	</tr>
 	<!-- LOOP $admin_bots -->
 	<tr>
-		<td class="row1" width="25%">{ $admin_bots:NAME }</td>
-		<td class="row1" width="15%" align="center" nowrap="nowrap">{ $admin_bots:LAST_VISIT }</td>
-		<td class="row1" width="1%"align="center">&nbsp;<a href="{ $admin_bots:LINK_STATUS }">{ $admin_bots:L_STATUS }</a>&nbsp;</td>
-		<td class="row1" width="1%" align="center">&nbsp;<a href="{ $admin_bots:LINK_EDIT }">{ $L_EDIT }</a>&nbsp;</td>
-
-		<td class="row1" width="1%" align="center">&nbsp;<a href="{ $admin_bots:LINK_DELETE }">{ $L_DELETE }</a>&nbsp;</td>
+		<td class="row1" width="">{ $admin_bots:NAME }</td>
+		<td class="row1" width="200" align="center" nowrap="nowrap">{ $admin_bots:LAST_VISIT }</td>
+		<td width="80" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $admin_bots:LINK_STATUS }'; return false;">
+			<a href="{ $admin_bots:LINK_STATUS }">{ $admin_bots:L_STATUS }</a>
+		</td>
+		<td width="80" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $admin_bots:LINK_EDIT }'; return false;">
+			<a href="{ $admin_bots:LINK_EDIT }">{ $L_EDIT }</a>
+		</td>
+		<td width="80" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $admin_bots:LINK_DELETE }'; return false;">
+			<a href="{ $admin_bots:LINK_DELETE }">{ $L_DELETE }</a> 
+		</td>
 	</tr>
 	<!-- ENDLOOP $admin_bots -->
 </table>

Added: trunk/includes/templates/admin/users/disabled.html
===================================================================
--- trunk/includes/templates/admin/users/disabled.html	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/includes/templates/admin/users/disabled.html	2005-08-24 19:26:07 UTC (rev 90)
@@ -0,0 +1,69 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<!-- INCLUDE admin/users/header.html -->
+
+<table class="tablebg" border="0" cellspacing="1" width="100%">
+    <tbody>
+		<tr>
+			<th colspan="6" align="center">{ $L_INACTIVE_USERS }</th>
+		</tr>
+		<tr>
+			<td colspan="6" class="row2"></td>
+		</tr>
+		<tr>
+			<th width="20px"></th>
+			<th>{ $L_USERNAME }</th>
+			<th>{ $L_REGISTED }</th>
+			<th colspan="3" >{ $L_OPTIONS }</th>
+		</tr>
+		<tr>
+			<td colspan="6" class="row2">{ $L_UNACTIVATED_USERS }</td>
+		</tr>
+		<!-- LOOP $users_admin -->
+		<tr>
+			<td height="25" class="row1">
+				<input name="mark_id[]" value="{ $users_admin:user_id }" type="checkbox">
+			</td>
+			<td height="25" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_admin:link_profile }'; return false;">
+				<a href="{ $users_admin:link_profile }">{ $users_admin:user_name }</a>
+			</td>
+			<td width="150" class="row1" align="center">
+				{ $users_admin:registered }
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_admin:link_activate }'; return false;">
+				<a href="{ $users_admin:link_activate }">{ $L_ACTIVATE }</a>
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_admin:link_remove }'; return false;">
+				<a href="{ $users_admin:link_remove }">{ $L_REMOVE }</a>
+			</td>
+			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_admin:link_remind }'; return false;">
+				<a href="{ $users_admin:link_remind }">{ $L_REMIND }</a> 
+			</td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="6" height="7"></td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr>
+			<td colspan="6" align="center" class="row1">
+				{ $L_NO_UNACTIVATED_USERS }
+			</td>
+		</tr>
+		<!-- ENDLOOP -->
+		<tr>
+			<td colspan="6" class="cat" align="right"><select name="mark_option"><option value="activate">{ $L_ACTIVATE }</option><option value="remove">{ $L_REMOVE }</option><option value="remind">{ $L_REMIND }</option></select>&nbsp;<input class="bottom" name="submit" value="{ $L_SUBMIT }" type="submit">&nbsp;</td>
+		</tr>
+		<!-- IF { $USERS_PAGINATION } -->
+		<tr class="row2">
+			<td style="padding: 5px;" valign="middle" colspan="6">
+				<div>{ $USERS_PAGINATION }</div>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+    </tbody>
+</table>
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: trunk/includes/templates/admin/users/header.html
===================================================================
--- trunk/includes/templates/admin/users/header.html	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/includes/templates/admin/users/header.html	2005-08-24 19:26:07 UTC (rev 90)
@@ -37,7 +37,8 @@
 						</tr>
 						<tr class="row1">
 							<td colspan="4">
-								<img src="images/add_user.png" alt="{ $L_ADD_USER }" title="{ $L_ADD_USER }" border="0">
+<!-- NEED A IMAGE BUTTOM CLASS -->
+								<a href="{ $LINK_ADD_USER }" title="{ $L_VIEW_BOTS }"><img src="images/add_user.png" alt="{ $L_ADD_USER }" title="{ $L_ADD_USER }" /></a>
 							</td>
 						</tr>
 					</tbody>
@@ -55,7 +56,7 @@
 							</td>
 						</tr>
 						<tr>
-							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_BOTS }'; return false;">
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_VIEW_BOTS }'; return false;">
 								<a href="{ $LINK_VIEW_BOTS }" title="{ $L_VIEW_BOTS }">{ $L_VIEW_BOTS }</a>
 							</td>
 						</tr>
@@ -70,8 +71,11 @@
 							</td>
 						</tr>
 						<tr>
+							<td class="row2" nowrap="nowrap"></td>
+						</tr>
+						<tr>
 							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_ADD_USER }'; return false;">
-								<a href="{ $LINK_ADD_USER }" title="{ $L_VIEW_BOTS }">{ $L_VIEW_BOTS }</a>
+								<a href="{ $LINK_ADD_USER }" title="{ $L_VIEW_BOTS }">{ $L_ADD_USER }</a>
 							</td>
 						</tr>
 					</tbody>

Modified: trunk/includes/templates/admin/users/index.html
===================================================================
--- trunk/includes/templates/admin/users/index.html	2005-08-24 15:00:26 UTC (rev 89)
+++ trunk/includes/templates/admin/users/index.html	2005-08-24 19:26:07 UTC (rev 90)
@@ -39,7 +39,7 @@
 				<a href="{ $users_unactivated:link_remove }">{ $L_REMOVE }</a>
 			</td>
 			<td width="60" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $users_unactivated:link_remind }'; return false;">
-				<a href="{ $users_unactivated:link_remind }">{ $L_REMIND }</a> 
+				<a href="{ $users_unactivated:link_remind }">{ $L_REMIND }</a>
 			</td>
 		</tr>
 		<tr>
@@ -52,7 +52,14 @@
 			</td>
 		</tr>
 		<!-- ENDLOOP -->
+		<!-- IF { $MORE_PENDING } -->
 		<tr>
+			<td colspan="6" align="center" class="row1">
+				<a href="{ $LINK_MORE_PENDING }"><b>{ $L_VIEW_MORE_PENDING }</b></a>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
 			<td colspan="6" class="row2">{ $L_DISABLED_USERS }</td>
 		</tr>
 		<!-- LOOP $users_disabled -->
@@ -86,7 +93,14 @@
 			</td>
 		</tr>
 		<!-- ENDLOOP -->
+		<!-- IF { $MORE_DISABLED } -->
 		<tr>
+			<td colspan="6" align="center" class="row1">
+				<a href="{ $LINK_MORE_DISABLED }"><b>{ $L_VIEW_MORE_DISABLED }</b></a>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
 			<td colspan="6" class="cat" align="right"><select name="mark_option"><option value="activate">{ $L_ACTIVATE }</option><option value="remove">{ $L_REMOVE }</option></select>&nbsp;<input class="bottom" name="submit" value="{ $L_SUBMIT }" type="submit">&nbsp;</td>
 		</tr>
     </tbody>



From viperal at berlios.de  Sat Aug 27 21:29:41 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 27 Aug 2005 21:29:41 +0200
Subject: [Viperals-svncheckins] r92 - in trunk: . admin admin/functions includes includes/db includes/display install modules modules/Contact modules/Forums modules/Quick_Message themes_admin themes_admin/viperal_admin themes_admin/viperal_admin/images themes_admin/viperal_admin/images/modules themes_admin/viperal_admin/images/modules/Forums themes_admin/viperal_admin/template
Message-ID: <200508271929.j7RJTf0U004308@sheep.berlios.de>

Author: viperal
Date: 2005-08-27 21:29:36 +0200 (Sat, 27 Aug 2005)
New Revision: 92

Added:
   trunk/themes_admin/
   trunk/themes_admin/viperal_admin/
   trunk/themes_admin/viperal_admin/images/
   trunk/themes_admin/viperal_admin/images/Thumbs.db
   trunk/themes_admin/viperal_admin/images/index.html
   trunk/themes_admin/viperal_admin/images/modules/
   trunk/themes_admin/viperal_admin/images/modules/Forums/
   trunk/themes_admin/viperal_admin/images/modules/Forums/index.html
   trunk/themes_admin/viperal_admin/images/modules/Forums/index.php
   trunk/themes_admin/viperal_admin/images/modules/index.html
   trunk/themes_admin/viperal_admin/index.html
   trunk/themes_admin/viperal_admin/index.php
   trunk/themes_admin/viperal_admin/template/
   trunk/themes_admin/viperal_admin/template/blockleft.html
   trunk/themes_admin/viperal_admin/template/blockright.html
   trunk/themes_admin/viperal_admin/template/footer.html
   trunk/themes_admin/viperal_admin/template/header.html
Removed:
   trunk/modules/News/
   trunk/modules/Recommend_Us/
Modified:
   trunk/admin/blocks.php
   trunk/admin/functions/block_functions.php
   trunk/admin/index.php
   trunk/admin/menu.php
   trunk/admin/messages.php
   trunk/admin/system.php
   trunk/admin/users.php
   trunk/includes/db/mysql.php
   trunk/includes/display/blocks.php
   trunk/includes/display/display.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/session.php
   trunk/includes/user.php
   trunk/install/build_data.php
   trunk/install/build_tables.php
   trunk/modules/Contact/index.php
   trunk/modules/Forums/mcp.php
   trunk/modules/Forums/viewtopic.php
   trunk/modules/Quick_Message/index.php
Log:


Modified: trunk/admin/blocks.php
===================================================================
--- trunk/admin/blocks.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/admin/blocks.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -130,10 +130,12 @@
 		break;
 	}
 
+	$active = $block['block_status'] == STATUS_ACTIVE;
+
 	$_CLASS['core_template']->assign_vars_array($block_position[$block['block_position']].'_admin_blocks', array(
-			'ACTIVE'		=> ($block['block_status']),
+			'ACTIVE'		=> $active,
 			'ACTIVE_LINK'	=> generate_link('blocks&amp;mode=change&amp;id='.$block['block_id'], array('admin' => true)),
-			'CHANGE'		=> ($block['block_status']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+			'CHANGE'		=> ($active) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
 			'ERROR'			=> ($error) ? $_CLASS['core_user']->get_lang($error) : false,
 
 			'EDIT_LINK'		=> generate_link('blocks&amp;mode=edit&amp;id='.$block['block_id'], array('admin' => true)),

Modified: trunk/admin/functions/block_functions.php
===================================================================
--- trunk/admin/functions/block_functions.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/admin/functions/block_functions.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -75,7 +75,7 @@
 	}
 
 	check_position($block['block_position']);
-	$status = ($block['block_status']) ? 0 : 1;
+	$status = ($block['block_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
 
 	$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_status = '.$status.' WHERE block_id = '.$id);
 

Modified: trunk/admin/index.php
===================================================================
--- trunk/admin/index.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/admin/index.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -110,7 +110,7 @@
 			'LINK_'.$more	=> $link,
 		));
 		
-		$sql = 'SELECT user_id, username, user_regdate
+		$sql = 'SELECT user_id, username, user_reg_date
 			FROM ' . USERS_TABLE . '
 				WHERE user_type = '.USER_NORMAL.'
 				AND user_status = '.$status;

Modified: trunk/admin/menu.php
===================================================================
--- trunk/admin/menu.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/admin/menu.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -56,6 +56,16 @@
 $menu['system'][] = array('lang' => $_CLASS['core_user']->get_lang('SYSTEM_SETTINGS'), 'link' => generate_link('system&amp;mode=system', array('admin' => true)));
 $menu['system'][] = array('lang' => $_CLASS['core_user']->get_lang('BOTS'), 'link' => generate_link('users&amp;mode=bots', array('admin' => true)));
 
+$menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('USERS'), 'link' => generate_link('users', array('admin' => true)));
+$menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE'), 'link' => generate_link('users', array('admin' => true)));
+$menu['users'][] = '';
+$menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('VIEW_DISABLED'), 'link' => generate_link('users&mode=disabled', array('admin' => true)));
+$menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('VIEW_UNACTIVATED'), 'link' => generate_link('users&mode=unactivated', array('admin' => true)));
+$menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('VIEW_BOTS'), 'link' => generate_link('users&amp;mode=bots', array('admin' => true)));
+$menu['users'][] = '';
+$menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('ADD_USER'), 'link' => generate_link('users&mode=add_user', array('admin' => true)));
+$menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('ADD_BOT'), 'link' => generate_link('users&mode=add_bot', array('admin' => true)));
+
 function build_menu($menu)
 {
 	$names = array_keys($menu);

Modified: trunk/admin/messages.php
===================================================================
--- trunk/admin/messages.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/admin/messages.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -106,9 +106,11 @@
 
 foreach ($messages as $row)
 {
+	$active = $row['block_status'] == STATUS_ACTIVE;
+
 	$_CLASS['core_template']->assign_vars_array($block_position[$row['block_position']].'_admin_messages', array(
-		'ACTIVE'		=> ($row['block_status']) ? true : false,
-		'CHANGE'		=> ($row['block_status']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+		'ACTIVE'		=> $active,
+		'CHANGE'		=> ($active) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
 
 		'AUTH_LINK'		=> generate_link('messages&amp;mode=auth&amp;id='.$row['block_id'], array('admin' => true)),
 		'ACTIVE_LINK'	=> generate_link('messages&amp;mode=change&amp;id='.$row['block_id'], array('admin' => true)),

Modified: trunk/admin/system.php
===================================================================
--- trunk/admin/system.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/admin/system.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -181,7 +181,6 @@
 		'MAINTENANCE' 		=> $_CORE_CONFIG['maintenance']['active'],
 		'MAINTENANCE_MSG' 	=> $_CORE_CONFIG['maintenance']['text'],
 		'MAINTENANCE_START' => is_numeric($_CORE_CONFIG['maintenance']['start']) ? $_CLASS['core_user']->format_date($_CORE_CONFIG['maintenance']['start'], 'M d, Y h:i a') : '',
-		'BROWSER_CHECK'		=> $_CORE_CONFIG['server']['browser_check'],
 		'IP_CHECK'			=> $_CORE_CONFIG['server']['ip_check'],
 		'SITE_DOMAIN'		=> $_CORE_CONFIG['server']['site_domain'],
 		'SITE_PATH'			=> $_CORE_CONFIG['server']['site_path'],

Modified: trunk/admin/users.php
===================================================================
--- trunk/admin/users.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/admin/users.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -156,32 +156,38 @@
 			{
 				require_once($site_file_root.'includes/functions_user.php');
 			
+				$sql = 'SELECT user_id, user_type, user_status
+					FROM ' . USERS_TABLE . ' 
+					WHERE user_id = '.$id;
+				
+				$result = $_CLASS['core_db']->query($sql);
+				$row = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+
+				if ($row['user_type'] != USER_BOT)
+				{
+					break;
+				}
+
 				switch ($_REQUEST['option'])
 				{
 					case 'activate':
-						user_activate($id);
+						if ($row['user_status'] != STATUS_ACTIVE)
+						{
+							user_activate($id);
+						}
 					break;
 			
 					case 'deactivate':
-						user_disable($id);
+						if ($row['user_status'] == STATUS_ACTIVE)
+						{
+							user_disable($id);
+						}
 					break;
 				
 					case 'delete':
 						if (display_confirmation())
 						{
-							$sql = 'SELECT user_id, user_type
-								FROM ' . USERS_TABLE . ' 
-								WHERE user_id = '.$id;
-				
-							$result = $_CLASS['core_db']->query($sql);
-							$row = $_CLASS['core_db']>fetch_row_assoc($result);
-							$_CLASS['core_db']->free_result($result);
-				
-							if ($row['user_type'] != USER_BOT)
-							{
-								break;
-							}
-				
 							user_delete($id);
 				
 							trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
@@ -220,10 +226,26 @@
 			{
 				require_once($site_file_root.'includes/functions_user.php');
 
+				$sql = 'SELECT user_id, user_type, user_status
+					FROM ' . USERS_TABLE . ' 
+					WHERE user_id = '.$id;
+				
+				$result = $_CLASS['core_db']->query($sql);
+				$row = $_CLASS['core_db']>fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+
+				if ($row['user_type'] != USER_NORMAL)
+				{
+					break;
+				}
+							
 				switch ($_REQUEST['option'])
 				{
 					case 'activate':
-						user_activate($id);
+						if ($row['user_status'] != STATUS_ACTIVE)
+						{
+							user_activate($id);
+						}
 					break;
 			
 					case 'delete':
@@ -265,7 +287,7 @@
 
 			$start = get_variable('start', 'GET', false, 'integer');
 
-			$sql = 'SELECT user_id, username, user_regdate
+			$sql = 'SELECT user_id, username, user_reg_date
 				FROM ' . USERS_TABLE . '
 					WHERE user_type = '.USER_NORMAL.'
 					AND user_status = '.$status;
@@ -277,7 +299,7 @@
 				$_CLASS['core_template']->assign_vars_array('users_admin', array(
 						'user_id'		=> $row['user_id'],
 						'user_name'		=> $row['username'],
-						'registered'	=> $_CLASS['core_user']->format_time($row['user_regdate']),
+						'registered'	=> $_CLASS['core_user']->format_time($row['user_reg_date']),
 						'link_profile'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
 						'link_activate'	=> generate_link($link.'&amp;option=activate&amp;id=' . $row['user_id'], array('admin' => true)),
 						'link_remove'	=> generate_link($link.'&amp;option=delete&amp;id=' . $row['user_id'], array('admin' => true)),
@@ -306,7 +328,6 @@
 $user_status = array(STATUS_PENDING, STATUS_DISABLED);
 $last_count = 0;
 
-// needed view more
 foreach ($user_status as $status)
 {
 	$limit = ($last_count) ? 10 : 20 - $last_count;
@@ -335,7 +356,7 @@
 		'LINK_'.$more	=> $link,
 	));
 
-	$sql = 'SELECT user_id, username, user_regdate
+	$sql = 'SELECT user_id, username, user_reg_date
 		FROM ' . USERS_TABLE . '
 			WHERE user_type = '.USER_NORMAL.'
 			AND user_status = '.$status;
@@ -349,7 +370,7 @@
 		$_CLASS['core_template']->assign_vars_array($type, array(
 				'user_id'		=> $row['user_id'],
 				'user_name'		=> $row['username'],
-				'registered'	=> $_CLASS['core_user']->format_time($row['user_regdate']),
+				'registered'	=> $_CLASS['core_user']->format_time($row['user_reg_date']),
 				'link_profile'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
 				'link_activate'	=> generate_link('&amp;user_mode=activate&amp;id=' . $row['user_id'], array('admin' => true)),
 				'link_remove'	=> generate_link('&amp;user_mode=remove&amp;id=' . $row['user_id'], array('admin' => true)),

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/includes/db/mysql.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -107,7 +107,7 @@
 		$this->return_on_error = $fail;
 	}
 
-	function transaction($option = 'start')
+	function transaction($option = 'start', $auto_rollback = true)
 	{
 		if (!$this->link_identifier)
 		{
@@ -124,25 +124,26 @@
 					break;
 				}
 
-				//$result = mysql_query('SET AUTOCOMMIT=0', $this->db_connect_id);
-				$result = mysql_query('BEGIN TRANSACTION', $this->link_identifier);
+				//$result = mysql_query('SET AUTOCOMMIT = 0', $this->link_identifier);
+				$result = mysql_query('START TRANSACTION', $this->link_identifier);
 				$this->in_transaction = true;
 			break;
 
 			case 'commit':
-			
+
 				if (!$this->in_transaction)
 				{
 					break;
 				}
 
 				$result = mysql_query('COMMIT', $this->link_identifier);
-				
-				if (!$result)
+
+				if (!$result && $auto_rollback)
 				{
 					mysql_query('ROLLBACK', $this->link_identifier);
 				}
-				
+
+				//$result = mysql_query('SET AUTOCOMMIT=1', $this->link_identifier);
 				$this->in_transaction = false;
 			break;
 
@@ -153,6 +154,7 @@
 				}
 
 				$result = mysql_query('ROLLBACK', $this->link_identifier);
+				//$result = mysql_query('SET AUTOCOMMIT=1', $this->link_identifier);
 				$this->in_transaction = false;
 			break;
 		}
@@ -432,8 +434,10 @@
 		{
 			$this->transaction('rollback');
 		}
+
+		trigger_error($message, E_USER_ERROR);
 		
-		trigger_error($message, E_USER_ERROR);
+		script_close(false);
 	}
 
 	function _debug($mode, $backtrace)
@@ -546,6 +550,20 @@
 
 	function add_table_field_int($name, $setting_sent)
 	{
+		if (!$setting_sent || !is_array($setting_sent))
+		{
+			global $site_file_root;
+			
+			$debug_backtrace = debug_backtrace();
+			$backtrace = array();
+			// remove the root directorys
+			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
+			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+
+			$backtrace['line'] = $debug_backtrace[0]['line'];
+			print_r($backtrace);echo '<br/>';
+		}
+		
 		$setting = array('default' => null, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
 		$setting = array_merge($setting, $setting_sent);
 
@@ -644,7 +662,7 @@
 		{
 			return;
 		}*/
-		$field = is_array($field) ? implode(',', $field) : $field;
+		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)
 		{

Modified: trunk/includes/display/blocks.php
===================================================================
--- trunk/includes/display/blocks.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/includes/display/blocks.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -54,7 +54,7 @@
 			$side = ($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
 		}
 			
-		if ($_CORE_MODULE['sides'] == BLOCK_ALL || ($side == BLOCK_LEFT && $_CORE_MODULE['sides'] == BLOCK_LEFT) || ($side == BLOCK_RIGHT && $_CORE_MODULE['sides'] == BLOCK_RIGHT))
+		if ($_CORE_MODULE['module_sides'] == BLOCK_ALL || ($side == BLOCK_LEFT && $_CORE_MODULE['module_sides'] == BLOCK_LEFT) || ($side == BLOCK_RIGHT && $_CORE_MODULE['module_sides'] == BLOCK_RIGHT))
 		{
 			$this->load_blocks();
 
@@ -82,7 +82,7 @@
 
 		if (is_null($this->blocks_array = $_CLASS['core_cache']->get('blocks')))
 		{
-			$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_status = 1 ORDER BY block_order ASC');
+			$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_status = '.STATUS_ACTIVE.' ORDER BY block_order ASC');
 
 			$this->blocks_array = array();
 
@@ -171,7 +171,7 @@
 			{
 				$this->block['block_modules'] = unserialize($this->block['block_modules']);
 // Homepage needs it's own value
-				if (!in_array($_CORE_MODULE['title'], $this->block['block_modules']['show'] || in_array($_CORE_MODULE['title'], $this->block['block_modules']['hide'])))
+				if (!in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['show'] || in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['hide'])))
 				{
 					continue;
 				}

Modified: trunk/includes/display/display.php
===================================================================
--- trunk/includes/display/display.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/includes/display/display.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -38,25 +38,25 @@
 	{
 		global $_CLASS, $site_file_root;
 
-		if (!$module || !file_exists($site_file_root.'modules/'.$module['name'].'/index.php'))
+		if (!$module || !file_exists($site_file_root.'modules/'.$module['module_name'].'/index.php'))
 		{
 			return '404:_PAGE_NOT_FOUND';
 		}
 
-		if (!$module['active'])
+		if ($module['module_status'] != STATUS_ACTIVE)
 		{
 			if (!$_CLASS['core_auth']->admin_auth('modules'))
 			{
 				return '_MODULE_NOT_ACTIVE';
 			}
 
-			$_CLASS['core_display']->message = '<b>Module '.$module['name'].' Isn\'t Active</b><br />';
+			$_CLASS['core_display']->message = '<b>Module '.$module['module_name'].' Isn\'t Active</b><br />';
 		}
 
 		//authization check here
-		$module['auth'] = ($module['auth']) ? unserialize($module['auth']) : '';
+		$module['module_auth'] = ($module['module_auth']) ? unserialize($module['module_auth']) : '';
 
-		if (($module['auth'] && !$_CLASS['core_auth']->auth($module['auth'])) && !$_CLASS['core_auth']->admin_power('modules'))
+		if (($module['module_auth'] && !$_CLASS['core_auth']->auth($module['module_auth'])) && !$_CLASS['core_auth']->admin_power('modules'))
 		{
 			return '_MODULE_NOT_AUTH';
 		}
@@ -64,7 +64,7 @@
 		//first module control the sides.
 		if (!empty($this->modules))
 		{
-			$module['sides'] = $this->modules[0]['sides'];
+			$module['module_sides'] = $this->modules[0]['module_sides'];
 		}
 
 		$this->modules[] = $module;
@@ -113,7 +113,7 @@
 
 		if ($title)
 		{
-			$_CORE_MODULE['title'] = $title;
+			$_CORE_MODULE['module_title'] = $title;
 		}
 
 		if ($template)
@@ -142,7 +142,7 @@
 
 		if ($title)
 		{
-			$_CORE_MODULE['title'] = $title;
+			$_CORE_MODULE['module_title'] = $title;
 		}
 
 		$this->headers();
@@ -169,7 +169,7 @@
 
 		$_CLASS['core_template']->assign_array(array(
 			'SITE_LANG'			=>	$_CLASS['core_user']->lang['LANG'],
-			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.(is_array($_CORE_MODULE['title']) ? implode(' &gt; ', $_CORE_MODULE['title']) : $_CORE_MODULE['title']),
+			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.(is_array($_CORE_MODULE['module_title']) ? implode(' &gt; ', $_CORE_MODULE['module_title']) : $_CORE_MODULE['module_title']),
 			'SITE_BASE'			=>	generate_base_url(),
 			'SITE_CHARSET'		=>	'UTF-8',
 			'SITE_NAME'			=>	$_CORE_CONFIG['global']['site_name'],
@@ -211,7 +211,7 @@
 		{
 			global $site_file_root;
 
-			require($site_file_root.'modules/'.$_CORE_MODULE['name'].'/index.php');
+			require($site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/index.php');
 		}
 
 		$this->displayed['footer'] = true;

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/includes/functions.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -469,11 +469,11 @@
 	$chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
 
 	$string = '';
-	$num_chars = strlen($chars) - 1;
+	$max_chars = strlen($chars) - 1;
 
 	for ($i = 0; $i < $length; ++$i)
 	{
-		$string .= substr($chars, mt_rand(0, $num_chars), 1);
+		$string .= substr($chars, mt_rand(0, $max_chars), 1);
 	}
 
 	return $string;
@@ -556,7 +556,8 @@
 
 		if ($save)
 		{
-			if ($_CLASS['core_user']->is_admin && $_CORE_CONFIG['server']['error_options'])
+			//if ($_CLASS['core_user']->is_admin && $_CORE_CONFIG['server']['error_options'])
+			if ($_CORE_CONFIG['server']['error_options'])
 			{
 				if (!empty($_CLASS['core_db']->query_list))
 				{
@@ -662,7 +663,7 @@
 	header('Cache-Control: private, pre-check=0, post-check=0, max-age=0');
 	header('Expires: 0');
 	header('Pragma: no-cache');
-		
+
 	echo '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
 	<html>
 		<head>

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/includes/functions_user.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -94,7 +94,7 @@
 	$_CLASS['core_db']->transaction('commit');
 }
 
-function user_activate($user_id)
+function user_activate($user_id, $update_stats = true)
 {
 	global $_CLASS, $_CORE_CONFIG;
 
@@ -119,7 +119,12 @@
 
 	$_CLASS['core_db']->query($sql);
 	
-	set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + count($user_id));
+	if ($update_stats)
+	{
+		set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + count($user_id));
+
+		$_CLASS['core_cache']->destroy('core_config');
+	}
 }
 
 function user_activate_reminder($user_id)
@@ -127,7 +132,7 @@
 
 }
 
-function user_disable($user_id)
+function user_disable($user_id, $update_stats = true)
 {
 	global $_CLASS, $_CORE_CONFIG;
 
@@ -156,23 +161,27 @@
 			AND member_status = ' . STATUS_ACTIVE;
 	$_CLASS['core_db']->query($sql);
 
-	if (in_array($_CORE_CONFIG['user']['newest_user_id'], $user_id))
+	if ($update_stats)
 	{
-		$sql = 'SELECT user_id, username FROM ' . USERS_TABLE . '
-			WHERE user_type = '.USER_NORMAL.' AND user_status = '.STATUS_ACTIVE.'
-			ORDER BY user_regdate';
-
-		$result = $_CLASS['core_db']->query_limit($sql, 1);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		set_core_config('user', 'newest_user_id', $row['user_id'], false);
-		set_core_config('user', 'newest_username', $row['username'], false);
+		if (in_array($_CORE_CONFIG['user']['newest_user_id'], $user_id))
+		{
+			$sql = 'SELECT user_id, username FROM ' . USERS_TABLE . '
+				WHERE user_type = '.USER_NORMAL.' AND user_status = '.STATUS_ACTIVE.'
+				ORDER BY user_reg_date';
+	
+			$result = $_CLASS['core_db']->query_limit($sql, 1);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+	
+			set_core_config('user', 'newest_user_id', $row['user_id'], false);
+			set_core_config('user', 'newest_username', $row['username'], false);
+		}
+	
+		$total_users = $_CORE_CONFIG['user']['total_users'] - count($user_id);
+		set_core_config('user', 'total_users', $total_users, false);
+		
+		$_CLASS['core_cache']->destroy('core_config');
 	}
-
-	set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] - count($user_id), false);
-	
-	$_CLASS['core_cache']->destroy('core_config');
 }
 
 function user_delete($user_id, $quick = false)
@@ -428,15 +437,15 @@
 		return 'USERNAME_INVALID_CHARS';
 	}
 
-// wouldn't select limit be better ?
-	$sql = 'SELECT COUNT(*) as count
+	$sql = 'SELECT username
 		FROM ' . USERS_TABLE . "
-		WHERE LOWER(username) = '" . $_CLASS['core_db']->escape($username) . "'";
-	$result = $_CLASS['core_db']->query($sql);
-	list($count) = $_CLASS['core_db']->fetch_row_num($result);
+		WHERE LOWER(username) = '" . $_CLASS['core_db']->escape($username) . "'";
+
+	$result = $_CLASS['core_db']->query_limit($sql, 1);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
-	if ($count)
+	if (is_array($row))
 	{
 		return 'USERNAME_TAKEN';
 	}

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/includes/session.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -44,7 +44,7 @@
 		if ($session_id_url)
 		{
 			// session id in url > cookie
-			if (!$session_id || $session_id_url !== $session_id)
+			if (!$session_id || $session_id !== $session_id_url)
 			{
 				$session_id = $session_id_url;
 				$this->sid_link = 'sid='.$session_id;
@@ -61,7 +61,7 @@
 				FROM ' . SESSIONS_TABLE . ' s, ' . USERS_TABLE . " u
 				WHERE s.session_id = '" . $_CLASS['core_db']->escape($session_id) . "'
 					AND u.user_id = s.session_user_id";
-					
+
 			$result = $_CLASS['core_db']->query($sql);
 
 			$this->data = $_CLASS['core_db']->fetch_row_assoc($result);

Modified: trunk/includes/user.php
===================================================================
--- trunk/includes/user.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/includes/user.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -33,7 +33,7 @@
 	var $lang = array();
 	var $img = array();
 
-	var $date_format;
+	var $time_format;
 	var $timezone;
 	var $dst;
 
@@ -86,7 +86,7 @@
 			return false;;
 		}
 
-		$format = (!$format) ? $this->date_format : $format;
+		$format = (!$format) ? $this->time_format : $format;
 
 		return strtr(date($format, $this->time_convert($gmtime)), $this->lang['datetime']);
 	}
@@ -255,7 +255,7 @@
 		$this->lang_name = $_CORE_CONFIG['global']['default_lang'];
 		$this->lang_path = $site_file_root.'language/' . $this->lang_name . '/';
 
-		$this->date_format = ($this->data['user_dateformat']) ? $this->data['user_dateformat'] : $_CORE_CONFIG['global']['default_dateformat'];
+		$this->time_format = ($this->data['user_time_format']) ? $this->data['user_time_format'] : $_CORE_CONFIG['global']['default_dateformat'];
 		$this->timezone = ($this->data['user_timezone']) ? $this->data['user_timezone'] : $_CORE_CONFIG['global']['default_timezone'];
 
 		require($this->lang_path . 'common.php');
@@ -271,7 +271,7 @@
 		{
 			global $_CORE_MODULE, $_CLASS;
 			
-			$module = ($module) ? $module : $_CORE_MODULE['name'];
+			$module = ($module) ? $module : $_CORE_MODULE['module_name'];
 			$lang = ($lang) ? $lang : $this->lang_name;
 
 			if (file_exists($_CLASS['core_display']->theme_path."/images/modules/$module/$img_file"))
@@ -356,7 +356,7 @@
 		{
 			global $_CORE_MODULE;
 			
-			include($site_file_root.'modules/'.$_CORE_MODULE['name']."/language/$this->lang_name/$lang_file");
+			include($site_file_root.'modules/'.$_CORE_MODULE['module_name']."/language/$this->lang_name/$lang_file");
 
 			return;
 		}

Modified: trunk/install/build_data.php
===================================================================
--- trunk/install/build_data.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/install/build_data.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -23,7 +23,7 @@
 
 $install_prefix = 'test_';
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."admins (admin_section, member_user_id, admin_status) VALUES ('/all/', 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."admins (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
 
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
 
@@ -40,9 +40,11 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'News', 1)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 1)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mb_mail', 1)");
@@ -50,8 +52,9 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '[\w_\+\. \-\[\]]+', 1)");
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_mail', '', 1)");
@@ -62,10 +65,11 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_pass_chars', '25', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_email_reuse', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_change', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_username', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_username', 'admin', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '2', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'activation', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '1', 0)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'path', '/', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_name', 'viperal', 1)");
@@ -76,12 +80,10 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)");
-
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_domain', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
 
-
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (1, 'GUESTS', 1, 2, '', 0, '', '')");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (2, 'REGISTERED', 1, 2, '', 0, '', '')");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (3, 'REGISTERED_COPPA', 1, 2, '', 0, '', '')");
@@ -92,38 +94,39 @@
 
 
 //Admin
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (4, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (6, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (2, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (4, 2, 10)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (6, 2, 10)");
 // Anonymous
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (1, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (1, 1, 1)");
 // Bots
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 3, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 4, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 5, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 6, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 7, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, member_user_id, member_status) VALUES (5, 8, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 3, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 4, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 5, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 6, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 1)");
 
-
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('blocks', 'Blocks', 0, 2,'')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('groups', 'Groups', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('system', 'System', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('messages', 'Messages', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('modules', 'Modules', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('services', 'Services', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('smiles', 'Smiles', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_admin_options) VALUES ('users', 'Users', 0, 2, '')");
-
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (5, 'News', 'News', 1, 1, 1, '0', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (6, 'Recommend_Us', 'Recommend Us', 1, 1, 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (7, 'Submit_News', 'Submit News', 1, 1, 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (8, 'Forums', 'Forums', 1, 1, 2, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (9, 'View_Online', 'View_Online', 1, 1, 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (10, 'Members_List', 'Members_List', 1, 1, 2, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (11, 'Control_Panel', 'Control_Panel', 1, 1, 2, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (12, 'Calender', 'Calender', 1, 1, 2, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_title, module_type, module_status, module_sides) VALUES (13, 'Quick_Message', 'Quick_Message', 1, 1, 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('blocks', 0, 2,'')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('system', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('messages', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('modules', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('smiles', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
 
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Articles', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Recommend_Us', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 2, 1)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3)");
@@ -148,14 +151,14 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username) VALUES (1, 16, 1, 'Anonymous')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_password, user_password_encoding, user_colour) VALUES (2, 148, 4, 'Admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (3, 24, 5, 'Googlebot', '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (4, 24, 5, 'MSN', '65.54.188.', 'msnbot/', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (5, 24, 5, 'Yahoo', '66.196.90.1', 'Yahoo! Slurp', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (6, 24, 5, 'Alexa', '66.28.250.,209.237.238.', 'ia_archiver', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (7, 24, 5, 'NaverBot', '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, group_id, username, user_ip, user_agent, user_colour) VALUES (8, 24, 5, 'Jetbot', '64.71.144.', 'Jetbot/', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username) VALUES (1, 0, 2, 1, 'Anonymous')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_colour) VALUES (2, 1, 2, 4, 'Admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (3, 2, 2, 5, 'Googlebot', '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (4, 2, 2, 5, 'MSN', '65.54.188.', 'msnbot/', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (5, 2, 2, 5, 'Yahoo', '66.196.90.1', 'Yahoo! Slurp', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (6, 2, 2, 5, 'Alexa', '66.28.250.,209.237.238.', 'ia_archiver', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (7, 2, 2, 5, 'NaverBot', '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (8, 2, 2, 5, 'Jetbot', '64.71.144.', 'Jetbot/', '')");
 
 // Forums
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
@@ -204,7 +207,27 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_ip', 1, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_info', 1, 1)");
 
-// this should be replaced by beta
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_readpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendim', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_hideonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewprofile', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgavatar', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chggrp', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgname', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgpasswd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgcensors', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_savedrafts', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sig', 1)");
+
+// START: This should be replaced by beta
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_server', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_defaults', 1)");
@@ -242,26 +265,6 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_events', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cron', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendemail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_readpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendim', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_hideonline', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewonline', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewprofile', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgavatar', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chggrp', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgemail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgname', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgpasswd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgcensors', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_savedrafts', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sig', 1)");
-
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_attach', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_html', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_bbsmiley_code', 1)");
@@ -276,13 +279,6 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_img', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_flash', 1)");
 
-/*
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 1, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (user_id, forum_id, auth_option_id, auth_setting) SELECT 2, 2, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
-*/
-
 // ADMINISTRATOR group
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
@@ -360,6 +356,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_startdate', ".gmtime().", 0)");
 
 // to be removed
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_function_name', 'mail', 0)");
@@ -459,5 +456,4 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'MAIN', 'main', 1, 1, 'front\r\nforum_view\r\ntopic_view\r\npost_details', 'acl_m_')");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')");
 
-
 ?>
\ No newline at end of file

Modified: trunk/install/build_tables.php
===================================================================
--- trunk/install/build_tables.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/install/build_tables.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -27,7 +27,7 @@
 {
 	global $_CLASS;
 
-	$_CLASS['core_db']->add_table_field_int(array('name' => $name, 'min' => 0, 'max' => 200000000, 'null' => $null));
+	$_CLASS['core_db']->add_table_field_int($name, array('max' => 200000000, 'null' => $null));
 }
 
 /*
@@ -38,8 +38,8 @@
 
 $_CLASS['core_db']->add_table_field_char('admin_section', 100);
 
-$_CLASS['core_db']->add_table_field_int('member_user_id', array('max' => 16000000, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('member_group_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('admin_status', array('max' => 10));
 $_CLASS['core_db']->add_table_field_text('admin_options', 60000, true);
 
@@ -105,9 +105,9 @@
 $_CLASS['core_db']->add_table_field_int('group_rank', array('max' => 2000));
 $_CLASS['core_db']->add_table_field_char('group_colour', 6);
 $_CLASS['core_db']->add_table_field_char('group_avatar', 100);
-$_CLASS['core_db']->add_table_field_int('group_avatar_type', 0, 200);
-$_CLASS['core_db']->add_table_field_int('group_avatar_width', 0, 200);
-$_CLASS['core_db']->add_table_field_int('group_avatar_height', 0, 200);
+$_CLASS['core_db']->add_table_field_int('group_avatar_type', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('group_avatar_width', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('group_avatar_height', array('max' => 200));
 
 $_CLASS['core_db']->add_table_field_int('group_sig_chars', array('max' => 160000));
 $_CLASS['core_db']->add_table_field_int('group_receive_pm', array('max' => 10));
@@ -130,11 +130,11 @@
 $_CLASS['core_db']->table_create('start', $install_prefix.'groups_members');
 
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('member_user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('member_status', array('max' => 16000000));
 
 $_CLASS['core_db']->add_table_index('group_id');
-$_CLASS['core_db']->add_table_index('member_user_id');
+$_CLASS['core_db']->add_table_index('user_id');
 $_CLASS['core_db']->add_table_index('member_status');
 
 $_CLASS['core_db']->table_create('commit');
@@ -146,7 +146,7 @@
 
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_name', 100);
-$_CLASS['core_db']->add_table_field_char('module_title', 100);
+$_CLASS['core_db']->add_table_field_char('module_title', 100, true);
 $_CLASS['core_db']->add_table_field_int('module_type', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('module_status', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('module_sides', array('max' => 10, 'null' => true));
@@ -165,7 +165,7 @@
 $_CLASS['core_db']->table_create('start', $install_prefix.'sessions');
 
 $_CLASS['core_db']->add_table_field_char('session_id', 40);
-$_CLASS['core_db']->add_table_field_int('session_user_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('session_user_id', array('max' => 16000000));
 field_unix_time('session_last_visit');
 field_unix_time('session_start');
 field_unix_time('session_time');
@@ -191,7 +191,7 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'sessions_auto_login');
 
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('auto_login_browser', 255);
 $_CLASS['core_db']->add_table_field_char('auto_login_code', 40);
 field_unix_time('auto_login_time');
@@ -233,8 +233,8 @@
 $_CLASS['core_db']->add_table_field_char('user_password', 40);
 $_CLASS['core_db']->add_table_field_char('user_password_encoding', 10);
 $_CLASS['core_db']->add_table_field_char('user_email', 100);
-$_CLASS['core_db']->add_table_field_int('user_type', 0, 1);
-$_CLASS['core_db']->add_table_field_int('user_status', 0, 10);
+$_CLASS['core_db']->add_table_field_int('user_type', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('user_status', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('user_group', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('user_ip', 255);
 $_CLASS['core_db']->add_table_field_char('user_agent', 255, null);
@@ -273,10 +273,10 @@
 $_CLASS['core_db']->add_table_field_char('user_occ', 255, true);
 
 // look at these
-$_CLASS['core_db']->add_table_field_int('user_message_limit', 0, 200);
-$_CLASS['core_db']->add_table_field_int('user_message_rules', 0, 1);
-$_CLASS['core_db']->add_table_field_int('user_full_folder', -10, 16000000, -3);
-$_CLASS['core_db']->add_table_field_int('user_attachsig', 0, 1, 1);
+//$_CLASS['core_db']->add_table_field_int('user_message_limit', 0, 200);
+//$_CLASS['core_db']->add_table_field_int('user_message_rules', 0, 1);
+//$_CLASS['core_db']->add_table_field_int('user_full_folder', -1array('max' => 16000000), -3);
+//$_CLASS['core_db']->add_table_field_int('user_attachsig', 0, 1, 1);
 ///
 
 $_CLASS['core_db']->add_table_field_int('user_notify', array('max' => 1));
@@ -325,20 +325,20 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_attachments');
 
-$_CLASS['core_db']->add_table_field_int('attach_id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_int('post_msg_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('poster_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('download_count', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('in_message'. 0, 1);
+$_CLASS['core_db']->add_table_field_int('attach_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('post_msg_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('download_count', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('in_message', array('max' => 1));
 
 $_CLASS['core_db']->add_table_field_text('comment', 200);
 $_CLASS['core_db']->add_table_field_char('physical_filename', 255);
 $_CLASS['core_db']->add_table_field_char('real_filename', 255);
-$_CLASS['core_db']->add_table_field_int('thumbnail'. 0, 1);
+$_CLASS['core_db']->add_table_field_int('thumbnail', array('max' => 1));
 $_CLASS['core_db']->add_table_field_char('extension', 50);
 $_CLASS['core_db']->add_table_field_char('mimetype', 100);
-$_CLASS['core_db']->add_table_field_int('filesize', 0, 1000000000);
+$_CLASS['core_db']->add_table_field_int('filesize', array('max' => 16000000));
 field_unix_time('filetime');
 
 $_CLASS['core_db']->add_table_index('attach_id', 'primary');
@@ -353,11 +353,11 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth');
 
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('group_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('auth_option_id', 0, 2000);
-$_CLASS['core_db']->add_table_field_int('auth_setting', 0, 1);
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('auth_option_id', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_int('auth_setting', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('user_id');
 $_CLASS['core_db']->add_table_index('group_id');
@@ -370,11 +370,10 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth_options');
 
-$_CLASS['core_db']->add_table_field_int('auth_option_id', 0, 2000, 0, true);
+$_CLASS['core_db']->add_table_field_int('auth_option_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('auth_option', 20);
-$_CLASS['core_db']->add_table_field_int('is_global', 0, 1);
-$_CLASS['core_db']->add_table_field_int('is_local', 0, 1);
-$_CLASS['core_db']->add_table_field_int('founder_only', 0, 1);
+$_CLASS['core_db']->add_table_field_int('is_global', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('is_local', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('auth_option_id', 'primary');
 $_CLASS['core_db']->add_table_index('auth_option', 'unique');
@@ -386,8 +385,8 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth_presets');
 
-$_CLASS['core_db']->add_table_field_int('preset_id', 0, 20000, 0, true);
-$_CLASS['core_db']->add_table_field_int('preset_user_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('preset_id', array('max' => 16000));
+$_CLASS['core_db']->add_table_field_int('preset_user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('preset_name', 50);
 $_CLASS['core_db']->add_table_field_char('preset_type', 2);
 $_CLASS['core_db']->add_table_field_text('preset_data', 2000);
@@ -403,9 +402,9 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_bookmarks');
 
-$_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('order_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('order_id', array('max' => 16000000));
 
 $_CLASS['core_db']->add_table_index('topic_id');
 $_CLASS['core_db']->add_table_index('user_id');
@@ -419,7 +418,7 @@
 
 $_CLASS['core_db']->add_table_field_char('config_name', 100);
 $_CLASS['core_db']->add_table_field_char('config_value', 255);
-$_CLASS['core_db']->add_table_field_int('is_dynamic', 0, 1);
+$_CLASS['core_db']->add_table_field_int('is_dynamic', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('config_name', 'primary');
 $_CLASS['core_db']->add_table_index('is_dynamic');
@@ -429,27 +428,29 @@
 /*
 	Forums Disallow Table
 */
+/*
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_disallow');
 
-$_CLASS['core_db']->add_table_field_int('disallow_id', 0, 16000000, 0, true);
+$_CLASS['core_db']->add_table_field_int('disallow_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('disallow_username', 30);
 
 $_CLASS['core_db']->add_table_index('disallow_id', 'primary');
 
 $_CLASS['core_db']->table_create('commit');
+*/
 
 /*
 	Forums Drafts Table
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_drafts');
 
-$_CLASS['core_db']->add_table_field_int('draft_id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('draft_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 field_unix_time('save_time');
 $_CLASS['core_db']->add_table_field_char('draft_subject', 50);
-$_CLASS['core_db']->add_table_field_text('draft_message', 0, 16000000);
+$_CLASS['core_db']->add_table_field_text('draft_message',  16000000);
 
 $_CLASS['core_db']->add_table_index('draft_id', 'primary');
 $_CLASS['core_db']->add_table_index('user_id');
@@ -462,8 +463,8 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_extensions');
 
-$_CLASS['core_db']->add_table_field_int('extension_id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_int('group_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('extension_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('extension', 100);
 
 $_CLASS['core_db']->add_table_index('extension_id', 'primary');
@@ -475,15 +476,15 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_extension_groups');
 
-$_CLASS['core_db']->add_table_field_int('group_id', 0, 16000000, 0, true);
+$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('group_name', 20);
-$_CLASS['core_db']->add_table_field_int('cat_id', 0, 200);
-$_CLASS['core_db']->add_table_field_int('allow_group', 0, 1);
-$_CLASS['core_db']->add_table_field_int('download_mode', 0, 1);
+$_CLASS['core_db']->add_table_field_int('cat_id', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_int('allow_group', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('download_mode', array('max' => 1));
 $_CLASS['core_db']->add_table_field_char('upload_icon', 100);
-$_CLASS['core_db']->add_table_field_int('max_filesize', 0, 1000000000);
+$_CLASS['core_db']->add_table_field_int('max_filesize', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_text('allowed_forums', 2000);
-$_CLASS['core_db']->add_table_field_int('allow_in_pm', 0, 1);
+$_CLASS['core_db']->add_table_field_int('allow_in_pm', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('group_id', 'primary');
 
@@ -494,42 +495,44 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_forums');
 
-$_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000, 0, true);
-$_CLASS['core_db']->add_table_field_int('parent_id', 0, 16000);
-$_CLASS['core_db']->add_table_field_int('left_id', 0, 16000);
-$_CLASS['core_db']->add_table_field_int('right_id', 0, 16000);
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('parent_id', array('max' => 16000));
+$_CLASS['core_db']->add_table_field_int('left_id', array('max' => 16000));
+$_CLASS['core_db']->add_table_field_int('right_id', array('max' => 16000));
 $_CLASS['core_db']->add_table_field_text('forum_parents', 20000);
 $_CLASS['core_db']->add_table_field_char('forum_name', 150);
 $_CLASS['core_db']->add_table_field_text('forum_desc', 20000);
 $_CLASS['core_db']->add_table_field_text('forum_rules', 20000);
 $_CLASS['core_db']->add_table_field_char('forum_rules_link', 200);
 $_CLASS['core_db']->add_table_field_char('forum_rules_flags', 50);
-$_CLASS['core_db']->add_table_field_int('forum_rules_bbcode_bitfield',0 , 1000000000);
+$_CLASS['core_db']->add_table_field_int('forum_rules_bbcode_bitfield', array('max' => 1000000000));
 $_CLASS['core_db']->add_table_field_char('forum_rules_bbcode_uid', 5);
 $_CLASS['core_db']->add_table_field_char('forum_link', 200);
 $_CLASS['core_db']->add_table_field_char('forum_password', 40);
 $_CLASS['core_db']->add_table_field_char('forum_password_encoding', 10);
 $_CLASS['core_db']->add_table_field_char('forum_image', 200);
-$_CLASS['core_db']->add_table_field_int('forum_topics_per_page', 0, 200);
-$_CLASS['core_db']->add_table_field_int('forum_type', 0, 1);
-$_CLASS['core_db']->add_table_field_int('forum_status', 0, 1);
-$_CLASS['core_db']->add_table_field_int('forum_posts', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('forum_topics', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('forum_topics_real', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('forum_last_post_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('forum_last_poster_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('forum_topics_per_page', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('forum_type', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('forum_status', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('forum_posts', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('forum_topics', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('forum_topics_real', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('forum_last_post_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('forum_last_poster_id', array('max' => 16000000));
 field_unix_time('forum_last_post_time');
 $_CLASS['core_db']->add_table_field_char('forum_last_poster_name', 50);
-$_CLASS['core_db']->add_table_field_int('forum_flags', 0, 200);
-$_CLASS['core_db']->add_table_field_int('display_on_index', 0, 1);
-$_CLASS['core_db']->add_table_field_int('enable_indexing', 0, 1);
-$_CLASS['core_db']->add_table_field_int('enable_icons', 0, 1);
+$_CLASS['core_db']->add_table_field_int('forum_flags', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('display_on_index', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('enable_indexing', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('enable_icons', array('max' => 1));
 field_unix_time('prune_next');
 
 //////
-$_CLASS['core_db']->add_table_field_int('prune_days', 0, 200);
-$_CLASS['core_db']->add_table_field_int('prune_viewed', 0, 200);
-$_CLASS['core_db']->add_table_field_int('prune_freq', 0, 200);
+
+$_CLASS['core_db']->add_table_field_int('enable_prune', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('prune_days', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('prune_viewed', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('prune_freq', array('max' => 200));
 //////
 
 $_CLASS['core_db']->add_table_index('forum_id', 'primary');
@@ -543,32 +546,32 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_posts');
 
-$_CLASS['core_db']->add_table_field_int('post_id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000);
-$_CLASS['core_db']->add_table_field_int('right_id', 0, 16000);
-$_CLASS['core_db']->add_table_field_int('poster_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('post_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000));
+$_CLASS['core_db']->add_table_field_int('right_id', array('max' => 16000));
+$_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
 field_unix_time('post_time');
 $_CLASS['core_db']->add_table_field_char('poster_ip', 20);
 $_CLASS['core_db']->add_table_field_char('post_username', 50);
-$_CLASS['core_db']->add_table_field_int('enable_bbcode', 0, 1);
-$_CLASS['core_db']->add_table_field_int('enable_html', 0, 1);
-$_CLASS['core_db']->add_table_field_int('enable_smilies', 0, 1);
-$_CLASS['core_db']->add_table_field_int('enable_sig', 0, 1);
+$_CLASS['core_db']->add_table_field_int('enable_bbcode', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('enable_html', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('enable_smilies', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('enable_sig', array('max' => 1));
 field_unix_time('post_edit_time');
-$_CLASS['core_db']->add_table_field_int('post_edit_count', 0, 20000);
-$_CLASS['core_db']->add_table_field_int('post_attachment', 0, 1);
+$_CLASS['core_db']->add_table_field_int('post_edit_count', array('max' => 20000));
+$_CLASS['core_db']->add_table_field_int('post_attachment', array('max' => 1));
 $_CLASS['core_db']->add_table_field_char('post_subject', 50);
 $_CLASS['core_db']->add_table_field_text('post_text', 10000000);
 $_CLASS['core_db']->add_table_field_char('bbcode_uid', 10);
-$_CLASS['core_db']->add_table_field_int('bbcode_bitfield', 0, 1000000000);
-$_CLASS['core_db']->add_table_field_int('icon_id', 0, 200, 1);
-$_CLASS['core_db']->add_table_field_int('enable_magic_url', 0, 1, 1);
-$_CLASS['core_db']->add_table_field_int('post_approved', 0, 1, 1);
+$_CLASS['core_db']->add_table_field_int('bbcode_bitfield', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('enable_magic_url', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('post_approved', array('max' => 1));
 $_CLASS['core_db']->add_table_field_char('post_edit_reason', 255);
-$_CLASS['core_db']->add_table_field_int('post_edit_user', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('post_edit_locked', 0, 1);
-$_CLASS['core_db']->add_table_field_int('post_reported', 0, 1);
+$_CLASS['core_db']->add_table_field_int('post_edit_user', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('post_edit_locked', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('post_reported', array('max' => 1));
 $_CLASS['core_db']->add_table_field_char('post_encoding', 10, 'utf-8'); // to be removed
 $_CLASS['core_db']->add_table_field_char('post_checksum', 32);
 
@@ -586,40 +589,40 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_topics');
 
-$_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000, 0, true);
-$_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('topic_title', 50);
-$_CLASS['core_db']->add_table_field_int('topic_poster', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('topic_poster', array('max' => 16000000));
 field_unix_time('topic_time');
-$_CLASS['core_db']->add_table_field_int('topic_views', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('topic_replies', 0, 16000000);  
-$_CLASS['core_db']->add_table_field_int('topic_status', 0, 1);
-$_CLASS['core_db']->add_table_field_int('topic_type', 0, 1);
-$_CLASS['core_db']->add_table_field_int('topic_last_post_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('topic_first_post_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('topic_moved_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('icon_id', 0, 200);
+$_CLASS['core_db']->add_table_field_int('topic_views', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_replies', array('max' => 16000000));  
+$_CLASS['core_db']->add_table_field_int('topic_status', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('topic_type', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('topic_last_post_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_first_post_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_moved_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
 
-$_CLASS['core_db']->add_table_field_int('topic_attachment', 0, 1);
-$_CLASS['core_db']->add_table_field_int('topic_approved', 0, 1, 1);
-$_CLASS['core_db']->add_table_field_int('topic_reported', 0, 1); 
+$_CLASS['core_db']->add_table_field_int('topic_attachment', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('topic_approved', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('topic_reported', array('max' => 1)); 
 field_unix_time('topic_time_limit');
-$_CLASS['core_db']->add_table_field_int('topic_replies_real', 16000000);
+$_CLASS['core_db']->add_table_field_int('topic_replies_real', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('topic_first_poster_name', 50);
-$_CLASS['core_db']->add_table_field_int('topic_last_poster_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('topic_last_poster_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('topic_last_poster_name', 50);
 field_unix_time('topic_last_post_time');
 field_unix_time('topic_last_view_time');
 
-$_CLASS['core_db']->add_table_field_int('topic_bumped', 0, 1);
-$_CLASS['core_db']->add_table_field_int('topic_bumper', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('topic_bumped', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('topic_bumper', array('max' => 16000000));
   
 $_CLASS['core_db']->add_table_field_char('poll_title', 100);
 field_unix_time('poll_start');
 field_unix_time('poll_length'); 
-$_CLASS['core_db']->add_table_field_int('poll_max_options', 0, 200, 1);
+$_CLASS['core_db']->add_table_field_int('poll_max_options', array('max' => 200));
 field_unix_time('poll_last_vote');
-$_CLASS['core_db']->add_table_field_int('poll_vote_change', 0, 1);
+$_CLASS['core_db']->add_table_field_int('poll_vote_change', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('topic_id', 'primary');
 $_CLASS['core_db']->add_table_index('forum_id');
@@ -634,9 +637,9 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_tracking');
 
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 field_unix_time('mark_time');
 
 $_CLASS['core_db']->add_table_index('user_id');
@@ -650,12 +653,12 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_icons');
 
-$_CLASS['core_db']->add_table_field_int('icons_id', 0, 2000, 0, true);
+$_CLASS['core_db']->add_table_field_int('icons_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('icons_url', 50);
-$_CLASS['core_db']->add_table_field_int('icons_width', 0, 2000);
-$_CLASS['core_db']->add_table_field_int('icons_height', 0, 2000);
-$_CLASS['core_db']->add_table_field_int('icons_order', 0, 2000);
-$_CLASS['core_db']->add_table_field_int('display_on_posting', 0, 1);
+$_CLASS['core_db']->add_table_field_int('icons_width', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('icons_height', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('icons_order', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_int('display_on_posting', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('icons_id', 'primary');
 
@@ -667,10 +670,10 @@
 
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_watch');
 
-$_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('notify_status', 0, 1);
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('notify_status', array('max' => 10));
 
 $_CLASS['core_db']->add_table_index('forum_id');
 $_CLASS['core_db']->add_table_index('topic_id');
@@ -683,12 +686,12 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_modules');
 
-$_CLASS['core_db']->add_table_field_int('module_id', 0, 20000, 0, true);
+$_CLASS['core_db']->add_table_field_int('module_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_type', 3);
 $_CLASS['core_db']->add_table_field_char('module_title', 50);
 $_CLASS['core_db']->add_table_field_char('module_filename', 50);
-$_CLASS['core_db']->add_table_field_int('module_order', 0, 200);
-$_CLASS['core_db']->add_table_field_int('module_enabled', 0, 1);
+$_CLASS['core_db']->add_table_field_int('module_order', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_int('module_enabled', array('max' => 1));
 $_CLASS['core_db']->add_table_field_text('module_subs', 2000);
 $_CLASS['core_db']->add_table_field_char('module_acl', 200);
 
@@ -703,12 +706,12 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_moderator_cache');
 
-$_CLASS['core_db']->add_table_field_int('forum_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('username', 50);
-$_CLASS['core_db']->add_table_field_int('group_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('groupname', 50);
-$_CLASS['core_db']->add_table_field_int('display_on_index', 0, 1);
+$_CLASS['core_db']->add_table_field_int('display_on_index', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('forum_id');
 $_CLASS['core_db']->add_table_index('display_on_index');
@@ -722,10 +725,10 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_poll_results');
 
-$_CLASS['core_db']->add_table_field_int('poll_option_id', 0, 2000);
-$_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('poll_option_id', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('poll_option_text', 255);
-$_CLASS['core_db']->add_table_field_int('poll_option_total', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('poll_option_total', array('max' => 16000000));
 
 $_CLASS['core_db']->add_table_index('poll_option_id');
 $_CLASS['core_db']->add_table_index('topic_id');
@@ -737,9 +740,9 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_poll_voters');
 
-$_CLASS['core_db']->add_table_field_int('topic_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('poll_option_id', 0, 2000);
-$_CLASS['core_db']->add_table_field_int('vote_user_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('poll_option_id', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_int('vote_user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('vote_user_ip', 40);
 
 $_CLASS['core_db']->add_table_index('topic_id');
@@ -755,10 +758,10 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_ranks');
 
-$_CLASS['core_db']->add_table_field_int('rank_id', 0, 16000000);
+$_CLASS['core_db']->add_table_field_int('rank_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('rank_title', 50);
-$_CLASS['core_db']->add_table_field_int('rank_min', -1, 16000000);
-$_CLASS['core_db']->add_table_field_int('rank_special', 0, 1);
+$_CLASS['core_db']->add_table_field_int('rank_min', array('min' => -1, 'max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('rank_special', array('max' => 1));
 $_CLASS['core_db']->add_table_field_char('rank_image', 100);
 
 $_CLASS['core_db']->add_table_index('rank_id');
@@ -770,10 +773,10 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_zebra');
 
-$_CLASS['core_db']->add_table_field_int('user_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('zebra_id', 0, 16000000);
-$_CLASS['core_db']->add_table_field_int('friend', 0, 1);
-$_CLASS['core_db']->add_table_field_int('foe', 0, 1);
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('zebra_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('friend', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('foe', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('user_id');
 $_CLASS['core_db']->add_table_index('zebra_id');

Modified: trunk/modules/Contact/index.php
===================================================================
--- trunk/modules/Contact/index.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/modules/Contact/index.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -1,18 +1,28 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
+// Add departments
+
 if (!defined('VIPERAL'))
 {
     die;
@@ -25,7 +35,7 @@
 
 if (!empty($_POST['preview']) || !empty($_POST['contact']))
 {
-	$data['MESSAGE']= get_variable('message', 'POST', '');
+	$data['MESSAGE']= trim(get_variable('message', 'POST', ''));
 	$data['NAME']	= get_variable('sender_name', 'POST', '');
 	$data['EMAIL']	= get_variable('sender_email', 'POST', '');
 
@@ -72,6 +82,7 @@
 
 $_CLASS['core_template']->display('modules/Contact/index.html');
 
+// remove this function
 function send_feedback($sender_name, $sender_email, $message, $preview = false)
 {
 	global $_CLASS, $_CORE_CONFIG;
@@ -89,12 +100,15 @@
 	if ($preview)
 	{
 		$_CLASS['core_template']->assign('PREVIEW', $body);
+
 		return;
 	}
 
+	require_once($site_file_root.'includes/mailer.php');
+
 	$mailer = new core_mailer;
-	$mailer->to('newuser at localhost', 'Viperal');
-	$mailer->subject('New Feedback');
+	$mailer->to($_CORE_CONFIG['email']['site_mail'], false);
+	$mailer->subject($_CLASS['core_user']->get_lang('SITE_FEEDBACK'));
 
 	$mailer->message = $body;
 

Modified: trunk/modules/Forums/mcp.php
===================================================================
--- trunk/modules/Forums/mcp.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/modules/Forums/mcp.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -55,7 +55,7 @@
 		);
 		
 		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
-			FROM ' . MODULES_TABLE . "
+			FROM ' . FORUMS_MODULES_TABLE . "
 			WHERE module_type = '{$module_type}'
 				AND module_enabled = 1
 			ORDER BY module_order ASC";
@@ -215,7 +215,7 @@
 	{
 		global $_CLASS;
 
-		$_CLASS['core_display']->display_head($page_title);
+		$_CLASS['core_display']->display_header($page_title);
 		
 		page_header();
 
@@ -249,7 +249,7 @@
 			case 'unapproved_topics':
 
 				$sql = 'SELECT COUNT(*) AS total
-					FROM ' . TOPICS_TABLE . '
+					FROM ' . FORUMS_TOPICS_TABLE . '
 					WHERE forum_id IN (' . implode(', ', $forum_list) . ')
 						AND topic_approved = 0';
 				$result = $_CLASS['core_db']->query($sql);
@@ -261,7 +261,7 @@
 			case 'unapproved_posts':
 
 				$sql = 'SELECT COUNT(*) AS total
-						FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t 
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t 
 						WHERE p.forum_id IN (' . implode(', ', $forum_list) . ')
 							AND p.post_approved = 0
 							AND t.topic_id = p.topic_id
@@ -384,7 +384,7 @@
 	{
 		// We determine the topic and forum id here, to make sure the moderator really has moderative rights on this post
 		$sql = 'SELECT topic_id, forum_id
-			FROM ' . POSTS_TABLE . "
+			FROM ' . FORUMS_POSTS_TABLE . "
 			WHERE post_id = $post_id";
 		$result = $_CLASS['core_db']->query($sql);
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -397,7 +397,7 @@
 	if ($topic_id && !$forum_id)
 	{
 		$sql = 'SELECT forum_id
-			FROM ' . TOPICS_TABLE . "
+			FROM ' . FORUMS_TOPICS_TABLE . "
 			WHERE topic_id = $topic_id";
 		$result = $_CLASS['core_db']->query($sql);
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -489,8 +489,8 @@
 	}
 
 	$sql = 'SELECT f.*, t.*
-		FROM ' . TOPICS_TABLE . ' t
-			LEFT JOIN ' . FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
+		FROM ' . FORUMS_TOPICS_TABLE . ' t
+			LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
 		WHERE t.topic_id IN (' . implode(', ', $topic_ids) . ')';
 	$result = $_CLASS['core_db']->query($sql);
 		
@@ -514,8 +514,8 @@
 	$rowset = array();
 
 	$sql = 'SELECT p.*, u.*, t.*, f.*
-		FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u, ' . TOPICS_TABLE . ' t
-			LEFT JOIN ' . FORUMS_TABLE . ' f ON f.forum_id = p.forum_id
+		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u, ' . FORUMS_TOPICS_TABLE . ' t
+			LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON f.forum_id = p.forum_id
 		WHERE p.post_id IN (' . implode(', ', $post_ids) . ')
 			AND u.user_id = p.poster_id
 			AND t.topic_id = p.topic_id';
@@ -546,7 +546,7 @@
 	$rowset = array();
 
 	$sql = 'SELECT *
-		FROM ' . FORUMS_TABLE . '
+		FROM ' . FORUMS_FORUMS_TABLE . '
 		WHERE forum_id ' . ((is_array($forum_id)) ? 'IN (' . implode(', ', $forum_id) . ')' : "= $forum_id");
 	$result = $_CLASS['core_db']->query($sql);
 		
@@ -581,7 +581,7 @@
 			$default_key = 't';
 			$default_dir = 'd';
 			$sql = 'SELECT COUNT(topic_id) AS total
-				FROM ' . TOPICS_TABLE . "
+				FROM ' . FORUMS_TOPICS_TABLE . "
 				$where_sql forum_id = $forum_id
 					AND topic_type NOT IN (" . POST_ANNOUNCE . ', ' . POST_GLOBAL . ")
 					AND topic_last_post_time >= $min_time";
@@ -597,7 +597,7 @@
 			$default_key = 't';
 			$default_dir = 'a';
 			$sql = 'SELECT COUNT(post_id) AS total
-				FROM ' . POSTS_TABLE . "
+				FROM ' . FORUMS_POSTS_TABLE . "
 				$where_sql topic_id = $topic_id
 					AND post_time >= $min_time";
 			if (!$_CLASS['auth']->acl_get('m_approve', $forum_id))
@@ -611,7 +611,7 @@
 			$default_key = 't';
 			$default_dir = 'd';
 			$sql = 'SELECT COUNT(post_id) AS total
-				FROM ' . POSTS_TABLE . "
+				FROM ' . FORUMS_POSTS_TABLE . "
 				$where_sql forum_id IN (" . (($forum_id) ? $forum_id : implode(', ', get_forum_list('m_approve'))) . ')
 					AND post_approved = 0
 					AND post_time >= ' . $min_time;
@@ -622,7 +622,7 @@
 			$default_key = 't';
 			$default_dir = 'd';
 			$sql = 'SELECT COUNT(topic_id) AS total
-				FROM ' . TOPICS_TABLE . "
+				FROM ' . FORUMS_TOPICS_TABLE . "
 				$where_sql forum_id IN (" . (($forum_id) ? $forum_id : implode(', ', get_forum_list('m_approve'))) . ')
 					AND topic_approved = 0
 					AND topic_time >= ' . $min_time;
@@ -647,7 +647,7 @@
 				$where_sql .= ' p.forum_id IN (' . implode(', ', get_forum_list('m_')) . ')';
 			}
 			$sql = 'SELECT COUNT(r.report_id) AS total
-				FROM ' . REPORTS_TABLE . ' r, ' . POSTS_TABLE . " p
+				FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . FORUMS_POSTS_TABLE . " p
 				$where_sql
 					AND p.post_id = r.post_id
 					$limit_time_sql";
@@ -658,7 +658,7 @@
 			$default_key = 't';
 			$default_dir = 'd';
 			$sql = 'SELECT COUNT(log_id) AS total
-				FROM ' . LOG_TABLE . "
+				FROM ' . FORUMS_LOG_TABLE . "
 				$where_sql forum_id IN (" . (($forum_id) ? $forum_id : implode(', ', get_forum_list('m_'))) . ')
 					AND log_time >= ' . $min_time . ' 
 					AND log_type = ' . LOG_MOD;

Modified: trunk/modules/Forums/viewtopic.php
===================================================================
--- trunk/modules/Forums/viewtopic.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/modules/Forums/viewtopic.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -328,7 +328,6 @@
 // General Viewtopic URL for return links
 $viewtopic_url = "Forums&amp;file=viewtopic&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : '');
 
-
 // Grab ranks
 $ranks = obtain_ranks();
 
@@ -1326,14 +1325,17 @@
 	else
 	{
 		$topic_last_read = 0;
+
 		if (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track']))
 		{
 			$tracking_topics = unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track']));
+
 			if (isset($tracking_topics[$forum_id]))
 			{
 				$topic_last_read = base_convert(max($tracking_topics[$forum_id]), 36, 10);
 				$topic_last_read = max($topic_last_read, $_CLASS['core_user']->data['session_last_visit']);
 			}
+
 			unset($tracking_topics);
 		}
 	}

Modified: trunk/modules/Quick_Message/index.php
===================================================================
--- trunk/modules/Quick_Message/index.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/modules/Quick_Message/index.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -1,16 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (!defined('VIPERAL'))
 {
     die;
@@ -46,7 +56,7 @@
 			trigger_error('LONG_MESSAGE');
 		}
 
-		$message 	= htmlentities($message, ENT_QUOTES, 'UTF-8');
+		$message = htmlentities($message, ENT_QUOTES, 'UTF-8');
 
 	// use limit
 		$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['last_post_check']));
@@ -69,10 +79,39 @@
 		else
 		{
 			$user_id = 0;
-			$user_name = get_username();
+			$user_name = get_variable('poster_name', 'POST', false);
+
+			if (!$user_name)
+			{
+				if ($_CORE_CONFIG['quick_message']['anonymous_posting'] != '2')
+				{
+					trigger_error('NO_NAME');
+				}
+			}
+			else
+			{
+				$length = mb_strlen($user_name);
+
+				if ($length < 2)
+				{
+					trigger_error('SHORT_NAME');
+				}
+
+				if ($length > 10)
+				{
+					trigger_error('LONG_NAME');
+				}
+
+				require($site_file_root.'includes/functions_user.php');
+			
+				if ($error = validate_username($user_name))
+				{
+					trigger_error($error);
+				}
+			}
 		}
 
-		htmlentities($user_name, ENT_QUOTES, 'UTF-8');
+		$user_name = htmlentities($user_name, ENT_QUOTES, 'UTF-8');
 
 		$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 			'poster_name'	=> (string) $user_name,
@@ -230,44 +269,4 @@
 	
 script_close();
 
-function get_username()
-{
-
-	global $_CORE_CONFIG, $site_file_root;
-	
-	$user_name = trim(get_variable('user_name', 'POST', ''));
-
-	if (!$user_name)
-	{
-		if ($_CORE_CONFIG['quick_message']['anonymous_posting'] == '2')
-		{
-			return false;
-			
-		} else {
-		
-			trigger_error('NO_NAME');
-		}
-	}
-	
-	$length = mb_strlen($user_name);
-	
-	if ($length < 2)
-	{
-		trigger_error('SHORT_NAME');
-	}
-	
-	if ($length > 10)
-	{
-		trigger_error('LONG_NAME');
-	}
-	
-	require($site_file_root.'includes/forums/functions_user.php');
-
-	if ($error = validate_username($user_name))
-	{
-		trigger_error($error);
-	}
-	return $user_name;
-}
-
 ?>
\ No newline at end of file

Added: trunk/themes_admin/viperal_admin/images/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/images/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/images/index.html
===================================================================

Added: trunk/themes_admin/viperal_admin/images/modules/Forums/index.html
===================================================================

Added: trunk/themes_admin/viperal_admin/images/modules/Forums/index.php
===================================================================
--- trunk/themes_admin/viperal_admin/images/modules/Forums/index.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/themes_admin/viperal_admin/images/modules/Forums/index.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -0,0 +1,87 @@
+<?php
+$this->img = array(
+	'bbcode_bitfield' => '6913',
+    'btn_post' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_post.gif*27*97',
+    'btn_post_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_post_pm.gif*27*97',
+    'btn_reply' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_reply.gif*27*97',
+    'btn_reply_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_reply_pm.gif*20*90',
+    'btn_locked' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_locked.gif*27*97',
+    'btn_profile' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_profile.gif*20*72',
+    'btn_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_pm.gif*20*72',
+    'btn_delete' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_delete.gif*20*20',
+    'btn_info' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_info.gif*20*20',
+    'btn_quote' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_quote.gif*20*90',
+    'btn_search' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_search.gif*20*72',
+    'btn_edit' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_edit.gif*20*90',
+    'btn_report' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_report.gif*20*20',
+    'btn_email' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_email.gif*20*72',
+    'btn_www' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_www.gif*20*72',
+    'btn_icq' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_icq.gif*20*72',
+    'btn_aim' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_aim.gif*20*72',
+    'btn_yim' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_yim.gif*20*72',
+    'btn_msnm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_msnm.gif*20*72',
+    'btn_jabber' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_jabber.gif*20*72',
+    'btn_online' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_online.gif*20*72',
+    'btn_offline' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_offline.gif*20*72',
+    'btn_friend' => '',
+    'btn_foe' => '',
+    'icon_unapproved' => 'themes/viperal/template/modules/Forums/images/icon_unapproved.gif*18*19',
+    'icon_reported' => 'themes/viperal/template/modules/Forums/images/icon_reported.gif*18*19',
+    'icon_attach' => 'themes/viperal/template/modules/Forums/images/icon_attach.gif*18*14',
+    'icon_post' => 'themes/viperal/template/modules/Forums/images/icon_minipost.gif*9*12',
+    'icon_post_new' => 'themes/viperal/template/modules/Forums/images/icon_minipost_new.gif*9*12',
+    'icon_post_latest' => 'themes/viperal/template/modules/Forums/images/icon_latest_reply.gif*9*18',
+    'icon_post_newest' => 'themes/viperal/template/modules/Forums/images/icon_newest_reply.gif*9*18',
+    'forum' => 'themes/viperal/template/modules/Forums/images/folder_big.gif*25*46',
+    'forum_new' => 'themes/viperal/template/modules/Forums/images/folder_new_big.gif*25*46',
+    'forum_locked' => 'themes/viperal/template/modules/Forums/images/folder_locked_big.gif*25*46',
+    'forum_link' => 'themes/viperal/template/modules/Forums/images/folder_link_big.gif*25*46',
+    'sub_forum' => 'themes/viperal/template/modules/Forums/images/subfolder_big.gif*25*46',
+    'sub_forum_new' => 'themes/viperal/template/modules/Forums/images/subfolder_new_big.gif*25*46',
+    'folder' => 'themes/viperal/template/modules/Forums/images/folder.gif*18*19',
+    'folder_moved' => 'themes/viperal/template/modules/Forums/images/folder_moved.gif*18*19',
+    'folder_posted' => 'themes/viperal/template/modules/Forums/images/folder_posted.gif*18*19',
+    'folder_new' => 'themes/viperal/template/modules/Forums/images/folder_new.gif*18*19',
+    'folder_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_new_posted.gif*18*19',
+    'folder_hot' => 'themes/viperal/template/modules/Forums/images/folder_hot.gif*18*19',
+    'folder_hot_posted' => 'themes/viperal/template/modules/Forums/images/folder_hot_posted.gif*18*19',
+    'folder_hot_new' => 'themes/viperal/template/modules/Forums/images/folder_new_hot.gif*18*19',
+    'folder_hot_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif*18*19',
+    'folder_locked' => 'themes/viperal/template/modules/Forums/images/folder_lock.gif*18*19',
+    'folder_locked_posted' => 'themes/viperal/template/modules/Forums/images/folder_lock_posted.gif*18*19',
+    'folder_locked_new' => 'themes/viperal/template/modules/Forums/images/folder_lock_new.gif*18*19',
+    'folder_locked_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif*18*19',
+    'folder_sticky' => 'themes/viperal/template/modules/Forums/images/folder_sticky.gif*18*19',
+    'folder_sticky_posted' => 'themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif*18*19',
+    'folder_sticky_new' => 'themes/viperal/template/modules/Forums/images/folder_sticky_new.gif*18*19',
+    'folder_sticky_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif*18*19',
+    'folder_announce' => 'themes/viperal/template/modules/Forums/images/folder_announce.gif*18*19',
+    'folder_announce_posted' => 'themes/viperal/template/modules/Forums/images/folder_announce_posted.gif*18*19',
+    'folder_announce_new' => 'themes/viperal/template/modules/Forums/images/folder_announce_new.gif*18*19',
+    'folder_announce_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif*18*19',
+    'folder_global' => '',
+    'folder_global_posted' => '',
+    'folder_global_new' => '',
+    'folder_global_new_posted' => '',
+    'poll_left'		=> 'themes/viperal/template/modules/Forums/images/vote_lcap.gif*12*4',
+    'poll_center'	=> 'themes/viperal/template/modules/Forums/images/voting_bar.gif*12*4',
+    'poll_right'	=> 'themes/viperal/template/modules/Forums/images/vote_rcap.gif*12*4',
+    'attach_progress_bar' => 'themes/viperal/template/modules/Forums/images/progress_bar.gif*16*280',
+    'karma_left' => '',
+    'karma_center' => 'themes/viperal/template/modules/Forums/images/karma/karma{SUFFIX}.gif*6*69',
+    'karma_right' => '',
+    'pagination_sep' => ', ',
+    'image_register' => 'themes/viperal/template/modules/Forums/images/icon_mini_register.gif',
+    'user_icon1' => '',
+    'user_icon2' => '',
+    'user_icon3' => '',
+    'user_icon4' => '',
+    'user_icon5' => '',
+    'user_icon6' => '', 
+    'user_icon7' => '',
+    'user_icon8' => '',
+    'user_icon9' => '',
+    'user_icon10' => '',
+);
+
+?>
\ No newline at end of file

Added: trunk/themes_admin/viperal_admin/images/modules/index.html
===================================================================

Added: trunk/themes_admin/viperal_admin/index.html
===================================================================

Added: trunk/themes_admin/viperal_admin/index.php
===================================================================
--- trunk/themes_admin/viperal_admin/index.php	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/themes_admin/viperal_admin/index.php	2005-08-27 19:29:36 UTC (rev 92)
@@ -0,0 +1,73 @@
+<?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright 2004 - 2005										//
+//  By Ryan Marshall ( Viperal?	)								//
+//																//
+//  http://www.viperal.com										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+//class theme_display extends core_display
+class viperal_admin_theme
+{
+	function viperal_admin_theme()
+	{
+		global $_CLASS;
+
+		$this->table_open	= '<div class="OpenTable"><div class="outer"><div class="inner">';
+		$this->table_close	= '</div></div></div>';
+		
+		$_CLASS['core_template']->assign_array(array(
+			'A_TABLE_OPEN'	=> $this->table_open,
+			'A_TABLE_CLOSE'	=> $this->table_close,
+			'A_STYLESHEET'	=> '/themes_admin/viperal_admin/style/style.css',
+		));
+	}
+
+	function theme_header()
+	{
+		global $_CORE_CONFIG, $_CORE_MODULE, $_CLASS;
+
+		$_CLASS['core_template']->assign_array(array(
+			'THEME_MAININDEX'	=> generate_link(),
+			'THEME_SITENAME'	=> $_CORE_CONFIG['global']['site_name'],
+			'THEME_MARGINRIGHT'	=> $_CLASS['core_blocks']->check_side(BLOCK_RIGHT) ? '180px' : '0px',
+			'THEME_MARGINLEFT' 	=> $_CLASS['core_blocks']->check_side(BLOCK_LEFT) ? '180px' : '0px'
+		));
+
+		if ($_CLASS['core_display']->homepage)
+		{
+			$_CLASS['core_template']->assign('PAGE_TITLE', $_CLASS['core_user']->lang['HOME']);
+		}
+		else
+		{
+			$_CLASS['core_template']->assign('PAGE_TITLE', $_CLASS['core_user']->lang['HOME'].' &gt; '.(is_array($_CORE_MODULE['module_title']) ? implode(' &gt; ', $_CORE_MODULE['module_title']) : $_CORE_MODULE['module_title']));
+		}
+		
+		$_CLASS['core_blocks']->display(BLOCK_LEFT);
+	
+		$_CLASS['core_template']->display('header.html');
+	}
+
+	function theme_footer()
+	{
+		global $_CLASS;
+
+		$_CLASS['core_blocks']->display(BLOCK_RIGHT);
+
+		$_CLASS['core_template']->assign('THEME_FOOTER', $_CLASS['core_display']->footmsg());
+		
+		$_CLASS['core_template']->display('footer.html');
+	}
+}
+?>
\ No newline at end of file

Added: trunk/themes_admin/viperal_admin/template/blockleft.html
===================================================================
--- trunk/themes_admin/viperal_admin/template/blockleft.html	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/themes_admin/viperal_admin/template/blockleft.html	2005-08-27 19:29:36 UTC (rev 92)
@@ -0,0 +1,13 @@
+<!-- IF isset({ $block_left }) -->
+<div id="blocksleft">
+	<!-- LOOP $block_left -->
+	<div class="blocks">
+		<div class="top" onclick="switch_collapse('block_{ $block_left:id }');" style="cursor:pointer">&nbsp;{ $block_left:title }&nbsp;</div>
+			<div<!-- IF { $block_left:collapsed } --> style="display: none;"<!-- ENDIF --> class="content" id="block_{ $block_left:id }">
+			{ $block_left:content }
+			</div>
+		</div>
+	<br />
+	<!-- ENDLOOP $block_left-->
+</div>
+<!-- ENDIF -->
\ No newline at end of file

Added: trunk/themes_admin/viperal_admin/template/blockright.html
===================================================================
--- trunk/themes_admin/viperal_admin/template/blockright.html	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/themes_admin/viperal_admin/template/blockright.html	2005-08-27 19:29:36 UTC (rev 92)
@@ -0,0 +1,13 @@
+<!-- IF isset({ $block_right }) -->
+<div id="blocksright">
+	<!-- LOOP $block_right -->
+	<div class="blocks">
+		<div class="top" onclick="switch_collapse('block_{ $block_right:id }');" style="cursor:pointer">&nbsp;{ $block_right:title }&nbsp;</div>
+			<div<!-- IF { $block_right:collapsed } --> style="display: none;"<!-- ENDIF --> class="content" id="block_{ $block_right:id }">
+			{ $block_right:content }
+			</div>
+		</div>
+	<br />
+	<!-- ENDLOOP $block_right -->
+</div>
+<!-- ENDIF -->
\ No newline at end of file

Added: trunk/themes_admin/viperal_admin/template/footer.html
===================================================================
--- trunk/themes_admin/viperal_admin/template/footer.html	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/themes_admin/viperal_admin/template/footer.html	2005-08-27 19:29:36 UTC (rev 92)
@@ -0,0 +1,40 @@
+	<!-- IF isset({ $block_bottom }) -->
+		{section name=block_bottom_loop loop=$block_bottom}
+		<div class="centerblock">
+			<div class="title">{$block_bottom[block_bottom_loop].TITLE}</div>
+				<div class="OpenTable"><div class="outer">
+					<div class="inner">
+						<div class="blockcontent">{$block_bottom[block_bottom_loop].CONTENT}</div>
+					</div>
+				</div>
+			</div>
+		</div>
+			{/section}
+	<!-- ENDIF $block_bottom -->
+	
+	<!-- IF isset({ $message_block_bottom }) -->
+	<br/>
+		<div class="messageblock">
+		<!-- LOOP $message_block_bottom -->
+			<div class="title" onclick="blockswitch2('{ $message_block_bottom:ID }');" style="cursor:pointer">{ $message_block_bottom:TITLE }
+			<!-- IF { $message_block_bottom:EDIT_LINK } -->[ <!-- IF { $message_block_bottom:EXPIRES } -->{ $message_block_bottom:EXPIRES } | <!-- ENDIF -->
+			<a href="{ $message_block_bottom:EDIT_LINK }" >{ $message_block_bottom:L_EDIT }</a> ]<!-- ENDIF --></div>
+			<div class="content" { $message_block_bottom:HIDE } id="pe{ $message_block_bottom:ID }">{ $message_block_bottom:CONTENT }</div>
+		<br />
+		<!-- ENDLOOP $message_block_bottom -->
+	
+		</div>
+	<br />
+	<!-- ENDIF -->
+	</div>
+	</div>
+	
+	<!-- INCLUDE blockright.html -->
+
+	<div class="footer">
+		<br />
+		<div align="center" class="footmsg">{ $THEME_FOOTER }</div>
+	</div>
+
+	</body>
+</html>
\ No newline at end of file

Added: trunk/themes_admin/viperal_admin/template/header.html
===================================================================
--- trunk/themes_admin/viperal_admin/template/header.html	2005-08-25 16:35:30 UTC (rev 91)
+++ trunk/themes_admin/viperal_admin/template/header.html	2005-08-27 19:29:36 UTC (rev 92)
@@ -0,0 +1,71 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="{ $SITE_LANG }" lang="{ $SITE_LANG }">
+<head>
+<title>{ $SITE_TITLE }</title>
+<meta http-equiv="content-Type" content="text/html; charset={ $SITE_CHARSET }" />
+<meta name="author" content="{ $SITE_NAME }" /><meta http-equiv="expires" content="0" />
+<meta name="copyright" content="Copyright { $SITE_NAME } { $SITE_URL }" />
+<meta name="robots" content="noindex, nofollow" />
+<!-- <link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" /> -->
+<style type="text/css">@import "{ $A_STYLESHEET }";</style>
+
+{ $HEADER_REGULAR }
+{ $HEADER_JS }
+
+<script type="text/javascript" src="/javascript/collapse.js"></script>
+<script type="text/javascript" src="/javascript/menu.js"></script>
+
+<!--[if IE]>
+<style>
+	.bodymain
+	{
+		height:1500px;
+	}
+</style>
+<![endif]-->
+
+</head>
+
+<body>
+
+{ $HEADER_BODY }
+
+<a name="Top"></a>
+
+<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+	<tr>
+		<td nowrap="nowrap" class="row2"><a href="{ $LINK_HOME }">{ $L_SITE_INDEX }</a></td>
+		<td nowrap="nowrap" class="row2"><a href="{ $LINK_ADMIN }">{ $L_ADMIN_INDEX }</a></td>
+		{ $MENU_MAIN_ITEMS }
+		<td width="100%" class="row2"></td>
+	</tr>
+</table>
+
+{ $MENU_MAIN }
+
+<!-- include blockleft.html -->
+
+<div class="mainbody" style="margin-left: { $THEME_MARGINLEFT }">
+	<div id="page">
+		You are here: { $PAGE_TITLE }
+	</div>
+	
+	<div class="bodymain" style="margin-right: { $THEME_MARGINRIGHT }">
+	<!-- IF { $HEADER_MESSAGE }-->
+	<div style="color: #999; border-bottom:1px solid #ccc; padding:2px; background-color: #eee; text-align: center;">{ $HEADER_MESSAGE }</div>
+	<!-- ENDIF -->
+
+<!-- IF isset({ $block_center }) -->
+	<!-- LOOP $block_center -->
+	<div class="centerblock">
+		<div class="title">{ $block_center:TITLE }</div>
+			<div class="OpenTable"><div class="outer">
+				<div class="inner">
+					<div class="content">{ $block_center:CONTENT }</div>
+				</div>
+			</div>
+		</div>
+	</div>
+	<!-- ENDLOOP $block_center -->
+	<br />
+<!-- ENDIF -->
\ No newline at end of file



From viperal at berlios.de  Mon Aug 29 03:58:13 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Mon, 29 Aug 2005 03:58:13 +0200
Subject: [Viperals-svncheckins] r93 - in trunk: blocks includes includes/compatiblity includes/db install modules/Control_Panel/ucp modules/Members_List
Message-ID: <200508290158.j7T1wDBb002107@sheep.berlios.de>

Author: viperal
Date: 2005-08-29 03:58:04 +0200 (Mon, 29 Aug 2005)
New Revision: 93

Added:
   trunk/includes/compatiblity/
   trunk/includes/compatiblity/mbstring.php
   trunk/includes/db/mysql3.php
Modified:
   trunk/blocks/block-Control_Panel.php
   trunk/blocks/block-User.php
   trunk/includes/db/mysql.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/handler.php
   trunk/includes/session.php
   trunk/install/build_data.php
   trunk/install/installer.php
   trunk/modules/Control_Panel/ucp/ucp_groups.php
   trunk/modules/Control_Panel/ucp/ucp_profile.php
   trunk/modules/Control_Panel/ucp/ucp_register.php
   trunk/modules/Members_List/index.php
Log:


Modified: trunk/blocks/block-Control_Panel.php
===================================================================
--- trunk/blocks/block-Control_Panel.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/blocks/block-Control_Panel.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -1,23 +1,31 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
-if (!defined('VIPERAL')) {
-    Header('Location: ../');
-    die();
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
 }
 
-// Fix the PM compose add To problem, if fixable !
-// Clean up un-needed stuff
 global $_CLASS;
 
 if (!isset($_CLASS['core_template']->_vars['ucp_section']))
@@ -26,254 +34,6 @@
 	return;
 }
 
-$this->content .= '<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th>'.$_CLASS['core_user']->lang['OPTIONS'].'
-</th>
-	</tr>';
+$this->content = $_CLASS['core_template']->display('modules/Control_Panel/ucp_sideblock.html', true);
 
-$_CLASS['core_template']->_sections['ucp_sectionloop']['name'] = 'ucp_sectionloop';
-$_CLASS['core_template']->_sections['ucp_sectionloop']['loop'] = is_array($_loop=$_CLASS['core_template']->_vars['ucp_section']) ? count($_loop) : max(0, (int)$_loop); unset($_loop);
-$_CLASS['core_template']->_sections['ucp_sectionloop']['show'] = true;
-$_CLASS['core_template']->_sections['ucp_sectionloop']['max'] = $_CLASS['core_template']->_sections['ucp_sectionloop']['loop'];
-$_CLASS['core_template']->_sections['ucp_sectionloop']['step'] = 1;
-$_CLASS['core_template']->_sections['ucp_sectionloop']['start'] = $_CLASS['core_template']->_sections['ucp_sectionloop']['step'] > 0 ? 0 : $_CLASS['core_template']->_sections['ucp_sectionloop']['loop']-1;
-if ($_CLASS['core_template']->_sections['ucp_sectionloop']['show']) {
-    $_CLASS['core_template']->_sections['ucp_sectionloop']['total'] = $_CLASS['core_template']->_sections['ucp_sectionloop']['loop'];
-    if ($_CLASS['core_template']->_sections['ucp_sectionloop']['total'] == 0)
-        $_CLASS['core_template']->_sections['ucp_sectionloop']['show'] = false;
-} else
-    $_CLASS['core_template']->_sections['ucp_sectionloop']['total'] = 0;
-if ($_CLASS['core_template']->_sections['ucp_sectionloop']['show']):
-
-            for ($_CLASS['core_template']->_sections['ucp_sectionloop']['index'] = $_CLASS['core_template']->_sections['ucp_sectionloop']['start'], $_CLASS['core_template']->_sections['ucp_sectionloop']['iteration'] = 1;
-                 $_CLASS['core_template']->_sections['ucp_sectionloop']['iteration'] <= $_CLASS['core_template']->_sections['ucp_sectionloop']['total'];
-                 $_CLASS['core_template']->_sections['ucp_sectionloop']['index'] += $_CLASS['core_template']->_sections['ucp_sectionloop']['step'], $_CLASS['core_template']->_sections['ucp_sectionloop']['iteration']++):
-$_CLASS['core_template']->_sections['ucp_sectionloop']['rownum'] = $_CLASS['core_template']->_sections['ucp_sectionloop']['iteration'];
-$_CLASS['core_template']->_sections['ucp_sectionloop']['index_prev'] = $_CLASS['core_template']->_sections['ucp_sectionloop']['index'] - $_CLASS['core_template']->_sections['ucp_sectionloop']['step'];
-$_CLASS['core_template']->_sections['ucp_sectionloop']['index_next'] = $_CLASS['core_template']->_sections['ucp_sectionloop']['index'] + $_CLASS['core_template']->_sections['ucp_sectionloop']['step'];
-$_CLASS['core_template']->_sections['ucp_sectionloop']['first']      = ($_CLASS['core_template']->_sections['ucp_sectionloop']['iteration'] == 1);
-$_CLASS['core_template']->_sections['ucp_sectionloop']['last']       = ($_CLASS['core_template']->_sections['ucp_sectionloop']['iteration'] == $_CLASS['core_template']->_sections['ucp_sectionloop']['total']);
-
-$this->content .= '<tr>';
-
-if ($_CLASS['core_template']->_vars['ucp_section'][$_CLASS['core_template']->_sections['ucp_sectionloop']['index']]['S_SELECTED']):
-$this->content .= '<td class="row1"><b class="phpbbnav">'.$_CLASS['core_template']->_vars['ucp_section'][$_CLASS['core_template']->_sections['ucp_sectionloop']['index']]['L_TITLE'].'
-</b>
-
-			<ul class="phpbbnav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">';
-unset($_CLASS['core_template']->_sections['ucp_subsectionloop']);
-
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['name'] = 'ucp_subsectionloop';
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['loop'] = is_array($_loop=$_CLASS['core_template']->_vars['ucp_subsection']) ? count($_loop) : max(0, (int)$_loop); unset($_loop);
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['show'] = true;
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['max'] = $_CLASS['core_template']->_sections['ucp_subsectionloop']['loop'];
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['step'] = 1;
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['start'] = $_CLASS['core_template']->_sections['ucp_subsectionloop']['step'] > 0 ? 0 : $_CLASS['core_template']->_sections['ucp_subsectionloop']['loop']-1;
-if ($_CLASS['core_template']->_sections['ucp_subsectionloop']['show']) {
-    $_CLASS['core_template']->_sections['ucp_subsectionloop']['total'] = $_CLASS['core_template']->_sections['ucp_subsectionloop']['loop'];
-    if ($_CLASS['core_template']->_sections['ucp_subsectionloop']['total'] == 0)
-        $_CLASS['core_template']->_sections['ucp_subsectionloop']['show'] = false;
-} else
-    $_CLASS['core_template']->_sections['ucp_subsectionloop']['total'] = 0;
-if ($_CLASS['core_template']->_sections['ucp_subsectionloop']['show']):
-
-            for ($_CLASS['core_template']->_sections['ucp_subsectionloop']['index'] = $_CLASS['core_template']->_sections['ucp_subsectionloop']['start'], $_CLASS['core_template']->_sections['ucp_subsectionloop']['iteration'] = 1;
-                 $_CLASS['core_template']->_sections['ucp_subsectionloop']['iteration'] <= $_CLASS['core_template']->_sections['ucp_subsectionloop']['total'];
-                 $_CLASS['core_template']->_sections['ucp_subsectionloop']['index'] += $_CLASS['core_template']->_sections['ucp_subsectionloop']['step'], $_CLASS['core_template']->_sections['ucp_subsectionloop']['iteration']++):
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['rownum'] = $_CLASS['core_template']->_sections['ucp_subsectionloop']['iteration'];
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['index_prev'] = $_CLASS['core_template']->_sections['ucp_subsectionloop']['index'] - $_CLASS['core_template']->_sections['ucp_subsectionloop']['step'];
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['index_next'] = $_CLASS['core_template']->_sections['ucp_subsectionloop']['index'] + $_CLASS['core_template']->_sections['ucp_subsectionloop']['step'];
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['first']      = ($_CLASS['core_template']->_sections['ucp_subsectionloop']['iteration'] == 1);
-$_CLASS['core_template']->_sections['ucp_subsectionloop']['last']       = ($_CLASS['core_template']->_sections['ucp_subsectionloop']['iteration'] == $_CLASS['core_template']->_sections['ucp_subsectionloop']['total']);
-
-$this->content .= '<li>&#187;';
-if ($_CLASS['core_template']->_vars['ucp_subsection'][$_CLASS['core_template']->_sections['ucp_subsectionloop']['index']]['S_SELECTED']):
-
-$this->content .= ' <b>'.$_CLASS['core_template']->_vars['ucp_subsection'][$_CLASS['core_template']->_sections['ucp_subsectionloop']['index']]['L_TITLE'].'
-</b>';
-
-else: 
-
-$this->content .= '<a href="'.$_CLASS['core_template']->_vars['ucp_subsection'][$_CLASS['core_template']->_sections['ucp_subsectionloop']['index']]['U_TITLE'].'"> '.$_CLASS['core_template']->_vars['ucp_subsection'][$_CLASS['core_template']->_sections['ucp_subsectionloop']['index']]['L_TITLE'].'
-</a>';
-
-endif;
-
-$this->content .= '</li>';
-
-endfor;
-endif;
-			$this->content .= '</ul>';
-
-else:
-		
-$this->content .= '<td class="row2" nowrap="nowrap" onmouseover="this.className=\'row1\'" onmouseout="this.className=\'row2\'" onclick="location.href=\''.$_CLASS['core_template']->_vars['ucp_section'][$_CLASS['core_template']->_sections['ucp_sectionloop']['index']]['U_TITLE'].'\'"><a class="phpbbnav" href="'.$_CLASS['core_template']->_vars['ucp_section'][$_CLASS['core_template']->_sections['ucp_sectionloop']['index']]['U_TITLE'].'
-">'.$_CLASS['core_template']->_vars['ucp_section'][$_CLASS['core_template']->_sections['ucp_sectionloop']['index']]['L_TITLE'].'
-</a>';
-
-endif;
-		
-		$this->content .= '</td>
-	</tr>';
-endfor;
-endif;
-
-$this->content .= '</table>
-
-<div style="padding: 2px;"></div>';
-
-if ($_CLASS['core_template']->_vars['S_SHOW_COLOUR_LEGEND']):
-
-$this->content .= '<table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
-	<tr>
-		<th colspan="2">'.$_CLASS['core_user']->lang['MESSAGE_COLOURS'].'
-</th>
-	</tr>';
-	
-unset($_CLASS['core_template']->_sections['pm_colour_infoloop']);
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['name'] = 'pm_colour_infoloop';
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['loop'] = is_array($_loop=$_CLASS['core_template']->_vars['pm_colour_info']) ? count($_loop) : max(0, (int)$_loop); unset($_loop);
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['show'] = true;
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['max'] = $_CLASS['core_template']->_sections['pm_colour_infoloop']['loop'];
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['step'] = 1;
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['start'] = $_CLASS['core_template']->_sections['pm_colour_infoloop']['step'] > 0 ? 0 : $_CLASS['core_template']->_sections['pm_colour_infoloop']['loop']-1;
-if ($_CLASS['core_template']->_sections['pm_colour_infoloop']['show']) {
-    $_CLASS['core_template']->_sections['pm_colour_infoloop']['total'] = $_CLASS['core_template']->_sections['pm_colour_infoloop']['loop'];
-    if ($_CLASS['core_template']->_sections['pm_colour_infoloop']['total'] == 0)
-        $_CLASS['core_template']->_sections['pm_colour_infoloop']['show'] = false;
-} else
-    $_CLASS['core_template']->_sections['pm_colour_infoloop']['total'] = 0;
-if ($_CLASS['core_template']->_sections['pm_colour_infoloop']['show']):
-
-            for ($_CLASS['core_template']->_sections['pm_colour_infoloop']['index'] = $_CLASS['core_template']->_sections['pm_colour_infoloop']['start'], $_CLASS['core_template']->_sections['pm_colour_infoloop']['iteration'] = 1;
-                 $_CLASS['core_template']->_sections['pm_colour_infoloop']['iteration'] <= $_CLASS['core_template']->_sections['pm_colour_infoloop']['total'];
-                 $_CLASS['core_template']->_sections['pm_colour_infoloop']['index'] += $_CLASS['core_template']->_sections['pm_colour_infoloop']['step'], $_CLASS['core_template']->_sections['pm_colour_infoloop']['iteration']++):
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['rownum'] = $_CLASS['core_template']->_sections['pm_colour_infoloop']['iteration'];
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['index_prev'] = $_CLASS['core_template']->_sections['pm_colour_infoloop']['index'] - $_CLASS['core_template']->_sections['pm_colour_infoloop']['step'];
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['index_next'] = $_CLASS['core_template']->_sections['pm_colour_infoloop']['index'] + $_CLASS['core_template']->_sections['pm_colour_infoloop']['step'];
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['first']      = ($_CLASS['core_template']->_sections['pm_colour_infoloop']['iteration'] == 1);
-$_CLASS['core_template']->_sections['pm_colour_infoloop']['last']       = ($_CLASS['core_template']->_sections['pm_colour_infoloop']['iteration'] == $_CLASS['core_template']->_sections['pm_colour_infoloop']['total']);
-
-	$this->content .= '<tr>';
-	
-if (! $_CLASS['core_template']->_vars['pm_colour_info'][$_CLASS['core_template']->_sections['pm_colour_infoloop']['index']]['IMG']):
-
-			$this->content .= '<td class="row1 '.$_CLASS['core_template']->_vars['pm_colour_info'][$_CLASS['core_template']->_sections['pm_colour_infoloop']['index']]['CLASS'].'
-" width="5"><img src="images/spacer.gif" width="5" alt="'.$_CLASS['core_template']->_vars['pm_colour_info'][$_CLASS['core_template']->_sections['pm_colour_infoloop']['index']]['LANG'].'
-" border="0" /></td>';
-
-else:
-			
-	$this->content .= '<td class="row1" width="25" align="center">'. $_CLASS['core_template']->_vars['pm_colour_info'][$_CLASS['core_template']->_sections['pm_colour_infoloop']['index']]['IMG'].'
-</td>';
-
-endif;
-
-		$this->content .= '<td class="row1"><span class="genmed">'.$_CLASS['core_template']->_vars['pm_colour_info'][$_CLASS['core_template']->_sections['pm_colour_infoloop']['index']]['LANG'].'
-</span></td>
-	</tr>';
-	
-endfor;
-endif;
-
-$this->content .= '</table>
-
-<div style="padding: 2px;"></div>';
-endif;
-
-$this->content .= '<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th>'.$_CLASS['core_user']->lang['FRIENDS'].'
-</th>
-	</tr>
-	<tr>
-		<td class="row1" align="center">
-		
-			<b class="genmed" style="color:green">'.$_CLASS['core_user']->lang['FRIENDS_ONLINE'].'
-</b>
-
-			<ul class="phpbbnav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">';
-			
-unset($_CLASS['core_template']->_sections['friends_onlineloop']);
-$_CLASS['core_template']->_sections['friends_onlineloop']['name'] = 'friends_onlineloop';
-$_CLASS['core_template']->_sections['friends_onlineloop']['loop'] = is_array($_loop=$_CLASS['core_template']->_vars['friends_online']) ? count($_loop) : max(0, (int)$_loop); unset($_loop);
-$_CLASS['core_template']->_sections['friends_onlineloop']['show'] = true;
-$_CLASS['core_template']->_sections['friends_onlineloop']['max'] = $_CLASS['core_template']->_sections['friends_onlineloop']['loop'];
-$_CLASS['core_template']->_sections['friends_onlineloop']['step'] = 1;
-$_CLASS['core_template']->_sections['friends_onlineloop']['start'] = $_CLASS['core_template']->_sections['friends_onlineloop']['step'] > 0 ? 0 : $_CLASS['core_template']->_sections['friends_onlineloop']['loop']-1;
-if ($_CLASS['core_template']->_sections['friends_onlineloop']['show']) {
-    $_CLASS['core_template']->_sections['friends_onlineloop']['total'] = $_CLASS['core_template']->_sections['friends_onlineloop']['loop'];
-    if ($_CLASS['core_template']->_sections['friends_onlineloop']['total'] == 0)
-        $_CLASS['core_template']->_sections['friends_onlineloop']['show'] = false;
-} else
-    $_CLASS['core_template']->_sections['friends_onlineloop']['total'] = 0;
-if ($_CLASS['core_template']->_sections['friends_onlineloop']['show']):
-
-            for ($_CLASS['core_template']->_sections['friends_onlineloop']['index'] = $_CLASS['core_template']->_sections['friends_onlineloop']['start'], $_CLASS['core_template']->_sections['friends_onlineloop']['iteration'] = 1;
-                 $_CLASS['core_template']->_sections['friends_onlineloop']['iteration'] <= $_CLASS['core_template']->_sections['friends_onlineloop']['total'];
-                 $_CLASS['core_template']->_sections['friends_onlineloop']['index'] += $_CLASS['core_template']->_sections['friends_onlineloop']['step'], $_CLASS['core_template']->_sections['friends_onlineloop']['iteration']++):
-$_CLASS['core_template']->_sections['friends_onlineloop']['rownum'] = $_CLASS['core_template']->_sections['friends_onlineloop']['iteration'];
-$_CLASS['core_template']->_sections['friends_onlineloop']['index_prev'] = $_CLASS['core_template']->_sections['friends_onlineloop']['index'] - $_CLASS['core_template']->_sections['friends_onlineloop']['step'];
-$_CLASS['core_template']->_sections['friends_onlineloop']['index_next'] = $_CLASS['core_template']->_sections['friends_onlineloop']['index'] + $_CLASS['core_template']->_sections['friends_onlineloop']['step'];
-$_CLASS['core_template']->_sections['friends_onlineloop']['first']      = ($_CLASS['core_template']->_sections['friends_onlineloop']['iteration'] == 1);
-$_CLASS['core_template']->_sections['friends_onlineloop']['last']       = ($_CLASS['core_template']->_sections['friends_onlineloop']['iteration'] == $_CLASS['core_template']->_sections['friends_onlineloop']['total']);
-
-				$this->content .= '<li><a href="'.$_CLASS['core_template']->_vars['friends_online'][$_CLASS['core_template']->_sections['friends_onlineloop']['index']]['U_PROFILE'].'
-">'.$_CLASS['core_template']->_vars['friends_online'][$_CLASS['core_template']->_sections['friends_onlineloop']['index']]['USERNAME'].'
-</a></li>';
-
-endfor;
-else:
-			$this->content .= '<li>'.$_CLASS['core_user']->lang['NO_FRIENDS_ONLINE'].'
-</li>';
-			endif;
-			$this->content .= '</ul>
-
-			<hr />
-
-			<b class="genmed" style="color:red">'.$_CLASS['core_user']->lang['FRIENDS_OFFLINE'].'
-</b>
-
-			<ul class="phpbbnav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">';
-
-unset($_CLASS['core_template']->_sections['friends_offlineloop']);
-$_CLASS['core_template']->_sections['friends_offlineloop']['name'] = 'friends_offlineloop';
-$_CLASS['core_template']->_sections['friends_offlineloop']['loop'] = is_array($_loop=$_CLASS['core_template']->_vars['friends_offline']) ? count($_loop) : max(0, (int)$_loop); unset($_loop);
-$_CLASS['core_template']->_sections['friends_offlineloop']['show'] = true;
-$_CLASS['core_template']->_sections['friends_offlineloop']['max'] = $_CLASS['core_template']->_sections['friends_offlineloop']['loop'];
-$_CLASS['core_template']->_sections['friends_offlineloop']['step'] = 1;
-$_CLASS['core_template']->_sections['friends_offlineloop']['start'] = $_CLASS['core_template']->_sections['friends_offlineloop']['step'] > 0 ? 0 : $_CLASS['core_template']->_sections['friends_offlineloop']['loop']-1;
-if ($_CLASS['core_template']->_sections['friends_offlineloop']['show']) {
-    $_CLASS['core_template']->_sections['friends_offlineloop']['total'] = $_CLASS['core_template']->_sections['friends_offlineloop']['loop'];
-    if ($_CLASS['core_template']->_sections['friends_offlineloop']['total'] == 0)
-        $_CLASS['core_template']->_sections['friends_offlineloop']['show'] = false;
-} else
-    $_CLASS['core_template']->_sections['friends_offlineloop']['total'] = 0;
-if ($_CLASS['core_template']->_sections['friends_offlineloop']['show']):
-
-            for ($_CLASS['core_template']->_sections['friends_offlineloop']['index'] = $_CLASS['core_template']->_sections['friends_offlineloop']['start'], $_CLASS['core_template']->_sections['friends_offlineloop']['iteration'] = 1;
-                 $_CLASS['core_template']->_sections['friends_offlineloop']['iteration'] <= $_CLASS['core_template']->_sections['friends_offlineloop']['total'];
-                 $_CLASS['core_template']->_sections['friends_offlineloop']['index'] += $_CLASS['core_template']->_sections['friends_offlineloop']['step'], $_CLASS['core_template']->_sections['friends_offlineloop']['iteration']++):
-$_CLASS['core_template']->_sections['friends_offlineloop']['rownum'] = $_CLASS['core_template']->_sections['friends_offlineloop']['iteration'];
-$_CLASS['core_template']->_sections['friends_offlineloop']['index_prev'] = $_CLASS['core_template']->_sections['friends_offlineloop']['index'] - $_CLASS['core_template']->_sections['friends_offlineloop']['step'];
-$_CLASS['core_template']->_sections['friends_offlineloop']['index_next'] = $_CLASS['core_template']->_sections['friends_offlineloop']['index'] + $_CLASS['core_template']->_sections['friends_offlineloop']['step'];
-$_CLASS['core_template']->_sections['friends_offlineloop']['first']      = ($_CLASS['core_template']->_sections['friends_offlineloop']['iteration'] == 1);
-$_CLASS['core_template']->_sections['friends_offlineloop']['last']       = ($_CLASS['core_template']->_sections['friends_offlineloop']['iteration'] == $_CLASS['core_template']->_sections['friends_offlineloop']['total']);
-
-			$this->content .= '<li><a href="'.$_CLASS['core_template']->_vars['friends_offline'][$_CLASS['core_template']->_sections['friends_offlineloop']['index']]['U_PROFILE'].'
-">'.$_CLASS['core_template']->_vars['friends_offline'][$_CLASS['core_template']->_sections['friends_offlineloop']['index']]['USERNAME'].'
-</a>';
-
-
-			endfor; else:
-			$this->content .= '<li>'.$_CLASS['core_user']->lang['NO_FRIENDS_OFFLINE'].'
-</li>';
-			endif;
-			$this->content .= '</ul>
-
-		</td>
-	</tr>
-</table></form>';
-
 ?>
\ No newline at end of file

Modified: trunk/blocks/block-User.php
===================================================================
--- trunk/blocks/block-User.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/blocks/block-User.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -10,7 +10,7 @@
 //  of the GNU General Public License version 2					//
 //																//
 //**************************************************************//
-
+
 if (!defined('VIPERAL'))
 {
     die;
@@ -54,7 +54,7 @@
     '.$_CLASS['core_user']->lang['USERNAME'].'</td><td align="right"><input class="post" type="text" name="username" size="10" maxlength="25" /></td></tr><tr><td>
     '.$_CLASS['core_user']->lang['PASSWORD'].'</td><td align="right"><input class="post" type="password" name="password" size="10" maxlength="20" /></td></tr><tr><td>';
 
-    $this->content .= (($_CORE_CONFIG['user']['require_activation'] != USER_ACTIVATION_DISABLE) ? '(<a href="'.generate_link('Control_Panel&amp;mode=register').'">'.$_CLASS['core_user']->lang['REGISTER'].'</a>)' : '') . '</td>
+    $this->content .= (($_CORE_CONFIG['user']['activation'] != USER_ACTIVATION_DISABLE) ? '(<a href="'.generate_link('Control_Panel&amp;mode=register').'">'.$_CLASS['core_user']->lang['REGISTER'].'</a>)' : '') . '</td>
 		<td align="right">
 			<input type="hidden" name="redirect" value="'.htmlspecialchars($_CLASS['core_user']->url).'" />
 			<input class="button" type="submit" name="login" value="'.$_CLASS['core_user']->lang['LOGIN'].'" /><br/>
@@ -70,16 +70,16 @@
 }
 
 $who_where['guest'] = $who_where['user'] = $who_where['staff'] = false;
-$online['guest'] = $online['user'] = $online['hidden'] = $online['total'] = $prev_id = 0;
-$prev_ip =  array();
+$online['guest'] = $online['user'] = $online['hidden'] = $online['total'] = 0;
+$prev_ip = $prev_id = array();
 
 $session_users = session_users();
 
 foreach ($session_users as $row)
 {
-	if ($row['user_id'] != ANONYMOUS && $row['user_id'] != $prev_id)
+	if ($row['user_id'] != ANONYMOUS && !in_array($row['user_id'], $prev_ip))
   	{
-		if (!$_CLASS['core_user']->is_admin && (!$row['user_allow_viewonline'] || !$row['session_viewonline']))
+		if (!$_CLASS['core_user']->is_admin && (!$row['user_allow_viewonline'] || $row['session_hidden']))
 		{
 			$online['hidden']++;
 			continue;
@@ -94,8 +94,7 @@
 			$row['username'] = '<b style="color:#' . $row['user_colour'] . '">' . $row['username'] . '</b>';
 		}
 		
-		$prev_id = $row['user_id'];
-	
+		$prev_id[] = $row['user_id'];
 	}
 	elseif ($row['user_id'] == ANONYMOUS && !in_array($row['session_ip'], $prev_ip))
 	{
@@ -122,7 +121,7 @@
 	
 	if ($row['user_id'] != ANONYMOUS)
 	{
-		$link = (($row['user_type'] <> USER_IGNORE) ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>' : $row['username']).' &gt;';
+		$link = (($row['user_type'] & USER_BOT) ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>' : $row['username']).' &gt;';
 		$who_where['user'] .= $online['user'] .': '.$link.' <a href="'.$row['session_url'].'">'.$row['session_page'].'</a><br />';
 	}
 	else
@@ -131,7 +130,10 @@
 	}
 
 }
+
 unset($session_users);
+unset($prev_id);
+unset($prev_ip);
 
 $this->content .= '
 <hr /><table >
@@ -142,8 +144,8 @@
   </tr>
   <tr> 
 	<td align="center" valign="middle" rowspan="1"><img src="images/blocks/user/stats.gif" alt="statistics" border="0" /></td>
-	<td class="gensmall" align="left" width="100%">Members&nbsp;<b>'.$config['num_users'].'</b><br />Latest:&nbsp;<a href="' . generate_link('Members_List&amp;mode=viewprofile&amp;u='.$config['newest_user_id']) . '">'. $config['newest_username']. '</a>
-	<br />Post&nbsp;<b>'.$config['num_posts'].'</b><br /><hr />
+	<td class="gensmall" align="left" width="100%">Members&nbsp;<b>'.$_CORE_CONFIG['user']['total_users'].'</b><br />Latest:&nbsp;<a href="' . generate_link('Members_List&amp;mode=viewprofile&amp;u='.$_CORE_CONFIG['user']['newest_user_id']) . '">'. $_CORE_CONFIG['user']['newest_username']. '</a>
+	<br /><hr />
 	</td>
   </tr>
   <tr> 
@@ -176,94 +178,7 @@
 '.(($who_where['guest']) ? $who_where['guest'] : '<em><b>&nbsp;None Online</b></em>').'
 		
 	</td>
-  </tr>';
-  
-/*
-if ($_CLASS['core_user']->is_user)
-{
-	$logged_visible_friends_online = 0;
-	$logged_hidden_friends_online = 0;
-
-	// Now figure out how many friends are online and make a list of them
-	$sql = 'SELECT DISTINCT 
-				u.user_id, u.username, u.user_colour, u.user_allow_viewonline,
-					u.user_type,
-				MAX(s.session_time) as online_time, 
-				MIN(s.session_viewonline) AS viewonline 
-			FROM 
-				' . ZEBRA_TABLE . ' z 
-			INNER JOIN 
-				' . SESSIONS_TABLE . ' s 
-				ON s.session_user_id = z.zebra_id
-			INNER JOIN
-				' . USERS_TABLE . ' u 
-				ON s.session_user_id = u.user_id
-			WHERE 	z.user_id =  ' . $_CLASS['core_user']->data['user_id'] . ' 
-				AND z.friend = 1 
-			GROUP BY z.zebra_id';
-
-	$result = $_CLASS['core_db']->sql_query($sql);
-	$update_time = $config['load_online_time'] * 60;
-
-	while( $row = $_CLASS['core_db']->sql_fetchrow($result) )
-	{
-		// If online session time is too old then skip this user
-		if( time() - $update_time > $row['online_time'] )
-		{
-			continue;
-		}
-
-		if ($row['user_colour'])
-		{
-			$row['username'] = '<b style="color:#' . $row['user_colour'] . '">' . $row['username'] . '</b>';
-		}
-
-		if ($row['user_allow_viewonline'] && $row['viewonline'])
-		{
-			$friends_online_link = $row['username'];
-			$logged_visible_friends_online++;
-		}
-		else
-		{
-			$friends_online_link = $row['username'];
-			$friends_online_link = '<i>' . $row['username'] . '</i>';
-			$logged_hidden_friends_online++;
-		}
-
-		if (($row['user_allow_viewonline'] && $row['viewonline']) || $auth->acl_get('u_viewonline'))
-		{
-			// TODO: If friend has you on ignore list then don't add
-			$friends_online_link = "<a href=\"memberlist.$phpEx&amp;mode=viewprofile&amp;u=" . $row['user_id'] . '">' . $friends_online_link . '</a>';
-			$friends_online_userlist .= ($friends_online_userlist != '') ? ', ' . $friends_online_link : $friends_online_link;
-		}
-	}
-	$total_online_friends = $logged_visible_friends_online + $logged_hidden_friends_online;
-}
-If ($_CLASS['core_user']->data['user_id'] != ANONYMOUS)
-{
-  $this->content .= '
-  <tr> 
-	  <td class="gensmall" style="padding: 4px;" align="left" colspan="2">
-		<hr /><b>Friends Online</b>
-	  </td>
   </tr>
-  <tr>
-	<td align="center" valign="middle" rowspan="1"><img src="images/blocks/whosonline.gif" alt="who\'s Online" border="0" /></td>
-	<td class="gensmall" align="left">
-		'.$logged_visible_friends_online.'&nbsp;Friends
-		<br />
-		'.$logged_hidden_friends_online.'&nbsp;Hidden Friends 
-		<br />
-		<b>'.$total_online_friends.'</b>&nbsp;Total Friends 
-		<br />
-		<br />
-		[<a href="'.generate_link('Control_Panel&i=5').'">Manage List</a>]
-	</td>
-  </tr>';
-}*/
+</table>';
 
-$this->content .= '</table>';
-
-unset($prev_id);
-unset($prev_ip);
 ?>
\ No newline at end of file

Added: trunk/includes/compatiblity/mbstring.php
===================================================================
--- trunk/includes/compatiblity/mbstring.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/includes/compatiblity/mbstring.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -0,0 +1,87 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+/*
+	What's this, Multibyte support is not avalible,
+	next your going to say you can't use a database *
+*/
+
+if (!function_exists('mb_internal_encoding'))
+{
+	function mb_internal_encoding()
+	{
+	}
+}
+
+if (!function_exists('mb_http_output'))
+{
+	function mb_http_output()
+	{
+	}
+}
+
+if (!function_exists('mb_strlen'))
+{
+	function mb_strlen($string, $encoding = null)
+	{
+		return strlen($string);
+	}
+}
+
+if (!function_exists('mb_strpos'))
+{
+	function mb_strpos($haystack, $needle, $offset = false, $encoding = null)
+	{
+		if ($offset)
+		{
+			return strpos($haystack, $needle, $offset);
+		}
+
+		return strpos($haystack, $needle);
+	}
+}
+
+if (!function_exists('mb_substr'))
+{
+	function mb_substr($string, $start, $length = false, $encoding = null)
+	{
+		if ($length)
+		{
+			return substr($string, $start, $length);
+		}
+
+		return substr($string, $start);
+	}
+}
+
+if (!function_exists('mb_convert_case'))
+{
+	function mb_convert_case($string, $mode = null, $encoding = null)
+	{
+		// maybe add modes
+		return ucfirst(strtolower($string));
+	}
+}
+
+
+?>
\ No newline at end of file

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/includes/db/mysql.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -193,7 +193,7 @@
 		{
 			$this->_error($query, $backtrace);
 		}
-		elseif (strpos($query, 'SELECT') !== false)
+		elseif (strpos($query, 'SELECT') === 0)
 		{
 			$this->open_queries[(int) $this->last_result] = $this->last_result;
 		}
@@ -456,7 +456,7 @@
 // this is done even for none admins ( need to fix this )
 				if (empty($_CORE_CONFIG['server']['error_options']) || $_CORE_CONFIG['server']['error_options'] == ERROR_DEBUGGER)
 				{
-					if (strpos($this->last_query, 'SELECT') !== false)
+					if (strpos($this->last_query, 'SELECT') === 0)
 					{
 						if ($result = @mysql_query('EXPLAIN '.$this->last_query, $this->link_identifier))
 						{

Added: trunk/includes/db/mysql3.php
===================================================================
--- trunk/includes/db/mysql3.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/includes/db/mysql3.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -0,0 +1,612 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+class db_mysql
+{
+	var $link_identifier = false;
+	var $db_layer = 'mysql3';
+
+	var $last_result;
+	var $return_on_error;
+	var $in_transaction = false;
+
+	var $queries_time = 0;
+	var $num_queries = 0;
+
+	var	$query_list = array();
+	var $query_details = array();
+	var $open_queries = array();
+
+	var $_indexs = array();
+	var $_fields = array();
+	var $_table_name = false;
+
+	function connect($db)
+	{		
+		if ($db['port'])
+		{
+			$db['server'] .= ':' . $port;
+		}
+
+		if ($this->link_identifier)
+		{
+			$this->disconnect();
+		}
+
+		$this->link_identifier = ($db['persistent']) ? @mysql_pconnect($db['server'], $db['username'], $db['password']) : @mysql_connect($db['server'], $db['username'], $db['password']);
+
+		if ($this->link_identifier)
+		{
+			if (@mysql_select_db($db['database']))
+			{
+				return $this->link_identifier;
+			}
+
+			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
+		}
+		
+		if (!$error)
+		{
+			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
+		}
+
+		$this->disconnect();
+
+		trigger_error($error, E_USER_ERROR);
+	}
+
+	function disconnect()
+	{
+		if (!$this->link_identifier)
+		{
+			return;
+		}
+
+		@mysql_close($this->link_identifier);
+		$this->link_identifier = false;
+	}
+
+	function sql_return_on_error($fail = false)
+	{
+		$this->return_on_error = $fail;
+	}
+
+	function return_on_error($fail = false)
+	{
+		$this->return_on_error = $fail;
+	}
+
+	function transaction($option = 'start', $auto_rollback = true)
+	{
+		return true;
+	}
+
+	function query($query = false,  $backtrace = false)
+	{
+		if (!$query || !$this->link_identifier) 
+		{ 
+			return false; 
+		}
+
+		global $_CLASS, $site_file_root;
+			
+		$this->num_queries++;
+		$this->last_query = $query;
+
+		if (!$backtrace)
+		{
+			$debug_backtrace = debug_backtrace();
+			$backtrace = array();
+			// remove the root directorys
+			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
+			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+
+			$backtrace['line'] = $debug_backtrace[0]['line'];
+		}
+
+		$this->_debug('start', $backtrace);
+		$this->last_result = $this->sql_query($query);
+		$this->_debug('stop', $backtrace);
+
+		if ($this->last_result === false)
+		{
+			$this->_error($query, $backtrace);
+		}
+		elseif (strpos($query, 'SELECT') === 0)
+		{
+			$this->open_queries[(int) $this->last_result] = $this->last_result;
+		}
+
+		return $this->last_result;
+	}
+
+	function sql_query($query = false)
+	{
+		return mysql_query($query, $this->link_identifier);
+	}
+
+	function query_limit($query = false, $total = false, $offset = 0, $backtrace = false) 
+	{
+		if (!$query || !$total || !$this->link_identifier) 
+		{
+			// no need to check for query or link_id, it's checked in db::query()
+			return $this->query($query);
+		}
+
+		global $site_file_root;
+
+		$query .= ' LIMIT ' . (($offset) ? $offset . ', ' : '') . $total;
+
+		if (!$backtrace)
+		{
+			$debug_backtrace = debug_backtrace();
+			$backtrace = array();
+			// remove the root directorys
+			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
+			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+
+			$backtrace['line'] = $debug_backtrace[0]['line'];
+		}
+		
+		return $this->query($query, $backtrace);
+	}
+
+	/*
+		Boy do I like this but it phpBB's, may have to do something similar
+	*/
+	function sql_build_array($query, $assoc_ary = false)
+	{
+		if (!is_array($assoc_ary))
+		{
+			return false;
+		}
+
+		$fields = array();
+		$values = array();
+
+		if ($query == 'INSERT')
+		{
+			foreach ($assoc_ary as $key => $var)
+			{
+				$fields[] = $key;
+
+				if (is_null($var))
+				{
+					$values[] = 'NULL';
+				}
+				elseif (is_string($var))
+				{
+					$values[] = "'" . $this->escape($var) . "'";
+				}
+				else
+				{
+					$values[] = (is_bool($var)) ? intval($var) : $var;
+				}
+			}
+
+			$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
+		}
+		else if ($query == 'UPDATE' || $query == 'SELECT')
+		{
+			$values = array();
+			foreach ($assoc_ary as $key => $var)
+			{
+				if (is_null($var))
+				{
+					$values[] = "$key = NULL";
+				}
+				elseif (is_string($var))
+				{
+					$values[] = "$key = '" . $this->escape($var) . "'";
+				}
+				else
+				{
+					$values[] = (is_bool($var)) ? "$key = " . intval($var) : "$key = $var";
+				}
+			}
+			$query = implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+		}
+
+		return $query;
+	}
+
+	function num_rows($result = false)
+	{
+		if (!$result || !$this->link_identifier) 
+		{ 
+			return 0; 
+		}
+
+		return mysql_num_rows($result);
+	}
+
+	function affected_rows()
+	{
+		if (!$this->link_identifier)
+		{ 
+			return 0; 
+		}
+
+		$num = mysql_affected_rows($this->link_identifier);
+
+		return (!$num || $num == -1) ? 0 : $num;
+	}
+
+	function fetch_row_assoc($result = false)
+	{
+		global $_CLASS;
+
+		if (!$result || !$this->link_identifier)
+		{
+			return false;
+		}
+
+		return @mysql_fetch_assoc($result);
+	}
+
+	function fetch_row_num($result = false)
+	{
+		if (!$result || !$this->link_identifier)
+		{
+			return false;
+		}
+
+		return @mysql_fetch_row($result);
+	}
+
+	function fetch_row_both($result = false)
+	{
+		if (!$result || !$this->link_identifier)
+		{
+			return false;
+		}
+
+		return @mysql_fetch_array($result);
+	}
+	
+	function insert_id($table, $column)
+	{
+		return ($this->link_identifier) ? @mysql_insert_id($this->link_identifier) : false;
+	}
+
+	function free_result($result = false)
+	{
+		if (!$result || !isset($this->open_queries[(int) $result]) || !$this->link_identifier) 
+		{ 
+			return false; 
+		}
+
+		unset($this->open_queries[(int) $result]);
+
+		return @mysql_free_result($result);
+	}
+
+	function escape($text)
+	{
+		return mysql_escape_string($text);
+	}
+
+	function escape_array($value)
+	{
+		return preg_replace('#(.*?)#e', "\$this->escape('\\1')", $value);
+	}
+	
+	function optimize_tables($table = '')
+	{
+		global $_CORE_CONFIG;
+	
+		if ($table)
+		{
+			if (is_array($table))
+			{
+				$table = implode(',', $table);
+			}
+		}
+		else
+		{
+			$result = $this->query('SHOW TABLES');
+
+			while ($row = $this->fetch_row_num($result))
+			{
+				if ($table)
+				{
+					$table .= ', ' . $row[0];
+				}
+			}
+
+			$this->sql_freeresult($result);
+		}
+
+		if ($table)
+		{
+			$this->query('OPTIMIZE TABLE '. $table);
+		}
+	}
+
+	function version($return_dbname = false)
+	{
+		if (!$this->link_identifier)
+		{
+			return false;
+		}
+		
+		return (($return_dbname) ? 'MySQL ' : '').mysql_get_server_info($this->link_identifier);
+	}
+
+	function _error($sql = '', $backtrace)
+	{
+		if ($this->return_on_error)
+		{
+			return;
+		}
+
+		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br /></td></tr></table>';
+
+		if ($this->in_transaction)
+		{
+			$this->transaction('rollback');
+		}
+
+		trigger_error($message, E_USER_ERROR);
+		
+		script_close(false);
+	}
+
+	function _debug($mode, $backtrace)
+	{
+		global $_CLASS, $_CORE_CONFIG;
+		static $start_time;
+
+		if (!$this->link_identifier) 
+		{ 
+			return false; 
+		}
+
+		switch ($mode)
+		{
+			case 'start':
+// this is done even for none admins ( need to fix this )
+				if (empty($_CORE_CONFIG['server']['error_options']) || $_CORE_CONFIG['server']['error_options'] == ERROR_DEBUGGER)
+				{
+					if (strpos($this->last_query, 'SELECT') === 0)
+					{
+						if ($result = @mysql_query('EXPLAIN '.$this->last_query, $this->link_identifier))
+						{
+							while ($row = @mysql_fetch_assoc($result))
+							{
+								$this->query_details[$this->num_queries][] = $row;
+							}
+						}
+					}
+					else
+					{
+						$this->query_details[$this->num_queries][] = '';
+					}
+				}
+
+				$start_time = explode(' ', microtime());
+				$start_time = $start_time[0] + $start_time[1];
+			break;
+
+			case 'stop':
+				global $site_file_root;
+
+				$end_time = explode(' ', microtime());
+				$end_time = $end_time[0] + $end_time[1];
+				$this->queries_time += $end_time - $start_time;
+
+				if (empty($_CORE_CONFIG['server']['error_options']) || $_CORE_CONFIG['server']['error_options'] == ERROR_DEBUGGER)
+				{
+					if ($this->last_result !== false)
+					{
+						$affected = false;
+
+						if (preg_match('/^(UPDATE|DELETE|REPLACE)/', $this->last_query))
+						{
+							$affected = $this->affected_rows($this->last_result);
+						}
+						
+						$this->query_list[$this->num_queries] = array('query' => $this->last_query, 'file' => $backtrace['file'], 'line'=> $backtrace['line'], 'affected' => $affected, 'time' => ($end_time - $start_time));
+					}
+					else
+					{
+						$error = mysql_error();
+						$this->query_list[$this->num_queries] = array('query' => $this->last_query, 'file' => $backtrace['file'], 'line'=> $backtrace['line'], 'error'=> $error['code'], 'errorcode' => $error['message']);
+					}
+				}
+			break;
+		}
+	}
+
+	/*
+		Table creation
+	*/
+	function table_create($option, $name = false)
+	{
+		switch ($option)
+		{
+			case 'start':
+				$this->_table_name = $name;
+				$this->_fields = $this->_indexs = array();
+			break;
+
+			case 'commit':
+			case 'return':
+				if (!$this->_table_name)
+				{
+					return;
+				}
+
+				$fields = implode(", \n", $this->_fields);
+				if ($indexs = implode(", \n", $this->_indexs))
+				{
+					$fields .= ", \n";
+				}
+
+				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) TYPE=MyISAM;";
+
+				if ($option == 'return')
+				{
+					return $table;
+				}
+
+				$this->sql_query($table);
+
+			case 'cancel':
+				$this->_table_name = false;
+				$this->_fields = $this->_indexs = array();
+			break;
+		}
+	}
+
+	function add_table_field_int($name, $setting_sent)
+	{
+		if (!$setting_sent || !is_array($setting_sent))
+		{
+			global $site_file_root;
+			
+			$debug_backtrace = debug_backtrace();
+			$backtrace = array();
+			// remove the root directorys
+			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
+			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+
+			$backtrace['line'] = $debug_backtrace[0]['line'];
+			print_r($backtrace);echo '<br/>';
+		}
+		
+		$setting = array('default' => null, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
+		$setting = array_merge($setting, $setting_sent);
+
+		$length = max(strlen($setting['min']), strlen($setting['max']));
+
+		if ($setting['min'] >= 0 && $setting['max'] <= 255)
+		{
+			// TINYINT UNSIGNED ( 0 to 255 )
+			$this->_fields[$name] =  "`$name` TINYINT($length) UNSIGNED";
+		}
+		elseif ($setting['min'] >= -128 && $setting['max'] <= 128)
+		{
+			// TINYINT ( -128 to 127 )
+			$this->_fields[$name] =  "`$name` TINYINT($length) DEFAULT";
+		}
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 65535)
+		{
+			// SMALLINT UNSIGNED ( 0 to 65,535 )
+			$this->_fields[$name] =  "`$name` SMALLINT($length) UNSIGNED";
+		}
+		elseif ($setting['min'] >= -32768 && $setting['max'] <= 32767)
+		{
+			// SMALLINT ( -32,768 to 32,767 )
+			$this->_fields[$name] =  "`$name` SMALLINT($length)";
+		}
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 16777215)
+		{
+			// MEDIUMINT UNSIGNED ( 0 to 16,777,215 )
+			$this->_fields[$name] =  "`$name` MEDIUMINT($length) UNSIGNED";
+		}
+		elseif ($setting['min'] >= -8388608 && $setting['max'] <= 8388607)
+		{
+			// MEDIUMINT ( -8,388,608 to 8,388,607 )
+			$this->_fields[$name] =  "`$name` MEDIUMINT($length)";
+		}
+		elseif ($setting['min'] >= -2147483647 && $setting['max'] <= 2147483647)
+		{
+			// INT ( -2,147,483,647 to 2,147,483,647 )
+			$this->_fields[$name] =  "`$name` INT($length)";
+		}
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 4294967295) // we'll do this last
+		{
+			// INT UNSIGNED ( 0 to 4,294,967,295 )
+			$this->_fields[$name] =  "`$name` INT($length) UNSIGNED";
+		}
+
+		if ($setting['auto_increment'])
+		{
+			$this->_fields[$name] .= ' auto_increment';
+		}
+		else
+		{
+			$this->_fields[$name] .= ($setting['null']) ? " NULL" : " NOT NULL";
+			$this->_fields[$name] .= is_null($setting['default']) ? '' : " DEFAULT '".(int) $setting['default']."'";
+		}
+	}
+
+	function add_table_field_text($name, $characters = 60000, $null = false)
+	{
+		if ($characters <= 255)
+		{
+			// TINYTEXT 1 to 255 Characters
+			$this->_fields[$name] =  "`$name` TINYTEXT";
+		}
+		elseif ($characters <= 65535)
+		{
+			// TEXT 1 to 65535 Characters
+			$this->_fields[$name] =  "`$name` TEXT";
+		}
+		elseif ($characters <= 16777215)
+		{
+			// MEDIUMTEXT 1 to 16,777,215 Characters
+			$this->_fields[$name] =  "`$name` MEDIUMTEXT";
+		}
+		elseif ($characters <= 4294967295)
+		{
+			// LONGTEXT 1 to 4,294,967,295 Characters
+			$this->_fields[$name] =  "`$name` LONGTEXT";
+		}
+
+		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
+	}
+
+	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
+	{
+		$this->_fields[$name] = ($padded) ? "`$name` CHAR($characters)" :  "`$name` VARCHAR($characters)";
+		$this->_fields[$name] .= $null ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= is_null($default) ? '' : "DEFAULT '$default'";
+	}
+
+	function add_table_index($field, $type  = 'index', $index_name = false)
+	{
+		$index_name = ($index_name) ? $index_name : $field;
+		
+		/*if (empty($this->_fields[$field]))
+		{
+			return;
+		}*/
+		$field = is_array($field) ? implode('` , `', $field) : $field;
+
+		switch ($type)
+		{
+			case 'index':
+			case 'unique':
+				$this->_indexs[$index_name] = (($type == 'UNIQUE') ? 'UNIQUE ' : '') . "KEY `$index_name` (`$field`)";
+			break;
+
+			case 'primary':
+				$this->_indexs['primary'] = "PRIMARY KEY (`$field`)";
+			break;
+		}
+	}
+}
+
+?>
\ No newline at end of file

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/includes/functions.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -173,7 +173,7 @@
 function check_theme($theme)
 {
 	global $site_file_root;
-	
+
 	if (file_exists($site_file_root.'themes/'.$theme.'/index.php'))
 	{
 		return true;
@@ -217,7 +217,7 @@
 	script_close();
 }
 
-function encode_password($pure, $encoding = 'md5')
+function encode_password($pure, $encoding)
 {
 	switch ($encoding)
 	{
@@ -607,25 +607,24 @@
 // to keep or not to keep ?
 function session_users()
 {
-	global $_CLASS, $config;
+	global $_CLASS, $_CORE_CONFIG;
 	static $loaded = false;
 	
-	if ($loaded) 
+	if ($loaded)
 	{
 		return $loaded;
 	}
 
 	$loaded = array();
-	//	WHERE s.session_time >= ' . (time() - (intval($config['load_online_time']) * 60)) .'
 
 	$sql = 'SELECT s.*, u.username, u.user_id, u.user_type, u.user_allow_viewonline, u.user_colour
 				FROM ' . SESSIONS_TABLE . ' s, '.USERS_TABLE.' u
-					WHERE s.session_time >= ' . (time() - (21600)) .'
+					WHERE s.session_time >= ' . (gmtime() - (int) $_CORE_CONFIG['server']['session_length']) .'
 				AND u.user_id = s.session_user_id';
 	$result = $_CLASS['core_db']->query($sql);
-	
+
 	$update = false;
-	
+
 	while($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		// update current user info with current page and url as it is done at the end of script.
@@ -638,8 +637,9 @@
 		
 		$loaded[] = $row;
 	}
-	
+
 	$_CLASS['core_db']->free_result($result);
+
 	return $loaded;
 }
 

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/includes/functions_user.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -21,6 +21,86 @@
 $Id$
 */
 
+function avatar_gallery(&$current_folder, &$folders, &$error)
+{
+	global $config, $_CLASS, $_CORE_CONFIG;
+
+	$path = $config['avatar_gallery_path'];
+	$data = $folders = array();
+
+	if ($current_folder)
+	{
+		$path .= '/'.$current_folder;
+	}
+	
+	if (!file_exists($path) || !is_dir($path))
+	{
+		return $data;
+	}
+
+	$dir = @opendir($path);
+
+	$count = 0;
+
+	while ($file = readdir($dir))
+	{
+		if (preg_match('#\.(gif$|png$|jpg|jpeg)$#i', $file))
+		{	
+			$data[$count]['file'] = ($current_folder) ? $current_folder.'/'.$file : $file; 
+			$data[$count]['name'] = ucfirst(str_replace('_', ' ', preg_replace('#^(.*)\..*$#', '\1', $file)));
+
+			$count++;
+		}
+
+		if (!$current_folder)
+		{
+			if ($file{0} != '.' && is_dir("$path/$file"))
+			{
+				$folders[] = $file;
+			}
+		}
+	}
+	closedir($dir);
+	
+	if ($current_folder)
+	{
+		$dir = @opendir($config['avatar_gallery_path']);
+
+		while ($file = readdir($dir))
+		{
+			if ($file{0} != '.' && is_dir($config['avatar_gallery_path']."/$file"))
+			{	
+				$folders[] = $file;
+			}
+		}
+		closedir($dir);
+	}
+
+	if (!$current_folder && empty($data) && !empty($folders))
+	{
+		$current_folder = $folders[0];
+
+		$path = $config['avatar_gallery_path'].'/'.$current_folder;
+
+		$dir = @opendir($path);
+		while ($file = readdir($dir))
+		{
+			if (preg_match('#\.(gif$|png$|jpg|jpeg)$#i', $file))
+			{	
+				$data[$count]['file'] = $current_folder.'/'.$file; 
+				$data[$count]['name'] = ucfirst(str_replace('_', ' ', preg_replace('#^(.*)\..*$#', '\1', $file)));
+	
+				$count++;
+			}
+		}
+		closedir($dir);
+	}
+
+	ksort($data);
+
+	return $data;
+}
+
 function check_user_id(&$user_id, $bypass = false)
 {
 	// should we just return false, if this array map is different from the one sent
@@ -60,7 +140,7 @@
 	return $user_id;
 }
 
-function user_add($data)
+function user_add(&$data)
 {
 	global $_CLASS, $_CORE_CONFIG;
 
@@ -81,11 +161,11 @@
 	$sql = 'INSERT INTO ' . USERS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data);
 	$_CLASS['core_db']->query($sql);
 
-	$user_id = $_CLASS['core_db']->insert_id(USERS_TABLE, 'user_id');
+	$data['user_id'] = $_CLASS['core_db']->insert_id(USERS_TABLE, 'user_id');
 				
 	$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 		'group_id'		=> (int) $data['user_group'],
-		'member_user_id'=> (int) $user_id,
+		'user_id'		=> (int) $data['user_id'],
 		'member_status'	=> $data['user_status']
 	));
 	
@@ -98,13 +178,16 @@
 {
 	global $_CLASS, $_CORE_CONFIG;
 
-	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
-	if (empty($user_id))
+	if (check_user_id($user_id) == false)
 	{
 		return;
 	}
-// hook here -- maybe ?
+	
+	$_CLASS['core_db']->transaction();
+
+// hook here
 	$sql = 'UPDATE ' . USERS_TABLE . '
 		SET user_status = ' . STATUS_ACTIVE . '
 			WHERE user_id  IN (' . implode(', ', $user_id) . ')
@@ -114,8 +197,8 @@
 
 	$sql = 'UPDATE ' . USER_GROUP_TABLE . '
 		SET member_status = ' . STATUS_ACTIVE . '
-			WHERE user_id  IN (' . implode(', ', $user_id) . ')';
-			//AND group_id =' .; get default group/s then add update, also update all group where the status is disabled
+			WHERE user_id  IN (' . implode(', ', $user_id) . ') 
+			AND member_status = ' . STATUS_DISABLED;
 
 	$_CLASS['core_db']->query($sql);
 	
@@ -125,6 +208,8 @@
 
 		$_CLASS['core_cache']->destroy('core_config');
 	}
+
+	$_CLASS['core_db']->transaction('commit');
 }
 
 function user_activate_reminder($user_id)
@@ -144,6 +229,7 @@
 	}
 
 // hook here -- maybe ?
+	$_CLASS['core_db']->transaction();
 
 	// disabled the user first
 	$sql = 'UPDATE ' . USERS_TABLE . '
@@ -157,7 +243,7 @@
 // should also remove all pending groups
 	$sql = 'UPDATE ' . USER_GROUP_TABLE . '
 		SET member_status = ' . STATUS_DISABLED . '
-			WHERE user_id  IN (' . implode(', ', $user_id) . ')
+			WHERE user_id IN (' . implode(', ', $user_id) . ')
 			AND member_status = ' . STATUS_ACTIVE;
 	$_CLASS['core_db']->query($sql);
 
@@ -182,6 +268,8 @@
 		
 		$_CLASS['core_cache']->destroy('core_config');
 	}
+	
+	$_CLASS['core_db']->transaction('commit');
 }
 
 function user_delete($user_id, $quick = false)
@@ -345,7 +433,7 @@
 	}
 
 	$sql = 'SELECT user_id FROM ' . USERS_TABLE . ' 
-				WHERE group_id IN (' . implode(', ', $group_id) . ')
+				WHERE user_group IN (' . implode(', ', $group_id) . ')
 				AND user_id IN (' . implode(', ', $user_id) . ')';
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -368,7 +456,7 @@
 		$_CLASS['core_db']->free_result($result);
 
 		$sql = 'UPDATE FROM '. USERS_TABLE .' 
-					SET group_id = 4, user_rank = -1
+					SET user_group = 4, user_rank = -1
 					WHERE user_id IN (' . implode(', ', $group_id) . ')';
 		$result = $_CLASS['core_db']->query($sql);
 	}

Modified: trunk/includes/handler.php
===================================================================
--- trunk/includes/handler.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/includes/handler.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -147,6 +147,8 @@
 
 		if ($this->report != ERROR_NONE)
 		{
+			echo $error;
+
 			//damn windows
 			$errfile = str_replace('\\','/', $errfile);
 			// Remove the root paths, site files, along with document root
@@ -172,8 +174,6 @@
 
 			case E_USER_ERROR:
 
-				$_CLASS['core_user']->user_setup();
-
 				$code = false;
 
 				if (mb_strpos($error, ':')) // there shouldn't be a 0 position
@@ -200,11 +200,22 @@
 					}
 				}
 
-				$error = (!empty($_CLASS['core_user']->lang[$error])) ? $_CLASS['core_user']->lang[$error] : $error;
+				if (isset($_CLASS['core_user']))
+				{
+					$_CLASS['core_user']->user_setup();
+					$error = (!empty($_CLASS['core_user']->lang[$error])) ? $_CLASS['core_user']->lang[$error] : $error;
+				}
 
 				$_CLASS['core_template']->assign('MESSAGE_TEXT',  $error);
 
-				$_CLASS['core_display']->display(false, 'error.html');
+				if (isset($_CLASS['core_display']))
+				{
+					$_CLASS['core_display']->display(false, 'error.html');
+				}
+				
+				$_CLASS['core_template']->display('error.html');
+
+				script_close();
 			break;
 
 			case E_USER_NOTICE:
@@ -220,8 +231,15 @@
 				));
 
 				$this->error_setting = array('title', 'redirect');
-				
-				$_CLASS['core_display']->display($this->error_setting['title'], 'message.html');
+
+				if (isset($_CLASS['core_display']))
+				{
+					$_CLASS['core_display']->display($this->error_setting['title'], 'message.html');
+				}
+
+				$_CLASS['core_template']->display('message.html');
+
+				script_close();
 			break;
 		}
 	}

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/includes/session.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -218,20 +218,20 @@
 	function autologin_generate()
 	{
 		global $_CLASS;
-// make this useable outside sessions
-		$code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
 
+		$this->autologin_code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
+
 		$data_array = array(
 			'user_id'				=> (int) $this->data['user_id'],
-			'auto_login_code'		=> (string) $code,
-			'auto_login_browser'	=> $this->browser,
-			'auto_login_time'		=> $this->time,
+			'auto_login_code'		=> (string) $this->autologin_code,
+			'auto_login_browser'	=> (string) $this->browser,
+			'auto_login_time'		=> (int) $this->time,
 		);
-		
+
 		$_CLASS['core_db']->query('INSERT INTO ' . SESSIONS_AUTOLOGIN_TABLE . ' '.	$_CLASS['core_db']->sql_build_array('INSERT', $data_array));
-	
+
 		$this->set_cookie('ali', $this->data['user_id'], $this->time + 2592000);
-		$this->set_cookie('alc', $code, $this->time + 2592000);
+		$this->set_cookie('alc', $this->autologin_code, $this->time + 2592000);
 	}
 
 	function autologin_retrieve($user_id, $code)
@@ -316,9 +316,7 @@
 
 	function gc($time)
 	{
-// Add auto login cleaning
 // Move to cron		
-
 		global $_CORE_CONFIG, $_CLASS;
 
 /*
@@ -328,10 +326,11 @@
 			AND session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
 		$_CLASS['core_db']->query($sql);
 */
+		$_CLASS['core_db']->transaction();
 
 		$sql = 'UPDATE ' . USERS_TABLE. ' u, ' . SESSIONS_TABLE . ' s
 					SET u.user_last_visit = s.session_time
-					WHERE s.session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']) . '
+					WHERE s.session_time < ' . ($time - (int) $_CORE_CONFIG['server']['session_length']) . '
 						AND s.session_user_id <> ' . ANONYMOUS .'
 						AND u.user_id = s.session_user_id';
 		$_CLASS['core_db']->sql_query($sql);
@@ -341,10 +340,12 @@
 		$_CLASS['core_db']->query($sql);
 
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
-					WHERE session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
+					WHERE session_time < ' . ($time - (int) $_CORE_CONFIG['server']['session_length']);
 		$_CLASS['core_db']->query($sql);
 		
 		$_CLASS['core_db']->optimize_tables(SESSIONS_TABLE);
+		
+		$_CLASS['core_db']->transaction('commit');
 	}
 
 	function session_data_get($name, $default = false)

Modified: trunk/install/build_data.php
===================================================================
--- trunk/install/build_data.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/install/build_data.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -53,7 +53,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '[\w_\+\. \-\[\]]+', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '.*', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)");
@@ -69,6 +69,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '2', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'activation', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'password_encoding', 'md5', 0)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'path', '/', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)");

Modified: trunk/install/installer.php
===================================================================
--- trunk/install/installer.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/install/installer.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -21,4 +21,5 @@
 $Id$
 */
 
+// LOL, MADE YOU LOOK
 ?>
\ No newline at end of file

Modified: trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -48,7 +48,12 @@
 					die;
 				}
 			}
-//empty(array())
+			
+			if (empty($group_id))
+			{
+				die; //temp
+			}
+
 			require_once($site_file_root.'includes/functions_user.php');
 
 			switch ($_POST['mode'])
@@ -56,27 +61,38 @@
 				case 'resign':
 // need to get member status and add other group types ( pending members can resign from all )
 					$sql = 'SELECT group_id	FROM  ' . GROUPS_TABLE . '
-								WHERE group_type = ' . GROUP_SYSTEM .'
+								WHERE group_type IN (' . GROUP_SYSTEM .', '.GROUP_SPECIAL.')
 								AND group_id IN ('. implode(', ', $group_id) .')';
+								
+					$sql = 'SELECT m.member_status, g.group_id, g.group_type
+								FROM ' . USER_GROUP_TABLE . ' m, ' . GROUPS_TABLE . ' g 
+								WHERE m.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+								AND m.group_id IN ('. implode(', ', $group_id) .')';
+
 					$result = $_CLASS['core_db']->query($sql);
 
-					$special = array();
+					$unset = array();
+
 					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 					{
-						$special[] = $row['user_id'];
+						if ($row['group_type'] == GROUP_SYSTEM && $row['group_type'] == GROUP_SPECIAL && $row['member_status'] != STATUS_PENDING)
+						{
+							$unset[] = $row['user_id'];
+						}
 					}
 					$_CLASS['core_db']->free_result($result);
 
-					$group_id = array_diff($group_id, $special);
-					unset($special);
+					$group_id = array_diff($group_id, $unset);
+					unset($unset);
 
 					groups_user_remove($group_id, $_CLASS['core_user']->data['user_id']);
 				break;
 
 				case 'apply':
-// users can be added 2x here, check to see if they are in the group first
-					$sql = 'SELECT group_id, FROM ' . USER_GROUP_TABLE . '
-						WHERE  group_id IN ('. implode(', ', $group_id) .')';
+					$sql = 'SELECT group_id FROM ' . USER_GROUP_TABLE . '
+						WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+						AND group_id IN ('. implode(', ', $group_id) .')';
+	
 					$result = $_CLASS['core_db']->query($sql);
 
 					$unset = array();
@@ -87,27 +103,33 @@
 					}
 					$_CLASS['core_db']->free_result($result);
 
-					$sql = 'SELECT group_id, group_status, group_type FROM  ' . GROUPS_TABLE . '
-								WHERE group_id IN ('. implode(', ', $group_id) .')';
-					$result = $_CLASS['core_db']->query($sql);
+					$group_id = array_diff($group_id, $unset);
+					unset($unset);
 
-					$group_id = array();
-
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					if (!empty($group_id))
 					{
-						$status = ($row['group_type'] == GROUP_UNRESTRAINED) ? STATUS_ACTIVE : STATUS_PENDING;
-
-						if ($row['group_status'] == STATUS_ACTIVE)
+						$sql = 'SELECT group_id, group_status, group_type FROM  ' . GROUPS_TABLE . '
+									WHERE group_id IN ('. implode(', ', $group_id) .')';
+						$result = $_CLASS['core_db']->query($sql);
+	
+						$group_id = array();
+	
+						while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 						{
-							$group_id[$status][] = $row['group_id'];
+							$status = ($row['group_type'] == GROUP_UNRESTRAINED) ? STATUS_ACTIVE : STATUS_PENDING;
+	
+							if ($row['group_status'] == STATUS_ACTIVE)
+							{
+								$group_id[$status][] = $row['group_id'];
+							}
 						}
+						$_CLASS['core_db']->free_result($result);
+	
+						foreach ($group_id as $status => $ids)
+						{
+							groups_user_add($ids, $_CLASS['core_user']->data['user_id'], $status);
+						}
 					}
-					$_CLASS['core_db']->free_result($result);
-
-					foreach ($group_id as $status => $ids)
-					{
-						groups_user_add($ids, $_CLASS['core_user']->data['user_id'], $status);
-					}
 				break;		
 			}
 		}
@@ -121,7 +143,8 @@
 			ORDER BY g.group_type DESC, g.group_name';
 		$result = $_CLASS['core_db']->query($sql);
 
-		$group_id_ary = array();
+		$group_array = array();
+
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$row['group_status'] = STATUS_ACTIVE;
@@ -132,21 +155,21 @@
 				'GROUP_ID'			=> $row['group_id'],
 				'GROUP_NAME'		=> isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
 				'GROUP_DESC'		=> $row['group_description'],
-				'GROUP_RESIGN'		=> ($row['group_type'] != GROUP_SYSTEM || ($row['group_type'] == GROUP_SPECIAL && $row['member_status'] == STATUS_PENDING)),
+				'GROUP_RESIGN'		=> ($row['member_status'] == STATUS_PENDING || ($row['group_type'] != GROUP_SYSTEM && $row['group_type'] != GROUP_SPECIAL)),
 				'U_VIEW_GROUP'		=> generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']),
-				'S_GROUP_DEFAULT'	=> ($row['group_id'] == $_CLASS['core_user']->data['group_id']) ? true : false
+				'S_GROUP_DEFAULT'	=> ($row['group_id'] == $_CLASS['core_user']->data['user_group']) ? true : false
 			));
 
-			$group_id_ary[] = $row['group_id'];
+			$group_array[] = $row['group_id'];
 		}
 		$_CLASS['core_db']->free_result($result);
 
-		$sql_and = 'NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
+		$sql_and = 'AND group_type NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
 
 		$sql = 'SELECT group_id, group_name, group_description, group_type
 			FROM ' . GROUPS_TABLE . '
-			WHERE group_id NOT IN (' . implode(', ', $group_id_ary) . ')
-				AND group_status = '. STATUS_ACTIVE ."
+			WHERE group_id NOT IN (' . implode(', ', $group_array) . ')
+				AND group_status = '. STATUS_ACTIVE ." $sql_and
 			ORDER BY group_type DESC, group_name";
 		$result = $_CLASS['core_db']->query($sql);
 

Modified: trunk/modules/Control_Panel/ucp/ucp_profile.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -16,21 +16,11 @@
 	function ucp_profile($id, $mode)
 	{
 		global $config, $_CLASS, $site_file_root, $_CORE_CONFIG;
-		$_CLASS['core_template']->assign(array(
-			'S_PRIVMSGS'		=>  false,
-			'profile_fields'	=>  false)
-
-		);
 		
-		$s_hidden_fields = '';
-		
-		$_CLASS['core_user']->add_lang('posting','Forums');
+		$preview	= isset($_POST['preview']);
+		$submit		= isset($_POST['submit']);
 
-		$preview	= (!empty($_POST['preview'])) ? true : false;
-		$submit		= (!empty($_POST['submit'])) ? true : false;
-		$delete		= (!empty($_POST['delete'])) ? true : false;
 		$module_link	= generate_link("Control_Panel&amp;i=$id&amp;mode=$mode");
-		$bday_day = $bday_month = $bday_year = '';
 
 		$error = $data = array();
 		$s_hidden_fields = '';
@@ -72,7 +62,7 @@
 					extract($data);
 					unset($data);
 
-					if ($_CLASS['auth']->acl_get('u_chgpasswd') && $new_password && $password_confirm != $new_password)
+					if ($new_password && $password_confirm != $new_password)
 					{
 						$error[] = 'NEW_PASSWORD_ERROR';
 					}
@@ -92,7 +82,7 @@
 						$sql_ary = array(
 							//'username'			=> ($_CLASS['auth']->acl_get('u_chgname') && $_CORE_CONFIG['user']['allow_namechange']) ? $username : $_CLASS['core_user']->data['username'], 
 							'user_email'		=> ($_CLASS['auth']->acl_get('u_chgemail')) ? $email : $_CLASS['core_user']->data['user_email'], 
-							//'user_password'		=> ($_CLASS['auth']->acl_get('u_chgpasswd') && $new_password) ? md5($new_password) : $_CLASS['core_user']->data['user_password'], 
+							//'user_password'		=> ($new_password) ? md5($new_password) : $_CLASS['core_user']->data['user_password'], 
 							//'user_passchg'		=> time(), 
 						);
 
@@ -196,97 +186,92 @@
 					'S_FORCE_PASSWORD'	=> ($_CORE_CONFIG['user']['chg_passforce'] && $this->data['user_passchg'] < time() - $_CORE_CONFIG['user']['chg_passforce']) ? true : false, 
 					'S_CHANGE_USERNAME'	=> ($_CORE_CONFIG['user']['allow_namechange'] && $_CLASS['auth']->acl_get('u_chgname')) ? true : false, 
 					'S_CHANGE_EMAIL'	=> ($_CLASS['auth']->acl_get('u_chgemail')) ? true : false,
-					'S_CHANGE_PASSWORD'	=> ($_CLASS['auth']->acl_get('u_chgpasswd')) ? true : false)
-				);
+					'S_CHANGE_PASSWORD'	=> true
+				));
 				break;
 
 			case 'profile_info':
 
-				include($site_file_root.'includes/forums/message_parser.php');
-				// TODO: The posting file is included because $message_parser->decode_message() relies on decode_message() in the posting functions.
-				include($site_file_root.'includes/forums/functions_posting.php');
-				 
+				$error = array();
+				$this_year = gmdate('Y', time());
+				
 				if ($submit)
 				{
-					$var_ary = array(
-						'icq'			=> (string) '', 
-						'aim'			=> (string) '', 
-						'msn'			=> (string) '', 
-						'yim'			=> (string) '', 
-						'jabber'		=> (string) '', 
-						'website'		=> (string) '', 
-						'location'		=> (string) '',
-						'occupation'	=> (string) '',
-						'interests'		=> (string) '',
-						'bday_day'		=> 0,
-						'bday_month'	=> 0,
-						'bday_year'		=> 0,
-					);
+					$icq	= get_variable('icq', 'POST', null);
+					$aim	= get_variable('aim', 'POST', null);
+					$msn	= get_variable('msn', 'POST', null);
+					$yim	= get_variable('yim', 'POST', null);
+					$jabber = get_variable('jabber', 'POST', null);
+					//$google = get_variable('google', 'POST', null);
 
-					foreach ($var_ary as $var => $default)
+					$website	= get_variable('website', 'POST', null);
+					$location	= get_variable('location', 'POST', null);				
+					$occupation	= get_variable('occupation', 'POST', null);
+					$interests	= get_variable('interests', 'POST', null);
+
+					$bday_day	= get_variable('bday_day', 'POST', false);
+					$bday_month	= get_variable('bday_month', 'POST', false);
+					$bday_year	= get_variable('bday_year', 'POST', false);
+
+					if ($bday_day || $bday_month || $bday_year)
 					{
-						$data[$var] = request_var($var, $default);
+						if ($bday_day < 1 || $bday_day > 31 || $bday_month < 1 || $bday_month > 12 || $bday_year < ($this_year - 100) || $bday_month > $this_year)
+						{
+							$error[] = $_CLASS['core_user']->get_lang('BIRTHDAY_ERROR');
+						}
 					}
 
-					$var_ary = array(
-						'icq'			=> array(
-							array('string', true, 3, 15), 
-							array('match', true, '#^[0-9]+$#i')), 
-						'aim'			=> array('string', true, 5, 255), 
-						'msn'			=> array('string', true, 5, 255), 
-						'jabber'		=> array(
-							array('string', true, 5, 255), 
-							array('match', true, '#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}(/.*)?$#i')),
-						'yim'			=> array('string', true, 5, 255), 
-						'website'		=> array(
-							array('string', true, 12, 255), 
-							array('match', true, '#^http[s]?://(.*?\.)*?[a-z0-9\-]+\.[a-z]{2,4}#i')), 
-						'location'		=> array('string', true, 2, 255), 
-						'occupation'	=> array('string', true, 2, 500), 
-						'interests'		=> array('string', true, 2, 500), 
-						'bday_day'		=> array('num', true, 1, 31),
-						'bday_month'	=> array('num', true, 1, 12),
-						'bday_year'		=> array('num', true, 1901, gmdate('Y', time())),
-					);
+					if (mb_strlen($interests) > 255)
+					{
+						$error[] = $_CLASS['core_user']->get_lang('INTEREST_LONG_ERROR');
+					}
 
-					$error = validate_data($data, $var_ary);
-					extract($data);
-					unset($data);
-					
-					if (!sizeof($error))
+					if (mb_strlen($occupation) > 255)
 					{
+						$error[] = $_CLASS['core_user']->get_lang('OCCUPATION_LONG_ERROR');
+					}
+
+					if (empty($error))
+					{
 						$sql_ary = array(
 							'user_icq'		=> $icq,
 							'user_aim'		=> $aim,
 							'user_msnm'		=> $msn,
 							'user_yim'		=> $yim,
 							'user_jabber'	=> $jabber,
+							//'user_google'	=> $google,
 							'user_website'	=> $website,
 							'user_from'		=> $location,
 							'user_occ'		=> $occupation,
 							'user_interests'=> $interests,
-							'user_birthday'	=> sprintf('%2d-%2d-%4d', $bday_day, $bday_month, $bday_year),
+							'user_birthday'	=> ($bday_day) ? sprintf('%2d-%2d-%4d', $bday_day, $bday_month, $bday_year) : null,
 						);
-
+	
 						$sql = 'UPDATE ' . USERS_TABLE . ' 
 							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 						$_CLASS['core_db']->sql_query($sql);
-
+	
 						$_CLASS['core_display']->meta_refresh(3, $module_link);
 						$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.$module_link.'">', '</a>');
 						trigger_error($message);
 					}
-					// Replace "error" strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
 				}
 
-				if (!$bday_day && $_CLASS['core_user']->data['user_birthday'])
+				if (!isset($bday_day))
 				{
-					list($bday_day, $bday_month, $bday_year) = explode('-', $_CLASS['core_user']->data['user_birthday']);
+					if ($_CLASS['core_user']->data['user_birthday'])
+					{
+						list($bday_day, $bday_month, $bday_year) = explode('-', $_CLASS['core_user']->data['user_birthday']);
+					}
+					else
+					{
+						$bday_day = $bday_month = $bday_year = '';
+					}
 				}
 
 				$s_birthday_day_options = '<option value="0"' . ((!$bday_day) ? ' selected="selected"' : '') . '>--</option>';
+
 				for ($i = 1; $i < 32; $i++)
 				{
 					$selected = ($i == $bday_day) ? ' selected="selected"' : '';
@@ -301,44 +286,36 @@
 				}
 				$s_birthday_year_options = '';
 
-				$now = explode(':', gmdate('Y'));
-
 				$s_birthday_year_options = '<option value="0"' . ((!$bday_year) ? ' selected="selected"' : '') . '>--</option>';
-				$i = $now[0] - 100;
 
-				for ($i; $i < $now[0]; $i++)
+				$i = $this_year - 100;
+				for ($i; $i < $this_year; $i++)
 				{
 					$selected = ($i == $bday_year) ? ' selected="selected"' : '';
 					$s_birthday_year_options .= "<option value=\"$i\"$selected>$i</option>";
 				}
-				unset($now);
 
-				$_CLASS['core_template']->assign(array(
-					'ERROR'		=> (sizeof($error)) ? implode('<br />', $error) : '',
+				$_CLASS['core_template']->assign_array(array(
+					'ERROR'		=> empty($error) ? '' : implode('<br />', $error),
 
-					'ICQ'		=> (isset($icq)) ? $icq : $_CLASS['core_user']->data['user_icq'], 
-					'YIM'		=> (isset($yim)) ? $yim : $_CLASS['core_user']->data['user_yim'], 
-					'AIM'		=> (isset($aim)) ? $aim : $_CLASS['core_user']->data['user_aim'], 
-					'MSN'		=> (isset($msn)) ? $msn : $_CLASS['core_user']->data['user_msnm'], 
-					'JABBER'	=> (isset($jabber)) ? $jabber : $_CLASS['core_user']->data['user_jabber'], 
-					'WEBSITE'	=> (isset($website)) ? $website : $_CLASS['core_user']->data['user_website'], 
-					'LOCATION'	=> (isset($location)) ? $location : $_CLASS['core_user']->data['user_from'], 
-					'OCCUPATION'=> (isset($occupation)) ? $occupation : $_CLASS['core_user']->data['user_occ'], 
-					'INTERESTS'	=> (isset($interests)) ? $interests : $_CLASS['core_user']->data['user_interests'], 
+					'ICQ'		=> isset($icq) ? $icq : $_CLASS['core_user']->data['user_icq'], 
+					'YIM'		=> isset($yim) ? $yim : $_CLASS['core_user']->data['user_yim'], 
+					'AIM'		=> isset($aim) ? $aim : $_CLASS['core_user']->data['user_aim'], 
+					'MSN'		=> isset($msn) ? $msn : $_CLASS['core_user']->data['user_msnm'], 
+					//'GOOGLE'	=> isset($google) ? $google : $_CLASS['core_user']->data['user_google'], 
+					'JABBER'	=> isset($jabber) ? $jabber : $_CLASS['core_user']->data['user_jabber'], 
+					'WEBSITE'	=> isset($website) ? $website : $_CLASS['core_user']->data['user_website'], 
+					'LOCATION'	=> isset($location) ? $location : $_CLASS['core_user']->data['user_from'], 
+					'OCCUPATION'=> isset($occupation) ? $occupation : $_CLASS['core_user']->data['user_occ'], 
+					'INTERESTS'	=> isset($interests) ? $interests : $_CLASS['core_user']->data['user_interests'], 
 
 					'S_BIRTHDAY_DAY_OPTIONS'	=> $s_birthday_day_options, 
 					'S_BIRTHDAY_MONTH_OPTIONS'	=> $s_birthday_month_options, 
-					'S_BIRTHDAY_YEAR_OPTIONS'	=> $s_birthday_year_options,)
-				);
+					'S_BIRTHDAY_YEAR_OPTIONS'	=> $s_birthday_year_options,
+				));
 			break;
 
 			case 'signature':
-
-				if (!$_CLASS['auth']->acl_get('u_sig'))
-				{
-					trigger_error('NO_AUTH_SIGNATURE');
-				}
-				
 				require($site_file_root.'includes/forums/functions_posting.php');
 				
 				// Generate smiley listing
@@ -435,90 +412,78 @@
 
 			case 'avatar':
 
-				$display_gallery = (isset($_POST['display_gallery'])) ? true : false;
-				$category = request_var('category', '');
-				$delete = (isset($_POST['delete'])) ? true : false;
-				
-				$avatarselect = request_var('avatarselect', '');
-				$avatarselect = str_replace(array('../', '..\\', './', '.\\'), '', $avatarselect);
-				if ($avatarselect && ($avatarselect{0} == '/' || $avatarselect{0} == "\\"))
-				{
-					 $avatarselect = '';
-				}
-				
+				$display_gallery = isset($_POST['display_gallery']);
+				$folder = isset($_REQUEST['category']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_REQUEST['category']) : false;
+
+				$delete = isset($_POST['delete']);
+
 				// Can we upload? 
-				$can_upload = ($config['allow_avatar_upload'] && file_exists($config['avatar_path']) && is_writeable($config['avatar_path']) && $_CLASS['auth']->acl_get('u_chgavatar') && (@ini_get('file_uploads') || strtolower(@ini_get('file_uploads')) == 'on')) ? true : false;
+				$can_upload = (file_exists($config['avatar_path']) && is_writeable($config['avatar_path']) && @ini_get('file_uploads')) ? true : false;
 
 				if ($submit)
 				{
-					$var_ary = array(
-						'uploadurl'		=> (string) '', 
-						'remotelink'	=> (string) '', 
-						'width'			=> (string) '',
-						'height'		=> (string) '' 
-					);
+					$gallery_avatar = isset($_POST['avatarselect']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['avatarselect']) : false;
 
-					foreach ($var_ary as $var => $default)
+					if ($config['allow_avatar_local'] && $gallery_avatar)
 					{
-						$data[$var] = request_var($var, $default);
-					}
+						if (!file_exists($config['avatar_gallery_path'] . '/' . $gallery_avatar))
+						{
+							$error[] = 'BAD_AVATAR';
+						}
+						else
+						{
+							$type = AVATAR_GALLERY;
+							$filename = $gallery_avatar;
 
-					$var_ary = array(
-						'uploadurl'		=> array('string', true, 5, 255), 
-						'remotelink'	=> array('string', true, 5, 255), 
-						'width'			=> array('string', true, 1, 3), 
-						'height'		=> array('string', true, 1, 3), 
-					);
-
-					$error = validate_data($data, $var_ary);
-					
-					if (!sizeof($error))
+							list($width, $height) = getimagesize($config['avatar_gallery_path'] . '/' . $gallery_avatar);
+						}
+					}
+					else
 					{
-						$data['user_id'] = $_CLASS['core_user']->data['user_id'];
+						$data['uploadurl']	= get_variable('uploadurl', 'POST', false);
+						$data['remotelink']	= get_variable('remotelink', 'POST', '');
+						$data['width']		= get_variable('width', 'POST', '');
+						$data['height']		= get_variable('height', 'POST', '');
+						$data['user_id']	= $_CLASS['core_user']->data['user_id'];
 
+						require_once($site_file_root.'includes/forums/functions_user.php');
+
 						if ((!empty($_FILES['uploadfile']['name']) || $data['uploadurl']) && $can_upload)
 						{
 							list($type, $filename, $width, $height) = avatar_upload($data, $error);
 						}
-						else if ($data['remotelink'] && $_CLASS['auth']->acl_get('u_chgavatar') && $config['allow_avatar_remote'])
+						elseif ($data['remotelink'] && $config['allow_avatar_remote'])
 						{
 							list($type, $filename, $width, $height) = avatar_remote($data, $error);
 						}
-						else if ($avatarselect && $_CLASS['auth']->acl_get('u_chgavatar') && $config['allow_avatar_local'])
+						elseif ($delete)
 						{
-							$type = AVATAR_GALLERY;
-							$filename = $avatarselect;
-
-							list($width, $height) = getimagesize($config['avatar_gallery_path'] . '/' . $filename);
+							$type = $filename = $width = $height = '';
 						}
-						else if ($delete && $_CLASS['auth']->acl_get('u_chgavatar'))
+						else
 						{
-							$type = $filename = $width = $height = '';
+							$error[] = 'IM_LOST';
 						}
 					}
 
-					if (!sizeof($error))
+					if (empty($error))
 					{
-						// Do we actually have any data to update?
-						if (sizeof($data))
-						{
-							$sql_ary = array(
-								'user_avatar'			=> $filename, 
-								'user_avatar_type'		=> $type, 
-								'user_avatar_width'		=> $width, 
-								'user_avatar_height'	=> $height, 
-							);
+						$sql_ary = array(
+							'user_avatar'			=> $filename, 
+							'user_avatar_type'		=> $type, 
+							'user_avatar_width'		=> $width, 
+							'user_avatar_height'	=> $height, 
+						);
 
-							$sql = 'UPDATE ' . USERS_TABLE . ' 
-								SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . ' 
-								WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-							$_CLASS['core_db']->sql_query($sql);
+						$sql = 'UPDATE ' . USERS_TABLE . ' 
+							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . ' 
+							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
+						$_CLASS['core_db']->sql_query($sql);
 
-							// Delete old avatar if present
-							if ($_CLASS['core_user']->data['user_avatar'] && $filename != $_CLASS['core_user']->data['user_avatar'] && $_CLASS['core_user']->data['user_avatar_type'] != AVATAR_GALLERY)
-							{
-								avatar_delete($_CLASS['core_user']->data['user_avatar']);
-							}
+						// Delete old avatar if present
+						if ($_CLASS['core_user']->data['user_avatar'] && $filename != $_CLASS['core_user']->data['user_avatar'] && $_CLASS['core_user']->data['user_avatar_type'] != AVATAR_GALLERY)
+						{
+							avatar_delete($_CLASS['core_user']->data['user_avatar']);
 						}
 
 						$_CLASS['core_display']->meta_refresh(3, $module_link);
@@ -526,15 +491,12 @@
 						trigger_error($message);
 					}
 
-					extract($data);
-					unset($data);
-
-					// Replace "error" strings with their real, localised form
 					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
 				}
 
 				// Generate users avatar
 				$avatar_img = '';
+
 				if ($_CLASS['core_user']->data['user_avatar'])
 				{
 					switch ($_CLASS['core_user']->data['user_avatar_type'])
@@ -552,7 +514,7 @@
 				}
 
 				$_CLASS['core_template']->assign(array(
-					'ERROR'			=> (sizeof($error)) ? implode('<br />', $error) : '', 
+					'ERROR'			=> empty($error) ? '' : implode('<br />', $error), 
 					'AVATAR'		=> $avatar_img, 
 					'AVATAR_SIZE'	=> $config['avatar_filesize'], 
 
@@ -561,16 +523,19 @@
 					'L_AVATAR_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)),)
 				);
 
-// Needs some work
-				if ($display_gallery && $_CLASS['auth']->acl_get('u_chgavatar') && $config['allow_avatar_local'])
+				if ($display_gallery && $config['allow_avatar_local'])
 				{
-					$avatar_list = avatar_gallery($category, $error);
-					$category = (!$category) ? key($avatar_list) : $category;
+					require_once($site_file_root.'includes/functions_user.php');
 
+					$avatar_list = avatar_gallery($folder, $folders, $error);
+
+					array_unshift($folders, '');
+
 					$s_category_options = '';
-					foreach (array_keys($avatar_list) as $cat)
+
+					foreach ($folders as $cat)
 					{
-						$s_category_options .= '<option value="' . $cat . '"' . (($cat == $category) ? ' selected="selected"' : '') . '>' . $cat . '</option>';
+						$s_category_options .= '<option value="' . $cat . '"' . (($cat == $folder) ? ' selected="selected"' : '') . '>' . (($cat) ? $cat : '--') . '</option>';
 					}
 
 					$_CLASS['core_template']->assign(array(
@@ -578,41 +543,35 @@
 						'S_CAT_OPTIONS'		=> $s_category_options)
 					);
 
-					$avatar_list = $avatar_list[$category];
-
 					foreach ($avatar_list as $avatar)
 					{
-
 						$_CLASS['core_template']->assign_vars_array('avatar',  array(
-								'AVATAR_IMAGE'		=> $config['avatar_gallery_path'] . '/' . $avatar['file'],
-								'AVATAR_NAME'		=> $avatar['name'],
-								'AVATAR_FILE'		=> $avatar['file'],
-								'S_OPTIONS_AVATAR'	=> $avatar['file']
-							));
+							'AVATAR_IMAGE'		=> $config['avatar_gallery_path'] . '/' . $avatar['file'],
+							'AVATAR_NAME'		=> $avatar['name'],
+							'AVATAR_FILE'		=> $avatar['file'],
+						));
 					}
-					unset($avatar_list);			
+					unset($avatar_list);
 				}
 				else
 				{
 					$_CLASS['core_template']->assign(array(
 						'AVATAR'		=> $avatar_img,
 						'AVATAR_SIZE'	=> $config['avatar_filesize'],
-						'WIDTH'			=> (isset($width)) ? $width : $_CLASS['core_user']->data['user_avatar_width'],
-						'HEIGHT'		=> (isset($height)) ? $height : $_CLASS['core_user']->data['user_avatar_height'],
+						'WIDTH'			=> $_CLASS['core_user']->data['user_avatar_width'],
+						'HEIGHT'		=> $_CLASS['core_user']->data['user_avatar_height'],
 
-						'S_UPLOAD_AVATAR_FILE'	=> $can_upload,
-						'S_UPLOAD_AVATAR_URL'	=> $can_upload,
-						'S_LINK_AVATAR'			=> ($_CLASS['auth']->acl_get('u_chgavatar') && $config['allow_avatar_remote']) ? true : false,
-						'S_GALLERY_AVATAR'		=> ($_CLASS['auth']->acl_get('u_chgavatar') && $config['allow_avatar_local']) ? true : false,
+						'S_CAN_UPLOAD'		=> $can_upload,
+						'S_LINK_AVATAR'		=> ($config['allow_avatar_remote']),
+						'S_GALLERY_AVATAR'	=> ($config['allow_avatar_local']),
 					));
 				}
 
 				break;
 		}
 
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'L_TITLE'					=> $_CLASS['core_user']->lang['UCP_PROFILE_' . strtoupper($mode)],
-			
 			'S_HIDDEN_FIELDS'			=> $s_hidden_fields,
 			'S_UCP_ACTION'				=> $module_link)
 		);

Modified: trunk/modules/Control_Panel/ucp/ucp_register.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -30,8 +30,8 @@
 		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
 		$submit		= isset($_POST['submit']);
 
-		if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_DISABLE
-			|| ($coppa || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
+		if ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_DISABLE
+			|| ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 			&& !$_CORE_CONFIG['email']['email_enable'])
 		{
 			trigger_error('UCP_REGISTER_DISABLE');
@@ -147,15 +147,15 @@
 				if (!$password)
 				{
 					//do some admin contact thing here
-					die('Try again later');
+					die('Activation disabled: Passwaord encoding problem');
 				}
 	
-				if ($coppa || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
+				if ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 				{
 					if (!$_CORE_CONFIG['email']['email_enable'])
 					{
 						//do some admin contact thing here
-						die('Try again later');
+						die('Activation disabled: Email Disabled');
 					}
 
 					$user_status = STATUS_PENDING;
@@ -166,12 +166,12 @@
 						$message = $_CLASS['core_user']->lang['ACCOUNT_COPPA'];
 						$email_template = 'coppa_welcome_inactive';
 					}
-					elseif ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF)
+					elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF)
 					{
 						$message = $_CLASS['core_user']->lang['ACCOUNT_INACTIVE'];
 						$email_template = 'user_welcome_inactive';
 					}
-					elseif ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
+					elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 					{
 						$message = $_CLASS['core_user']->lang['ACCOUNT_INACTIVE_ADMIN'];
 						$email_template = 'admin_welcome_inactive';
@@ -186,34 +186,33 @@
 					$message = $_CLASS['core_user']->lang['ACCOUNT_ADDED'];
 				}
 	
-				if ($user_status === STATUS_ACTIVE)
-				{
-					set_core_config('user', 'newest_user_id', $row['user_id'], false);
-					set_core_config('user', 'newest_username', $row['username'], false);
-					set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + 1, false);
-				}
-
 				$data = array(
-					'username'		=> $username,
-					'user_email'	=> $email,
+					'username'		=> (string) $username,
+					'user_email'	=> (string) $email,
 // add an option so admin can set with group they added to
 					'user_group'	=> ($coppa) ? 3 : 2,
-					'user_reg_date'	=> gmtime(),
-					'user_timezone'	=> $tz,
+					'user_reg_date'	=> (int) $_CLASS['core_user']->time,
+					'user_timezone'	=> (string) $tz,
 
-					'user_password'			=> $password,
-					'user_password_encoding'=> $_CORE_CONFIG['user']['password_encoding'],
+					'user_password'			=> (string) $password,
+					'user_password_encoding'=> (string) $_CORE_CONFIG['user']['password_encoding'],
 
-					'user_lang'			=> ($lang == $_CORE_CONFIG['global']['default_lang']) ? null : $lang,
+					'user_lang'			=> ($lang) ? (string) $lang : null,
 					'user_type'			=> USER_NORMAL,
-					'user_status'		=> $user_status,
-					'user_act_key'		=> $user_act_key,
-					'user_ip'			=> $_CLASS['core_user']->ip,
+					'user_status'		=> (int) $user_status,
+					'user_act_key'		=> (string) $user_act_key,
+					'user_ip'			=> (string) $_CLASS['core_user']->ip,
 				);
 
 				user_add($data);
-				unset($data);
 
+				if ($data['user_status'] === STATUS_ACTIVE)
+				{
+					set_core_config('user', 'newest_user_id', $data['user_id'], false);
+					set_core_config('user', 'newest_username', $data['username'], false);
+					set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + 1, false);
+				}
+
 				require_once($site_file_root.'includes/mailer.php');
 		
 				$mailer = new core_mailer();
@@ -221,14 +220,13 @@
 				$mailer->to($email, $username);
 				$mailer->subject($subject);
 
-				// change this don't want to use phpBBs template
 				$_CLASS['core_template']->assign_array(array(
 					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
 					'WELCOME_MSG'   => sprintf($_CLASS['core_user']->lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
 					'USERNAME'		=> $username,
 					'PASSWORD'		=> $password,
 					'EMAIL_SIG'		=> '', //I like this
-					'U_ACTIVATE'	=> generate_link("system&amp;mode=activate&user_id=$user_id&key=$user_act_key", array('sid' => false, 'full' => true))
+					'U_ACTIVATE'	=> generate_link('system&amp;mode=activate&user_id='.$data['user_id'].'&key='.$user_act_key, array('sid' => false, 'full' => true))
 				));
 
 				if ($coppa)
@@ -237,8 +235,8 @@
 						'FAX_INFO'		=> $_CORE_CONFIG['user']['coppa_fax'],
 						'MAIL_INFO'		=> $_CORE_CONFIG['user']['coppa_mail'],
 						'EMAIL_ADDRESS' => $email,
-						'SITENAME'		=> $_CORE_CONFIG['global']['site_name'])
-					);
+						'SITENAME'		=> $_CORE_CONFIG['global']['site_name']
+					));
 				}
 
 				$mailer->message = trim($_CLASS['core_template']->display('modules/Control_Panel/email/'.$email_template, true));
@@ -278,7 +276,7 @@
 			}
 		}
 
-		switch ($_CORE_CONFIG['user']['require_activation'])
+		switch ($_CORE_CONFIG['user']['activation'])
 		{
 			case USER_ACTIVATION_SELF:
 				$l_reg_cond = $_CLASS['core_user']->lang['UCP_EMAIL_ACTIVATE'];

Modified: trunk/modules/Members_List/index.php
===================================================================
--- trunk/modules/Members_List/index.php	2005-08-27 19:29:36 UTC (rev 92)
+++ trunk/modules/Members_List/index.php	2005-08-29 01:58:04 UTC (rev 93)
@@ -291,7 +291,10 @@
 		}
 
 		// We left join on the session table to see if the user is currently online
-		$sql = 'SELECT username, user_id, user_type, user_status, group_id, user_colour, user_permissions, user_sig, user_sig_bbcode_uid, user_sig_bbcode_bitfield, user_allow_viewemail, user_posts, user_regdate, user_rank, user_from, user_occ, user_interests, user_website, user_email, user_icq, user_aim, user_yim, user_msnm, user_jabber, user_avatar, user_avatar_width, user_avatar_height, user_avatar_type, user_last_visit
+		$sql = 'SELECT username, user_id, user_type, user_status, user_group, user_colour, user_permissions, user_sig,
+			user_sig_bbcode_uid, user_sig_bbcode_bitfield, user_allow_viewemail, user_posts, user_reg_date, user_rank,
+			user_from, user_occ, user_interests, user_website, user_email, user_icq, user_aim, user_yim, user_msnm,
+			user_jabber, user_avatar, user_avatar_width, user_avatar_height, user_avatar_type, user_last_visit
 			FROM ' . USERS_TABLE . "
 			WHERE user_id = $user_id
 				AND user_type = " . USER_NORMAL;
@@ -308,7 +311,7 @@
 		$sql = 'SELECT g.group_id, g.group_name, g.group_type
 			FROM ' . USER_GROUP_TABLE . ' ug, ' . GROUPS_TABLE . " g
 			WHERE ug.user_id = $user_id
-				AND g.group_id = ug.group_id" . ((!$_CLASS['auth']->acl_gets('a_group')) ? ' AND group_type <> ' . GROUP_HIDDEN : '') . '
+				AND g.group_id = ug.group_id AND group_type <> " . GROUP_HIDDEN. '
 			ORDER BY group_type, group_name';
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -316,7 +319,7 @@
 		
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$group_options .= '<option value="' . $row['group_id'] . '"'.(($member['group_id'] == $row['group_id'])? ' selected="selected"' : '').'>' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+			$group_options .= '<option value="' . $row['group_id'] . '"'.(($member['user_group'] == $row['group_id'])? ' selected="selected"' : '').'>' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
 		}
 		$_CLASS['core_db']->free_result($result);
 		
@@ -411,7 +414,7 @@
 		}
 
 		// Do the relevant calculations
-		$memberdays = max(1, round((time() - $member['user_regdate']) / 86400));
+		$memberdays = max(1, round((time() - $member['user_reg_date']) / 86400));
 		$posts_per_day = $member['user_posts'] / $memberdays;
 		$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
 
@@ -478,8 +481,8 @@
 			'ACTIVE_TOPIC_PCT'	=> sprintf($_CLASS['core_user']->lang['POST_PCT'], $active_t_pct),
 
 			'LOCATION'		=> (!empty($member['user_from'])) ? censor_text($member['user_from']) : '',
-			'OCCUPATION'    => (!empty($member['user_occ'])) ? censor_text($member['user_occ']) : '',
-			'INTERESTS'		=> (!empty($member['user_interests'])) ? censor_text($member['user_interests']) : '',
+			'OCCUPATION'    => (!empty($member['user_occ'])) ? str_replace("\n", '<br />', censor_text($member['user_occ'])) : '',
+			'INTERESTS'		=> (!empty($member['user_interests'])) ? str_replace("\n", '<br />', censor_text($member['user_interests'])) : '',
 			'SIGNATURE'		=> (!empty($member['user_sig'])) ? str_replace("\n", '<br />', $member['user_sig']) : '',
 
 			'AVATAR_IMG'	=> $poster_avatar,
@@ -565,7 +568,7 @@
 			$sql = 'SELECT username, user_email, user_allow_viewemail, user_lang, user_jabber, user_notify_type
 				FROM ' . USERS_TABLE . "
 				WHERE user_id = $user_id
-					AND user_type = ". USER_NORMAL . ' AND u.user_status = ' . STATUS_ACTIVE;
+					AND user_type = ". USER_NORMAL . ' AND user_status = ' . STATUS_ACTIVE;
 			$result = $_CLASS['core_db']->query($sql);
 
 			if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
@@ -723,7 +726,7 @@
 
 		// Sorting
 		$sort_key_text = array('a' => $_CLASS['core_user']->lang['SORT_USERNAME'], 'b' => $_CLASS['core_user']->lang['SORT_LOCATION'], 'c' => $_CLASS['core_user']->lang['SORT_JOINED'], 'd' => $_CLASS['core_user']->lang['SORT_POST_COUNT'], 'e' => $_CLASS['core_user']->lang['SORT_EMAIL'], 'f' => $_CLASS['core_user']->lang['WEBSITE'], 'g' => $_CLASS['core_user']->lang['ICQ'], 'h' => $_CLASS['core_user']->lang['AIM'], 'i' => $_CLASS['core_user']->lang['MSNM'], 'j' => $_CLASS['core_user']->lang['YIM'], 'k' => $_CLASS['core_user']->lang['JABBER'], 'l' => $_CLASS['core_user']->lang['SORT_LAST_ACTIVE'], 'm' => $_CLASS['core_user']->lang['SORT_RANK']);
-		$sort_key_sql = array('a' => 'u.username', 'b' => 'u.user_from', 'c' => 'u.user_regdate', 'd' => 'u.user_posts', 'e' => 'u.user_email', 'f' => 'u.user_website', 'g' => 'u.user_icq', 'h' => 'u.user_aim', 'i' => 'u.user_msnm', 'j' => 'u.user_yim', 'k' => 'u.user_jabber', 'l' => 'u.user_last_visit', 'm' => 'u.user_rank DESC, u.user_posts');
+		$sort_key_sql = array('a' => 'u.username', 'b' => 'u.user_from', 'c' => 'u.user_reg_date', 'd' => 'u.user_posts', 'e' => 'u.user_email', 'f' => 'u.user_website', 'g' => 'u.user_icq', 'h' => 'u.user_aim', 'i' => 'u.user_msnm', 'j' => 'u.user_yim', 'k' => 'u.user_jabber', 'l' => 'u.user_last_visit', 'm' => 'u.user_rank DESC, u.user_posts');
 
 		$sort_dir_text = array('a' => $_CLASS['core_user']->lang['ASCENDING'], 'd' => $_CLASS['core_user']->lang['DESCENDING']);
 
@@ -799,7 +802,7 @@
 			$sql_where .= ($msn) ? " AND u.user_msnm LIKE '" . str_replace('*', '%', $_CLASS['core_db']->escape($msn)) ."' " : '';
 			$sql_where .= ($jabber) ? " AND u.user_jabber LIKE '" . str_replace('*', '%', $_CLASS['core_db']->escape($jabber)) . "' " : '';
 			$sql_where .= (is_numeric($count)) ? ' AND u.user_posts ' . $find_key_match[$count_select] . ' ' . (int) $count . ' ' : '';
-			$sql_where .= (sizeof($joined) > 1) ? " AND u.user_regdate " . $find_key_match[$joined_select] . ' ' . gmmktime(0, 0, 0, intval($joined[1]), intval($joined[2]), intval($joined[0])) : '';
+			$sql_where .= (sizeof($joined) > 1) ? " AND u.user_reg_date " . $find_key_match[$joined_select] . ' ' . gmmktime(0, 0, 0, intval($joined[1]), intval($joined[2]), intval($joined[0])) : '';
 			$sql_where .= (sizeof($active) > 1) ? " AND u.user_last_visit " . $find_key_match[$active_select] . ' ' . gmmktime(0, 0, 0, $active[1], intval($active[2]), intval($active[0])) : '';
 
 			if ($ipdomain && $_CLASS['auth']->acl_get('m_ip'))
@@ -1031,11 +1034,14 @@
 		$_CLASS['core_db']->free_result($result);
 		
 		// Do the SQL thang
-		$sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_allow_viewemail, u.user_posts, u.user_regdate, u.user_rank, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_msnm, u.user_jabber, u.user_avatar, u.user_avatar_type, u.user_last_visit 
-			'. $sql_fields .' FROM ' . USERS_TABLE . " u$sql_from
-			WHERE u.user_type = " . USER_NORMAL . ' AND u.user_status = ' . STATUS_ACTIVE ."
-				$sql_where
-			ORDER BY $order_by";
+		$sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_allow_viewemail, u.user_posts, u.user_reg_date,
+				u.user_rank, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, 
+				u.user_msnm, u.user_jabber, u.user_avatar, u.user_avatar_type, u.user_last_visit '. $sql_fields .'
+					FROM ' . USERS_TABLE . " u$sql_from
+					WHERE u.user_type = " . USER_NORMAL . ' AND u.user_status = ' . STATUS_ACTIVE ."
+						$sql_where
+						ORDER BY $order_by";
+
 		$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
 
 		$id_cache = array();
@@ -1170,7 +1176,7 @@
 		'USER_COLOR'	=> (!empty($data['user_colour'])) ? $data['user_colour'] : '',
 		'RANK_TITLE'	=> $rank_title,
 
-		'JOINED'		=> $_CLASS['core_user']->format_date($data['user_regdate'], $_CLASS['core_user']->lang['DATE_FORMAT']),
+		'JOINED'		=> $_CLASS['core_user']->format_date($data['user_reg_date'], $_CLASS['core_user']->lang['DATE_FORMAT']),
 		'VISITED'		=> (empty($last_visit)) ? ' - ' : $_CLASS['core_user']->format_date($last_visit, $_CLASS['core_user']->lang['DATE_FORMAT']),
 		'POSTS'			=> ($data['user_posts']) ? $data['user_posts'] : 0,
 



From viperal at berlios.de  Tue Aug 30 19:36:54 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Tue, 30 Aug 2005 19:36:54 +0200
Subject: [Viperals-svncheckins] r94 - in trunk: blocks includes includes/db includes/forums install javascript modules/Forums
Message-ID: <200508301736.j7UHasIQ013969@sheep.berlios.de>

Author: viperal
Date: 2005-08-30 19:36:52 +0200 (Tue, 30 Aug 2005)
New Revision: 94

Added:
   trunk/javascript/ajax.js
Modified:
   trunk/blocks/block-Quick_Message.php
   trunk/includes/db/mysql.php
   trunk/includes/db/mysqli.php
   trunk/includes/db/postgres.php
   trunk/includes/db/sqlite.php
   trunk/includes/db/sqlite_pdo.php
   trunk/includes/forums/functions.php
   trunk/includes/forums/functions_admin.php
   trunk/includes/forums/functions_posting.php
   trunk/includes/forums/functions_user.php
   trunk/includes/forums/message_parser.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/mailer.php
   trunk/includes/system.php
   trunk/includes/user.php
   trunk/install/build_data.php
   trunk/install/build_tables.php
   trunk/javascript/collapse.js
   trunk/javascript/menu.js
   trunk/modules/Forums/index.php
   trunk/modules/Forums/main.php
   trunk/modules/Forums/posting.php
   trunk/modules/Forums/viewforum.php
   trunk/modules/Forums/viewtopic.php
Log:


Modified: trunk/blocks/block-Quick_Message.php
===================================================================
--- trunk/blocks/block-Quick_Message.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/blocks/block-Quick_Message.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -39,8 +39,8 @@
 
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	//$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES, 'UTF-8'));
-	$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES));
+	$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES, 'UTF-8'));
+	//$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES));
 
 	$row['message_text'] = '';
 

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/db/mysql.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -550,20 +550,6 @@
 
 	function add_table_field_int($name, $setting_sent)
 	{
-		if (!$setting_sent || !is_array($setting_sent))
-		{
-			global $site_file_root;
-			
-			$debug_backtrace = debug_backtrace();
-			$backtrace = array();
-			// remove the root directorys
-			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
-
-			$backtrace['line'] = $debug_backtrace[0]['line'];
-			print_r($backtrace);echo '<br/>';
-		}
-		
 		$setting = array('default' => null, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
 		$setting = array_merge($setting, $setting_sent);
 
@@ -621,7 +607,7 @@
 		}
 	}
 
-	function add_table_field_text($name, $characters = 60000, $null = false)
+	function add_table_field_text($name, $characters, $null = false)
 	{
 		if ($characters <= 255)
 		{
@@ -650,18 +636,14 @@
 	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
 		$this->_fields[$name] = ($padded) ? "`$name` CHAR($characters)" :  "`$name` VARCHAR($characters)";
-		$this->_fields[$name] .= $null ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
 		$this->_fields[$name] .= is_null($default) ? '' : "DEFAULT '$default'";
 	}
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = ($index_name) ? $index_name : $field;
-		
-		/*if (empty($this->_fields[$field]))
-		{
-			return;
-		}*/
+
 		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)

Modified: trunk/includes/db/mysqli.php
===================================================================
--- trunk/includes/db/mysqli.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/db/mysqli.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 class db_mysqli
@@ -95,7 +97,7 @@
 		$this->return_on_error = $fail;
 	}
 
-	function transaction($option = 'start')
+	function transaction($option = 'start', $auto_rollback = true)
 	{
 		if (!$this->link_identifier)
 		{
@@ -125,7 +127,7 @@
 
 				$result = mysqli_commit($this->link_identifier);
 
-				if (!$result)
+				if (!$result && $auto_rollback)
 				{
 					mysqli_rollback($this->link_identifier);
 				}
@@ -637,7 +639,7 @@
 		{
 			return;
 		}*/
-		$field = is_array($field) ? implode(',', $field) : $field;
+		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)
 		{
@@ -651,7 +653,6 @@
 			break;
 		}
 	}
-
 }
 
 ?>
\ No newline at end of file

Modified: trunk/includes/db/postgres.php
===================================================================
--- trunk/includes/db/postgres.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/db/postgres.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -1,18 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class db_postgres
 {
 	var $link_identifier;
@@ -73,6 +81,8 @@
 		if ($this->link_identifier)
 		{
 			pg_set_client_encoding($this->link_identifier, 'UNICODE');
+			//pg_set_client_encoding($this->link_identifier, 'UTF8');  pg8.1 unicode still works tho
+
 			//pg_query($this->link_identifier, "SET CLIENT_ENCODING TO 'value'"); SET NAMES 'value'
 			return $this->link_identifier;
 		}
@@ -101,7 +111,7 @@
 		$this->return_on_error = $fail;
 	}
 
-	function transaction($option = 'start')
+	function transaction($option = 'start', $auto_rollback = true)
 	{
 		$result = false;
 		
@@ -113,7 +123,7 @@
 					break;
 				}
 
-				$result = @pg_query($this->db_connect_id, 'BEGIN TRANSACTION');
+				$result = @pg_query($this->db_connect_id, 'BEGIN');
 				$this->in_transaction = true;
 			break;
 
@@ -126,7 +136,7 @@
 
 				$result = @pg_query($this->db_connect_id, 'COMMIT');
 				
-				if (!$result)
+				if (!$result && $auto_rollback)
 				{
 					@pg_query($this->db_connect_id, 'ROLLBACK');
 				}
@@ -179,7 +189,7 @@
 		{
 			$this->_error($query, $backtrace);
 		}
-		elseif (strpos($query, 'SELECT') !== false)
+		elseif (strpos($query, 'SELECT') === 0)
 		{
 			$this->open_queries[(int) $this->last_result] = $this->last_result;
 		}
@@ -346,22 +356,22 @@
 	function insert_id($table, $column)
 	{
 		$oid = @pg_last_oid($this->last_result);
-	
+
+		/* 
+		Shouldn't be need, but incase they don't have oid support ( not sure why they wouldn't )
+		They can fall back to the less acurrate method, totally not recommended for active sites
+
+		if ($result = $this->query("SELECT last_value FROM pg_get_serial_sequence($table, $column)"))
+		{
+			$return = $this->fetch_row_assoc($result);
+			$this->free_result($result);
+			
+			$return['last_value'];
+		}
+		*/
+
 		if ($oid === false || !($result = $this->query("SELECT $column FROM $table WHERE oid = $oid")))
 		{
-			/* 
-			Shouldn't be need, but incase they don't have oid ( not sure why they wouldn't )
-			They can fall back to the less acurrate method, totally not recommended for active sites
-
-			if ($result = $this->query("SELECT last_value FROM pg_get_serial_sequence($table, $column)"))
-			{
-				$return = $this->fetch_row_assoc($result);
-				$this->free_result($result);
-				
-				$return['last_value'];
-			}
-			*/
-			
 			return false;
 		}
 
@@ -522,12 +532,19 @@
 				}
 
 				$fields = implode(", \n", $this->_fields);
-				$indexs = ($this->_indexs) ? "\n\n".implode("\n", $this->_indexs) :  '';
 
+				if ($this->_indexs['primary'])
+				{
+					$fields .= ", \n".$this->_indexs['primary'];
+					unset($this->_indexs['primary']);
+				}
+			
+				$indexs = empty($this->_indexs) ? '' : "\n\n".implode("\n", $this->_indexs);
+
 				$oid = ($this->_table_oid) ? 'WITH OIDS' : 'WITHOUT OIDS';
 
 				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields." \n )\n $oid;$indexs";
-//WITH ENCODING='UNICODE'  ( for create table )
+//WITH ENCODING='UNICODE'  ( for database creation )
 				if ($option == 'return')
 				{
 					return $table;
@@ -542,33 +559,37 @@
 		}
 	}
 
-	function add_table_field_int($name, $number_min, $number_max = false, $default = 0, $auto_increment = false)
+	function add_table_field_int($name, $setting_sent)
 	{
-		$length = max(strlen($number_min), strlen($number_max));
+		$setting = array('default' => null, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
+		$setting = array_merge($setting, $setting_sent);
 
-		if (!$auto_increment && $number_min >= -32768 && $number_max <= 32767)
+		$length = max(strlen($setting['min']), strlen($setting['max']));
+
+		if (!$setting['auto_increment'] && $setting['min'] >= -32768 && $setting['max'] <= 32767)
 		{
 			// SMALLINT -- INT2 ( -32,768 to 32,767 )
 			$this->_fields[$name] =  "$name SMALLINT";
 		}
-		elseif ($number_min >= -2147483648 && $number_max <= 2147483647)
+		elseif ($setting['min'] >= -2147483648 && $setting['max'] <= 2147483647)
 		{
 			// INTEGER -- INT4 ( +auto_increment => SERIAL4 ) ( -2,147,483,648 to 2,147,483,647 )
-			$this->_fields[$name] =   ($auto_increment) ? "$name SERIAL" : "$name INTEGER";
+			$this->_fields[$name] =   ($setting['auto_increment']) ? "$name SERIAL" : "$name INTEGER";
 		}
-		elseif ($number_min >= 9223372036854775808 && $number_max <= 9223372036854775807)
+		elseif ($setting['min'] >= 9223372036854775808 && $setting['max'] <= 9223372036854775807)
 		{
 			// BIGINT -- INT8 ( +auto_increment => SERIAL8 ) ( 9,223,372,036,854,775,808 to 9,223,372,036,854,775,807 )
-			$this->_fields[$name] =  ($auto_increment) ? "$name BIGSERIAL" : "$name BIGINT";
+			$this->_fields[$name] =  ($setting['auto_increment']) ? "$name BIGSERIAL" : "$name BIGINT";
 		}
 
-		if ($auto_increment)
+		if ($setting['auto_increment'])
 		{
 			$this->_table_oid = true;
 		}
 		else
 		{
-			$this->_fields[$name] .= " NOT NULL DEFAULT '".(int) $default."'";
+			$this->_fields[$name] .= ($setting['null']) ? " NULL" : " NOT NULL";
+			$this->_fields[$name] .= is_null($setting['default']) ? '' : " DEFAULT '".(int) $setting['default']."'";
 		}
 	}
 
@@ -577,38 +598,27 @@
 		$this->_fields[$name] =  "$name TEXT".(($null) ? " NULL" : " NOT NULL");
 	}
 
-	function add_table_field_char($name, $characters, $default = null, $padded = false)
+	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
 		$this->_fields[$name] =  ($padded) ? "$name CHARACTER($characters)" : "$name CHARACTER VARYING($characters)";
-		$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '$default'";
+		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= is_null($default) ? '' : "DEFAULT '$default'";
 	}
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
-		static $primary_key = false;
-
-		if (empty($this->_fields[$field]))
-		{
-			return;
-		}
-
 		$index_name = $this->_table_name.'_'.(($index_name) ? $index_name : $field) ;
+		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)
 		{
 			case 'index':
 			case 'unique':
-				//CREATE INDEX a ON test USING btree (a)
 				$this->_indexs[$index_name] = (($type == 'UNIQUE') ? 'CREATE UNIQUE' : 'CREATE') . " INDEX $index_name ON {$this->_table_name} ($field);";
 			break;
 
 			case 'primary':
-				if ($primary_key)
-				{
-				}
-				$primary_key = $field;
-
-				$this->_fields[$field] .= ' PRIMARY KEY';
+				$this->_indexs['primary'] = "PRIMARY KEY ($field)";
 			break;
 		}
 	}

Modified: trunk/includes/db/sqlite.php
===================================================================
--- trunk/includes/db/sqlite.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/db/sqlite.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -1,18 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 // Try to download an load dll -- dl()is user chooses too for windows server
 // LOL ya right windows, rofl ....  Maybe it's a test server :-)
 
@@ -166,7 +174,7 @@
 		{
 			$this->_error($query, $backtrace);
 		}
-		elseif (strpos($query, 'SELECT') !== false)
+		elseif (strpos($query, 'SELECT') === 0)
 		{
 			$this->open_queries[(int) $this->last_result] = $this->last_result;
 		}

Modified: trunk/includes/db/sqlite_pdo.php
===================================================================
--- trunk/includes/db/sqlite_pdo.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/db/sqlite_pdo.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -1,18 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 // http://sourceforge.net/projects/sqlitemanager/
 class db_sqlite_pdo
 {

Modified: trunk/includes/forums/functions.php
===================================================================
--- trunk/includes/forums/functions.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/forums/functions.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -500,11 +500,11 @@
 }
 
 // Topic and forum watching common code
-function watch_topic_forum($mode, &$s_watching, $user_id, $match_id, $notify_status = 'unset', $start = 0)
+function watch_topic_forum($mode, $user_id, $match_id, $notify_status = 'unset', $start = 0)
 {
-	global $_CLASS, $_CLASS, $_CORE_CONFIG;
+	global $_CLASS, $config, $_CORE_CONFIG;
 
-	if (!$_CLASS['core_user']->is_user || $_CORE_CONFIG['email']['email_enable'] || $config['allow_topic_notify'])
+	if (!$_CLASS['core_user']->is_user || !$_CORE_CONFIG['email']['email_enable'] || !$config['allow_topic_notify'])
 	{
 		return array('link' => '', 'title' => '', 'watching' => false);
 	}
@@ -523,7 +523,7 @@
 				AND user_id = $user_id";
 		$result = $_CLASS['core_db']->query($sql);
 
-		$notify_status = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['notify_status'] : NULL;
+		$notify_status = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['notify_status'] : null;
 		$_CLASS['core_db']->free_result($result);
 	}
 
@@ -534,15 +534,30 @@
 			if ($_GET['watch'] == $mode)
 			{
 				$is_watching = true;
-	
-				$sql = 'INSERT INTO ' . FORUMS_WATCH_TABLE . " (user_id, $where_sql, notify_status)
-					VALUES ($user_id, $match_id, 0)";
-				$_CLASS['core_db']->query($sql);
+
+				/*
+				if ($mode == 'forum')
+				{
+					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
+						WHERE topic_id = $match_id
+							AND user_id = $user_id";
+				
+					$_CLASS['core_db']->query($sql);
+				}
+				*/
+
+				$sql_array = array(
+					'user_id' => (int) $user_id,
+					$where_sql => (int) $match_id,
+					'notify_status' => 0
+				);
+
+				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' '.$_CLASS['core_db']->sql_build_array('INSERT', $sql_array));
 			}
 
-			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$u_url=$match_id&amp;start=$start"));
-			$message = $_CLASS['core_user']->lang['ARE_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;" . $u_url . "=$match_id&amp;start=$start") . '">', '</a>');
-			trigger_error($message);
+			//$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$u_url=$match_id&amp;start=$start"));
+			//$message = $_CLASS['core_user']->lang['ARE_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;" . $u_url . "=$match_id&amp;start=$start") . '">', '</a>');
+			//trigger_error($message);
 		}
 	}
 	else
@@ -556,12 +571,13 @@
 				$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
 					WHERE $where_sql = $match_id
 						AND user_id = $user_id";
+
 				$_CLASS['core_db']->query($sql);
 			}
 
-			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$u_url=$match_id&amp;start=$start"));
-			$message = $_CLASS['core_user']->lang['NOT_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;" . $u_url . "=$match_id&amp;start=$start") . '">', '</a>');
-			trigger_error($message);
+			//$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$u_url=$match_id&amp;start=$start"));
+			//$message = $_CLASS['core_user']->lang['NOT_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;" . $u_url . "=$match_id&amp;start=$start") . '">', '</a>');
+			//trigger_error($message);
 		}
 		else
 		{
@@ -582,7 +598,7 @@
 			'watching' => true,
 			'link' => generate_link("Forums&amp;file=view$mode&amp;$u_url=$match_id&amp;" . (($is_watching) ? 'unwatch' : 'watch') . "=$mode&amp;start=$start"),
 			'title' => $_CLASS['core_user']->lang[(($is_watching) ? 'STOP' : 'START') . '_WATCHING_' . strtoupper($mode)],
-		);
+	);
 }
 
 // Marks a topic or form as read
@@ -1359,7 +1375,6 @@
 // Temp
 		'T_IMAGE_PATH'			=> "themes/viperal/template/modules/Forums/images/",
 
-		'TRANSLATION_INFO'	=> 'Ported by <a href="http://www.viperal.com/" target="viperal">Viperal</a>',
 		'U_ACP'				=> ($_CLASS['core_user']->is_admin && $_CLASS['auth']->acl_get('a_')) ? generate_link('Forums', array('admin' => true)) : '',
 		'L_ACP'				=> $_CLASS['core_user']->lang['ACP']
 	));

Modified: trunk/includes/forums/functions_admin.php
===================================================================
--- trunk/includes/forums/functions_admin.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/forums/functions_admin.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -425,14 +425,14 @@
 		$forum_ids[] = $row['forum_id'];
 	}
 
-	if (!sizeof($post_ids))
+	if (empty($post_ids))
 	{
 		return false;
 	}
 
 	$sql_where = implode(', ', $post_ids);
 
-	$_CLASS['core_db']->sql_transaction('begin');
+	$_CLASS['core_db']->transaction();
 
 	$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_REPORTS_TABLE, FORUMS_SEARCH_MATCH_TABLE);
 	

Modified: trunk/includes/forums/functions_posting.php
===================================================================
--- trunk/includes/forums/functions_posting.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/forums/functions_posting.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -35,7 +35,7 @@
 	{
 		$sql = 'SELECT smiley_id
 			FROM ' . SMILIES_TABLE . '
-			WHERE smiley_type = 0';
+			WHERE smiley_type = 1';
 		$result = $_CLASS['core_db']->query_limit($sql, 1, 0);
 
 		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -51,7 +51,7 @@
 
 		$sql = 'SELECT *
 			FROM ' . SMILIES_TABLE .' 
-				WHERE smiley_type ='.(($mode == 'inline') ? '1' : '0') . '
+				WHERE smiley_type ='.(($mode == 'inline') ? '0' : '1') . '
 					ORDER BY smiley_order';
 		$result = $_CLASS['core_db']->query($sql);
 	
@@ -469,13 +469,11 @@
 {
 	global $config, $_CLASS;
 
-	// Grab icons
-	$icons = array();
-	obtain_icons($icons);
+	$icons = obtain_icons();
 
 	$_CLASS['core_template']->assign('S_NO_ICON_CHECKED', ((!$icon_id) ? ' checked="checked"' : ''));
 
-	if (sizeof($icons))
+	if (!empty($icons))
 	{
 		foreach ($icons as $id => $data)
 		{
@@ -488,8 +486,8 @@
 					'ICON_HEIGHT' 	=> $data['height'],
 	
 					'S_CHECKED'		=> ($id == $icon_id) ? true : false,
-					'S_ICON_CHECKED' => ($id == $icon_id) ? ' checked="checked"' : '')
-				);
+					'S_ICON_CHECKED' => ($id == $icon_id) ? ' checked="checked"' : ''
+				));
 			}
 		}
 
@@ -632,7 +630,7 @@
 	if ($forum_id || $topic_id)
 	{
 		$sql = 'SELECT d.draft_id, d.topic_id, d.forum_id, d.draft_subject, d.save_time, f.forum_name
-			FROM ' . DRAFTS_TABLE . ' d, ' . FORUMS_TABLE . ' f
+			FROM ' . FORUMS_DRAFTS_TABLE . ' d, ' . FORUMS_TABLE . ' f
 				WHERE d.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 				AND f.forum_id = d.forum_id ' . 
 				(($forum_id) ? " AND f.forum_id = $forum_id" : '') . '
@@ -641,7 +639,7 @@
 	else
 	{
 		$sql = 'SELECT *
-			FROM ' . DRAFTS_TABLE . '
+			FROM ' . FORUMS_DRAFTS_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 				AND forum_id = 0
 				AND topic_id = 0
@@ -664,7 +662,7 @@
 	if (sizeof($topic_ids))
 	{
 		$sql = 'SELECT topic_id, forum_id, topic_title
-			FROM ' . TOPICS_TABLE . '
+			FROM ' . FORUMS_TOPICS_TABLE . '
 			WHERE topic_id IN (' . implode(',', array_unique($topic_ids)) . ')';
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -813,209 +811,149 @@
 // User Notification
 function user_notification($mode, $subject, $topic_title, $forum_name, $forum_id, $topic_id, $post_id)
 {
-	// Going to rewite this
-	return; 
-	
 	global $config, $_CORE_CONFIG, $_CLASS, $site_file_root;
 
-	$topic_notification = ($mode == 'reply' || $mode == 'quote');
-	$forum_notification = ($mode == 'post');
+return;
 
-	if (!$topic_notification && !$forum_notification)
+	if ($mode == 'reply' || $mode == 'quote')
 	{
-		trigger_error('WRONG_NOTIFICATION_MODE');
+		$notify_type = 'topic';
+		$template = 'topic_notify'; //forum_notify
+		$where = "(w.forum_id = $forum_id OR w.topic_id = $topic_id)";
 	}
+	else
+	{
+		$notify_type = 'forum';
+		$template = 'newtopic_notify';
+		$where = 'w.forum_id = '.$forum_id;
+	}
 
 	$topic_title = ($topic_notification) ? $topic_title : $subject;
 	$topic_title = censor_text($topic_title);
 
-	// Get banned User ID's
-	$sql = 'SELECT ban_userid 
-		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']->query($sql);
+	$holding = array();
 
-	$sql_ignore_users = ANONYMOUS . ', ' . $_CLASS['core_user']->data['user_id'];
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if (isset($row['ban_userid']))
-		{
-			$sql_ignore_users .= ', ' . $row['ban_userid'];
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
+// Add use of notification type
 
-	$notify_rows = array();
-
-	// -- get forum_userids	|| topic_userids
-	$sql = 'SELECT u.user_id, u.username, u.user_email, u.user_lang, u.user_notify_type, u.user_jabber 
-		FROM ' . (($topic_notification) ? TOPICS_WATCH_TABLE : FORUMS_WATCH_TABLE) . ' w, ' . USERS_TABLE . ' u
-		WHERE w.' . (($topic_notification) ? 'topic_id' : 'forum_id') . ' = ' . (($topic_notification) ? $topic_id : $forum_id) . "
-			AND w.user_id NOT IN ($sql_ignore_users)
+	// Lets get all the users that are set to be notified
+	// $sql = 'SELECT w.notify_type, u.user_id, u.username, u.user_email, u.user_lang, u.user_notify_type, u.user_jabber 
+	$sql = 'SELECT w.notify_type, u.user_id, u.username, u.user_email, u.user_lang
+		FROM '.FORUMS_WATCH_TABLE.' w, ' . USERS_TABLE . " u
+		WHERE $where
 			AND w.notify_status = 0
-			AND u.user_type IN (" . USER_NORMAL . ', ' . USER_FOUNDER . ')
+			AND u.user_status = ". STATUS_ACTIVE . '
 			AND u.user_id = w.user_id';
 	$result = $_CLASS['core_db']->query($sql);
 
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	while ($user = $_CLASS['core_db']->fetch_user_assoc($result))
 	{
-		$notify_rows[$row['user_id']] = array(
-			'user_id'		=> $row['user_id'],
-			'username'		=> $row['username'],
-			'user_email'	=> $row['user_email'],
-			'user_jabber'	=> $row['user_jabber'], 
-			'user_lang'		=> $row['user_lang'], 
-			'notify_type'	=> ($topic_notification) ? 'topic' : 'forum',
-			'template'		=> ($topic_notification) ? 'topic_notify' : 'newtopic_notify',
-			'method'		=> $row['user_notify_type'], 
-			'allowed'		=> false
-		);
-	}
-	$_CLASS['core_db']->free_result($result);
-	
-	// forum notification is sent to those not receiving post notification
-	if ($topic_notification)
-	{
-		if (sizeof($notify_rows))
+		$ignore_array[$user['user_id']] = $user['user_id'];
+
+		$holding[$user['user_id']] = $user;
+		$holding[$user['user_id']]['template'] = ($notify_type == 'topic' && $user['forum_id']) ? 'forum_notify' : $template;
+		
+		if ($notify_type == 'topic' && $user['forum_id'])
 		{
-			$sql_ignore_users .= ', ' . implode(', ', array_keys($notify_rows));
+			$holding[$user['user_id']]['template'] = 'forum_notify';
+			$holding[$user['user_id']]['update'] = 'forum';
 		}
-
-		$sql = 'SELECT u.user_id, u.username, u.user_email, u.user_lang, u.user_notify_type, u.user_jabber 
-			FROM ' . FORUMS_WATCH_TABLE . ' fw, ' . USERS_TABLE . " u
-			WHERE fw.forum_id = $forum_id
-				AND fw.user_id NOT IN ($sql_ignore_users)
-				AND fw.notify_status = 0
-				AND u.user_type IN (" . USER_NORMAL . ', ' . USER_FOUNDER . ')
-				AND u.user_id = fw.user_id';
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		else
 		{
-			$notify_rows[$row['user_id']] = array(
-				'user_id'		=> $row['user_id'],
-				'username'		=> $row['username'],
-				'user_email'	=> $row['user_email'],
-				'user_jabber'	=> $row['user_jabber'], 
-				'user_lang'		=> $row['user_lang'],
-				'notify_type'	=> 'forum',
-				'template'		=> 'forum_notify',
-				'method'		=> $row['user_notify_type'], 
-				'allowed'		=> false
-			);
+			$holding[$user['user_id']]['template'] = $template;
+			$holding[$user['user_id']]['update'] = $notify_type;
 		}
-		$_CLASS['core_db']->free_result($result);
 	}
-
-	if (!sizeof($notify_rows))
+	$_CLASS['core_db']->free_result($result);
+	
+	if (empty($holding))
 	{
 		return;
 	}
 
-	foreach ($_CLASS['auth']->acl_get_list(array_keys($notify_rows), 'f_read', $forum_id) as $forum_id => $forum_ary)
+	// Now we remove the users that aren't allowed to read the forum
+	$acl_list = $_CLASS['auth']->acl_get_list(array_keys($ignore_array), 'f_read', $forum_id);
+
+	foreach($forum_ary[$forum_id]['f_read'] as $user_id)
 	{
-		foreach ($forum_ary as $auth_option => $user_ary)
-		{
-			foreach ($user_ary as $user_id)
-			{
-				$notify_rows[$user_id]['allowed'] = true;
-			}
-		}
+		unset($ignore_array[$user_id]);
 	}
 
+	$processed = $update = array();
 
-	// Now, we have to do a little step before really sending, we need to distinguish our users a little bit. ;)
-	$msg_users = $delete_ids = $update_notification = array();
-	foreach ($notify_rows as $user_id => $row)
+	foreach ($holding as $user)
 	{
-		if (!$row['allowed'] || !trim($row['user_email']))
+		if (!in_array($user['user_id'], $ignore_array))
 		{
-			$delete_ids[$row['notify_type']][] = $row['user_id'];
+			$processed[$user['template']][] = $user;
+			$update[$user['update']][] = $user['user_id'];
 		}
-		else
-		{
-			$msg_users[] = $row;
-			$update_notification[$row['notify_type']][] = $row['user_id'];
-		}
 	}
-	unset($notify_rows);
+	unset($holding, $ignore_array);
 
-	// Now, we are able to really send out notifications
-	if (sizeof($msg_users))
+	if (empty($processed))
 	{
-		require_once($site_file_root.'includes/forums/functions_messenger.php');
-		$messenger = new messenger();
+		return;
+	}
 
-		$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
+	require_once($site_file_root.'includes/forums/functions_messenger.php');
+	$messenger = new messenger();
 
-		$msg_list_ary = array();
-		foreach ($msg_users as $row)
-		{ 
-			$pos = (!isset($msg_list_ary[$row['template']])) ? 0 : sizeof($msg_list_ary[$row['template']]);
+	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
 
-			$msg_list_ary[$row['template']][$pos]['method']	= $row['method'];
-			$msg_list_ary[$row['template']][$pos]['email']	= $row['user_email'];
-			$msg_list_ary[$row['template']][$pos]['jabber']	= $row['user_jabber'];
-			$msg_list_ary[$row['template']][$pos]['name']	= $row['username'];
-			$msg_list_ary[$row['template']][$pos]['lang']	= $row['user_lang'];
-		}
-		unset($msg_users);
+	require_once($site_file_root.'includes/mailer.php');
 
-		foreach ($msg_list_ary as $email_template => $email_list)
+	foreach ($processed as $template => $user_list)
+	{
+		$mailer = new core_mailer;
+
+		$count = count($user_list);
+		for ($i = 0; $i < $count; $i++)
 		{
-			foreach ($email_list as $addr)
-			{
-				$messenger->template($email_template, $addr['lang']);
+			$mailer->to($user_list[$i]['user_id'], $user_list[$i]['username']);
+		}
 
-				$messenger->replyto($config['board_email']);
-				$messenger->to($addr['email'], $addr['name']);
-				$messenger->im($addr['jabber'], $addr['name']);
+// this has to change
+		$mailer->subject($_CLASS['core_user']->get_lang('FORUM_NOTIFICATION'));
 
-				$messenger->assign_vars(array(
-					'EMAIL_SIG'		=> $email_sig,
-					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
-					'USERNAME'		=> $addr['name'],
-					'TOPIC_TITLE'	=> $topic_title,  
-					'FORUM_NAME'	=> $forum_name,
+		$_CLASS['core_template']->assign_array(array(
+			'EMAIL_SIG'		=> '',
+			'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
+			'TOPIC_TITLE'	=> $topic_title,  
+			'FORUM_NAME'	=> $forum_name,
 
-					'U_FORUM'				=> generate_link("Forums&amp;file=viewtopic&f=$forum_id&e=0", array('sid' => false, 'full' => true)),
-					'U_TOPIC'				=> generate_link("Forums&amp;file=viewtopic&f=$forum_id&t=$topic_id&e=0", array('sid' => false, 'full' => true)),
-					'U_NEWEST_POST'			=> generate_link("Forums&amp;file=viewtopic&f=$forum_id&t=$topic_id&p=$post_id&e=$post_id", array('sid' => false, 'full' => true)),
-					'U_STOP_WATCHING_TOPIC' => generate_link("Forums&amp;file=viewtopic&f=$forum_id&t=$topic_id&unwatch=topic", array('sid' => false, 'full' => true)),
-					'U_STOP_WATCHING_FORUM' => generate_link("Forums&amp;file=viewforum&f=$forum_id&unwatch=forum", array('sid' => false, 'full' => true)), 
-				));
+			'U_FORUM'				=> generate_link("Forums&amp;file=viewtopic&f=$forum_id&e=0", array('sid' => false, 'full' => true)),
+			'U_TOPIC'				=> generate_link("Forums&amp;file=viewtopic&t=$topic_id&e=0", array('sid' => false, 'full' => true)),
+			'U_NEWEST_POST'			=> generate_link("Forums&amp;file=viewtopic&t=$topic_id&p=$post_id&e=$post_id", array('sid' => false, 'full' => true)),
+			'U_STOP_WATCHING_TOPIC' => generate_link("Forums&amp;file=viewtopic&t=$topic_id&unwatch=topic", array('sid' => false, 'full' => true)),
+			'U_STOP_WATCHING_FORUM' => generate_link("Forums&amp;file=viewforum&f=$forum_id&unwatch=forum", array('sid' => false, 'full' => true)), 
+		));
 
-				$messenger->send($addr['method']);
-				$messenger->reset();
-			}
-		}
-		unset($msg_list_ary);
-
-		if ($messenger->queue)
-		{
-			$messenger->save_queue();
-		}
+		//$mailer->message = trim($_CLASS['core_template']->display('fdsgfd'.$template, true));
+		//$mailer->send();
+		
+		unset($mailer);
 	}
 
-	// Handle the DB updates
 	$_CLASS['core_db']->transaction();
 
-	if (isset($update_notification['topic']) && sizeof($update_notification['topic']))
+	if (!empty($update['topic']))
 	{
-		$_CLASS['core_db']->query('UPDATE ' . TOPICS_WATCH_TABLE . "
+		$_CLASS['core_db']->query('UPDATE ' . FORUMS_WATCH_TABLE . "
 			SET notify_status = 1
 			WHERE topic_id = $topic_id
-				AND user_id IN (" . implode(', ', $update_notification['topic']) . ")");
+				AND user_id IN (" . implode(', ', $update['topic']) . ")");
 	}
 
-	if (isset($update_notification['forum']) && sizeof($update_notification['forum']))
+	if (!empty($update['forum']))
 	{
 		$_CLASS['core_db']->query('UPDATE ' . FORUMS_WATCH_TABLE . "
 			SET notify_status = 1
 			WHERE forum_id = $forum_id
-				AND user_id IN (" . implode(', ', $update_notification['forum']) . ")");
+				AND user_id IN (" . implode(', ', $update['forum']) . ")");
 	}
 
 	// Now delete the user_ids not authorized to receive notifications on this topic/forum
+	/*
 	if (isset($delete_ids['topic']) && sizeof($delete_ids['topic']))
 	{
 		$_CLASS['core_db']->query('DELETE FROM ' . TOPICS_WATCH_TABLE . "
@@ -1029,6 +967,7 @@
 			WHERE forum_id = $forum_id
 				AND user_id IN (" . implode(', ', $delete_ids['forum']) . ")");
 	}
+	*/
 
 	$_CLASS['core_db']->sql_transaction('commit');
 }

Modified: trunk/includes/forums/functions_user.php
===================================================================
--- trunk/includes/forums/functions_user.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/forums/functions_user.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -983,54 +983,6 @@
 	return array(AVATAR_UPLOAD, $file->get('realname'), $file->get('width'), $file->get('height'));
 }
 
-function avatar_gallery($category, &$error)
-{
-	global $config, $_CLASS, $_CORE_CONFIG;
-
-	$path = $config['avatar_gallery_path'];
-	
-	if (!file_exists($path) || !is_dir($path))
-	{
-		return array($_CLASS['core_user']->lang['NONE'] => array());
-	}
-	
-	// To be replaced with SQL ... before M3 completion
-	$dp = @opendir($path);
-
-	$data = array();
-	$count = 0;
-
-	while ($file = readdir($dp))
-	{
-		if ($file{0} != '.' && is_dir("$path/$file"))
-		{
-			$dp2 = @opendir("$path/$file");
-
-			while ($sub_file = readdir($dp2))
-			{
-				if (preg_match('#\.(gif$|png$|jpg|jpeg)$#i', $sub_file))
-				{
-					$data[$file][$count]['file'] = "$file/$sub_file"; 
-					$data[$file][$count]['name'] = ucfirst(str_replace('_', ' ', preg_replace('#^(.*)\..*$#', '\1', $sub_file)));
-
-					$count++;
-				}
-			}
-			closedir($dp2);
-		}
-	}
-	closedir($dp);
-	
-	if (!sizeof($data))
-	{
-		return false;
-	}
-	
-	ksort($data);
-
-	return $data;
-}
-
 //
 // Usergroup functions
 //

Modified: trunk/includes/forums/message_parser.php
===================================================================
--- trunk/includes/forums/message_parser.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/forums/message_parser.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -652,11 +652,8 @@
 			return '';
 		}
 		
-		$server_protocol = ( $config['cookie_secure'] ) ? 'https://' : 'http://';
-		$server_port = ( $config['server_port'] <> 80 ) ? ':' . trim($config['server_port']) . '/' : '/';
-
 		// relative urls for this board
-		if (preg_match('#' . $server_protocol . trim($config['server_name']) . $server_port . preg_replace('/^\/?(.*?)(\/)?$/', '$1', trim($config['script_path'])) . '/([^ \t\n\r<"\']+)#i', $url) ||
+		if (preg_match('#' . preg_quote(preg_replace('/^\/?(.*?)(\/)?$/', '$1', generate_base_url()), '#') . '/([^ \t\n\r<"\']+)#i', $url) ||
 			preg_match('#([\w]+?://.*?[^ \t\n\r<"\']*)#i', $url) ||
 			preg_match('#(www\.[\w\-]+\.[\w\-.\~]+(?:/[^ \t\n\r<"\']*)?)#i', $url))
 		{
@@ -783,7 +780,7 @@
 		// Parse URL's
 		if ($allow_magic_url)
 		{
-			$this->magic_url((($config['cookie_secure']) ? 'https://' : 'http://'), $config['server_name'], $config['server_port'], $config['script_path']);
+			$this->magic_url();
 	
 			if ($config['max_' . $mode . '_urls'])
 			{
@@ -888,20 +885,18 @@
 	// Replace magic urls of form http://xxx.xxx., www.xxx. and xxx at xxx.xxx.
 	// Cuts down displayed size of link if over 50 chars, turns absolute links
 	// into relative versions when the server/script path matches the link
-	function magic_url($server_protocol, $server_name, $server_port, $script_path)
+	function magic_url()
 	{
 		static $match;
 		static $replace;
 		
-		$server_port = ($server_port <> 80 ) ? ':' . trim($server_port) . '/' : '/';
-
 		if(!is_array($match))
 		{
 			$match = $replace = array();
 			// Be sure to not let the matches cross over. ;)
 	
 			// relative urls for this board
-			$match[] = '#(^|[\n ]|\()(' . preg_quote($server_protocol . trim($server_name) . $server_port . preg_replace('/^\/?(.*?)(\/)?$/', '$1', trim($script_path)), '#') . ')/(.*?([^ \t\n\r<"\'\)]*)?)#i';
+			$match[] = '#(^|[\n ]|\()(' . preg_quote(preg_replace('/^\/?(.*?)(\/)?$/', '$1', generate_base_url()), '#') . ')/(.*?([^ \t\n\r<"\'\)]*)?)#i';
 			$replace[] = '$1<!-- l --><a href="$2/$3">$3</a><!-- l -->';
 	
 			// matches a xxxx://aaaaa.bbb.cccc. ...

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/functions.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -39,11 +39,11 @@
 		{
 			$is_bot = $bot['user_id'];
 		}
-		
+
 		if ($bot['user_ip'] && (!$bot['user_agent'] || $is_bot))
 		{
 			$is_bot = false;
-			
+
 			foreach (explode(',', $bot['user_ip']) as $bot_ip)
 			{
 				if (strpos($ip, $bot_ip) === 0)
@@ -52,7 +52,7 @@
 				}
 			}
 		}
-		
+
 		if ($is_bot)
 		{
 			if ($bot['user_status'] == USER_DISABLE)
@@ -64,7 +64,7 @@
 			break;
 		}
 	}
-	
+
 	return $is_bot;
 }
 
@@ -87,7 +87,7 @@
 {
 	global $_CORE_CONFIG, $_CLASS;
 	static $load_status = null;
-	
+
 	if (!is_null($load_status))
 	{
 		return $load_status;
@@ -155,7 +155,7 @@
 			{
 				return $maintance_status = false;
 			}
-			
+
 			if ($return)
 			{
 				return $maintance_status = true;
@@ -163,7 +163,7 @@
 
 			trigger_error('503:'.$_CORE_CONFIG['maintenance']['text'], E_USER_ERROR);
 		}
-		
+
 		return $_CORE_CONFIG['maintenance']['start'];
 	}
 
@@ -181,7 +181,7 @@
 	return false;
 }
 
-function display_confirmation($message = '', $hidden = '')
+function display_confirmation($message = '', $hidden = '', $image = false)
 {
 	global $_CLASS, $SID;
 // Add user entered confirmation code as a choose, maybe ...
@@ -193,9 +193,9 @@
 	if (isset($_POST['confirm']))
 	{
 		$code = $_CLASS['core_user']->session_data_get('confirmation_code');
-		$confirm_code = get_variable('confirm_code', 'POST');
+		$confirm_code = get_variable('confirm_code', 'POST', false);
 
-		if ($code && $confirm_code && $code == $confirm_code)
+		if ($code && $confirm_code && $code === $confirm_code)
 		{
 			return true;
 		}
@@ -203,13 +203,25 @@
 		return false;
 	}
 
-	$confirmation_code = generate_string(6);
+	$confirmation_code = generate_string(6);
+
+	if ($image)
+	{
+		$confirm_image = '<img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" />';
+	}
+	else
+	{
+		$confirm_image = false;
+		$hidden .= '<input type="hidden" name="confirm_code" value="' . $confirmation_code . '" />';
+	}
+
 	$_CLASS['core_user']->session_data_set('confirmation_code', $confirmation_code);
 
 	$_CLASS['core_template']->assign_array(array(
 		'MESSAGE'		=> ($message) ? $message : 'Are you sure you want to perform this action ?',
-		'CONFIRM_ACTION'=> generate_link($_CLASS['core_user']->url),
-		'HIDDEN_FIELDS'	=> $hidden.'<input type="hidden" name="confirm_code" value="' . $confirmation_code . '" />'
+		'CONFIRM_ACTION'=> generate_link($_CLASS['core_user']->url),
+		'CONFIRM_IMAGE'	=> $confirm_image,
+		'HIDDEN_FIELDS'	=> $hidden
 	));
 
 	$_CLASS['core_template']->display('confirmation.html');
@@ -249,27 +261,27 @@
 	if (is_null($bots = $_CLASS['core_cache']->get('bots')))
 	{
 		$bots = array();
-		
+
 		$sql = 'SELECT user_id, username, user_agent, user_ip
 			FROM ' . USERS_TABLE . ' WHERE user_type = ' . USER_BOT;
 		$result = $_CLASS['core_db']->query($sql);
-			
+
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$bots[] = $row;
 		}
-		
+
 		$_CLASS['core_db']->free_result($result);
 		$_CLASS['core_cache']->put('bots', $bots);
 	}
-	
+
 	return $bots;
 }
 
 function get_variable($var_name, $type, $default = false, $var_type = 'string')
 {
 	$variable = null;
-	
+
 	$type = strtoupper($type);
 
 	switch ($type)
@@ -290,7 +302,7 @@
 			$variable = isset($_COOKIE[$var_name]) ? $_COOKIE[$var_name] : $default;
 		break;
 	}
-			
+
 	if (is_null($variable))
 	{
 		return $default;
@@ -329,23 +341,23 @@
 function generate_base_url()
 {
 	static $base = false;
-	
+
 	if (!$base)
 	{
 		global $_CORE_CONFIG;
-		
-		$base = ($_CORE_CONFIG['server']['cookie_secure']) ? 'https://' : 'http://' ;
-		$base .= trim((isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : $_CORE_CONFIG['server']['site_domain']));
-		$base .= (($_CORE_CONFIG['server']['site_port'] != 80) ? ':' . trim($_CORE_CONFIG['server']['site_port']) : '') . $_CORE_CONFIG['server']['site_path'];
+
+		$base = ($_CORE_CONFIG['server']['site_secure']) ? 'https://' : 'http://' ;
+		$base .= trim(isset($_SERVER['HTTP_HOST']) ? $_SERVER['HTTP_HOST'] : $_CORE_CONFIG['server']['site_domain']);
+		$base .= (($_CORE_CONFIG['server']['site_port'] && $_CORE_CONFIG['server']['site_port'] != 80) ? ':' . $_CORE_CONFIG['server']['site_port'] : '') . ($_CORE_CONFIG['server']['site_path']) ? $_CORE_CONFIG['server']['site_path'] : '/';
 	}
-	
+
 	return $base;
 }
 
 function generate_link($link = false, $link_options = false)
 {
 	global $_CLASS, $_CORE_MODULE;
-	
+
 	$options = array(
 		'admin'		=> false,
 		'full'		=> false,
@@ -368,7 +380,7 @@
 	}
 
 	$file = ($options['admin']) ? ADMIN_PAGE : INDEX_PAGE;
-	
+
 	if (!$link)
 	{
 		$link = $file;
@@ -487,9 +499,9 @@
 function load_class($file, $name, $class = false)
 {
 	global $_CLASS;
-	
+
 	$class = ($class) ? $class : $name;
-	
+
 	if (empty($_CLASS[$name]) || !is_object($_CLASS[$name]))
 	{
 		if ($file)
@@ -510,7 +522,7 @@
 function set_core_config($section, $name, $value, $clear_cache = true, $auto_add = false, $cache = true)
 {
 	global $_CLASS, $_CORE_CONFIG;
-	
+
 	$sql = 'UPDATE ' . CORE_CONFIG_TABLE . " SET config_value = '".$_CLASS['core_db']->escape($value) . "'
 		WHERE config_section = '" . $_CLASS['core_db']->escape($section) . "'
 			AND config_name = '". $_CLASS['core_db']->escape($name) ."'";
@@ -526,9 +538,7 @@
 		);
 
 		$_CLASS['core_db']->return_on_error(true);
-
 		$_CLASS['core_db']->query('INSERT INTO ' . CORE_CONFIG_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_array));
-		
 		$_CLASS['core_db']->return_on_error(false);
 	}
 
@@ -574,12 +584,12 @@
 			$_CLASS['core_user']->save();
 		}	
 	}
-	
+
 	if (!empty($_CLASS['core_cache']))
 	{
 		$_CLASS['core_cache']->save();
 	}
-	
+
 	if (!empty($_CLASS['core_db']))
 	{
 		$_CLASS['core_db']->disconnect();
@@ -609,7 +619,7 @@
 {
 	global $_CLASS, $_CORE_CONFIG;
 	static $loaded = false;
-	
+
 	if ($loaded)
 	{
 		return $loaded;
@@ -686,12 +696,12 @@
 function select_theme($default = false)
 {
 	global $site_file_root, $_CLASS;
-	
+
 	if (!$default)
 	{
 		$default = $_CLASS['core_display']->theme_name;
 	}
-	
+
 	$theme_array = array();
 	$handle = opendir($site_file_root.'themes');
 	
@@ -751,11 +761,6 @@
 	return $select;
 }
 
-function url_redirect($url = false, $save = false)
-{
-	redirect($url = false, $save = false);
-}
-
 if (!function_exists('file_get_contents'))
 {
 	//string file_get_contents ( string filename [, bool use_include_path [, resource context [, int offset [, int maxlen]]]] )

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/functions_user.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -537,7 +537,7 @@
 	{
 		return 'USERNAME_TAKEN';
 	}
-	
+
 	return true;
 }
 

Modified: trunk/includes/mailer.php
===================================================================
--- trunk/includes/mailer.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/mailer.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -182,9 +182,10 @@
 			$message = "\n".strip_tags(preg_replace('#<br */?>#i', "\n", modify_lines($this->message)))."\n";
 		}
 
-		if (!$_CORE_CONFIG['email']['smtp'])
+		if ($_CORE_CONFIG['email']['smtp'])
 		{
 			$smtp = new smtp_mailer;
+
 			if ($connect = $smtp->connect($_CORE_CONFIG['email']['smtp_host'], $_CORE_CONFIG['email']['smtp_port']))
 			{
 				$login = $smtp->login($_CORE_CONFIG['email']['smtp_username'], $_CORE_CONFIG['email']['smtp_password']);
@@ -252,7 +253,7 @@
 		$port = ((int) $port) ? (int) $port : 25;
 
 		//$host = 'tls://smtp.gmail.com';
-		//$port = 587;
+		//$port = 465;
 
 		$this->connection = fsockopen($host, $port, $errno, $errstr, 5);
 

Modified: trunk/includes/system.php
===================================================================
--- trunk/includes/system.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/system.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -164,7 +164,7 @@
 		trigger_error('CANT_ACTIVATED');
 	}
 	
-	$sql = 'SELECT username, user_status, user_email, user_new_password, user_new_password_encoding, user_act_key
+	$sql = 'SELECT username, user_status, user_group, user_new_password, user_new_password_encoding, user_act_key
 		FROM ' . USERS_TABLE . " WHERE user_id = $user_id AND user_type = ".USER_NORMAL;
 
 	$result = $_CLASS['core_db']->sql_query($sql);
@@ -180,7 +180,7 @@
 	{
 		trigger_error(($row['user_status'] == USER_ACTIVE) ? 'ALREADY_ACTIVATED' : 'CANT_ACTIVATED');
 	}
-	
+
 	if ($row['user_act_key'] != $key)
 	{
 		trigger_error('WRONG_ACTIVATION_KEY');
@@ -192,7 +192,7 @@
 		'user_new_password_encoding'=> null
 	);
 
-	if ($row['user_new_password'])
+	if ($row['user_status'] != USER_UNACTIVATED)
 	{
 		$sql_ary += array(
 			'user_password'				=> $row['user_new_password'],
@@ -203,13 +203,14 @@
 	{
 		include_once($site_file_root.'includes/functions_user.php');
 		user_activate($user_id);
-		
+
 		set_core_config('user', 'newest_user_id', $row['user_id'], false);
 		set_core_config('user', 'newest_username', $row['username'], false);
 	}
 
 	$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
 		WHERE user_id = ' . $row['user_id'];
+
 	$result = $_CLASS['core_db']->sql_query($sql);
 }
 

Modified: trunk/includes/user.php
===================================================================
--- trunk/includes/user.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/includes/user.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -246,7 +246,7 @@
 					}
 				}
 			}
-	
+
 			$path = $site_file_root.'themes/'.$theme;
 			
 			$_CLASS['core_display']->load_theme($theme, $path);
@@ -409,7 +409,7 @@
 		}
 		else
 		{
-			setcookie($name, $cookie_data, $cookie_time, $_CORE_CONFIG['server']['cookie_path'], $_CORE_CONFIG['server']['cookie_domain'], $_CORE_CONFIG['server']['cookie_secure']);
+			setcookie($name, $cookie_data, $cookie_time, $_CORE_CONFIG['server']['cookie_path'], $_CORE_CONFIG['server']['cookie_domain'], $_CORE_CONFIG['server']['site_secure']);
 		}
 	}
 	

Modified: trunk/install/build_data.php
===================================================================
--- trunk/install/build_data.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/install/build_data.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -48,10 +48,11 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mb_mail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_auth_type', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_port', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '.*', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
@@ -75,12 +76,12 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_name', 'viperal', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_path', '/', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_secure', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_load', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_sessions', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_secure', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_domain', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
@@ -298,11 +299,11 @@
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
 //$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbsmiley_code', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html_tags', 'b,i,u,pre', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_smilies', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_smilies', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_topic_notify', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_forum_notify', '1', 0)");
@@ -310,12 +311,9 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_remote', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_upload', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_nocensors', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_cpf_viewtopic', '0', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bookmarks', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_cpf_viewprofile', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_disable_msg', '', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_form', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('cookie_secure', '0', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_login_attempts', '3', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_ratings', '10', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('posts_per_page', '10', 0)");
@@ -328,8 +326,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_cpf_memberlist', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online', '1', 0)");
@@ -341,7 +338,8 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_track', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('queue_interval', '3', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('version', '2.1.2', 0)");
@@ -414,9 +412,6 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_download_pm', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_report_pm', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_guests', '1', 0)");
-#$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('print_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('forward_pm', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_img_pm', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)");

Modified: trunk/install/build_tables.php
===================================================================
--- trunk/install/build_tables.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/install/build_tables.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -673,6 +673,7 @@
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('notify_type', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('notify_status', array('max' => 10));
 
 $_CLASS['core_db']->add_table_index('forum_id');

Added: trunk/javascript/ajax.js
===================================================================
--- trunk/javascript/ajax.js	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/javascript/ajax.js	2005-08-30 17:36:52 UTC (rev 94)
@@ -0,0 +1,40 @@
+// By Ryan Marshall ( viperal1 at gmail.com )
+
+function core_ajax()
+{
+	this.request = false;
+	this.async = true;
+}
+
+core_ajax.prototype.init = function()
+{
+	try
+	{
+		this.request = new XMLHttpRequest();
+	}
+	catch(e)
+	{
+		try
+		{
+			this.request = new ActiveXObject('Microsoft.XMLHTTP');
+			return true;
+		}
+		catch(e)
+		{
+			return false;
+		}
+	}
+}
+
+core_ajax.prototype.send = function(url, data)
+{
+	if (!this.request)
+	{
+		this.init();
+	}
+	
+	this.request.open('POST', url, this.async);
+	this.request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
+	
+	this.request.send(data);
+}
\ No newline at end of file

Modified: trunk/javascript/collapse.js
===================================================================
--- trunk/javascript/collapse.js	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/javascript/collapse.js	2005-08-30 17:36:52 UTC (rev 94)
@@ -6,8 +6,11 @@
 **	Auto opening on mouse over maybe ( closeing on mouse out ) ?	
 */
 
-var slider_id = new Array();
-var slider_height = new Array();
+if (typeof slider_id == 'undefined')
+{
+	var slider_id = new Array();
+	var slider_height = new Array();
+}
 
 function get_cookie(cookie_name)
 {
@@ -58,7 +61,7 @@
 	return null;
 }
 
-function switch_collapse(identifier, cookie)
+function switch_collapse(identifier, no_slide, cookie)
 {
 	var area = document.getElementById(identifier);
 	var img = document.getElementById(identifier + '_img');
@@ -67,17 +70,8 @@
 
 	if (area.style.display == 'none')
 	{
-		area.style.height = '';
-		area.style.display = '';
-		var height = area.offsetHeight;
-
-		area.style.overflow	= 'hidden';
-		area.style.height = '0px';
-
 		switch_collapse_save(identifier, false, cookie);
 
-		start_slide_block(identifier, 'out', height);
-
 		if (img)
 		{
 			img.src = img.src.replace('show', 'hide');
@@ -86,18 +80,26 @@
 		if (item)
 		{
 			item.className = item.className.replace('show', 'hide');
-		}
+		}
+
+		area.style.display = '';
+
+		if (!no_slide)
+		{
+			area.style.height = '';
+
+			var height = area.offsetHeight;
+	
+			area.style.overflow	= 'hidden';
+			area.style.height = '0px';
+
+			start_slide_block(identifier, 'out', height);
+		}
 	}
 	else
 	{
-		var height = area.offsetHeight;
-		area.style.overflow	= 'hidden';
-
-		start_slide_block(identifier, 'in', height);
-
 		switch_collapse_save(identifier, true, cookie);
 		
-
 		if (img)
 		{
 			img.src = img.src.replace('hide', 'show');
@@ -106,6 +108,18 @@
 		if (item)
 		{
 			item.className = item.className.replace('hide', 'show');
+		}
+
+		if (no_slide)
+		{
+			area.style.display = 'none';
+		}
+		else
+		{
+			var height = area.offsetHeight;
+			area.style.overflow	= 'hidden';
+	
+			start_slide_block(identifier, 'in', height);
 		}
 	}
 }
@@ -171,42 +185,40 @@
 function slide_block(identifier, option, height)
 {
 	var area = document.getElementById(identifier);
+	var step = Math.ceil(height / 25);
 
+	if (step < 6)
+	{
+		step = 6;
+	}
+
 	if (option == 'in')
 	{
-		if (slider_height[identifier] == 0)
-		{//alert(height);
-			stop_slide_block(identifier);
+		slider_height[identifier] -= step;
+		
+		if (slider_height[identifier] <= 0)
+		{
 			area.style.display = 'none';
+			area.style.height = '';
 
+			stop_slide_block(identifier);
+			
 			return;
 		}
-
-		slider_height[identifier] -= 6;
-		
-		if (slider_height[identifier] < 0)
-		{
-			slider_height[identifier] = 0;
-		}
-
 	}
 	else
 	{
-		if (slider_height[identifier] == height || slider_height[identifier] > height)
-		{	//alert(height);
+		slider_height[identifier] += step;
+
+		if (slider_height[identifier] >= height)
+		{
+			area.style.height = '';
 			stop_slide_block(identifier);
 
 			return;
 		}
+	}
 
-		slider_height[identifier] += 6;
-		
-		if (slider_height[identifier] > height)
-		{
-			slider_height[identifier] = height;
-		}
-	}
-		
 	area.style.height = slider_height[identifier]+'px';
 }
 

Modified: trunk/javascript/menu.js
===================================================================
--- trunk/javascript/menu.js	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/javascript/menu.js	2005-08-30 17:36:52 UTC (rev 94)
@@ -148,27 +148,26 @@
 	{
 		active_menu = false;
 	}
-	
+
+	stop_slide(object_name+ '_menu');
 	menu.style.display = 'none';	
 }
 
 function slide(identifier, height)
 {
 	var area = document.getElementById(identifier);
+	var step = Math.ceil(height / 25);
 
-	if (slider_height[identifier] == height || slider_height[identifier] > height)
+	slider_height[identifier] += step;
+
+	if (slider_height[identifier] >= height)
 	{
+		area.style.clip = '';
+		
 		stop_slide(identifier);
 	}
 	else
 	{
-		slider_height[identifier] += 6;
-
-		if (slider_height[identifier] > height)
-		{
-			slider_height[identifier] = height;
-		}
-
 		area.style.clip = 'rect(auto, auto, ' + slider_height[identifier] + 'px, auto)';
 	}
 }

Modified: trunk/modules/Forums/index.php
===================================================================
--- trunk/modules/Forums/index.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/modules/Forums/index.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -1,16 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 $file = get_variable('file', 'REQUEST', false);
 
 $approved_files = array('viewforum', 'viewtopic', 'report', 'faq', 'posting', 'download', 'mcp', 'search');

Modified: trunk/modules/Forums/main.php
===================================================================
--- trunk/modules/Forums/main.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/modules/Forums/main.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -1,16 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: index.php,v 1.146 2004/09/01 15:55:40 psotfx Exp $

Modified: trunk/modules/Forums/posting.php
===================================================================
--- trunk/modules/Forums/posting.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/modules/Forums/posting.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -1,4 +1,26 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: posting.php,v 1.346 2004/10/19 19:20:29 acydburn Exp $
@@ -10,6 +32,7 @@
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 
 // -------------------------------------------------------------
+
 if (!defined('VIPERAL'))
 {
     die;
@@ -21,13 +44,12 @@
 $forum_id	= request_var('f', 0);
 $draft_id	= request_var('d', 0);
 
-$submit		= (isset($_POST['post']));
-$preview	= (isset($_POST['preview']));
-$save		= (isset($_POST['save']));
-$load		= (isset($_POST['load']));
-$cancel		= (isset($_POST['cancel']));
-$confirm	= (isset($_POST['confirm']));
-$delete		= (isset($_POST['delete']));
+$submit		= isset($_POST['post']);
+$preview	= isset($_POST['preview']);
+$save		= isset($_POST['save']);
+$load		= isset($_POST['load']);
+$confirm	= isset($_POST['confirm']);
+$delete		= isset($_POST['delete']);
 
 $refresh	= isset($_POST['add_file']) || isset($_POST['delete_file']) || isset($_POST['edit_comment']) || isset($_POST['cancel_unglobalise']) || $save || $load;
 
@@ -37,10 +59,10 @@
 $current_time = $_CLASS['core_user']->time;
 
 // Was cancel pressed? If so then redirect to the appropriate page
-if ($_CLASS['core_user']->is_bot || $cancel)
+if ($_CLASS['core_user']->is_bot || isset($_POST['cancel']))
 {
-	$redirect = ($post_id) ? generate_link("Forums&amp;file=viewtopic&p=$post_id#$post_id") : (($topic_id) ? generate_link('Forums&amp;file=viewtopic&t='.$topic_id) : (($forum_id) ? generate_link('Forums&amp;file=viewforum&f='.$forum_id) : generate_link('Forums')));
-	url_redirect($redirect);
+	$redirect = ($post_id) ? "Forums&amp;file=viewtopic&p=$post_id#$post_id" : (($topic_id) ? 'Forums&amp;file=viewtopic&t='.$topic_id : (($forum_id) ? 'Forums&amp;file=viewforum&f='.$forum_id : 'Forums'));
+	redirect(generate_link($redirect,  array('full' => true)));
 }
 
 switch ($mode)
@@ -54,7 +76,7 @@
 		$sql = 'SELECT *
 			FROM ' . FORUMS_FORUMS_TABLE . "
 			WHERE forum_id = $forum_id";
-		break;
+	break;
 
 	case 'bump':
 	case 'reply':
@@ -64,9 +86,8 @@
 		}
 
 		$sql = 'SELECT t.*, f.* 
-			FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . " f
-			WHERE t.topic_id = $topic_id
-				AND f.forum_id = t.forum_id";
+			FROM ' . FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_FORUMS_TABLE . " f ON (f.forum_id = t.forum_id)
+			WHERE t.topic_id = $topic_id";
 	break;
 
 	case 'quote':
@@ -78,16 +99,19 @@
 		}
 
 		$sql = 'SELECT f.*, t.*, p.*, u.username, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield
-			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_USERS_TABLE . " u
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u , ' . FORUMS_TOPICS_TABLE . ' t
+			LEFT JOIN ' . FORUMS_FORUMS_TABLE . " f ON (f.forum_id = t.forum_id)
 			WHERE p.post_id = $post_id
 				AND t.topic_id = p.topic_id
-				AND u.user_id = p.poster_id
-				AND (f.forum_id = t.forum_id 
-					OR f.forum_id = $forum_id)";
-		break;
+				AND u.user_id = p.poster_id";
+	break;
 
 	case 'smilies':
+		require_once($site_file_root.'includes/forums/functions_posting.php');
+
 		generate_smilies('window', $forum_id);
+
+		script_close(false);
 	break;
 
 	default:
@@ -109,9 +133,10 @@
 require_once($site_file_root.'includes/forums/functions_admin.php');
 require_once($site_file_root.'includes/forums/functions_posting.php');
 
+// remove
 extract($posting_data);
 
-if (!$_CLASS['auth']->acl_get('f_' . $mode, $forum_id) && !$_CLASS['auth']->acl_get('m_'. $mode, $forum_id) && $forum_type == FORUM_POST)
+if ($posting_data['forum_type'] == FORUM_POST && !$_CLASS['auth']->acl_get('f_' . $mode, $forum_id) && !$_CLASS['auth']->acl_get('m_'. $mode, $forum_id))
 {
 	if ($_CLASS['core_user']->is_user)
 	{
@@ -121,20 +146,12 @@
 	login_box(array('explain' => $_CLASS['core_user']->lang['LOGIN_EXPLAIN_' . strtoupper($mode)]));
 }
 
-$quote_username = (isset($username)) ? $username : ((isset($post_username)) ? $post_username : '');
-
-$forum_id	= (int) $forum_id;
+$forum_id	= (int) $posting_data['forum_id'];
 $topic_id	= (int) $topic_id;
 $post_id	= (int) $post_id;
 
-// Global Topic? - Adjust forum id
-if (!$forum_id && $topic_type == POST_GLOBAL)
-{
-	$forum_id = request_var('f', 0);
-}
+$posting_data['post_edit_locked'] = isset($posting_data['post_edit_locked']) ? (int) $posting_data['post_edit_locked'] : false;
 
-$post_edit_locked = (isset($post_edit_locked)) ? (int) $post_edit_locked : 0;
-
 $_CLASS['core_user']->add_lang(array('posting', 'mcp', 'viewtopic'));
 $_CLASS['core_user']->add_img();
 
@@ -149,10 +166,9 @@
 	unset($forum_info);
 }
 
-$post_subject = (in_array($mode, array('quote', 'edit', 'delete'))) ? $post_subject : ((isset($topic_title)) ? $topic_title : '');
+$post_subject = in_array($mode, array('quote', 'edit', 'delete')) ? $posting_data['post_subject'] : (isset($posting_data['topic_title']) ? $posting_data['topic_title'] : '');
+$topic_time_limit = (isset($posting_data['topic_time_limit']) && $posting_data['topic_time_limit']) ? (int) $posting_data['topic_time_limit'] / 86400 : 0;
 
-$topic_time_limit = (isset($topic_time_limit)) ? (($topic_time_limit) ? (int) $topic_time_limit / 86400 : (int) $topic_time_limit) : 0;
-
 $poll_length = (isset($poll_length)) ? (($poll_length) ? (int) $poll_length / 86400 : (int) $poll_length) : 0;
 $poll_start = (isset($poll_start)) ? (int) $poll_start : 0;
 $poll_options = array();
@@ -191,16 +207,18 @@
 
 // Set uninitialized variables
 $uninit = array('post_attachment' => 0, 'poster_id' => 0, 'enable_magic_url' => 0, 'topic_status' => 0, 'topic_type' => POST_NORMAL, 'subject' => '', 'topic_title' => '', 'post_time' => 0, 'post_edit_reason' => '');
+
 foreach ($uninit as $var_name => $default_value)
 {
-	if (!isset($$var_name))
+	if (!isset($posting_data[$var_name]))
 	{
-		$$var_name = $default_value;
+		$posting_data[$var_name] = $default_value;
 	}
 }
+
 unset($uninit, $var_name, $default_value);
 
-if ($post_attachment && !$submit && !$refresh && !$preview && $mode == 'edit')
+if ($posting_data['post_attachment'] && !$submit && !$refresh && !$preview && $mode == 'edit')
 {
 	$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
 		FROM ' . FORUMS_ATTACHMENTS_TABLE . "
@@ -214,16 +232,16 @@
 	$_CLASS['core_db']->free_result($result);
 }
 
-if ($poster_id == ANONYMOUS || !$poster_id)
+if (!$posting_data['poster_id'] || $posting_data['poster_id'] == ANONYMOUS)
 {
-	$username = (in_array($mode, array('quote', 'edit', 'delete'))) ? trim($post_username) : '';
+	$posting_data['username'] = in_array($mode, array('quote', 'edit', 'delete')) ? trim($posting_data['post_username']) : get_variable('username', 'POST', '');
 }
 else
 {
-	$username = (in_array($mode, array('quote', 'edit', 'delete'))) ? trim($username) : '';
+	$posting_data['username'] = in_array($mode, array('quote', 'edit', 'delete')) ? trim($posting_data['username']) : '';
 }
 
-$enable_urls = $enable_magic_url;
+$enable_urls = $posting_data['enable_magic_url'];
 $enable_html = (isset($enable_html)) ? $enable_html : $config['allow_html'];
 
 if (!in_array($mode, array('quote', 'edit', 'delete')))
@@ -234,7 +252,7 @@
 	$enable_urls	= true;
 }
 
-$enable_magic_url = $drafts = false;
+$posting_data['enable_magic_url'] = $drafts = false;
 
 // User own some drafts?
 if ($_CLASS['core_user']->is_user && $_CLASS['auth']->acl_get('u_savedrafts') && $mode != 'delete')
@@ -256,26 +274,29 @@
 $check_value = (($enable_html+1) << 16) + (($enable_bbcode+1) << 8) + (($enable_smilies+1) << 4) + (($enable_urls+1) << 2) + (($enable_sig+1) << 1);
 
 // Notify user checkbox
+$notify_set = false;
+
 if ($mode != 'post' && $_CLASS['core_user']->is_user)
 {
-	$sql = 'SELECT topic_id
+	$sql = 'SELECT forum_id, topic_id
 		FROM ' . FORUMS_WATCH_TABLE . "
-		WHERE forum_id = $forum_id AND topic_id IN ($topic_id, 0)
+		WHERE (forum_id = $forum_id OR topic_id = $topic_id)
 			AND user_id = " . $_CLASS['core_user']->data['user_id'];
+
 	$result = $_CLASS['core_db']->query_limit($sql, 1);
-	$notify_set = ($_CLASS['core_db']->fetch_row_assoc($result)) ? 1 : 0;
+
+	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$notify_set = ($row['topic_id']) ? 1 : 2;
+	}
 	$_CLASS['core_db']->free_result($result);
 }
-else
-{
-	$notify_set = 0;
-}
 
 // Forum/Topic locked?
 // what about if we want to delete/etc ?
-if (($forum_status == ITEM_LOCKED || $topic_status == ITEM_LOCKED) && !$_CLASS['auth']->acl_get('m_edit', $forum_id))
+if (($posting_data['forum_status'] == ITEM_LOCKED || $posting_data['topic_status'] == ITEM_LOCKED) && !$_CLASS['auth']->acl_get('m_edit', $forum_id))
 {
-	$message = ($forum_status == ITEM_LOCKED) ? 'FORUM_LOCKED' : 'TOPIC_LOCKED';
+	$message = ($posting_data['forum_status'] == ITEM_LOCKED) ? 'FORUM_LOCKED' : 'TOPIC_LOCKED';
 	trigger_error($message);
 }
 
@@ -284,19 +305,19 @@
 // !$preview && !$refresh && !$submit &&
 if ($mode == 'edit' && !$preview && !$refresh && !$submit && !$_CLASS['auth']->acl_get('m_edit', $forum_id))
 {
-	if ($_CLASS['core_user']->data['user_id'] != $poster_id)
+	if ($posting_data['post_edit_locked'])
 	{
-		trigger_error('USER_CANNOT_EDIT');
+		trigger_error('CANNOT_EDIT_POST_LOCKED');
 	}
 
-	if (!($post_time > time() - $config['edit_time'] || !$config['edit_time']))
+	if ($_CLASS['core_user']->data['user_id'] != $posting_data['poster_id'])
 	{
-		trigger_error('CANNOT_EDIT_TIME');
+		trigger_error('USER_CANNOT_EDIT');
 	}
 
-	if ($post_edit_locked)
+	if (!($posting_data['post_time'] > time() - $config['edit_time'] || !$config['edit_time']))
 	{
-		trigger_error('CANNOT_EDIT_POST_LOCKED');
+		trigger_error('CANNOT_EDIT_TIME');
 	}
 }
 
@@ -311,7 +332,7 @@
 // Delete triggered ?
 if ($mode == 'delete')
 {
-	if ($_CLASS['auth']->acl_get('f_delete', $forum_id) && $post_id == $topic_last_post_id && ((!$_CLASS['core_user']->is_user && $poster_id == ANONYMOUS && $poster_ip && $poster_ip == $_CLASS['core_user']->ip) || ($_CLASS['core_user']->is_user && $poster_id == $_CLASS['core_user']->data['user_id'])))
+	if ($_CLASS['auth']->acl_get('f_delete', $forum_id) && $post_id == $topic_last_post_id && ((!$_CLASS['core_user']->is_user && $posting_data['poster_id'] == ANONYMOUS && $poster_ip && $poster_ip == $_CLASS['core_user']->ip) || ($_CLASS['core_user']->is_user && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'])))
 	{
 		$user_deletable = true;
 	}
@@ -325,16 +346,16 @@
 {
 	$s_hidden_fields = '<input type="hidden" name="p" value="' . $post_id . '" /><input type="hidden" name="f" value="' . $forum_id . '" /><input type="hidden" name="mode" value="delete" />';
 
-	if (confirm_box(true))
+	if (display_confirmation(false, $s_hidden_fields))
 	{
 		$data = array(
 			'topic_first_post_id'=> $topic_first_post_id,
 			'topic_last_post_id'=> $topic_last_post_id,
 			'topic_approved'	=> $topic_approved,
-			'topic_type'		=> $topic_type,
+			'topic_type'		=> $posting_data['topic_type'],
 			'post_approved' 	=> $post_approved,
-			'post_time'			=> $post_time,
-			'poster_id'			=> $poster_id
+			'post_time'			=> $posting_data['post_time'],
+			'poster_id'			=> $posting_data['poster_id']
 		);
 		
 		$next_post_id = delete_post($mode, $post_id, $topic_id, $forum_id, $data);
@@ -343,7 +364,7 @@
 		{
 			if (!$user_deletable)
 			{
-				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_TOPIC', $topic_title);
+				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_TOPIC', $posting_data['topic_title']);
 			}
 
 			$meta_info = generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id);
@@ -362,21 +383,17 @@
 
 		$_CLASS['core_display']->meta_refresh(3, $meta_info);
 		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id).'">', '</a>');
+
 		trigger_error($message);
 	}
-	else
-	{
-		confirm_box(false, 'DELETE_MESSAGE', $s_hidden_fields);
-	}
 }
 
-
-if ($mode == 'delete' && $poster_id != $_CLASS['core_user']->data['user_id'] && !$_CLASS['auth']->acl_get('f_delete', $forum_id))
+if ($mode == 'delete' && $posting_data['poster_id'] != $_CLASS['core_user']->data['user_id'] && !$_CLASS['auth']->acl_get('f_delete', $forum_id))
 {
 	trigger_error('DELETE_OWN_POSTS');
 }
 
-if ($mode == 'delete' && $poster_id == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id) && $post_id != $topic_last_post_id)
+if ($mode == 'delete' && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id) && $post_id != $topic_last_post_id)
 {
 	trigger_error('CANNOT_DELETE_REPLIED');
 }
@@ -386,7 +403,6 @@
 	trigger_error('USER_CANNOT_DELETE');
 }
 
-
 // HTML, BBCode, Smilies, Images and Flash status
 $html_status	= ($config['allow_html'] && $_CLASS['auth']->acl_get('f_html', $forum_id));
 $bbcode_status	= ($config['allow_bbcode'] && $_CLASS['auth']->acl_get('f_bbcode', $forum_id));
@@ -423,7 +439,7 @@
 
 	markread('topic', $forum_id, $topic_id, $current_time);
 
-	add_log('mod', $forum_id, $topic_id, sprintf($_CLASS['core_user']->lang['LOGM_BUMP'], $topic_title));
+	add_log('mod', $forum_id, $topic_id, sprintf($_CLASS['core_user']->lang['LOGM_BUMP'], $posting_data['topic_title']));
 
 	$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$topic_last_post_id#$topic_last_post_id"));
 
@@ -440,7 +456,7 @@
 if ($save && $_CLASS['core_user']->is_user && $_CLASS['auth']->acl_get('u_savedrafts'))
 {
 	$subject = request_var('subject', '', true);
-	$subject = (!$subject && $mode != 'post') ? $topic_title : $subject;
+	$subject = (!$subject && $mode != 'post') ? $posting_data['topic_title'] : $subject;
 	$message = request_var('message', '', true);
 
 	if ($subject && $message)
@@ -494,8 +510,8 @@
 	
 	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$_REQUEST['subject'] = html_entity_decode($row['draft_subject'],HTML_ENTITIES);
-		$_REQUEST['message'] = html_entity_decode($row['draft_message'],HTML_ENTITIES);
+		$_REQUEST['subject'] = html_entity_decode($row['draft_subject'], HTML_ENTITIES);
+		$_REQUEST['message'] = html_entity_decode($row['draft_message'], HTML_ENTITIES);
 
 		$refresh = true;
 		$_CLASS['core_template']->assign('S_DRAFT_LOADED', true);
@@ -514,35 +530,29 @@
 
 if ($submit || $preview || $refresh)
 {
-	$topic_cur_post_id	= request_var('topic_cur_post_id', 0);
+	$posting_data['post_edit_reason'] = ($mode == 'edit' && isset($_POST['edit_reason']) && !empty($_POST['edit_reason']) && $_CLASS['core_user']->data['user_id'] != $posting_data['poster_id']) ? get_variable('edit_reason', 'POST', '') : '';
+	$posting_data['topic_type'] = isset($_POST['topic_type']) ? (int) $_POST['topic_type'] : (($mode != 'post') ? $posting_data['topic_type'] : POST_NORMAL);
 
-	$subject = request_var('subject', '', true);
+	$topic_cur_post_id	= get_variable('topic_cur_post_id', 'POST', 0, 'int');
 
-	if (strcmp($subject, strtoupper($subject)) == 0 && $subject)
-	{
-		$subject = strtolower($subject);
-	}
-	
-	$message_parser->message = request_var('message', '', true);
+	$subject = mb_strtolower(get_variable('subject', 'POST', ''));
+	$message_parser->message = get_variable('message', 'POST', '');
 
-	$username			= (isset($_POST['username'])) ? request_var('username', '') : $username;
-	$post_edit_reason	= (isset($_POST['edit_reason']) && !empty($_POST['edit_reason']) && $mode == 'edit' && $_CLASS['core_user']->data['user_id'] != $poster_id) ? request_var('edit_reason', '') : '';
 
-	$topic_type			= (isset($_POST['topic_type'])) ? (int) $_POST['topic_type'] : (($mode != 'post') ? $topic_type : POST_NORMAL);
 	$topic_time_limit	= (isset($_POST['topic_time_limit'])) ? (int) $_POST['topic_time_limit'] : (($mode != 'post') ? $topic_time_limit : 0);
-	$icon_id			= request_var('icon', 0);
+	$icon_id			= get_variable('icon', 'POST', 0, 'int');
 
 	$enable_html 		= (!$html_status || isset($_POST['disable_html'])) ? false : true;
 	$enable_bbcode 		= (!$bbcode_status || isset($_POST['disable_bbcode'])) ? false : true;
 	$enable_smilies		= (!$smilies_status || isset($_POST['disable_smilies'])) ? false : true;
-	$enable_urls 		= (isset($_POST['disable_magic_url'])) ? 0 : 1;
+	$enable_urls 		= isset($_POST['disable_magic_url']) ? 0 : 1;
 	$enable_sig			= (!$config['allow_sig']) ? false : (($_CLASS['core_user']->is_user && isset($_POST['attach_sig'])) ? true : false);
 
-	$notify				= (isset($_POST['notify']));
-	$topic_lock			= (isset($_POST['lock_topic']));
-	$post_lock			= (isset($_POST['lock_post']));
+	$notify				= isset($_POST['notify']);
+	$topic_lock			= isset($_POST['lock_topic']);
+	$post_lock			= isset($_POST['lock_post']);
 
-	$poll_delete		= (isset($_POST['poll_delete']));
+	$poll_delete		= isset($_POST['poll_delete']);
 	
 	// Faster than crc32
 	if ($submit)
@@ -557,7 +567,7 @@
 
 	// Delete Poll
 	if ($poll_delete && $mode == 'edit' && $poll_options && 
-		((!$poll_last_vote && $poster_id == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id)))
+		((!$poll_last_vote && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id)))
 	{
 		switch (SQL_LAYER)
 		{
@@ -663,31 +673,29 @@
 		{
 			if ($last_post_time && ($current_time - $last_post_time) < intval($config['flood_interval']))
 			{
-				$error[] = $_CLASS['core_user']->lang['FLOOD_ERROR'];
+				$error[] = $_CLASS['core_user']->get_lang('FLOOD_ERROR');
 			}
 		}
 	}
 
 	// Validate username
-	if (($username && !$_CLASS['core_user']->is_user) || ($mode == 'edit' && $post_username))
+	if (($posting_data['username'] && !$_CLASS['core_user']->is_user) || ($mode == 'edit' && (!$posting_data['poster_id'] || $posting_data['poster_id'] == ANONYMOUS)))
 	{
-		require($site_file_root.'includes/forums/functions_user.php');
-		
-		if (($result = validate_username(($mode == 'edit' && $post_username) ? $post_username : $username)) != false)
+		require_once($site_file_root.'includes/functions_user.php');
+		$result = validate_username($posting_data['username']);
+
+		if ($result !== true)
 		{
-			if ((!$result == 'USERNAME_TAKEN') || ($result == 'USERNAME_TAKEN' && !$_CLASS['auth']->acl_get('m_edit', $forum_id)))
-			{
-				$error[] = $result;
-			}
+			$error[] = $result;
 		}
 	}
 
 	// Parse subject
-	if (!$subject && ($mode == 'post' || ($mode == 'edit' && $topic_first_post_id == $post_id)))
+	if (!$subject && ($mode == 'post' || ($mode == 'edit' && $posting_data['topic_first_post_id'] == $posting_data['post_id'])))
 	{
-		$error[] = $_CLASS['core_user']->lang['EMPTY_SUBJECT'];
+		$error[] = $_CLASS['core_user']->get_lang('EMPTY_SUBJECT');
 	}
-	
+
 	$poll_last_vote = (isset($poll_last_vote)) ? $poll_last_vote : 0;
 
 	if ($poll_option_text && 
@@ -725,19 +733,22 @@
 	}
 
 	// Check topic type
-	if ($topic_type != POST_NORMAL && ($mode == 'post' || ($mode == 'edit' && $topic_first_post_id == $post_id)))
+	if ($posting_data['topic_type'] != POST_NORMAL && ($mode == 'post' || ($mode == 'edit' && $posting_data['topic_first_post_id'] == $posting_data['post_id'])))
 	{
-		switch ($topic_type)
+		switch ($posting_data['topic_type'])
 		{
 			case POST_GLOBAL:
 			case POST_ANNOUNCE:
 				$auth_option = 'f_announce';
-				break;
+			break;
+
 			case POST_STICKY:
 				$auth_option = 'f_sticky';
-				break;
+			break;
+
 			default:
 				$auth_option = '';
+			break;	
 		}
 
 		if (!$_CLASS['auth']->acl_get($auth_option, $forum_id))
@@ -752,10 +763,10 @@
 	}
 
 	// Store message, sync counters
-	if (!sizeof($error) && $submit)
+	if (empty($error) && $submit)
 	{
 		// Check if we want to de-globalize the topic... and ask for new forum
-		if ($topic_type != POST_GLOBAL)
+		if ($posting_data['topic_type'] != POST_GLOBAL)
 		{
 			$sql = 'SELECT topic_type, forum_id
 				FROM ' . FORUMS_TOPICS_TABLE . "
@@ -788,21 +799,23 @@
 		if ($submit)
 		{
 			// Lock/Unlock Topic
-			$change_topic_status = $topic_status;
+			$change_topic_status = $posting_data['topic_status'];
 			$perm_lock_unlock = ($_CLASS['auth']->acl_get('m_lock', $forum_id) || ($_CLASS['auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_id'] == $topic_poster));
 
-			if ($topic_status == ITEM_LOCKED && !$topic_lock && $perm_lock_unlock)
+			if ($posting_data['topic_status'] == ITEM_LOCKED && !$topic_lock && $perm_lock_unlock)
 			{
 				$change_topic_status = ITEM_UNLOCKED;
 			}
-			else if ($topic_status == ITEM_UNLOCKED && $topic_lock && $perm_lock_unlock)
+			else if ($posting_data['topic_status'] == ITEM_UNLOCKED && $topic_lock && $perm_lock_unlock)
 			{
 				$change_topic_status = ITEM_LOCKED;
 			}
 		
-			if ($change_topic_status != $topic_status)
+			if ($change_topic_status != $posting_data['topic_status'])
 			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . "
+				$posting_data['topic_status'] = $change_topic_status;
+
+				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . "
 					SET topic_status = $change_topic_status
 					WHERE topic_id = $topic_id
 						AND topic_moved_id = 0";
@@ -810,21 +823,21 @@
 			
 				$user_lock = ($_CLASS['auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_id'] == $topic_poster) ? 'USER_' : '';
 
-				add_log('mod', $forum_id, $topic_id, 'LOG_' . $user_lock . (($change_topic_status == ITEM_LOCKED) ? 'LOCK' : 'UNLOCK'), $topic_title);
+				//add_log('mod', $forum_id, $topic_id, 'LOG_' . $user_lock . (($change_topic_status == ITEM_LOCKED) ? 'LOCK' : 'UNLOCK'), $posting_data['topic_title']);
 			}
 
 			// Lock/Unlock Post Edit
-			if ($mode == 'edit' && $post_edit_locked == ITEM_LOCKED && !$post_lock && $_CLASS['auth']->acl_get('m_edit', $forum_id))
+			if ($mode == 'edit' && $posting_data['post_edit_locked'] == ITEM_LOCKED && !$post_lock && $_CLASS['auth']->acl_get('m_edit', $forum_id))
 			{
-				$post_edit_locked = ITEM_UNLOCKED;
+				$posting_data['post_edit_locked'] = ITEM_UNLOCKED;
 			}
-			else if ($mode == 'edit' && $post_edit_locked == ITEM_UNLOCKED && $post_lock && $_CLASS['auth']->acl_get('m_edit', $forum_id))
+			else if ($mode == 'edit' && $posting_data['post_edit_locked'] == ITEM_UNLOCKED && $post_lock && $_CLASS['auth']->acl_get('m_edit', $forum_id))
 			{
-				$post_edit_locked = ITEM_LOCKED;
+				$posting_data['post_edit_locked'] = ITEM_LOCKED;
 			}
 
 			$post_data = array(
-				'topic_title'			=> (!$topic_title) ? $subject : $topic_title,
+				'topic_title'			=> (!$posting_data['topic_title']) ? $subject : $posting_data['topic_title'],
 				'topic_first_post_id'	=> (isset($topic_first_post_id)) ? (int) $topic_first_post_id : 0,
 				'topic_last_post_id'	=> (isset($topic_last_post_id)) ? (int) $topic_last_post_id : 0,
 				'topic_time_limit'		=> (int) $topic_time_limit,
@@ -832,7 +845,7 @@
 				'topic_id'				=> (int) $topic_id,
 				'forum_id'				=> (int) $forum_id,
 				'icon_id'				=> (int) $icon_id,
-				'poster_id'				=> (int) $poster_id,
+				'poster_id'				=> (int) $posting_data['poster_id'],
 				'enable_sig'			=> (bool) $enable_sig,
 				'enable_bbcode'			=> (bool) $enable_bbcode,
 				'enable_html' 			=> (bool) $enable_html,
@@ -840,17 +853,16 @@
 				'enable_urls'			=> (bool) $enable_urls,
 				'enable_indexing'		=> (bool) $enable_indexing,
 				'message_md5'			=> (string) $message_md5,
-				'post_time'				=> (isset($post_time)) ? (int) $post_time : $current_time,
+				'post_time'				=> ($posting_data['post_time']) ? (int) $posting_data['post_time'] : $current_time,
 				'post_checksum'			=> (isset($post_checksum)) ? (string) $post_checksum : '',
-				'post_edit_reason'		=> $post_edit_reason,
+				'post_edit_reason'		=> $posting_data['post_edit_reason'],
 				'post_edit_user'		=> ($mode == 'edit') ? $_CLASS['core_user']->data['user_id'] : ((isset($post_edit_user)) ? (int) $post_edit_user : 0),
 				'forum_parents'			=> $forum_parents,
 				'forum_name'			=> $forum_name,
 				'notify'				=> $notify,
 				'notify_set'			=> $notify_set,
 				'poster_ip'				=> (isset($poster_ip)) ? (int) $poster_ip : $_CLASS['core_user']->ip,
-				'post_edit_locked'		=> (int) $post_edit_locked,
-				'post_edit_locked'		=> (int) $post_edit_locked,
+				'post_edit_locked'		=> (int) $posting_data['post_edit_locked'],
 				'bbcode_bitfield'		=> (int) $message_parser->bbcode_bitfield,
 				'bbcode_uid'			=> $message_parser->bbcode_uid,
 				'message'				=> $message_parser->message,
@@ -859,7 +871,7 @@
 			);
 			unset($message_parser);
 			
-			submit_post($mode, $subject, $username, $topic_type, $poll, $post_data, $update_message);
+			submit_post($mode, $subject, $posting_data['username'], $posting_data['topic_type'], $poll, $post_data, $update_message);
 		}
 	}	
 
@@ -869,7 +881,7 @@
 // Preview
 if (!sizeof($error) && $preview)
 {
-	$post_time = ($mode == 'edit') ? $post_time : $current_time;
+	$posting_data['post_time'] = ($mode == 'edit') ? $posting_data['post_time'] : $current_time;
 
 	$preview_message = $message_parser->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
 
@@ -972,6 +984,7 @@
 
 if ($mode == 'quote' && !$preview && !$refresh)
 {
+	$quote_username = isset($posting_data['username']) ? $posting_data['username'] : (isset($posting_data['post_username']) ? $posting_data['post_username'] : '');
 	$message_parser->message = '[quote="' . $quote_username . '"]' . censor_text(trim($message_parser->message)) . "[/quote]\n";
 }
 
@@ -1014,7 +1027,7 @@
 
 if ($mode == 'post' || ($mode == 'edit' && $post_id == $topic_first_post_id))
 {
-	$topic_type_toggle = posting_gen_topic_types($forum_id, $topic_type);
+	$topic_type_toggle = posting_gen_topic_types($forum_id, $posting_data['topic_type']);
 }
 
 $s_topic_icons = false;
@@ -1032,8 +1045,8 @@
 $urls_checked		= (isset($enable_urls)) ? !$enable_urls : 0;
 $sig_checked		= $enable_sig;
 $notify_checked		= (isset($notify)) ? $notify : ((!$notify_set) ? (($_CLASS['core_user']->is_user) ? $_CLASS['core_user']->data['user_notify'] : 0) : 1);
-$lock_topic_checked	= (isset($topic_lock)) ? $topic_lock : (($topic_status == ITEM_LOCKED) ? 1 : 0);
-$lock_post_checked	= (isset($post_lock)) ? $post_lock : $post_edit_locked;
+$lock_topic_checked	= (isset($topic_lock)) ? $topic_lock : (($posting_data['topic_status'] == ITEM_LOCKED) ? 1 : 0);
+$lock_post_checked	= isset($post_lock) ? $post_lock : $posting_data['post_edit_locked'];
 
 // Page title & action URL, include session_id for security purpose
 $s_action = "Forums&amp;file=posting&amp;mode=$mode&amp;f=$forum_id";
@@ -1064,7 +1077,7 @@
 	'forum_parents'	=> $forum_parents,
 	'forum_name'	=> $forum_name,
 	'forum_id'		=> $forum_id,
-	'forum_type'	=> $forum_type,
+	'forum_type'	=> $posting_data['forum_type'],
 	'forum_desc'	=> $forum_desc,
 	'forum_rules'	=> $forum_rules,
 	'forum_rules_flags' => $forum_rules_flags,
@@ -1092,9 +1105,9 @@
 	
 	'FORUM_NAME' 			=> $forum_name,
 	'FORUM_DESC'			=> ($forum_desc) ? strip_tags($forum_desc) : '',
-	'TOPIC_TITLE' 			=> $topic_title,
+	'TOPIC_TITLE' 			=> $posting_data['topic_title'],
 	'MODERATORS' 			=> (sizeof($moderators)) ? implode(', ', $moderators[$forum_id]) : '',
-	'USERNAME'				=> ((!$preview && $mode != 'quote') || $preview) ? stripslashes($username) : '',
+	'USERNAME'				=> ((!$preview && $mode != 'quote') || $preview) ? $posting_data['username'] : '',
 	'SUBJECT'				=> $post_subject,
 	'MESSAGE'				=> $post_text,
 	'HTML_STATUS'			=> ($html_status) ? $_CLASS['core_user']->lang['HTML_IS_ON'] : $_CLASS['core_user']->lang['HTML_IS_OFF'],
@@ -1103,19 +1116,19 @@
 	'FLASH_STATUS'			=> ($flash_status) ? $_CLASS['core_user']->lang['FLASH_IS_ON'] : $_CLASS['core_user']->lang['FLASH_IS_OFF'],
 	'SMILIES_STATUS'		=> ($smilies_status) ? $_CLASS['core_user']->lang['SMILIES_ARE_ON'] : $_CLASS['core_user']->lang['SMILIES_ARE_OFF'],
 	'MINI_POST_IMG'			=> $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['POST']),
-	'POST_DATE'				=> ($post_time) ? $_CLASS['core_user']->format_date($post_time) : '',
+	'POST_DATE'				=> ($posting_data['post_time']) ? $_CLASS['core_user']->format_date($posting_data['post_time']) : '',
 	'ERROR'					=> (sizeof($error)) ? implode('<br />', $error) : '', 
 	'TOPIC_TIME_LIMIT'		=> (int) $topic_time_limit,
-	'EDIT_REASON'			=> $post_edit_reason,
+	'EDIT_REASON'			=> $posting_data['post_edit_reason'],
 
 	'U_VIEW_FORUM' 			=> generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id),
 	'U_VIEWTOPIC' 			=> ($mode != 'post') ? generate_link("Forums&amp;file=viewtopic&amp;$forum_id&amp;t=$topic_id") : '',
 
 	'S_EDIT_POST'			=> ($mode == 'edit'),
-	'S_EDIT_REASON'			=> ($mode == 'edit' && $_CLASS['core_user']->data['user_id'] != $poster_id),
+	'S_EDIT_REASON'			=> ($mode == 'edit' && $_CLASS['core_user']->data['user_id'] != $posting_data['poster_id']),
 	'S_DISPLAY_USERNAME'	=> (!$_CLASS['core_user']->is_user || ($mode == 'edit' && $post_username)),
 	'S_SHOW_TOPIC_ICONS'	=> $s_topic_icons,
-	'S_DELETE_ALLOWED' 		=> ($mode == 'edit' && (($post_id == $topic_last_post_id && $poster_id == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id))),
+	'S_DELETE_ALLOWED' 		=> ($mode == 'edit' && (($post_id == $topic_last_post_id && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id))),
 	'S_HTML_ALLOWED'		=> $html_status,
 	'S_HTML_CHECKED' 		=> ($html_checked) ? ' checked="checked"' : '',
 	'S_BBCODE_ALLOWED'		=> $bbcode_status,
@@ -1147,7 +1160,7 @@
 	$_CLASS['core_template']->assign_array(array(
 		'S_SHOW_POLL_BOX'		=> true,
 		'S_POLL_VOTE_CHANGE'    => ($_CLASS['auth']->acl_get('f_votechg', $forum_id)),
-		'S_POLL_DELETE'			=> ($mode == 'edit' && $poll_options && ((!$poll_last_vote && $poster_id == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id))),
+		'S_POLL_DELETE'			=> ($mode == 'edit' && $poll_options && ((!$poll_last_vote && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id))),
 
 		'L_POLL_OPTIONS_EXPLAIN'=> sprintf($_CLASS['core_user']->lang['POLL_OPTIONS_EXPLAIN'], $config['max_poll_options']),
 		'VOTE_CHANGE_CHECKED'   => (isset($poll_vote_change) && $poll_vote_change) ? ' checked="checked"' : '',
@@ -1213,17 +1226,20 @@
 	if (!delete_posts('post_id', array($post_id), false))
 	{
 		// Try to delete topic, we may had an previous error causing inconsistency
+		/*
 		if ($post_mode = 'delete_topic')
 		{
 			delete_topics('topic_id', array($topic_id), false);
 		}
+		*/
 		trigger_error('ALREADY_DELETED');
 	}
 
 	$_CLASS['core_db']->transaction('commit');
 
 	// Collect the necessary informations for updating the tables
-	$sql_data[FORUMS_TABLE] = '';
+	$sql_data[FORUMS_FORUMS_TABLE] = '';
+
 	switch ($post_mode)
 	{
 		case 'delete_topic':
@@ -1232,18 +1248,18 @@
 
 			if ($data['topic_type'] != POST_GLOBAL)
 			{
-				$sql_data[FORUMS_TABLE] .= 'forum_posts = forum_posts - 1, forum_topics_real = forum_topics_real - 1';
-				$sql_data[FORUMS_TABLE] .= ($data['topic_approved']) ? ', forum_topics = forum_topics - 1' : '';
+				$sql_data[FORUMS_FORUMS_TABLE] .= 'forum_posts = forum_posts - 1, forum_topics_real = forum_topics_real - 1';
+				$sql_data[FORUMS_FORUMS_TABLE] .= ($data['topic_approved']) ? ', forum_topics = forum_topics - 1' : '';
+				$sql_data[FORUMS_FORUMS_TABLE] .= ', ';
 			}
 
-			$sql_data[FORUMS_TABLE] .= ($sql_data[FORUMS_TABLE]) ? ', ' : '';
-			$sql_data[FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
-			$sql_data[TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+			$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 			break;
 
 		case 'delete_first_post':
 			$sql = 'SELECT p.post_id, p.poster_id, p.post_username, u.username 
-				FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . " u
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_USERS_TABLE . " u
 				WHERE p.topic_id = $topic_id 
 					AND p.poster_id = u.user_id 
 				ORDER BY p.post_time ASC";
@@ -1254,11 +1270,11 @@
 
 			if ($data['topic_type'] != POST_GLOBAL)
 			{
-				$sql_data[FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
+				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
 			}
 
-			$sql_data[TOPICS_TABLE] = 'topic_first_post_id = ' . intval($row['post_id']) . ", topic_first_poster_name = '" . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']->sql_escape($row['post_username']) : $_CLASS['core_db']->sql_escape($row['username'])) . "'";
-			$sql_data[TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_first_post_id = ' . intval($row['post_id']) . ", topic_first_poster_name = '" . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']->sql_escape($row['post_username']) : $_CLASS['core_db']->sql_escape($row['username'])) . "'";
+			$sql_data[FORUMS_TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 
 			$next_post_id = (int) $row['post_id'];
 			break;
@@ -1266,23 +1282,23 @@
 		case 'delete_last_post':
 			if ($data['topic_type'] != POST_GLOBAL)
 			{
-				$sql_data[FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
+				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
 			}
 
-			$sql_data[FORUMS_TABLE] .= ($sql_data[FORUMS_TABLE]) ? ', ' : '';
-			$sql_data[FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
-			$sql_data[TOPICS_TABLE] = 'topic_bumped = 0, topic_bumper = 0, topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+			$sql_data[FORUMS_FORUMS_TABLE] .= ($sql_data[FORUMS_FORUMS_TABLE]) ? ', ' : '';
+			$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_bumped = 0, topic_bumper = 0, topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 
 			$update = update_last_post_information('topic', $topic_id);
 			if (sizeof($update))
 			{
-				$sql_data[TOPICS_TABLE] .= ', ' . implode(', ', $update);
+				$sql_data[FORUMS_TOPICS_TABLE] .= ', ' . implode(', ', $update);
 				$next_post_id = (int) str_replace('topic_last_post_id = ', '', $update[0]);
 			}
 			else
 			{
 				$sql = 'SELECT MAX(post_id) as last_post_id
-					FROM ' . POSTS_TABLE . "
+					FROM ' . FORUMS_POSTS_TABLE . "
 					WHERE topic_id = $topic_id " .
 						((!$_CLASS['auth']->acl_get('m_approve')) ? 'AND post_approved = 1' : '');
 				$result = $_CLASS['core_db']->query($sql);
@@ -1295,7 +1311,7 @@
 			
 		case 'delete':
 			$sql = 'SELECT post_id
-				FROM ' . POSTS_TABLE . "
+				FROM ' . FORUMS_POSTS_TABLE . "
 				WHERE topic_id = $topic_id " . 
 					((!$_CLASS['auth']->acl_get('m_approve')) ? 'AND post_approved = 1' : '') . '
 					AND post_time > ' . $data['post_time'] . '
@@ -1307,10 +1323,10 @@
 
 			if ($data['topic_type'] != POST_GLOBAL)
 			{
-				$sql_data[FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
+				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
 			}
 
-			$sql_data[TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 			$next_post_id = (int) $row['post_id'];
 	}
 				
@@ -1319,7 +1335,7 @@
 
 	$_CLASS['core_db']->transaction();
 
-	$where_sql = array(FORUMS_TABLE => "forum_id = $forum_id", TOPICS_TABLE => "topic_id = $topic_id", USERS_TABLE => 'user_id = ' . $data['poster_id']);
+	$where_sql = array(FORUMS_FORUMS_TABLE => "forum_id = $forum_id", FORUMS_TOPICS_TABLE => "topic_id = $topic_id", USERS_TABLE => 'user_id = ' . $data['poster_id']);
 
 	foreach ($sql_data as $table => $update_sql)
 	{
@@ -1423,7 +1439,7 @@
 				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array();
 			}
 
-			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[POSTS_TABLE]['sql'], array(
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
 				'forum_id' 			=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
 				'poster_id' 		=> $data['poster_id'],
 				'icon_id'			=> $data['icon_id'],

Modified: trunk/modules/Forums/viewforum.php
===================================================================
--- trunk/modules/Forums/viewforum.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/modules/Forums/viewforum.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -1,16 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: viewforum.php,v 1.254 2004/10/13 19:30:02 acydburn Exp $
@@ -174,14 +184,15 @@
 		}
 	}
 
-	// Forum rules amd subscription info
-	$s_watching_forum = $s_watching_forum_img = array();
-	$s_watching_forum['link'] = $s_watching_forum['title'] = '';
-	if (($config['email_enable'] || $config['jab_enable']) && $config['allow_forum_notify'] && $_CLASS['auth']->acl_get('f_subscribe', $forum_id))
+	if ($_CLASS['auth']->acl_get('f_subscribe', $forum_id))
 	{
 		$notify_status = (isset($forum_data['notify_status'])) ? $forum_data['notify_status'] : NULL;
-		watch_topic_forum('forum', $s_watching_forum, $s_watching_forum_img, $_CLASS['core_user']->data['user_id'], $forum_id, $notify_status);
+		$s_watching_forum = watch_topic_forum('forum', $_CLASS['core_user']->data['user_id'], $forum_id, $notify_status);
 	}
+	else
+	{
+		$s_watching_forum['link'] = $s_watching_forum['title'] = '';
+	}
 
 	gen_forum_auth_level('forum', $forum_id);
 
@@ -204,7 +215,7 @@
 		$sql = 'SELECT COUNT(topic_id) AS num_topics
 			FROM ' . FORUMS_TOPICS_TABLE . "
 			WHERE forum_id = $forum_id
-				AND topic_type <> " . POST_ANNOUNCE . "  
+				AND topic_type <> " . POST_ANNOUNCE . " 
 				AND topic_last_post_time >= $min_post_time
 			" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND topic_approved = 1');
 		$result = $_CLASS['core_db']->query($sql);
@@ -292,7 +303,7 @@
 	if ($forum_data['forum_type'] == FORUM_POST)
 	{
 		// Obtain announcements ... removed sort ordering, sort by time in all cases
-		$sql = "SELECT t.* $sql_select 
+		$sql = "SELECT DISTINCT t.* $sql_select 
 			FROM $sql_from 
 			WHERE t.forum_id IN ($forum_id, 0)
 				AND t.topic_type IN (" . POST_ANNOUNCE . ', ' . POST_GLOBAL . ')
@@ -310,6 +321,7 @@
 	// If the user is trying to reach late pages, start searching from the end
 	$store_reverse = false;
 	$sql_limit = $config['topics_per_page'];
+
 	if ($start > $topics_count / 2)
 	{
 		$store_reverse = true;
@@ -350,8 +362,9 @@
 
 	$topic_list = ($store_reverse) ? array_merge($announcement_list, array_reverse($topic_list)) : array_merge($announcement_list, $topic_list);
 
-	// set to true so we can test .. we only update the mark if this is made into an (int) time
-	$mark_forum_read = true;
+	// we only update the mark if this is made into an (int) time
+	// We don't check when $start is used
+	$mark_forum_read = ($start) ? false : true;
 
 	// Okay, lets dump out the page ...
 	if (sizeof($topic_list))

Modified: trunk/modules/Forums/viewtopic.php
===================================================================
--- trunk/modules/Forums/viewtopic.php	2005-08-29 01:58:04 UTC (rev 93)
+++ trunk/modules/Forums/viewtopic.php	2005-08-30 17:36:52 UTC (rev 94)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 // -------------------------------------------------------------
@@ -150,7 +152,7 @@
 {
 	$extra_fields .= ', tw.notify_status';
 	$join_sql_table .= ' LEFT JOIN ' . FORUMS_WATCH_TABLE . ' tw ON (tw.user_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-		AND tw.forum_id = $forum_id AND tw.topic_id IN ($topic_id, 0) )";
+		AND (tw.forum_id = $forum_id OR tw.topic_id = $topic_id))";
 
 	if ($config['allow_bookmarks'])
 	{
@@ -179,8 +181,6 @@
 	trigger_error('NO_TOPIC');
 }
 
-$topic_data['notify_status'] = isset($topic_data['notify_status']) ? $topic_data['notify_status'] : 0;
-
 //Check for read permission
 if (!$_CLASS['auth']->acl_get('f_read', $forum_id) && !$_CLASS['auth']->acl_get('m_', $forum_id))
 {
@@ -193,6 +193,7 @@
 }
 
 // Are we watching this topic?
+$topic_data['notify_status'] = isset($topic_data['notify_status']) ? $topic_data['notify_status'] : null;
 $s_watching_topic = watch_topic_forum('topic', $_CLASS['core_user']->data['user_id'], $topic_id, $topic_data['notify_status'], $start);
 
 // Bookmarks
@@ -592,7 +593,7 @@
 	trigger_error($_CLASS['core_user']->lang['NO_TOPIC']);
 }
 
-$sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_posts, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_jabber, u.user_regdate, u.user_msnm, u.user_allow_viewemail, u.user_allow_viewonline, u.user_rank, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height, z.friend, z.foe, p.*
+$sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_posts, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_jabber, u.user_reg_date, u.user_msnm, u.user_allow_viewemail, u.user_allow_viewonline, u.user_rank, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height, z.friend, z.foe, p.*
 	FROM ' . FORUMS_POSTS_TABLE . ' p
 	LEFT JOIN ' . ZEBRA_TABLE . ' z ON (z.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' AND z.zebra_id = p.poster_id), ' . USERS_TABLE . ' u
 	WHERE p.post_id IN (' . implode(', ', $post_list) . ')
@@ -712,7 +713,7 @@
 			$id_cache[] = $poster_id;
 
 			$user_cache[$poster_id] = array(
-				'joined'				=> $_CLASS['core_user']->format_date($row['user_regdate'], $_CLASS['core_user']->lang['DATE_FORMAT']),
+				'joined'				=> $_CLASS['core_user']->format_date($row['user_reg_date'], $_CLASS['core_user']->lang['DATE_FORMAT']),
 				'posts'					=> $row['user_posts'],
 				'from'					=> $row['user_from'],
 				'sig'					=> $user_sig,



From viperal at berlios.de  Wed Aug 31 16:26:27 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 31 Aug 2005 16:26:27 +0200
Subject: [Viperals-svncheckins] r95 - in trunk: blocks includes includes/db includes/display install modules/Quick_Message
Message-ID: <200508311426.j7VEQRqq028178@sheep.berlios.de>

Author: viperal
Date: 2005-08-31 16:26:25 +0200 (Wed, 31 Aug 2005)
New Revision: 95

Modified:
   trunk/blocks/block-Quick_Message.php
   trunk/includes/db/postgres.php
   trunk/includes/display/display.php
   trunk/includes/session.php
   trunk/install/build_data.php
   trunk/install/build_tables.php
   trunk/modules/Quick_Message/index.php
Log:


Modified: trunk/blocks/block-Quick_Message.php
===================================================================
--- trunk/blocks/block-Quick_Message.php	2005-08-30 17:36:52 UTC (rev 94)
+++ trunk/blocks/block-Quick_Message.php	2005-08-31 14:26:25 UTC (rev 95)
@@ -39,8 +39,12 @@
 
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES, 'UTF-8'));
-	//$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES));
+	/*
+		php 4 doesn't support mb html_entity_decode :-(
+		Make a core function for this
+	*/
+	//$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES, 'UTF-8'));
+	$words_array = explode(' ', $row['message_text']);
 
 	$row['message_text'] = '';
 
@@ -64,6 +68,8 @@
 	
 	if ($row['poster_name'])
 	{
+		$row['poster_name'] = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');
+
 		if ($row['poster_id']) 
 		{
 			$this->content .= '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']).'"><b>' . $row['poster_name'] . ': </b></a>';

Modified: trunk/includes/db/postgres.php
===================================================================
--- trunk/includes/db/postgres.php	2005-08-30 17:36:52 UTC (rev 94)
+++ trunk/includes/db/postgres.php	2005-08-31 14:26:25 UTC (rev 95)
@@ -28,7 +28,7 @@
 
 	var $last_result;
 	var $return_on_error;
-	var $in_transaction;
+	var $in_transaction = false;
 
 	var $queries_time = 0;
 	var $num_queries = 0;
@@ -80,7 +80,7 @@
 
 		if ($this->link_identifier)
 		{
-			pg_set_client_encoding($this->link_identifier, 'UNICODE');
+			//pg_set_client_encoding($this->link_identifier, 'UNICODE');
 			//pg_set_client_encoding($this->link_identifier, 'UTF8');  pg8.1 unicode still works tho
 
 			//pg_query($this->link_identifier, "SET CLIENT_ENCODING TO 'value'"); SET NAMES 'value'
@@ -123,7 +123,7 @@
 					break;
 				}
 
-				$result = @pg_query($this->db_connect_id, 'BEGIN');
+				$result = pg_query($this->link_identifier, 'START TRANSACTION');
 				$this->in_transaction = true;
 			break;
 
@@ -134,11 +134,11 @@
 					break;
 				}
 
-				$result = @pg_query($this->db_connect_id, 'COMMIT');
+				$result = pg_query($this->link_identifier, 'COMMIT');
 				
 				if (!$result && $auto_rollback)
 				{
-					@pg_query($this->db_connect_id, 'ROLLBACK');
+					pg_query($this->link_identifier, 'ROLLBACK');
 				}
 				
 				$this->in_transaction = false;
@@ -150,7 +150,7 @@
 					break;
 				}
 
-				$result = @pg_query($this->db_connect_id, 'ROLLBACK');
+				$result = pg_query($this->link_identifier, 'ROLLBACK');
 				$this->in_transaction = false;
 			break;
 		}
@@ -533,7 +533,7 @@
 
 				$fields = implode(", \n", $this->_fields);
 
-				if ($this->_indexs['primary'])
+				if (isset($this->_indexs['primary']))
 				{
 					$fields .= ", \n".$this->_indexs['primary'];
 					unset($this->_indexs['primary']);
@@ -550,7 +550,10 @@
 					return $table;
 				}
 
-				$this->sql_query($table);
+				if (!$this->sql_query($table))
+				{
+				echo $table.'<br/>';
+				}
 
 			case 'cancel':
 				$this->_table_name = $this->_table_oid = false;
@@ -608,7 +611,7 @@
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = $this->_table_name.'_'.(($index_name) ? $index_name : $field) ;
-		$field = is_array($field) ? implode('` , `', $field) : $field;
+		$field = is_array($field) ? implode(', ', $field) : $field;
 
 		switch ($type)
 		{

Modified: trunk/includes/display/display.php
===================================================================
--- trunk/includes/display/display.php	2005-08-30 17:36:52 UTC (rev 94)
+++ trunk/includes/display/display.php	2005-08-31 14:26:25 UTC (rev 95)
@@ -291,7 +291,7 @@
 	{
 		global $_CLASS;
 
-		$this->header['meta'] .= '<meta http-equiv="refresh" content="' . $time . ';url=' . (($url) ? $url : generate_link(array('full' => true))) . '">';
+		$this->header['meta'] .= '<meta http-equiv="refresh" content="' . $time . ';url=' . (($url) ? $url : generate_link(false, array('full' => true))) . '">';
 	}
 }
 

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-30 17:36:52 UTC (rev 94)
+++ trunk/includes/session.php	2005-08-31 14:26:25 UTC (rev 95)
@@ -180,6 +180,7 @@
 			'session_page'		=> (string) $this->page, // need to be added back
 			'session_url'		=> (string) $this->url,
 			'session_ip'		=> (string) $this->ip,
+			'session_last_visit'=> (int) $this->data['session_last_visit'],
 			'session_user_type'	=> (int) $this->data['user_type'],
 			'session_admin'		=> (int) $this->data['session_admin'],
 			'session_auth'		=> (int) serialize($_CLASS['core_auth']->auth_dump()),
@@ -265,7 +266,7 @@
 			$sql = 'UPDATE ' . SESSIONS_AUTOLOGIN_TABLE . '	SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data_array) . "
 						WHERE user_id = $user_id
 						AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			// need to update both the code and the user_id,
 			// since user_id cookie has an expiry time
@@ -316,36 +317,64 @@
 
 	function gc($time)
 	{
-// Move to cron		
+// Move to cron
+		if (!is_numeric($time))
+		{
+			return;
+		}
+
 		global $_CORE_CONFIG, $_CLASS;
 
-/*
-		// keep the next query less demanding
+		$_CLASS['core_db']->transaction();
+
+		// Remove all expired guess sessions
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
 			WHERE session_user_id = ' . ANONYMOUS . '
 			AND session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
 		$_CLASS['core_db']->query($sql);
-*/
-		$_CLASS['core_db']->transaction();
 
-		$sql = 'UPDATE ' . USERS_TABLE. ' u, ' . SESSIONS_TABLE . ' s
-					SET u.user_last_visit = s.session_time
-					WHERE s.session_time < ' . ($time - (int) $_CORE_CONFIG['server']['session_length']) . '
-						AND s.session_user_id <> ' . ANONYMOUS .'
-						AND u.user_id = s.session_user_id';
-		$_CLASS['core_db']->sql_query($sql);
+// see if other database supports UPDATE sELECT
+		switch ($_CLASS['core_db']->db_layer)
+		{
+			//Oracle8 suporrts this also, I believe
+			case 'mysql':
+			case 'mysqli':
+				$sql = 'UPDATE ' . USERS_TABLE. ' u, ' . SESSIONS_TABLE . ' s
+							SET u.user_last_visit = s.session_time
+								WHERE s.session_time < ' . ($time - (int) $_CORE_CONFIG['server']['session_length']) . '
+								AND u.user_id = s.session_user_id';
+				$_CLASS['core_db']->query($sql);
+			break;
 
+			default:
+				$sql = 'SELECT session_user_id, MAX(session_time) AS session_time
+							FROM ' . SESSIONS_TABLE . '
+								WHERE session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']) . '
+								GROUP BY session_user_id';
+				$result = $_CLASS['core_db']->query($sql);
+				
+				// Should be fast with the transaction
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					$sql = 'UPDATE ' . USERS_TABLE . '
+							SET user_last_visit = ' . $row['session_time'] . '
+								WHERE user_id = ' . $row['session_user_id'];
+					$_CLASS['core_db']->query($sql);
+				}
+			break;
+		}
+
+		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
+				WHERE session_time < ' . ($time - (int) $_CORE_CONFIG['server']['session_length']);
+			$_CLASS['core_db']->query($sql);
+
 		$sql = 'DELETE FROM ' . SESSIONS_AUTOLOGIN_TABLE . '
 					WHERE auto_login_time < ' . ($time - 2592000);
 		$_CLASS['core_db']->query($sql);
+		
+		$_CLASS['core_db']->transaction('commit');
 
-		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
-					WHERE session_time < ' . ($time - (int) $_CORE_CONFIG['server']['session_length']);
-		$_CLASS['core_db']->query($sql);
-		
 		$_CLASS['core_db']->optimize_tables(SESSIONS_TABLE);
-		
-		$_CLASS['core_db']->transaction('commit');
 	}
 
 	function session_data_get($name, $default = false)

Modified: trunk/install/build_data.php
===================================================================
--- trunk/install/build_data.php	2005-08-30 17:36:52 UTC (rev 94)
+++ trunk/install/build_data.php	2005-08-31 14:26:25 UTC (rev 95)
@@ -22,6 +22,7 @@
 */
 
 $install_prefix = 'test_';
+$time = gmtime();
 
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."admins (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
 
@@ -86,13 +87,13 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (1, 'GUESTS', 1, 2, '', 0, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (2, 'REGISTERED', 1, 2, '', 0, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (3, 'REGISTERED_COPPA', 1, 2, '', 0, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (4, 'ADMINISTRATORS', 1, 2, 'AA0000', 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (5, 'BOTS', 1, 2, '9E8DA7', 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (1, 'GUESTS', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (2, 'REGISTERED', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (3, 'REGISTERED_COPPA', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (4, 'ADMINISTRATORS', 1, 2, 'AA0000', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (5, 'BOTS', 1, 2, '9E8DA7', 1, '')");
 // To be seperated
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_avatar, group_description) VALUES (6, 'SUPER_MODERATORS', 1, 2, '00AA00', 0, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (6, 'SUPER_MODERATORS', 1, 2, '00AA00', 0, '')");
 
 
 //Admin
@@ -100,14 +101,14 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (4, 2, 10)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (6, 2, 10)");
 // Anonymous
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (1, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (1, 1, 2)");
 // Bots
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 3, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 4, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 5, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 6, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 3, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 4, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 5, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 6, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('blocks', 0, 2,'')");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
@@ -129,38 +130,38 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 2, 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':?:', 'question.png', 'Question', 19, 19, 18)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?:', 'question.png', 'Question', 19, 19, 18, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username) VALUES (1, 0, 2, 1, 'Anonymous')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_colour) VALUES (2, 1, 2, 4, 'Admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (3, 2, 2, 5, 'Googlebot', '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (4, 2, 2, 5, 'MSN', '65.54.188.', 'msnbot/', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (5, 2, 2, 5, 'Yahoo', '66.196.90.1', 'Yahoo! Slurp', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (6, 2, 2, 5, 'Alexa', '66.28.250.,209.237.238.', 'ia_archiver', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (7, 2, 2, 5, 'NaverBot', '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_ip, user_agent, user_colour) VALUES (8, 2, 2, 5, 'Jetbot', '64.71.144.', 'Jetbot/', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (1, 0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (2, 1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (3, 2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (4, 2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (5, 2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (6, 2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (7, 2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (8, 2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0)");
 
 // Forums
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
@@ -168,7 +169,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_read', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_post', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_reply', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");f_bbcode
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_edit', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_user_lock', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_delete', 1)");
@@ -182,7 +183,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_download', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_icons', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_html', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bbsmiley_code', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bbcode', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_smilies', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_img', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_flash', 1)");

Modified: trunk/install/build_tables.php
===================================================================
--- trunk/install/build_tables.php	2005-08-30 17:36:52 UTC (rev 94)
+++ trunk/install/build_tables.php	2005-08-31 14:26:25 UTC (rev 95)
@@ -43,8 +43,8 @@
 $_CLASS['core_db']->add_table_field_int('admin_status', array('max' => 10));
 $_CLASS['core_db']->add_table_field_text('admin_options', 60000, true);
 
-$_CLASS['core_db']->add_table_index('member_user_id');
-$_CLASS['core_db']->add_table_index('member_group_id');
+$_CLASS['core_db']->add_table_index('user_id');
+$_CLASS['core_db']->add_table_index('group_id');
 $_CLASS['core_db']->add_table_index('admin_status');
 
 $_CLASS['core_db']->table_create('commit');
@@ -97,27 +97,27 @@
 
 $_CLASS['core_db']->table_create('start', $install_prefix.'groups');
 
+// this section needs updating, with null fields
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('group_name', 50);
 $_CLASS['core_db']->add_table_field_int('group_type', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('group_status', array('max' => 10));
 
-$_CLASS['core_db']->add_table_field_int('group_rank', array('max' => 2000));
-$_CLASS['core_db']->add_table_field_char('group_colour', 6);
-$_CLASS['core_db']->add_table_field_char('group_avatar', 100);
-$_CLASS['core_db']->add_table_field_int('group_avatar_type', array('max' => 200));
-$_CLASS['core_db']->add_table_field_int('group_avatar_width', array('max' => 200));
-$_CLASS['core_db']->add_table_field_int('group_avatar_height', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('group_rank', array('max' => 2000, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('group_colour', 6, true);
+$_CLASS['core_db']->add_table_field_char('group_avatar', 100, true);
+$_CLASS['core_db']->add_table_field_int('group_avatar_type', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('group_avatar_width', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('group_avatar_height', array('max' => 200, 'null' => true));
 
-$_CLASS['core_db']->add_table_field_int('group_sig_chars', array('max' => 160000));
-$_CLASS['core_db']->add_table_field_int('group_receive_pm', array('max' => 10));
-$_CLASS['core_db']->add_table_field_int('group_message_limit', array('max' => 10000));
+$_CLASS['core_db']->add_table_field_int('group_sig_chars', array('max' => 160000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('group_receive_pm', array('max' => 10, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('group_message_limit', array('max' => 10000, 'null' => true));
 
 $_CLASS['core_db']->add_table_field_char('group_description', 255);
-$_CLASS['core_db']->add_table_field_int('group_display', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('group_display', array('max' => 10, 'null' => true)); // temp null
 $_CLASS['core_db']->add_table_field_int('group_legend', array('max' => 10));
 
-
 $_CLASS['core_db']->add_table_index('group_id', 'primary');
 $_CLASS['core_db']->add_table_index('group_display');
 $_CLASS['core_db']->add_table_index('group_legend');
@@ -237,13 +237,13 @@
 $_CLASS['core_db']->add_table_field_int('user_status', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('user_group', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('user_ip', 255);
-$_CLASS['core_db']->add_table_field_char('user_agent', 255, null);
+$_CLASS['core_db']->add_table_field_char('user_agent', 255, true);
 $_CLASS['core_db']->add_table_field_char('user_birthday', 10, true);
 $_CLASS['core_db']->add_table_field_text('user_data', 6000, true);
 
-$_CLASS['core_db']->add_table_field_char('user_act_key', 10, null);
-$_CLASS['core_db']->add_table_field_char('user_new_password', 40);
-$_CLASS['core_db']->add_table_field_char('user_new_password_encoding', 10);
+$_CLASS['core_db']->add_table_field_char('user_act_key', 10, true);
+$_CLASS['core_db']->add_table_field_char('user_new_password', 40, true);
+$_CLASS['core_db']->add_table_field_char('user_new_password_encoding', 10, true);
 
 field_unix_time('user_reg_date');
 field_unix_time('user_last_visit', true);
@@ -259,7 +259,7 @@
 $_CLASS['core_db']->add_table_field_int('user_allow_viewemail', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('user_allow_massemail', array('max' => 1));
 
-$_CLASS['core_db']->add_table_field_int('user_new_privmsg', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('user_new_privmsg', array('max' => 1, 'null' => true));
 
 $_CLASS['core_db']->add_table_field_text('user_sig', 60000, true);
 $_CLASS['core_db']->add_table_field_char('user_from', 100, true);
@@ -279,31 +279,31 @@
 //$_CLASS['core_db']->add_table_field_int('user_attachsig', 0, 1, 1);
 ///
 
-$_CLASS['core_db']->add_table_field_int('user_notify', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('user_notify', array('max' => 1, 'null' => true));
 //$_CLASS['core_db']->add_table_field_int('user_notify_pm', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('user_notify_type', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('user_notify_type', array('max' => 10, 'null' => true));
 
 $_CLASS['core_db']->add_table_field_int('user_allow_pm', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('user_allow_email', array('max' => 1));
 
-$_CLASS['core_db']->add_table_field_char('user_sig_bbcode_uid', 5);
-$_CLASS['core_db']->add_table_field_int('user_sig_bbcode_bitfield', array('max' => 1600));
+$_CLASS['core_db']->add_table_field_char('user_sig_bbcode_uid', 5, true);
+$_CLASS['core_db']->add_table_field_int('user_sig_bbcode_bitfield', array('max' => 1600, 'null' => true));
 
-$_CLASS['core_db']->add_table_field_int('user_topic_show_days', array('max' => 200));
-$_CLASS['core_db']->add_table_field_char('user_topic_sortby_type', 1);
-$_CLASS['core_db']->add_table_field_char('user_topic_sortby_dir', 1);
+$_CLASS['core_db']->add_table_field_int('user_topic_show_days', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('user_topic_sortby_type', 1, true);
+$_CLASS['core_db']->add_table_field_char('user_topic_sortby_dir', 1, true);
 
-$_CLASS['core_db']->add_table_field_int('user_post_show_days', array('max' => 200));
-$_CLASS['core_db']->add_table_field_char('user_post_sortby_type', 1);
-$_CLASS['core_db']->add_table_field_char('user_post_sortby_dir', 1);
+$_CLASS['core_db']->add_table_field_int('user_post_show_days', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('user_post_sortby_type', 1, true);
+$_CLASS['core_db']->add_table_field_char('user_post_sortby_dir', 1, true);
 
-$_CLASS['core_db']->add_table_field_int('user_posts', array('max' => 16000000));
-field_unix_time('user_last_post_time');
+$_CLASS['core_db']->add_table_field_int('user_posts', array('max' => 16000000, 'null' => true));
+field_unix_time('user_last_post_time', true);
 
-$_CLASS['core_db']->add_table_field_text('user_permissions', 60000); // phpBBs rename user_forums_permissions
+$_CLASS['core_db']->add_table_field_text('user_permissions', 60000, true); // phpBBs rename user_forums_permissions
 
 // these can be null I think
-$_CLASS['core_db']->add_table_field_char('user_avatar', 200, null);
+$_CLASS['core_db']->add_table_field_char('user_avatar', 200, true);
 $_CLASS['core_db']->add_table_field_int('user_avatar_type', array('max' => 10, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('user_avatar_width', array('max' => 100, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('user_avatar_height', array('max' => 100, 'null' => true));
@@ -353,9 +353,9 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth');
 
-$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('auth_option_id', array('max' => 2000));
 $_CLASS['core_db']->add_table_field_int('auth_setting', array('max' => 1));
 
@@ -372,8 +372,9 @@
 
 $_CLASS['core_db']->add_table_field_int('auth_option_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('auth_option', 20);
-$_CLASS['core_db']->add_table_field_int('is_global', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('is_local', array('max' => 1));
+// These 2 are useless, change to type
+$_CLASS['core_db']->add_table_field_int('is_global', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('is_local', array('max' => 1, 'null' => true));
 
 $_CLASS['core_db']->add_table_index('auth_option_id', 'primary');
 $_CLASS['core_db']->add_table_index('auth_option', 'unique');
@@ -502,30 +503,30 @@
 $_CLASS['core_db']->add_table_field_text('forum_parents', 20000);
 $_CLASS['core_db']->add_table_field_char('forum_name', 150);
 $_CLASS['core_db']->add_table_field_text('forum_desc', 20000);
-$_CLASS['core_db']->add_table_field_text('forum_rules', 20000);
-$_CLASS['core_db']->add_table_field_char('forum_rules_link', 200);
-$_CLASS['core_db']->add_table_field_char('forum_rules_flags', 50);
-$_CLASS['core_db']->add_table_field_int('forum_rules_bbcode_bitfield', array('max' => 1000000000));
-$_CLASS['core_db']->add_table_field_char('forum_rules_bbcode_uid', 5);
-$_CLASS['core_db']->add_table_field_char('forum_link', 200);
-$_CLASS['core_db']->add_table_field_char('forum_password', 40);
-$_CLASS['core_db']->add_table_field_char('forum_password_encoding', 10);
-$_CLASS['core_db']->add_table_field_char('forum_image', 200);
-$_CLASS['core_db']->add_table_field_int('forum_topics_per_page', array('max' => 200));
+$_CLASS['core_db']->add_table_field_text('forum_rules', 20000, true);
+$_CLASS['core_db']->add_table_field_char('forum_rules_link', 200, true);
+$_CLASS['core_db']->add_table_field_char('forum_rules_flags', 50, true);
+$_CLASS['core_db']->add_table_field_int('forum_rules_bbcode_bitfield', array('max' => 1000000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('forum_rules_bbcode_uid', 5, true);
+$_CLASS['core_db']->add_table_field_char('forum_link', 200, true);
+$_CLASS['core_db']->add_table_field_char('forum_password', 40, true);
+$_CLASS['core_db']->add_table_field_char('forum_password_encoding', 10, true);
+$_CLASS['core_db']->add_table_field_char('forum_image', 200, true);
+$_CLASS['core_db']->add_table_field_int('forum_topics_per_page', array('max' => 200, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('forum_type', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('forum_status', array('max' => 10));
-$_CLASS['core_db']->add_table_field_int('forum_posts', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('forum_topics', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('forum_topics_real', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('forum_last_post_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('forum_last_poster_id', array('max' => 16000000));
-field_unix_time('forum_last_post_time');
-$_CLASS['core_db']->add_table_field_char('forum_last_poster_name', 50);
+$_CLASS['core_db']->add_table_field_int('forum_posts', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('forum_topics', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('forum_topics_real', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('forum_last_post_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('forum_last_poster_id', array('max' => 16000000, 'null' => true));
+field_unix_time('forum_last_post_time', true);
+$_CLASS['core_db']->add_table_field_char('forum_last_poster_name', 50, true);
 $_CLASS['core_db']->add_table_field_int('forum_flags', array('max' => 200));
 $_CLASS['core_db']->add_table_field_int('display_on_index', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('enable_indexing', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('enable_icons', array('max' => 1));
-field_unix_time('prune_next');
+field_unix_time('prune_next', true);
 
 //////
 
@@ -558,9 +559,9 @@
 $_CLASS['core_db']->add_table_field_int('enable_html', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('enable_smilies', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('enable_sig', array('max' => 1));
-field_unix_time('post_edit_time');
-$_CLASS['core_db']->add_table_field_int('post_edit_count', array('max' => 20000));
-$_CLASS['core_db']->add_table_field_int('post_attachment', array('max' => 1));
+field_unix_time('post_edit_time', true);
+$_CLASS['core_db']->add_table_field_int('post_edit_count', array('max' => 20000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('post_attachment', array('max' => 1, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('post_subject', 50);
 $_CLASS['core_db']->add_table_field_text('post_text', 10000000);
 $_CLASS['core_db']->add_table_field_char('bbcode_uid', 10);
@@ -568,11 +569,10 @@
 $_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
 $_CLASS['core_db']->add_table_field_int('enable_magic_url', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('post_approved', array('max' => 1));
-$_CLASS['core_db']->add_table_field_char('post_edit_reason', 255);
-$_CLASS['core_db']->add_table_field_int('post_edit_user', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('post_edit_locked', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('post_reported', array('max' => 1));
-$_CLASS['core_db']->add_table_field_char('post_encoding', 10, 'utf-8'); // to be removed
+$_CLASS['core_db']->add_table_field_char('post_edit_reason', 255, true);
+$_CLASS['core_db']->add_table_field_int('post_edit_user', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('post_edit_locked', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('post_reported', array('max' => 1, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('post_checksum', 32);
 
 $_CLASS['core_db']->add_table_index('post_id', 'primary');
@@ -594,12 +594,15 @@
 $_CLASS['core_db']->add_table_field_char('topic_title', 50);
 $_CLASS['core_db']->add_table_field_int('topic_poster', array('max' => 16000000));
 field_unix_time('topic_time');
-$_CLASS['core_db']->add_table_field_int('topic_views', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('topic_replies', array('max' => 16000000));  
+$_CLASS['core_db']->add_table_field_int('topic_views', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('topic_replies', array('max' => 16000000, 'null' => true));  
 $_CLASS['core_db']->add_table_field_int('topic_status', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('topic_type', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('topic_last_post_id', array('max' => 16000000));
+
+// we should set this on topic creation
+$_CLASS['core_db']->add_table_field_int('topic_last_post_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('topic_first_post_id', array('max' => 16000000));
+
 $_CLASS['core_db']->add_table_field_int('topic_moved_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
 
@@ -607,22 +610,22 @@
 $_CLASS['core_db']->add_table_field_int('topic_approved', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('topic_reported', array('max' => 1)); 
 field_unix_time('topic_time_limit');
-$_CLASS['core_db']->add_table_field_int('topic_replies_real', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_replies_real', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('topic_first_poster_name', 50);
-$_CLASS['core_db']->add_table_field_int('topic_last_poster_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_char('topic_last_poster_name', 50);
-field_unix_time('topic_last_post_time');
-field_unix_time('topic_last_view_time');
+$_CLASS['core_db']->add_table_field_int('topic_last_poster_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('topic_last_poster_name', 50, true);
+field_unix_time('topic_last_post_time', true);
+field_unix_time('topic_last_view_time', true);
 
-$_CLASS['core_db']->add_table_field_int('topic_bumped', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('topic_bumper', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_bumped', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('topic_bumper', array('max' => 16000000, 'null' => true));
   
-$_CLASS['core_db']->add_table_field_char('poll_title', 100);
-field_unix_time('poll_start');
-field_unix_time('poll_length'); 
-$_CLASS['core_db']->add_table_field_int('poll_max_options', array('max' => 200));
-field_unix_time('poll_last_vote');
-$_CLASS['core_db']->add_table_field_int('poll_vote_change', array('max' => 1));
+$_CLASS['core_db']->add_table_field_char('poll_title', 100, true);
+field_unix_time('poll_start', true);
+field_unix_time('poll_length', true); 
+$_CLASS['core_db']->add_table_field_int('poll_max_options', array('max' => 200, 'null' => true));
+field_unix_time('poll_last_vote', true);
+$_CLASS['core_db']->add_table_field_int('poll_vote_change', array('max' => 1, 'null' => true));
 
 $_CLASS['core_db']->add_table_index('topic_id', 'primary');
 $_CLASS['core_db']->add_table_index('forum_id');
@@ -776,9 +779,11 @@
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('zebra_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('friend', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('foe', array('max' => 1));
 
+// conbine these 2
+$_CLASS['core_db']->add_table_field_int('friend', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('foe', array('max' => 1, 'null' => true));
+
 $_CLASS['core_db']->add_table_index('user_id');
 $_CLASS['core_db']->add_table_index('zebra_id');
 

Modified: trunk/modules/Quick_Message/index.php
===================================================================
--- trunk/modules/Quick_Message/index.php	2005-08-30 17:36:52 UTC (rev 94)
+++ trunk/modules/Quick_Message/index.php	2005-08-31 14:26:25 UTC (rev 95)
@@ -39,7 +39,7 @@
 	case 'add':
 		if (empty($_POST['submit']) || $_CLASS['core_user']->is_bot)
 		{
-			url_redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
+			redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
 		}
 
 		$message = trim(get_variable('message', 'POST', false));
@@ -56,8 +56,6 @@
 			trigger_error('LONG_MESSAGE');
 		}
 
-		$message = htmlentities($message, ENT_QUOTES, 'UTF-8');
-
 	// use limit
 		$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['last_post_check']));
 		$count = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -111,8 +109,6 @@
 			}
 		}
 
-		$user_name = htmlentities($user_name, ENT_QUOTES, 'UTF-8');
-
 		$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 			'poster_name'	=> (string) $user_name,
 			'poster_id'		=> (int) $user_id,
@@ -123,7 +119,7 @@
 
 		$_CLASS['core_db']->query($sql);
 
-		redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
+		redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
 	break;
 
 	case 'delete':
@@ -167,7 +163,7 @@
 		$_CLASS['core_db']->query($sql);
 
 		//trigger_error('MESSAGE_DELETED');
-		redirect(generate_link($_CLASS['core_user']->data['session_url']), false);
+		redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
 	break;
 }
 
@@ -204,7 +200,7 @@
 {
 	if ($row['poster_name'])
 	{
-		$user_name = $row['poster_name'];
+		$user_name = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');;
 		$userlink = ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : false;
 	}
 	else
@@ -242,7 +238,7 @@
 		'USER_NAME'		=> $user_name,
 		'USER_LINK'		=> $userlink,
 		'DELETE_LINK'	=> $delete_link,
-		'MESSAGE'		=> modify_lines($row['message_text'], '<br />'),
+		'MESSAGE'		=> modify_lines(htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8'), '<br />'),
 		'TIME'			=> $_CLASS['core_user']->format_date($row['message_time']),
 		'POSTER_AVATAR' => $avatar,
 		'U_PROFILE' 	=> ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['poster_id']) : false,



